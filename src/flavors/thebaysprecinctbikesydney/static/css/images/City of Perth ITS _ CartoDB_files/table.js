/*! v3.14.06 - 2015-06-25 */
function RGBColor(a){this.ok=!1,"#"==a.charAt(0)&&(a=a.substr(1,6)),a=a.replace(/ /g,""),a=a.toLowerCase();var b={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};for(var c in b)a==c&&(a=b[c]);for(var d=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(a){return[parseInt(a[1]),parseInt(a[2]),parseInt(a[3])]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(a){return[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],process:function(a){return[parseInt(a[1]+a[1],16),parseInt(a[2]+a[2],16),parseInt(a[3]+a[3],16)]}}],e=0;e<d.length;e++){var f=d[e].re,g=d[e].process,h=f.exec(a);h&&(channels=g(h),this.r=channels[0],this.g=channels[1],this.b=channels[2],this.ok=!0)}this.r=this.r<0||isNaN(this.r)?0:this.r>255?255:this.r,this.g=this.g<0||isNaN(this.g)?0:this.g>255?255:this.g,this.b=this.b<0||isNaN(this.b)?0:this.b>255?255:this.b,this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"},this.toHex=function(){var a=this.r.toString(16),b=this.g.toString(16),c=this.b.toString(16);return 1==a.length&&(a="0"+a),1==b.length&&(b="0"+b),1==c.length&&(c="0"+c),"#"+a+b+c},this.getHelpXML=function(){for(var a=new Array,c=0;c<d.length;c++)for(var e=d[c].example,f=0;f<e.length;f++)a[a.length]=e[f];for(var g in b)a[a.length]=g;var h=document.createElement("ul");h.setAttribute("id","rgbcolor-examples");for(var c=0;c<a.length;c++)try{var i=document.createElement("li"),j=new RGBColor(a[c]),k=document.createElement("div");k.style.cssText="margin: 3px; border: 1px solid black; background:"+j.toHex()+"; color:"+j.toHex(),k.appendChild(document.createTextNode("test"));var l=document.createTextNode(" "+a[c]+" -> "+j.toRGB()+" -> "+j.toHex());i.appendChild(k),i.appendChild(l),h.appendChild(i)}catch(m){}return h}}function enableClickOut(a){a.click(function(){cdb.god.trigger("closeDialogs")})}function MarkerGMaps(){var a=arguments[0];a.position&&(a.position=new google.maps.LatLng(a.position[0],a.position[1])),google.maps.Marker.apply(this,arguments)}function PolygonGMaps(){google.maps.Polygon.apply(this,arguments)}function PolylineGMaps(){google.maps.Polyline.apply(this,arguments)}function GrouperLayerMapView(a){return{initialize:function(){this.groupLayer=null,this.activeLayerModel=null,a.prototype.initialize.call(this)},_removeLayers:function(){var a=this;_.each(this.map.layers.getLayersByType("CartoDB"),function(b){b.unbind(null,null,a)}),cdb.geo.MapView.prototype._removeLayers.call(this),this.groupLayer&&this.groupLayer.model.unbind(),this.groupLayer=null},_removeLayer:function(a){a.cid in this.layers?this.layers[a.cid]===this.groupLayer?(this._updateLayerDefinition(a),a.unbind(null,null,this),delete this.layers[a.cid],this.trigger("removeLayerView",this)):(this.trigger("removeLayerView",this),cdb.geo.MapView.prototype._removeLayer.call(this,a)):cdb.log.info("removing non existing layer")},setActiveLayer:function(a){this.activeLayerModel=a,this._setInteraction()},disableInteraction:function(){this.groupLayer&&this.groupLayer._clearInteraction()},enableInteraction:function(){this._setInteraction()},_setInteraction:function(){if(this.groupLayer&&this.activeLayerModel){this.groupLayer._clearInteraction();for(var a=this.map.layers.getLayerDefIndex(this.activeLayerModel),b=0;b<this.groupLayer.getLayerCount();++b)this.groupLayer.setInteraction(b,b==a)}},_updateLayerDefinition:function(a){if(!a)throw"layer must be a valid layer (not null)";if(this.groupLayer)if(0===this.map.layers.getLayersByType("CartoDB").length)this.groupLayer.remove(),this.groupLayer=null;else{var b=this.map.layers.getLayerDef();this.groupLayer.setLayerDefinition(b),this._setInteraction()}},_routeErrors:function(a){var b=/style(\d+)/,c=/layer(\d+):/i,d=/PSQL error/i,e=/syntax error/i,f=/"the_geom_webmercator" does not exist/i,g=/Error:/i,h=this.map.layers.where({visible:!0,type:"CartoDB"});for(var i in a){var j=a[i];if(j&&j.length){var k=b.exec(j);if(k){var l=parseInt(k[1],10);h[l].trigger("parseError",[j])}else{var k=c.exec(j);if(k){var l=parseInt(k[1],10);f.exec(j)?(j=_t("you should select the_geom_webmercator column"),h[l].trigger("sqlNoMercator",[j])):h[l].trigger("sqlParseError",[j])}else if(d.exec(j)||e.exec(j)||g.exec(j)){var m="sqlError";f.exec(j)&&(m="sqlNoMercator",j=_t("you should select the_geom_webmercator column")),_.each(h,function(a){a.trigger(m,j)})}else _.each(h,function(a){a.trigger("error",j)})}}}},_routeSignal:function(a){var b=this;return function(){var c=b.map.layers.where({visible:!0,type:"CartoDB"}),d=[a].concat(arguments);_.each(c,function(a){a.trigger.apply(a,d)})}},_addLayer:function(b,c,d){if("CartoDB"===b.get("type")){if(this.groupLayer)this.layers[b.cid]=this.groupLayer,this._updateLayerDefinition(b),this.trigger("newLayerView",this.groupLayer,b,this);else{var e=new cdb.geo.CartoDBGroupLayer(_.extend(b.toLayerGroup(),{user_name:this.options.user.get("username"),maps_api_template:cdb.config.get("maps_api_template"),no_cdn:!1,force_cors:!0})),f=a.prototype._addLayer.call(this,e,c,_.extend({},d,{silent:!0}));delete this.layers[e.cid],this.layers[b.cid]=f,this.groupLayer=f,e.bind("error",this._routeErrors,this),e.bind("tileOk",this._routeSignal("tileOk"),this),this.trigger("newLayerView",f,b,this)}b.bind("change:tile_style change:query change:query_wrapper change:interactivity change:visible",this._updateLayerDefinition,this),this._addLayerToMap(this.groupLayer),delete this.layers[this.groupLayer.model.cid]}else a.prototype._addLayer.call(this,b,c,d)}}}function proxyModel(a,b){var c=new Backbone.Model;c.set(a.attributes);var d=!1;return b=b||function(){a.set(c.attributes)},a.bind("change",function(){d=!0,c.set(a.attributes),d=!1},c),c.bind("change",function(){d||b(a,c)},a),c.unlink=function(){a.unbind(null,null,c),c.unbind(null,null,a)},c}window.CodeMirror=function(){"use strict";function a(c,d){if(!(this instanceof a))return new a(c,d);this.options=d=d||{};for(var e in ue)!d.hasOwnProperty(e)&&ue.hasOwnProperty(e)&&(d[e]=ue[e]);n(d);var f="string"==typeof d.value?0:d.value.first,g=this.display=b(c,f);g.wrapper.CodeMirror=this,k(this),d.autofocus&&!ae&&pa(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,focused:!1,suppressEdits:!1,pasteIncoming:!1,cutIncoming:!1,draggingText:!1,highlight:new dd},i(this),d.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap");var h=d.value;"string"==typeof h&&(h=new Je(d.value,d.mode)),ha(this,wc)(this,h),Md&&setTimeout(md(oa,this,!0),20),sa(this);var j;try{j=document.activeElement==g.input}catch(l){}j||d.autofocus&&!ae?setTimeout(md(La,this),20):Ma(this),ha(this,function(){for(var a in te)te.propertyIsEnumerable(a)&&te[a](this,d[a],ve);for(var b=0;b<ze.length;++b)ze[b](this)})()}function b(a,b){var c={},d=c.input=rd("textarea",null,null,"position: absolute; padding: 0; width: 1px; height: 1em; outline: none");return Sd?d.style.width="1000px":d.setAttribute("wrap","off"),_d&&(d.style.border="1px solid black"),d.setAttribute("autocorrect","off"),d.setAttribute("autocapitalize","off"),d.setAttribute("spellcheck","false"),c.inputDiv=rd("div",[d],null,"overflow: hidden; position: relative; width: 3px; height: 0px;"),c.scrollbarH=rd("div",[rd("div",null,null,"height: 1px")],"CodeMirror-hscrollbar"),c.scrollbarV=rd("div",[rd("div",null,null,"width: 1px")],"CodeMirror-vscrollbar"),c.scrollbarFiller=rd("div",null,"CodeMirror-scrollbar-filler"),c.gutterFiller=rd("div",null,"CodeMirror-gutter-filler"),c.lineDiv=rd("div",null,"CodeMirror-code"),c.selectionDiv=rd("div",null,null,"position: relative; z-index: 1"),c.cursor=rd("div"," ","CodeMirror-cursor"),c.otherCursor=rd("div"," ","CodeMirror-cursor CodeMirror-secondarycursor"),c.measure=rd("div",null,"CodeMirror-measure"),c.lineSpace=rd("div",[c.measure,c.selectionDiv,c.lineDiv,c.cursor,c.otherCursor],null,"position: relative; outline: none"),c.mover=rd("div",[rd("div",[c.lineSpace],"CodeMirror-lines")],null,"position: relative"),c.sizer=rd("div",[c.mover],"CodeMirror-sizer"),c.heightForcer=rd("div",null,null,"position: absolute; height: "+Oe+"px; width: 1px;"),c.gutters=rd("div",null,"CodeMirror-gutters"),c.lineGutter=null,c.scroller=rd("div",[c.sizer,c.heightForcer,c.gutters],"CodeMirror-scroll"),c.scroller.setAttribute("tabIndex","-1"),c.wrapper=rd("div",[c.inputDiv,c.scrollbarH,c.scrollbarV,c.scrollbarFiller,c.gutterFiller,c.scroller],"CodeMirror"),Nd&&(c.gutters.style.zIndex=-1,c.scroller.style.paddingRight=0),a.appendChild?a.appendChild(c.wrapper):a(c.wrapper),_d&&(d.style.width="0px"),Sd||(c.scroller.draggable=!0),Xd?(c.inputDiv.style.height="1px",c.inputDiv.style.position="absolute"):Nd&&(c.scrollbarH.style.minWidth=c.scrollbarV.style.minWidth="18px"),c.viewOffset=c.lastSizeC=0,c.showingFrom=c.showingTo=b,c.lineNumWidth=c.lineNumInnerWidth=c.lineNumChars=null,c.prevInput="",c.alignWidgets=!1,c.pollingFast=!1,c.poll=new dd,c.cachedCharWidth=c.cachedTextHeight=c.cachedPaddingH=null,c.measureLineCache=[],c.measureLineCachePos=0,c.inaccurateSelection=!1,c.maxLine=null,c.maxLineLength=0,c.maxLineChanged=!1,c.wheelDX=c.wheelDY=c.wheelStartX=c.wheelStartY=null,c}function c(b){b.doc.mode=a.getMode(b.options,b.doc.modeOption),d(b)}function d(a){a.doc.iter(function(a){a.stateAfter&&(a.stateAfter=null),a.styles&&(a.styles=null)}),a.doc.frontier=a.doc.first,H(a,100),a.state.modeGen++,a.curOp&&ka(a)}function e(a){a.options.lineWrapping?(a.display.wrapper.className+=" CodeMirror-wrap",a.display.sizer.style.minWidth=""):(a.display.wrapper.className=a.display.wrapper.className.replace(" CodeMirror-wrap",""),m(a)),g(a),ka(a),V(a),setTimeout(function(){o(a)},100)}function f(a){var b=da(a.display),c=a.options.lineWrapping,d=c&&Math.max(5,a.display.scroller.clientWidth/ea(a.display)-3);return function(e){return Zb(a.doc,e)?0:c?(Math.ceil(e.text.length/d)||1)*b:b}}function g(a){var b=a.doc,c=f(a);b.iter(function(a){var b=c(a);b!=a.height&&Ac(a,b)})}function h(a){var b=Ce[a.options.keyMap],c=b.style;a.display.wrapper.className=a.display.wrapper.className.replace(/\s*cm-keymap-\S+/g,"")+(c?" cm-keymap-"+c:"")}function i(a){a.display.wrapper.className=a.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+a.options.theme.replace(/(^|\s)\s*/g," cm-s-"),V(a)}function j(a){k(a),ka(a),setTimeout(function(){q(a)},20)}function k(a){var b=a.display.gutters,c=a.options.gutters;sd(b);for(var d=0;d<c.length;++d){var e=c[d],f=b.appendChild(rd("div",null,"CodeMirror-gutter "+e));"CodeMirror-linenumbers"==e&&(a.display.lineGutter=f,f.style.width=(a.display.lineNumWidth||1)+"px")}b.style.display=d?"":"none"}function l(a,b){if(0==b.height)return 0;for(var c,d=b.text.length,e=b;c=Vb(e);){var f=c.find();e=xc(a,f.from.line),d+=f.from.ch-f.to.ch}for(e=b;c=Wb(e);){var f=c.find();d-=e.text.length-f.from.ch,e=xc(a,f.to.line),d+=e.text.length-f.to.ch}return d}function m(a){var b=a.display,c=a.doc;b.maxLine=xc(c,c.first),b.maxLineLength=l(c,b.maxLine),b.maxLineChanged=!0,c.iter(function(a){var d=l(c,a);d>b.maxLineLength&&(b.maxLineLength=d,b.maxLine=a)})}function n(a){var b=id(a.gutters,"CodeMirror-linenumbers");-1==b&&a.lineNumbers?a.gutters=a.gutters.concat(["CodeMirror-linenumbers"]):b>-1&&!a.lineNumbers&&(a.gutters=a.gutters.slice(0),a.gutters.splice(b,1))}function o(a){var b=a.display,c=a.doc.height,d=c+M(b);b.sizer.style.minHeight=b.heightForcer.style.top=d+"px",b.gutters.style.height=Math.max(d,b.scroller.clientHeight-Oe)+"px";var e=Math.max(d,b.scroller.scrollHeight),f=b.scroller.scrollWidth>b.scroller.clientWidth+1,g=e>b.scroller.clientHeight+1;g?(b.scrollbarV.style.display="block",b.scrollbarV.style.bottom=f?xd(b.measure)+"px":"0",b.scrollbarV.firstChild.style.height=Math.max(0,e-b.scroller.clientHeight+b.scrollbarV.clientHeight)+"px"):(b.scrollbarV.style.display="",b.scrollbarV.firstChild.style.height="0"),f?(b.scrollbarH.style.display="block",b.scrollbarH.style.right=g?xd(b.measure)+"px":"0",b.scrollbarH.firstChild.style.width=b.scroller.scrollWidth-b.scroller.clientWidth+b.scrollbarH.clientWidth+"px"):(b.scrollbarH.style.display="",b.scrollbarH.firstChild.style.width="0"),f&&g?(b.scrollbarFiller.style.display="block",b.scrollbarFiller.style.height=b.scrollbarFiller.style.width=xd(b.measure)+"px"):b.scrollbarFiller.style.display="",f&&a.options.coverGutterNextToScrollbar&&a.options.fixedGutter?(b.gutterFiller.style.display="block",b.gutterFiller.style.height=xd(b.measure)+"px",b.gutterFiller.style.width=b.gutters.offsetWidth+"px"):b.gutterFiller.style.display="",Yd&&0===xd(b.measure)&&(b.scrollbarV.style.minWidth=b.scrollbarH.style.minHeight=Zd?"18px":"12px",b.scrollbarV.style.pointerEvents=b.scrollbarH.style.pointerEvents="none")}function p(a,b,c){var d=a.scroller.scrollTop,e=a.wrapper.clientHeight;"number"==typeof c?d=c:c&&(d=c.top,e=c.bottom-c.top),d=Math.floor(d-L(a));var f=Math.ceil(d+e);return{from:Cc(b,d),to:Cc(b,f)}}function q(a){var b=a.display;if(b.alignWidgets||b.gutters.firstChild&&a.options.fixedGutter){for(var c=t(b)-b.scroller.scrollLeft+a.doc.scrollLeft,d=b.gutters.offsetWidth,e=c+"px",f=b.lineDiv.firstChild;f;f=f.nextSibling)if(f.alignable)for(var g=0,h=f.alignable;g<h.length;++g)h[g].style.left=e;a.options.fixedGutter&&(b.gutters.style.left=c+d+"px")}}function r(a){if(!a.options.lineNumbers)return!1;var b=a.doc,c=s(a.options,b.first+b.size-1),d=a.display;if(c.length!=d.lineNumChars){var e=d.measure.appendChild(rd("div",[rd("div",c)],"CodeMirror-linenumber CodeMirror-gutter-elt")),f=e.firstChild.offsetWidth,g=e.offsetWidth-f;return d.lineGutter.style.width="",d.lineNumInnerWidth=Math.max(f,d.lineGutter.offsetWidth-g),d.lineNumWidth=d.lineNumInnerWidth+g,d.lineNumChars=d.lineNumInnerWidth?c.length:-1,d.lineGutter.style.width=d.lineNumWidth+"px",!0}return!1}function s(a,b){return String(a.lineNumberFormatter(b+a.firstLineNumber))}function t(a){return vd(a.scroller).left-vd(a.sizer).left}function u(a,b,c,d){for(var e,f=a.display.showingFrom,g=a.display.showingTo,h=p(a.display,a.doc,c),i=!0;;i=!1){var j=a.display.scroller.clientWidth;if(!v(a,b,h,d))break;if(e=!0,b=[],D(a),o(a),i&&a.options.lineWrapping&&j!=a.display.scroller.clientWidth)d=!0;else if(d=!1,c&&(c=Math.min(a.display.scroller.scrollHeight-a.display.scroller.clientHeight,"number"==typeof c?c:c.top)),h=p(a.display,a.doc,c),h.from>=a.display.showingFrom&&h.to<=a.display.showingTo)break}return e&&($c(a,"update",a),(a.display.showingFrom!=f||a.display.showingTo!=g)&&$c(a,"viewportChange",a,a.display.showingFrom,a.display.showingTo)),e}function v(a,b,c,d){var e=a.display,f=a.doc;if(!e.wrapper.offsetWidth)return e.showingFrom=e.showingTo=f.first,void(e.viewOffset=0);if(!(!d&&0==b.length&&c.from>e.showingFrom&&c.to<e.showingTo)){r(a)&&(b=[{from:f.first,to:f.first+f.size}]);var g=e.sizer.style.marginLeft=e.gutters.offsetWidth+"px";e.scrollbarH.style.left=a.options.fixedGutter?g:"0";var h=1/0;if(a.options.lineNumbers)for(var i=0;i<b.length;++i)b[i].diff&&b[i].from<h&&(h=b[i].from);var j=f.first+f.size,k=Math.max(c.from-a.options.viewportMargin,f.first),l=Math.min(j,c.to+a.options.viewportMargin);if(e.showingFrom<k&&k-e.showingFrom<20&&(k=Math.max(f.first,e.showingFrom)),e.showingTo>l&&e.showingTo-l<20&&(l=Math.min(j,e.showingTo)),ke)for(k=Bc(Yb(f,xc(f,k)));j>l&&Zb(f,xc(f,l));)++l;var m=[{from:Math.max(e.showingFrom,f.first),to:Math.min(e.showingTo,j)}];if(m=m[0].from>=m[0].to?[]:y(m,b),ke)for(var i=0;i<m.length;++i)for(var n,o=m[i];n=Wb(xc(f,o.to-1));){var p=n.find().from.line;if(!(p>o.from)){m.splice(i--,1);break}o.to=p}for(var q=0,i=0;i<m.length;++i){var o=m[i];o.from<k&&(o.from=k),o.to>l&&(o.to=l),o.from>=o.to?m.splice(i--,1):q+=o.to-o.from}if(!d&&q==l-k&&k==e.showingFrom&&l==e.showingTo)return void x(a);m.sort(function(a,b){return a.from-b.from});try{var s=document.activeElement}catch(t){}.7*(l-k)>q&&(e.lineDiv.style.display="none"),A(a,k,l,m,h),e.lineDiv.style.display="",s&&document.activeElement!=s&&s.offsetHeight&&s.focus();var u=k!=e.showingFrom||l!=e.showingTo||e.lastSizeC!=e.wrapper.clientHeight;return u&&(e.lastSizeC=e.wrapper.clientHeight,H(a,400)),e.showingFrom=k,e.showingTo=l,e.gutters.style.height="",w(a),x(a),!0}}function w(a){for(var b,c=a.display,d=c.lineDiv.offsetTop,e=c.lineDiv.firstChild;e;e=e.nextSibling)if(e.lineObj){if(Nd){var f=e.offsetTop+e.offsetHeight;b=f-d,d=f}else{var g=vd(e);b=g.bottom-g.top}var h=e.lineObj.height-b;if(2>b&&(b=da(c)),h>.001||-.001>h){Ac(e.lineObj,b);var i=e.lineObj.widgets;if(i)for(var j=0;j<i.length;++j)i[j].height=i[j].node.offsetHeight}}}function x(a){var b=a.display.viewOffset=Dc(a,xc(a.doc,a.display.showingFrom));a.display.mover.style.top=b+"px"}function y(a,b){for(var c=0,d=b.length||0;d>c;++c){for(var e=b[c],f=[],g=e.diff||0,h=0,i=a.length;i>h;++h){var j=a[h];e.to<=j.from&&e.diff?f.push({from:j.from+g,to:j.to+g}):e.to<=j.from||e.from>=j.to?f.push(j):(e.from>j.from&&f.push({from:j.from,to:e.from}),e.to<j.to&&f.push({from:e.to+g,to:j.to+g}))}a=f}return a}function z(a){for(var b=a.display,c={},d={},e=b.gutters.firstChild,f=0;e;e=e.nextSibling,++f)c[a.options.gutters[f]]=e.offsetLeft,d[a.options.gutters[f]]=e.offsetWidth;return{fixedPos:t(b),gutterTotalWidth:b.gutters.offsetWidth,gutterLeft:c,gutterWidth:d,wrapperWidth:b.wrapper.clientWidth}}function A(a,b,c,d,e){function f(b){var c=b.nextSibling;return Sd&&be&&a.display.currentWheelTarget==b?(b.style.display="none",b.lineObj=null):b.parentNode.removeChild(b),c}var g=z(a),h=a.display,i=a.options.lineNumbers;d.length||Sd&&a.display.currentWheelTarget||sd(h.lineDiv);var j=h.lineDiv,k=j.firstChild,l=d.shift(),m=b;for(a.doc.iter(b,c,function(b){if(l&&l.to==m&&(l=d.shift()),Zb(a.doc,b)){if(0!=b.height&&Ac(b,0),b.widgets&&k&&k.previousSibling)for(var c=0;c<b.widgets.length;++c){var h=b.widgets[c];if(h.showIfHidden){var n=k.previousSibling;if(/pre/i.test(n.nodeName)){var o=rd("div",null,null,"position: relative");n.parentNode.replaceChild(o,n),o.appendChild(n),n=o}var p=n.appendChild(rd("div",[h.node],"CodeMirror-linewidget"));h.handleMouseEvents||(p.ignoreEvents=!0),C(h,p,n,g)}}}else if(l&&l.from<=m&&l.to>m){for(;k.lineObj!=b;)k=f(k);i&&m>=e&&k.lineNumber&&ud(k.lineNumber,s(a.options,m)),k=k.nextSibling}else{if(b.widgets)for(var q,r=0,t=k;t&&20>r;++r,t=t.nextSibling)if(t.lineObj==b&&/div/i.test(t.nodeName)){q=t;break}var u=B(a,b,m,g,q);if(u!=q)j.insertBefore(u,k);else{for(;k!=q;)k=f(k);k=k.nextSibling}u.lineObj=b}++m});k;)k=f(k)}function B(a,b,c,d,e){var f,g=lc(a,b),h=g.pre,i=b.gutterMarkers,j=a.display,k=g.bgClass?g.bgClass+" "+(b.bgClass||""):b.bgClass;if(!(a.options.lineNumbers||i||k||b.wrapClass||b.widgets))return h;if(e){e.alignable=null;for(var l,m=!0,n=0,o=null,p=e.firstChild;p;p=l)if(l=p.nextSibling,/\bCodeMirror-linewidget\b/.test(p.className)){for(var q=0;q<b.widgets.length;++q){var r=b.widgets[q];if(r.node==p.firstChild){r.above||o||(o=p),C(r,p,e,d),++n;break}}if(q==b.widgets.length){m=!1;break}}else e.removeChild(p);e.insertBefore(h,o),m&&n==b.widgets.length&&(f=e,e.className=b.wrapClass||"")}if(f||(f=rd("div",null,b.wrapClass,"position: relative"),f.appendChild(h)),k&&f.insertBefore(rd("div",null,k+" CodeMirror-linebackground"),f.firstChild),a.options.lineNumbers||i){var t=f.insertBefore(rd("div",null,"CodeMirror-gutter-wrapper","position: absolute; left: "+(a.options.fixedGutter?d.fixedPos:-d.gutterTotalWidth)+"px"),h);if(a.options.fixedGutter&&(f.alignable||(f.alignable=[])).push(t),!a.options.lineNumbers||i&&i["CodeMirror-linenumbers"]||(f.lineNumber=t.appendChild(rd("div",s(a.options,c),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+d.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+j.lineNumInnerWidth+"px"))),i)for(var u=0;u<a.options.gutters.length;++u){var v=a.options.gutters[u],w=i.hasOwnProperty(v)&&i[v];w&&t.appendChild(rd("div",[w],"CodeMirror-gutter-elt","left: "+d.gutterLeft[v]+"px; width: "+d.gutterWidth[v]+"px"))}}if(Nd&&(f.style.zIndex=2),b.widgets&&f!=e)for(var q=0,x=b.widgets;q<x.length;++q){var r=x[q],y=rd("div",[r.node],"CodeMirror-linewidget");r.handleMouseEvents||(y.ignoreEvents=!0),C(r,y,f,d),r.above?f.insertBefore(y,a.options.lineNumbers&&0!=b.height?t:h):f.appendChild(y),$c(r,"redraw")}return f}function C(a,b,c,d){if(a.noHScroll){(c.alignable||(c.alignable=[])).push(b);var e=d.wrapperWidth;b.style.left=d.fixedPos+"px",a.coverGutter||(e-=d.gutterTotalWidth,b.style.paddingLeft=d.gutterTotalWidth+"px"),b.style.width=e+"px"}a.coverGutter&&(b.style.zIndex=5,b.style.position="relative",a.noHScroll||(b.style.marginLeft=-d.gutterTotalWidth+"px"))}function D(a){var b=a.display,c=Za(a.doc.sel.from,a.doc.sel.to);if(c||a.options.showCursorWhenSelecting?E(a):b.cursor.style.display=b.otherCursor.style.display="none",c?b.selectionDiv.style.display="none":F(a),a.options.moveInputWithCursor){var d=_(a,a.doc.sel.head,"div"),e=vd(b.wrapper),f=vd(b.lineDiv);b.inputDiv.style.top=Math.max(0,Math.min(b.wrapper.clientHeight-10,d.top+f.top-e.top))+"px",b.inputDiv.style.left=Math.max(0,Math.min(b.wrapper.clientWidth-10,d.left+f.left-e.left))+"px"}}function E(a){var b=a.display,c=_(a,a.doc.sel.head,"div");b.cursor.style.left=c.left+"px",b.cursor.style.top=c.top+"px",b.cursor.style.height=Math.max(0,c.bottom-c.top)*a.options.cursorHeight+"px",b.cursor.style.display="",c.other?(b.otherCursor.style.display="",b.otherCursor.style.left=c.other.left+"px",b.otherCursor.style.top=c.other.top+"px",b.otherCursor.style.height=.85*(c.other.bottom-c.other.top)+"px"):b.otherCursor.style.display="none"}function F(a){function b(a,b,c,d){0>b&&(b=0),g.appendChild(rd("div",null,"CodeMirror-selected","position: absolute; left: "+a+"px; top: "+b+"px; width: "+(null==c?j-a:c)+"px; height: "+(d-b)+"px"))}function c(c,d,f){function g(b,d){return $(a,Ya(c,b),"div",l,d)}var h,k,l=xc(e,c),m=l.text.length;return zd(Ec(l),d||0,null==f?m:f,function(a,c,e){var l,n,o,p=g(a,"left");if(a==c)l=p,n=o=p.left;else{if(l=g(c-1,"right"),"rtl"==e){var q=p;p=l,l=q}n=p.left,o=l.right}null==d&&0==a&&(n=i),l.top-p.top>3&&(b(n,p.top,null,p.bottom),n=i,p.bottom<l.top&&b(n,p.bottom,null,l.top)),null==f&&c==m&&(o=j),(!h||p.top<h.top||p.top==h.top&&p.left<h.left)&&(h=p),(!k||l.bottom>k.bottom||l.bottom==k.bottom&&l.right>k.right)&&(k=l),i+1>n&&(n=i),b(n,l.top,o-n,l.bottom)}),{start:h,end:k}}var d=a.display,e=a.doc,f=a.doc.sel,g=document.createDocumentFragment(),h=N(a.display),i=h.left,j=d.lineSpace.offsetWidth-h.right;if(f.from.line==f.to.line)c(f.from.line,f.from.ch,f.to.ch);else{var k=xc(e,f.from.line),l=xc(e,f.to.line),m=Yb(e,k)==Yb(e,l),n=c(f.from.line,f.from.ch,m?k.text.length:null).end,o=c(f.to.line,m?0:null,f.to.ch).start;m&&(n.top<o.top-2?(b(n.right,n.top,null,n.bottom),b(i,o.top,o.left,o.bottom)):b(n.right,n.top,o.left-n.right,n.bottom)),n.bottom<o.top&&b(i,n.bottom,null,o.top)}td(d.selectionDiv,g),d.selectionDiv.style.display=""}function G(a){if(a.state.focused){var b=a.display;clearInterval(b.blinker);var c=!0;b.cursor.style.visibility=b.otherCursor.style.visibility="",a.options.cursorBlinkRate>0&&(b.blinker=setInterval(function(){b.cursor.style.visibility=b.otherCursor.style.visibility=(c=!c)?"":"hidden"},a.options.cursorBlinkRate))}}function H(a,b){a.doc.mode.startState&&a.doc.frontier<a.display.showingTo&&a.state.highlight.set(b,md(I,a))}function I(a){var b=a.doc;if(b.frontier<b.first&&(b.frontier=b.first),!(b.frontier>=a.display.showingTo)){var c,d=+new Date+a.options.workTime,e=xb(b.mode,K(a,b.frontier)),f=[];b.iter(b.frontier,Math.min(b.first+b.size,a.display.showingTo+500),function(g){if(b.frontier>=a.display.showingFrom){var h=g.styles;g.styles=hc(a,g,e,!0);for(var i=!h||h.length!=g.styles.length,j=0;!i&&j<h.length;++j)i=h[j]!=g.styles[j];i&&(c&&c.end==b.frontier?c.end++:f.push(c={start:b.frontier,end:b.frontier+1})),g.stateAfter=xb(b.mode,e)}else jc(a,g.text,e),g.stateAfter=b.frontier%5==0?xb(b.mode,e):null;return++b.frontier,+new Date>d?(H(a,a.options.workDelay),!0):void 0}),f.length&&ha(a,function(){for(var a=0;a<f.length;++a)ka(this,f[a].start,f[a].end)})()}}function J(a,b,c){for(var d,e,f=a.doc,g=c?-1:b-(a.doc.mode.innerMode?1e3:100),h=b;h>g;--h){if(h<=f.first)return f.first;var i=xc(f,h-1);if(i.stateAfter&&(!c||h<=f.frontier))return h;var j=ed(i.text,null,a.options.tabSize);(null==e||d>j)&&(e=h-1,d=j)}return e}function K(a,b,c){var d=a.doc,e=a.display;if(!d.mode.startState)return!0;var f=J(a,b,c),g=f>d.first&&xc(d,f-1).stateAfter;return g=g?xb(d.mode,g):yb(d.mode),d.iter(f,b,function(c){jc(a,c.text,g);var h=f==b-1||f%5==0||f>=e.showingFrom&&f<e.showingTo;c.stateAfter=h?xb(d.mode,g):null,++f}),c&&(d.frontier=f),g}function L(a){return a.lineSpace.offsetTop}function M(a){return a.mover.offsetHeight-a.lineSpace.offsetHeight}function N(a){if(a.cachedPaddingH)return a.cachedPaddingH;var b=td(a.measure,rd("pre","x")),c=window.getComputedStyle?window.getComputedStyle(b):b.currentStyle;return a.cachedPaddingH={left:parseInt(c.paddingLeft),right:parseInt(c.paddingRight)}}function O(a,b,c,d,e){var f=-1;if(d=d||R(a,b),d.crude){var g=d.left+c*d.width;return{left:g,right:g+d.width,top:d.top,bottom:d.bottom}}for(var h=c;;h+=f){var i=d[h];if(i)break;0>f&&0==h&&(f=1)}return e=h>c?"left":c>h?"right":e,"left"==e&&i.leftSide?i=i.leftSide:"right"==e&&i.rightSide&&(i=i.rightSide),{left:c>h?i.right:i.left,right:h>c?i.left:i.right,top:i.top,bottom:i.bottom}}function P(a,b){for(var c=a.display.measureLineCache,d=0;d<c.length;++d){var e=c[d];if(e.text==b.text&&e.markedSpans==b.markedSpans&&a.display.scroller.clientWidth==e.width&&e.classes==b.textClass+"|"+b.wrapClass)return e}}function Q(a,b){var c=P(a,b);c&&(c.text=c.measure=c.markedSpans=null)}function R(a,b){var c=P(a,b);if(c)return c.measure;var d=S(a,b),e=a.display.measureLineCache,f={text:b.text,width:a.display.scroller.clientWidth,markedSpans:b.markedSpans,measure:d,classes:b.textClass+"|"+b.wrapClass};return 16==e.length?e[++a.display.measureLineCachePos%16]=f:e.push(f),d}function S(a,b){function c(a){var b=a.top-o.top,c=a.bottom-o.top;c>r&&(c=r),0>b&&(b=0);for(var d=p.length-2;d>=0;d-=2){var e=p[d],f=p[d+1];if(!(e>c||b>f)&&(b>=e&&f>=c||e>=b&&c>=f||Math.min(c,f)-Math.max(b,e)>=c-b>>1)){p[d]=Math.min(b,e),p[d+1]=Math.max(c,f);break}}return 0>d&&(d=p.length,p.push(b,c)),{left:a.left-o.left,right:a.right-o.left,top:d,bottom:null}}function d(a){a.bottom=p[a.top+1],a.top=p[a.top]}if(!a.options.lineWrapping&&b.text.length>=a.options.crudeMeasuringFrom)return T(a,b);var e=a.display,f=ld(b.text.length),g=lc(a,b,f,!0).pre;if(Md&&!Nd&&!a.options.lineWrapping&&g.childNodes.length>100){for(var h=document.createDocumentFragment(),i=10,j=g.childNodes.length,k=0,l=Math.ceil(j/i);l>k;++k){for(var m=rd("div",null,null,"display: inline-block"),n=0;i>n&&j;++n)m.appendChild(g.firstChild),--j;h.appendChild(m)}g.appendChild(h)}td(e.measure,g);var o=vd(e.lineDiv),p=[],q=ld(b.text.length),r=g.offsetHeight;Od&&e.measure.first!=g&&td(e.measure,g);for(var s,k=0;k<f.length;++k)if(s=f[k]){var t=s,u=null;if(/\bCodeMirror-widget\b/.test(s.className)&&s.getClientRects){1==s.firstChild.nodeType&&(t=s.firstChild);var v=t.getClientRects();v.length>1&&(u=q[k]=c(v[0]),u.rightSide=c(v[v.length-1]))}u||(u=q[k]=c(vd(t))),s.measureRight&&(u.right=vd(s.measureRight).left-o.left),s.leftSide&&(u.leftSide=c(vd(s.leftSide)))}sd(a.display.measure);for(var s,k=0;k<q.length;++k)(s=q[k])&&(d(s),s.leftSide&&d(s.leftSide),s.rightSide&&d(s.rightSide));return q}function T(a,b){var c=new Fe(b.text.slice(0,100),null);b.textClass&&(c.textClass=b.textClass);var d=S(a,c),e=O(a,c,0,d,"left"),f=O(a,c,99,d,"right");return{crude:!0,top:e.top,left:e.left,bottom:e.bottom,width:(f.right-e.left)/100}}function U(a,b){var c=!1;if(b.markedSpans)for(var d=0;d<b.markedSpans;++d){var e=b.markedSpans[d];!e.collapsed||null!=e.to&&e.to!=b.text.length||(c=!0)}var f=!c&&P(a,b);if(f||b.text.length>=a.options.crudeMeasuringFrom)return O(a,b,b.text.length,f&&f.measure,"right").right;var g=lc(a,b,null,!0).pre,h=g.appendChild(yd(a.display.measure));return td(a.display.measure,g),vd(h).right-vd(a.display.lineDiv).left}function V(a){a.display.measureLineCache.length=a.display.measureLineCachePos=0,a.display.cachedCharWidth=a.display.cachedTextHeight=a.display.cachedPaddingH=null,a.options.lineWrapping||(a.display.maxLineChanged=!0),a.display.lineNumChars=null}function W(){return window.pageXOffset||(document.documentElement||document.body).scrollLeft}function X(){return window.pageYOffset||(document.documentElement||document.body).scrollTop}function Y(a,b,c,d){if(b.widgets)for(var e=0;e<b.widgets.length;++e)if(b.widgets[e].above){var f=cc(b.widgets[e]);c.top+=f,c.bottom+=f}if("line"==d)return c;d||(d="local");var g=Dc(a,b);if("local"==d?g+=L(a.display):g-=a.display.viewOffset,"page"==d||"window"==d){var h=vd(a.display.lineSpace);g+=h.top+("window"==d?0:X());var i=h.left+("window"==d?0:W());c.left+=i,c.right+=i}return c.top+=g,c.bottom+=g,c}function Z(a,b,c){if("div"==c)return b;var d=b.left,e=b.top;if("page"==c)d-=W(),e-=X();else if("local"==c||!c){var f=vd(a.display.sizer);d+=f.left,e+=f.top}var g=vd(a.display.lineSpace);return{left:d-g.left,top:e-g.top}}function $(a,b,c,d,e){return d||(d=xc(a.doc,b.line)),Y(a,d,O(a,d,b.ch,null,e),c)}function _(a,b,c,d,e){function f(b,f){var g=O(a,d,b,e,f?"right":"left");return f?g.left=g.right:g.right=g.left,Y(a,d,g,c)}function g(a,b){var c=h[b],d=c.level%2;return a==Ad(c)&&b&&c.level<h[b-1].level?(c=h[--b],a=Bd(c)-(c.level%2?0:1),d=!0):a==Bd(c)&&b<h.length-1&&c.level<h[b+1].level&&(c=h[++b],a=Ad(c)-c.level%2,d=!1),d&&a==c.to&&a>c.from?f(a-1):f(a,d);
}d=d||xc(a.doc,b.line),e||(e=R(a,d));var h=Ec(d),i=b.ch;if(!h)return f(i);var j=Hd(h,i),k=g(i,j);return null!=$e&&(k.other=g(i,$e)),k}function aa(a,b,c,d){var e=new Ya(a,b);return e.xRel=d,c&&(e.outside=!0),e}function ba(a,b,c){var d=a.doc;if(c+=a.display.viewOffset,0>c)return aa(d.first,0,!0,-1);var e=Cc(d,c),f=d.first+d.size-1;if(e>f)return aa(d.first+d.size-1,xc(d,f).text.length,!0,1);for(0>b&&(b=0);;){var g=xc(d,e),h=ca(a,g,e,b,c),i=Wb(g),j=i&&i.find();if(!i||!(h.ch>j.from.ch||h.ch==j.from.ch&&h.xRel>0))return h;e=j.to.line}}function ca(a,b,c,d,e){function f(d){var e=_(a,Ya(c,d),"line",b,j);return h=!0,g>e.bottom?e.left-i:g<e.top?e.left+i:(h=!1,e.left)}var g=e-Dc(a,b),h=!1,i=2*a.display.wrapper.clientWidth,j=R(a,b),k=Ec(b),l=b.text.length,m=Cd(b),n=Dd(b),o=f(m),p=h,q=f(n),r=h;if(d>q)return aa(c,n,r,1);for(;;){if(k?n==m||n==Jd(b,m,1):1>=n-m){for(var s=o>d||q-d>=d-o?m:n,t=d-(s==m?o:q);pd(b.text.charAt(s));)++s;var u=aa(c,s,s==m?p:r,0>t?-1:t?1:0);return u}var v=Math.ceil(l/2),w=m+v;if(k){w=m;for(var x=0;v>x;++x)w=Jd(b,w,1)}var y=f(w);y>d?(n=w,q=y,(r=h)&&(q+=1e3),l=v):(m=w,o=y,p=h,l-=v)}}function da(a){if(null!=a.cachedTextHeight)return a.cachedTextHeight;if(null==ee){ee=rd("pre");for(var b=0;49>b;++b)ee.appendChild(document.createTextNode("x")),ee.appendChild(rd("br"));ee.appendChild(document.createTextNode("x"))}td(a.measure,ee);var c=ee.offsetHeight/50;return c>3&&(a.cachedTextHeight=c),sd(a.measure),c||1}function ea(a){if(null!=a.cachedCharWidth)return a.cachedCharWidth;var b=rd("span","x"),c=rd("pre",[b]);td(a.measure,c);var d=b.offsetWidth;return d>2&&(a.cachedCharWidth=d),d||10}function fa(a){a.curOp={changes:[],forceUpdate:!1,updateInput:null,userSelChange:null,textChanged:null,selectionChanged:!1,cursorActivity:!1,updateMaxLine:!1,updateScrollPos:!1,id:++le},Ne++||(Me=[])}function ga(a){var b=a.curOp,c=a.doc,d=a.display;if(a.curOp=null,b.updateMaxLine&&m(a),d.maxLineChanged&&!a.options.lineWrapping&&d.maxLine){var e=U(a,d.maxLine);d.sizer.style.minWidth=Math.max(0,e+3)+"px",d.maxLineChanged=!1;var f=Math.max(0,d.sizer.offsetLeft+d.sizer.offsetWidth-d.scroller.clientWidth);f<c.scrollLeft&&!b.updateScrollPos&&Ca(a,Math.min(d.scroller.scrollLeft,f),!0)}var g,h;if(b.updateScrollPos)g=b.updateScrollPos;else if(b.selectionChanged&&d.scroller.clientHeight){var i=_(a,c.sel.head);g=nb(a,i.left,i.top,i.left,i.bottom)}if((b.changes.length||b.forceUpdate||g&&null!=g.scrollTop)&&(h=u(a,b.changes,g&&g.scrollTop,b.forceUpdate),a.display.scroller.offsetHeight&&(a.doc.scrollTop=a.display.scroller.scrollTop)),!h&&b.selectionChanged&&D(a),b.updateScrollPos){var j=Math.max(0,Math.min(d.scroller.scrollHeight-d.scroller.clientHeight,g.scrollTop)),k=Math.max(0,Math.min(d.scroller.scrollWidth-d.scroller.clientWidth,g.scrollLeft));d.scroller.scrollTop=d.scrollbarV.scrollTop=c.scrollTop=j,d.scroller.scrollLeft=d.scrollbarH.scrollLeft=c.scrollLeft=k,q(a),b.scrollToPos&&lb(a,cb(a.doc,b.scrollToPos.from),cb(a.doc,b.scrollToPos.to),b.scrollToPos.margin)}else g&&kb(a);b.selectionChanged&&G(a),a.state.focused&&b.updateInput&&oa(a,b.userSelChange);var l=b.maybeHiddenMarkers,n=b.maybeUnhiddenMarkers;if(l)for(var o=0;o<l.length;++o)l[o].lines.length||Zc(l[o],"hide");if(n)for(var o=0;o<n.length;++o)n[o].lines.length&&Zc(n[o],"unhide");var p;if(--Ne||(p=Me,Me=null),b.textChanged&&Zc(a,"change",a,b.textChanged),b.cursorActivity&&Zc(a,"cursorActivity",a),p)for(var o=0;o<p.length;++o)p[o]()}function ha(a,b){return function(){var c=a||this,d=!c.curOp;d&&fa(c);try{var e=b.apply(c,arguments)}finally{d&&ga(c)}return e}}function ia(a){return function(){var b,c=this.cm&&!this.cm.curOp;c&&fa(this.cm);try{b=a.apply(this,arguments)}finally{c&&ga(this.cm)}return b}}function ja(a,b){var c,d=!a.curOp;d&&fa(a);try{c=b()}finally{d&&ga(a)}return c}function ka(a,b,c,d){null==b&&(b=a.doc.first),null==c&&(c=a.doc.first+a.doc.size),a.curOp.changes.push({from:b,to:c,diff:d})}function la(a){a.display.pollingFast||a.display.poll.set(a.options.pollInterval,function(){na(a),a.state.focused&&la(a)})}function ma(a){function b(){var d=na(a);d||c?(a.display.pollingFast=!1,la(a)):(c=!0,a.display.poll.set(60,b))}var c=!1;a.display.pollingFast=!0,a.display.poll.set(20,b)}function na(a){var b=a.display.input,c=a.display.prevInput,d=a.doc,e=d.sel;if(!a.state.focused||Xe(b)||ra(a)||a.options.disableInput)return!1;a.state.pasteIncoming&&a.state.fakedLastChar&&(b.value=b.value.substring(0,b.value.length-1),a.state.fakedLastChar=!1);var f=b.value;if(f==c&&Za(e.from,e.to))return!1;if(Rd&&!Od&&a.display.inputHasSelection===f)return oa(a,!0),!1;var g=!a.curOp;g&&fa(a),e.shift=!1;for(var h=0,i=Math.min(c.length,f.length);i>h&&c.charCodeAt(h)==f.charCodeAt(h);)++h;var j=e.from,k=e.to,l=f.slice(h);h<c.length?j=Ya(j.line,j.ch-(c.length-h)):a.state.overwrite&&Za(j,k)&&!a.state.pasteIncoming&&(k=Ya(k.line,Math.min(xc(d,k.line).text.length,k.ch+l.length)));var m=a.curOp.updateInput,n={from:j,to:k,text:We(l),origin:a.state.pasteIncoming?"paste":a.state.cutIncoming?"cut":"+input"};if(Ra(a.doc,n,"end"),a.curOp.updateInput=m,$c(a,"inputRead",a,n),l&&!a.state.pasteIncoming&&a.options.electricChars&&a.options.smartIndent&&e.head.ch<100){var o=a.getModeAt(e.head).electricChars;if(o)for(var p=0;p<o.length;p++)if(l.indexOf(o.charAt(p))>-1){qb(a,e.head.line,"smart");break}}return f.length>1e3||f.indexOf("\n")>-1?b.value=a.display.prevInput="":a.display.prevInput=f,g&&ga(a),a.state.pasteIncoming=a.state.cutIncoming=!1,!0}function oa(a,b){var c,d,e=a.doc;if(Za(e.sel.from,e.sel.to))b&&(a.display.prevInput=a.display.input.value="",Rd&&!Od&&(a.display.inputHasSelection=null));else{a.display.prevInput="",c=Ye&&(e.sel.to.line-e.sel.from.line>100||(d=a.getSelection()).length>1e3);var f=c?"-":d||a.getSelection();a.display.input.value=f,a.state.focused&&hd(a.display.input),Rd&&!Od&&(a.display.inputHasSelection=f)}a.display.inaccurateSelection=c}function pa(a){"nocursor"==a.options.readOnly||ae&&document.activeElement==a.display.input||a.display.input.focus()}function qa(a){a.state.focused||(pa(a),La(a))}function ra(a){return a.options.readOnly||a.doc.cantEdit}function sa(a){function b(){a.state.focused&&setTimeout(md(pa,a),0)}function c(){null==h&&(h=setTimeout(function(){h=null,g.cachedCharWidth=g.cachedTextHeight=g.cachedPaddingH=Ue=null,V(a),ja(a,md(ka,a))},100))}function d(){for(var a=g.wrapper.parentNode;a&&a!=document.body;a=a.parentNode);a?setTimeout(d,5e3):Yc(window,"resize",c)}function e(b){_c(a,b)||a.options.onDragEvent&&a.options.onDragEvent(a,Qc(b))||Uc(b)}function f(b){g.inaccurateSelection&&(g.prevInput="",g.inaccurateSelection=!1,g.input.value=a.getSelection(),hd(g.input)),"cut"==b.type&&(a.state.cutIncoming=!0)}var g=a.display;Xc(g.scroller,"mousedown",ha(a,va)),Md?Xc(g.scroller,"dblclick",ha(a,function(b){if(!_c(a,b)){var c=ua(a,b);if(c&&!ya(a,b)&&!ta(a.display,b)){Rc(b);var d=ub(xc(a.doc,c.line).text,c);fb(a.doc,d.from,d.to)}}})):Xc(g.scroller,"dblclick",function(b){_c(a,b)||Rc(b)}),Xc(g.lineSpace,"selectstart",function(a){ta(g,a)||Rc(a)}),ie||Xc(g.scroller,"contextmenu",function(b){Na(a,b)}),Xc(g.scroller,"scroll",function(){g.scroller.clientHeight&&(Ba(a,g.scroller.scrollTop),Ca(a,g.scroller.scrollLeft,!0),Zc(a,"scroll",a))}),Xc(g.scrollbarV,"scroll",function(){g.scroller.clientHeight&&Ba(a,g.scrollbarV.scrollTop)}),Xc(g.scrollbarH,"scroll",function(){g.scroller.clientHeight&&Ca(a,g.scrollbarH.scrollLeft)}),Xc(g.scroller,"mousewheel",function(b){Da(a,b)}),Xc(g.scroller,"DOMMouseScroll",function(b){Da(a,b)}),Xc(g.scrollbarH,"mousedown",b),Xc(g.scrollbarV,"mousedown",b),Xc(g.wrapper,"scroll",function(){g.wrapper.scrollTop=g.wrapper.scrollLeft=0});var h;Xc(window,"resize",c),setTimeout(d,5e3),Xc(g.input,"keyup",ha(a,Ia)),Xc(g.input,"input",function(){Rd&&!Od&&a.display.inputHasSelection&&(a.display.inputHasSelection=null),ma(a)}),Xc(g.input,"keydown",ha(a,Ja)),Xc(g.input,"keypress",ha(a,Ka)),Xc(g.input,"focus",md(La,a)),Xc(g.input,"blur",md(Ma,a)),a.options.dragDrop&&(Xc(g.scroller,"dragstart",function(b){Aa(a,b)}),Xc(g.scroller,"dragenter",e),Xc(g.scroller,"dragover",e),Xc(g.scroller,"drop",ha(a,za))),Xc(g.scroller,"paste",function(b){ta(g,b)||(pa(a),ma(a))}),Xc(g.input,"paste",function(){if(Sd&&!a.state.fakedLastChar&&!(new Date-a.state.lastMiddleDown<200)){var b=g.input.selectionStart,c=g.input.selectionEnd;g.input.value+="$",g.input.selectionStart=b,g.input.selectionEnd=c,a.state.fakedLastChar=!0}a.state.pasteIncoming=!0,ma(a)}),Xc(g.input,"cut",f),Xc(g.input,"copy",f),Xd&&Xc(g.sizer,"mouseup",function(){document.activeElement==g.input&&g.input.blur(),pa(a)})}function ta(a,b){for(var c=Vc(b);c!=a.wrapper;c=c.parentNode)if(!c||c.ignoreEvents||c.parentNode==a.sizer&&c!=a.mover)return!0}function ua(a,b,c){var d=a.display;if(!c){var e=Vc(b);if(e==d.scrollbarH||e==d.scrollbarH.firstChild||e==d.scrollbarV||e==d.scrollbarV.firstChild||e==d.scrollbarFiller||e==d.gutterFiller)return null}var f,g,h=vd(d.lineSpace);try{f=b.clientX,g=b.clientY}catch(b){return null}return ba(a,f-h.left,g-h.top)}function va(a){function b(a){if(!Za(r,a)){if(r=a,"single"==k)return void fb(e.doc,cb(g,i),a);if(o=cb(g,o),q=cb(g,q),"double"==k){var b=ub(xc(g,a.line).text,a);$a(a,o)?fb(e.doc,b.from,q):fb(e.doc,o,b.to)}else"triple"==k&&($a(a,o)?fb(e.doc,q,cb(g,Ya(a.line,0))):fb(e.doc,o,cb(g,Ya(a.line+1,0))))}}function c(a){var d=++t,h=ua(e,a,!0);if(h)if(Za(h,m)){var i=a.clientY<s.top?-20:a.clientY>s.bottom?20:0;i&&setTimeout(ha(e,function(){t==d&&(f.scroller.scrollTop+=i,c(a))}),50)}else{qa(e),m=h,b(h);var j=p(f,g);(h.line>=j.to||h.line<j.from)&&setTimeout(ha(e,function(){t==d&&c(a)}),150)}}function d(a){t=1/0,Rc(a),pa(e),Yc(document,"mousemove",u),Yc(document,"mouseup",v)}if(!_c(this,a)){var e=this,f=e.display,g=e.doc,h=g.sel;if(h.shift=a.shiftKey,ta(f,a))return void(Sd||(f.scroller.draggable=!1,setTimeout(function(){f.scroller.draggable=!0},100)));if(!ya(e,a)){var i=ua(e,a);switch(window.focus(),Wc(a)){case 3:return void(ie&&Na.call(e,e,a));case 2:return Sd&&(e.state.lastMiddleDown=+new Date),i&&fb(e.doc,i),setTimeout(md(pa,e),20),void Rc(a)}if(!i)return void(Vc(a)==f.scroller&&Rc(a));setTimeout(md(qa,e),0);var j=+new Date,k="single";if(ge&&ge.time>j-400&&Za(ge.pos,i))k="triple",Rc(a),setTimeout(md(pa,e),20),vb(e,i.line);else if(fe&&fe.time>j-400&&Za(fe.pos,i)){k="double",ge={time:j,pos:i},Rc(a);var l=ub(xc(g,i.line).text,i);fb(e.doc,l.from,l.to)}else fe={time:j,pos:i};var m=i;if(e.options.dragDrop&&Te&&!ra(e)&&!Za(h.from,h.to)&&!$a(i,h.from)&&!$a(h.to,i)&&"single"==k){var n=ha(e,function(b){Sd&&(f.scroller.draggable=!1),e.state.draggingText=!1,Yc(document,"mouseup",n),Yc(f.scroller,"drop",n),Math.abs(a.clientX-b.clientX)+Math.abs(a.clientY-b.clientY)<10&&(Rc(b),fb(e.doc,i),pa(e),Md&&!Od&&setTimeout(function(){document.body.focus(),pa(e)},20))});return Sd&&(f.scroller.draggable=!0),e.state.draggingText=n,f.scroller.dragDrop&&f.scroller.dragDrop(),Xc(document,"mouseup",n),void Xc(f.scroller,"drop",n)}Rc(a),"single"==k&&fb(e.doc,cb(g,i));var o=h.from,q=h.to,r=i,s=vd(f.wrapper),t=0,u=ha(e,function(a){(Rd&&!Pd?a.buttons:Wc(a))?c(a):d(a)}),v=ha(e,d);Xc(document,"mousemove",u),Xc(document,"mouseup",v)}}}function wa(a,b,c,d,e){try{var f=b.clientX,g=b.clientY}catch(b){return!1}if(f>=Math.floor(vd(a.display.gutters).right))return!1;d&&Rc(b);var h=a.display,i=vd(h.lineDiv);if(g>i.bottom||!bd(a,c))return Tc(b);g-=i.top-h.viewOffset;for(var j=0;j<a.options.gutters.length;++j){var k=h.gutters.childNodes[j];if(k&&vd(k).right>=f){var l=Cc(a.doc,g),m=a.options.gutters[j];return e(a,c,a,l,m,b),Tc(b)}}}function xa(a,b){return bd(a,"gutterContextMenu")?wa(a,b,"gutterContextMenu",!1,Zc):!1}function ya(a,b){return wa(a,b,"gutterClick",!0,$c)}function za(a){var b=this;if(!(_c(b,a)||ta(b.display,a)||b.options.onDragEvent&&b.options.onDragEvent(b,Qc(a)))){Rc(a),Rd&&(me=+new Date);var c=ua(b,a,!0),d=a.dataTransfer.files;if(c&&!ra(b))if(d&&d.length&&window.FileReader&&window.File)for(var e=d.length,f=Array(e),g=0,h=function(a,d){var h=new FileReader;h.onload=function(){f[d]=h.result,++g==e&&(c=cb(b.doc,c),Ra(b.doc,{from:c,to:c,text:We(f.join("\n")),origin:"paste"},"around"))},h.readAsText(a)},i=0;e>i;++i)h(d[i],i);else{if(b.state.draggingText&&!$a(c,b.doc.sel.from)&&!$a(b.doc.sel.to,c))return b.state.draggingText(a),void setTimeout(md(pa,b),20);try{var f=a.dataTransfer.getData("Text");if(f){var j=b.doc.sel.from,k=b.doc.sel.to;hb(b.doc,c,c),b.state.draggingText&&Xa(b.doc,"",j,k,"paste"),b.replaceSelection(f,null,"paste"),pa(b)}}catch(a){}}}}function Aa(a,b){if(Rd&&(!a.state.draggingText||+new Date-me<100))return void Uc(b);if(!_c(a,b)&&!ta(a.display,b)){var c=a.getSelection();if(b.dataTransfer.setData("Text",c),b.dataTransfer.setDragImage&&!Wd){var d=rd("img",null,null,"position: fixed; left: 0; top: 0;");d.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",Vd&&(d.width=d.height=1,a.display.wrapper.appendChild(d),d._top=d.offsetTop),b.dataTransfer.setDragImage(d,0,0),Vd&&d.parentNode.removeChild(d)}}}function Ba(a,b){Math.abs(a.doc.scrollTop-b)<2||(a.doc.scrollTop=b,Ld||u(a,[],b),a.display.scroller.scrollTop!=b&&(a.display.scroller.scrollTop=b),a.display.scrollbarV.scrollTop!=b&&(a.display.scrollbarV.scrollTop=b),Ld&&u(a,[]),H(a,100))}function Ca(a,b,c){(c?b==a.doc.scrollLeft:Math.abs(a.doc.scrollLeft-b)<2)||(b=Math.min(b,a.display.scroller.scrollWidth-a.display.scroller.clientWidth),a.doc.scrollLeft=b,q(a),a.display.scroller.scrollLeft!=b&&(a.display.scroller.scrollLeft=b),a.display.scrollbarH.scrollLeft!=b&&(a.display.scrollbarH.scrollLeft=b))}function Da(a,b){var c=b.wheelDeltaX,d=b.wheelDeltaY;null==c&&b.detail&&b.axis==b.HORIZONTAL_AXIS&&(c=b.detail),null==d&&b.detail&&b.axis==b.VERTICAL_AXIS?d=b.detail:null==d&&(d=b.wheelDelta);var e=a.display,f=e.scroller;if(c&&f.scrollWidth>f.clientWidth||d&&f.scrollHeight>f.clientHeight){if(d&&be&&Sd)for(var g=b.target;g!=f;g=g.parentNode)if(g.lineObj){a.display.currentWheelTarget=g;break}if(c&&!Ld&&!Vd&&null!=oe)return d&&Ba(a,Math.max(0,Math.min(f.scrollTop+d*oe,f.scrollHeight-f.clientHeight))),Ca(a,Math.max(0,Math.min(f.scrollLeft+c*oe,f.scrollWidth-f.clientWidth))),Rc(b),void(e.wheelStartX=null);if(d&&null!=oe){var h=d*oe,i=a.doc.scrollTop,j=i+e.wrapper.clientHeight;0>h?i=Math.max(0,i+h-50):j=Math.min(a.doc.height,j+h+50),u(a,[],{top:i,bottom:j})}20>ne&&(null==e.wheelStartX?(e.wheelStartX=f.scrollLeft,e.wheelStartY=f.scrollTop,e.wheelDX=c,e.wheelDY=d,setTimeout(function(){if(null!=e.wheelStartX){var a=f.scrollLeft-e.wheelStartX,b=f.scrollTop-e.wheelStartY,c=b&&e.wheelDY&&b/e.wheelDY||a&&e.wheelDX&&a/e.wheelDX;e.wheelStartX=e.wheelStartY=null,c&&(oe=(oe*ne+c)/(ne+1),++ne)}},200)):(e.wheelDX+=c,e.wheelDY+=d))}}function Ea(a,b,c){if("string"==typeof b&&(b=Be[b],!b))return!1;a.display.pollingFast&&na(a)&&(a.display.pollingFast=!1);var d=a.doc,e=d.sel.shift,f=!1;try{ra(a)&&(a.state.suppressEdits=!0),c&&(d.sel.shift=!1),f=b(a)!=Pe}finally{d.sel.shift=e,a.state.suppressEdits=!1}return f}function Fa(a){var b=a.state.keyMaps.slice(0);return a.options.extraKeys&&b.push(a.options.extraKeys),b.push(a.options.keyMap),b}function Ga(a,b){var c=zb(a.options.keyMap),d=c.auto;clearTimeout(pe),d&&!Bb(b)&&(pe=setTimeout(function(){zb(a.options.keyMap)==c&&(a.options.keyMap=d.call?d.call(null,a):d,h(a))},50));var e=Cb(b,!0),f=!1;if(!e)return!1;var g=Fa(a);return f=b.shiftKey?Ab("Shift-"+e,g,function(b){return Ea(a,b,!0)})||Ab(e,g,function(b){return("string"==typeof b?/^go[A-Z]/.test(b):b.motion)?Ea(a,b):void 0}):Ab(e,g,function(b){return Ea(a,b)}),f&&(Rc(b),G(a),Od&&(b.oldKeyCode=b.keyCode,b.keyCode=0),$c(a,"keyHandled",a,e,b)),f}function Ha(a,b,c){var d=Ab("'"+c+"'",Fa(a),function(b){return Ea(a,b,!0)});return d&&(Rc(b),G(a),$c(a,"keyHandled",a,"'"+c+"'",b)),d}function Ia(a){var b=this;_c(b,a)||b.options.onKeyEvent&&b.options.onKeyEvent(b,Qc(a))||16==a.keyCode&&(b.doc.sel.shift=!1)}function Ja(a){var b=this;if(qa(b),!(_c(b,a)||b.options.onKeyEvent&&b.options.onKeyEvent(b,Qc(a)))){Md&&27==a.keyCode&&(a.returnValue=!1);var c=a.keyCode;b.doc.sel.shift=16==c||a.shiftKey;var d=Ga(b,a);Vd&&(re=d?c:null,!d&&88==c&&!Ye&&(be?a.metaKey:a.ctrlKey)&&b.replaceSelection(""))}}function Ka(a){var b=this;if(!(_c(b,a)||b.options.onKeyEvent&&b.options.onKeyEvent(b,Qc(a)))){var c=a.keyCode,d=a.charCode;if(Vd&&c==re)return re=null,void Rc(a);if(!(Vd&&(!a.which||a.which<10)||Xd)||!Ga(b,a)){var e=String.fromCharCode(null==d?c:d);Ha(b,a,e)||(Rd&&!Od&&(b.display.inputHasSelection=null),ma(b))}}}function La(a){"nocursor"!=a.options.readOnly&&(a.state.focused||(Zc(a,"focus",a),a.state.focused=!0,-1==a.display.wrapper.className.search(/\bCodeMirror-focused\b/)&&(a.display.wrapper.className+=" CodeMirror-focused"),a.curOp||(oa(a,!0),Sd&&setTimeout(md(oa,a,!0),0))),la(a),G(a))}function Ma(a){a.state.focused&&(Zc(a,"blur",a),a.state.focused=!1,a.display.wrapper.className=a.display.wrapper.className.replace(" CodeMirror-focused","")),clearInterval(a.display.blinker),setTimeout(function(){a.state.focused||(a.doc.sel.shift=!1)},150)}function Na(a,b){function c(){if(null!=e.input.selectionStart){var a=e.input.value="​"+(Za(f.from,f.to)?"":e.input.value);e.prevInput="​",e.input.selectionStart=1,e.input.selectionEnd=a.length}}function d(){if(e.inputDiv.style.position="relative",e.input.style.cssText=j,Od&&(e.scrollbarV.scrollTop=e.scroller.scrollTop=h),la(a),null!=e.input.selectionStart){(!Rd||Od)&&c(),clearTimeout(qe);var b=0,d=function(){"​"==e.prevInput&&0==e.input.selectionStart?ha(a,Be.selectAll)(a):b++<10?qe=setTimeout(d,500):oa(a)};qe=setTimeout(d,200)}}if(!_c(a,b,"contextmenu")){var e=a.display,f=a.doc.sel;if(!ta(e,b)&&!xa(a,b)){var g=ua(a,b),h=e.scroller.scrollTop;if(g&&!Vd){var i=a.options.resetSelectionOnContextMenu;i&&(Za(f.from,f.to)||$a(g,f.from)||!$a(g,f.to))&&ha(a,hb)(a.doc,g,g);var j=e.input.style.cssText;if(e.inputDiv.style.position="absolute",e.input.style.cssText="position: fixed; width: 30px; height: 30px; top: "+(b.clientY-5)+"px; left: "+(b.clientX-5)+"px; z-index: 1000; background: transparent; outline: none;border-width: 0; outline: none; overflow: hidden; opacity: .05; -ms-opacity: .05; filter: alpha(opacity=5);",pa(a),oa(a,!0),Za(f.from,f.to)&&(e.input.value=e.prevInput=" "),Rd&&!Od&&c(),ie){Uc(b);var k=function(){Yc(window,"mouseup",k),setTimeout(d,20)};Xc(window,"mouseup",k)}else setTimeout(d,50)}}}}function Oa(a,b,c){if(!$a(b.from,c))return cb(a,c);var d=b.text.length-1-(b.to.line-b.from.line);if(c.line>b.to.line+d){var e=c.line-d,f=a.first+a.size-1;return e>f?Ya(f,xc(a,f).text.length):db(c,xc(a,e).text.length)}if(c.line==b.to.line+d)return db(c,gd(b.text).length+(1==b.text.length?b.from.ch:0)+xc(a,b.to.line).text.length-b.to.ch);var g=c.line-b.from.line;return db(c,b.text[g].length+(g?0:b.from.ch))}function Pa(a,b,c){if(c&&"object"==typeof c)return{anchor:Oa(a,b,c.anchor),head:Oa(a,b,c.head)};if("start"==c)return{anchor:b.from,head:b.from};var d=se(b);if("around"==c)return{anchor:b.from,head:d};if("end"==c)return{anchor:d,head:d};var e=function(a){if($a(a,b.from))return a;if(!$a(b.to,a))return d;var c=a.line+b.text.length-(b.to.line-b.from.line)-1,e=a.ch;return a.line==b.to.line&&(e+=d.ch-b.to.ch),Ya(c,e)};return{anchor:e(a.sel.anchor),head:e(a.sel.head)}}function Qa(a,b,c){var d={canceled:!1,from:b.from,to:b.to,text:b.text,origin:b.origin,cancel:function(){this.canceled=!0}};return c&&(d.update=function(b,c,d,e){b&&(this.from=cb(a,b)),c&&(this.to=cb(a,c)),d&&(this.text=d),void 0!==e&&(this.origin=e)}),Zc(a,"beforeChange",a,d),a.cm&&Zc(a.cm,"beforeChange",a.cm,d),d.canceled?null:{from:d.from,to:d.to,text:d.text,origin:d.origin}}function Ra(a,b,c,d){if(a.cm){if(!a.cm.curOp)return ha(a.cm,Ra)(a,b,c,d);if(a.cm.state.suppressEdits)return}if(!(bd(a,"beforeChange")||a.cm&&bd(a.cm,"beforeChange"))||(b=Qa(a,b,!0))){var e=je&&!d&&Qb(a,b.from,b.to);if(e){for(var f=e.length-1;f>=1;--f)Sa(a,{from:e[f].from,to:e[f].to,text:[""]});e.length&&Sa(a,{from:e[0].from,to:e[0].to,text:b.text},c)}else Sa(a,b,c)}}function Sa(a,b,c){if(1!=b.text.length||""!=b.text[0]||!Za(b.from,b.to)){var d=Pa(a,b,c);Ic(a,b,d,a.cm?a.cm.curOp.id:NaN),Va(a,b,d,Nb(a,b));var e=[];vc(a,function(a,c){c||-1!=id(e,a.history)||(Oc(a.history,b),e.push(a.history)),Va(a,b,null,Nb(a,b))})}}function Ta(a,b){if(!a.cm||!a.cm.state.suppressEdits){var c=a.history,d=("undo"==b?c.done:c.undone).pop();if(d){var e={changes:[],anchorBefore:d.anchorAfter,headBefore:d.headAfter,anchorAfter:d.anchorBefore,headAfter:d.headBefore,generation:c.generation};("undo"==b?c.undone:c.done).push(e),c.generation=d.generation||++c.maxGeneration;for(var f=bd(a,"beforeChange")||a.cm&&bd(a.cm,"beforeChange"),g=d.changes.length-1;g>=0;--g){var h=d.changes[g];if(h.origin=b,f&&!Qa(a,h,!1))return void(("undo"==b?c.done:c.undone).length=0);e.changes.push(Hc(a,h));var i=g?Pa(a,h,null):{anchor:d.anchorBefore,head:d.headBefore};Va(a,h,i,Pb(a,h));var j=[];vc(a,function(a,b){b||-1!=id(j,a.history)||(Oc(a.history,h),j.push(a.history)),Va(a,h,null,Pb(a,h))})}}}}function Ua(a,b){function c(a){return Ya(a.line+b,a.ch)}a.first+=b,a.cm&&ka(a.cm,a.first,a.first,b),a.sel.head=c(a.sel.head),a.sel.anchor=c(a.sel.anchor),a.sel.from=c(a.sel.from),a.sel.to=c(a.sel.to)}function Va(a,b,c,d){if(a.cm&&!a.cm.curOp)return ha(a.cm,Va)(a,b,c,d);if(b.to.line<a.first)return void Ua(a,b.text.length-1-(b.to.line-b.from.line));if(!(b.from.line>a.lastLine())){if(b.from.line<a.first){var e=b.text.length-1-(a.first-b.from.line);Ua(a,e),b={from:Ya(a.first,0),to:Ya(b.to.line+e,b.to.ch),text:[gd(b.text)],origin:b.origin}}var f=a.lastLine();b.to.line>f&&(b={from:b.from,to:Ya(f,xc(a,f).text.length),text:[b.text[0]],origin:b.origin}),b.removed=yc(a,b.from,b.to),c||(c=Pa(a,b,null)),a.cm?Wa(a.cm,b,d,c):sc(a,b,d,c)}}function Wa(a,b,c,d){var e=a.doc,g=a.display,h=b.from,i=b.to,j=!1,k=h.line;a.options.lineWrapping||(k=Bc(Yb(e,xc(e,h.line))),e.iter(k,i.line+1,function(a){return a==g.maxLine?(j=!0,!0):void 0})),$a(e.sel.head,b.from)||$a(b.to,e.sel.head)||(a.curOp.cursorActivity=!0),sc(e,b,c,d,f(a)),a.options.lineWrapping||(e.iter(k,h.line+b.text.length,function(a){var b=l(e,a);b>g.maxLineLength&&(g.maxLine=a,g.maxLineLength=b,g.maxLineChanged=!0,j=!1)}),j&&(a.curOp.updateMaxLine=!0)),e.frontier=Math.min(e.frontier,h.line),H(a,400);var m=b.text.length-(i.line-h.line)-1;if(ka(a,h.line,i.line+1,m),bd(a,"change")){var n={from:h,to:i,text:b.text,removed:b.removed,origin:b.origin};if(a.curOp.textChanged){for(var o=a.curOp.textChanged;o.next;o=o.next);o.next=n}else a.curOp.textChanged=n}}function Xa(a,b,c,d,e){if(d||(d=c),$a(d,c)){var f=d;d=c,c=f}"string"==typeof b&&(b=We(b)),Ra(a,{from:c,to:d,text:b,origin:e},null)}function Ya(a,b){return this instanceof Ya?(this.line=a,void(this.ch=b)):new Ya(a,b)}function Za(a,b){return a.line==b.line&&a.ch==b.ch}function $a(a,b){return a.line<b.line||a.line==b.line&&a.ch<b.ch}function _a(a,b){return a.line-b.line||a.ch-b.ch}function ab(a){return Ya(a.line,a.ch)}function bb(a,b){return Math.max(a.first,Math.min(b,a.first+a.size-1))}function cb(a,b){if(b.line<a.first)return Ya(a.first,0);var c=a.first+a.size-1;return b.line>c?Ya(c,xc(a,c).text.length):db(b,xc(a,b.line).text.length)}function db(a,b){var c=a.ch;return null==c||c>b?Ya(a.line,b):0>c?Ya(a.line,0):a}function eb(a,b){return b>=a.first&&b<a.first+a.size}function fb(a,b,c,d){if(a.sel.shift||a.sel.extend){var e=a.sel.anchor;if(c){var f=$a(b,e);f!=$a(c,e)?(e=b,b=c):f!=$a(b,c)&&(b=c)}hb(a,e,b,d)}else hb(a,b,c||b,d);a.cm&&(a.cm.curOp.userSelChange=!0)}function gb(a,b,c){var d={anchor:b,head:c};return Zc(a,"beforeSelectionChange",a,d),a.cm&&Zc(a.cm,"beforeSelectionChange",a.cm,d),d.anchor=cb(a,d.anchor),d.head=cb(a,d.head),d}function hb(a,b,c,d,e){if(!e&&bd(a,"beforeSelectionChange")||a.cm&&bd(a.cm,"beforeSelectionChange")){var f=gb(a,b,c);c=f.head,b=f.anchor}var g=a.sel;if(g.goalColumn=null,null==d&&(d=$a(c,g.head)?-1:1),(e||!Za(b,g.anchor))&&(b=jb(a,b,d,"push"!=e)),(e||!Za(c,g.head))&&(c=jb(a,c,d,"push"!=e)),!Za(g.anchor,b)||!Za(g.head,c)){g.anchor=b,g.head=c;var h=$a(c,b);g.from=h?c:b,g.to=h?b:c,a.cm&&(a.cm.curOp.updateInput=a.cm.curOp.selectionChanged=a.cm.curOp.cursorActivity=!0),$c(a,"cursorActivity",a)}}function ib(a){hb(a.doc,a.doc.sel.from,a.doc.sel.to,null,"push")}function jb(a,b,c,d){var e=!1,f=b,g=c||1;a.cantEdit=!1;a:for(;;){var h=xc(a,f.line);if(h.markedSpans)for(var i=0;i<h.markedSpans.length;++i){var j=h.markedSpans[i],k=j.marker;if((null==j.from||(k.inclusiveLeft?j.from<=f.ch:j.from<f.ch))&&(null==j.to||(k.inclusiveRight?j.to>=f.ch:j.to>f.ch))){if(d&&(Zc(k,"beforeCursorEnter"),k.explicitlyCleared)){if(h.markedSpans){--i;continue}break}if(!k.atomic)continue;var l=k.find()[0>g?"from":"to"];if(Za(l,f)&&(l.ch+=g,l.ch<0?l=l.line>a.first?cb(a,Ya(l.line-1)):null:l.ch>h.text.length&&(l=l.line<a.first+a.size-1?Ya(l.line+1,0):null),!l)){if(e)return d?(a.cantEdit=!0,Ya(a.first,0)):jb(a,b,c,!0);e=!0,l=b,g=-g}f=l;continue a}}return f}}function kb(a){var b=lb(a,a.doc.sel.head,null,a.options.cursorScrollMargin);if(a.state.focused){var c=a.display,d=vd(c.sizer),e=null;if(b.top+d.top<0?e=!0:b.bottom+d.top>(window.innerHeight||document.documentElement.clientHeight)&&(e=!1),null!=e&&!$d){var f=rd("div","​",null,"position: absolute; top: "+(b.top-c.viewOffset)+"px; height: "+(b.bottom-b.top+Oe)+"px; left: "+b.left+"px; width: 2px;");a.display.lineSpace.appendChild(f),f.scrollIntoView(e),a.display.lineSpace.removeChild(f)}}}function lb(a,b,c,d){for(null==d&&(d=0);;){var e=!1,f=_(a,b),g=c&&c!=b?_(a,c):f,h=nb(a,Math.min(f.left,g.left),Math.min(f.top,g.top)-d,Math.max(f.left,g.left),Math.max(f.bottom,g.bottom)+d),i=a.doc.scrollTop,j=a.doc.scrollLeft;if(null!=h.scrollTop&&(Ba(a,h.scrollTop),Math.abs(a.doc.scrollTop-i)>1&&(e=!0)),null!=h.scrollLeft&&(Ca(a,h.scrollLeft),Math.abs(a.doc.scrollLeft-j)>1&&(e=!0)),!e)return f}}function mb(a,b,c,d,e){var f=nb(a,b,c,d,e);null!=f.scrollTop&&Ba(a,f.scrollTop),null!=f.scrollLeft&&Ca(a,f.scrollLeft)}function nb(a,b,c,d,e){var f=a.display,g=da(a.display);0>c&&(c=0);var h=f.scroller.clientHeight-Oe,i=f.scroller.scrollTop,j={},k=a.doc.height+M(f),l=g>c,m=e>k-g;if(i>c)j.scrollTop=l?0:c;else if(e>i+h){var n=Math.min(c,(m?k:e)-h);n!=i&&(j.scrollTop=n)}var o=f.scroller.clientWidth-Oe,p=f.scroller.scrollLeft;b+=f.gutters.offsetWidth,d+=f.gutters.offsetWidth;var q=f.gutters.offsetWidth,r=q+10>b;return p+q>b||r?(r&&(b=0),j.scrollLeft=Math.max(0,b-10-q)):d>o+p-3&&(j.scrollLeft=d+10-o),j}function ob(a,b,c){a.curOp.updateScrollPos={scrollLeft:null==b?a.doc.scrollLeft:b,scrollTop:null==c?a.doc.scrollTop:c}}function pb(a,b,c){var d=a.curOp.updateScrollPos||(a.curOp.updateScrollPos={scrollLeft:a.doc.scrollLeft,scrollTop:a.doc.scrollTop}),e=a.display.scroller;d.scrollTop=Math.max(0,Math.min(e.scrollHeight-e.clientHeight,d.scrollTop+c)),d.scrollLeft=Math.max(0,Math.min(e.scrollWidth-e.clientWidth,d.scrollLeft+b))}function qb(a,b,c,d){var e,f=a.doc;null==c&&(c="add"),"smart"==c&&(a.doc.mode.indent?e=K(a,b):c="prev");var g=a.options.tabSize,h=xc(f,b),i=ed(h.text,null,g);h.stateAfter&&(h.stateAfter=null);var j,k=h.text.match(/^\s*/)[0];if(d||/\S/.test(h.text)){if("smart"==c&&(j=a.doc.mode.indent(e,h.text.slice(k.length),h.text),j==Pe)){if(!d)return;c="prev"}}else j=0,c="not";"prev"==c?j=b>f.first?ed(xc(f,b-1).text,null,g):0:"add"==c?j=i+a.options.indentUnit:"subtract"==c?j=i-a.options.indentUnit:"number"==typeof c&&(j=i+c),j=Math.max(0,j);var l="",m=0;if(a.options.indentWithTabs)for(var n=Math.floor(j/g);n;--n)m+=g,l+="	";j>m&&(l+=fd(j-m)),l!=k?Xa(a.doc,l,Ya(b,0),Ya(b,k.length),"+input"):f.sel.head.line==b&&f.sel.head.ch<k.length&&hb(f,Ya(b,k.length),Ya(b,k.length),1),h.stateAfter=null}function rb(a,b,c){var d=b,e=b,f=a.doc;return"number"==typeof b?e=xc(f,bb(f,b)):d=Bc(b),null==d?null:c(e,d)?(ka(a,d,d+1),e):null}function sb(a,b,c,d,e){function f(){var b=h+c;return b<a.first||b>=a.first+a.size?l=!1:(h=b,k=xc(a,b))}function g(a){var b=(e?Jd:Kd)(k,i,c,!0);if(null==b){if(a||!f())return l=!1;i=e?(0>c?Dd:Cd)(k):0>c?k.text.length:0}else i=b;return!0}var h=b.line,i=b.ch,j=c,k=xc(a,h),l=!0;if("char"==d)g();else if("column"==d)g(!0);else if("word"==d||"group"==d)for(var m=null,n="group"==d,o=!0;!(0>c)||g(!o);o=!1){var p=k.text.charAt(i)||"\n",q=nd(p)?"w":n&&"\n"==p?"n":!n||/\s/.test(p)?null:"p";if(!n||o||q||(q="s"),m&&m!=q){0>c&&(c=1,g());break}if(q&&(m=q),c>0&&!g(!o))break}var r=jb(a,Ya(h,i),j,!0);return l||(r.hitSide=!0),r}function tb(a,b,c,d){var e,f=a.doc,g=b.left;if("page"==d){var h=Math.min(a.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight);e=b.top+c*(h-(0>c?1.5:.5)*da(a.display))}else"line"==d&&(e=c>0?b.bottom+3:b.top-3);for(;;){var i=ba(a,g,e);if(!i.outside)break;if(0>c?0>=e:e>=f.height){i.hitSide=!0;break}e+=5*c}return i}function ub(a,b){var c=b.ch,d=b.ch;if(a){(b.xRel<0||d==a.length)&&c?--c:++d;for(var e=a.charAt(c),f=nd(e)?nd:/\s/.test(e)?function(a){return/\s/.test(a)}:function(a){return!/\s/.test(a)&&!nd(a)};c>0&&f(a.charAt(c-1));)--c;for(;d<a.length&&f(a.charAt(d));)++d}return{from:Ya(b.line,c),to:Ya(b.line,d)}}function vb(a,b){fb(a.doc,Ya(b,0),cb(a.doc,Ya(b+1,0)))}function wb(b,c,d,e){a.defaults[b]=c,d&&(te[b]=e?function(a,b,c){c!=ve&&d(a,b,c)}:d)}function xb(a,b){if(b===!0)return b;if(a.copyState)return a.copyState(b);var c={};for(var d in b){var e=b[d];e instanceof Array&&(e=e.concat([])),c[d]=e}return c}function yb(a,b,c){return a.startState?a.startState(b,c):!0}function zb(a){return"string"==typeof a?Ce[a]:a}function Ab(a,b,c){function d(b){b=zb(b);var e=b[a];if(e===!1)return"stop";if(null!=e&&c(e))return!0;if(b.nofallthrough)return"stop";var f=b.fallthrough;if(null==f)return!1;if("[object Array]"!=Object.prototype.toString.call(f))return d(f);for(var g=0,h=f.length;h>g;++g){var i=d(f[g]);if(i)return i}return!1}for(var e=0;e<b.length;++e){var f=d(b[e]);if(f)return"stop"!=f}}function Bb(a){var b=Ze[a.keyCode];return"Ctrl"==b||"Alt"==b||"Shift"==b||"Mod"==b}function Cb(a,b){if(Vd&&34==a.keyCode&&a["char"])return!1;var c=Ze[a.keyCode];return null==c||a.altGraphKey?!1:(a.altKey&&(c="Alt-"+c),(he?a.metaKey:a.ctrlKey)&&(c="Ctrl-"+c),(he?a.ctrlKey:a.metaKey)&&(c="Cmd-"+c),!b&&a.shiftKey&&(c="Shift-"+c),c)}function Db(a,b){this.pos=this.start=0,this.string=a,this.tabSize=b||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0}function Eb(a,b){this.lines=[],this.type=b,this.doc=a}function Fb(a,b,c,d,e){if(d&&d.shared)return Hb(a,b,c,d,e);if(a.cm&&!a.cm.curOp)return ha(a.cm,Fb)(a,b,c,d,e);var f=new Eb(a,e);if(d&&kd(d,f),$a(c,b)||Za(b,c)&&f.clearWhenEmpty!==!1)return f;if(f.replacedWith&&(f.collapsed=!0,f.replacedWith=rd("span",[f.replacedWith],"CodeMirror-widget"),d.handleMouseEvents||(f.replacedWith.ignoreEvents=!0)),f.collapsed){if(Xb(a,b.line,b,c,f)||b.line!=c.line&&Xb(a,c.line,b,c,f))throw new Error("Inserting collapsed marker partially overlapping an existing one");ke=!0}f.addToHistory&&Ic(a,{from:b,to:c,origin:"markText"},{head:a.sel.head,anchor:a.sel.anchor},NaN);var g,h=b.line,i=a.cm;return a.iter(h,c.line+1,function(d){i&&f.collapsed&&!i.options.lineWrapping&&Yb(a,d)==i.display.maxLine&&(g=!0);var e={from:null,to:null,marker:f};h==b.line&&(e.from=b.ch),h==c.line&&(e.to=c.ch),f.collapsed&&h!=b.line&&Ac(d,0),Kb(d,e),++h}),f.collapsed&&a.iter(b.line,c.line+1,function(b){Zb(a,b)&&Ac(b,0)}),f.clearOnEnter&&Xc(f,"beforeCursorEnter",function(){f.clear()}),f.readOnly&&(je=!0,(a.history.done.length||a.history.undone.length)&&a.clearHistory()),f.collapsed&&(f.id=++De,f.atomic=!0),i&&(g&&(i.curOp.updateMaxLine=!0),(f.className||f.title||f.startStyle||f.endStyle||f.collapsed)&&ka(i,b.line,c.line+1),f.atomic&&ib(i)),f}function Gb(a,b){this.markers=a,this.primary=b;for(var c=0,d=this;c<a.length;++c)a[c].parent=this,Xc(a[c],"clear",function(){d.clear()})}function Hb(a,b,c,d,e){d=kd(d),d.shared=!1;var f=[Fb(a,b,c,d,e)],g=f[0],h=d.replacedWith;return vc(a,function(a){h&&(d.replacedWith=h.cloneNode(!0)),f.push(Fb(a,cb(a,b),cb(a,c),d,e));for(var i=0;i<a.linked.length;++i)if(a.linked[i].isParent)return;g=gd(f)}),new Gb(f,g)}function Ib(a,b){if(a)for(var c=0;c<a.length;++c){var d=a[c];if(d.marker==b)return d}}function Jb(a,b){for(var c,d=0;d<a.length;++d)a[d]!=b&&(c||(c=[])).push(a[d]);
return c}function Kb(a,b){a.markedSpans=a.markedSpans?a.markedSpans.concat([b]):[b],b.marker.attachLine(a)}function Lb(a,b,c){if(a)for(var d,e=0;e<a.length;++e){var f=a[e],g=f.marker,h=null==f.from||(g.inclusiveLeft?f.from<=b:f.from<b);if(h||f.from==b&&"bookmark"==g.type&&(!c||!f.marker.insertLeft)){var i=null==f.to||(g.inclusiveRight?f.to>=b:f.to>b);(d||(d=[])).push({from:f.from,to:i?null:f.to,marker:g})}}return d}function Mb(a,b,c){if(a)for(var d,e=0;e<a.length;++e){var f=a[e],g=f.marker,h=null==f.to||(g.inclusiveRight?f.to>=b:f.to>b);if(h||f.from==b&&"bookmark"==g.type&&(!c||f.marker.insertLeft)){var i=null==f.from||(g.inclusiveLeft?f.from<=b:f.from<b);(d||(d=[])).push({from:i?null:f.from-b,to:null==f.to?null:f.to-b,marker:g})}}return d}function Nb(a,b){var c=eb(a,b.from.line)&&xc(a,b.from.line).markedSpans,d=eb(a,b.to.line)&&xc(a,b.to.line).markedSpans;if(!c&&!d)return null;var e=b.from.ch,f=b.to.ch,g=Za(b.from,b.to),h=Lb(c,e,g),i=Mb(d,f,g),j=1==b.text.length,k=gd(b.text).length+(j?e:0);if(h)for(var l=0;l<h.length;++l){var m=h[l];if(null==m.to){var n=Ib(i,m.marker);n?j&&(m.to=null==n.to?null:n.to+k):m.to=e}}if(i)for(var l=0;l<i.length;++l){var m=i[l];if(null!=m.to&&(m.to+=k),null==m.from){var n=Ib(h,m.marker);n||(m.from=k,j&&(h||(h=[])).push(m))}else m.from+=k,j&&(h||(h=[])).push(m)}h&&(h=Ob(h)),i&&i!=h&&(i=Ob(i));var o=[h];if(!j){var p,q=b.text.length-2;if(q>0&&h)for(var l=0;l<h.length;++l)null==h[l].to&&(p||(p=[])).push({from:null,to:null,marker:h[l].marker});for(var l=0;q>l;++l)o.push(p);o.push(i)}return o}function Ob(a){for(var b=0;b<a.length;++b){var c=a[b];null!=c.from&&c.from==c.to&&c.marker.clearWhenEmpty!==!1&&a.splice(b--,1)}return a.length?a:null}function Pb(a,b){var c=Kc(a,b),d=Nb(a,b);if(!c)return d;if(!d)return c;for(var e=0;e<c.length;++e){var f=c[e],g=d[e];if(f&&g)a:for(var h=0;h<g.length;++h){for(var i=g[h],j=0;j<f.length;++j)if(f[j].marker==i.marker)continue a;f.push(i)}else g&&(c[e]=g)}return c}function Qb(a,b,c){var d=null;if(a.iter(b.line,c.line+1,function(a){if(a.markedSpans)for(var b=0;b<a.markedSpans.length;++b){var c=a.markedSpans[b].marker;!c.readOnly||d&&-1!=id(d,c)||(d||(d=[])).push(c)}}),!d)return null;for(var e=[{from:b,to:c}],f=0;f<d.length;++f)for(var g=d[f],h=g.find(),i=0;i<e.length;++i){var j=e[i];if(!$a(j.to,h.from)&&!$a(h.to,j.from)){var k=[i,1];($a(j.from,h.from)||!g.inclusiveLeft&&Za(j.from,h.from))&&k.push({from:j.from,to:h.from}),($a(h.to,j.to)||!g.inclusiveRight&&Za(j.to,h.to))&&k.push({from:h.to,to:j.to}),e.splice.apply(e,k),i+=k.length-1}}return e}function Rb(a){return a.inclusiveLeft?-1:0}function Sb(a){return a.inclusiveRight?1:0}function Tb(a,b){var c=a.lines.length-b.lines.length;if(0!=c)return c;var d=a.find(),e=b.find(),f=_a(d.from,e.from)||Rb(a)-Rb(b);if(f)return-f;var g=_a(d.to,e.to)||Sb(a)-Sb(b);return g?g:b.id-a.id}function Ub(a,b){var c,d=ke&&a.markedSpans;if(d)for(var e,f=0;f<d.length;++f)e=d[f],e.marker.collapsed&&null==(b?e.from:e.to)&&(!c||Tb(c,e.marker)<0)&&(c=e.marker);return c}function Vb(a){return Ub(a,!0)}function Wb(a){return Ub(a,!1)}function Xb(a,b,c,d,e){var f=xc(a,b),g=ke&&f.markedSpans;if(g)for(var h=0;h<g.length;++h){var i=g[h];if(i.marker.collapsed){var j=i.marker.find(!0),k=_a(j.from,c)||Rb(i.marker)-Rb(e),l=_a(j.to,d)||Sb(i.marker)-Sb(e);if(!(k>=0&&0>=l||0>=k&&l>=0)&&(0>=k&&(_a(j.to,c)||Sb(i.marker)-Rb(e))>0||k>=0&&(_a(j.from,d)||Rb(i.marker)-Sb(e))<0))return!0}}}function Yb(a,b){for(var c;c=Vb(b);)b=xc(a,c.find().from.line);return b}function Zb(a,b){var c=ke&&b.markedSpans;if(c)for(var d,e=0;e<c.length;++e)if(d=c[e],d.marker.collapsed){if(null==d.from)return!0;if(!d.marker.replacedWith&&0==d.from&&d.marker.inclusiveLeft&&$b(a,b,d))return!0}}function $b(a,b,c){if(null==c.to){var d=c.marker.find().to,e=xc(a,d.line);return $b(a,e,Ib(e.markedSpans,c.marker))}if(c.marker.inclusiveRight&&c.to==b.text.length)return!0;for(var f,g=0;g<b.markedSpans.length;++g)if(f=b.markedSpans[g],f.marker.collapsed&&!f.marker.replacedWith&&f.from==c.to&&(null==f.to||f.to!=c.from)&&(f.marker.inclusiveLeft||c.marker.inclusiveRight)&&$b(a,b,f))return!0}function _b(a){var b=a.markedSpans;if(b){for(var c=0;c<b.length;++c)b[c].marker.detachLine(a);a.markedSpans=null}}function ac(a,b){if(b){for(var c=0;c<b.length;++c)b[c].marker.attachLine(a);a.markedSpans=b}}function bc(a){return function(){var b=!this.cm.curOp;b&&fa(this.cm);try{var c=a.apply(this,arguments)}finally{b&&ga(this.cm)}return c}}function cc(a){return null!=a.height?a.height:(a.node.parentNode&&1==a.node.parentNode.nodeType||td(a.cm.display.measure,rd("div",[a.node],null,"position: relative")),a.height=a.node.offsetHeight)}function dc(a,b,c,d){var e=new Ee(a,c,d);return e.noHScroll&&(a.display.alignWidgets=!0),rb(a,b,function(b){var c=b.widgets||(b.widgets=[]);if(null==e.insertAt?c.push(e):c.splice(Math.min(c.length-1,Math.max(0,e.insertAt)),0,e),e.line=b,!Zb(a.doc,b)||e.showIfHidden){var d=Dc(a,b)<a.doc.scrollTop;Ac(b,b.height+cc(e)),d&&pb(a,0,e.height),a.curOp.forceUpdate=!0}return!0}),e}function ec(a,b,c,d){a.text=b,a.stateAfter&&(a.stateAfter=null),a.styles&&(a.styles=null),null!=a.order&&(a.order=null),_b(a),ac(a,c);var e=d?d(a):1;e!=a.height&&Ac(a,e)}function fc(a){a.parent=null,_b(a)}function gc(b,c,d,e,f,g){var h=d.flattenSpans;null==h&&(h=b.options.flattenSpans);var i,j=0,k=null,l=new Db(c,b.options.tabSize);for(""==c&&d.blankLine&&d.blankLine(e);!l.eol();){if(l.pos>b.options.maxHighlightLength?(h=!1,g&&jc(b,c,e,l.pos),l.pos=c.length,i=null):i=d.token(l,e),b.options.addModeClass){var m=a.innerMode(d,e).mode.name;m&&(i="m-"+(i?m+" "+i:m))}h&&k==i||(j<l.start&&f(l.start,k),j=l.start,k=i),l.start=l.pos}for(;j<l.pos;){var n=Math.min(l.pos,j+5e4);f(n,k),j=n}}function hc(a,b,c,d){var e=[a.state.modeGen];gc(a,b.text,a.doc.mode,c,function(a,b){e.push(a,b)},d);for(var f=0;f<a.state.overlays.length;++f){var g=a.state.overlays[f],h=1,i=0;gc(a,b.text,g.mode,!0,function(a,b){for(var c=h;a>i;){var d=e[h];d>a&&e.splice(h,1,a,e[h+1],d),h+=2,i=Math.min(a,d)}if(b)if(g.opaque)e.splice(c,h-c,a,b),h=c+2;else for(;h>c;c+=2){var f=e[c+1];e[c+1]=f?f+" "+b:b}})}return e}function ic(a,b){return b.styles&&b.styles[0]==a.state.modeGen||(b.styles=hc(a,b,b.stateAfter=K(a,Bc(b)))),b.styles}function jc(a,b,c,d){var e=a.doc.mode,f=new Db(b,a.options.tabSize);for(f.start=f.pos=d||0,""==b&&e.blankLine&&e.blankLine(c);!f.eol()&&f.pos<=a.options.maxHighlightLength;)e.token(f,c),f.start=f.pos}function kc(a,b){if(!a)return null;for(;;){var c=a.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!c)break;a=a.slice(0,c.index)+a.slice(c.index+c[0].length);var d=c[1]?"bgClass":"textClass";null==b[d]?b[d]=c[2]:new RegExp("(?:^|s)"+c[2]+"(?:$|s)").test(b[d])||(b[d]+=" "+c[2])}if(/^\s*$/.test(a))return null;var e=b.cm.options.addModeClass?He:Ge;return e[a]||(e[a]=a.replace(/\S+/g,"cm-$&"))}function lc(a,b,c,d){for(var e,f=b,g=!0;e=Vb(f);)f=xc(a.doc,e.find().from.line);var h={pre:rd("pre"),col:0,pos:0,measure:null,measuredSomething:!1,cm:a,copyWidgets:d};do{f.text&&(g=!1),h.measure=f==b&&c,h.pos=0,h.addToken=h.measure?oc:nc,(Rd||Sd)&&a.getOption("lineWrapping")&&(h.addToken=pc(h.addToken));var i=rc(f,h,ic(a,f));c&&f==b&&!h.measuredSomething&&(c[0]=h.pre.appendChild(yd(a.display.measure)),h.measuredSomething=!0),i&&(f=xc(a.doc,i.to.line))}while(i);!c||h.measuredSomething||c[0]||(c[0]=h.pre.appendChild(g?rd("span"," "):yd(a.display.measure))),h.pre.firstChild||Zb(a.doc,b)||h.pre.appendChild(document.createTextNode(" "));var j;if(c&&Rd&&(j=Ec(f))){var k=j.length-1;j[k].from==j[k].to&&--k;var l=j[k],m=j[k-1];if(l.from+1==l.to&&m&&l.level<m.level){var n=c[h.pos-1];n&&n.parentNode.insertBefore(n.measureRight=yd(a.display.measure),n.nextSibling)}}var o=h.textClass?h.textClass+" "+(b.textClass||""):b.textClass;return o&&(h.pre.className=o),Zc(a,"renderLine",a,b,h.pre),h}function mc(a){var b=rd("span","•","cm-invalidchar");return b.title="\\u"+a.charCodeAt(0).toString(16),b}function nc(a,b,c,d,e,f){if(b){var g=a.cm.options.specialChars;if(g.test(b))for(var h=document.createDocumentFragment(),i=0;;){g.lastIndex=i;var j=g.exec(b),k=j?j.index-i:b.length-i;if(k&&(h.appendChild(document.createTextNode(b.slice(i,i+k))),a.col+=k),!j)break;if(i+=k+1,"	"==j[0]){var l=a.cm.options.tabSize,m=l-a.col%l;h.appendChild(rd("span",fd(m),"cm-tab")),a.col+=m}else{var n=a.cm.options.specialCharPlaceholder(j[0]);h.appendChild(n),a.col+=1}}else{a.col+=b.length;var h=document.createTextNode(b)}if(c||d||e||a.measure){var o=c||"";d&&(o+=d),e&&(o+=e);var n=rd("span",[h],o);return f&&(n.title=f),a.pre.appendChild(n)}a.pre.appendChild(h)}}function oc(a,b,c,d,e){for(var f=a.cm.options.lineWrapping,g=0;g<b.length;++g){for(var h=0==g,i=g+1;i<b.length&&pd(b.charAt(i));)++i;var j=b.slice(g,i);g=i-1,g&&f&&wd(b,g)&&a.pre.appendChild(rd("wbr"));var k=a.measure[a.pos],l=a.measure[a.pos]=nc(a,j,c,h&&d,g==b.length-1&&e);k&&(l.leftSide=k.leftSide||k),Md&&f&&" "==j&&g&&!/\s/.test(b.charAt(g-1))&&g<b.length-1&&!/\s/.test(b.charAt(g+1))&&(l.style.whiteSpace="normal"),a.pos+=j.length}b.length&&(a.measuredSomething=!0)}function pc(a){function b(a){for(var b=" ",c=0;c<a.length-2;++c)b+=c%2?" ":" ";return b+=" "}return function(c,d,e,f,g,h){return a(c,d.replace(/ {3,}/g,b),e,f,g,h)}}function qc(a,b,c,d){var e=!d&&c.replacedWith;if(e&&(a.copyWidgets&&(e=e.cloneNode(!0)),a.pre.appendChild(e),a.measure)){if(b)a.measure[a.pos]=e;else{var f=yd(a.cm.display.measure);if("bookmark"!=c.type||c.insertLeft){if(a.measure[a.pos])return;a.measure[a.pos]=a.pre.insertBefore(f,e)}else a.measure[a.pos]=a.pre.appendChild(f)}a.measuredSomething=!0}a.pos+=b}function rc(a,b,c){var d=a.markedSpans,e=a.text,f=0;if(d)for(var g,h,i,j,k,l,m=e.length,n=0,o=1,p="",q=0;;){if(q==n){h=i=j=k="",l=null,q=1/0;for(var r=[],s=0;s<d.length;++s){var t=d[s],u=t.marker;t.from<=n&&(null==t.to||t.to>n)?(null!=t.to&&q>t.to&&(q=t.to,i=""),u.className&&(h+=" "+u.className),u.startStyle&&t.from==n&&(j+=" "+u.startStyle),u.endStyle&&t.to==q&&(i+=" "+u.endStyle),u.title&&!k&&(k=u.title),u.collapsed&&(!l||Tb(l.marker,u)<0)&&(l=t)):t.from>n&&q>t.from&&(q=t.from),"bookmark"==u.type&&t.from==n&&u.replacedWith&&r.push(u)}if(l&&(l.from||0)==n&&(qc(b,(null==l.to?m:l.to)-n,l.marker,null==l.from),null==l.to))return l.marker.find();if(!l&&r.length)for(var s=0;s<r.length;++s)qc(b,0,r[s])}if(n>=m)break;for(var v=Math.min(m,q);;){if(p){var w=n+p.length;if(!l){var x=w>v?p.slice(0,v-n):p;b.addToken(b,x,g?g+h:h,j,n+x.length==q?i:"",k)}if(w>=v){p=p.slice(v-n),n=v;break}n=w,j=""}p=e.slice(f,f=c[o++]),g=kc(c[o++],b)}}else for(var o=1;o<c.length;o+=2)b.addToken(b,e.slice(f,f=c[o]),kc(c[o+1],b))}function sc(a,b,c,d,e){function f(a){return c?c[a]:null}function g(a,c,d){ec(a,c,d,e),$c(a,"change",a,b)}var h=b.from,i=b.to,j=b.text,k=xc(a,h.line),l=xc(a,i.line),m=gd(j),n=f(j.length-1),o=i.line-h.line;if(0!=h.ch||0!=i.ch||""!=m||a.cm&&!a.cm.options.wholeLineUpdateBefore)if(k==l)if(1==j.length)g(k,k.text.slice(0,h.ch)+m+k.text.slice(i.ch),n);else{for(var p=[],q=1,r=j.length-1;r>q;++q)p.push(new Fe(j[q],f(q),e));p.push(new Fe(m+k.text.slice(i.ch),n,e)),g(k,k.text.slice(0,h.ch)+j[0],f(0)),a.insert(h.line+1,p)}else if(1==j.length)g(k,k.text.slice(0,h.ch)+j[0]+l.text.slice(i.ch),f(0)),a.remove(h.line+1,o);else{g(k,k.text.slice(0,h.ch)+j[0],f(0)),g(l,m+l.text.slice(i.ch),n);for(var q=1,r=j.length-1,p=[];r>q;++q)p.push(new Fe(j[q],f(q),e));o>1&&a.remove(h.line+1,o-1),a.insert(h.line+1,p)}else{for(var q=0,r=j.length-1,p=[];r>q;++q)p.push(new Fe(j[q],f(q),e));g(l,l.text,n),o&&a.remove(h.line,o),p.length&&a.insert(h.line,p)}$c(a,"change",a,b),hb(a,d.anchor,d.head,null,!0)}function tc(a){this.lines=a,this.parent=null;for(var b=0,c=a.length,d=0;c>b;++b)a[b].parent=this,d+=a[b].height;this.height=d}function uc(a){this.children=a;for(var b=0,c=0,d=0,e=a.length;e>d;++d){var f=a[d];b+=f.chunkSize(),c+=f.height,f.parent=this}this.size=b,this.height=c,this.parent=null}function vc(a,b,c){function d(a,e,f){if(a.linked)for(var g=0;g<a.linked.length;++g){var h=a.linked[g];if(h.doc!=e){var i=f&&h.sharedHist;(!c||i)&&(b(h.doc,i),d(h.doc,a,i))}}}d(a,null,!0)}function wc(a,b){if(b.cm)throw new Error("This document is already in use.");a.doc=b,b.cm=a,g(a),c(a),a.options.lineWrapping||m(a),a.options.mode=b.modeOption,ka(a)}function xc(a,b){for(b-=a.first;!a.lines;)for(var c=0;;++c){var d=a.children[c],e=d.chunkSize();if(e>b){a=d;break}b-=e}return a.lines[b]}function yc(a,b,c){var d=[],e=b.line;return a.iter(b.line,c.line+1,function(a){var f=a.text;e==c.line&&(f=f.slice(0,c.ch)),e==b.line&&(f=f.slice(b.ch)),d.push(f),++e}),d}function zc(a,b,c){var d=[];return a.iter(b,c,function(a){d.push(a.text)}),d}function Ac(a,b){for(var c=b-a.height,d=a;d;d=d.parent)d.height+=c}function Bc(a){if(null==a.parent)return null;for(var b=a.parent,c=id(b.lines,a),d=b.parent;d;b=d,d=d.parent)for(var e=0;d.children[e]!=b;++e)c+=d.children[e].chunkSize();return c+b.first}function Cc(a,b){var c=a.first;a:do{for(var d=0,e=a.children.length;e>d;++d){var f=a.children[d],g=f.height;if(g>b){a=f;continue a}b-=g,c+=f.chunkSize()}return c}while(!a.lines);for(var d=0,e=a.lines.length;e>d;++d){var h=a.lines[d],i=h.height;if(i>b)break;b-=i}return c+d}function Dc(a,b){b=Yb(a.doc,b);for(var c=0,d=b.parent,e=0;e<d.lines.length;++e){var f=d.lines[e];if(f==b)break;c+=f.height}for(var g=d.parent;g;d=g,g=d.parent)for(var e=0;e<g.children.length;++e){var h=g.children[e];if(h==d)break;c+=h.height}return c}function Ec(a){var b=a.order;return null==b&&(b=a.order=_e(a.text)),b}function Fc(a){return{done:[],undone:[],undoDepth:1/0,lastTime:0,lastOp:null,lastOrigin:null,generation:a||1,maxGeneration:a||1}}function Gc(a,b,c,d){var e=b["spans_"+a.id],f=0;a.iter(Math.max(a.first,c),Math.min(a.first+a.size,d),function(c){c.markedSpans&&((e||(e=b["spans_"+a.id]={}))[f]=c.markedSpans),++f})}function Hc(a,b){var c={line:b.from.line,ch:b.from.ch},d={from:c,to:se(b),text:yc(a,b.from,b.to)};return Gc(a,d,b.from.line,b.to.line+1),vc(a,function(a){Gc(a,d,b.from.line,b.to.line+1)},!0),d}function Ic(a,b,c,d){var e=a.history;e.undone.length=0;var f=+new Date,g=gd(e.done);if(g&&(e.lastOp==d||e.lastOrigin==b.origin&&b.origin&&("+"==b.origin.charAt(0)&&a.cm&&e.lastTime>f-a.cm.options.historyEventDelay||"*"==b.origin.charAt(0)))){var h=gd(g.changes);Za(b.from,b.to)&&Za(b.from,h.to)?h.to=se(b):g.changes.push(Hc(a,b)),g.anchorAfter=c.anchor,g.headAfter=c.head}else for(g={changes:[Hc(a,b)],generation:e.generation,anchorBefore:a.sel.anchor,headBefore:a.sel.head,anchorAfter:c.anchor,headAfter:c.head},e.done.push(g);e.done.length>e.undoDepth;)e.done.shift();e.generation=++e.maxGeneration,e.lastTime=f,e.lastOp=d,e.lastOrigin=b.origin,h||Zc(a,"historyAdded")}function Jc(a){if(!a)return null;for(var b,c=0;c<a.length;++c)a[c].marker.explicitlyCleared?b||(b=a.slice(0,c)):b&&b.push(a[c]);return b?b.length?b:null:a}function Kc(a,b){var c=b["spans_"+a.id];if(!c)return null;for(var d=0,e=[];d<b.text.length;++d)e.push(Jc(c[d]));return e}function Lc(a,b){for(var c=0,d=[];c<a.length;++c){var e=a[c],f=e.changes,g=[];d.push({changes:g,anchorBefore:e.anchorBefore,headBefore:e.headBefore,anchorAfter:e.anchorAfter,headAfter:e.headAfter});for(var h=0;h<f.length;++h){var i,j=f[h];if(g.push({from:j.from,to:j.to,text:j.text}),b)for(var k in j)(i=k.match(/^spans_(\d+)$/))&&id(b,Number(i[1]))>-1&&(gd(g)[k]=j[k],delete j[k])}}return d}function Mc(a,b,c,d){c<a.line?a.line+=d:b<a.line&&(a.line=b,a.ch=0)}function Nc(a,b,c,d){for(var e=0;e<a.length;++e){for(var f=a[e],g=!0,h=0;h<f.changes.length;++h){var i=f.changes[h];if(f.copied||(i.from=ab(i.from),i.to=ab(i.to)),c<i.from.line)i.from.line+=d,i.to.line+=d;else if(b<=i.to.line){g=!1;break}}f.copied||(f.anchorBefore=ab(f.anchorBefore),f.headBefore=ab(f.headBefore),f.anchorAfter=ab(f.anchorAfter),f.readAfter=ab(f.headAfter),f.copied=!0),g?(Mc(f.anchorBefore),Mc(f.headBefore),Mc(f.anchorAfter),Mc(f.headAfter)):(a.splice(0,e+1),e=0)}}function Oc(a,b){var c=b.from.line,d=b.to.line,e=b.text.length-(d-c)-1;Nc(a.done,c,d,e),Nc(a.undone,c,d,e)}function Pc(){Uc(this)}function Qc(a){return a.stop||(a.stop=Pc),a}function Rc(a){a.preventDefault?a.preventDefault():a.returnValue=!1}function Sc(a){a.stopPropagation?a.stopPropagation():a.cancelBubble=!0}function Tc(a){return null!=a.defaultPrevented?a.defaultPrevented:0==a.returnValue}function Uc(a){Rc(a),Sc(a)}function Vc(a){return a.target||a.srcElement}function Wc(a){var b=a.which;return null==b&&(1&a.button?b=1:2&a.button?b=3:4&a.button&&(b=2)),be&&a.ctrlKey&&1==b&&(b=3),b}function Xc(a,b,c){if(a.addEventListener)a.addEventListener(b,c,!1);else if(a.attachEvent)a.attachEvent("on"+b,c);else{var d=a._handlers||(a._handlers={}),e=d[b]||(d[b]=[]);e.push(c)}}function Yc(a,b,c){if(a.removeEventListener)a.removeEventListener(b,c,!1);else if(a.detachEvent)a.detachEvent("on"+b,c);else{var d=a._handlers&&a._handlers[b];if(!d)return;for(var e=0;e<d.length;++e)if(d[e]==c){d.splice(e,1);break}}}function Zc(a,b){var c=a._handlers&&a._handlers[b];if(c)for(var d=Array.prototype.slice.call(arguments,2),e=0;e<c.length;++e)c[e].apply(null,d)}function $c(a,b){function c(a){return function(){a.apply(null,e)}}var d=a._handlers&&a._handlers[b];if(d){var e=Array.prototype.slice.call(arguments,2);Me||(++Ne,Me=[],setTimeout(ad,0));for(var f=0;f<d.length;++f)Me.push(c(d[f]))}}function _c(a,b,c){return Zc(a,c||b.type,a,b),Tc(b)||b.codemirrorIgnore}function ad(){--Ne;var a=Me;Me=null;for(var b=0;b<a.length;++b)a[b]()}function bd(a,b){var c=a._handlers&&a._handlers[b];return c&&c.length>0}function cd(a){a.prototype.on=function(a,b){Xc(this,a,b)},a.prototype.off=function(a,b){Yc(this,a,b)}}function dd(){this.id=null}function ed(a,b,c,d,e){null==b&&(b=a.search(/[^\s\u00a0]/),-1==b&&(b=a.length));for(var f=d||0,g=e||0;b>f;++f)"	"==a.charAt(f)?g+=c-g%c:++g;return g}function fd(a){for(;Qe.length<=a;)Qe.push(gd(Qe)+" ");return Qe[a]}function gd(a){return a[a.length-1]}function hd(a){if(_d)a.selectionStart=0,a.selectionEnd=a.value.length;else try{a.select()}catch(b){}}function id(a,b){if(a.indexOf)return a.indexOf(b);for(var c=0,d=a.length;d>c;++c)if(a[c]==b)return c;return-1}function jd(a,b){function c(){}c.prototype=a;var d=new c;return b&&kd(b,d),d}function kd(a,b){b||(b={});for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function ld(a){for(var b=[],c=0;a>c;++c)b.push(void 0);return b}function md(a){var b=Array.prototype.slice.call(arguments,1);return function(){return a.apply(null,b)}}function nd(a){return/\w/.test(a)||a>""&&(a.toUpperCase()!=a.toLowerCase()||Re.test(a))}function od(a){for(var b in a)if(a.hasOwnProperty(b)&&a[b])return!1;return!0}function pd(a){return a.charCodeAt(0)>=768&&Se.test(a)}function qd(a,b,c){var d=a/255,e=b/255,f=c/255,g=.03928>=d?d/12.92:Math.pow((d+.055)/1.055,2.4),h=.03928>=e?e/12.92:Math.pow((e+.055)/1.055,2.4),i=.03928>=f?f/12.92:Math.pow((f+.055)/1.055,2.4),j=.2126*g+.7152*h+.0722*i;return j}function rd(a,b,c,d){var e=document.createElement(a);if(c&&(e.className=c),d&&(e.style.cssText=d),"string"==typeof b)ud(e,b);else if(b)for(var f=0;f<b.length;++f)e.appendChild(b[f]);if("cm-color"===c&&RGBColor){var g=new RGBColor(e.innerHTML),h=qd(g.r,g.g,g.b);.51>h&&(e.style.color="white"),e.style.background=e.innerHTML}return e}function sd(a){for(var b=a.childNodes.length;b>0;--b)a.removeChild(a.firstChild);return a}function td(a,b){return sd(a).appendChild(b)}function ud(a,b){Od?(a.innerHTML="",a.appendChild(document.createTextNode(b))):a.textContent=b}function vd(a){return a.getBoundingClientRect()}function wd(){return!1}function xd(a){if(null!=Ue)return Ue;var b=rd("div",null,null,"width: 50px; height: 50px; overflow-x: scroll");return td(a,b),b.offsetWidth&&(Ue=b.offsetHeight-b.clientHeight),Ue||0}function yd(a){if(null==Ve){var b=rd("span","​");td(a,rd("span",[b,document.createTextNode("x")])),0!=a.firstChild.offsetHeight&&(Ve=b.offsetWidth<=1&&b.offsetHeight>2&&!Nd)}return Ve?rd("span","​"):rd("span"," ",null,"display: inline-block; width: 1px; margin-right: -1px")}function zd(a,b,c,d){if(!a)return d(b,c,"ltr");for(var e=!1,f=0;f<a.length;++f){var g=a[f];(g.from<c&&g.to>b||b==c&&g.to==b)&&(d(Math.max(g.from,b),Math.min(g.to,c),1==g.level?"rtl":"ltr"),e=!0)}e||d(b,c,"ltr")}function Ad(a){return a.level%2?a.to:a.from}function Bd(a){return a.level%2?a.from:a.to}function Cd(a){var b=Ec(a);return b?Ad(b[0]):0}function Dd(a){var b=Ec(a);return b?Bd(gd(b)):a.text.length}function Ed(a,b){var c=xc(a.doc,b),d=Yb(a.doc,c);d!=c&&(b=Bc(d));var e=Ec(d),f=e?e[0].level%2?Dd(d):Cd(d):0;return Ya(b,f)}function Fd(a,b){for(var c,d;c=Wb(d=xc(a.doc,b));)b=c.find().to.line;var e=Ec(d),f=e?e[0].level%2?Cd(d):Dd(d):d.text.length;return Ya(b,f)}function Gd(a,b,c){var d=a[0].level;return b==d?!0:c==d?!1:c>b}function Hd(a,b){$e=null;for(var c,d=0;d<a.length;++d){var e=a[d];if(e.from<b&&e.to>b)return d;if(e.from==b||e.to==b){if(null!=c)return Gd(a,e.level,a[c].level)?(e.from!=e.to&&($e=c),d):(e.from!=e.to&&($e=d),c);c=d}}return c}function Id(a,b,c,d){if(!d)return b+c;do b+=c;while(b>0&&pd(a.text.charAt(b)));return b}function Jd(a,b,c,d){var e=Ec(a);if(!e)return Kd(a,b,c,d);for(var f=Hd(e,b),g=e[f],h=Id(a,b,g.level%2?-c:c,d);;){if(h>g.from&&h<g.to)return h;if(h==g.from||h==g.to)return Hd(e,h)==f?h:(g=e[f+=c],c>0==g.level%2?g.to:g.from);if(g=e[f+=c],!g)return null;h=c>0==g.level%2?Id(a,g.to,-1,d):Id(a,g.from,1,d)}}function Kd(a,b,c,d){var e=b+c;if(d)for(;e>0&&pd(a.text.charAt(e));)e+=c;return 0>e||e>a.text.length?null:e}var Ld=/gecko\/\d/i.test(navigator.userAgent),Md=/MSIE \d/.test(navigator.userAgent),Nd=Md&&(null==document.documentMode||document.documentMode<8),Od=Md&&(null==document.documentMode||document.documentMode<9),Pd=Md&&(null==document.documentMode||document.documentMode<10),Qd=/Trident\/([7-9]|\d{2,})\./.test(navigator.userAgent),Rd=Md||Qd,Sd=/WebKit\//.test(navigator.userAgent),Td=Sd&&/Qt\/\d+\.\d+/.test(navigator.userAgent),Ud=/Chrome\//.test(navigator.userAgent),Vd=/Opera\//.test(navigator.userAgent),Wd=/Apple Computer/.test(navigator.vendor),Xd=/KHTML\//.test(navigator.userAgent),Yd=/Mac OS X 1\d\D([7-9]|\d\d)\D/.test(navigator.userAgent),Zd=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(navigator.userAgent),$d=/PhantomJS/.test(navigator.userAgent),_d=/AppleWebKit/.test(navigator.userAgent)&&/Mobile\/\w+/.test(navigator.userAgent),ae=_d||/Android|webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(navigator.userAgent),be=_d||/Mac/.test(navigator.platform),ce=/win/i.test(navigator.platform),de=Vd&&navigator.userAgent.match(/Version\/(\d*\.\d*)/);de&&(de=Number(de[1])),de&&de>=15&&(Vd=!1,Sd=!0);var ee,fe,ge,he=be&&(Td||Vd&&(null==de||12.11>de)),ie=Ld||Rd&&!Od,je=!1,ke=!1,le=0,me=0,ne=0,oe=null;Rd?oe=-.53:Ld?oe=15:Ud?oe=-.7:Wd&&(oe=-1/3);var pe,qe,re=null,se=a.changeEnd=function(a){return a.text?Ya(a.from.line+a.text.length-1,gd(a.text).length+(1==a.text.length?a.from.ch:0)):a.to};a.Pos=Ya,a.prototype={constructor:a,focus:function(){window.focus(),pa(this),ma(this)},setOption:function(a,b){var c=this.options,d=c[a];(c[a]!=b||"mode"==a)&&(c[a]=b,te.hasOwnProperty(a)&&ha(this,te[a])(this,b,d))},getOption:function(a){return this.options[a]},getDoc:function(){return this.doc},addKeyMap:function(a,b){this.state.keyMaps[b?"push":"unshift"](a)},removeKeyMap:function(a){for(var b=this.state.keyMaps,c=0;c<b.length;++c)if(b[c]==a||"string"!=typeof b[c]&&b[c].name==a)return b.splice(c,1),!0},addOverlay:ha(null,function(b,c){var d=b.token?b:a.getMode(this.options,b);if(d.startState)throw new Error("Overlays may not be stateful.");this.state.overlays.push({mode:d,modeSpec:b,opaque:c&&c.opaque}),this.state.modeGen++,ka(this)}),removeOverlay:ha(null,function(a){for(var b=this.state.overlays,c=0;c<b.length;++c){var d=b[c].modeSpec;if(d==a||"string"==typeof a&&d.name==a)return b.splice(c,1),this.state.modeGen++,void ka(this)}}),indentLine:ha(null,function(a,b,c){"string"!=typeof b&&"number"!=typeof b&&(b=null==b?this.options.smartIndent?"smart":"prev":b?"add":"subtract"),eb(this.doc,a)&&qb(this,a,b,c)}),indentSelection:ha(null,function(a){var b=this.doc.sel;if(Za(b.from,b.to))return qb(this,b.from.line,a,!0);for(var c=b.to.line-(b.to.ch?0:1),d=b.from.line;c>=d;++d)qb(this,d,a)}),getTokenAt:function(a,b){var c=this.doc;a=cb(c,a);for(var d=K(this,a.line,b),e=this.doc.mode,f=xc(c,a.line),g=new Db(f.text,this.options.tabSize);g.pos<a.ch&&!g.eol();){g.start=g.pos;var h=e.token(g,d)}return{start:g.start,end:g.pos,string:g.current(),className:h||null,type:h||null,state:d}},getTokenTypeAt:function(a){a=cb(this.doc,a);var b=ic(this,xc(this.doc,a.line)),c=0,d=(b.length-1)/2,e=a.ch;if(0==e)return b[2];for(;;){var f=c+d>>1;if((f?b[2*f-1]:0)>=e)d=f;else{if(!(b[2*f+1]<e))return b[2*f+2];c=f+1}}},getModeAt:function(b){var c=this.doc.mode;return c.innerMode?a.innerMode(c,this.getTokenAt(b).state).mode:c},getHelper:function(a,b){return this.getHelpers(a,b)[0]},getHelpers:function(a,b){var c=[];if(!Ae.hasOwnProperty(b))return Ae;var d=Ae[b],e=this.getModeAt(a);if("string"==typeof e[b])d[e[b]]&&c.push(d[e[b]]);else if(e[b])for(var f=0;f<e[b].length;f++){var g=d[e[b][f]];g&&c.push(g)}else e.helperType&&d[e.helperType]?c.push(d[e.helperType]):d[e.name]&&c.push(d[e.name]);for(var f=0;f<d._global.length;f++){var h=d._global[f];h.pred(e,this)&&-1==id(c,h.val)&&c.push(h.val)}return c},getStateAfter:function(a,b){var c=this.doc;return a=bb(c,null==a?c.first+c.size-1:a),K(this,a+1,b)},cursorCoords:function(a,b){var c,d=this.doc.sel;return c=null==a?d.head:"object"==typeof a?cb(this.doc,a):a?d.from:d.to,_(this,c,b||"page")},charCoords:function(a,b){return $(this,cb(this.doc,a),b||"page")},coordsChar:function(a,b){return a=Z(this,a,b||"page"),ba(this,a.left,a.top)},lineAtHeight:function(a,b){return a=Z(this,{top:a,left:0},b||"page").top,Cc(this.doc,a+this.display.viewOffset)},heightAtLine:function(a,b){var c=!1,d=this.doc.first+this.doc.size-1;a<this.doc.first?a=this.doc.first:a>d&&(a=d,c=!0);var e=xc(this.doc,a);return Y(this,xc(this.doc,a),{top:0,left:0},b||"page").top+(c?e.height:0)},defaultTextHeight:function(){return da(this.display)},defaultCharWidth:function(){return ea(this.display)},setGutterMarker:ha(null,function(a,b,c){return rb(this,a,function(a){var d=a.gutterMarkers||(a.gutterMarkers={});return d[b]=c,!c&&od(d)&&(a.gutterMarkers=null),!0})}),clearGutter:ha(null,function(a){var b=this,c=b.doc,d=c.first;c.iter(function(c){c.gutterMarkers&&c.gutterMarkers[a]&&(c.gutterMarkers[a]=null,ka(b,d,d+1),od(c.gutterMarkers)&&(c.gutterMarkers=null)),++d})}),addLineClass:ha(null,function(a,b,c){return rb(this,a,function(a){var d="text"==b?"textClass":"background"==b?"bgClass":"wrapClass";if(a[d]){if(new RegExp("(?:^|\\s)"+c+"(?:$|\\s)").test(a[d]))return!1;a[d]+=" "+c}else a[d]=c;return!0})}),removeLineClass:ha(null,function(a,b,c){return rb(this,a,function(a){var d="text"==b?"textClass":"background"==b?"bgClass":"wrapClass",e=a[d];if(!e)return!1;if(null==c)a[d]=null;else{var f=e.match(new RegExp("(?:^|\\s+)"+c+"(?:$|\\s+)"));if(!f)return!1;var g=f.index+f[0].length;a[d]=e.slice(0,f.index)+(f.index&&g!=e.length?" ":"")+e.slice(g)||null}return!0})}),addLineWidget:ha(null,function(a,b,c){return dc(this,a,b,c)}),removeLineWidget:function(a){a.clear()},lineInfo:function(a){if("number"==typeof a){if(!eb(this.doc,a))return null;var b=a;if(a=xc(this.doc,a),!a)return null}else{var b=Bc(a);if(null==b)return null}return{line:b,handle:a,text:a.text,gutterMarkers:a.gutterMarkers,textClass:a.textClass,bgClass:a.bgClass,wrapClass:a.wrapClass,widgets:a.widgets}},getViewport:function(){return{from:this.display.showingFrom,to:this.display.showingTo}},addWidget:function(a,b,c,d,e){var f=this.display;a=_(this,cb(this.doc,a));var g=a.bottom,h=a.left;if(b.style.position="absolute",f.sizer.appendChild(b),"over"==d)g=a.top;else if("above"==d||"near"==d){var i=Math.max(f.wrapper.clientHeight,this.doc.height),j=Math.max(f.sizer.clientWidth,f.lineSpace.clientWidth);("above"==d||a.bottom+b.offsetHeight>i)&&a.top>b.offsetHeight?g=a.top-b.offsetHeight:a.bottom+b.offsetHeight<=i&&(g=a.bottom),h+b.offsetWidth>j&&(h=j-b.offsetWidth)}b.style.top=g+"px",b.style.left=b.style.right="","right"==e?(h=f.sizer.clientWidth-b.offsetWidth,b.style.right="0px"):("left"==e?h=0:"middle"==e&&(h=(f.sizer.clientWidth-b.offsetWidth)/2),b.style.left=h+"px"),c&&mb(this,h,g,h+b.offsetWidth,g+b.offsetHeight)},triggerOnKeyDown:ha(null,Ja),triggerOnKeyPress:ha(null,Ka),triggerOnKeyUp:ha(null,Ia),execCommand:function(a){return Be.hasOwnProperty(a)?Be[a](this):void 0},findPosH:function(a,b,c,d){var e=1;0>b&&(e=-1,b=-b);for(var f=0,g=cb(this.doc,a);b>f&&(g=sb(this.doc,g,e,c,d),!g.hitSide);++f);return g},moveH:ha(null,function(a,b){var c,d=this.doc.sel;c=d.shift||d.extend||Za(d.from,d.to)?sb(this.doc,d.head,a,b,this.options.rtlMoveVisually):0>a?d.from:d.to,fb(this.doc,c,c,a)}),deleteH:ha(null,function(a,b){var c=this.doc.sel;Za(c.from,c.to)?Xa(this.doc,"",c.from,sb(this.doc,c.head,a,b,!1),"+delete"):Xa(this.doc,"",c.from,c.to,"+delete"),this.curOp.userSelChange=!0}),findPosV:function(a,b,c,d){var e=1,f=d;0>b&&(e=-1,b=-b);for(var g=0,h=cb(this.doc,a);b>g;++g){var i=_(this,h,"div");if(null==f?f=i.left:i.left=f,h=tb(this,i,e,c),h.hitSide)break}return h},moveV:ha(null,function(a,b){var c,d,e=this.doc.sel;if(e.shift||e.extend||Za(e.from,e.to)){var f=_(this,e.head,"div");null!=e.goalColumn&&(f.left=e.goalColumn),c=tb(this,f,a,b),"page"==b&&pb(this,0,$(this,c,"div").top-f.top),d=f.left}else c=0>a?e.from:e.to;fb(this.doc,c,c,a),null!=d&&(e.goalColumn=d)}),toggleOverwrite:function(a){(null==a||a!=this.state.overwrite)&&((this.state.overwrite=!this.state.overwrite)?this.display.cursor.className+=" CodeMirror-overwrite":this.display.cursor.className=this.display.cursor.className.replace(" CodeMirror-overwrite",""),Zc(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return document.activeElement==this.display.input},scrollTo:ha(null,function(a,b){ob(this,a,b)}),getScrollInfo:function(){var a=this.display.scroller,b=Oe;return{left:a.scrollLeft,top:a.scrollTop,height:a.scrollHeight-b,width:a.scrollWidth-b,clientHeight:a.clientHeight-b,clientWidth:a.clientWidth-b}},scrollIntoView:ha(null,function(a,b){null==a?a={from:this.doc.sel.head,to:null}:"number"==typeof a?a={from:Ya(a,0),to:null}:null==a.from&&(a={from:a,to:null}),a.to||(a.to=a.from),b||(b=0);var c=a;null!=a.from.line&&(this.curOp.scrollToPos={from:a.from,to:a.to,margin:b},c={from:_(this,a.from),to:_(this,a.to)});var d=nb(this,Math.min(c.from.left,c.to.left),Math.min(c.from.top,c.to.top)-b,Math.max(c.from.right,c.to.right),Math.max(c.from.bottom,c.to.bottom)+b);ob(this,d.scrollLeft,d.scrollTop)}),setSize:ha(null,function(a,b){function c(a){return"number"==typeof a||/^\d+$/.test(String(a))?a+"px":a}null!=a&&(this.display.wrapper.style.width=c(a)),null!=b&&(this.display.wrapper.style.height=c(b)),this.options.lineWrapping&&(this.display.measureLineCache.length=this.display.measureLineCachePos=0),this.curOp.forceUpdate=!0,Zc(this,"refresh",this)}),operation:function(a){return ja(this,a)},refresh:ha(null,function(){var a=this.display.cachedTextHeight;V(this),ob(this,this.doc.scrollLeft,this.doc.scrollTop),ka(this),(null==a||Math.abs(a-da(this.display))>.5)&&g(this),Zc(this,"refresh",this)}),swapDoc:ha(null,function(a){var b=this.doc;return b.cm=null,wc(this,a),V(this),oa(this,!0),ob(this,a.scrollLeft,a.scrollTop),$c(this,"swapDoc",this,b),b}),getInputField:function(){return this.display.input},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},cd(a);var te=a.optionHandlers={},ue=a.defaults={},ve=a.Init={toString:function(){return"CodeMirror.Init"}};wb("value","",function(a,b){a.setValue(b)},!0),wb("mode",null,function(a,b){a.doc.modeOption=b,c(a)},!0),wb("indentUnit",2,c,!0),wb("indentWithTabs",!1),wb("smartIndent",!0),wb("tabSize",4,function(a){d(a),V(a),ka(a)},!0),wb("specialChars",/[\t\u0000-\u0019\u00ad\u200b\u2028\u2029\ufeff]/g,function(a,b){a.options.specialChars=new RegExp(b.source+(b.test("	")?"":"|	"),"g"),a.refresh()},!0),wb("specialCharPlaceholder",mc,function(a){a.refresh()},!0),wb("electricChars",!0),wb("rtlMoveVisually",!ce),
wb("wholeLineUpdateBefore",!0),wb("theme","default",function(a){i(a),j(a)},!0),wb("keyMap","default",h),wb("extraKeys",null),wb("onKeyEvent",null),wb("onDragEvent",null),wb("lineWrapping",!1,e,!0),wb("gutters",[],function(a){n(a.options),j(a)},!0),wb("fixedGutter",!0,function(a,b){a.display.gutters.style.left=b?t(a.display)+"px":"0",a.refresh()},!0),wb("coverGutterNextToScrollbar",!1,o,!0),wb("lineNumbers",!1,function(a){n(a.options),j(a)},!0),wb("firstLineNumber",1,j,!0),wb("lineNumberFormatter",function(a){return a},j,!0),wb("showCursorWhenSelecting",!1,D,!0),wb("resetSelectionOnContextMenu",!0),wb("readOnly",!1,function(a,b){"nocursor"==b?(Ma(a),a.display.input.blur(),a.display.disabled=!0):(a.display.disabled=!1,b||oa(a,!0))}),wb("disableInput",!1,function(a,b){b||oa(a,!0)},!0),wb("dragDrop",!0),wb("cursorBlinkRate",530),wb("cursorScrollMargin",0),wb("cursorHeight",1),wb("workTime",100),wb("workDelay",100),wb("flattenSpans",!0,d,!0),wb("addModeClass",!1,d,!0),wb("pollInterval",100),wb("undoDepth",40,function(a,b){a.doc.history.undoDepth=b}),wb("historyEventDelay",500),wb("viewportMargin",10,function(a){a.refresh()},!0),wb("maxHighlightLength",1e4,d,!0),wb("crudeMeasuringFrom",1e4),wb("moveInputWithCursor",!0,function(a,b){b||(a.display.inputDiv.style.top=a.display.inputDiv.style.left=0)}),wb("tabindex",null,function(a,b){a.display.input.tabIndex=b||""}),wb("autofocus",null);var we=a.modes={},xe=a.mimeModes={};a.defineMode=function(b,c){if(a.defaults.mode||"null"==b||(a.defaults.mode=b),arguments.length>2){c.dependencies=[];for(var d=2;d<arguments.length;++d)c.dependencies.push(arguments[d])}we[b]=c},a.defineMIME=function(a,b){xe[a]=b},a.resolveMode=function(b){if("string"==typeof b&&xe.hasOwnProperty(b))b=xe[b];else if(b&&"string"==typeof b.name&&xe.hasOwnProperty(b.name)){var c=xe[b.name];"string"==typeof c&&(c={name:c}),b=jd(c,b),b.name=c.name}else if("string"==typeof b&&/^[\w\-]+\/[\w\-]+\+xml$/.test(b))return a.resolveMode("application/xml");return"string"==typeof b?{name:b}:b||{name:"null"}},a.getMode=function(b,c){var c=a.resolveMode(c),d=we[c.name];if(!d)return a.getMode(b,"text/plain");var e=d(b,c);if(ye.hasOwnProperty(c.name)){var f=ye[c.name];for(var g in f)f.hasOwnProperty(g)&&(e.hasOwnProperty(g)&&(e["_"+g]=e[g]),e[g]=f[g])}if(e.name=c.name,c.helperType&&(e.helperType=c.helperType),c.modeProps)for(var g in c.modeProps)e[g]=c.modeProps[g];return e},a.defineMode("null",function(){return{token:function(a){a.skipToEnd()}}}),a.defineMIME("text/plain","null");var ye=a.modeExtensions={};a.extendMode=function(a,b){var c=ye.hasOwnProperty(a)?ye[a]:ye[a]={};kd(b,c)},a.defineExtension=function(b,c){a.prototype[b]=c},a.defineDocExtension=function(a,b){Je.prototype[a]=b},a.defineOption=wb;var ze=[];a.defineInitHook=function(a){ze.push(a)};var Ae=a.helpers={};a.registerHelper=function(b,c,d){Ae.hasOwnProperty(b)||(Ae[b]=a[b]={_global:[]}),Ae[b][c]=d},a.registerGlobalHelper=function(b,c,d,e){a.registerHelper(b,c,e),Ae[b]._global.push({pred:d,val:e})},a.isWordChar=nd,a.copyState=xb,a.startState=yb,a.innerMode=function(a,b){for(;a.innerMode;){var c=a.innerMode(b);if(!c||c.mode==a)break;b=c.state,a=c.mode}return c||{mode:a,state:b}};var Be=a.commands={selectAll:function(a){a.setSelection(Ya(a.firstLine(),0),Ya(a.lastLine()))},killLine:function(a){var b=a.getCursor(!0),c=a.getCursor(!1),d=!Za(b,c);d||a.getLine(b.line).length!=b.ch?a.replaceRange("",b,d?c:Ya(b.line),"+delete"):a.replaceRange("",b,Ya(b.line+1,0),"+delete")},deleteLine:function(a){var b=a.getCursor().line;a.replaceRange("",Ya(b,0),Ya(b+1,0),"+delete")},delLineLeft:function(a){var b=a.getCursor();a.replaceRange("",Ya(b.line,0),b,"+delete")},undo:function(a){a.undo()},redo:function(a){a.redo()},goDocStart:function(a){a.extendSelection(Ya(a.firstLine(),0))},goDocEnd:function(a){a.extendSelection(Ya(a.lastLine()))},goLineStart:function(a){a.extendSelection(Ed(a,a.getCursor().line))},goLineStartSmart:function(a){var b=a.getCursor(),c=Ed(a,b.line),d=a.getLineHandle(c.line),e=Ec(d);if(e&&0!=e[0].level)a.extendSelection(c);else{var f=Math.max(0,d.text.search(/\S/)),g=b.line==c.line&&b.ch<=f&&b.ch;a.extendSelection(Ya(c.line,g?0:f))}},goLineEnd:function(a){a.extendSelection(Fd(a,a.getCursor().line))},goLineRight:function(a){var b=a.charCoords(a.getCursor(),"div").top+5;a.extendSelection(a.coordsChar({left:a.display.lineDiv.offsetWidth+100,top:b},"div"))},goLineLeft:function(a){var b=a.charCoords(a.getCursor(),"div").top+5;a.extendSelection(a.coordsChar({left:0,top:b},"div"))},goLineUp:function(a){a.moveV(-1,"line")},goLineDown:function(a){a.moveV(1,"line")},goPageUp:function(a){a.moveV(-1,"page")},goPageDown:function(a){a.moveV(1,"page")},goCharLeft:function(a){a.moveH(-1,"char")},goCharRight:function(a){a.moveH(1,"char")},goColumnLeft:function(a){a.moveH(-1,"column")},goColumnRight:function(a){a.moveH(1,"column")},goWordLeft:function(a){a.moveH(-1,"word")},goGroupRight:function(a){a.moveH(1,"group")},goGroupLeft:function(a){a.moveH(-1,"group")},goWordRight:function(a){a.moveH(1,"word")},delCharBefore:function(a){a.deleteH(-1,"char")},delCharAfter:function(a){a.deleteH(1,"char")},delWordBefore:function(a){a.deleteH(-1,"word")},delWordAfter:function(a){a.deleteH(1,"word")},delGroupBefore:function(a){a.deleteH(-1,"group")},delGroupAfter:function(a){a.deleteH(1,"group")},indentAuto:function(a){a.indentSelection("smart")},indentMore:function(a){a.indentSelection("add")},indentLess:function(a){a.indentSelection("subtract")},insertTab:function(a){a.replaceSelection("	","end","+input")},defaultTab:function(a){a.somethingSelected()?a.indentSelection("add"):a.replaceSelection("	","end","+input")},transposeChars:function(a){var b=a.getCursor(),c=a.getLine(b.line);b.ch>0&&b.ch<c.length-1&&a.replaceRange(c.charAt(b.ch)+c.charAt(b.ch-1),Ya(b.line,b.ch-1),Ya(b.line,b.ch+1))},newlineAndIndent:function(a){ha(a,function(){a.replaceSelection("\n","end","+input"),a.indentLine(a.getCursor().line,null,!0)})()},toggleOverwrite:function(a){a.toggleOverwrite()}},Ce=a.keyMap={};Ce.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite"},Ce.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-Up":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Down":"goDocEnd","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore",fallthrough:"basic"},Ce.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineStart","Cmd-Right":"goLineEnd","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delLineLeft",fallthrough:["basic","emacsy"]},Ce["default"]=be?Ce.macDefault:Ce.pcDefault,Ce.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Alt-F":"goWordRight","Alt-B":"goWordLeft","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-D":"delWordAfter","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars"},a.lookupKey=Ab,a.isModifierKey=Bb,a.keyName=Cb,a.fromTextArea=function(b,c){function d(){b.value=j.getValue()}if(c||(c={}),c.value=b.value,!c.tabindex&&b.tabindex&&(c.tabindex=b.tabindex),!c.placeholder&&b.placeholder&&(c.placeholder=b.placeholder),null==c.autofocus){var e=document.body;try{e=document.activeElement}catch(f){}c.autofocus=e==b||null!=b.getAttribute("autofocus")&&e==document.body}if(b.form&&(Xc(b.form,"submit",d),!c.leaveSubmitMethodAlone)){var g=b.form,h=g.submit;try{var i=g.submit=function(){d(),g.submit=h,g.submit(),g.submit=i}}catch(f){}}b.style.display="none";var j=a(function(a){b.parentNode.insertBefore(a,b.nextSibling)},c);return j.save=d,j.getTextArea=function(){return b},j.toTextArea=function(){d(),b.parentNode.removeChild(j.getWrapperElement()),b.style.display="",b.form&&(Yc(b.form,"submit",d),"function"==typeof b.form.submit&&(b.form.submit=h))},j},Db.prototype={eol:function(){return this.pos>=this.string.length},sol:function(){return this.pos==this.lineStart},peek:function(){return this.string.charAt(this.pos)||void 0},next:function(){return this.pos<this.string.length?this.string.charAt(this.pos++):void 0},eat:function(a){var b=this.string.charAt(this.pos);if("string"==typeof a)var c=b==a;else var c=b&&(a.test?a.test(b):a(b));return c?(++this.pos,b):void 0},eatWhile:function(a){for(var b=this.pos;this.eat(a););return this.pos>b},eatSpace:function(){for(var a=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>a},skipToEnd:function(){this.pos=this.string.length},skipTo:function(a){var b=this.string.indexOf(a,this.pos);return b>-1?(this.pos=b,!0):void 0},backUp:function(a){this.pos-=a},column:function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=ed(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?ed(this.string,this.lineStart,this.tabSize):0)},indentation:function(){return ed(this.string,null,this.tabSize)-(this.lineStart?ed(this.string,this.lineStart,this.tabSize):0)},match:function(a,b,c){if("string"!=typeof a){var d=this.string.slice(this.pos).match(a);return d&&d.index>0?null:(d&&b!==!1&&(this.pos+=d[0].length),d)}var e=function(a){return c?a.toLowerCase():a},f=this.string.substr(this.pos,a.length);return e(f)==e(a)?(b!==!1&&(this.pos+=a.length),!0):void 0},current:function(){return this.string.slice(this.start,this.pos)},hideFirstChars:function(a,b){this.lineStart+=a;try{return b()}finally{this.lineStart-=a}}},a.StringStream=Db,a.TextMarker=Eb,cd(Eb),Eb.prototype.clear=function(){if(!this.explicitlyCleared){var a=this.doc.cm,b=a&&!a.curOp;if(b&&fa(a),bd(this,"clear")){var c=this.find();c&&$c(this,"clear",c.from,c.to)}for(var d=null,e=null,f=0;f<this.lines.length;++f){var g=this.lines[f],h=Ib(g.markedSpans,this);null!=h.to&&(e=Bc(g)),g.markedSpans=Jb(g.markedSpans,h),null!=h.from?d=Bc(g):this.collapsed&&!Zb(this.doc,g)&&a&&Ac(g,da(a.display))}if(a&&this.collapsed&&!a.options.lineWrapping)for(var f=0;f<this.lines.length;++f){var i=Yb(a.doc,this.lines[f]),j=l(a.doc,i);j>a.display.maxLineLength&&(a.display.maxLine=i,a.display.maxLineLength=j,a.display.maxLineChanged=!0)}null!=d&&a&&ka(a,d,e+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,a&&ib(a)),b&&ga(a)}},Eb.prototype.find=function(a){for(var b,c,d=0;d<this.lines.length;++d){var e=this.lines[d],f=Ib(e.markedSpans,this);if(null!=f.from||null!=f.to){var g=Bc(e);null!=f.from&&(b=Ya(g,f.from)),null!=f.to&&(c=Ya(g,f.to))}}return"bookmark"!=this.type||a?b&&{from:b,to:c}:b},Eb.prototype.changed=function(){var a=this.find(),b=this.doc.cm;if(a&&b){"bookmark"!=this.type&&(a=a.from);var c=xc(this.doc,a.line);if(Q(b,c),a.line>=b.display.showingFrom&&a.line<b.display.showingTo){for(var d=b.display.lineDiv.firstChild;d;d=d.nextSibling)if(d.lineObj==c){d.offsetHeight!=c.height&&Ac(c,d.offsetHeight);break}ja(b,function(){b.curOp.selectionChanged=b.curOp.forceUpdate=b.curOp.updateMaxLine=!0})}}},Eb.prototype.attachLine=function(a){if(!this.lines.length&&this.doc.cm){var b=this.doc.cm.curOp;b.maybeHiddenMarkers&&-1!=id(b.maybeHiddenMarkers,this)||(b.maybeUnhiddenMarkers||(b.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(a)},Eb.prototype.detachLine=function(a){if(this.lines.splice(id(this.lines,a),1),!this.lines.length&&this.doc.cm){var b=this.doc.cm.curOp;(b.maybeHiddenMarkers||(b.maybeHiddenMarkers=[])).push(this)}};var De=0;a.SharedTextMarker=Gb,cd(Gb),Gb.prototype.clear=function(){if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var a=0;a<this.markers.length;++a)this.markers[a].clear();$c(this,"clear")}},Gb.prototype.find=function(){return this.primary.find()};var Ee=a.LineWidget=function(a,b,c){if(c)for(var d in c)c.hasOwnProperty(d)&&(this[d]=c[d]);this.cm=a,this.node=b};cd(Ee),Ee.prototype.clear=bc(function(){var a=this.line.widgets,b=Bc(this.line);if(null!=b&&a){for(var c=0;c<a.length;++c)a[c]==this&&a.splice(c--,1);a.length||(this.line.widgets=null);var d=Dc(this.cm,this.line)<this.cm.doc.scrollTop;Ac(this.line,Math.max(0,this.line.height-cc(this))),d&&pb(this.cm,0,-this.height),ka(this.cm,b,b+1)}}),Ee.prototype.changed=bc(function(){var a=this.height;this.height=null;var b=cc(this)-a;if(b){Ac(this.line,this.line.height+b);var c=Bc(this.line);ka(this.cm,c,c+1)}});var Fe=a.Line=function(a,b,c){this.text=a,ac(this,b),this.height=c?c(this):1};cd(Fe),Fe.prototype.lineNo=function(){return Bc(this)};var Ge={},He={};tc.prototype={chunkSize:function(){return this.lines.length},removeInner:function(a,b){for(var c=a,d=a+b;d>c;++c){var e=this.lines[c];this.height-=e.height,fc(e),$c(e,"delete")}this.lines.splice(a,b)},collapse:function(a){a.splice.apply(a,[a.length,0].concat(this.lines))},insertInner:function(a,b,c){this.height+=c,this.lines=this.lines.slice(0,a).concat(b).concat(this.lines.slice(a));for(var d=0,e=b.length;e>d;++d)b[d].parent=this},iterN:function(a,b,c){for(var d=a+b;d>a;++a)if(c(this.lines[a]))return!0}},uc.prototype={chunkSize:function(){return this.size},removeInner:function(a,b){this.size-=b;for(var c=0;c<this.children.length;++c){var d=this.children[c],e=d.chunkSize();if(e>a){var f=Math.min(b,e-a),g=d.height;if(d.removeInner(a,f),this.height-=g-d.height,e==f&&(this.children.splice(c--,1),d.parent=null),0==(b-=f))break;a=0}else a-=e}if(this.size-b<25){var h=[];this.collapse(h),this.children=[new tc(h)],this.children[0].parent=this}},collapse:function(a){for(var b=0,c=this.children.length;c>b;++b)this.children[b].collapse(a)},insertInner:function(a,b,c){this.size+=b.length,this.height+=c;for(var d=0,e=this.children.length;e>d;++d){var f=this.children[d],g=f.chunkSize();if(g>=a){if(f.insertInner(a,b,c),f.lines&&f.lines.length>50){for(;f.lines.length>50;){var h=f.lines.splice(f.lines.length-25,25),i=new tc(h);f.height-=i.height,this.children.splice(d+1,0,i),i.parent=this}this.maybeSpill()}break}a-=g}},maybeSpill:function(){if(!(this.children.length<=10)){var a=this;do{var b=a.children.splice(a.children.length-5,5),c=new uc(b);if(a.parent){a.size-=c.size,a.height-=c.height;var d=id(a.parent.children,a);a.parent.children.splice(d+1,0,c)}else{var e=new uc(a.children);e.parent=a,a.children=[e,c],a=e}c.parent=a.parent}while(a.children.length>10);a.parent.maybeSpill()}},iterN:function(a,b,c){for(var d=0,e=this.children.length;e>d;++d){var f=this.children[d],g=f.chunkSize();if(g>a){var h=Math.min(b,g-a);if(f.iterN(a,h,c))return!0;if(0==(b-=h))break;a=0}else a-=g}}};var Ie=0,Je=a.Doc=function(a,b,c){if(!(this instanceof Je))return new Je(a,b,c);null==c&&(c=0),uc.call(this,[new tc([new Fe("",null)])]),this.first=c,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.history=Fc(),this.cleanGeneration=1,this.frontier=c;var d=Ya(c,0);this.sel={from:d,to:d,head:d,anchor:d,shift:!1,extend:!1,goalColumn:null},this.id=++Ie,this.modeOption=b,"string"==typeof a&&(a=We(a)),sc(this,{from:d,to:d,text:a},null,{head:d,anchor:d})};Je.prototype=jd(uc.prototype,{constructor:Je,iter:function(a,b,c){c?this.iterN(a-this.first,b-a,c):this.iterN(this.first,this.first+this.size,a)},insert:function(a,b){for(var c=0,d=0,e=b.length;e>d;++d)c+=b[d].height;this.insertInner(a-this.first,b,c)},remove:function(a,b){this.removeInner(a-this.first,b)},getValue:function(a){var b=zc(this,this.first,this.first+this.size);return a===!1?b:b.join(a||"\n")},setValue:function(a){var b=Ya(this.first,0),c=this.first+this.size-1;Ra(this,{from:b,to:Ya(c,xc(this,c).text.length),text:We(a),origin:"setValue"},{head:b,anchor:b},!0)},replaceRange:function(a,b,c,d){b=cb(this,b),c=c?cb(this,c):b,Xa(this,a,b,c,d)},getRange:function(a,b,c){var d=yc(this,cb(this,a),cb(this,b));return c===!1?d:d.join(c||"\n")},getLine:function(a){var b=this.getLineHandle(a);return b&&b.text},setLine:function(a,b){eb(this,a)&&Xa(this,b,Ya(a,0),cb(this,Ya(a)))},removeLine:function(a){a?Xa(this,"",cb(this,Ya(a-1)),cb(this,Ya(a))):Xa(this,"",Ya(0,0),cb(this,Ya(1,0)))},getLineHandle:function(a){return eb(this,a)?xc(this,a):void 0},getLineNumber:function(a){return Bc(a)},getLineHandleVisualStart:function(a){return"number"==typeof a&&(a=xc(this,a)),Yb(this,a)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(a){return cb(this,a)},getCursor:function(a){var b,c=this.sel;return b=null==a||"head"==a?c.head:"anchor"==a?c.anchor:"end"==a||a===!1?c.to:c.from,ab(b)},somethingSelected:function(){return!Za(this.sel.head,this.sel.anchor)},setCursor:ia(function(a,b,c){var d=cb(this,"number"==typeof a?Ya(a,b||0):a);c?fb(this,d):hb(this,d,d)}),setSelection:ia(function(a,b,c){hb(this,cb(this,a),cb(this,b||a),c)}),extendSelection:ia(function(a,b,c){fb(this,cb(this,a),b&&cb(this,b),c)}),getSelection:function(a){return this.getRange(this.sel.from,this.sel.to,a)},replaceSelection:function(a,b,c){Ra(this,{from:this.sel.from,to:this.sel.to,text:We(a),origin:c},b||"around")},undo:ia(function(){Ta(this,"undo")}),redo:ia(function(){Ta(this,"redo")}),setExtending:function(a){this.sel.extend=a},historySize:function(){var a=this.history;return{undo:a.done.length,redo:a.undone.length}},clearHistory:function(){this.history=Fc(this.history.maxGeneration)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(a){return a&&(this.history.lastOp=this.history.lastOrigin=null),this.history.generation},isClean:function(a){return this.history.generation==(a||this.cleanGeneration)},getHistory:function(){return{done:Lc(this.history.done),undone:Lc(this.history.undone)}},setHistory:function(a){var b=this.history=Fc(this.history.maxGeneration);b.done=a.done.slice(0),b.undone=a.undone.slice(0)},markText:function(a,b,c){return Fb(this,cb(this,a),cb(this,b),c,"range")},setBookmark:function(a,b){var c={replacedWith:b&&(null==b.nodeType?b.widget:b),insertLeft:b&&b.insertLeft,clearWhenEmpty:!1};return a=cb(this,a),Fb(this,a,a,c,"bookmark")},findMarksAt:function(a){a=cb(this,a);var b=[],c=xc(this,a.line).markedSpans;if(c)for(var d=0;d<c.length;++d){var e=c[d];(null==e.from||e.from<=a.ch)&&(null==e.to||e.to>=a.ch)&&b.push(e.marker.parent||e.marker)}return b},findMarks:function(a,b){a=cb(this,a),b=cb(this,b);var c=[],d=a.line;return this.iter(a.line,b.line+1,function(e){var f=e.markedSpans;if(f)for(var g=0;g<f.length;g++){var h=f[g];d==a.line&&a.ch>h.to||null==h.from&&d!=a.line||d==b.line&&h.from>b.ch||c.push(h.marker.parent||h.marker)}++d}),c},getAllMarks:function(){var a=[];return this.iter(function(b){var c=b.markedSpans;if(c)for(var d=0;d<c.length;++d)null!=c[d].from&&a.push(c[d].marker)}),a},posFromIndex:function(a){var b,c=this.first;return this.iter(function(d){var e=d.text.length+1;return e>a?(b=a,!0):(a-=e,void++c)}),cb(this,Ya(c,b))},indexFromPos:function(a){a=cb(this,a);var b=a.ch;return a.line<this.first||a.ch<0?0:(this.iter(this.first,a.line,function(a){b+=a.text.length+1}),b)},copy:function(a){var b=new Je(zc(this,this.first,this.first+this.size),this.modeOption,this.first);return b.scrollTop=this.scrollTop,b.scrollLeft=this.scrollLeft,b.sel={from:this.sel.from,to:this.sel.to,head:this.sel.head,anchor:this.sel.anchor,shift:this.sel.shift,extend:!1,goalColumn:this.sel.goalColumn},a&&(b.history.undoDepth=this.history.undoDepth,b.setHistory(this.getHistory())),b},linkedDoc:function(a){a||(a={});var b=this.first,c=this.first+this.size;null!=a.from&&a.from>b&&(b=a.from),null!=a.to&&a.to<c&&(c=a.to);var d=new Je(zc(this,b,c),a.mode||this.modeOption,b);return a.sharedHist&&(d.history=this.history),(this.linked||(this.linked=[])).push({doc:d,sharedHist:a.sharedHist}),d.linked=[{doc:this,isParent:!0,sharedHist:a.sharedHist}],d},unlinkDoc:function(b){if(b instanceof a&&(b=b.doc),this.linked)for(var c=0;c<this.linked.length;++c){var d=this.linked[c];if(d.doc==b){this.linked.splice(c,1),b.unlinkDoc(this);break}}if(b.history==this.history){var e=[b.id];vc(b,function(a){e.push(a.id)},!0),b.history=Fc(),b.history.done=Lc(this.history.done,e),b.history.undone=Lc(this.history.undone,e)}},iterLinkedDocs:function(a){vc(this,a)},getMode:function(){return this.mode},getEditor:function(){return this.cm}}),Je.prototype.eachLine=Je.prototype.iter;var Ke="iter insert remove copy getEditor".split(" ");for(var Le in Je.prototype)Je.prototype.hasOwnProperty(Le)&&id(Ke,Le)<0&&(a.prototype[Le]=function(a){return function(){return a.apply(this.doc,arguments)}}(Je.prototype[Le]));cd(Je),a.e_stop=Uc,a.e_preventDefault=Rc,a.e_stopPropagation=Sc;var Me,Ne=0;a.on=Xc,a.off=Yc,a.signal=Zc;var Oe=30,Pe=a.Pass={toString:function(){return"CodeMirror.Pass"}};dd.prototype={set:function(a,b){clearTimeout(this.id),this.id=setTimeout(b,a)}},a.countColumn=ed;var Qe=[""],Re=/[\u00df\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/,Se=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/;a.replaceGetRect=function(a){vd=a};var Te=function(){if(Od)return!1;var a=rd("div");return"draggable"in a||"dragDrop"in a}();Ld?wd=function(a,b){return 36==a.charCodeAt(b-1)&&39==a.charCodeAt(b)}:Wd&&!/Version\/([6-9]|\d\d)\b/.test(navigator.userAgent)?wd=function(a,b){return/\-[^ \-?]|\?[^ !\'\"\),.\-\/:;\?\]\}]/.test(a.slice(b-1,b+1))}:Sd&&/Chrome\/(?:29|[3-9]\d|\d\d\d)\./.test(navigator.userAgent)?wd=function(a,b){var c=a.charCodeAt(b-1);return c>=8208&&8212>=c}:Sd&&(wd=function(a,b){if(b>1&&45==a.charCodeAt(b-1)){if(/\w/.test(a.charAt(b-2))&&/[^\-?\.]/.test(a.charAt(b)))return!0;if(b>2&&/[\d\.,]/.test(a.charAt(b-2))&&/[\d\.,]/.test(a.charAt(b)))return!1}return/[~!#%&*)=+}\]\\|\"\.>,:;][({[<]|-[^\-?\.\u2010-\u201f\u2026]|\?[\w~`@#$%\^&*(_=+{[|><]|\u2026[\w~`@#$%\^&*(_=+{[><]/.test(a.slice(b-1,b+1))});var Ue,Ve,We=3!="\n\nb".split(/\n/).length?function(a){for(var b=0,c=[],d=a.length;d>=b;){var e=a.indexOf("\n",b);-1==e&&(e=a.length);var f=a.slice(b,"\r"==a.charAt(e-1)?e-1:e),g=f.indexOf("\r");-1!=g?(c.push(f.slice(0,g)),b+=g+1):(c.push(f),b=e+1)}return c}:function(a){return a.split(/\r\n?|\n/)};a.splitLines=We;var Xe=window.getSelection?function(a){try{return a.selectionStart!=a.selectionEnd}catch(b){return!1}}:function(a){try{var b=a.ownerDocument.selection.createRange()}catch(c){}return b&&b.parentElement()==a?0!=b.compareEndPoints("StartToEnd",b):!1},Ye=function(){var a=rd("div");return"oncopy"in a?!0:(a.setAttribute("oncopy","return;"),"function"==typeof a.oncopy)}(),Ze={3:"Enter",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",107:"=",109:"-",127:"Delete",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"};a.keyNames=Ze,function(){for(var a=0;10>a;a++)Ze[a+48]=Ze[a+96]=String(a);for(var a=65;90>=a;a++)Ze[a]=String.fromCharCode(a);for(var a=1;12>=a;a++)Ze[a+111]=Ze[a+63235]="F"+a}();var $e,_e=function(){function a(a){return 255>=a?b.charAt(a):a>=1424&&1524>=a?"R":a>=1536&&1791>=a?c.charAt(a-1536):a>=1792&&2220>=a?"r":"L"}var b="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLL",c="rrrrrrrrrrrr,rNNmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmrrrrrrrnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmNmmmmrrrrrrrrrrrrrrrrrr",d=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,e=/[stwN]/,f=/[LRr]/,g=/[Lb1n]/,h=/[1n]/,i="L";return function(b){if(!d.test(b))return!1;for(var c,j=b.length,k=[],l=0;j>l;++l)k.push(c=a(b.charCodeAt(l)));for(var l=0,m=i;j>l;++l){var c=k[l];"m"==c?k[l]=m:m=c}for(var l=0,n=i;j>l;++l){var c=k[l];"1"==c&&"r"==n?k[l]="n":f.test(c)&&(n=c,"r"==c&&(k[l]="R"))}for(var l=1,m=k[0];j-1>l;++l){var c=k[l];"+"==c&&"1"==m&&"1"==k[l+1]?k[l]="1":","!=c||m!=k[l+1]||"1"!=m&&"n"!=m||(k[l]=m),m=c}for(var l=0;j>l;++l){var c=k[l];if(","==c)k[l]="N";else if("%"==c){for(var o=l+1;j>o&&"%"==k[o];++o);for(var p=l&&"!"==k[l-1]||j>o&&"1"==k[o]?"1":"N",q=l;o>q;++q)k[q]=p;l=o-1}}for(var l=0,n=i;j>l;++l){var c=k[l];"L"==n&&"1"==c?k[l]="L":f.test(c)&&(n=c)}for(var l=0;j>l;++l)if(e.test(k[l])){for(var o=l+1;j>o&&e.test(k[o]);++o);for(var r="L"==(l?k[l-1]:i),s="L"==(j>o?k[o]:i),p=r||s?"L":"R",q=l;o>q;++q)k[q]=p;l=o-1}for(var t,u=[],l=0;j>l;)if(g.test(k[l])){var v=l;for(++l;j>l&&g.test(k[l]);++l);u.push({from:v,to:l,level:0})}else{var w=l,x=u.length;for(++l;j>l&&"L"!=k[l];++l);for(var q=w;l>q;)if(h.test(k[q])){q>w&&u.splice(x,0,{from:w,to:q,level:1});var y=q;for(++q;l>q&&h.test(k[q]);++q);u.splice(x,0,{from:y,to:q,level:2}),w=q}else++q;l>w&&u.splice(x,0,{from:w,to:l,level:1})}return 1==u[0].level&&(t=b.match(/^\s+/))&&(u[0].from=t[0].length,u.unshift({from:0,to:t[0].length,level:0})),1==gd(u).level&&(t=b.match(/\s+$/))&&(gd(u).to-=t[0].length,u.push({from:j-t[0].length,to:j,level:0})),u[0].level!=gd(u).level&&u.push({from:j,to:j,level:u[0].level}),u}}();return a.version="3.22.1",a}(),function(){"use strict";function a(a,b,c){this.cm=a,this.getHints=b,this.options=c,this.widget=this.onClose=null}function b(a){return"string"==typeof a?a:"object"==typeof a?a[0]:a.text}function c(a){return"object"==typeof a?a[1]:""}function d(a,b){function c(a,c){var f;f="string"!=typeof c?function(a){return c(a,b)}:d.hasOwnProperty(c)?d[c]:c,e[a]=f}var d={Up:function(){b.moveFocus(-1)},Down:function(){b.moveFocus(1)},PageUp:function(){b.moveFocus(-b.menuSize())},PageDown:function(){b.moveFocus(b.menuSize())},Home:function(){b.setFocus(0)},End:function(){b.setFocus(b.length)},Enter:b.pick,Tab:b.pick,Esc:b.close},e=a.customKeys?{}:d;if(a.customKeys)for(var f in a.customKeys)a.customKeys.hasOwnProperty(f)&&c(f,a.customKeys[f]);if(a.extraKeys)for(var f in a.extraKeys)a.extraKeys.hasOwnProperty(f)&&c(f,a.extraKeys[f]);return e}function e(a,e){this.completion=a,this.data=e;var f=this,g=a.cm,h=a.options,i=this.hints=document.createElement("ul");i.className="CodeMirror-hints",this.selectedHint=0;for(var j=e.list,k=0;k<j.length;++k){var l=i.appendChild(document.createElement("li")),m=b(j[k]),n="CodeMirror-hint"+(k?"":" CodeMirror-hint-active");if(null!=m.className&&(n=m.className+" "+n),l.className=n,m.render)m.render(l,e,m);else{var o=document.createElement("span");if(o.className="string"==typeof j[k]?"text":"value",o.innerHTML=m.displayText||m,o.title=m.displayText||m,o.hintId=k,c(j[k])){var p=document.createElement("span");p.className="type",p.hintId=k,p.innerHTML=c(j[k]),l.appendChild(p)}l.appendChild(o)}l.hintId=k}var q=g.cursorCoords(h.alignWithWord!==!1?e.from:null),r=q.left,s=q.bottom,t=!0;i.style.left=r+"px",i.style.top=s+"px";var u=window.innerWidth||Math.max(document.body.offsetWidth,document.documentElement.offsetWidth),v=window.innerHeight||Math.max(document.body.offsetHeight,document.documentElement.offsetHeight);(h.container||document.body).appendChild(i);var w=i.getBoundingClientRect(),x=w.right-u,y=w.bottom-v;if(x>0&&(w.right-w.left>u&&(i.style.width=u-5+"px",x-=w.right-w.left-u),i.style.left=(r=q.left-x)+"px"),y>0){var z=w.bottom-w.top;w.top-(q.bottom-q.top)-z>0?(y=z+(q.bottom-q.top),t=!1):z>v&&(i.style.height=v-5+"px",y-=z-v),i.style.top=(s=q.bottom-y)+"px"}if(g.addKeyMap(this.keyMap=d(h,{moveFocus:function(a){f.changeActive(f.selectedHint+a)},setFocus:function(a){f.changeActive(a)},menuSize:function(){return f.screenAmount()},length:j.length,close:function(){a.close()},pick:function(){f.pick()}})),h.closeOnUnfocus!==!1){var A;g.on("blur",this.onBlur=function(){A=setTimeout(function(){a.close()},100)}),g.on("focus",this.onFocus=function(){clearTimeout(A)})}var B=g.getScrollInfo();return g.on("scroll",this.onScroll=function(){var b=g.getScrollInfo(),c=g.getWrapperElement().getBoundingClientRect(),d=s+B.top-b.top,e=d-(window.pageYOffset||(document.documentElement||document.body).scrollTop);return t||(e+=i.offsetHeight),e<=c.top||e>=c.bottom?a.close():(i.style.top=d+"px",void(i.style.left=r+B.left-b.left+"px"))}),CodeMirror.on(i,"click",function(a){var b=a.target||a.srcElement;null!=b.hintId&&(f.changeActive(b.hintId),f.pick())}),CodeMirror.on(i,"mouseover",function(a){var b=a.target||a.srcElement;null!=b.hintId&&f.changeActive(b.hintId)}),CodeMirror.on(i,"mousedown",function(){setTimeout(function(){g.focus()},20)}),CodeMirror.signal(e,"select",j[0],i.firstChild),!0}CodeMirror.showHint=function(b,c,d){if(!b.somethingSelected()&&(null==c&&(c=b.getHelper(b.getCursor(),"hint")),null!=c)){b.state.completionActive&&b.state.completionActive.close();var e=b.state.completionActive=new a(b,c,d||{});return CodeMirror.signal(b,"startCompletion",b),e.options.async?void c(b,function(a){e.showHints(a)},e.options):e.showHints(c(b,e.options))}},a.prototype={close:function(){this.active()&&(this.cm.state.completionActive=null,this.widget&&this.widget.close(),this.onClose&&this.onClose(),CodeMirror.signal(this.cm,"endCompletion",this.cm));
},active:function(){return this.cm.state.completionActive==this},pick:function(a,c){var d=a.list[c];d.hint?d.hint(this.cm,a,d):this.cm.replaceRange(b(d),a.from,a.to),this.close()},showHints:function(a){return a&&a.list.length&&this.active()?void(0!=this.options.completeSingle&&1==a.list.length?this.pick(a,0):this.showWidget(a)):this.close()},showWidget:function(a){function b(){g||(g=!0,i.close(),i.cm.off("cursorActivity",f),a&&CodeMirror.signal(a,"close"))}function c(){g||(CodeMirror.signal(a,"update"),i.options.async?i.getHints(i.cm,d,i.options):d(i.getHints(i.cm,i.options)))}function d(c){return a=c,g?void 0:a&&a.list.length?void(i.widget=new e(i,a)):b()}function f(){clearTimeout(h);var a=i.cm.getCursor(),b=i.cm.getLine(a.line);a.line!=k.line||b.length-a.ch!=l-k.ch||a.ch<k.ch||i.cm.somethingSelected()||a.ch&&j.test(b.charAt(a.ch-1))?i.close():(h=setTimeout(c,170),i.widget&&i.widget.close())}this.widget=new e(this,a),CodeMirror.signal(a,"shown");var g,h=null,i=this,j=this.options.closeCharacters||/[\s()\[\]{};:>,-]/,k=this.cm.getCursor(),l=this.cm.getLine(k.line).length;this.cm.on("cursorActivity",f),this.onClose=b}},e.prototype={close:function(){if(this.completion.widget==this){this.completion.widget=null,this.hints.parentNode.removeChild(this.hints),this.completion.cm.removeKeyMap(this.keyMap);var a=this.completion.cm;this.completion.options.closeOnUnfocus!==!1&&(a.off("blur",this.onBlur),a.off("focus",this.onFocus)),a.off("scroll",this.onScroll)}},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(a){if(a=Math.max(0,Math.min(a,this.data.list.length-1)),this.selectedHint!=a){var b=this.hints.childNodes[this.selectedHint];b.className=b.className.replace(" CodeMirror-hint-active",""),b=this.hints.childNodes[this.selectedHint=a],b.className+=" CodeMirror-hint-active",b.offsetTop<this.hints.scrollTop?this.hints.scrollTop=b.offsetTop-3:b.offsetTop+b.offsetHeight>this.hints.scrollTop+this.hints.clientHeight&&(this.hints.scrollTop=b.offsetTop+b.offsetHeight-this.hints.clientHeight+3),CodeMirror.signal(this.data,"select",this.data.list[this.selectedHint],b)}},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1}}}(),function(){"use strict";var a=/[\w$]+/,b=500;CodeMirror.registerHelper("hint","anyword",function(c,d){function e(a){for(var b=h.line,d=Math.min(Math.max(b+a*g,c.firstLine()),c.lastLine())+a;b!=d;b+=a)for(var e,i=c.getLine(b),j=new RegExp(f.source,"g");e=j.exec(i);)(b!=h.line||e[0]!==l)&&(l&&0!=e[0].indexOf(l)||n.hasOwnProperty(e[0])||(n[e[0]]=!0,m.push(e[0])))}for(var f=d&&d.word||a,g=d&&d.range||b,h=c.getCursor(),i=c.getLine(h.line),j=h.ch,k=j;k<i.length&&f.test(i.charAt(k));)++k;for(;j&&f.test(i.charAt(j-1));)--j;var l=j!=k&&i.slice(j,k),m=[],n={};return e(-1),e(1),{list:m,from:CodeMirror.Pos(h.line,j),to:CodeMirror.Pos(h.line,k)}})}(),function(){function a(a,b){for(var c=0,d=a.length;d>c;++c)b(a[c])}function b(a,b){if(!Array.prototype.indexOf){for(var c=a.length;c--;)if(a[c]===b)return!0;return!1}return-1!=a.indexOf(b)}function c(a,b,c,d){var g=a.getCursor(),h=c(a,g),i=h;for(h.state=CodeMirror.innerMode(a.getMode(),h.state).state,/^[\w$_]*$/.test(h.string)||(h=i={start:g.ch,end:g.ch,string:"",state:h.state,type:"."==h.string?"property":null});"property"==i.type;){if(i=c(a,f(g.line,i.start)),"."!=i.string)return;if(i=c(a,f(g.line,i.start)),")"==i.string){var j=1;do switch(i=c(a,f(g.line,i.start)),i.string){case")":j++;break;case"(":j--}while(j>0);if(i=c(a,f(g.line,i.start)),0!==i.type.indexOf("variable"))return;i.type="function"}if(!k)var k=[];k.push(i)}return{list:e(h,k,b,d),from:f(g.line,h.start),to:f(g.line,h.end)}}function d(a,b){return c(a,[],function(a,b){return a.getTokenAt(b)},b)}function e(c,d,e,f){function g(a){0!=a.indexOf(j)||j==a||b(i,a)||i.push(a)}function h(a){for(var b in a)g(a[b])}var i=[],j=c.string;return h(f.list),a(e,g),i}var f=CodeMirror.Pos;CodeMirror.registerHelper("hint","custom-list",d)}(),function(){function a(a,b){for(var c=0,d=a.length;d>c;++c)b(a[c])}function b(a,b){if(!Array.prototype.indexOf){for(var c=a.length;c--;)if(a[c]===b)return!0;return!1}return-1!=a.indexOf(b)}function c(a,b,c,d){var g=a.getCursor(),h=c(a,g),i=h;for(h.state=CodeMirror.innerMode(a.getMode(),h.state).state,/^[\w$_]*$/.test(h.string)||(h=i={start:g.ch,end:g.ch,string:"",state:h.state,type:"."==h.string?"property":null});"property"==i.type;){if(i=c(a,f(g.line,i.start)),"."!=i.string)return;if(i=c(a,f(g.line,i.start)),")"==i.string){var j=1;do switch(i=c(a,f(g.line,i.start)),i.string){case")":j++;break;case"(":j--}while(j>0);if(i=c(a,f(g.line,i.start)),0!==i.type.indexOf("variable"))return;i.type="function"}if(!k)var k=[];k.push(i)}return{list:e(h,k,b,d),from:f(g.line,h.start),to:f(g.line,h.end)}}function d(a,b){return c(a,[],function(a,b){return a.getTokenAt(b)},b)}function e(c,d,e,f){function g(a){0!=a[0].indexOf(j)||j==a[0]||b(i,a[0])||i.push(a)}function h(a){for(var b in a)g(a[b])}var i=[],j=c.string;return h(f.list),a(e,g),i}var f=CodeMirror.Pos;CodeMirror.registerHelper("hint","custom-list-with-type",d)}(),function(a){"undefined"==typeof a.fn.each2&&a.fn.extend({each2:function(b){for(var c=a([0]),d=-1,e=this.length;++d<e&&(c.context=c[0]=this[d])&&b.call(c[0],d,c)!==!1;);return this}})}(jQuery),function(a,b){"use strict";function c(a,b){var c,d=0,e=b.length;if("undefined"==typeof a)return-1;if(a.constructor===String){for(;e>d;d+=1)if(0===a.localeCompare(b[d]))return d}else for(;e>d;d+=1)if(c=b[d],c.constructor===String){if(0===c.localeCompare(a))return d}else if(c===a)return d;return-1}function d(a,c){return a===c?!0:a===b||c===b?!1:null===a||null===c?!1:a.constructor===String?0===a.localeCompare(c):c.constructor===String?0===c.localeCompare(a):!1}function e(b,c){var d,e,f;if(null===b||b.length<1)return[];for(d=b.split(c),e=0,f=d.length;f>e;e+=1)d[e]=a.trim(d[e]);return d}function f(a){return a.outerWidth(!1)-a.width()}function g(c){var d="keyup-change-value";c.bind("keydown",function(){a.data(c,d)===b&&a.data(c,d,c.val())}),c.bind("keyup",function(){var e=a.data(c,d);e!==b&&c.val()!==e&&(a.removeData(c,d),c.trigger("keyup-change"))})}function h(c){c.bind("mousemove",function(c){var d=D;(d===b||d.x!==c.pageX||d.y!==c.pageY)&&a(c.target).trigger("mousemove-filtered",c)})}function i(a,c,d){d=d||b;var e;return function(){var b=arguments;window.clearTimeout(e),e=window.setTimeout(function(){c.apply(d,b)},a)}}function j(a){var b,c=!1;return function(){return c===!1&&(b=a(),c=!0),b}}function k(a,b){var d=i(a,function(a){b.trigger("scroll-debounced",a)});b.bind("scroll",function(a){c(a.target,b.get())>=0&&d(a)})}function l(a){a.preventDefault(),a.stopPropagation()}function m(a){a.preventDefault(),a.stopImmediatePropagation()}function n(b){if(!C){var c=b[0].currentStyle||window.getComputedStyle(b[0],null);C=a("<div></div>").css({position:"absolute",left:"-10000px",top:"-10000px",display:"none",fontSize:c.fontSize,fontFamily:c.fontFamily,fontStyle:c.fontStyle,fontWeight:c.fontWeight,letterSpacing:c.letterSpacing,textTransform:c.textTransform,whiteSpace:"nowrap"}),a("body").append(C)}return C.text(b.val()),C.width()}function o(a,b,c){var d=a.toUpperCase().indexOf(b.toUpperCase()),e=b.length;return 0>d?void c.push(a):(c.push(a.substring(0,d)),c.push("<span class='select2-match'>"),c.push(a.substring(d,d+e)),c.push("</span>"),void c.push(a.substring(d+e,a.length)))}function p(b){var c,d=0,e=null,f=b.quietMillis||100;return function(g){window.clearTimeout(c),c=window.setTimeout(function(){d+=1;var c=d,f=b.data,h=b.transport||a.ajax,i=b.traditional||!1,j=b.type||"GET";f=f.call(this,g.term,g.page,g.context),null!==e&&e.abort(),e=h.call(null,{url:b.url,dataType:b.dataType,data:f,type:j,traditional:i,success:function(a){if(!(d>c)){var e=b.results(a,g.page);g.callback(e)}}})},f)}}function q(b){var c,d=b,e=function(a){return""+a.text};return a.isArray(d)||(e=d.text,a.isFunction(e)||(c=d.text,e=function(a){return a[c]}),d=d.results),function(b){var c,f=b.term,g={results:[]};return""===f?void b.callback({results:d}):(c=function(d,g){var h,i;if(d=d[0],d.children){h={};for(i in d)d.hasOwnProperty(i)&&(h[i]=d[i]);h.children=[],a(d.children).each2(function(a,b){c(b,h.children)}),(h.children.length||b.matcher(f,e(h)))&&g.push(h)}else b.matcher(f,e(d))&&g.push(d)},a(d).each2(function(a,b){c(b,g.results)}),void b.callback(g))}}function r(c){return a.isFunction(c)?c:function(d){var e=d.term,f={results:[]};a(c).each(function(){var a=this.text!==b,c=a?this.text:this;(""===e||d.matcher(e,c))&&f.results.push(a?this:{id:this,text:this})}),d.callback(f)}}function s(b,c){if(a.isFunction(b))return!0;if(!b)return!1;throw new Error("formatterName must be a function or a falsy value")}function t(b){return a.isFunction(b)?b():b}function u(b){var c=0;return a.each(b,function(a,b){b.children?c+=u(b.children):c++}),c}function v(a,c,e,f){var g,h,i,j,k,l=a,m=!1;if(!f.createSearchChoice||!f.tokenSeparators||f.tokenSeparators.length<1)return b;for(;;){for(h=-1,i=0,j=f.tokenSeparators.length;j>i&&(k=f.tokenSeparators[i],h=a.indexOf(k),!(h>=0));i++);if(0>h)break;if(g=a.substring(0,h),a=a.substring(h+k.length),g.length>0&&(g=f.createSearchChoice(g,c),g!==b&&null!==g&&f.id(g)!==b&&null!==f.id(g))){for(m=!1,i=0,j=c.length;j>i;i++)if(d(f.id(g),f.id(c[i]))){m=!0;break}m||e(g)}}return 0!=l.localeCompare(a)?a:void 0}function w(b,c){var d=function(){};return d.prototype=new b,d.prototype.constructor=d,d.prototype.parent=b.prototype,d.prototype=a.extend(d.prototype,c),d}if(window.Select2===b){var x,y,z,A,B,C,D,E;x={TAB:9,ENTER:13,ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,SHIFT:16,CTRL:17,ALT:18,PAGE_UP:33,PAGE_DOWN:34,HOME:36,END:35,BACKSPACE:8,DELETE:46,isArrow:function(a){switch(a=a.which?a.which:a){case x.LEFT:case x.RIGHT:case x.UP:case x.DOWN:return!0}return!1},isControl:function(a){var b=a.which;switch(b){case x.SHIFT:case x.CTRL:case x.ALT:return!0}return a.metaKey?!0:!1},isFunctionKey:function(a){return a=a.which?a.which:a,a>=112&&123>=a}},E=a(document),B=function(){var a=1;return function(){return a++}}(),E.bind("mousemove",function(a){D={x:a.pageX,y:a.pageY}}),E.ready(function(){E.bind("mousedown touchend",function(c){var d,e=a(c.target).closest("div.select2-container").get(0);e?E.find("div.select2-container-active").each(function(){this!==e&&a(this).data("select2").blur()}):(e=a(c.target).closest("div.select2-drop").get(0),E.find("div.select2-drop-active").each(function(){this!==e&&a(this).data("select2").blur()})),e=a(c.target),d=e.attr("for"),"LABEL"===c.target.tagName&&d&&d.length>0&&(d=d.replace(/([\[\].])/g,"\\$1"),e=a("#"+d),e=e.data("select2"),e!==b&&(e.focus(),c.preventDefault()))})}),y=w(Object,{bind:function(a){var b=this;return function(){a.apply(b,arguments)}},init:function(c){var d,e,f,i=".select2-results";if(this.opts=c=this.prepareOpts(c),this.id=c.id,c.element.data("select2")!==b&&null!==c.element.data("select2")&&this.destroy(),this.enabled=!0,this.container=this.createContainer(),this.containerId="s2id_"+(c.element.attr("id")||"autogen"+B()),this.containerSelector="#"+this.containerId.replace(/([;&,\.\+\*\~':"\!\^#$%@\[\]\(\)=>\|])/g,"\\$1"),this.container.attr("id",this.containerId),this.body=j(function(){return c.element.closest("body")}),c.element.attr("class")!==b&&this.container.addClass(c.element.attr("class").replace(/validate\[[\S ]+] ?/,"")),this.container.css(t(c.containerCss)),this.container.addClass(t(c.containerCssClass)),this.opts.element.data("select2",this).hide().before(this.container),this.container.data("select2",this),this.dropdown=this.container.find(".select2-drop"),this.dropdown.addClass(t(c.dropdownCssClass)),this.dropdown.data("select2",this),this.results=d=this.container.find(i),this.search=e=this.container.find("input.select2-input"),this.free_text=f=this.container.find("input.select2-input-free"),e.attr("tabIndex",this.opts.element.attr("tabIndex")),this.resultsPage=0,this.context=null,this.initContainer(),this.initContainerWidth(),h(this.results),this.dropdown.delegate(i,"mousemove-filtered",this.bind(this.highlightUnderEvent)),k(80,this.results),this.dropdown.delegate(i,"scroll-debounced",this.bind(this.loadMoreIfNeeded)),a.fn.mousewheel&&d.mousewheel(function(a,b,c,e){var f=d.scrollTop();e>0&&0>=f-e?(d.scrollTop(0),l(a)):0>e&&d.get(0).scrollHeight-d.scrollTop()+e<=d.height()&&(d.scrollTop(d.get(0).scrollHeight-d.height()),l(a))}),g(e),e.bind("keyup-change",this.bind(this.updateResults)),e.bind("focus",function(){e.addClass("select2-focused")," "===e.val()&&e.val("")}),e.bind("blur",function(){e.removeClass("select2-focused")}),this.dropdown.delegate(i,"mouseup",this.bind(function(b){a(b.target).closest(".select2-result-selectable:not(.select2-disabled)").length>0?(this.highlightUnderEvent(b),this.selectHighlighted(b)):this.focusSearch(),l(b)})),this.dropdown.bind("click mouseup mousedown",function(a){a.stopPropagation()}),a.isFunction(this.opts.initSelection)&&(this.initSelection(),this.monitorSource()),(c.element.is(":disabled")||c.element.is("[readonly='readonly']"))&&this.disable(),a(this.container).hasClass("color_ramp"))try{for(var m=a(this.container).find(".select2-choice").text().replace(/ /g,""),n=a(this.container).attr("class").match(/(\d)_buckets/)[1],o="<ul>",p=cdb.admin.color_ramps[m][n],q=0,r=p.length;r>q;q++){var m=p[q];o+="<li style='background:"+m+";'></li>"}o+="</ul>",a(this.container).find(".select2-choice").append(o)}catch(s){cdb.log.info("Failing Select plugin when tries to generate a color ramp dropdown")}},destroy:function(){var a=this.opts.element.data("select2");a!==b&&(a.container.remove(),a.dropdown.remove(),a.opts.element.removeData("select2").unbind(".select2").show())},prepareOpts:function(c){var f,g,h,i;if(f=c.element,"select"===f.get(0).tagName.toLowerCase()&&(this.select=g=c.element),g&&a.each(["id","multiple","ajax","query","createSearchChoice","initSelection","data","tags"],function(){if(this in c)throw new Error("Option '"+this+"' is not allowed for Select2 when attached to a <select> element.")}),c=a.extend({},{populateResults:function(d,e,f){var g,h=this.opts.id,i=this;(g=function(d,e,j){var k,l,m,n,o,p,q,r,s,t;for(k=0,l=d.length;l>k;k+=1){if(m=d[k],n=a(m.element).is(":disabled"),o=!n&&h(m)!==b,p=m.children&&m.children.length>0,q=a("<li></li>"),q.addClass("select2-results-dept-"+j),q.addClass("select2-result"),q.addClass(o?"select2-result-selectable":"select2-result-unselectable"),p&&q.addClass("select2-result-with-children"),q.addClass(i.opts.formatResultCssClass(m)),r=a("<div></div>"),!o&&a(m.element).data("message")){var u=a(m.element).data("message");q.tipsy({fade:!0,gravity:"s",offset:-10,title:function(){return u}})}r.addClass("select2-result-label "+(v?m.text:"")),t=c.formatResult(m,r,f),t!==b&&r.html(i.opts.escapeMarkup(t)),q.append(r),p&&(s=a("<ul></ul>"),s.addClass("select2-result-sub"),g(m.children,s,j+1),q.append(s));var v=a(e.prevObject).hasClass("color_ramp");if(v)try{r.html("");for(var w=m.text,x=a(e.prevObject).attr("class").match(/(\d)_buckets/)[1],y="<table><tr>",z=cdb.admin.color_ramps[w][x],A=0,B=z.length;B>A;A++){var w=z[A];y+="<td class='color' style='background:"+w+";'></td>"}y+="</tr></table>",r.append(y)}catch(C){cdb.log.info("Failing Select plugin when tries to generate a color ramp dropdown")}q.data("select2-data",m),e.append(q)}})(e,d,0)}},a.fn.select2.defaults,c),"function"!=typeof c.id&&(h=c.id,c.id=function(a){return a[h]}),g?(c.query=this.bind(function(c){var d,e,g,h={results:[],more:!1},i=c.term;g=function(a,b){var d;a.is("option")?c.matcher(i,a.text(),a)&&b.push({id:a.attr("value"),text:a.text(),element:a.get(),css:a.attr("class")}):a.is("optgroup")&&(d={text:a.attr("label"),children:[],element:a.get(),css:a.attr("class")},a.children().each2(function(a,b){g(b,d.children)}),d.children.length>0&&b.push(d))},d=f.children(),this.getPlaceholder()!==b&&d.length>0&&(e=d[0],""===a(e).text()&&(d=d.not(e))),d.each2(function(a,b){g(b,h.results)}),c.callback(h)}),c.id=function(a){return a.id},c.formatResultCssClass=function(a){return a.css}):"query"in c||("ajax"in c?(i=c.element.data("ajax-url"),i&&i.length>0&&(c.ajax.url=i),c.query=p(c.ajax)):"data"in c?c.query=q(c.data):"tags"in c&&(c.query=r(c.tags),c.createSearchChoice===b&&(c.createSearchChoice=function(a){return{id:a,text:a}}),c.initSelection=function(b,f){var g=[];a(e(b.val(),c.separator)).each(function(){var b=this,e=this,f=c.tags;a.isFunction(f)&&(f=f()),a(f).each(function(){return d(this.id,b)?(e=this.text,!1):void 0}),g.push({id:b,text:e})}),f(g)})),"function"!=typeof c.query)throw"query function not defined for Select2 "+c.element.attr("id");return c},monitorSource:function(){this.opts.element.bind("change.select2",this.bind(function(a){this.opts.element.data("select2-change-triggered")!==!0&&this.initSelection()}))},triggerChange:function(b){b=b||{},b=a.extend({},b,{type:"change",val:this.val()}),this.opts.element.data("select2-change-triggered",!0),this.opts.element.trigger(b),this.opts.element.data("select2-change-triggered",!1),this.opts.element.click(),this.opts.blurOnChange&&this.opts.element.blur()},enable:function(){this.enabled||(this.enabled=!0,this.container.removeClass("select2-container-disabled"),this.opts.element.removeAttr("disabled"))},disable:function(){this.enabled&&(this.close(),this.enabled=!1,this.container.addClass("select2-container-disabled"),this.opts.element.attr("disabled","disabled"))},opened:function(){return this.container.hasClass("select2-dropdown-open")},positionDropdown:function(){var b,c,d,e=this.container.offset(),f=this.container.outerHeight(!1),g=this.container.outerWidth(!1),h=this.dropdown.outerHeight(!1),i=a(window).scrollLeft()+document.documentElement.clientWidth,j=a(window).scrollTop()+document.documentElement.clientHeight,k=e.top+f,l=e.left,m=j>=k+h,n=e.top-h>=this.body().scrollTop(),o=this.dropdown.outerWidth(!1),p=i>=l+o,q=this.dropdown.hasClass("select2-drop-above");"static"!==this.body().css("position")&&(b=this.body().offset(),k-=b.top,l-=b.left),q?(c=!0,!n&&m&&(c=!1)):(c=!1,!m&&n&&(c=!0)),p||(l=e.left+g-o),c?(k=e.top-h,this.container.addClass("select2-drop-above"),this.dropdown.addClass("select2-drop-above")):(this.container.removeClass("select2-drop-above"),this.dropdown.removeClass("select2-drop-above")),d=a.extend({top:k,left:l,width:g},t(this.opts.dropdownCss)),this.dropdown.css(d)},shouldOpen:function(){var b;return this.opened()?!1:(b=a.Event("open"),this.opts.element.trigger(b),!b.isDefaultPrevented())},clearDropdownAlignmentPreference:function(){this.container.removeClass("select2-drop-above"),this.dropdown.removeClass("select2-drop-above")},open:function(){return this.shouldOpen()?(window.setTimeout(this.bind(this.opening),1),!0):!1},opening:function(){var b=this.containerId,c=this.containerSelector,d="scroll."+b,e="resize."+b;this.container.parents().each(function(){a(this).bind(d,function(){var b=a(c);0==b.length&&a(this).unbind(d),b.select2("close")})}),window.setTimeout(function(){a(window).bind(e,function(){var b=a(c);0==b.length&&a(window).unbind(e),b.select2("close")}),a(window).bind(d,function(){var b=a(c);0==b.length&&a(window).unbind(d),b.select2("close")})},10),this.clearDropdownAlignmentPreference()," "===this.search.val()&&this.search.val(""),this.container.addClass("select2-dropdown-open").addClass("select2-container-active"),this.updateResults(!0),this.dropdown[0]!==this.body().children().last()[0]&&this.dropdown.detach().appendTo(this.body()),this.dropdown.show(),this.positionDropdown(),this.dropdown.addClass("select2-drop-active"),this.ensureHighlightVisible(),this.focusSearch()},close:function(){if(this.opened()){var b=this;this.container.parents().each(function(){a(this).unbind("scroll."+b.containerId)}),a(window).unbind("resize."+this.containerId),a(window).unbind("scroll."+this.containerId),this.clearDropdownAlignmentPreference(),this.dropdown.hide(),this.container.removeClass("select2-dropdown-open").removeClass("select2-container-active"),this.results.empty(),this.clearSearch(),this.opts.element.trigger(a.Event("close"))}},clearSearch:function(){},ensureHighlightVisible:function(){var b,c,d,e,f,g,h,i=this.results;if(c=this.highlight(),!(0>c)){if(0==c)return void i.scrollTop(0);b=i.find(".select2-result-selectable"),d=a(b[c]),e=d.offset().top+d.outerHeight(!0),c===b.length-1&&(h=i.find("li.select2-more-results"),h.length>0&&(e=h.offset().top+h.outerHeight(!0))),f=i.offset().top+i.outerHeight(!0),e>f&&i.scrollTop(i.scrollTop()+(e-f)),g=d.offset().top-i.offset().top,0>g&&"none"!=d.css("display")&&i.scrollTop(i.scrollTop()+g)}},moveHighlight:function(b){for(var c=this.results.find(".select2-result-selectable"),d=this.highlight();d>-1&&d<c.length;){d+=b;var e=a(c[d]);if(e.hasClass("select2-result-selectable")&&!e.hasClass("select2-disabled")){this.highlight(d);break}}},highlight:function(b){var d=this.results.find(".select2-result-selectable").not(".select2-disabled");return 0===arguments.length?c(d.filter(".select2-highlighted")[0],d.get()):(b>=d.length&&(b=d.length-1),0>b&&(b=0),d.removeClass("select2-highlighted"),a(d[b]).addClass("select2-highlighted"),void this.ensureHighlightVisible())},countSelectableResults:function(){return this.results.find(".select2-result-selectable").not(".select2-disabled").length},highlightUnderEvent:function(b){var c=a(b.target).closest(".select2-result-selectable");if(c.length>0&&!c.is(".select2-highlighted")){var d=this.results.find(".select2-result-selectable");this.highlight(d.index(c))}else 0==c.length&&this.results.find(".select2-highlighted").removeClass("select2-highlighted")},loadMoreIfNeeded:function(){var a,b=this.results,c=b.find("li.select2-more-results"),d=this.resultsPage+1,e=this,f=this.search.val(),g=this.context;0!==c.length&&(a=c.offset().top-b.offset().top-b.height(),0>=a&&(c.addClass("select2-active"),this.opts.query({term:f,page:d,context:g,matcher:this.opts.matcher,callback:this.bind(function(a){e.opened()&&(e.opts.populateResults.call(this,b,a.results,{term:f,page:d,context:g}),a.more===!0?(c.detach().appendTo(b).text(e.opts.formatLoadMore(d+1)),window.setTimeout(function(){e.loadMoreIfNeeded()},10)):c.remove(),e.positionDropdown(),e.resultsPage=d)})})))},tokenize:function(){},updateResults:function(c){function e(){k.find(".select2-result").each(function(b,c){var d=a(c),e=d.data("tipsy");e&&d.tipsy("hide").unbind("mouseleave mouseenter")})}function f(){k.scrollTop(0),j.removeClass("select2-active"),m.positionDropdown()}function g(a){k.html(m.opts.escapeMarkup(a)),f()}var h,i,j=this.search,k=this.results,l=this.opts,m=this;if(c===!0||this.showSearchInput!==!1&&this.opened()){if(j.addClass("select2-active"),e(),l.maximumSelectionSize>=1&&(h=this.data(),a.isArray(h)&&h.length>=l.maximumSelectionSize&&s(l.formatSelectionTooBig,"formatSelectionTooBig")))return void g("<li class='select2-selection-limit'>"+l.formatSelectionTooBig(l.maximumSelectionSize)+"</li>");if(j.val().length<l.minimumInputLength)return void g(s(l.formatInputTooShort,"formatInputTooShort")?"<li class='select2-no-results'>"+l.formatInputTooShort(j.val(),l.minimumInputLength)+"</li>":"");l.formatSearching()&&g("<li class='select2-searching'>"+l.formatSearching()+"</li>"),i=this.tokenize(),i!=b&&null!=i&&j.val(i),this.resultsPage=1,l.query({term:j.val(),page:this.resultsPage,context:null,matcher:l.matcher,callback:this.bind(function(e){var h;if(this.opened()){if(this.context=e.context===b?null:e.context,this.opts.createSearchChoice&&""!==j.val()&&(h=this.opts.createSearchChoice.call(null,j.val(),e.results),h!==b&&null!==h&&m.id(h)!==b&&null!==m.id(h)&&0===a(e.results).filter(function(){return d(m.id(this),m.id(h))}).length&&e.results.unshift(h)),0===e.results.length&&s(l.formatNoMatches,"formatNoMatches"))return void g("<li class='select2-no-results'>"+l.formatNoMatches(j.val())+"</li>");k.empty(),m.opts.populateResults.call(this,k,e.results,{term:j.val(),page:this.resultsPage,context:null}),e.more===!0&&s(l.formatLoadMore,"formatLoadMore")&&(k.append("<li class='select2-more-results'>"+m.opts.escapeMarkup(l.formatLoadMore(this.resultsPage))+"</li>"),window.setTimeout(function(){m.loadMoreIfNeeded()},10)),this.postprocessResults(e,c),f()}})})}},cancel:function(){this.close()},blur:function(){this.close(),this.container.removeClass("select2-container-active"),this.dropdown.removeClass("select2-drop-active"),this.search[0]===document.activeElement&&this.search.blur(),this.clearSearch(),this.selection.find(".select2-search-choice-focus").removeClass("select2-search-choice-focus"),this.opts.element.triggerHandler("blur")},focusSearch:function(){this.showSearchInput&&(this.search.show(),this.search.focus(),window.setTimeout(this.bind(function(){this.search.show(),this.search.focus(),this.search.val(this.search.val())}),10))},selectHighlighted:function(){var a=this.highlight(),b=this.results.find(".select2-highlighted").not(".select2-disabled"),c=b.closest(".select2-result-selectable").data("select2-data");c&&(b.addClass("select2-disabled"),this.highlight(a),this.onSelect(c))},getPlaceholder:function(){return this.opts.element.attr("placeholder")||this.opts.element.attr("data-placeholder")||this.opts.element.data("placeholder")||this.opts.placeholder},initContainerWidth:function(){function c(){var c,d,e,f,g;if("off"===this.opts.width)return null;if("element"===this.opts.width)return 0===this.opts.element.outerWidth(!1)?"auto":this.opts.element.outerWidth(!1)+"px";if("copy"===this.opts.width||"resolve"===this.opts.width){if(c=this.opts.element.attr("style"),c!==b)for(d=c.split(";"),f=0,g=d.length;g>f;f+=1)if(e=d[f].replace(/\s/g,"").match(/width:(([-+]?([0-9]*\.)?[0-9]+)(px|em|ex|%|in|cm|mm|pt|pc))/),null!==e&&e.length>=1)return e[1];return"resolve"===this.opts.width?(c=this.opts.element.css("width"),c.indexOf("%")>0?c:0===this.opts.element.outerWidth(!1)?"auto":this.opts.element.outerWidth(!1)+"px"):null}return a.isFunction(this.opts.width)?this.opts.width():this.opts.width}var d=c.call(this);null!==d&&this.container.attr("style","width: "+d)}}),z=w(y,{createContainer:function(){var b=a("<div></div>",{"class":"select2-container"}).html(["    <a href='javascript:void(0)' onclick='return false;' class='select2-choice'>","   <span></span><abbr class='select2-search-choice-close' style='display:none;'></abbr>","   <div><b></b></div>","</a>","    <div class='select2-drop select2-offscreen'>","   <div class='select2-search'>","       <input type='text' autocomplete='off' class='select2-input'/>","   </div>","   <ul class='select2-results'>","   </ul>","   <div class='select2-text'>","       <input type='text' placeholder='Free text input' class='select2-input-free'/>","       <i class='select2-icon select2-text-icon'></i>","   </div>","</div>"].join(""));return b},opening:function(){this.search.show(),this.parent.opening.apply(this,arguments),this.dropdown.removeClass("select2-offscreen")},close:function(){this.opened()&&(this.parent.close.apply(this,arguments),this.dropdown.removeAttr("style").addClass("select2-offscreen").insertAfter(this.selection).show())},focus:function(){this.close(),this.selection.focus()},isFocused:function(){return this.selection[0]===document.activeElement},cancel:function(){this.parent.cancel.apply(this,arguments),this.selection.focus()},initContainer:function(){var b,c=this.container,d=this.dropdown,e=!1;this.selection=b=c.find(".select2-choice"),this.search.bind("keydown",this.bind(function(a){if(this.enabled){if(a.which===x.PAGE_UP||a.which===x.PAGE_DOWN)return void l(a);if(this.opened())switch(a.which){case x.UP:case x.DOWN:return this.moveHighlight(a.which===x.UP?-1:1),void l(a);case x.TAB:case x.ENTER:return this.selectHighlighted(),void l(a);case x.ESC:return this.cancel(a),void l(a)}else{if(a.which===x.TAB||x.isControl(a)||x.isFunctionKey(a)||a.which===x.ESC)return;if(this.opts.openOnEnter===!1&&a.which===x.ENTER)return;if(this.open(),a.which===x.ENTER)return}}})),this.search.bind("focus",this.bind(function(){this.selection.attr("tabIndex","-1")})),this.search.bind("blur",this.bind(function(){this.opened()||this.container.removeClass("select2-container-active"),window.setTimeout(this.bind(function(){var a=this.opts.element.attr("tabIndex");a?this.selection.attr("tabIndex",a):this.selection.removeAttr("tabIndex")}),10)})),this.free_text.bind("keydown",this.bind(function(b){var c=a(b.target).val();if(this.enabled){if(b.which===x.PAGE_UP||b.which===x.PAGE_DOWN)return void l(b);if(this.opened())switch(b.which){case x.UP:case x.DOWN:return void l(b);case x.TAB:return;case x.ENTER:return this.onSelect({id:c,text:c}),void l(b);case x.ESC:return this.cancel(b),void l(b)}}})),b.delegate("abbr","mousedown",this.bind(function(a){this.enabled&&(this.clear(),m(a),this.close(),this.triggerChange(),this.selection.focus())})),b.bind("mousedown",this.bind(function(a){e=!0,this.opened()?(this.close(),this.selection.focus()):this.enabled&&this.open(),e=!1})),d.bind("mousedown",this.bind(function(){})),b.bind("focus",this.bind(function(){this.container.addClass("select2-container-active"),this.search.attr("tabIndex","-1")})),b.bind("blur",this.bind(function(){this.opened()||this.container.removeClass("select2-container-active"),window.setTimeout(this.bind(function(){this.search.attr("tabIndex",this.opts.element.attr("tabIndex"))}),10)})),b.bind("keydown",this.bind(function(a){return this.enabled?a.which==x.DOWN||a.which==x.UP||a.which==x.ENTER&&this.opts.openOnEnter?(this.open(),void l(a)):a.which==x.DELETE||a.which==x.BACKSPACE?(this.opts.allowClear&&this.clear(),void l(a)):void 0:void 0})),b.bind("keypress",this.bind(function(a){var b=String.fromCharCode(a.which);this.search.val(b),this.open()})),this.setPlaceholder(),this.search.bind("focus",this.bind(function(){this.container.addClass("select2-container-active")}))},clear:function(){this.opts.element.val(""),this.selection.find("span").empty(),this.selection.removeData("select2-data"),this.setPlaceholder()},initSelection:function(){if(""===this.opts.element.val()&&""===this.opts.element.text())this.close(),this.setPlaceholder();else{var a=this;this.opts.initSelection.call(null,this.opts.element,function(c){c!==b&&null!==c&&(a.updateSelection(c),a.close(),a.setPlaceholder())})}},prepareOpts:function(){var b=this.parent.prepareOpts.apply(this,arguments);return"select"===b.element.get(0).tagName.toLowerCase()&&(b.initSelection=function(b,c){var d=b.find(":selected");a.isFunction(c)&&c({id:d.attr("value"),text:d.text(),element:d})}),b},setPlaceholder:function(){var a=this.getPlaceholder(),c=this.selection.data("select2-data");if(""===this.opts.element.val()&&a!==b&&c&&!c.id&&!c.text){if(this.select&&""!==this.select.find("option:first").text())return;this.selection.find("span").html(this.opts.escapeMarkup(a)),this.selection.addClass("select2-default"),this.selection.find("abbr").hide()}},postprocessResults:function(b,c){var e=0,f=this,g=!0,h=!1;this.results.find(".select2-result-selectable").each2(function(a,b){return d(f.id(b.data("select2-data")),f.opts.element.val())?(e=a,!1):void 0}),this.highlight(e),c===!0&&(g=this.showSearchInput=u(b.results)>=this.opts.minimumResultsForSearch,this.dropdown.find(".select2-search")[g?"removeClass":"addClass"]("select2-search-hidden"),h=this.showFreeTextInput=this.opts.freeText,this.dropdown.find(".select2-text")[h?"removeClass":"addClass"]("select2-search-hidden"),a(this.dropdown,this.container)[g?"addClass":"removeClass"]("select2-with-searchbox"))},onSelect:function(a){var b=this.opts.element.val();this.opts.element.val(this.id(a)),this.updateSelection(a),this.close(),this.selection.focus(),d(b,this.id(a))||this.triggerChange()},updateSelection:function(a){var c,d=this.selection.find("span");this.selection.data("select2-data",a),d.empty(),c=this.opts.formatSelection(a,d),c!==b&&d.append(this.opts.escapeMarkup(c)),this.selection.removeClass("select2-default"),this.opts.allowClear&&this.getPlaceholder()!==b&&this.selection.find("abbr").show()},val:function(){var a,c=null,d=this;if(0===arguments.length)return this.opts.element.val();if(a=arguments[0],this.select)this.select.val(a).find(":selected").each2(function(a,b){
return c={id:b.attr("value"),text:b.text()},!1}),c.id||c.text||(c={id:a,text:a}),this.updateSelection(c),this.setPlaceholder();else{if(this.opts.initSelection===b)throw new Error("cannot call val() if initSelection() is not defined");if(!a)return void this.clear();this.opts.element.val(a),this.opts.initSelection(this.opts.element,function(a){d.opts.element.val(a?d.id(a):""),d.updateSelection(a),d.setPlaceholder()})}},clearSearch:function(){this.search.val("")},data:function(a){var c;return 0===arguments.length?(c=this.selection.data("select2-data"),c==b&&(c=null),c):void(a&&""!==a?(this.opts.element.val(a?this.id(a):""),this.updateSelection(a)):this.clear())}}),A=w(y,{createContainer:function(){var b=a("<div></div>",{"class":"select2-container select2-container-multi"}).html(["    <ul class='select2-choices'>","  <li class='select2-search-field'>","    <input type='text' autocomplete='off' class='select2-input'>","  </li>","</ul>","<div class='select2-drop select2-drop-multi' style='display:none;'>","   <ul class='select2-results'>","   </ul>","</div>"].join(""));return b},prepareOpts:function(){var b=this.parent.prepareOpts.apply(this,arguments);return"select"===b.element.get(0).tagName.toLowerCase()&&(b.initSelection=function(b,c){var d=[];b.find(":selected").each2(function(a,b){d.push({id:b.attr("value"),text:b.text(),element:b})}),a.isFunction(c)&&c(d)}),b},initContainer:function(){var b,c=".select2-choices";this.searchContainer=this.container.find(".select2-search-field"),this.selection=b=this.container.find(c),this.search.bind("keydown",this.bind(function(a){if(this.enabled){if(a.which===x.BACKSPACE&&""===this.search.val()){this.close();var c,d=b.find(".select2-search-choice-focus");if(d.length>0)return this.unselect(d.first()),this.search.width(10),void l(a);c=b.find(".select2-search-choice:not(.select2-locked)"),c.length>0&&c.last().addClass("select2-search-choice-focus")}else b.find(".select2-search-choice-focus").removeClass("select2-search-choice-focus");if(this.opened())switch(a.which){case x.UP:case x.DOWN:return this.moveHighlight(a.which===x.UP?-1:1),void l(a);case x.ENTER:case x.TAB:return this.selectHighlighted(),void l(a);case x.ESC:return this.cancel(a),void l(a)}a.which===x.TAB||x.isControl(a)||x.isFunctionKey(a)||a.which===x.BACKSPACE||a.which===x.ESC||(this.opts.openOnEnter!==!1||a.which!==x.ENTER)&&(this.open(),(a.which===x.PAGE_UP||a.which===x.PAGE_DOWN)&&l(a))}})),this.search.bind("keyup",this.bind(this.resizeSearch)),this.search.bind("blur",this.bind(function(a){this.container.removeClass("select2-container-active"),this.search.removeClass("select2-focused"),this.clearSearch(),a.stopImmediatePropagation()})),this.container.delegate(c,"mousedown",this.bind(function(b){this.enabled&&(a(b.target).closest(".select2-search-choice").length>0||(this.clearPlaceholder(),this.open(),this.focusSearch(),b.preventDefault()))})),this.container.delegate(c,"focus",this.bind(function(){this.enabled&&(this.container.addClass("select2-container-active"),this.dropdown.addClass("select2-drop-active"),this.clearPlaceholder())})),this.clearSearch()},enable:function(){this.enabled||(this.parent.enable.apply(this,arguments),this.search.removeAttr("disabled"))},disable:function(){this.enabled&&(this.parent.disable.apply(this,arguments),this.search.attr("disabled",!0))},initSelection:function(){if(""===this.opts.element.val()&&""===this.opts.element.text()&&(this.updateSelection([]),this.close(),this.clearSearch()),this.select||""!==this.opts.element.val()){var a=this;this.opts.initSelection.call(null,this.opts.element,function(c){c!==b&&null!==c&&(a.updateSelection(c),a.close(),a.clearSearch())})}},clearSearch:function(){var a=this.getPlaceholder();a!==b&&0===this.getVal().length&&this.search.hasClass("select2-focused")===!1?(this.search.val(a).addClass("select2-default"),this.resizeSearch()):this.search.val(" ").width(10)},clearPlaceholder:function(){this.search.hasClass("select2-default")?this.search.val("").removeClass("select2-default"):" "===this.search.val()&&this.search.val("")},opening:function(){this.parent.opening.apply(this,arguments),this.clearPlaceholder(),this.resizeSearch(),this.focusSearch()},close:function(){this.opened()&&this.parent.close.apply(this,arguments)},focus:function(){this.close(),this.search.focus()},isFocused:function(){return this.search.hasClass("select2-focused")},updateSelection:function(b){var d=[],e=[],f=this;a(b).each(function(){c(f.id(this),d)<0&&(d.push(f.id(this)),e.push(this))}),b=e,this.selection.find(".select2-search-choice").remove(),a(b).each(function(){f.addSelectedChoice(this)}),f.postprocessResults()},tokenize:function(){var a=this.search.val();a=this.opts.tokenizer(a,this.data(),this.bind(this.onSelect),this.opts),null!=a&&a!=b&&(this.search.val(a),a.length>0&&this.open())},onSelect:function(a){this.addSelectedChoice(a),(this.select||!this.opts.closeOnSelect)&&this.postprocessResults(),this.opts.closeOnSelect?(this.close(),this.search.width(10)):this.countSelectableResults()>0?(this.search.width(10),this.resizeSearch(),this.positionDropdown()):this.close(),this.triggerChange({added:a}),this.focusSearch()},cancel:function(){this.close(),this.focusSearch()},addSelectedChoice:function(c){var d,e=!c.locked,f=a("<li class='select2-search-choice'>    <div></div>    <a href='#' onclick='return false;' class='select2-search-choice-close' tabindex='-1'></a></li>"),g=a("<li class='select2-search-choice select2-locked'><div></div></li>"),h=e?f:g,i=this.id(c),j=this.getVal();d=this.opts.formatSelection(c,h.find("div")),d!=b&&h.find("div").replaceWith("<div>"+this.opts.escapeMarkup(d)+"</div>"),e&&h.find(".select2-search-choice-close").bind("mousedown",l).bind("click dblclick",this.bind(function(b){this.enabled&&(a(b.target).closest(".select2-search-choice").fadeOut("fast",this.bind(function(){this.unselect(a(b.target)),this.selection.find(".select2-search-choice-focus").removeClass("select2-search-choice-focus"),this.close(),this.focusSearch()})).dequeue(),l(b))})).bind("focus",this.bind(function(){this.enabled&&(this.container.addClass("select2-container-active"),this.dropdown.addClass("select2-drop-active"))})),h.data("select2-data",c),h.insertBefore(this.searchContainer),j.push(i),this.setVal(j)},unselect:function(a){var b,d,e=this.getVal();if(a=a.closest(".select2-search-choice"),0===a.length)throw"Invalid argument: "+a+". Must be .select2-search-choice";b=a.data("select2-data"),d=c(this.id(b),e),d>=0&&(e.splice(d,1),this.setVal(e),this.select&&this.postprocessResults()),a.remove(),this.triggerChange({removed:b})},postprocessResults:function(){var a=this.getVal(),b=this.results.find(".select2-result-selectable"),d=this.results.find(".select2-result-with-children"),e=this;b.each2(function(b,d){var f=e.id(d.data("select2-data"));c(f,a)>=0?d.addClass("select2-disabled").removeClass("select2-result-selectable"):d.removeClass("select2-disabled").addClass("select2-result-selectable")}),d.each2(function(a,b){b.is(".select2-result-selectable")||0!=b.find(".select2-result-selectable").length?b.removeClass("select2-disabled"):b.addClass("select2-disabled")}),-1==this.highlight()&&b.each2(function(a,b){return!b.hasClass("select2-disabled")&&b.hasClass("select2-result-selectable")?(e.highlight(0),!1):void 0})},resizeSearch:function(){var a,b,c,d,e,g=f(this.search);a=n(this.search)+10,b=this.search.offset().left,c=this.selection.width(),d=this.selection.offset().left,e=c-(b-d)-g,a>e&&(e=c-g),40>e&&(e=c-g),this.search.width(e)},getVal:function(){var a;return this.select?(a=this.select.val(),null===a?[]:a):(a=this.opts.element.val(),e(a,this.opts.separator))},setVal:function(b){var d;this.select?this.select.val(b):(d=[],a(b).each(function(){c(this,d)<0&&d.push(this)}),this.opts.element.val(0===d.length?"":d.join(this.opts.separator)))},val:function(){var c,d=[],e=this;if(0===arguments.length)return this.getVal();if(c=arguments[0],!c)return this.opts.element.val(""),this.updateSelection([]),void this.clearSearch();if(this.setVal(c),this.select)this.select.find(":selected").each(function(){d.push({id:a(this).attr("value"),text:a(this).text()})}),this.updateSelection(d);else{if(this.opts.initSelection===b)throw new Error("val() cannot be called if initSelection() is not defined");this.opts.initSelection(this.opts.element,function(b){var c=a(b).map(e.id);e.setVal(c),e.updateSelection(b),e.clearSearch()})}this.clearSearch()},onSortStart:function(){if(this.select)throw new Error("Sorting of elements is not supported when attached to <select>. Attach to <input type='hidden'/> instead.");this.search.width(0),this.searchContainer.hide()},onSortEnd:function(){var b=[],c=this;this.searchContainer.show(),this.searchContainer.appendTo(this.searchContainer.parent()),this.resizeSearch(),this.selection.find(".select2-search-choice").each(function(){b.push(c.opts.id(a(this).data("select2-data")))}),this.setVal(b),this.triggerChange()},data:function(b){var c,d=this;return 0===arguments.length?this.selection.find(".select2-search-choice").map(function(){return a(this).data("select2-data")}).get():(b||(b=[]),c=a.map(b,function(a){return d.opts.id(a)}),this.setVal(c),this.updateSelection(b),this.clearSearch(),void 0)}}),a.fn.select2=function(){var d,e,f,g,h=Array.prototype.slice.call(arguments,0),i=["val","destroy","opened","open","close","focus","isFocused","container","onSortStart","onSortEnd","enable","disable","positionDropdown","data"];return this.each(function(){if(0===h.length||"object"==typeof h[0])d=0===h.length?{}:a.extend({},h[0]),d.element=a(this),"select"===d.element.get(0).tagName.toLowerCase()?g=d.element.attr("multiple"):(g=d.multiple||!1,"tags"in d&&(d.multiple=g=!0)),e=g?new A:new z,e.init(d);else{if("string"!=typeof h[0])throw"Invalid arguments to select2 plugin: "+h;if(c(h[0],i)<0)throw"Unknown method: "+h[0];if(f=b,e=a(this).data("select2"),e===b)return;if(f="container"===h[0]?e.container:e[h[0]].apply(e,h.slice(1)),f!==b)return!1}}),f===b?this:f},a.fn.select2.defaults={width:"copy",closeOnSelect:!0,openOnEnter:!0,containerCss:{},dropdownCss:{},containerCssClass:"",dropdownCssClass:"",formatResult:function(a,b,c){var d=[];return o(a.text,c.term,d),d.join("")},formatSelection:function(a,c){return a?a.text:b},formatResultCssClass:function(a){return b},formatNoMatches:function(){return"No matches found"},formatInputTooShort:function(a,b){var c=b-a.length;return"Please enter "+c+" more character"+(1==c?"":"s")},formatSelectionTooBig:function(a){return"You can only select "+a+" item"+(1==a?"":"s")},formatLoadMore:function(a){return"Loading more results..."},formatSearching:function(){return"Searching..."},minimumResultsForSearch:0,minimumInputLength:0,maximumSelectionSize:0,id:function(a){return a.id},matcher:function(a,b){return b.toUpperCase().indexOf(a.toUpperCase())>=0},separator:",",tokenSeparators:[],tokenizer:v,escapeMarkup:function(a){return a&&"string"==typeof a?a.replace(/&/g,"&amp;"):a},blurOnChange:!1},window.Select2={query:{ajax:p,local:q,tags:r},util:{debounce:i,markMatch:o},"class":{"abstract":y,single:z,multi:A}}}}(jQuery),function(a){var b,c="#000000",d="#FFFFFF",e="br",f=[["  ---  "," -@@@- ","-@---@-","-@- -@-","-@- -@-","-@- -@-","-@---@-"," -@@@- ","  ---  "],["  -  "," -@- ","-@@- "," -@- "," -@- "," -@- "," -@- ","-@@@-"," --- "],["  ---  "," -@@@- ","-@---@-"," - --@-","  -@@- "," -@--  ","-@---- ","-@@@@@-"," ----- "],["  ---  "," -@@@- ","-@---@-"," - --@-","  -@@- "," - --@-","-@---@-"," -@@@- ","  ---  "],["    -- ","   -@@-","  -@-@-"," -@--@-","-@---@-","-@@@@@-"," ----@-","    -@-","     - "],[" ----- ","-@@@@@-","-@---- ","-@---  ","-@@@@- "," ----@-","-@---@-"," -@@@- ","  ---  "],["  ---  "," -@@@- ","-@---@-","-@---- ","-@@@@- ","-@---@-","-@---@-"," -@@@- ","  ---  "],[" ----- ","-@@@@@-"," ----@-","   -@- ","   -@- ","  -@-  ","  -@-  ","  -@-  ","   -   "],["  ---  "," -@@@- ","-@---@-","-@---@-"," -@@@- ","-@---@-","-@---@-"," -@@@- ","  ---  "],["  ---  "," -@@@- ","-@---@-","-@---@-"," -@@@@-"," ----@-","-@---@-"," -@@@- ","  ---  "],[" - ","-@-","-@-","-@-","-@-","-@-"," - ","-@-"," - "]];a.faviconNotify=function(g,h,i,j,k){if(i=i||e,k=k||d,j=j||c,b=b||a("<canvas />")[0],b.getContext){var l=a("<img />")[0];l.onload=function(){b.height=b.width=16;var c=b.getContext("2d");if(c.drawImage(this,0,0),void 0!=h){if(h>99)var d=[f[9],f[9],f[10]];else{var d=[];h=h.toString(),a.each(h,function(a,b){d.push(f[b])})}var e=[],g=d[0].length;a.each(d,function(a,b){for(n=0;g>n;n++)if(void 0==e[n])e[n]=b[n];else{var c=e[n].length;" "==e[n][c-1]?e[n]=e[n].substring(0,c-1)+b[n]:e[n]+=b[n].substring(1)}});var l=e[0].length,m=-1!=i.indexOf("l")?0:16-l,n=-1!=i.indexOf("t")?0:16-g;for(dX=0;dX<l;dX++)for(dY=0;dY<g;dY++){var o=e[dY][dX];" "!=o&&(c.fillStyle="@"==o?k:j,c.fillRect(m+dX,n+dY,1,1))}}a("link[rel$=icon]").replaceWith(""),a("head").append(a('<link rel="shortcut icon" type="image/x-icon"/>').attr("href",b.toDataURL("image/png")))},l.src=g}}}(jQuery),function(a){function b(a){return a}function c(a,b){for(var c=0,d=b.length,e=new Array(d);d>c;++c)e[c]=a[b[c]];return e}function d(a){function b(b,c,d,e){for(;e>d;){var f=d+e>>>1;a(b[f])<c?d=f+1:e=f}return d}function c(b,c,d,e){for(;e>d;){var f=d+e>>>1;c<a(b[f])?e=f:d=f+1}return d}return c.right=c,c.left=b,c}function e(a){function b(a,b,c){for(var e=c-b,f=(e>>>1)+1;--f>0;)d(a,f,e,b);return a}function c(a,b,c){for(var e,f=c-b;--f>0;)e=a[b],a[b]=a[b+f],a[b+f]=e,d(a,1,f,b);return a}function d(b,c,d,e){for(var f,g=b[--e+c],h=a(g);(f=c<<1)<=d&&(d>f&&a(b[e+f])>a(b[e+f+1])&&f++,!(h<=a(b[e+f])));)b[e+c]=b[e+f],c=f;b[e+c]=g}return b.sort=c,b}function f(a){function b(b,d,e,f){var g,h,i,j,k=new Array(f=Math.min(e-d,f));for(h=0;f>h;++h)k[h]=b[d++];if(c(k,0,f),e>d){g=a(k[0]);do(i=a(j=b[d])>g)&&(k[0]=j,g=a(c(k,0,f)[0]));while(++d<e)}return k}var c=e(a);return b}function g(a){function b(b,c,d){for(var e=c+1;d>e;++e){for(var f=e,g=b[e],h=a(g);f>c&&a(b[f-1])>h;--f)b[f]=b[f-1];b[f]=g}return b}return b}function h(a){function b(a,b,e){return(D>e-b?d:c)(a,b,e)}function c(c,d,e){var f,g=(e-d)/6|0,h=d+g,i=e-1-g,j=d+e-1>>1,k=j-g,l=j+g,m=c[h],n=a(m),o=c[k],p=a(o),q=c[j],r=a(q),s=c[l],t=a(s),u=c[i],v=a(u);n>p&&(f=m,m=o,o=f,f=n,n=p,p=f),t>v&&(f=s,s=u,u=f,f=t,t=v,v=f),n>r&&(f=m,m=q,q=f,f=n,n=r,r=f),p>r&&(f=o,o=q,q=f,f=p,p=r,r=f),n>t&&(f=m,m=s,s=f,f=n,n=t,t=f),r>t&&(f=q,q=s,s=f,f=r,r=t,t=f),p>v&&(f=o,o=u,u=f,f=p,p=v,v=f),p>r&&(f=o,o=q,q=f,f=p,p=r,r=f),t>v&&(f=s,s=u,u=f,f=t,t=v,v=f);var w=o,x=p,y=s,z=t;c[h]=m,c[k]=c[d],c[j]=q,c[l]=c[e-1],c[i]=u;var A=d+1,B=e-2,C=z>=x&&x>=z;if(C)for(var D=A;B>=D;++D){var E=c[D],F=a(E);if(x>F)D!==A&&(c[D]=c[A],c[A]=E),++A;else if(F>x)for(;;){var G=a(c[B]);{if(!(G>x)){if(x>G){c[D]=c[A],c[A++]=c[B],c[B--]=E;break}c[D]=c[B],c[B--]=E;break}B--}}}else for(var D=A;B>=D;D++){var E=c[D],F=a(E);if(x>F)D!==A&&(c[D]=c[A],c[A]=E),++A;else if(F>z)for(;;){var G=a(c[B]);{if(!(G>z)){x>G?(c[D]=c[A],c[A++]=c[B],c[B--]=E):(c[D]=c[B],c[B--]=E);break}if(B--,D>B)break}}}if(c[d]=c[A-1],c[A-1]=w,c[e-1]=c[B+1],c[B+1]=y,b(c,d,A-1),b(c,B+2,e),C)return c;if(h>A&&B>i){for(var H,G;(H=a(c[A]))<=x&&H>=x;)++A;for(;(G=a(c[B]))<=z&&G>=z;)--B;for(var D=A;B>=D;D++){var E=c[D],F=a(E);if(x>=F&&F>=x)D!==A&&(c[D]=c[A],c[A]=E),A++;else if(z>=F&&F>=z)for(;;){var G=a(c[B]);{if(!(z>=G&&G>=z)){x>G?(c[D]=c[A],c[A++]=c[B],c[B--]=E):(c[D]=c[B],c[B--]=E);break}if(B--,D>B)break}}}}return b(c,A,B+1)}var d=g(a);return b}function i(a){for(var b=new Array(a),c=-1;++c<a;)b[c]=0;return b}function j(a,b){for(var c=a.length;b>c;)a[c++]=0;return a}function k(a,b){if(b>32)throw new Error("invalid array width!");return a}function l(a,b){return function(c){var d=c.length;return[a.left(c,b,0,d),a.right(c,b,0,d)]}}function m(a,b){var c=b[0],d=b[1];return function(b){var e=b.length;return[a.left(b,c,0,e),a.left(b,d,0,e)]}}function n(a){return[0,a.length]}function o(){return null}function p(){return 0}function q(a){return a+1}function r(a){return a-1}function s(a){return function(b,c){return b+ +a(c)}}function t(a){return function(b,c){return b-a(c)}}function u(){function a(a){var b=z,c=a.length;return c&&(u=u.concat(a),C=H(C,z+=c),F.forEach(function(d){d(a,b,c)})),k}function d(){for(var a=v(z,z),b=[],c=0,d=0;z>c;++c)C[c]?a[c]=d++:b.push(c);D.forEach(function(a){a(0,[],b)}),G.forEach(function(b){b(a)});for(var e,c=0,d=0;z>c;++c)(e=C[c])&&(c!==d&&(C[d]=e,u[d]=u[c]),++d);for(u.length=d;z>d;)C[--z]=0}function g(a){function d(b,d,e){U=b.map(a),V=$(w(e),0,e),U=c(U,V);var f,g=_(U),h=g[0],i=g[1];if(W)for(f=0;e>f;++f)W(U[f],f)||(C[V[f]+d]|=Y);else{for(f=0;h>f;++f)C[V[f]+d]|=Y;for(f=i;e>f;++f)C[V[f]+d]|=Y}if(!d)return S=U,T=V,ca=h,void(da=i);var j=S,k=T,l=0,m=0;for(S=new Array(z),T=v(z,z),f=0;d>l&&e>m;++f)j[l]<U[m]?(S[f]=j[l],T[f]=k[l++]):(S[f]=U[m],T[f]=V[m++]+d);for(;d>l;++l,++f)S[f]=j[l],T[f]=k[l];for(;e>m;++m,++f)S[f]=U[m],T[f]=V[m]+d;g=_(S),ca=g[0],da=g[1]}function g(a,b,c){aa.forEach(function(a){a(U,V,b,c)}),U=V=null}function i(a){for(var b,c=0,d=0;z>c;++c)C[b=T[c]]&&(c!==d&&(S[d]=S[c]),T[d]=a[b],++d);for(S.length=d;z>d;)T[d++]=0;var e=_(S);ca=e[0],da=e[1]}function j(a){var b=a[0],c=a[1];if(W)return W=null,M(function(a,d){return d>=b&&c>d}),ca=b,da=c,X;var d,e,f,g=[],h=[];if(ca>b)for(d=b,e=Math.min(ca,c);e>d;++d)C[f=T[d]]^=Y,g.push(f);else if(b>ca)for(d=ca,e=Math.min(b,da);e>d;++d)C[f=T[d]]^=Y,h.push(f);if(c>da)for(d=Math.max(b,da),e=c;e>d;++d)C[f=T[d]]^=Y,g.push(f);else if(da>c)for(d=Math.max(ca,c),e=da;e>d;++d)C[f=T[d]]^=Y,h.push(f);return ca=b,da=c,D.forEach(function(a){a(Y,g,h)}),X}function k(a){return null==a?K():Array.isArray(a)?J(a):"function"==typeof a?L(a):E(a)}function E(a){return j((_=l(y,a))(S))}function J(a){return j((_=m(y,a))(S))}function K(){return j((_=n)(S))}function L(a){return _=n,M(W=a),ca=0,da=z,X}function M(a){var b,c,d,e=[],f=[];for(b=0;z>b;++b)!(C[c=T[b]]&Y)^!!(d=a(S[b],b))&&(d?(C[c]&=Z,e.push(c)):(C[c]|=Y,f.push(c)));D.forEach(function(a){a(Y,e,f)})}function N(a){for(var b,c=[],d=da;--d>=ca&&a>0;)C[b=T[d]]||(c.push(u[b]),--a);return c}function O(a){for(var b,c=[],d=ca;da>d&&a>0;)C[b=T[d]]||(c.push(u[b]),--a),d++;return c}function P(a){function c(b,c,d,e){function f(){++U===R&&(s=I(s,Q<<=1),K=I(K,Q),R=x(Q))}var k,l,m,n,p,q,r=J,s=v(U,R),t=N,w=P,y=U,A=0,B=0;for(X&&(t=w=o),J=new Array(U),U=0,K=y>1?H(K,z):v(z,R),y&&(m=(l=r[0]).key);e>B&&!((n=a(b[B]))>=n);)++B;for(;e>B;){for(l&&n>=m?(p=l,q=m,s[A]=U,(l=r[++A])&&(m=l.key)):(p={key:n,value:w()},q=n),J[U]=p;!(n>q||(K[k=c[B]+d]=U,C[k]&Z||(p.value=t(p.value,u[k])),++B>=e));)n=a(b[B]);f()}for(;y>A;)J[s[A]=U]=r[A++],f();if(U>A)for(A=0;d>A;++A)K[A]=s[K[A]];k=D.indexOf(V),U>1?(V=g,W=i):(!U&&$&&(U=1,J=[{key:null,value:w()}]),1===U?(V=h,W=j):(V=o,W=o),K=null),D[k]=V}function d(){if(U>1){for(var a=U,b=J,c=v(a,a),d=0,e=0;z>d;++d)C[d]&&(c[K[e]=K[d]]=1,++e);for(J=[],U=0,d=0;a>d;++d)c[d]&&(c[d]=U++,J.push(b[d]));if(U>1)for(var d=0;e>d;++d)K[d]=c[K[d]];else K=null;D[D.indexOf(V)]=U>1?(W=i,V=g):1===U?(W=j,V=h):W=V=o}else if(1===U){if($)return;for(var d=0;z>d;++d)if(C[d])return;J=[],U=0,D[D.indexOf(V)]=V=W=o}}function g(a,b,c){if(a!==Y&&!X){var d,e,f,g;for(d=0,f=b.length;f>d;++d)C[e=b[d]]&Z||(g=J[K[e]],g.value=N(g.value,u[e]));for(d=0,f=c.length;f>d;++d)(C[e=c[d]]&Z)===a&&(g=J[K[e]],g.value=O(g.value,u[e]))}}function h(a,b,c){if(a!==Y&&!X){var d,e,f,g=J[0];for(d=0,f=b.length;f>d;++d)C[e=b[d]]&Z||(g.value=N(g.value,u[e]));for(d=0,f=c.length;f>d;++d)(C[e=c[d]]&Z)===a&&(g.value=O(g.value,u[e]))}}function i(){var a,b;for(a=0;U>a;++a)J[a].value=P();for(a=0;z>a;++a)C[a]&Z||(b=J[K[a]],b.value=N(b.value,u[a]))}function j(){var a,b=J[0];for(b.value=P(),a=0;z>a;++a)C[a]&Z||(b.value=N(b.value,u[a]))}function k(){return X&&(W(),X=!1),J}function l(a){var b=L(k(),0,J.length,a);return M.sort(b,0,b.length)}function m(a,b,c){return N=a,O=b,P=c,X=!0,F}function n(){return m(q,r,p)}function w(a){return m(s(a),t(a),p)}function y(a){function b(b){return a(b.value)}return L=f(b),M=e(b),F}function A(){return y(b)}function B(){return U}function E(){var a=D.indexOf(V);return a>=0&&D.splice(a,1),a=aa.indexOf(c),a>=0&&aa.splice(a,1),a=G.indexOf(d),a>=0&&G.splice(a,1),F}var F={top:l,all:k,reduce:m,reduceCount:n,reduceSum:w,order:y,orderNatural:A,size:B,dispose:E,remove:E};ba.push(F);var J,K,L,M,N,O,P,Q=8,R=x(Q),U=0,V=o,W=o,X=!0,$=a===o;return arguments.length<1&&(a=b),D.push(V),aa.push(c),G.push(d),c(S,T,0,z),n().orderNatural()}function Q(){var a=P(o),b=a.all;return delete a.all,delete a.top,delete a.order,delete a.orderNatural,delete a.size,a.value=function(){return b()[0].value},a}function R(){ba.forEach(function(a){a.dispose()});var a=F.indexOf(d);return a>=0&&F.splice(a,1),a=F.indexOf(g),a>=0&&F.splice(a,1),a=G.indexOf(i),a>=0&&G.splice(a,1),A&=Z,K()}var S,T,U,V,W,X={filter:k,filterExact:E,filterRange:J,filterFunction:L,filterAll:K,top:N,bottom:O,group:P,groupAll:Q,dispose:R,remove:R},Y=~A&-~A,Z=~Y,$=h(function(a){return U[a]}),_=n,aa=[],ba=[],ca=0,da=0;return F.unshift(d),F.push(g),G.push(i),A|=Y,(B>=32?!Y:A&(1<<B)-1)&&(C=I(C,B<<=1)),d(u,0,z),g(u,0,z),X}function i(){function a(a,b){var c;if(!n)for(c=b;z>c;++c)C[c]||(i=j(i,u[c]))}function b(a,b,c){var d,e,f;if(!n){for(d=0,f=b.length;f>d;++d)C[e=b[d]]||(i=j(i,u[e]));for(d=0,f=c.length;f>d;++d)C[e=c[d]]===a&&(i=k(i,u[e]))}}function c(){var a;for(i=l(),a=0;z>a;++a)C[a]||(i=j(i,u[a]))}function d(a,b,c){return j=a,k=b,l=c,n=!0,m}function e(){return d(q,r,p)}function f(a){return d(s(a),t(a),p)}function g(){return n&&(c(),n=!1),i}function h(){var c=D.indexOf(b);return c>=0&&D.splice(c),c=F.indexOf(a),c>=0&&F.splice(c),m}var i,j,k,l,m={reduce:d,reduceCount:e,reduceSum:f,value:g,dispose:h,remove:h},n=!0;return D.push(b),F.push(a),a(u,0,z),e()}function j(){return z}var k={add:a,remove:d,dimension:g,groupAll:i,size:j},u=[],z=0,A=0,B=8,C=E(0),D=[],F=[],G=[];return arguments.length?a(arguments[0]):k}function v(a,b){return(257>b?E:65537>b?F:G)(a)}function w(a){for(var b=v(a,a),c=-1;++c<a;)b[c]=c;return b}function x(a){return 8===a?256:16===a?65536:4294967296}u.version="1.3.11",u.permute=c;var y=u.bisect=d(b);y.by=d;var z=u.heap=e(b);z.by=e;var A=u.heapselect=f(b);A.by=f;var B=u.insertionsort=g(b);B.by=g;var C=u.quicksort=h(b);C.by=h;var D=32,E=i,F=i,G=i,H=j,I=k;"undefined"!=typeof Uint8Array&&(E=function(a){return new Uint8Array(a)},F=function(a){return new Uint16Array(a)},G=function(a){return new Uint32Array(a)},H=function(a,b){if(a.length>=b)return a;var c=new a.constructor(b);return c.set(a),c},I=function(a,b){var c;switch(b){case 16:c=F(a.length);break;case 32:c=G(a.length);break;default:throw new Error("invalid array width!")}return c.set(a),c}),a.crossfilter=u}("undefined"!=typeof exports&&exports||this),jQuery.effects||function(a,b){function c(b){var c;return b&&b.constructor==Array&&3==b.length?b:(c=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(b))?[parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10)]:(c=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(b))?[2.55*parseFloat(c[1]),2.55*parseFloat(c[2]),2.55*parseFloat(c[3])]:(c=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(b))?[parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],16)]:(c=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(b))?[parseInt(c[1]+c[1],16),parseInt(c[2]+c[2],16),parseInt(c[3]+c[3],16)]:(c=/rgba\(0, 0, 0, 0\)/.exec(b))?i.transparent:i[a.trim(b).toLowerCase()]}function d(b,d){var e;do{if(e=a.curCSS(b,d),""!=e&&"transparent"!=e||a.nodeName(b,"body"))break;d="backgroundColor"}while(b=b.parentNode);return c(e)}function e(){var a,b,c=document.defaultView?document.defaultView.getComputedStyle(this,null):this.currentStyle,d={};if(c&&c.length&&c[0]&&c[c[0]])for(var e=c.length;e--;)a=c[e],"string"==typeof c[a]&&(b=a.replace(/\-(\w)/g,function(a,b){return b.toUpperCase()}),d[b]=c[a]);else for(a in c)"string"==typeof c[a]&&(d[a]=c[a]);return d}function f(b){var c,d;for(c in b)d=b[c],(null==d||a.isFunction(d)||c in k||/scrollbar/.test(c)||!/color/i.test(c)&&isNaN(parseFloat(d)))&&delete b[c];return b}function g(a,b){var c,d={_:0};for(c in b)a[c]!=b[c]&&(d[c]=b[c]);return d}function h(b,c,d,e){return"object"==typeof b&&(e=c,d=null,c=b,b=c.effect),a.isFunction(c)&&(e=c,d=null,c={}),("number"==typeof c||a.fx.speeds[c])&&(e=d,d=c,c={}),a.isFunction(d)&&(e=d,d=null),c=c||{},d=d||c.duration,d=a.fx.off?0:"number"==typeof d?d:a.fx.speeds[d]||a.fx.speeds._default,e=e||c.complete,[b,c,d,e]}a.effects={},a.each(["backgroundColor","borderBottomColor","borderLeftColor","borderRightColor","borderTopColor","color","outlineColor"],function(b,e){a.fx.step[e]=function(a){a.colorInit||(a.start=d(a.elem,e),a.end=c(a.end),a.colorInit=!0),a.elem.style[e]="rgb("+Math.max(Math.min(parseInt(a.pos*(a.end[0]-a.start[0])+a.start[0],10),255),0)+","+Math.max(Math.min(parseInt(a.pos*(a.end[1]-a.start[1])+a.start[1],10),255),0)+","+Math.max(Math.min(parseInt(a.pos*(a.end[2]-a.start[2])+a.start[2],10),255),0)+")"}});var i={aqua:[0,255,255],azure:[240,255,255],beige:[245,245,220],black:[0,0,0],blue:[0,0,255],brown:[165,42,42],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgrey:[169,169,169],darkgreen:[0,100,0],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkviolet:[148,0,211],fuchsia:[255,0,255],gold:[255,215,0],green:[0,128,0],indigo:[75,0,130],khaki:[240,230,140],lightblue:[173,216,230],lightcyan:[224,255,255],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightyellow:[255,255,224],lime:[0,255,0],magenta:[255,0,255],maroon:[128,0,0],navy:[0,0,128],olive:[128,128,0],orange:[255,165,0],pink:[255,192,203],purple:[128,0,128],violet:[128,0,128],red:[255,0,0],silver:[192,192,192],white:[255,255,255],yellow:[255,255,0],transparent:[255,255,255]},j=["add","remove","toggle"],k={border:1,borderBottom:1,borderColor:1,borderLeft:1,borderRight:1,borderTop:1,borderWidth:1,margin:1,padding:1};a.effects.animateClass=function(b,c,d,h){return a.isFunction(d)&&(h=d,d=null),this.each(function(){var i,k=a(this),l=k.attr("style")||" ",m=f(e.call(this)),n=k.attr("className");a.each(j,function(a,c){b[c]&&k[c+"Class"](b[c])}),i=f(e.call(this)),k.attr("className",n),k.animate(g(m,i),c,d,function(){a.each(j,function(a,c){b[c]&&k[c+"Class"](b[c])}),"object"==typeof k.attr("style")?(k.attr("style").cssText="",k.attr("style").cssText=l):k.attr("style",l),h&&h.apply(this,arguments)})})},a.fn.extend({_addClass:a.fn.addClass,addClass:function(b,c,d,e){return c?a.effects.animateClass.apply(this,[{add:b},c,d,e]):this._addClass(b)},_removeClass:a.fn.removeClass,removeClass:function(b,c,d,e){return c?a.effects.animateClass.apply(this,[{remove:b},c,d,e]):this._removeClass(b)},_toggleClass:a.fn.toggleClass,toggleClass:function(c,d,e,f,g){return"boolean"==typeof d||d===b?e?a.effects.animateClass.apply(this,[d?{add:c}:{remove:c},e,f,g]):this._toggleClass(c,d):a.effects.animateClass.apply(this,[{toggle:c},d,e,f])},switchClass:function(b,c,d,e,f){return a.effects.animateClass.apply(this,[{add:c,remove:b},d,e,f])}}),a.extend(a.effects,{version:"1.8.3",save:function(a,b){for(var c=0;c<b.length;c++)null!==b[c]&&a.data("ec.storage."+b[c],a[0].style[b[c]])},restore:function(a,b){for(var c=0;c<b.length;c++)null!==b[c]&&a.css(b[c],a.data("ec.storage."+b[c]))},setMode:function(a,b){return"toggle"==b&&(b=a.is(":hidden")?"show":"hide"),b},getBaseline:function(a,b){var c,d;switch(a[0]){case"top":c=0;break;case"middle":c=.5;break;case"bottom":c=1;break;default:c=a[0]/b.height}switch(a[1]){case"left":d=0;break;case"center":d=.5;break;case"right":d=1;break;default:d=a[1]/b.width}return{x:d,y:c}},createWrapper:function(b){if(b.parent().is(".ui-effects-wrapper"))return b.parent();var c={width:b.outerWidth(!0),height:b.outerHeight(!0),"float":b.css("float")},d=a("<div></div>").addClass("ui-effects-wrapper").css({fontSize:"100%",background:"transparent",border:"none",margin:0,padding:0});return b.wrap(d),d=b.parent(),"static"==b.css("position")?(d.css({position:"relative"}),b.css({position:"relative"})):(a.extend(c,{position:b.css("position"),zIndex:b.css("z-index")}),a.each(["top","left","bottom","right"],function(a,d){c[d]=b.css(d),isNaN(parseInt(c[d],10))&&(c[d]="auto")}),b.css({position:"relative",top:0,left:0})),d.css(c).show()},removeWrapper:function(a){return a.parent().is(".ui-effects-wrapper")?a.parent().replaceWith(a):a},setTransition:function(b,c,d,e){return e=e||{},a.each(c,function(a,c){unit=b.cssUnit(c),unit[0]>0&&(e[c]=unit[0]*d+unit[1])}),e}}),a.fn.extend({effect:function(b,c,d,e){var f=h.apply(this,arguments),g={options:f[1],duration:f[2],callback:f[3]},i=a.effects[b];return i&&!a.fx.off?i.call(this,g):this},_show:a.fn.show,show:function(b){if(!b||"number"==typeof b||a.fx.speeds[b])return this._show.apply(this,arguments);var c=h.apply(this,arguments);return c[1].mode="show",this.effect.apply(this,c)},_hide:a.fn.hide,hide:function(b){if(!b||"number"==typeof b||a.fx.speeds[b])return this._hide.apply(this,arguments);var c=h.apply(this,arguments);return c[1].mode="hide",this.effect.apply(this,c)},__toggle:a.fn.toggle,toggle:function(b){if(!b||"number"==typeof b||a.fx.speeds[b]||"boolean"==typeof b||a.isFunction(b))return this.__toggle.apply(this,arguments);var c=h.apply(this,arguments);return c[1].mode="toggle",this.effect.apply(this,c)},cssUnit:function(b){var c=this.css(b),d=[];return a.each(["em","px","%","pt"],function(a,b){c.indexOf(b)>0&&(d=[parseFloat(c),b])}),d}}),a.easing.jswing=a.easing.swing,a.extend(a.easing,{def:"easeOutQuad",swing:function(b,c,d,e,f){return a.easing[a.easing.def](b,c,d,e,f)},easeInQuad:function(a,b,c,d,e){return d*(b/=e)*b+c},easeOutQuad:function(a,b,c,d,e){return-d*(b/=e)*(b-2)+c},easeInOutQuad:function(a,b,c,d,e){return(b/=e/2)<1?d/2*b*b+c:-d/2*(--b*(b-2)-1)+c},easeInCubic:function(a,b,c,d,e){return d*(b/=e)*b*b+c},easeOutCubic:function(a,b,c,d,e){return d*((b=b/e-1)*b*b+1)+c},easeInOutCubic:function(a,b,c,d,e){return(b/=e/2)<1?d/2*b*b*b+c:d/2*((b-=2)*b*b+2)+c},easeInQuart:function(a,b,c,d,e){return d*(b/=e)*b*b*b+c},easeOutQuart:function(a,b,c,d,e){return-d*((b=b/e-1)*b*b*b-1)+c},easeInOutQuart:function(a,b,c,d,e){return(b/=e/2)<1?d/2*b*b*b*b+c:-d/2*((b-=2)*b*b*b-2)+c},easeInQuint:function(a,b,c,d,e){return d*(b/=e)*b*b*b*b+c},easeOutQuint:function(a,b,c,d,e){return d*((b=b/e-1)*b*b*b*b+1)+c},easeInOutQuint:function(a,b,c,d,e){return(b/=e/2)<1?d/2*b*b*b*b*b+c:d/2*((b-=2)*b*b*b*b+2)+c},easeInSine:function(a,b,c,d,e){return-d*Math.cos(b/e*(Math.PI/2))+d+c},easeOutSine:function(a,b,c,d,e){return d*Math.sin(b/e*(Math.PI/2))+c},easeInOutSine:function(a,b,c,d,e){return-d/2*(Math.cos(Math.PI*b/e)-1)+c},easeInExpo:function(a,b,c,d,e){return 0==b?c:d*Math.pow(2,10*(b/e-1))+c},easeOutExpo:function(a,b,c,d,e){return b==e?c+d:d*(-Math.pow(2,-10*b/e)+1)+c},easeInOutExpo:function(a,b,c,d,e){return 0==b?c:b==e?c+d:(b/=e/2)<1?d/2*Math.pow(2,10*(b-1))+c:d/2*(-Math.pow(2,-10*--b)+2)+c},easeInCirc:function(a,b,c,d,e){return-d*(Math.sqrt(1-(b/=e)*b)-1)+c},easeOutCirc:function(a,b,c,d,e){return d*Math.sqrt(1-(b=b/e-1)*b)+c},easeInOutCirc:function(a,b,c,d,e){return(b/=e/2)<1?-d/2*(Math.sqrt(1-b*b)-1)+c:d/2*(Math.sqrt(1-(b-=2)*b)+1)+c},easeInElastic:function(a,b,c,d,e){var f=1.70158,g=0,h=d;if(0==b)return c;if(1==(b/=e))return c+d;if(g||(g=.3*e),h<Math.abs(d)){h=d;var f=g/4}else var f=g/(2*Math.PI)*Math.asin(d/h);return-(h*Math.pow(2,10*(b-=1))*Math.sin(2*(b*e-f)*Math.PI/g))+c},easeOutElastic:function(a,b,c,d,e){var f=1.70158,g=0,h=d;if(0==b)return c;if(1==(b/=e))return c+d;if(g||(g=.3*e),h<Math.abs(d)){h=d;var f=g/4}else var f=g/(2*Math.PI)*Math.asin(d/h);return h*Math.pow(2,-10*b)*Math.sin(2*(b*e-f)*Math.PI/g)+d+c},easeInOutElastic:function(a,b,c,d,e){var f=1.70158,g=0,h=d;if(0==b)return c;if(2==(b/=e/2))return c+d;if(g||(g=.3*e*1.5),h<Math.abs(d)){h=d;var f=g/4}else var f=g/(2*Math.PI)*Math.asin(d/h);return 1>b?-.5*h*Math.pow(2,10*(b-=1))*Math.sin(2*(b*e-f)*Math.PI/g)+c:h*Math.pow(2,-10*(b-=1))*Math.sin(2*(b*e-f)*Math.PI/g)*.5+d+c},easeInBack:function(a,c,d,e,f,g){return g==b&&(g=1.70158),e*(c/=f)*c*((g+1)*c-g)+d},easeOutBack:function(a,c,d,e,f,g){
return g==b&&(g=1.70158),e*((c=c/f-1)*c*((g+1)*c+g)+1)+d},easeInOutBack:function(a,c,d,e,f,g){return g==b&&(g=1.70158),(c/=f/2)<1?e/2*c*c*(((g*=1.525)+1)*c-g)+d:e/2*((c-=2)*c*(((g*=1.525)+1)*c+g)+2)+d},easeInBounce:function(b,c,d,e,f){return e-a.easing.easeOutBounce(b,f-c,0,e,f)+d},easeOutBounce:function(a,b,c,d,e){return(b/=e)<1/2.75?7.5625*d*b*b+c:2/2.75>b?d*(7.5625*(b-=1.5/2.75)*b+.75)+c:2.5/2.75>b?d*(7.5625*(b-=2.25/2.75)*b+.9375)+c:d*(7.5625*(b-=2.625/2.75)*b+.984375)+c},easeInOutBounce:function(b,c,d,e,f){return f/2>c?.5*a.easing.easeInBounce(b,2*c,0,e,f)+d:.5*a.easing.easeOutBounce(b,2*c-f,0,e,f)+.5*e+d}})}(jQuery),function(a,b){a.effects.blind=function(b){return this.queue(function(){var c=a(this),d=["position","top","left"],e=a.effects.setMode(c,b.options.mode||"hide"),f=b.options.direction||"vertical";a.effects.save(c,d),c.show();var g=a.effects.createWrapper(c).css({overflow:"hidden"}),h="vertical"==f?"height":"width",i="vertical"==f?g.height():g.width();"show"==e&&g.css(h,0);var j={};j[h]="show"==e?i:0,g.animate(j,b.duration,b.options.easing,function(){"hide"==e&&c.hide(),a.effects.restore(c,d),a.effects.removeWrapper(c),b.callback&&b.callback.apply(c[0],arguments),c.dequeue()})})}}(jQuery),function(a,b){a.effects.highlight=function(b){return this.queue(function(){var c=a(this),d=["backgroundImage","backgroundColor","opacity"],e=a.effects.setMode(c,b.options.mode||"show"),f={backgroundColor:c.css("backgroundColor")};"hide"==e&&(f.opacity=0),a.effects.save(c,d),c.show().css({backgroundImage:"none",backgroundColor:b.options.color||"#ffff99"}).animate(f,{queue:!1,duration:b.duration,easing:b.options.easing,complete:function(){"hide"==e&&c.hide(),a.effects.restore(c,d),"show"==e&&!a.support.opacity&&this.style.removeAttribute("filter"),b.callback&&b.callback.apply(this,arguments),c.dequeue()}})})}}(jQuery),function(a,b){var c=0;a.widget("ui.autocomplete",{options:{appendTo:"body",autoFocus:!1,delay:300,minLength:1,position:{my:"left top",at:"left bottom",collision:"none"},source:null},pending:0,_create:function(){var b,c=this,d=this.element[0].ownerDocument;this.isMultiLine=this.element.is("textarea"),this.element.addClass("ui-autocomplete-input").attr("autocomplete","off").attr({role:"textbox","aria-autocomplete":"list","aria-haspopup":"true"}).bind("keydown.autocomplete",function(d){if(!c.options.disabled&&!c.element.propAttr("readOnly")){b=!1;var e=a.ui.keyCode;switch(d.keyCode){case e.PAGE_UP:c._move("previousPage",d);break;case e.PAGE_DOWN:c._move("nextPage",d);break;case e.UP:c._keyEvent("previous",d);break;case e.DOWN:c._keyEvent("next",d);break;case e.ENTER:case e.NUMPAD_ENTER:c.menu.active&&(b=!0,d.preventDefault());case e.TAB:if(!c.menu.active)return;c.menu.select(d);break;case e.ESCAPE:c.element.val(c.term),c.close(d);break;default:clearTimeout(c.searching),c.searching=setTimeout(function(){c.term!=c.element.val()&&(c.selectedItem=null,c.search(null,d))},c.options.delay)}}}).bind("keypress.autocomplete",function(a){b&&(b=!1,a.preventDefault())}).bind("focus.autocomplete",function(){c.options.disabled||(c.selectedItem=null,c.previous=c.element.val())}).bind("blur.autocomplete",function(a){c.options.disabled||(clearTimeout(c.searching),c.closing=setTimeout(function(){c.close(a),c._change(a)},150))}),this._initSource(),this.menu=a("<ul></ul>").addClass("ui-autocomplete").appendTo(a(this.options.appendTo||"body",d)[0]).mousedown(function(b){var d=c.menu.element[0];a(b.target).closest(".ui-menu-item").length||setTimeout(function(){a(document).one("mousedown",function(b){b.target===c.element[0]||b.target===d||a.ui.contains(d,b.target)||c.close()})},1),setTimeout(function(){clearTimeout(c.closing)},13)}).menu({focus:function(a,b){var d=b.item.data("item.autocomplete");!1!==c._trigger("focus",a,{item:d})&&/^key/.test(a.originalEvent.type)&&c.element.val(d.value)},selected:function(a,b){var e=b.item.data("item.autocomplete"),f=c.previous;c.element[0]!==d.activeElement&&(c.element.focus(),c.previous=f,setTimeout(function(){c.previous=f,c.selectedItem=e},1)),!1!==c._trigger("select",a,{item:e})&&c.element.val(e.value),c.term=c.element.val(),c.close(a),c.selectedItem=e},blur:function(a,b){c.menu.element.is(":visible")&&c.element.val()!==c.term&&c.element.val(c.term)}}).zIndex(this.element.zIndex()+1).css({top:0,left:0}).hide().data("menu"),a.fn.bgiframe&&this.menu.element.bgiframe(),c.beforeunloadHandler=function(){c.element.removeAttr("autocomplete")},a(window).bind("beforeunload",c.beforeunloadHandler)},destroy:function(){this.element.removeClass("ui-autocomplete-input").removeAttr("autocomplete").removeAttr("role").removeAttr("aria-autocomplete").removeAttr("aria-haspopup"),this.menu.element.remove(),a(window).unbind("beforeunload",this.beforeunloadHandler),a.Widget.prototype.destroy.call(this)},_setOption:function(b,c){a.Widget.prototype._setOption.apply(this,arguments),"source"===b&&this._initSource(),"appendTo"===b&&this.menu.element.appendTo(a(c||"body",this.element[0].ownerDocument)[0]),"disabled"===b&&c&&this.xhr&&this.xhr.abort()},_initSource:function(){var b,c,d=this;a.isArray(this.options.source)?(b=this.options.source,this.source=function(c,d){d(a.ui.autocomplete.filter(b,c.term))}):"string"==typeof this.options.source?(c=this.options.source,this.source=function(b,e){d.xhr&&d.xhr.abort(),d.xhr=a.ajax({url:c,data:b,dataType:"json",success:function(a,b){e(a)},error:function(){e([])}})}):this.source=this.options.source},search:function(a,b){return a=null!=a?a:this.element.val(),this.term=this.element.val(),a.length<this.options.minLength?this.close(b):(clearTimeout(this.closing),this._trigger("search",b)!==!1?this._search(a):void 0)},_search:function(a){this.pending++,this.element.addClass("ui-autocomplete-loading"),this.source({term:a},this._response())},_response:function(){var a=this,b=++c;return function(d){b===c&&a.__response(d),a.pending--,a.pending||a.element.removeClass("ui-autocomplete-loading")}},__response:function(a){!this.options.disabled&&a&&a.length?(a=this._normalize(a),this._suggest(a),this._trigger("open")):this.close()},close:function(a){clearTimeout(this.closing),this.menu.element.is(":visible")&&(this.menu.element.hide(),this.menu.deactivate(),this._trigger("close",a))},_change:function(a){this.previous!==this.element.val()&&this._trigger("change",a,{item:this.selectedItem})},_normalize:function(b){return b.length&&b[0].label&&b[0].value?b:a.map(b,function(b){return"string"==typeof b?{label:b,value:b}:a.extend({label:b.label||b.value,value:b.value||b.label},b)})},_suggest:function(b){var c=this.menu.element.empty().zIndex(this.element.zIndex()+1);this._renderMenu(c,b),this.menu.deactivate(),this.menu.refresh(),c.show(),this._resizeMenu(),c.position(a.extend({of:this.element},this.options.position)),this.options.autoFocus&&this.menu.next(new a.Event("mouseover"))},_resizeMenu:function(){var a=this.menu.element;a.outerWidth(Math.max(a.width("").outerWidth()+1,this.element.outerWidth()))},_renderMenu:function(b,c){var d=this;a.each(c,function(a,c){d._renderItem(b,c)})},_renderItem:function(b,c){return a("<li></li>").data("item.autocomplete",c).append(a("<a></a>").text(c.label)).appendTo(b)},_move:function(a,b){return this.menu.element.is(":visible")?this.menu.first()&&/^previous/.test(a)||this.menu.last()&&/^next/.test(a)?(this.element.val(this.term),void this.menu.deactivate()):void this.menu[a](b):void this.search(null,b)},widget:function(){return this.menu.element},_keyEvent:function(a,b){(!this.isMultiLine||this.menu.element.is(":visible"))&&(this._move(a,b),b.preventDefault())}}),a.extend(a.ui.autocomplete,{escapeRegex:function(a){return a.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")},filter:function(b,c){var d=new RegExp(a.ui.autocomplete.escapeRegex(c),"i");return a.grep(b,function(a){return d.test(a.label||a.value||a)})}})}(jQuery),function(a){a.widget("ui.menu",{_create:function(){var b=this;this.element.addClass("ui-menu ui-widget ui-widget-content ui-corner-all").attr({role:"listbox","aria-activedescendant":"ui-active-menuitem"}).click(function(c){a(c.target).closest(".ui-menu-item a").length&&(c.preventDefault(),b.select(c))}),this.refresh()},refresh:function(){var b=this,c=this.element.children("li:not(.ui-menu-item):has(a)").addClass("ui-menu-item").attr("role","menuitem");c.children("a").addClass("ui-corner-all").attr("tabindex",-1).mouseenter(function(c){b.activate(c,a(this).parent())}).mouseleave(function(){b.deactivate()})},activate:function(a,b){if(this.deactivate(),this.hasScroll()){var c=b.offset().top-this.element.offset().top,d=this.element.scrollTop(),e=this.element.height();0>c?this.element.scrollTop(d+c):c>=e&&this.element.scrollTop(d+c-e+b.height())}this.active=b.eq(0).children("a").addClass("ui-state-hover").attr("id","ui-active-menuitem").end(),this._trigger("focus",a,{item:b})},deactivate:function(){this.active&&(this.active.children("a").removeClass("ui-state-hover").removeAttr("id"),this._trigger("blur"),this.active=null)},next:function(a){this.move("next",".ui-menu-item:first",a)},previous:function(a){this.move("prev",".ui-menu-item:last",a)},first:function(){return this.active&&!this.active.prevAll(".ui-menu-item").length},last:function(){return this.active&&!this.active.nextAll(".ui-menu-item").length},move:function(a,b,c){if(!this.active)return void this.activate(c,this.element.children(b));var d=this.active[a+"All"](".ui-menu-item").eq(0);d.length?this.activate(c,d):this.activate(c,this.element.children(b))},nextPage:function(b){if(this.hasScroll()){if(!this.active||this.last())return void this.activate(b,this.element.children(".ui-menu-item:first"));var c=this.active.offset().top,d=this.element.height(),e=this.element.children(".ui-menu-item").filter(function(){var b=a(this).offset().top-c-d+a(this).height();return 10>b&&b>-10});e.length||(e=this.element.children(".ui-menu-item:last")),this.activate(b,e)}else this.activate(b,this.element.children(".ui-menu-item").filter(!this.active||this.last()?":first":":last"))},previousPage:function(b){if(this.hasScroll()){if(!this.active||this.first())return void this.activate(b,this.element.children(".ui-menu-item:last"));var c=this.active.offset().top,d=this.element.height(),e=this.element.children(".ui-menu-item").filter(function(){var b=a(this).offset().top-c+d-a(this).height();return 10>b&&b>-10});e.length||(e=this.element.children(".ui-menu-item:first")),this.activate(b,e)}else this.activate(b,this.element.children(".ui-menu-item").filter(!this.active||this.first()?":last":":first"))},hasScroll:function(){return this.element.height()<this.element[a.fn.prop?"prop":"attr"]("scrollHeight")},select:function(a){this._trigger("selected",a,{item:this.active})}})}(jQuery),function(a,b){function c(b,c){var e=b.nodeName.toLowerCase();if("area"===e){var f,g=b.parentNode,h=g.name;return b.href&&h&&"map"===g.nodeName.toLowerCase()?(f=a("img[usemap=#"+h+"]")[0],!!f&&d(f)):!1}return(/input|select|textarea|button|object/.test(e)?!b.disabled:"a"==e?b.href||c:c)&&d(b)}function d(b){return!a(b).parents().andSelf().filter(function(){return"hidden"===a.curCSS(this,"visibility")||a.expr.filters.hidden(this)}).length}a.ui=a.ui||{},a.ui.version||(a.extend(a.ui,{version:"1.8.23",keyCode:{ALT:18,BACKSPACE:8,CAPS_LOCK:20,COMMA:188,COMMAND:91,COMMAND_LEFT:91,COMMAND_RIGHT:93,CONTROL:17,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,INSERT:45,LEFT:37,MENU:93,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SHIFT:16,SPACE:32,TAB:9,UP:38,WINDOWS:91}}),a.fn.extend({propAttr:a.fn.prop||a.fn.attr,_focus:a.fn.focus,focus:function(b,c){return"number"==typeof b?this.each(function(){var d=this;setTimeout(function(){a(d).focus(),c&&c.call(d)},b)}):this._focus.apply(this,arguments)},scrollParent:function(){var b;return b=a.browser.msie&&/(static|relative)/.test(this.css("position"))||/absolute/.test(this.css("position"))?this.parents().filter(function(){return/(relative|absolute|fixed)/.test(a.curCSS(this,"position",1))&&/(auto|scroll)/.test(a.curCSS(this,"overflow",1)+a.curCSS(this,"overflow-y",1)+a.curCSS(this,"overflow-x",1))}).eq(0):this.parents().filter(function(){return/(auto|scroll)/.test(a.curCSS(this,"overflow",1)+a.curCSS(this,"overflow-y",1)+a.curCSS(this,"overflow-x",1))}).eq(0),/fixed/.test(this.css("position"))||!b.length?a(document):b},zIndex:function(c){if(c!==b)return this.css("zIndex",c);if(this.length)for(var d,e,f=a(this[0]);f.length&&f[0]!==document;){if(d=f.css("position"),("absolute"===d||"relative"===d||"fixed"===d)&&(e=parseInt(f.css("zIndex"),10),!isNaN(e)&&0!==e))return e;f=f.parent()}return 0},disableSelection:function(){return this.bind((a.support.selectstart?"selectstart":"mousedown")+".ui-disableSelection",function(a){a.preventDefault()})},enableSelection:function(){return this.unbind(".ui-disableSelection")}}),a("<a>").outerWidth(1).jquery||a.each(["Width","Height"],function(c,d){function e(b,c,d,e){return a.each(f,function(){c-=parseFloat(a.curCSS(b,"padding"+this,!0))||0,d&&(c-=parseFloat(a.curCSS(b,"border"+this+"Width",!0))||0),e&&(c-=parseFloat(a.curCSS(b,"margin"+this,!0))||0)}),c}var f="Width"===d?["Left","Right"]:["Top","Bottom"],g=d.toLowerCase(),h={innerWidth:a.fn.innerWidth,innerHeight:a.fn.innerHeight,outerWidth:a.fn.outerWidth,outerHeight:a.fn.outerHeight};a.fn["inner"+d]=function(c){return c===b?h["inner"+d].call(this):this.each(function(){a(this).css(g,e(this,c)+"px")})},a.fn["outer"+d]=function(b,c){return"number"!=typeof b?h["outer"+d].call(this,b):this.each(function(){a(this).css(g,e(this,b,!0,c)+"px")})}}),a.extend(a.expr[":"],{data:a.expr.createPseudo?a.expr.createPseudo(function(b){return function(c){return!!a.data(c,b)}}):function(b,c,d){return!!a.data(b,d[3])},focusable:function(b){return c(b,!isNaN(a.attr(b,"tabindex")))},tabbable:function(b){var d=a.attr(b,"tabindex"),e=isNaN(d);return(e||d>=0)&&c(b,!e)}}),a(function(){var b=document.body,c=b.appendChild(c=document.createElement("div"));c.offsetHeight,a.extend(c.style,{minHeight:"100px",height:"auto",padding:0,borderWidth:0}),a.support.minHeight=100===c.offsetHeight,a.support.selectstart="onselectstart"in c,b.removeChild(c).style.display="none"}),a.curCSS||(a.curCSS=a.css),a.extend(a.ui,{plugin:{add:function(b,c,d){var e=a.ui[b].prototype;for(var f in d)e.plugins[f]=e.plugins[f]||[],e.plugins[f].push([c,d[f]])},call:function(a,b,c){var d=a.plugins[b];if(d&&a.element[0].parentNode)for(var e=0;e<d.length;e++)a.options[d[e][0]]&&d[e][1].apply(a.element,c)}},contains:function(a,b){return document.compareDocumentPosition?16&a.compareDocumentPosition(b):a!==b&&a.contains(b)},hasScroll:function(b,c){if("hidden"===a(b).css("overflow"))return!1;var d=c&&"left"===c?"scrollLeft":"scrollTop",e=!1;return b[d]>0?!0:(b[d]=1,e=b[d]>0,b[d]=0,e)},isOverAxis:function(a,b,c){return a>b&&b+c>a},isOver:function(b,c,d,e,f,g){return a.ui.isOverAxis(b,d,f)&&a.ui.isOverAxis(c,e,g)}}))}(jQuery),function(a,b){a.widget("ui.draggable",a.ui.mouse,{widgetEventPrefix:"drag",options:{addClasses:!0,appendTo:"parent",axis:!1,connectToSortable:!1,containment:!1,cursor:"auto",cursorAt:!1,grid:!1,handle:!1,helper:"original",iframeFix:!1,opacity:!1,refreshPositions:!1,revert:!1,revertDuration:500,scope:"default",scroll:!0,scrollSensitivity:20,scrollSpeed:20,snap:!1,snapMode:"both",snapTolerance:20,stack:!1,zIndex:!1},_create:function(){"original"!=this.options.helper||/^(?:r|a|f)/.test(this.element.css("position"))||(this.element[0].style.position="relative"),this.options.addClasses&&this.element.addClass("ui-draggable"),this.options.disabled&&this.element.addClass("ui-draggable-disabled"),this._mouseInit()},destroy:function(){return this.element.data("draggable")?(this.element.removeData("draggable").unbind(".draggable").removeClass("ui-draggable ui-draggable-dragging ui-draggable-disabled"),this._mouseDestroy(),this):void 0},_mouseCapture:function(b){var c=this.options;return this.helper||c.disabled||a(b.target).is(".ui-resizable-handle")?!1:(this.handle=this._getHandle(b),this.handle?(c.iframeFix&&a(c.iframeFix===!0?"iframe":c.iframeFix).each(function(){a('<div class="ui-draggable-iframeFix" style="background: #fff;"></div>').css({width:this.offsetWidth+"px",height:this.offsetHeight+"px",position:"absolute",opacity:"0.001",zIndex:1e3}).css(a(this).offset()).appendTo("body")}),!0):!1)},_mouseStart:function(b){var c=this.options;return this.helper=this._createHelper(b),this.helper.addClass("ui-draggable-dragging"),this._cacheHelperProportions(),a.ui.ddmanager&&(a.ui.ddmanager.current=this),this._cacheMargins(),this.cssPosition=this.helper.css("position"),this.scrollParent=this.helper.scrollParent(),this.offset=this.positionAbs=this.element.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},a.extend(this.offset,{click:{left:b.pageX-this.offset.left,top:b.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.originalPosition=this.position=this._generatePosition(b),this.originalPageX=b.pageX,this.originalPageY=b.pageY,c.cursorAt&&this._adjustOffsetFromHelper(c.cursorAt),c.containment&&this._setContainment(),this._trigger("start",b)===!1?(this._clear(),!1):(this._cacheHelperProportions(),a.ui.ddmanager&&!c.dropBehaviour&&a.ui.ddmanager.prepareOffsets(this,b),this._mouseDrag(b,!0),a.ui.ddmanager&&a.ui.ddmanager.dragStart(this,b),!0)},_mouseDrag:function(b,c){if(this.position=this._generatePosition(b),this.positionAbs=this._convertPositionTo("absolute"),!c){var d=this._uiHash();if(this._trigger("drag",b,d)===!1)return this._mouseUp({}),!1;this.position=d.position}return this.options.axis&&"y"==this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"==this.options.axis||(this.helper[0].style.top=this.position.top+"px"),a.ui.ddmanager&&a.ui.ddmanager.drag(this,b),!1},_mouseStop:function(b){var c=!1;a.ui.ddmanager&&!this.options.dropBehaviour&&(c=a.ui.ddmanager.drop(this,b)),this.dropped&&(c=this.dropped,this.dropped=!1);for(var d=this.element[0],e=!1;d&&(d=d.parentNode);)d==document&&(e=!0);if(!e&&"original"===this.options.helper)return!1;if("invalid"==this.options.revert&&!c||"valid"==this.options.revert&&c||this.options.revert===!0||a.isFunction(this.options.revert)&&this.options.revert.call(this.element,c)){var f=this;a(this.helper).animate(this.originalPosition,parseInt(this.options.revertDuration,10),function(){f._trigger("stop",b)!==!1&&f._clear()})}else this._trigger("stop",b)!==!1&&this._clear();return!1},_mouseUp:function(b){return this.options.iframeFix===!0&&a("div.ui-draggable-iframeFix").each(function(){this.parentNode.removeChild(this)}),a.ui.ddmanager&&a.ui.ddmanager.dragStop(this,b),a.ui.mouse.prototype._mouseUp.call(this,b)},cancel:function(){return this.helper.is(".ui-draggable-dragging")?this._mouseUp({}):this._clear(),this},_getHandle:function(b){var c=this.options.handle&&a(this.options.handle,this.element).length?!1:!0;return a(this.options.handle,this.element).find("*").andSelf().each(function(){this==b.target&&(c=!0)}),c},_createHelper:function(b){var c=this.options,d=a.isFunction(c.helper)?a(c.helper.apply(this.element[0],[b])):"clone"==c.helper?this.element.clone().removeAttr("id"):this.element;return d.parents("body").length||d.appendTo("parent"==c.appendTo?this.element[0].parentNode:c.appendTo),d[0]==this.element[0]||/(fixed|absolute)/.test(d.css("position"))||d.css("position","absolute"),d},_adjustOffsetFromHelper:function(b){"string"==typeof b&&(b=b.split(" ")),a.isArray(b)&&(b={left:+b[0],top:+b[1]||0}),"left"in b&&(this.offset.click.left=b.left+this.margins.left),"right"in b&&(this.offset.click.left=this.helperProportions.width-b.right+this.margins.left),"top"in b&&(this.offset.click.top=b.top+this.margins.top),"bottom"in b&&(this.offset.click.top=this.helperProportions.height-b.bottom+this.margins.top)},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var b=this.offsetParent.offset();return"absolute"==this.cssPosition&&this.scrollParent[0]!=document&&a.ui.contains(this.scrollParent[0],this.offsetParent[0])&&(b.left+=this.scrollParent.scrollLeft(),b.top+=this.scrollParent.scrollTop()),(this.offsetParent[0]==document.body||this.offsetParent[0].tagName&&"html"==this.offsetParent[0].tagName.toLowerCase()&&a.browser.msie)&&(b={top:0,left:0}),{top:b.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:b.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"==this.cssPosition){var a=this.element.position();return{top:a.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:a.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.element.css("marginLeft"),10)||0,top:parseInt(this.element.css("marginTop"),10)||0,right:parseInt(this.element.css("marginRight"),10)||0,bottom:parseInt(this.element.css("marginBottom"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var b=this.options;if("parent"==b.containment&&(b.containment=this.helper[0].parentNode),("document"==b.containment||"window"==b.containment)&&(this.containment=["document"==b.containment?0:a(window).scrollLeft()-this.offset.relative.left-this.offset.parent.left,"document"==b.containment?0:a(window).scrollTop()-this.offset.relative.top-this.offset.parent.top,("document"==b.containment?0:a(window).scrollLeft())+a("document"==b.containment?document:window).width()-this.helperProportions.width-this.margins.left,("document"==b.containment?0:a(window).scrollTop())+(a("document"==b.containment?document:window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]),/^(document|window|parent)$/.test(b.containment)||b.containment.constructor==Array)b.containment.constructor==Array&&(this.containment=b.containment);else{var c=a(b.containment),d=c[0];if(!d)return;var e=(c.offset(),"hidden"!=a(d).css("overflow"));this.containment=[(parseInt(a(d).css("borderLeftWidth"),10)||0)+(parseInt(a(d).css("paddingLeft"),10)||0),(parseInt(a(d).css("borderTopWidth"),10)||0)+(parseInt(a(d).css("paddingTop"),10)||0),(e?Math.max(d.scrollWidth,d.offsetWidth):d.offsetWidth)-(parseInt(a(d).css("borderLeftWidth"),10)||0)-(parseInt(a(d).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left-this.margins.right,(e?Math.max(d.scrollHeight,d.offsetHeight):d.offsetHeight)-(parseInt(a(d).css("borderTopWidth"),10)||0)-(parseInt(a(d).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top-this.margins.bottom],this.relative_container=c}},_convertPositionTo:function(b,c){c||(c=this.position);var d="absolute"==b?1:-1,e=(this.options,"absolute"!=this.cssPosition||this.scrollParent[0]!=document&&a.ui.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent),f=/(html|body)/i.test(e[0].tagName);return{top:c.top+this.offset.relative.top*d+this.offset.parent.top*d-(a.browser.safari&&a.browser.version<526&&"fixed"==this.cssPosition?0:("fixed"==this.cssPosition?-this.scrollParent.scrollTop():f?0:e.scrollTop())*d),left:c.left+this.offset.relative.left*d+this.offset.parent.left*d-(a.browser.safari&&a.browser.version<526&&"fixed"==this.cssPosition?0:("fixed"==this.cssPosition?-this.scrollParent.scrollLeft():f?0:e.scrollLeft())*d)}},_generatePosition:function(b){var c=this.options,d="absolute"!=this.cssPosition||this.scrollParent[0]!=document&&a.ui.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,e=/(html|body)/i.test(d[0].tagName),f=b.pageX,g=b.pageY;if(this.originalPosition){var h;if(this.containment){if(this.relative_container){var i=this.relative_container.offset();h=[this.containment[0]+i.left,this.containment[1]+i.top,this.containment[2]+i.left,this.containment[3]+i.top]}else h=this.containment;b.pageX-this.offset.click.left<h[0]&&(f=h[0]+this.offset.click.left),b.pageY-this.offset.click.top<h[1]&&(g=h[1]+this.offset.click.top),b.pageX-this.offset.click.left>h[2]&&(f=h[2]+this.offset.click.left),b.pageY-this.offset.click.top>h[3]&&(g=h[3]+this.offset.click.top)}if(c.grid){var j=c.grid[1]?this.originalPageY+Math.round((g-this.originalPageY)/c.grid[1])*c.grid[1]:this.originalPageY;g=h&&(j-this.offset.click.top<h[1]||j-this.offset.click.top>h[3])?j-this.offset.click.top<h[1]?j+c.grid[1]:j-c.grid[1]:j;var k=c.grid[0]?this.originalPageX+Math.round((f-this.originalPageX)/c.grid[0])*c.grid[0]:this.originalPageX;f=h&&(k-this.offset.click.left<h[0]||k-this.offset.click.left>h[2])?k-this.offset.click.left<h[0]?k+c.grid[0]:k-c.grid[0]:k}}return{top:g-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+(a.browser.safari&&a.browser.version<526&&"fixed"==this.cssPosition?0:"fixed"==this.cssPosition?-this.scrollParent.scrollTop():e?0:d.scrollTop()),left:f-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+(a.browser.safari&&a.browser.version<526&&"fixed"==this.cssPosition?0:"fixed"==this.cssPosition?-this.scrollParent.scrollLeft():e?0:d.scrollLeft())}},_clear:function(){this.helper.removeClass("ui-draggable-dragging"),this.helper[0]==this.element[0]||this.cancelHelperRemoval||this.helper.remove(),this.helper=null,this.cancelHelperRemoval=!1},_trigger:function(b,c,d){return d=d||this._uiHash(),a.ui.plugin.call(this,b,[c,d]),"drag"==b&&(this.positionAbs=this._convertPositionTo("absolute")),a.Widget.prototype._trigger.call(this,b,c,d)},plugins:{},_uiHash:function(a){return{helper:this.helper,position:this.position,originalPosition:this.originalPosition,offset:this.positionAbs}}}),a.extend(a.ui.draggable,{version:"1.8.23"}),a.ui.plugin.add("draggable","connectToSortable",{start:function(b,c){var d=a(this).data("draggable"),e=d.options,f=a.extend({},c,{item:d.element});d.sortables=[],a(e.connectToSortable).each(function(){var c=a.data(this,"sortable");c&&!c.options.disabled&&(d.sortables.push({instance:c,shouldRevert:c.options.revert}),c.refreshPositions(),c._trigger("activate",b,f))})},stop:function(b,c){var d=a(this).data("draggable"),e=a.extend({},c,{item:d.element});a.each(d.sortables,function(){this.instance.isOver?(this.instance.isOver=0,d.cancelHelperRemoval=!0,this.instance.cancelHelperRemoval=!1,this.shouldRevert&&(this.instance.options.revert=!0),this.instance._mouseStop(b),this.instance.options.helper=this.instance.options._helper,"original"==d.options.helper&&this.instance.currentItem.css({top:"auto",left:"auto"})):(this.instance.cancelHelperRemoval=!1,this.instance._trigger("deactivate",b,e))})},drag:function(b,c){var d=a(this).data("draggable"),e=this;a.each(d.sortables,function(f){this.instance.positionAbs=d.positionAbs,this.instance.helperProportions=d.helperProportions,this.instance.offset.click=d.offset.click,this.instance._intersectsWith(this.instance.containerCache)?(this.instance.isOver||(this.instance.isOver=1,this.instance.currentItem=a(e).clone().removeAttr("id").appendTo(this.instance.element).data("sortable-item",!0),this.instance.options._helper=this.instance.options.helper,this.instance.options.helper=function(){return c.helper[0]},b.target=this.instance.currentItem[0],this.instance._mouseCapture(b,!0),this.instance._mouseStart(b,!0,!0),this.instance.offset.click.top=d.offset.click.top,this.instance.offset.click.left=d.offset.click.left,this.instance.offset.parent.left-=d.offset.parent.left-this.instance.offset.parent.left,this.instance.offset.parent.top-=d.offset.parent.top-this.instance.offset.parent.top,d._trigger("toSortable",b),d.dropped=this.instance.element,d.currentItem=d.element,this.instance.fromOutside=d),this.instance.currentItem&&this.instance._mouseDrag(b)):this.instance.isOver&&(this.instance.isOver=0,this.instance.cancelHelperRemoval=!0,this.instance.options.revert=!1,this.instance._trigger("out",b,this.instance._uiHash(this.instance)),this.instance._mouseStop(b,!0),this.instance.options.helper=this.instance.options._helper,this.instance.currentItem.remove(),this.instance.placeholder&&this.instance.placeholder.remove(),d._trigger("fromSortable",b),d.dropped=!1)})}}),a.ui.plugin.add("draggable","cursor",{start:function(b,c){var d=a("body"),e=a(this).data("draggable").options;d.css("cursor")&&(e._cursor=d.css("cursor")),d.css("cursor",e.cursor)},stop:function(b,c){var d=a(this).data("draggable").options;d._cursor&&a("body").css("cursor",d._cursor)}}),a.ui.plugin.add("draggable","opacity",{start:function(b,c){var d=a(c.helper),e=a(this).data("draggable").options;d.css("opacity")&&(e._opacity=d.css("opacity")),d.css("opacity",e.opacity)},stop:function(b,c){var d=a(this).data("draggable").options;d._opacity&&a(c.helper).css("opacity",d._opacity)}}),a.ui.plugin.add("draggable","scroll",{start:function(b,c){var d=a(this).data("draggable");d.scrollParent[0]!=document&&"HTML"!=d.scrollParent[0].tagName&&(d.overflowOffset=d.scrollParent.offset())},drag:function(b,c){var d=a(this).data("draggable"),e=d.options,f=!1;d.scrollParent[0]!=document&&"HTML"!=d.scrollParent[0].tagName?(e.axis&&"x"==e.axis||(d.overflowOffset.top+d.scrollParent[0].offsetHeight-b.pageY<e.scrollSensitivity?d.scrollParent[0].scrollTop=f=d.scrollParent[0].scrollTop+e.scrollSpeed:b.pageY-d.overflowOffset.top<e.scrollSensitivity&&(d.scrollParent[0].scrollTop=f=d.scrollParent[0].scrollTop-e.scrollSpeed)),e.axis&&"y"==e.axis||(d.overflowOffset.left+d.scrollParent[0].offsetWidth-b.pageX<e.scrollSensitivity?d.scrollParent[0].scrollLeft=f=d.scrollParent[0].scrollLeft+e.scrollSpeed:b.pageX-d.overflowOffset.left<e.scrollSensitivity&&(d.scrollParent[0].scrollLeft=f=d.scrollParent[0].scrollLeft-e.scrollSpeed))):(e.axis&&"x"==e.axis||(b.pageY-a(document).scrollTop()<e.scrollSensitivity?f=a(document).scrollTop(a(document).scrollTop()-e.scrollSpeed):a(window).height()-(b.pageY-a(document).scrollTop())<e.scrollSensitivity&&(f=a(document).scrollTop(a(document).scrollTop()+e.scrollSpeed))),e.axis&&"y"==e.axis||(b.pageX-a(document).scrollLeft()<e.scrollSensitivity?f=a(document).scrollLeft(a(document).scrollLeft()-e.scrollSpeed):a(window).width()-(b.pageX-a(document).scrollLeft())<e.scrollSensitivity&&(f=a(document).scrollLeft(a(document).scrollLeft()+e.scrollSpeed)))),f!==!1&&a.ui.ddmanager&&!e.dropBehaviour&&a.ui.ddmanager.prepareOffsets(d,b)}}),a.ui.plugin.add("draggable","snap",{start:function(b,c){var d=a(this).data("draggable"),e=d.options;d.snapElements=[],a(e.snap.constructor!=String?e.snap.items||":data(draggable)":e.snap).each(function(){var b=a(this),c=b.offset();this!=d.element[0]&&d.snapElements.push({item:this,width:b.outerWidth(),height:b.outerHeight(),top:c.top,left:c.left})})},drag:function(b,c){for(var d=a(this).data("draggable"),e=d.options,f=e.snapTolerance,g=c.offset.left,h=g+d.helperProportions.width,i=c.offset.top,j=i+d.helperProportions.height,k=d.snapElements.length-1;k>=0;k--){var l=d.snapElements[k].left,m=l+d.snapElements[k].width,n=d.snapElements[k].top,o=n+d.snapElements[k].height;if(g>l-f&&m+f>g&&i>n-f&&o+f>i||g>l-f&&m+f>g&&j>n-f&&o+f>j||h>l-f&&m+f>h&&i>n-f&&o+f>i||h>l-f&&m+f>h&&j>n-f&&o+f>j){if("inner"!=e.snapMode){var p=Math.abs(n-j)<=f,q=Math.abs(o-i)<=f,r=Math.abs(l-h)<=f,s=Math.abs(m-g)<=f;p&&(c.position.top=d._convertPositionTo("relative",{top:n-d.helperProportions.height,left:0}).top-d.margins.top),q&&(c.position.top=d._convertPositionTo("relative",{top:o,left:0}).top-d.margins.top),r&&(c.position.left=d._convertPositionTo("relative",{top:0,left:l-d.helperProportions.width}).left-d.margins.left),s&&(c.position.left=d._convertPositionTo("relative",{top:0,left:m}).left-d.margins.left)}var t=p||q||r||s;if("outer"!=e.snapMode){var p=Math.abs(n-i)<=f,q=Math.abs(o-j)<=f,r=Math.abs(l-g)<=f,s=Math.abs(m-h)<=f;p&&(c.position.top=d._convertPositionTo("relative",{top:n,left:0}).top-d.margins.top),q&&(c.position.top=d._convertPositionTo("relative",{top:o-d.helperProportions.height,
left:0}).top-d.margins.top),r&&(c.position.left=d._convertPositionTo("relative",{top:0,left:l}).left-d.margins.left),s&&(c.position.left=d._convertPositionTo("relative",{top:0,left:m-d.helperProportions.width}).left-d.margins.left)}!d.snapElements[k].snapping&&(p||q||r||s||t)&&d.options.snap.snap&&d.options.snap.snap.call(d.element,b,a.extend(d._uiHash(),{snapItem:d.snapElements[k].item})),d.snapElements[k].snapping=p||q||r||s||t}else d.snapElements[k].snapping&&d.options.snap.release&&d.options.snap.release.call(d.element,b,a.extend(d._uiHash(),{snapItem:d.snapElements[k].item})),d.snapElements[k].snapping=!1}}}),a.ui.plugin.add("draggable","stack",{start:function(b,c){var d=a(this).data("draggable").options,e=a.makeArray(a(d.stack)).sort(function(b,c){return(parseInt(a(b).css("zIndex"),10)||0)-(parseInt(a(c).css("zIndex"),10)||0)});if(e.length){var f=parseInt(e[0].style.zIndex)||0;a(e).each(function(a){this.style.zIndex=f+a}),this[0].style.zIndex=f+e.length}}}),a.ui.plugin.add("draggable","zIndex",{start:function(b,c){var d=a(c.helper),e=a(this).data("draggable").options;d.css("zIndex")&&(e._zIndex=d.css("zIndex")),d.css("zIndex",e.zIndex)},stop:function(b,c){var d=a(this).data("draggable").options;d._zIndex&&a(c.helper).css("zIndex",d._zIndex)}})}(jQuery),function(a,b){a.widget("ui.droppable",{widgetEventPrefix:"drop",options:{accept:"*",activeClass:!1,addClasses:!0,greedy:!1,hoverClass:!1,scope:"default",tolerance:"intersect"},_create:function(){var b=this.options,c=b.accept;this.isover=0,this.isout=1,this.accept=a.isFunction(c)?c:function(a){return a.is(c)},this.proportions={width:this.element[0].offsetWidth,height:this.element[0].offsetHeight},a.ui.ddmanager.droppables[b.scope]=a.ui.ddmanager.droppables[b.scope]||[],a.ui.ddmanager.droppables[b.scope].push(this),b.addClasses&&this.element.addClass("ui-droppable")},destroy:function(){for(var b=a.ui.ddmanager.droppables[this.options.scope],c=0;c<b.length;c++)b[c]==this&&b.splice(c,1);return this.element.removeClass("ui-droppable ui-droppable-disabled").removeData("droppable").unbind(".droppable"),this},_setOption:function(b,c){"accept"==b&&(this.accept=a.isFunction(c)?c:function(a){return a.is(c)}),a.Widget.prototype._setOption.apply(this,arguments)},_activate:function(b){var c=a.ui.ddmanager.current;this.options.activeClass&&this.element.addClass(this.options.activeClass),c&&this._trigger("activate",b,this.ui(c))},_deactivate:function(b){var c=a.ui.ddmanager.current;this.options.activeClass&&this.element.removeClass(this.options.activeClass),c&&this._trigger("deactivate",b,this.ui(c))},_over:function(b){var c=a.ui.ddmanager.current;c&&(c.currentItem||c.element)[0]!=this.element[0]&&this.accept.call(this.element[0],c.currentItem||c.element)&&(this.options.hoverClass&&this.element.addClass(this.options.hoverClass),this._trigger("over",b,this.ui(c)))},_out:function(b){var c=a.ui.ddmanager.current;c&&(c.currentItem||c.element)[0]!=this.element[0]&&this.accept.call(this.element[0],c.currentItem||c.element)&&(this.options.hoverClass&&this.element.removeClass(this.options.hoverClass),this._trigger("out",b,this.ui(c)))},_drop:function(b,c){var d=c||a.ui.ddmanager.current;if(!d||(d.currentItem||d.element)[0]==this.element[0])return!1;var e=!1;return this.element.find(":data(droppable)").not(".ui-draggable-dragging").each(function(){var b=a.data(this,"droppable");return b.options.greedy&&!b.options.disabled&&b.options.scope==d.options.scope&&b.accept.call(b.element[0],d.currentItem||d.element)&&a.ui.intersect(d,a.extend(b,{offset:b.element.offset()}),b.options.tolerance)?(e=!0,!1):void 0}),e?!1:this.accept.call(this.element[0],d.currentItem||d.element)?(this.options.activeClass&&this.element.removeClass(this.options.activeClass),this.options.hoverClass&&this.element.removeClass(this.options.hoverClass),this._trigger("drop",b,this.ui(d)),this.element):!1},ui:function(a){return{draggable:a.currentItem||a.element,helper:a.helper,position:a.position,offset:a.positionAbs}}}),a.extend(a.ui.droppable,{version:"1.8.23"}),a.ui.intersect=function(b,c,d){if(!c.offset)return!1;var e=(b.positionAbs||b.position.absolute).left,f=e+b.helperProportions.width,g=(b.positionAbs||b.position.absolute).top,h=g+b.helperProportions.height,i=c.offset.left,j=i+c.proportions.width,k=c.offset.top,l=k+c.proportions.height;switch(d){case"fit":return e>=i&&j>=f&&g>=k&&l>=h;case"intersect":return i<e+b.helperProportions.width/2&&f-b.helperProportions.width/2<j&&k<g+b.helperProportions.height/2&&h-b.helperProportions.height/2<l;case"pointer":var m=(b.positionAbs||b.position.absolute).left+(b.clickOffset||b.offset.click).left,n=(b.positionAbs||b.position.absolute).top+(b.clickOffset||b.offset.click).top,o=a.ui.isOver(n,m,k,i,c.proportions.height,c.proportions.width);return o;case"touch":return(g>=k&&l>=g||h>=k&&l>=h||k>g&&h>l)&&(e>=i&&j>=e||f>=i&&j>=f||i>e&&f>j);default:return!1}},a.ui.ddmanager={current:null,droppables:{"default":[]},prepareOffsets:function(b,c){var d=a.ui.ddmanager.droppables[b.options.scope]||[],e=c?c.type:null,f=(b.currentItem||b.element).find(":data(droppable)").andSelf();a:for(var g=0;g<d.length;g++)if(!(d[g].options.disabled||b&&!d[g].accept.call(d[g].element[0],b.currentItem||b.element))){for(var h=0;h<f.length;h++)if(f[h]==d[g].element[0]){d[g].proportions.height=0;continue a}d[g].visible="none"!=d[g].element.css("display"),d[g].visible&&("mousedown"==e&&d[g]._activate.call(d[g],c),d[g].offset=d[g].element.offset(),d[g].proportions={width:d[g].element[0].offsetWidth,height:d[g].element[0].offsetHeight})}},drop:function(b,c){var d=!1;return a.each(a.ui.ddmanager.droppables[b.options.scope]||[],function(){this.options&&(!this.options.disabled&&this.visible&&a.ui.intersect(b,this,this.options.tolerance)&&(d=this._drop.call(this,c)||d),!this.options.disabled&&this.visible&&this.accept.call(this.element[0],b.currentItem||b.element)&&(this.isout=1,this.isover=0,this._deactivate.call(this,c)))}),d},dragStart:function(b,c){b.element.parents(":not(body,html)").bind("scroll.droppable",function(){b.options.refreshPositions||a.ui.ddmanager.prepareOffsets(b,c)})},drag:function(b,c){b.options.refreshPositions&&a.ui.ddmanager.prepareOffsets(b,c),a.each(a.ui.ddmanager.droppables[b.options.scope]||[],function(){if(!this.options.disabled&&!this.greedyChild&&this.visible){var d=a.ui.intersect(b,this,this.options.tolerance),e=d||1!=this.isover?d&&0==this.isover?"isover":null:"isout";if(e){var f;if(this.options.greedy){var g=this.element.parents(":data(droppable):eq(0)");g.length&&(f=a.data(g[0],"droppable"),f.greedyChild="isover"==e?1:0)}f&&"isover"==e&&(f.isover=0,f.isout=1,f._out.call(f,c)),this[e]=1,this["isout"==e?"isover":"isout"]=0,this["isover"==e?"_over":"_out"].call(this,c),f&&"isout"==e&&(f.isout=0,f.isover=1,f._over.call(f,c))}}})},dragStop:function(b,c){b.element.parents(":not(body,html)").unbind("scroll.droppable"),b.options.refreshPositions||a.ui.ddmanager.prepareOffsets(b,c)}}}(jQuery),function(a,b){var c=!1;a(document).mouseup(function(a){c=!1}),a.widget("ui.mouse",{options:{cancel:":input,option",distance:1,delay:0},_mouseInit:function(){var b=this;this.element.bind("mousedown."+this.widgetName,function(a){return b._mouseDown(a)}).bind("click."+this.widgetName,function(c){return!0===a.data(c.target,b.widgetName+".preventClickEvent")?(a.removeData(c.target,b.widgetName+".preventClickEvent"),c.stopImmediatePropagation(),!1):void 0}),this.started=!1},_mouseDestroy:function(){this.element.unbind("."+this.widgetName),this._mouseMoveDelegate&&a(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate)},_mouseDown:function(b){if(!c){this._mouseStarted&&this._mouseUp(b),this._mouseDownEvent=b;var d=this,e=1==b.which,f="string"==typeof this.options.cancel&&b.target.nodeName?a(b.target).closest(this.options.cancel).length:!1;return e&&!f&&this._mouseCapture(b)?(this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout(function(){d.mouseDelayMet=!0},this.options.delay)),this._mouseDistanceMet(b)&&this._mouseDelayMet(b)&&(this._mouseStarted=this._mouseStart(b)!==!1,!this._mouseStarted)?(b.preventDefault(),!0):(!0===a.data(b.target,this.widgetName+".preventClickEvent")&&a.removeData(b.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate=function(a){return d._mouseMove(a)},this._mouseUpDelegate=function(a){return d._mouseUp(a)},a(document).bind("mousemove."+this.widgetName,this._mouseMoveDelegate).bind("mouseup."+this.widgetName,this._mouseUpDelegate),b.preventDefault(),c=!0,!0)):!0}},_mouseMove:function(b){return!a.browser.msie||document.documentMode>=9||b.button?this._mouseStarted?(this._mouseDrag(b),b.preventDefault()):(this._mouseDistanceMet(b)&&this._mouseDelayMet(b)&&(this._mouseStarted=this._mouseStart(this._mouseDownEvent,b)!==!1,this._mouseStarted?this._mouseDrag(b):this._mouseUp(b)),!this._mouseStarted):this._mouseUp(b)},_mouseUp:function(b){return a(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate),this._mouseStarted&&(this._mouseStarted=!1,b.target==this._mouseDownEvent.target&&a.data(b.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(b)),!1},_mouseDistanceMet:function(a){return Math.max(Math.abs(this._mouseDownEvent.pageX-a.pageX),Math.abs(this._mouseDownEvent.pageY-a.pageY))>=this.options.distance},_mouseDelayMet:function(a){return this.mouseDelayMet},_mouseStart:function(a){},_mouseDrag:function(a){},_mouseStop:function(a){},_mouseCapture:function(a){return!0}})}(jQuery),function(a,b){a.ui=a.ui||{};var c=/left|center|right/,d=/top|center|bottom/,e="center",f={},g=a.fn.position,h=a.fn.offset;a.fn.position=function(b){if(!b||!b.of)return g.apply(this,arguments);b=a.extend({},b);var h,i,j,k=a(b.of),l=k[0],m=(b.collision||"flip").split(" "),n=b.offset?b.offset.split(" "):[0,0];return 9===l.nodeType?(h=k.width(),i=k.height(),j={top:0,left:0}):l.setTimeout?(h=k.width(),i=k.height(),j={top:k.scrollTop(),left:k.scrollLeft()}):l.preventDefault?(b.at="left top",h=i=0,j={top:b.of.pageY,left:b.of.pageX}):(h=k.outerWidth(),i=k.outerHeight(),j=k.offset()),a.each(["my","at"],function(){var a=(b[this]||"").split(" ");1===a.length&&(a=c.test(a[0])?a.concat([e]):d.test(a[0])?[e].concat(a):[e,e]),a[0]=c.test(a[0])?a[0]:e,a[1]=d.test(a[1])?a[1]:e,b[this]=a}),1===m.length&&(m[1]=m[0]),n[0]=parseInt(n[0],10)||0,1===n.length&&(n[1]=n[0]),n[1]=parseInt(n[1],10)||0,"right"===b.at[0]?j.left+=h:b.at[0]===e&&(j.left+=h/2),"bottom"===b.at[1]?j.top+=i:b.at[1]===e&&(j.top+=i/2),j.left+=n[0],j.top+=n[1],this.each(function(){var c,d=a(this),g=d.outerWidth(),k=d.outerHeight(),l=parseInt(a.curCSS(this,"marginLeft",!0))||0,o=parseInt(a.curCSS(this,"marginTop",!0))||0,p=g+l+(parseInt(a.curCSS(this,"marginRight",!0))||0),q=k+o+(parseInt(a.curCSS(this,"marginBottom",!0))||0),r=a.extend({},j);"right"===b.my[0]?r.left-=g:b.my[0]===e&&(r.left-=g/2),"bottom"===b.my[1]?r.top-=k:b.my[1]===e&&(r.top-=k/2),f.fractions||(r.left=Math.round(r.left),r.top=Math.round(r.top)),c={left:r.left-l,top:r.top-o},a.each(["left","top"],function(d,e){a.ui.position[m[d]]&&a.ui.position[m[d]][e](r,{targetWidth:h,targetHeight:i,elemWidth:g,elemHeight:k,collisionPosition:c,collisionWidth:p,collisionHeight:q,offset:n,my:b.my,at:b.at})}),a.fn.bgiframe&&d.bgiframe(),d.offset(a.extend(r,{using:b.using}))})},a.ui.position={fit:{left:function(b,c){var d=a(window),e=c.collisionPosition.left+c.collisionWidth-d.width()-d.scrollLeft();b.left=e>0?b.left-e:Math.max(b.left-c.collisionPosition.left,b.left)},top:function(b,c){var d=a(window),e=c.collisionPosition.top+c.collisionHeight-d.height()-d.scrollTop();b.top=e>0?b.top-e:Math.max(b.top-c.collisionPosition.top,b.top)}},flip:{left:function(b,c){if(c.at[0]!==e){var d=a(window),f=c.collisionPosition.left+c.collisionWidth-d.width()-d.scrollLeft(),g="left"===c.my[0]?-c.elemWidth:"right"===c.my[0]?c.elemWidth:0,h="left"===c.at[0]?c.targetWidth:-c.targetWidth,i=-2*c.offset[0];b.left+=c.collisionPosition.left<0?g+h+i:f>0?g+h+i:0}},top:function(b,c){if(c.at[1]!==e){var d=a(window),f=c.collisionPosition.top+c.collisionHeight-d.height()-d.scrollTop(),g="top"===c.my[1]?-c.elemHeight:"bottom"===c.my[1]?c.elemHeight:0,h="top"===c.at[1]?c.targetHeight:-c.targetHeight,i=-2*c.offset[1];b.top+=c.collisionPosition.top<0?g+h+i:f>0?g+h+i:0}}}},a.offset.setOffset||(a.offset.setOffset=function(b,c){/static/.test(a.curCSS(b,"position"))&&(b.style.position="relative");var d=a(b),e=d.offset(),f=parseInt(a.curCSS(b,"top",!0),10)||0,g=parseInt(a.curCSS(b,"left",!0),10)||0,h={top:c.top-e.top+f,left:c.left-e.left+g};"using"in c?c.using.call(b,h):d.css(h)},a.fn.offset=function(b){var c=this[0];return c&&c.ownerDocument?b?a.isFunction(b)?this.each(function(c){a(this).offset(b.call(this,c,a(this).offset()))}):this.each(function(){a.offset.setOffset(this,b)}):h.call(this):null}),a.curCSS||(a.curCSS=a.css),function(){var b,c,d,e,g,h=document.getElementsByTagName("body")[0],i=document.createElement("div");b=document.createElement(h?"div":"body"),d={visibility:"hidden",width:0,height:0,border:0,margin:0,background:"none"},h&&a.extend(d,{position:"absolute",left:"-1000px",top:"-1000px"});for(var j in d)b.style[j]=d[j];b.appendChild(i),c=h||document.documentElement,c.insertBefore(b,c.firstChild),i.style.cssText="position: absolute; left: 10.7432222px; top: 10.432325px; height: 30px; width: 201px;",e=a(i).offset(function(a,b){return b}).offset(),b.innerHTML="",c.removeChild(b),g=e.top+e.left+(h?2e3:0),f.fractions=g>21&&22>g}()}(jQuery),function(a,b){var c=5;a.widget("ui.slider",a.ui.mouse,{widgetEventPrefix:"slide",options:{animate:!1,distance:0,max:100,min:0,orientation:"horizontal",range:!1,step:1,value:0,values:null},_create:function(){var b=this,d=this.options,e=this.element.find(".ui-slider-handle").addClass("ui-state-default ui-corner-all"),f="<a class='ui-slider-handle ui-state-default ui-corner-all' href='#'></a>",g=d.values&&d.values.length||1,h=[];this._keySliding=!1,this._mouseSliding=!1,this._animateOff=!0,this._handleIndex=null,this._detectOrientation(),this._mouseInit(),this.element.addClass("ui-slider ui-slider-"+this.orientation+" ui-widget ui-widget-content ui-corner-all"+(d.disabled?" ui-slider-disabled ui-disabled":"")),this.range=a([]),d.range&&(d.range===!0&&(d.values||(d.values=[this._valueMin(),this._valueMin()]),d.values.length&&2!==d.values.length&&(d.values=[d.values[0],d.values[0]])),this.range=a("<div></div>").appendTo(this.element).addClass("ui-slider-range ui-widget-header"+("min"===d.range||"max"===d.range?" ui-slider-range-"+d.range:"")));for(var i=e.length;g>i;i+=1)h.push(f);this.handles=e.add(a(h.join("")).appendTo(b.element)),this.handle=this.handles.eq(0),this.handles.add(this.range).filter("a").click(function(a){a.preventDefault()}).hover(function(){d.disabled||a(this).addClass("ui-state-hover")},function(){a(this).removeClass("ui-state-hover")}).focus(function(){d.disabled?a(this).blur():(a(".ui-slider .ui-state-focus").removeClass("ui-state-focus"),a(this).addClass("ui-state-focus"))}).blur(function(){a(this).removeClass("ui-state-focus")}),this.handles.each(function(b){a(this).data("index.ui-slider-handle",b)}),this.handles.keydown(function(d){var e,f,g,h,i=a(this).data("index.ui-slider-handle");if(!b.options.disabled){switch(d.keyCode){case a.ui.keyCode.HOME:case a.ui.keyCode.END:case a.ui.keyCode.PAGE_UP:case a.ui.keyCode.PAGE_DOWN:case a.ui.keyCode.UP:case a.ui.keyCode.RIGHT:case a.ui.keyCode.DOWN:case a.ui.keyCode.LEFT:if(d.preventDefault(),!b._keySliding&&(b._keySliding=!0,a(this).addClass("ui-state-active"),e=b._start(d,i),e===!1))return}switch(h=b.options.step,f=g=b.options.values&&b.options.values.length?b.values(i):b.value(),d.keyCode){case a.ui.keyCode.HOME:g=b._valueMin();break;case a.ui.keyCode.END:g=b._valueMax();break;case a.ui.keyCode.PAGE_UP:g=b._trimAlignValue(f+(b._valueMax()-b._valueMin())/c);break;case a.ui.keyCode.PAGE_DOWN:g=b._trimAlignValue(f-(b._valueMax()-b._valueMin())/c);break;case a.ui.keyCode.UP:case a.ui.keyCode.RIGHT:if(f===b._valueMax())return;g=b._trimAlignValue(f+h);break;case a.ui.keyCode.DOWN:case a.ui.keyCode.LEFT:if(f===b._valueMin())return;g=b._trimAlignValue(f-h)}b._slide(d,i,g)}}).keyup(function(c){var d=a(this).data("index.ui-slider-handle");b._keySliding&&(b._keySliding=!1,b._stop(c,d),b._change(c,d),a(this).removeClass("ui-state-active"))}),this._refreshValue(),this._animateOff=!1},destroy:function(){return this.handles.remove(),this.range.remove(),this.element.removeClass("ui-slider ui-slider-horizontal ui-slider-vertical ui-slider-disabled ui-widget ui-widget-content ui-corner-all").removeData("slider").unbind(".slider"),this._mouseDestroy(),this},_mouseCapture:function(b){var c,d,e,f,g,h,i,j,k,l=this.options;return l.disabled?!1:(this.elementSize={width:this.element.outerWidth(),height:this.element.outerHeight()},this.elementOffset=this.element.offset(),c={x:b.pageX,y:b.pageY},d=this._normValueFromMouse(c),e=this._valueMax()-this._valueMin()+1,g=this,this.handles.each(function(b){var c=Math.abs(d-g.values(b));e>c&&(e=c,f=a(this),h=b)}),l.range===!0&&this.values(1)===l.min&&(h+=1,f=a(this.handles[h])),i=this._start(b,h),i===!1?!1:(this._mouseSliding=!0,g._handleIndex=h,f.addClass("ui-state-active").focus(),j=f.offset(),k=!a(b.target).parents().andSelf().is(".ui-slider-handle"),this._clickOffset=k?{left:0,top:0}:{left:b.pageX-j.left-f.width()/2,top:b.pageY-j.top-f.height()/2-(parseInt(f.css("borderTopWidth"),10)||0)-(parseInt(f.css("borderBottomWidth"),10)||0)+(parseInt(f.css("marginTop"),10)||0)},this.handles.hasClass("ui-state-hover")||this._slide(b,h,d),this._animateOff=!0,!0))},_mouseStart:function(a){return!0},_mouseDrag:function(a){var b={x:a.pageX,y:a.pageY},c=this._normValueFromMouse(b);return this._slide(a,this._handleIndex,c),!1},_mouseStop:function(a){return this.handles.removeClass("ui-state-active"),this._mouseSliding=!1,this._stop(a,this._handleIndex),this._change(a,this._handleIndex),this._handleIndex=null,this._clickOffset=null,this._animateOff=!1,!1},_detectOrientation:function(){this.orientation="vertical"===this.options.orientation?"vertical":"horizontal"},_normValueFromMouse:function(a){var b,c,d,e,f;return"horizontal"===this.orientation?(b=this.elementSize.width,c=a.x-this.elementOffset.left-(this._clickOffset?this._clickOffset.left:0)):(b=this.elementSize.height,c=a.y-this.elementOffset.top-(this._clickOffset?this._clickOffset.top:0)),d=c/b,d>1&&(d=1),0>d&&(d=0),"vertical"===this.orientation&&(d=1-d),e=this._valueMax()-this._valueMin(),f=this._valueMin()+d*e,this._trimAlignValue(f)},_start:function(a,b){var c={handle:this.handles[b],value:this.value()};return this.options.values&&this.options.values.length&&(c.value=this.values(b),c.values=this.values()),this._trigger("start",a,c)},_slide:function(a,b,c){var d,e,f;this.options.values&&this.options.values.length?(d=this.values(b?0:1),2===this.options.values.length&&this.options.range===!0&&(0===b&&c>d||1===b&&d>c)&&(c=d),c!==this.values(b)&&(e=this.values(),e[b]=c,f=this._trigger("slide",a,{handle:this.handles[b],value:c,values:e}),d=this.values(b?0:1),f!==!1&&this.values(b,c,!0))):c!==this.value()&&(f=this._trigger("slide",a,{handle:this.handles[b],value:c}),f!==!1&&this.value(c))},_stop:function(a,b){var c={handle:this.handles[b],value:this.value()};this.options.values&&this.options.values.length&&(c.value=this.values(b),c.values=this.values()),this._trigger("stop",a,c)},_change:function(a,b){if(!this._keySliding&&!this._mouseSliding){var c={handle:this.handles[b],value:this.value()};this.options.values&&this.options.values.length&&(c.value=this.values(b),c.values=this.values()),this._trigger("change",a,c)}},value:function(a){return arguments.length?(this.options.value=this._trimAlignValue(a),this._refreshValue(),void this._change(null,0)):this._value()},values:function(b,c){var d,e,f;if(arguments.length>1)return this.options.values[b]=this._trimAlignValue(c),this._refreshValue(),void this._change(null,b);if(!arguments.length)return this._values();if(!a.isArray(arguments[0]))return this.options.values&&this.options.values.length?this._values(b):this.value();for(d=this.options.values,e=arguments[0],f=0;f<d.length;f+=1)d[f]=this._trimAlignValue(e[f]),this._change(null,f);this._refreshValue()},_setOption:function(b,c){var d,e=0;switch(a.isArray(this.options.values)&&(e=this.options.values.length),a.Widget.prototype._setOption.apply(this,arguments),b){case"disabled":c?(this.handles.filter(".ui-state-focus").blur(),this.handles.removeClass("ui-state-hover"),this.handles.propAttr("disabled",!0),this.element.addClass("ui-disabled")):(this.handles.propAttr("disabled",!1),this.element.removeClass("ui-disabled"));break;case"orientation":this._detectOrientation(),this.element.removeClass("ui-slider-horizontal ui-slider-vertical").addClass("ui-slider-"+this.orientation),this._refreshValue();break;case"value":this._animateOff=!0,this._refreshValue(),this._change(null,0),this._animateOff=!1;break;case"values":for(this._animateOff=!0,this._refreshValue(),d=0;e>d;d+=1)this._change(null,d);this._animateOff=!1}},_value:function(){var a=this.options.value;return a=this._trimAlignValue(a)},_values:function(a){var b,c,d;if(arguments.length)return b=this.options.values[a],b=this._trimAlignValue(b);for(c=this.options.values.slice(),d=0;d<c.length;d+=1)c[d]=this._trimAlignValue(c[d]);return c},_trimAlignValue:function(a){if(a<=this._valueMin())return this._valueMin();if(a>=this._valueMax())return this._valueMax();var b=this.options.step>0?this.options.step:1,c=(a-this._valueMin())%b,d=a-c;return 2*Math.abs(c)>=b&&(d+=c>0?b:-b),parseFloat(d.toFixed(5))},_valueMin:function(){return this.options.min},_valueMax:function(){return this.options.max},_refreshValue:function(){var b,c,d,e,f,g=this.options.range,h=this.options,i=this,j=this._animateOff?!1:h.animate,k={};this.options.values&&this.options.values.length?this.handles.each(function(d,e){b=(i.values(d)-i._valueMin())/(i._valueMax()-i._valueMin())*100,k["horizontal"===i.orientation?"left":"bottom"]=b+"%",a(this).stop(1,1)[j?"animate":"css"](k,h.animate),i.options.range===!0&&("horizontal"===i.orientation?(0===d&&i.range.stop(1,1)[j?"animate":"css"]({left:b+"%"},h.animate),1===d&&i.range[j?"animate":"css"]({width:b-c+"%"},{queue:!1,duration:h.animate})):(0===d&&i.range.stop(1,1)[j?"animate":"css"]({bottom:b+"%"},h.animate),1===d&&i.range[j?"animate":"css"]({height:b-c+"%"},{queue:!1,duration:h.animate}))),c=b}):(d=this.value(),e=this._valueMin(),f=this._valueMax(),b=f!==e?(d-e)/(f-e)*100:0,k["horizontal"===i.orientation?"left":"bottom"]=b+"%",this.handle.stop(1,1)[j?"animate":"css"](k,h.animate),"min"===g&&"horizontal"===this.orientation&&this.range.stop(1,1)[j?"animate":"css"]({width:b+"%"},h.animate),"max"===g&&"horizontal"===this.orientation&&this.range[j?"animate":"css"]({width:100-b+"%"},{queue:!1,duration:h.animate}),"min"===g&&"vertical"===this.orientation&&this.range.stop(1,1)[j?"animate":"css"]({height:b+"%"},h.animate),"max"===g&&"vertical"===this.orientation&&this.range[j?"animate":"css"]({height:100-b+"%"},{queue:!1,duration:h.animate}))}}),a.extend(a.ui.slider,{version:"1.8.23"})}(jQuery),function(a,b){a.widget("ui.sortable",a.ui.mouse,{widgetEventPrefix:"sort",ready:!1,options:{appendTo:"parent",axis:!1,connectWith:!1,containment:!1,cursor:"auto",cursorAt:!1,dropOnEmpty:!0,forcePlaceholderSize:!1,forceHelperSize:!1,grid:!1,handle:!1,helper:"original",items:"> *",opacity:!1,placeholder:!1,revert:!1,scroll:!0,scrollSensitivity:20,scrollSpeed:20,scope:"default",tolerance:"intersect",zIndex:1e3},_create:function(){var a=this.options;this.containerCache={},this.element.addClass("ui-sortable"),this.refresh(),this.floating=this.items.length?"x"===a.axis||/left|right/.test(this.items[0].item.css("float"))||/inline|table-cell/.test(this.items[0].item.css("display")):!1,this.offset=this.element.offset(),this._mouseInit(),this.ready=!0},destroy:function(){a.Widget.prototype.destroy.call(this),this.element.removeClass("ui-sortable ui-sortable-disabled"),this._mouseDestroy();for(var b=this.items.length-1;b>=0;b--)this.items[b].item.removeData(this.widgetName+"-item");return this},_setOption:function(b,c){"disabled"===b?(this.options[b]=c,this.widget()[c?"addClass":"removeClass"]("ui-sortable-disabled")):a.Widget.prototype._setOption.apply(this,arguments)},_mouseCapture:function(b,c){var d=this;if(this.reverting)return!1;if(this.options.disabled||"static"==this.options.type)return!1;this._refreshItems(b);var e=null,f=this;a(b.target).parents().each(function(){return a.data(this,d.widgetName+"-item")==f?(e=a(this),!1):void 0});if(a.data(b.target,d.widgetName+"-item")==f&&(e=a(b.target)),!e)return!1;if(this.options.handle&&!c){var g=!1;if(a(this.options.handle,e).find("*").andSelf().each(function(){this==b.target&&(g=!0)}),!g)return!1}return this.currentItem=e,this._removeCurrentsFromItems(),!0},_mouseStart:function(b,c,d){var e=this.options,f=this;if(this.currentContainer=this,this.refreshPositions(),this.helper=this._createHelper(b),this._cacheHelperProportions(),this._cacheMargins(),this.scrollParent=this.helper.scrollParent(),this.offset=this.currentItem.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},a.extend(this.offset,{click:{left:b.pageX-this.offset.left,top:b.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.helper.css("position","absolute"),this.cssPosition=this.helper.css("position"),this.originalPosition=this._generatePosition(b),this.originalPageX=b.pageX,this.originalPageY=b.pageY,e.cursorAt&&this._adjustOffsetFromHelper(e.cursorAt),this.domPosition={prev:this.currentItem.prev()[0],parent:this.currentItem.parent()[0]},this.helper[0]!=this.currentItem[0]&&this.currentItem.hide(),this._createPlaceholder(),e.containment&&this._setContainment(),e.cursor&&(a("body").css("cursor")&&(this._storedCursor=a("body").css("cursor")),a("body").css("cursor",e.cursor)),e.opacity&&(this.helper.css("opacity")&&(this._storedOpacity=this.helper.css("opacity")),this.helper.css("opacity",e.opacity)),e.zIndex&&(this.helper.css("zIndex")&&(this._storedZIndex=this.helper.css("zIndex")),this.helper.css("zIndex",e.zIndex)),this.scrollParent[0]!=document&&"HTML"!=this.scrollParent[0].tagName&&(this.overflowOffset=this.scrollParent.offset()),this._trigger("start",b,this._uiHash()),this._preserveHelperProportions||this._cacheHelperProportions(),!d)for(var g=this.containers.length-1;g>=0;g--)this.containers[g]._trigger("activate",b,f._uiHash(this));return a.ui.ddmanager&&(a.ui.ddmanager.current=this),a.ui.ddmanager&&!e.dropBehaviour&&a.ui.ddmanager.prepareOffsets(this,b),this.dragging=!0,this.helper.addClass("ui-sortable-helper"),this._mouseDrag(b),!0},_mouseDrag:function(b){if(this.position=this._generatePosition(b),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll){var c=this.options,d=!1;this.scrollParent[0]!=document&&"HTML"!=this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-b.pageY<c.scrollSensitivity?this.scrollParent[0].scrollTop=d=this.scrollParent[0].scrollTop+c.scrollSpeed:b.pageY-this.overflowOffset.top<c.scrollSensitivity&&(this.scrollParent[0].scrollTop=d=this.scrollParent[0].scrollTop-c.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-b.pageX<c.scrollSensitivity?this.scrollParent[0].scrollLeft=d=this.scrollParent[0].scrollLeft+c.scrollSpeed:b.pageX-this.overflowOffset.left<c.scrollSensitivity&&(this.scrollParent[0].scrollLeft=d=this.scrollParent[0].scrollLeft-c.scrollSpeed)):(b.pageY-a(document).scrollTop()<c.scrollSensitivity?d=a(document).scrollTop(a(document).scrollTop()-c.scrollSpeed):a(window).height()-(b.pageY-a(document).scrollTop())<c.scrollSensitivity&&(d=a(document).scrollTop(a(document).scrollTop()+c.scrollSpeed)),b.pageX-a(document).scrollLeft()<c.scrollSensitivity?d=a(document).scrollLeft(a(document).scrollLeft()-c.scrollSpeed):a(window).width()-(b.pageX-a(document).scrollLeft())<c.scrollSensitivity&&(d=a(document).scrollLeft(a(document).scrollLeft()+c.scrollSpeed))),d!==!1&&a.ui.ddmanager&&!c.dropBehaviour&&a.ui.ddmanager.prepareOffsets(this,b)}this.positionAbs=this._convertPositionTo("absolute"),this.options.axis&&"y"==this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"==this.options.axis||(this.helper[0].style.top=this.position.top+"px");for(var e=this.items.length-1;e>=0;e--){var f=this.items[e],g=f.item[0],h=this._intersectsWithPointer(f);if(h&&g!=this.currentItem[0]&&this.placeholder[1==h?"next":"prev"]()[0]!=g&&!a.ui.contains(this.placeholder[0],g)&&("semi-dynamic"==this.options.type?!a.ui.contains(this.element[0],g):!0)){if(this.direction=1==h?"down":"up","pointer"!=this.options.tolerance&&!this._intersectsWithSides(f))break;this._rearrange(b,f),this._trigger("change",b,this._uiHash());break}}return this._contactContainers(b),a.ui.ddmanager&&a.ui.ddmanager.drag(this,b),this._trigger("sort",b,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(b,c){if(b){if(a.ui.ddmanager&&!this.options.dropBehaviour&&a.ui.ddmanager.drop(this,b),this.options.revert){var d=this,e=d.placeholder.offset();d.reverting=!0,a(this.helper).animate({left:e.left-this.offset.parent.left-d.margins.left+(this.offsetParent[0]==document.body?0:this.offsetParent[0].scrollLeft),top:e.top-this.offset.parent.top-d.margins.top+(this.offsetParent[0]==document.body?0:this.offsetParent[0].scrollTop)},parseInt(this.options.revert,10)||500,function(){d._clear(b)})}else this._clear(b,c);return!1}},cancel:function(){var b=this;if(this.dragging){this._mouseUp({target:null}),"original"==this.options.helper?this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper"):this.currentItem.show();for(var c=this.containers.length-1;c>=0;c--)this.containers[c]._trigger("deactivate",null,b._uiHash(this)),this.containers[c].containerCache.over&&(this.containers[c]._trigger("out",null,b._uiHash(this)),this.containers[c].containerCache.over=0)}return this.placeholder&&(this.placeholder[0].parentNode&&this.placeholder[0].parentNode.removeChild(this.placeholder[0]),"original"!=this.options.helper&&this.helper&&this.helper[0].parentNode&&this.helper.remove(),a.extend(this,{helper:null,dragging:!1,reverting:!1,_noFinalSort:null}),this.domPosition.prev?a(this.domPosition.prev).after(this.currentItem):a(this.domPosition.parent).prepend(this.currentItem)),this},serialize:function(b){var c=this._getItemsAsjQuery(b&&b.connected),d=[];return b=b||{},a(c).each(function(){var c=(a(b.item||this).attr(b.attribute||"id")||"").match(b.expression||/(.+)[-=_](.+)/);c&&d.push((b.key||c[1]+"[]")+"="+(b.key&&b.expression?c[1]:c[2]))}),!d.length&&b.key&&d.push(b.key+"="),d.join("&")},toArray:function(b){var c=this._getItemsAsjQuery(b&&b.connected),d=[];return b=b||{},c.each(function(){d.push(a(b.item||this).attr(b.attribute||"id")||"")}),d},_intersectsWith:function(a){var b=this.positionAbs.left,c=b+this.helperProportions.width,d=this.positionAbs.top,e=d+this.helperProportions.height,f=a.left,g=f+a.width,h=a.top,i=h+a.height,j=this.offset.click.top,k=this.offset.click.left,l=d+j>h&&i>d+j&&b+k>f&&g>b+k;return"pointer"==this.options.tolerance||this.options.forcePointerForContainers||"pointer"!=this.options.tolerance&&this.helperProportions[this.floating?"width":"height"]>a[this.floating?"width":"height"]?l:f<b+this.helperProportions.width/2&&c-this.helperProportions.width/2<g&&h<d+this.helperProportions.height/2&&e-this.helperProportions.height/2<i},_intersectsWithPointer:function(b){var c="x"===this.options.axis||a.ui.isOverAxis(this.positionAbs.top+this.offset.click.top,b.top,b.height),d="y"===this.options.axis||a.ui.isOverAxis(this.positionAbs.left+this.offset.click.left,b.left,b.width),e=c&&d,f=this._getDragVerticalDirection(),g=this._getDragHorizontalDirection();return e?this.floating?g&&"right"==g||"down"==f?2:1:f&&("down"==f?2:1):!1;
},_intersectsWithSides:function(b){var c=a.ui.isOverAxis(this.positionAbs.top+this.offset.click.top,b.top+b.height/2,b.height),d=a.ui.isOverAxis(this.positionAbs.left+this.offset.click.left,b.left+b.width/2,b.width),e=this._getDragVerticalDirection(),f=this._getDragHorizontalDirection();return this.floating&&f?"right"==f&&d||"left"==f&&!d:e&&("down"==e&&c||"up"==e&&!c)},_getDragVerticalDirection:function(){var a=this.positionAbs.top-this.lastPositionAbs.top;return 0!=a&&(a>0?"down":"up")},_getDragHorizontalDirection:function(){var a=this.positionAbs.left-this.lastPositionAbs.left;return 0!=a&&(a>0?"right":"left")},refresh:function(a){return this._refreshItems(a),this.refreshPositions(),this},_connectWith:function(){var a=this.options;return a.connectWith.constructor==String?[a.connectWith]:a.connectWith},_getItemsAsjQuery:function(b){var c=[],d=[],e=this._connectWith();if(e&&b)for(var f=e.length-1;f>=0;f--)for(var g=a(e[f]),h=g.length-1;h>=0;h--){var i=a.data(g[h],this.widgetName);i&&i!=this&&!i.options.disabled&&d.push([a.isFunction(i.options.items)?i.options.items.call(i.element):a(i.options.items,i.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),i])}d.push([a.isFunction(this.options.items)?this.options.items.call(this.element,null,{options:this.options,item:this.currentItem}):a(this.options.items,this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),this]);for(var f=d.length-1;f>=0;f--)d[f][0].each(function(){c.push(this)});return a(c)},_removeCurrentsFromItems:function(){for(var a=this.currentItem.find(":data("+this.widgetName+"-item)"),b=0;b<this.items.length;b++)for(var c=0;c<a.length;c++)a[c]==this.items[b].item[0]&&this.items.splice(b,1)},_refreshItems:function(b){this.items=[],this.containers=[this];var c=this.items,d=[[a.isFunction(this.options.items)?this.options.items.call(this.element[0],b,{item:this.currentItem}):a(this.options.items,this.element),this]],e=this._connectWith();if(e&&this.ready)for(var f=e.length-1;f>=0;f--)for(var g=a(e[f]),h=g.length-1;h>=0;h--){var i=a.data(g[h],this.widgetName);i&&i!=this&&!i.options.disabled&&(d.push([a.isFunction(i.options.items)?i.options.items.call(i.element[0],b,{item:this.currentItem}):a(i.options.items,i.element),i]),this.containers.push(i))}for(var f=d.length-1;f>=0;f--)for(var j=d[f][1],k=d[f][0],h=0,l=k.length;l>h;h++){var m=a(k[h]);m.data(this.widgetName+"-item",j),c.push({item:m,instance:j,width:0,height:0,left:0,top:0})}},refreshPositions:function(b){this.offsetParent&&this.helper&&(this.offset.parent=this._getParentOffset());for(var c=this.items.length-1;c>=0;c--){var d=this.items[c];if(d.instance==this.currentContainer||!this.currentContainer||d.item[0]==this.currentItem[0]){var e=this.options.toleranceElement?a(this.options.toleranceElement,d.item):d.item;b||(d.width=e.outerWidth(),d.height=e.outerHeight());var f=e.offset();d.left=f.left,d.top=f.top}}if(this.options.custom&&this.options.custom.refreshContainers)this.options.custom.refreshContainers.call(this);else for(var c=this.containers.length-1;c>=0;c--){var f=this.containers[c].element.offset();this.containers[c].containerCache.left=f.left,this.containers[c].containerCache.top=f.top,this.containers[c].containerCache.width=this.containers[c].element.outerWidth(),this.containers[c].containerCache.height=this.containers[c].element.outerHeight()}return this},_createPlaceholder:function(b){var c=b||this,d=c.options;if(!d.placeholder||d.placeholder.constructor==String){var e=d.placeholder;d.placeholder={element:function(){var b=a(document.createElement(c.currentItem[0].nodeName)).addClass(e||c.currentItem[0].className+" ui-sortable-placeholder").removeClass("ui-sortable-helper")[0];return e||(b.style.visibility="hidden"),b},update:function(a,b){(!e||d.forcePlaceholderSize)&&(b.height()||b.height(c.currentItem.innerHeight()-parseInt(c.currentItem.css("paddingTop")||0,10)-parseInt(c.currentItem.css("paddingBottom")||0,10)),b.width()||b.width(c.currentItem.innerWidth()-parseInt(c.currentItem.css("paddingLeft")||0,10)-parseInt(c.currentItem.css("paddingRight")||0,10)))}}}c.placeholder=a(d.placeholder.element.call(c.element,c.currentItem)),c.currentItem.after(c.placeholder),d.placeholder.update(c,c.placeholder)},_contactContainers:function(b){for(var c=null,d=null,e=this.containers.length-1;e>=0;e--)if(!a.ui.contains(this.currentItem[0],this.containers[e].element[0]))if(this._intersectsWith(this.containers[e].containerCache)){if(c&&a.ui.contains(this.containers[e].element[0],c.element[0]))continue;c=this.containers[e],d=e}else this.containers[e].containerCache.over&&(this.containers[e]._trigger("out",b,this._uiHash(this)),this.containers[e].containerCache.over=0);if(c)if(1===this.containers.length)this.containers[d]._trigger("over",b,this._uiHash(this)),this.containers[d].containerCache.over=1;else if(this.currentContainer!=this.containers[d]){for(var f=1e4,g=null,h=this.positionAbs[this.containers[d].floating?"left":"top"],i=this.items.length-1;i>=0;i--)if(a.ui.contains(this.containers[d].element[0],this.items[i].item[0])){var j=this.containers[d].floating?this.items[i].item.offset().left:this.items[i].item.offset().top;Math.abs(j-h)<f&&(f=Math.abs(j-h),g=this.items[i],this.direction=j-h>0?"down":"up")}if(!g&&!this.options.dropOnEmpty)return;this.currentContainer=this.containers[d],g?this._rearrange(b,g,null,!0):this._rearrange(b,null,this.containers[d].element,!0),this._trigger("change",b,this._uiHash()),this.containers[d]._trigger("change",b,this._uiHash(this)),this.options.placeholder.update(this.currentContainer,this.placeholder),this.containers[d]._trigger("over",b,this._uiHash(this)),this.containers[d].containerCache.over=1}},_createHelper:function(b){var c=this.options,d=a.isFunction(c.helper)?a(c.helper.apply(this.element[0],[b,this.currentItem])):"clone"==c.helper?this.currentItem.clone():this.currentItem;return d.parents("body").length||a("parent"!=c.appendTo?c.appendTo:this.currentItem[0].parentNode)[0].appendChild(d[0]),d[0]==this.currentItem[0]&&(this._storedCSS={width:this.currentItem[0].style.width,height:this.currentItem[0].style.height,position:this.currentItem.css("position"),top:this.currentItem.css("top"),left:this.currentItem.css("left")}),(""==d[0].style.width||c.forceHelperSize)&&d.width(this.currentItem.width()),(""==d[0].style.height||c.forceHelperSize)&&d.height(this.currentItem.height()),d},_adjustOffsetFromHelper:function(b){"string"==typeof b&&(b=b.split(" ")),a.isArray(b)&&(b={left:+b[0],top:+b[1]||0}),"left"in b&&(this.offset.click.left=b.left+this.margins.left),"right"in b&&(this.offset.click.left=this.helperProportions.width-b.right+this.margins.left),"top"in b&&(this.offset.click.top=b.top+this.margins.top),"bottom"in b&&(this.offset.click.top=this.helperProportions.height-b.bottom+this.margins.top)},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var b=this.offsetParent.offset();return"absolute"==this.cssPosition&&this.scrollParent[0]!=document&&a.ui.contains(this.scrollParent[0],this.offsetParent[0])&&(b.left+=this.scrollParent.scrollLeft(),b.top+=this.scrollParent.scrollTop()),(this.offsetParent[0]==document.body||this.offsetParent[0].tagName&&"html"==this.offsetParent[0].tagName.toLowerCase()&&a.browser.msie)&&(b={top:0,left:0}),{top:b.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:b.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if("relative"==this.cssPosition){var a=this.currentItem.position();return{top:a.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:a.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.currentItem.css("marginLeft"),10)||0,top:parseInt(this.currentItem.css("marginTop"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var b=this.options;if("parent"==b.containment&&(b.containment=this.helper[0].parentNode),("document"==b.containment||"window"==b.containment)&&(this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,a("document"==b.containment?document:window).width()-this.helperProportions.width-this.margins.left,(a("document"==b.containment?document:window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]),!/^(document|window|parent)$/.test(b.containment)){var c=a(b.containment)[0],d=a(b.containment).offset(),e="hidden"!=a(c).css("overflow");this.containment=[d.left+(parseInt(a(c).css("borderLeftWidth"),10)||0)+(parseInt(a(c).css("paddingLeft"),10)||0)-this.margins.left,d.top+(parseInt(a(c).css("borderTopWidth"),10)||0)+(parseInt(a(c).css("paddingTop"),10)||0)-this.margins.top,d.left+(e?Math.max(c.scrollWidth,c.offsetWidth):c.offsetWidth)-(parseInt(a(c).css("borderLeftWidth"),10)||0)-(parseInt(a(c).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,d.top+(e?Math.max(c.scrollHeight,c.offsetHeight):c.offsetHeight)-(parseInt(a(c).css("borderTopWidth"),10)||0)-(parseInt(a(c).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top]}},_convertPositionTo:function(b,c){c||(c=this.position);var d="absolute"==b?1:-1,e=(this.options,"absolute"!=this.cssPosition||this.scrollParent[0]!=document&&a.ui.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent),f=/(html|body)/i.test(e[0].tagName);return{top:c.top+this.offset.relative.top*d+this.offset.parent.top*d-(a.browser.safari&&"fixed"==this.cssPosition?0:("fixed"==this.cssPosition?-this.scrollParent.scrollTop():f?0:e.scrollTop())*d),left:c.left+this.offset.relative.left*d+this.offset.parent.left*d-(a.browser.safari&&"fixed"==this.cssPosition?0:("fixed"==this.cssPosition?-this.scrollParent.scrollLeft():f?0:e.scrollLeft())*d)}},_generatePosition:function(b){var c=this.options,d="absolute"!=this.cssPosition||this.scrollParent[0]!=document&&a.ui.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,e=/(html|body)/i.test(d[0].tagName);"relative"!=this.cssPosition||this.scrollParent[0]!=document&&this.scrollParent[0]!=this.offsetParent[0]||(this.offset.relative=this._getRelativeOffset());var f=b.pageX,g=b.pageY;if(this.originalPosition&&(this.containment&&(b.pageX-this.offset.click.left<this.containment[0]&&(f=this.containment[0]+this.offset.click.left),b.pageY-this.offset.click.top<this.containment[1]&&(g=this.containment[1]+this.offset.click.top),b.pageX-this.offset.click.left>this.containment[2]&&(f=this.containment[2]+this.offset.click.left),b.pageY-this.offset.click.top>this.containment[3]&&(g=this.containment[3]+this.offset.click.top)),c.grid)){var h=this.originalPageY+Math.round((g-this.originalPageY)/c.grid[1])*c.grid[1];g=this.containment&&(h-this.offset.click.top<this.containment[1]||h-this.offset.click.top>this.containment[3])?h-this.offset.click.top<this.containment[1]?h+c.grid[1]:h-c.grid[1]:h;var i=this.originalPageX+Math.round((f-this.originalPageX)/c.grid[0])*c.grid[0];f=this.containment&&(i-this.offset.click.left<this.containment[0]||i-this.offset.click.left>this.containment[2])?i-this.offset.click.left<this.containment[0]?i+c.grid[0]:i-c.grid[0]:i}return{top:g-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+(a.browser.safari&&"fixed"==this.cssPosition?0:"fixed"==this.cssPosition?-this.scrollParent.scrollTop():e?0:d.scrollTop()),left:f-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+(a.browser.safari&&"fixed"==this.cssPosition?0:"fixed"==this.cssPosition?-this.scrollParent.scrollLeft():e?0:d.scrollLeft())}},_rearrange:function(a,b,c,d){c?c[0].appendChild(this.placeholder[0]):b.item[0].parentNode.insertBefore(this.placeholder[0],"down"==this.direction?b.item[0]:b.item[0].nextSibling),this.counter=this.counter?++this.counter:1;var e=this,f=this.counter;window.setTimeout(function(){f==e.counter&&e.refreshPositions(!d)},0)},_clear:function(b,c){this.reverting=!1;var d=[];if(!this._noFinalSort&&this.currentItem.parent().length&&this.placeholder.before(this.currentItem),this._noFinalSort=null,this.helper[0]==this.currentItem[0]){for(var e in this._storedCSS)("auto"==this._storedCSS[e]||"static"==this._storedCSS[e])&&(this._storedCSS[e]="");this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else this.currentItem.show();if(this.fromOutside&&!c&&d.push(function(a){this._trigger("receive",a,this._uiHash(this.fromOutside))}),!this.fromOutside&&this.domPosition.prev==this.currentItem.prev().not(".ui-sortable-helper")[0]&&this.domPosition.parent==this.currentItem.parent()[0]||c||d.push(function(a){this._trigger("update",a,this._uiHash())}),!a.ui.contains(this.element[0],this.currentItem[0])){c||d.push(function(a){this._trigger("remove",a,this._uiHash())});for(var e=this.containers.length-1;e>=0;e--)a.ui.contains(this.containers[e].element[0],this.currentItem[0])&&!c&&(d.push(function(a){return function(b){a._trigger("receive",b,this._uiHash(this))}}.call(this,this.containers[e])),d.push(function(a){return function(b){a._trigger("update",b,this._uiHash(this))}}.call(this,this.containers[e])))}for(var e=this.containers.length-1;e>=0;e--)c||d.push(function(a){return function(b){a._trigger("deactivate",b,this._uiHash(this))}}.call(this,this.containers[e])),this.containers[e].containerCache.over&&(d.push(function(a){return function(b){a._trigger("out",b,this._uiHash(this))}}.call(this,this.containers[e])),this.containers[e].containerCache.over=0);if(this._storedCursor&&a("body").css("cursor",this._storedCursor),this._storedOpacity&&this.helper.css("opacity",this._storedOpacity),this._storedZIndex&&this.helper.css("zIndex","auto"==this._storedZIndex?"":this._storedZIndex),this.dragging=!1,this.cancelHelperRemoval){if(!c){this._trigger("beforeStop",b,this._uiHash());for(var e=0;e<d.length;e++)d[e].call(this,b);this._trigger("stop",b,this._uiHash())}return this.fromOutside=!1,!1}if(c||this._trigger("beforeStop",b,this._uiHash()),this.placeholder[0].parentNode&&this.placeholder[0].parentNode.removeChild(this.placeholder[0]),this.helper&&this.helper[0]!=this.currentItem[0]&&this.helper.remove(),this.helper=null,!c){for(var e=0;e<d.length;e++)d[e].call(this,b);this._trigger("stop",b,this._uiHash())}return this.fromOutside=!1,!0},_trigger:function(){a.Widget.prototype._trigger.apply(this,arguments)===!1&&this.cancel()},_uiHash:function(b){var c=b||this;return{helper:c.helper,placeholder:c.placeholder||a([]),position:c.position,originalPosition:c.originalPosition,offset:c.positionAbs,item:c.currentItem,sender:b?b.element:null}}}),a.extend(a.ui.sortable,{version:"1.8.23"})}(jQuery),function(a,b){if(a.cleanData){var c=a.cleanData;a.cleanData=function(b){for(var d,e=0;null!=(d=b[e]);e++)try{a(d).triggerHandler("remove")}catch(f){}c(b)}}else{var d=a.fn.remove;a.fn.remove=function(b,c){return this.each(function(){return c||(!b||a.filter(b,[this]).length)&&a("*",this).add([this]).each(function(){try{a(this).triggerHandler("remove")}catch(b){}}),d.call(a(this),b,c)})}}a.widget=function(b,c,d){var e,f=b.split(".")[0];b=b.split(".")[1],e=f+"-"+b,d||(d=c,c=a.Widget),a.expr[":"][e]=function(c){return!!a.data(c,b)},a[f]=a[f]||{},a[f][b]=function(a,b){arguments.length&&this._createWidget(a,b)};var g=new c;g.options=a.extend(!0,{},g.options),a[f][b].prototype=a.extend(!0,g,{namespace:f,widgetName:b,widgetEventPrefix:a[f][b].prototype.widgetEventPrefix||b,widgetBaseClass:e},d),a.widget.bridge(b,a[f][b])},a.widget.bridge=function(c,d){a.fn[c]=function(e){var f="string"==typeof e,g=Array.prototype.slice.call(arguments,1),h=this;return e=!f&&g.length?a.extend.apply(null,[!0,e].concat(g)):e,f&&"_"===e.charAt(0)?h:(f?this.each(function(){var d=a.data(this,c),f=d&&a.isFunction(d[e])?d[e].apply(d,g):d;return f!==d&&f!==b?(h=f,!1):void 0}):this.each(function(){var b=a.data(this,c);b?b.option(e||{})._init():a.data(this,c,new d(e,this))}),h)}},a.Widget=function(a,b){arguments.length&&this._createWidget(a,b)},a.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",options:{disabled:!1},_createWidget:function(b,c){a.data(c,this.widgetName,this),this.element=a(c),this.options=a.extend(!0,{},this.options,this._getCreateOptions(),b);var d=this;this.element.bind("remove."+this.widgetName,function(){d.destroy()}),this._create(),this._trigger("create"),this._init()},_getCreateOptions:function(){return a.metadata&&a.metadata.get(this.element[0])[this.widgetName]},_create:function(){},_init:function(){},destroy:function(){this.element.unbind("."+this.widgetName).removeData(this.widgetName),this.widget().unbind("."+this.widgetName).removeAttr("aria-disabled").removeClass(this.widgetBaseClass+"-disabled ui-state-disabled")},widget:function(){return this.element},option:function(c,d){var e=c;if(0===arguments.length)return a.extend({},this.options);if("string"==typeof c){if(d===b)return this.options[c];e={},e[c]=d}return this._setOptions(e),this},_setOptions:function(b){var c=this;return a.each(b,function(a,b){c._setOption(a,b)}),this},_setOption:function(a,b){return this.options[a]=b,"disabled"===a&&this.widget()[b?"addClass":"removeClass"](this.widgetBaseClass+"-disabled ui-state-disabled").attr("aria-disabled",b),this},enable:function(){return this._setOption("disabled",!1)},disable:function(){return this._setOption("disabled",!0)},_trigger:function(b,c,d){var e,f,g=this.options[b];if(d=d||{},c=a.Event(c),c.type=(b===this.widgetEventPrefix?b:this.widgetEventPrefix+b).toLowerCase(),c.target=this.element[0],f=c.originalEvent)for(e in f)e in c||(c[e]=f[e]);return this.element.trigger(c,d),!(a.isFunction(g)&&g.call(this.element[0],c,d)===!1||c.isDefaultPrevented())}}}(jQuery),function(a,b,c,d){a.fn.caret=function(e,f){var g,h,i=this[0],j=a.browser.msie;if("object"==typeof e&&"number"==typeof e.start&&"number"==typeof e.end)g=e.start,h=e.end;else if("number"==typeof e&&"number"==typeof f)g=e,h=f;else if("string"==typeof e)(g=i.value.indexOf(e))>-1?h=g+e[b]:g=null;else if("[object RegExp]"===Object.prototype.toString.call(e)){var k=e.exec(i.value);null!=k&&(g=k.index,h=g+k[0][b])}if("undefined"!=typeof g){if(j){var l=this[0].createTextRange();l.collapse(!0),l.moveStart("character",g),l.moveEnd("character",h-g),l.select()}else this[0].selectionStart=g,this[0].selectionEnd=h;return this[0].focus(),this}if(j){var m=document.selection;if("textarea"!=this[0].tagName.toLowerCase()){var n=this.val(),o=m[c]()[d]();o.moveEnd("character",n[b]);var p=""==o.text?n[b]:n.lastIndexOf(o.text);o=m[c]()[d](),o.moveStart("character",-n[b]);var q=o.text[b]}else{var o=m[c](),r=o[d]();r.moveToElementText(this[0]),r.setEndPoint("EndToEnd",o);var p=r.text[b]-o.text[b],q=p+o.text[b]}}else var p=i.selectionStart,q=i.selectionEnd;var s=i.value.substring(p,q);return{start:p,end:q,text:s,replace:function(a){return i.value.substring(0,p)+a+i.value.substring(q,i.value[b])}}}}(jQuery,"length","createRange","duplicate"),function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.moment=b()}(this,function(){"use strict";function a(){return Ac.apply(null,arguments)}function b(a){Ac=a}function c(){return{empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidMonth:null,invalidFormat:!1,userInvalidated:!1,iso:!1}}function d(a){return"[object Array]"===Object.prototype.toString.call(a)}function e(a){return"[object Date]"===Object.prototype.toString.call(a)||a instanceof Date}function f(a,b){var c,d=[];for(c=0;c<a.length;++c)d.push(b(a[c],c));return d}function g(a,b){return Object.prototype.hasOwnProperty.call(a,b)}function h(a,b){for(var c in b)g(b,c)&&(a[c]=b[c]);return g(b,"toString")&&(a.toString=b.toString),g(b,"valueOf")&&(a.valueOf=b.valueOf),a}function i(a,b,c,d){return ya(a,b,c,d,!0).utc()}function j(a){return null==a._isValid&&(a._isValid=!isNaN(a._d.getTime())&&a._pf.overflow<0&&!a._pf.empty&&!a._pf.invalidMonth&&!a._pf.nullInput&&!a._pf.invalidFormat&&!a._pf.userInvalidated,a._strict&&(a._isValid=a._isValid&&0===a._pf.charsLeftOver&&0===a._pf.unusedTokens.length&&void 0===a._pf.bigHour)),a._isValid}function k(a){var b=i(NaN);return null!=a?h(b._pf,a):b._pf.userInvalidated=!0,b}function l(a,b){var c,d,e;if("undefined"!=typeof b._isAMomentObject&&(a._isAMomentObject=b._isAMomentObject),"undefined"!=typeof b._i&&(a._i=b._i),"undefined"!=typeof b._f&&(a._f=b._f),"undefined"!=typeof b._l&&(a._l=b._l),"undefined"!=typeof b._strict&&(a._strict=b._strict),"undefined"!=typeof b._tzm&&(a._tzm=b._tzm),"undefined"!=typeof b._isUTC&&(a._isUTC=b._isUTC),"undefined"!=typeof b._offset&&(a._offset=b._offset),"undefined"!=typeof b._pf&&(a._pf=b._pf),"undefined"!=typeof b._locale&&(a._locale=b._locale),Cc.length>0)for(c in Cc)d=Cc[c],e=b[d],"undefined"!=typeof e&&(a[d]=e);return a}function m(b){l(this,b),this._d=new Date(+b._d),Dc===!1&&(Dc=!0,a.updateOffset(this),Dc=!1)}function n(a){return a instanceof m||null!=a&&g(a,"_isAMomentObject")}function o(a){var b=+a,c=0;return 0!==b&&isFinite(b)&&(c=b>=0?Math.floor(b):Math.ceil(b)),c}function p(a,b,c){var d,e=Math.min(a.length,b.length),f=Math.abs(a.length-b.length),g=0;for(d=0;e>d;d++)(c&&a[d]!==b[d]||!c&&o(a[d])!==o(b[d]))&&g++;return g+f}function q(){}function r(a){return a?a.toLowerCase().replace("_","-"):a}function s(a){for(var b,c,d,e,f=0;f<a.length;){for(e=r(a[f]).split("-"),b=e.length,c=r(a[f+1]),c=c?c.split("-"):null;b>0;){if(d=t(e.slice(0,b).join("-")))return d;if(c&&c.length>=b&&p(e,c,!0)>=b-1)break;b--}f++}return null}function t(a){var b=null;if(!Ec[a]&&"undefined"!=typeof module&&module&&module.exports)try{b=Bc._abbr,require("./locale/"+a),u(b)}catch(c){}return Ec[a]}function u(a,b){var c;return a&&(c="undefined"==typeof b?w(a):v(a,b),c&&(Bc=c)),Bc._abbr}function v(a,b){return null!==b?(b.abbr=a,Ec[a]||(Ec[a]=new q),Ec[a].set(b),u(a),Ec[a]):(delete Ec[a],null)}function w(a){var b;if(a&&a._locale&&a._locale._abbr&&(a=a._locale._abbr),!a)return Bc;if(!d(a)){if(b=t(a))return b;a=[a]}return s(a)}function x(a,b){var c=a.toLowerCase();Fc[c]=Fc[c+"s"]=Fc[b]=a}function y(a){return"string"==typeof a?Fc[a]||Fc[a.toLowerCase()]:void 0}function z(a){var b,c,d={};for(c in a)g(a,c)&&(b=y(c),b&&(d[b]=a[c]));return d}function A(b,c){return function(d){return null!=d?(C(this,b,d),a.updateOffset(this,c),this):B(this,b)}}function B(a,b){return a._d["get"+(a._isUTC?"UTC":"")+b]()}function C(a,b,c){return a._d["set"+(a._isUTC?"UTC":"")+b](c)}function D(a,b){var c;if("object"==typeof a)for(c in a)this.set(c,a[c]);else if(a=y(a),"function"==typeof this[a])return this[a](b);return this}function E(a,b,c){for(var d=""+Math.abs(a),e=a>=0;d.length<b;)d="0"+d;return(e?c?"+":"":"-")+d}function F(a,b,c,d){var e=d;"string"==typeof d&&(e=function(){return this[d]()}),a&&(Jc[a]=e),b&&(Jc[b[0]]=function(){return E(e.apply(this,arguments),b[1],b[2])}),c&&(Jc[c]=function(){return this.localeData().ordinal(e.apply(this,arguments),a)})}function G(a){return a.match(/\[[\s\S]/)?a.replace(/^\[|\]$/g,""):a.replace(/\\/g,"")}function H(a){var b,c,d=a.match(Gc);for(b=0,c=d.length;c>b;b++)Jc[d[b]]?d[b]=Jc[d[b]]:d[b]=G(d[b]);return function(e){var f="";for(b=0;c>b;b++)f+=d[b]instanceof Function?d[b].call(e,a):d[b];return f}}function I(a,b){return a.isValid()?(b=J(b,a.localeData()),Ic[b]||(Ic[b]=H(b)),Ic[b](a)):a.localeData().invalidDate()}function J(a,b){function c(a){return b.longDateFormat(a)||a}var d=5;for(Hc.lastIndex=0;d>=0&&Hc.test(a);)a=a.replace(Hc,c),Hc.lastIndex=0,d-=1;return a}function K(a,b,c){Yc[a]="function"==typeof b?b:function(a){return a&&c?c:b}}function L(a,b){return g(Yc,a)?Yc[a](b._strict,b._locale):new RegExp(M(a))}function M(a){return a.replace("\\","").replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(a,b,c,d,e){return b||c||d||e}).replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function N(a,b){var c,d=b;for("string"==typeof a&&(a=[a]),"number"==typeof b&&(d=function(a,c){c[b]=o(a)}),c=0;c<a.length;c++)Zc[a[c]]=d}function O(a,b){N(a,function(a,c,d,e){d._w=d._w||{},b(a,d._w,d,e)})}function P(a,b,c){null!=b&&g(Zc,a)&&Zc[a](b,c._a,c,a)}function Q(a,b){return new Date(Date.UTC(a,b+1,0)).getUTCDate()}function R(a){return this._months[a.month()]}function S(a){return this._monthsShort[a.month()]}function T(a,b,c){var d,e,f;for(this._monthsParse||(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[]),d=0;12>d;d++){if(e=i([2e3,d]),c&&!this._longMonthsParse[d]&&(this._longMonthsParse[d]=new RegExp("^"+this.months(e,"").replace(".","")+"$","i"),this._shortMonthsParse[d]=new RegExp("^"+this.monthsShort(e,"").replace(".","")+"$","i")),c||this._monthsParse[d]||(f="^"+this.months(e,"")+"|^"+this.monthsShort(e,""),this._monthsParse[d]=new RegExp(f.replace(".",""),"i")),c&&"MMMM"===b&&this._longMonthsParse[d].test(a))return d;if(c&&"MMM"===b&&this._shortMonthsParse[d].test(a))return d;if(!c&&this._monthsParse[d].test(a))return d}}function U(a,b){var c;return"string"==typeof b&&(b=a.localeData().monthsParse(b),"number"!=typeof b)?a:(c=Math.min(a.date(),Q(a.year(),b)),a._d["set"+(a._isUTC?"UTC":"")+"Month"](b,c),a)}function V(b){return null!=b?(U(this,b),a.updateOffset(this,!0),this):B(this,"Month")}function W(){return Q(this.year(),this.month())}function X(a){var b,c=a._a;return c&&-2===a._pf.overflow&&(b=c[_c]<0||c[_c]>11?_c:c[ad]<1||c[ad]>Q(c[$c],c[_c])?ad:c[bd]<0||c[bd]>24||24===c[bd]&&(0!==c[cd]||0!==c[dd]||0!==c[ed])?bd:c[cd]<0||c[cd]>59?cd:c[dd]<0||c[dd]>59?dd:c[ed]<0||c[ed]>999?ed:-1,a._pf._overflowDayOfYear&&($c>b||b>ad)&&(b=ad),a._pf.overflow=b),a}function Y(b){a.suppressDeprecationWarnings===!1&&"undefined"!=typeof console&&console.warn&&console.warn("Deprecation warning: "+b)}function Z(a,b){var c=!0;return h(function(){return c&&(Y(a),c=!1),b.apply(this,arguments)},b)}function $(a,b){hd[a]||(Y(b),hd[a]=!0)}function _(a){var b,c,d=a._i,e=id.exec(d);if(e){for(a._pf.iso=!0,b=0,c=jd.length;c>b;b++)if(jd[b][1].exec(d)){a._f=jd[b][0]+(e[6]||" ");break}for(b=0,c=kd.length;c>b;b++)if(kd[b][1].exec(d)){a._f+=kd[b][0];break}d.match(Vc)&&(a._f+="Z"),sa(a)}else a._isValid=!1}function aa(b){var c=ld.exec(b._i);return null!==c?void(b._d=new Date(+c[1])):(_(b),void(b._isValid===!1&&(delete b._isValid,a.createFromInputFallback(b))))}function ba(a,b,c,d,e,f,g){var h=new Date(a,b,c,d,e,f,g);return 1970>a&&h.setFullYear(a),h}function ca(a){var b=new Date(Date.UTC.apply(null,arguments));return 1970>a&&b.setUTCFullYear(a),b}function da(a){return ea(a)?366:365}function ea(a){return a%4===0&&a%100!==0||a%400===0}function fa(){return ea(this.year())}function ga(a,b,c){var d,e=c-b,f=c-a.day();return f>e&&(f-=7),e-7>f&&(f+=7),d=za(a).add(f,"d"),{week:Math.ceil(d.dayOfYear()/7),year:d.year()}}function ha(a){return ga(a,this._week.dow,this._week.doy).week}function ia(){return this._week.dow}function ja(){return this._week.doy}function ka(a){var b=this.localeData().week(this);return null==a?b:this.add(7*(a-b),"d")}function la(a){var b=ga(this,1,4).week;return null==a?b:this.add(7*(a-b),"d")}function ma(a,b,c,d,e){var f,g,h=ca(a,0,1).getUTCDay();return h=0===h?7:h,c=null!=c?c:e,f=e-h+(h>d?7:0)-(e>h?7:0),g=7*(b-1)+(c-e)+f+1,{year:g>0?a:a-1,dayOfYear:g>0?g:da(a-1)+g}}function na(a){var b=Math.round((this.clone().startOf("day")-this.clone().startOf("year"))/864e5)+1;return null==a?b:this.add(a-b,"d")}function oa(a,b,c){return null!=a?a:null!=b?b:c}function pa(a){var b=new Date;return a._useUTC?[b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate()]:[b.getFullYear(),b.getMonth(),b.getDate()]}function qa(a){var b,c,d,e,f=[];if(!a._d){for(d=pa(a),a._w&&null==a._a[ad]&&null==a._a[_c]&&ra(a),a._dayOfYear&&(e=oa(a._a[$c],d[$c]),a._dayOfYear>da(e)&&(a._pf._overflowDayOfYear=!0),c=ca(e,0,a._dayOfYear),a._a[_c]=c.getUTCMonth(),a._a[ad]=c.getUTCDate()),b=0;3>b&&null==a._a[b];++b)a._a[b]=f[b]=d[b];for(;7>b;b++)a._a[b]=f[b]=null==a._a[b]?2===b?1:0:a._a[b];24===a._a[bd]&&0===a._a[cd]&&0===a._a[dd]&&0===a._a[ed]&&(a._nextDay=!0,a._a[bd]=0),a._d=(a._useUTC?ca:ba).apply(null,f),null!=a._tzm&&a._d.setUTCMinutes(a._d.getUTCMinutes()-a._tzm),a._nextDay&&(a._a[bd]=24)}}function ra(a){var b,c,d,e,f,g,h;b=a._w,null!=b.GG||null!=b.W||null!=b.E?(f=1,g=4,c=oa(b.GG,a._a[$c],ga(za(),1,4).year),d=oa(b.W,1),e=oa(b.E,1)):(f=a._locale._week.dow,g=a._locale._week.doy,c=oa(b.gg,a._a[$c],ga(za(),f,g).year),d=oa(b.w,1),null!=b.d?(e=b.d,f>e&&++d):e=null!=b.e?b.e+f:f),h=ma(c,d,e,g,f),a._a[$c]=h.year,a._dayOfYear=h.dayOfYear}function sa(b){if(b._f===a.ISO_8601)return void _(b);b._a=[],b._pf.empty=!0;var c,d,e,f,g,h=""+b._i,i=h.length,j=0;for(e=J(b._f,b._locale).match(Gc)||[],c=0;c<e.length;c++)f=e[c],d=(h.match(L(f,b))||[])[0],d&&(g=h.substr(0,h.indexOf(d)),g.length>0&&b._pf.unusedInput.push(g),h=h.slice(h.indexOf(d)+d.length),j+=d.length),Jc[f]?(d?b._pf.empty=!1:b._pf.unusedTokens.push(f),P(f,d,b)):b._strict&&!d&&b._pf.unusedTokens.push(f);b._pf.charsLeftOver=i-j,h.length>0&&b._pf.unusedInput.push(h),b._pf.bigHour===!0&&b._a[bd]<=12&&(b._pf.bigHour=void 0),b._a[bd]=ta(b._locale,b._a[bd],b._meridiem),qa(b),X(b)}function ta(a,b,c){var d;return null==c?b:null!=a.meridiemHour?a.meridiemHour(b,c):null!=a.isPM?(d=a.isPM(c),d&&12>b&&(b+=12),d||12!==b||(b=0),b):b}function ua(a){var b,d,e,f,g;if(0===a._f.length)return a._pf.invalidFormat=!0,void(a._d=new Date(NaN));for(f=0;f<a._f.length;f++)g=0,b=l({},a),null!=a._useUTC&&(b._useUTC=a._useUTC),b._pf=c(),b._f=a._f[f],sa(b),j(b)&&(g+=b._pf.charsLeftOver,g+=10*b._pf.unusedTokens.length,b._pf.score=g,(null==e||e>g)&&(e=g,d=b));h(a,d||b)}function va(a){if(!a._d){var b=z(a._i);a._a=[b.year,b.month,b.day||b.date,b.hour,b.minute,b.second,b.millisecond],qa(a)}}function wa(a){var b,c=a._i,e=a._f;return a._locale=a._locale||w(a._l),null===c||void 0===e&&""===c?k({nullInput:!0}):("string"==typeof c&&(a._i=c=a._locale.preparse(c)),n(c)?new m(X(c)):(d(e)?ua(a):e?sa(a):xa(a),b=new m(X(a)),b._nextDay&&(b.add(1,"d"),b._nextDay=void 0),b))}function xa(b){var c=b._i;void 0===c?b._d=new Date:e(c)?b._d=new Date(+c):"string"==typeof c?aa(b):d(c)?(b._a=f(c.slice(0),function(a){return parseInt(a,10)}),qa(b)):"object"==typeof c?va(b):"number"==typeof c?b._d=new Date(c):a.createFromInputFallback(b)}function ya(a,b,d,e,f){var g={};return"boolean"==typeof d&&(e=d,d=void 0),g._isAMomentObject=!0,g._useUTC=g._isUTC=f,g._l=d,g._i=a,g._f=b,g._strict=e,g._pf=c(),wa(g)}function za(a,b,c,d){return ya(a,b,c,d,!1)}function Aa(a,b){var c,e;if(1===b.length&&d(b[0])&&(b=b[0]),!b.length)return za();for(c=b[0],e=1;e<b.length;++e)b[e][a](c)&&(c=b[e]);return c}function Ba(){var a=[].slice.call(arguments,0);return Aa("isBefore",a)}function Ca(){var a=[].slice.call(arguments,0);return Aa("isAfter",a)}function Da(a){var b=z(a),c=b.year||0,d=b.quarter||0,e=b.month||0,f=b.week||0,g=b.day||0,h=b.hour||0,i=b.minute||0,j=b.second||0,k=b.millisecond||0;this._milliseconds=+k+1e3*j+6e4*i+36e5*h,this._days=+g+7*f,this._months=+e+3*d+12*c,this._data={},this._locale=w(),this._bubble()}function Ea(a){return a instanceof Da}function Fa(a,b){F(a,0,0,function(){var a=this.utcOffset(),c="+";return 0>a&&(a=-a,c="-"),c+E(~~(a/60),2)+b+E(~~a%60,2)})}function Ga(a){var b=(a||"").match(Vc)||[],c=b[b.length-1]||[],d=(c+"").match(qd)||["-",0,0],e=+(60*d[1])+o(d[2]);return"+"===d[0]?e:-e}function Ha(b,c){var d,f;return c._isUTC?(d=c.clone(),f=(n(b)||e(b)?+b:+za(b))-+d,d._d.setTime(+d._d+f),a.updateOffset(d,!1),d):za(b).local()}function Ia(a){return 15*-Math.round(a._d.getTimezoneOffset()/15)}function Ja(b,c){var d,e=this._offset||0;return null!=b?("string"==typeof b&&(b=Ga(b)),Math.abs(b)<16&&(b=60*b),!this._isUTC&&c&&(d=Ia(this)),this._offset=b,this._isUTC=!0,null!=d&&this.add(d,"m"),e!==b&&(!c||this._changeInProgress?Za(this,Ua(b-e,"m"),1,!1):this._changeInProgress||(this._changeInProgress=!0,a.updateOffset(this,!0),this._changeInProgress=null)),this):this._isUTC?e:Ia(this)}function Ka(a,b){return null!=a?("string"!=typeof a&&(a=-a),this.utcOffset(a,b),this):-this.utcOffset();
}function La(a){return this.utcOffset(0,a)}function Ma(a){return this._isUTC&&(this.utcOffset(0,a),this._isUTC=!1,a&&this.subtract(Ia(this),"m")),this}function Na(){return this._tzm?this.utcOffset(this._tzm):"string"==typeof this._i&&this.utcOffset(Ga(this._i)),this}function Oa(a){return a=a?za(a).utcOffset():0,(this.utcOffset()-a)%60===0}function Pa(){return this.utcOffset()>this.clone().month(0).utcOffset()||this.utcOffset()>this.clone().month(5).utcOffset()}function Qa(){if(this._a){var a=this._isUTC?i(this._a):za(this._a);return this.isValid()&&p(this._a,a.toArray())>0}return!1}function Ra(){return!this._isUTC}function Sa(){return this._isUTC}function Ta(){return this._isUTC&&0===this._offset}function Ua(a,b){var c,d,e,f=a,h=null;return Ea(a)?f={ms:a._milliseconds,d:a._days,M:a._months}:"number"==typeof a?(f={},b?f[b]=a:f.milliseconds=a):(h=rd.exec(a))?(c="-"===h[1]?-1:1,f={y:0,d:o(h[ad])*c,h:o(h[bd])*c,m:o(h[cd])*c,s:o(h[dd])*c,ms:o(h[ed])*c}):(h=sd.exec(a))?(c="-"===h[1]?-1:1,f={y:Va(h[2],c),M:Va(h[3],c),d:Va(h[4],c),h:Va(h[5],c),m:Va(h[6],c),s:Va(h[7],c),w:Va(h[8],c)}):null==f?f={}:"object"==typeof f&&("from"in f||"to"in f)&&(e=Xa(za(f.from),za(f.to)),f={},f.ms=e.milliseconds,f.M=e.months),d=new Da(f),Ea(a)&&g(a,"_locale")&&(d._locale=a._locale),d}function Va(a,b){var c=a&&parseFloat(a.replace(",","."));return(isNaN(c)?0:c)*b}function Wa(a,b){var c={milliseconds:0,months:0};return c.months=b.month()-a.month()+12*(b.year()-a.year()),a.clone().add(c.months,"M").isAfter(b)&&--c.months,c.milliseconds=+b-+a.clone().add(c.months,"M"),c}function Xa(a,b){var c;return b=Ha(b,a),a.isBefore(b)?c=Wa(a,b):(c=Wa(b,a),c.milliseconds=-c.milliseconds,c.months=-c.months),c}function Ya(a,b){return function(c,d){var e,f;return null===d||isNaN(+d)||($(b,"moment()."+b+"(period, number) is deprecated. Please use moment()."+b+"(number, period)."),f=c,c=d,d=f),c="string"==typeof c?+c:c,e=Ua(c,d),Za(this,e,a),this}}function Za(b,c,d,e){var f=c._milliseconds,g=c._days,h=c._months;e=null==e?!0:e,f&&b._d.setTime(+b._d+f*d),g&&C(b,"Date",B(b,"Date")+g*d),h&&U(b,B(b,"Month")+h*d),e&&a.updateOffset(b,g||h)}function $a(a){var b=a||za(),c=Ha(b,this).startOf("day"),d=this.diff(c,"days",!0),e=-6>d?"sameElse":-1>d?"lastWeek":0>d?"lastDay":1>d?"sameDay":2>d?"nextDay":7>d?"nextWeek":"sameElse";return this.format(this.localeData().calendar(e,this,za(b)))}function _a(){return new m(this)}function ab(a,b){var c;return b=y("undefined"!=typeof b?b:"millisecond"),"millisecond"===b?(a=n(a)?a:za(a),+this>+a):(c=n(a)?+a:+za(a),c<+this.clone().startOf(b))}function bb(a,b){var c;return b=y("undefined"!=typeof b?b:"millisecond"),"millisecond"===b?(a=n(a)?a:za(a),+a>+this):(c=n(a)?+a:+za(a),+this.clone().endOf(b)<c)}function cb(a,b,c){return this.isAfter(a,c)&&this.isBefore(b,c)}function db(a,b){var c;return b=y(b||"millisecond"),"millisecond"===b?(a=n(a)?a:za(a),+this===+a):(c=+za(a),+this.clone().startOf(b)<=c&&c<=+this.clone().endOf(b))}function eb(a){return 0>a?Math.ceil(a):Math.floor(a)}function fb(a,b,c){var d,e,f=Ha(a,this),g=6e4*(f.utcOffset()-this.utcOffset());return b=y(b),"year"===b||"month"===b||"quarter"===b?(e=gb(this,f),"quarter"===b?e/=3:"year"===b&&(e/=12)):(d=this-f,e="second"===b?d/1e3:"minute"===b?d/6e4:"hour"===b?d/36e5:"day"===b?(d-g)/864e5:"week"===b?(d-g)/6048e5:d),c?e:eb(e)}function gb(a,b){var c,d,e=12*(b.year()-a.year())+(b.month()-a.month()),f=a.clone().add(e,"months");return 0>b-f?(c=a.clone().add(e-1,"months"),d=(b-f)/(f-c)):(c=a.clone().add(e+1,"months"),d=(b-f)/(c-f)),-(e+d)}function hb(){return this.clone().locale("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")}function ib(){var a=this.clone().utc();return 0<a.year()&&a.year()<=9999?"function"==typeof Date.prototype.toISOString?this.toDate().toISOString():I(a,"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]"):I(a,"YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]")}function jb(b){var c=I(this,b||a.defaultFormat);return this.localeData().postformat(c)}function kb(a,b){return Ua({to:this,from:a}).locale(this.locale()).humanize(!b)}function lb(a){return this.from(za(),a)}function mb(a){var b;return void 0===a?this._locale._abbr:(b=w(a),null!=b&&(this._locale=b),this)}function nb(){return this._locale}function ob(a){switch(a=y(a)){case"year":this.month(0);case"quarter":case"month":this.date(1);case"week":case"isoWeek":case"day":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}return"week"===a&&this.weekday(0),"isoWeek"===a&&this.isoWeekday(1),"quarter"===a&&this.month(3*Math.floor(this.month()/3)),this}function pb(a){return a=y(a),void 0===a||"millisecond"===a?this:this.startOf(a).add(1,"isoWeek"===a?"week":a).subtract(1,"ms")}function qb(){return+this._d-6e4*(this._offset||0)}function rb(){return Math.floor(+this/1e3)}function sb(){return this._offset?new Date(+this):this._d}function tb(){var a=this;return[a.year(),a.month(),a.date(),a.hour(),a.minute(),a.second(),a.millisecond()]}function ub(){return j(this)}function vb(){return h({},this._pf)}function wb(){return this._pf.overflow}function xb(a,b){F(0,[a,a.length],0,b)}function yb(a,b,c){return ga(za([a,11,31+b-c]),b,c).week}function zb(a){var b=ga(this,this.localeData()._week.dow,this.localeData()._week.doy).year;return null==a?b:this.add(a-b,"y")}function Ab(a){var b=ga(this,1,4).year;return null==a?b:this.add(a-b,"y")}function Bb(){return yb(this.year(),1,4)}function Cb(){var a=this.localeData()._week;return yb(this.year(),a.dow,a.doy)}function Db(a){return null==a?Math.ceil((this.month()+1)/3):this.month(3*(a-1)+this.month()%3)}function Eb(a,b){if("string"==typeof a)if(isNaN(a)){if(a=b.weekdaysParse(a),"number"!=typeof a)return null}else a=parseInt(a,10);return a}function Fb(a){return this._weekdays[a.day()]}function Gb(a){return this._weekdaysShort[a.day()]}function Hb(a){return this._weekdaysMin[a.day()]}function Ib(a){var b,c,d;for(this._weekdaysParse||(this._weekdaysParse=[]),b=0;7>b;b++)if(this._weekdaysParse[b]||(c=za([2e3,1]).day(b),d="^"+this.weekdays(c,"")+"|^"+this.weekdaysShort(c,"")+"|^"+this.weekdaysMin(c,""),this._weekdaysParse[b]=new RegExp(d.replace(".",""),"i")),this._weekdaysParse[b].test(a))return b}function Jb(a){var b=this._isUTC?this._d.getUTCDay():this._d.getDay();return null!=a?(a=Eb(a,this.localeData()),this.add(a-b,"d")):b}function Kb(a){var b=(this.day()+7-this.localeData()._week.dow)%7;return null==a?b:this.add(a-b,"d")}function Lb(a){return null==a?this.day()||7:this.day(this.day()%7?a:a-7)}function Mb(a,b){F(a,0,0,function(){return this.localeData().meridiem(this.hours(),this.minutes(),b)})}function Nb(a,b){return b._meridiemParse}function Ob(a){return"p"===(a+"").toLowerCase().charAt(0)}function Pb(a,b,c){return a>11?c?"pm":"PM":c?"am":"AM"}function Qb(a){F(0,[a,3],0,"millisecond")}function Rb(){return this._isUTC?"UTC":""}function Sb(){return this._isUTC?"Coordinated Universal Time":""}function Tb(a){return za(1e3*a)}function Ub(){return za.apply(null,arguments).parseZone()}function Vb(a,b,c){var d=this._calendar[a];return"function"==typeof d?d.call(b,c):d}function Wb(a){var b=this._longDateFormat[a];return!b&&this._longDateFormat[a.toUpperCase()]&&(b=this._longDateFormat[a.toUpperCase()].replace(/MMMM|MM|DD|dddd/g,function(a){return a.slice(1)}),this._longDateFormat[a]=b),b}function Xb(){return this._invalidDate}function Yb(a){return this._ordinal.replace("%d",a)}function Zb(a){return a}function $b(a,b,c,d){var e=this._relativeTime[c];return"function"==typeof e?e(a,b,c,d):e.replace(/%d/i,a)}function _b(a,b){var c=this._relativeTime[a>0?"future":"past"];return"function"==typeof c?c(b):c.replace(/%s/i,b)}function ac(a){var b,c;for(c in a)b=a[c],"function"==typeof b?this[c]=b:this["_"+c]=b;this._ordinalParseLenient=new RegExp(this._ordinalParse.source+"|"+/\d{1,2}/.source)}function bc(a,b,c,d){var e=w(),f=i().set(d,b);return e[c](f,a)}function cc(a,b,c,d,e){if("number"==typeof a&&(b=a,a=void 0),a=a||"",null!=b)return bc(a,b,c,e);var f,g=[];for(f=0;d>f;f++)g[f]=bc(a,f,c,e);return g}function dc(a,b){return cc(a,b,"months",12,"month")}function ec(a,b){return cc(a,b,"monthsShort",12,"month")}function fc(a,b){return cc(a,b,"weekdays",7,"day")}function gc(a,b){return cc(a,b,"weekdaysShort",7,"day")}function hc(a,b){return cc(a,b,"weekdaysMin",7,"day")}function ic(){var a=this._data;return this._milliseconds=Od(this._milliseconds),this._days=Od(this._days),this._months=Od(this._months),a.milliseconds=Od(a.milliseconds),a.seconds=Od(a.seconds),a.minutes=Od(a.minutes),a.hours=Od(a.hours),a.months=Od(a.months),a.years=Od(a.years),this}function jc(a,b,c,d){var e=Ua(b,c);return a._milliseconds+=d*e._milliseconds,a._days+=d*e._days,a._months+=d*e._months,a._bubble()}function kc(a,b){return jc(this,a,b,1)}function lc(a,b){return jc(this,a,b,-1)}function mc(){var a,b,c,d=this._milliseconds,e=this._days,f=this._months,g=this._data,h=0;return g.milliseconds=d%1e3,a=eb(d/1e3),g.seconds=a%60,b=eb(a/60),g.minutes=b%60,c=eb(b/60),g.hours=c%24,e+=eb(c/24),h=eb(nc(e)),e-=eb(oc(h)),f+=eb(e/30),e%=30,h+=eb(f/12),f%=12,g.days=e,g.months=f,g.years=h,this}function nc(a){return 400*a/146097}function oc(a){return 146097*a/400}function pc(a){var b,c,d=this._milliseconds;if(a=y(a),"month"===a||"year"===a)return b=this._days+d/864e5,c=this._months+12*nc(b),"month"===a?c:c/12;switch(b=this._days+Math.round(oc(this._months/12)),a){case"week":return b/7+d/6048e5;case"day":return b+d/864e5;case"hour":return 24*b+d/36e5;case"minute":return 24*b*60+d/6e4;case"second":return 24*b*60*60+d/1e3;case"millisecond":return Math.floor(24*b*60*60*1e3)+d;default:throw new Error("Unknown unit "+a)}}function qc(){return this._milliseconds+864e5*this._days+this._months%12*2592e6+31536e6*o(this._months/12)}function rc(a){return function(){return this.as(a)}}function sc(a){return a=y(a),this[a+"s"]()}function tc(a){return function(){return this._data[a]}}function uc(){return eb(this.days()/7)}function vc(a,b,c,d,e){return e.relativeTime(b||1,!!c,a,d)}function wc(a,b,c){var d=Ua(a).abs(),e=ce(d.as("s")),f=ce(d.as("m")),g=ce(d.as("h")),h=ce(d.as("d")),i=ce(d.as("M")),j=ce(d.as("y")),k=e<de.s&&["s",e]||1===f&&["m"]||f<de.m&&["mm",f]||1===g&&["h"]||g<de.h&&["hh",g]||1===h&&["d"]||h<de.d&&["dd",h]||1===i&&["M"]||i<de.M&&["MM",i]||1===j&&["y"]||["yy",j];return k[2]=b,k[3]=+a>0,k[4]=c,vc.apply(null,k)}function xc(a,b){return void 0===de[a]?!1:void 0===b?de[a]:(de[a]=b,!0)}function yc(a){var b=this.localeData(),c=wc(this,!a,b);return a&&(c=b.pastFuture(+this,c)),b.postformat(c)}function zc(){var a=ee(this.years()),b=ee(this.months()),c=ee(this.days()),d=ee(this.hours()),e=ee(this.minutes()),f=ee(this.seconds()+this.milliseconds()/1e3),g=this.asSeconds();return g?(0>g?"-":"")+"P"+(a?a+"Y":"")+(b?b+"M":"")+(c?c+"D":"")+(d||e||f?"T":"")+(d?d+"H":"")+(e?e+"M":"")+(f?f+"S":""):"P0D"}var Ac,Bc,Cc=a.momentProperties=[],Dc=!1,Ec={},Fc={},Gc=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Q|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|mm?|ss?|S{1,4}|x|X|zz?|ZZ?|.)/g,Hc=/(\[[^\[]*\])|(\\)?(LTS|LT|LL?L?L?|l{1,4})/g,Ic={},Jc={},Kc=/\d/,Lc=/\d\d/,Mc=/\d{3}/,Nc=/\d{4}/,Oc=/[+-]?\d{6}/,Pc=/\d\d?/,Qc=/\d{1,3}/,Rc=/\d{1,4}/,Sc=/[+-]?\d{1,6}/,Tc=/\d+/,Uc=/[+-]?\d+/,Vc=/Z|[+-]\d\d:?\d\d/gi,Wc=/[+-]?\d+(\.\d{1,3})?/,Xc=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,Yc={},Zc={},$c=0,_c=1,ad=2,bd=3,cd=4,dd=5,ed=6;F("M",["MM",2],"Mo",function(){return this.month()+1}),F("MMM",0,0,function(a){return this.localeData().monthsShort(this,a)}),F("MMMM",0,0,function(a){return this.localeData().months(this,a)}),x("month","M"),K("M",Pc),K("MM",Pc,Lc),K("MMM",Xc),K("MMMM",Xc),N(["M","MM"],function(a,b){b[_c]=o(a)-1}),N(["MMM","MMMM"],function(a,b,c,d){var e=c._locale.monthsParse(a,d,c._strict);null!=e?b[_c]=e:c._pf.invalidMonth=a});var fd="January_February_March_April_May_June_July_August_September_October_November_December".split("_"),gd="Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),hd={};a.suppressDeprecationWarnings=!1;var id=/^\s*(?:[+-]\d{6}|\d{4})-(?:(\d\d-\d\d)|(W\d\d$)|(W\d\d-\d)|(\d\d\d))((T| )(\d\d(:\d\d(:\d\d(\.\d+)?)?)?)?([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,jd=[["YYYYYY-MM-DD",/[+-]\d{6}-\d{2}-\d{2}/],["YYYY-MM-DD",/\d{4}-\d{2}-\d{2}/],["GGGG-[W]WW-E",/\d{4}-W\d{2}-\d/],["GGGG-[W]WW",/\d{4}-W\d{2}/],["YYYY-DDD",/\d{4}-\d{3}/]],kd=[["HH:mm:ss.SSSS",/(T| )\d\d:\d\d:\d\d\.\d+/],["HH:mm:ss",/(T| )\d\d:\d\d:\d\d/],["HH:mm",/(T| )\d\d:\d\d/],["HH",/(T| )\d\d/]],ld=/^\/?Date\((\-?\d+)/i;a.createFromInputFallback=Z("moment construction falls back to js Date. This is discouraged and will be removed in upcoming major release. Please refer to https://github.com/moment/moment/issues/1407 for more info.",function(a){a._d=new Date(a._i+(a._useUTC?" UTC":""))}),F(0,["YY",2],0,function(){return this.year()%100}),F(0,["YYYY",4],0,"year"),F(0,["YYYYY",5],0,"year"),F(0,["YYYYYY",6,!0],0,"year"),x("year","y"),K("Y",Uc),K("YY",Pc,Lc),K("YYYY",Rc,Nc),K("YYYYY",Sc,Oc),K("YYYYYY",Sc,Oc),N(["YYYY","YYYYY","YYYYYY"],$c),N("YY",function(b,c){c[$c]=a.parseTwoDigitYear(b)}),a.parseTwoDigitYear=function(a){return o(a)+(o(a)>68?1900:2e3)};var md=A("FullYear",!1);F("w",["ww",2],"wo","week"),F("W",["WW",2],"Wo","isoWeek"),x("week","w"),x("isoWeek","W"),K("w",Pc),K("ww",Pc,Lc),K("W",Pc),K("WW",Pc,Lc),O(["w","ww","W","WW"],function(a,b,c,d){b[d.substr(0,1)]=o(a)});var nd={dow:0,doy:6};F("DDD",["DDDD",3],"DDDo","dayOfYear"),x("dayOfYear","DDD"),K("DDD",Qc),K("DDDD",Mc),N(["DDD","DDDD"],function(a,b,c){c._dayOfYear=o(a)}),a.ISO_8601=function(){};var od=Z("moment().min is deprecated, use moment.min instead. https://github.com/moment/moment/issues/1548",function(){var a=za.apply(null,arguments);return this>a?this:a}),pd=Z("moment().max is deprecated, use moment.max instead. https://github.com/moment/moment/issues/1548",function(){var a=za.apply(null,arguments);return a>this?this:a});Fa("Z",":"),Fa("ZZ",""),K("Z",Vc),K("ZZ",Vc),N(["Z","ZZ"],function(a,b,c){c._useUTC=!0,c._tzm=Ga(a)});var qd=/([\+\-]|\d\d)/gi;a.updateOffset=function(){};var rd=/(\-)?(?:(\d*)\.)?(\d+)\:(\d+)(?:\:(\d+)\.?(\d{3})?)?/,sd=/^(-)?P(?:(?:([0-9,.]*)Y)?(?:([0-9,.]*)M)?(?:([0-9,.]*)D)?(?:T(?:([0-9,.]*)H)?(?:([0-9,.]*)M)?(?:([0-9,.]*)S)?)?|([0-9,.]*)W)$/;Ua.fn=Da.prototype;var td=Ya(1,"add"),ud=Ya(-1,"subtract");a.defaultFormat="YYYY-MM-DDTHH:mm:ssZ";var vd=Z("moment().lang() is deprecated. Instead, use moment().localeData() to get the language configuration. Use moment().locale() to change languages.",function(a){return void 0===a?this.localeData():this.locale(a)});F(0,["gg",2],0,function(){return this.weekYear()%100}),F(0,["GG",2],0,function(){return this.isoWeekYear()%100}),xb("gggg","weekYear"),xb("ggggg","weekYear"),xb("GGGG","isoWeekYear"),xb("GGGGG","isoWeekYear"),x("weekYear","gg"),x("isoWeekYear","GG"),K("G",Uc),K("g",Uc),K("GG",Pc,Lc),K("gg",Pc,Lc),K("GGGG",Rc,Nc),K("gggg",Rc,Nc),K("GGGGG",Sc,Oc),K("ggggg",Sc,Oc),O(["gggg","ggggg","GGGG","GGGGG"],function(a,b,c,d){b[d.substr(0,2)]=o(a)}),O(["gg","GG"],function(b,c,d,e){c[e]=a.parseTwoDigitYear(b)}),F("Q",0,0,"quarter"),x("quarter","Q"),K("Q",Kc),N("Q",function(a,b){b[_c]=3*(o(a)-1)}),F("D",["DD",2],"Do","date"),x("date","D"),K("D",Pc),K("DD",Pc,Lc),K("Do",function(a,b){return a?b._ordinalParse:b._ordinalParseLenient}),N(["D","DD"],ad),N("Do",function(a,b){b[ad]=o(a.match(Pc)[0],10)});var wd=A("Date",!0);F("d",0,"do","day"),F("dd",0,0,function(a){return this.localeData().weekdaysMin(this,a)}),F("ddd",0,0,function(a){return this.localeData().weekdaysShort(this,a)}),F("dddd",0,0,function(a){return this.localeData().weekdays(this,a)}),F("e",0,0,"weekday"),F("E",0,0,"isoWeekday"),x("day","d"),x("weekday","e"),x("isoWeekday","E"),K("d",Pc),K("e",Pc),K("E",Pc),K("dd",Xc),K("ddd",Xc),K("dddd",Xc),O(["dd","ddd","dddd"],function(a,b,c){var d=c._locale.weekdaysParse(a);null!=d?b.d=d:c._pf.invalidWeekday=a}),O(["d","e","E"],function(a,b,c,d){b[d]=o(a)});var xd="Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),yd="Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),zd="Su_Mo_Tu_We_Th_Fr_Sa".split("_");F("H",["HH",2],0,"hour"),F("h",["hh",2],0,function(){return this.hours()%12||12}),Mb("a",!0),Mb("A",!1),x("hour","h"),K("a",Nb),K("A",Nb),K("H",Pc),K("h",Pc),K("HH",Pc,Lc),K("hh",Pc,Lc),N(["H","HH"],bd),N(["a","A"],function(a,b,c){c._isPm=c._locale.isPM(a),c._meridiem=a}),N(["h","hh"],function(a,b,c){b[bd]=o(a),c._pf.bigHour=!0});var Ad=/[ap]\.?m?\.?/i,Bd=A("Hours",!0);F("m",["mm",2],0,"minute"),x("minute","m"),K("m",Pc),K("mm",Pc,Lc),N(["m","mm"],cd);var Cd=A("Minutes",!1);F("s",["ss",2],0,"second"),x("second","s"),K("s",Pc),K("ss",Pc,Lc),N(["s","ss"],dd);var Dd=A("Seconds",!1);F("S",0,0,function(){return~~(this.millisecond()/100)}),F(0,["SS",2],0,function(){return~~(this.millisecond()/10)}),Qb("SSS"),Qb("SSSS"),x("millisecond","ms"),K("S",Qc,Kc),K("SS",Qc,Lc),K("SSS",Qc,Mc),K("SSSS",Tc),N(["S","SS","SSS","SSSS"],function(a,b){b[ed]=o(1e3*("0."+a))});var Ed=A("Milliseconds",!1);F("z",0,0,"zoneAbbr"),F("zz",0,0,"zoneName");var Fd=m.prototype;Fd.add=td,Fd.calendar=$a,Fd.clone=_a,Fd.diff=fb,Fd.endOf=pb,Fd.format=jb,Fd.from=kb,Fd.fromNow=lb,Fd.get=D,Fd.invalidAt=wb,Fd.isAfter=ab,Fd.isBefore=bb,Fd.isBetween=cb,Fd.isSame=db,Fd.isValid=ub,Fd.lang=vd,Fd.locale=mb,Fd.localeData=nb,Fd.max=pd,Fd.min=od,Fd.parsingFlags=vb,Fd.set=D,Fd.startOf=ob,Fd.subtract=ud,Fd.toArray=tb,Fd.toDate=sb,Fd.toISOString=ib,Fd.toJSON=ib,Fd.toString=hb,Fd.unix=rb,Fd.valueOf=qb,Fd.year=md,Fd.isLeapYear=fa,Fd.weekYear=zb,Fd.isoWeekYear=Ab,Fd.quarter=Fd.quarters=Db,Fd.month=V,Fd.daysInMonth=W,Fd.week=Fd.weeks=ka,Fd.isoWeek=Fd.isoWeeks=la,Fd.weeksInYear=Cb,Fd.isoWeeksInYear=Bb,Fd.date=wd,Fd.day=Fd.days=Jb,Fd.weekday=Kb,Fd.isoWeekday=Lb,Fd.dayOfYear=na,Fd.hour=Fd.hours=Bd,Fd.minute=Fd.minutes=Cd,Fd.second=Fd.seconds=Dd,Fd.millisecond=Fd.milliseconds=Ed,Fd.utcOffset=Ja,Fd.utc=La,Fd.local=Ma,Fd.parseZone=Na,Fd.hasAlignedHourOffset=Oa,Fd.isDST=Pa,Fd.isDSTShifted=Qa,Fd.isLocal=Ra,Fd.isUtcOffset=Sa,Fd.isUtc=Ta,Fd.isUTC=Ta,Fd.zoneAbbr=Rb,Fd.zoneName=Sb,Fd.dates=Z("dates accessor is deprecated. Use date instead.",wd),Fd.months=Z("months accessor is deprecated. Use month instead",V),Fd.years=Z("years accessor is deprecated. Use year instead",md),Fd.zone=Z("moment().zone is deprecated, use moment().utcOffset instead. https://github.com/moment/moment/issues/1779",Ka);var Gd=Fd,Hd={sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},Id={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY LT",LLLL:"dddd, MMMM D, YYYY LT"},Jd="Invalid date",Kd="%d",Ld=/\d{1,2}/,Md={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},Nd=q.prototype;Nd._calendar=Hd,Nd.calendar=Vb,Nd._longDateFormat=Id,Nd.longDateFormat=Wb,Nd._invalidDate=Jd,Nd.invalidDate=Xb,Nd._ordinal=Kd,Nd.ordinal=Yb,Nd._ordinalParse=Ld,Nd.preparse=Zb,Nd.postformat=Zb,Nd._relativeTime=Md,Nd.relativeTime=$b,Nd.pastFuture=_b,Nd.set=ac,Nd.months=R,Nd._months=fd,Nd.monthsShort=S,Nd._monthsShort=gd,Nd.monthsParse=T,Nd.week=ha,Nd._week=nd,Nd.firstDayOfYear=ja,Nd.firstDayOfWeek=ia,Nd.weekdays=Fb,Nd._weekdays=xd,Nd.weekdaysMin=Hb,Nd._weekdaysMin=zd,Nd.weekdaysShort=Gb,Nd._weekdaysShort=yd,Nd.weekdaysParse=Ib,Nd.isPM=Ob,Nd._meridiemParse=Ad,Nd.meridiem=Pb,u("en",{ordinalParse:/\d{1,2}(th|st|nd|rd)/,ordinal:function(a){var b=a%10,c=1===o(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th";return a+c}}),a.lang=Z("moment.lang is deprecated. Use moment.locale instead.",u),a.langData=Z("moment.langData is deprecated. Use moment.localeData instead.",w);var Od=Math.abs,Pd=rc("ms"),Qd=rc("s"),Rd=rc("m"),Sd=rc("h"),Td=rc("d"),Ud=rc("w"),Vd=rc("M"),Wd=rc("y"),Xd=tc("milliseconds"),Yd=tc("seconds"),Zd=tc("minutes"),$d=tc("hours"),_d=tc("days"),ae=tc("months"),be=tc("years"),ce=Math.round,de={s:45,m:45,h:22,d:26,M:11},ee=Math.abs,fe=Da.prototype;fe.abs=ic,fe.add=kc,fe.subtract=lc,fe.as=pc,fe.asMilliseconds=Pd,fe.asSeconds=Qd,fe.asMinutes=Rd,fe.asHours=Sd,fe.asDays=Td,fe.asWeeks=Ud,fe.asMonths=Vd,fe.asYears=Wd,fe.valueOf=qc,fe._bubble=mc,fe.get=sc,fe.milliseconds=Xd,fe.seconds=Yd,fe.minutes=Zd,fe.hours=$d,fe.days=_d,fe.weeks=uc,fe.months=ae,fe.years=be,fe.humanize=yc,fe.toISOString=zc,fe.toString=zc,fe.toJSON=zc,fe.locale=mb,fe.localeData=nb,fe.toIsoString=Z("toIsoString() is deprecated. Please use toISOString() instead (notice the capitals)",zc),fe.lang=vd,F("X",0,0,"unix"),F("x",0,0,"valueOf"),K("x",Uc),K("X",Wc),N("X",function(a,b,c){c._d=new Date(1e3*parseFloat(a,10))}),N("x",function(a,b,c){c._d=new Date(o(a))}),a.version="2.10.2",b(za),a.fn=Gd,a.min=Ba,a.max=Ca,a.utc=i,a.unix=Tb,a.months=dc,a.isDate=e,a.locale=u,a.invalid=k,a.duration=Ua,a.isMoment=n,a.weekdays=fc,a.parseZone=Ub,a.localeData=w,a.isDuration=Ea,a.monthsShort=ec,a.weekdaysMin=hc,a.defineLocale=v,a.weekdaysShort=gc,a.normalizeUnits=y,a.relativeTimeThreshold=xc;var ge=a;return ge}),function(a){a.fn.zclip=function(b){if("object"==typeof b&&!b.length){var c=a.extend({path:"/javascripts/plugins/ZeroClipboard.swf",copy:null,beforeCopy:null,afterCopy:null,clickAfter:!0,setHandCursor:!0,setCSSEffects:!0},b);return this.each(function(){var b=a(this);if(b.is(":visible")&&("string"==typeof c.copy||a.isFunction(c.copy))){ZeroClipboard.setMoviePath(c.path);var d=new ZeroClipboard.Client;a.isFunction(c.copy)&&b.bind("zClip_copy",c.copy),a.isFunction(c.beforeCopy)&&b.bind("zClip_beforeCopy",c.beforeCopy),a.isFunction(c.afterCopy)&&b.bind("zClip_afterCopy",c.afterCopy),d.setHandCursor(c.setHandCursor),d.setCSSEffects(c.setCSSEffects),d.addEventListener("mouseOver",function(a){b.trigger("mouseenter")}),d.addEventListener("mouseOut",function(a){b.trigger("mouseleave")}),d.addEventListener("mouseDown",function(e){b.trigger("mousedown"),a.isFunction(c.copy)?d.setText(b.triggerHandler("zClip_copy")):d.setText(c.copy),a.isFunction(c.beforeCopy)&&b.trigger("zClip_beforeCopy")}),d.addEventListener("complete",function(d,e){a.isFunction(c.afterCopy)?b.trigger("zClip_afterCopy"):(e.length>500&&(e=e.substr(0,500)+"...\n\n("+(e.length-500)+" characters not shown)"),b.removeClass("hover")),c.clickAfter&&b.trigger("click")}),d.glue(b[0],b.parent()[0]),a(window).bind("load resize",function(){d.reposition()})}})}return"string"==typeof b?this.each(function(){var c=a(this);b=b.toLowerCase();var d=c.data("zclipId"),e=a("#"+d+".zclip");"remove"==b?(e.remove(),c.removeClass("active hover")):"hide"==b?(e.hide(),c.removeClass("active hover")):"show"==b&&e.show()}):void 0}}(jQuery);var ZeroClipboard={version:"1.0.7",clients:{},moviePath:"ZeroClipboard.swf",nextId:1,$:function(a){return"string"==typeof a&&(a=document.getElementById(a)),a.addClass||(a.hide=function(){this.style.display="none"},a.show=function(){this.style.display=""},a.addClass=function(a){this.removeClass(a),this.className+=" "+a},a.removeClass=function(a){for(var b=this.className.split(/\s+/),c=-1,d=0;d<b.length;d++)b[d]==a&&(c=d,d=b.length);return c>-1&&(b.splice(c,1),this.className=b.join(" ")),this},a.hasClass=function(a){return!!this.className.match(new RegExp("\\s*"+a+"\\s*"))}),a},setMoviePath:function(a){this.moviePath=a},dispatch:function(a,b,c){var d=this.clients[a];d&&d.receiveEvent(b,c)},register:function(a,b){this.clients[a]=b},getDOMObjectPosition:function(a,b){var c={left:0,top:0,width:a.width?a.width:a.offsetWidth,height:a.height?a.height:a.offsetHeight};return a&&a!=b&&(c.left+=a.offsetLeft,c.top+=a.offsetTop),c},Client:function(a){this.handlers={},this.id=ZeroClipboard.nextId++,this.movieId="ZeroClipboardMovie_"+this.id,ZeroClipboard.register(this.id,this),a&&this.glue(a)}};ZeroClipboard.Client.prototype={id:0,ready:!1,movie:null,clipText:"",handCursorEnabled:!0,cssEffects:!0,handlers:null,glue:function(a,b,c){this.domElement=ZeroClipboard.$(a);var d=99;this.domElement.style.zIndex&&(d=parseInt(this.domElement.style.zIndex,10)+1),"string"==typeof b?b=ZeroClipboard.$(b):"undefined"==typeof b&&(b=document.getElementsByTagName("body")[0]);var e=ZeroClipboard.getDOMObjectPosition(this.domElement,b);this.div=document.createElement("div"),this.div.className="zclip",this.div.id="zclip-"+this.movieId,$(this.domElement).data("zclipId","zclip-"+this.movieId);var f=this.div.style;if(f.position="absolute",f.left=""+e.left+"px",f.top=""+e.top+"px",f.width=""+e.width+"px",f.height=""+e.height+"px",f.zIndex=d,"object"==typeof c)for(addedStyle in c)f[addedStyle]=c[addedStyle];b.appendChild(this.div),this.div.innerHTML=this.getHTML(e.width,e.height)},getHTML:function(a,b){var c="",d="id="+this.id+"&width="+a+"&height="+b;if(navigator.userAgent.match(/MSIE/)){var e=location.href.match(/^https/i)?"https://":"http://";c+='<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="'+e+'download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" width="'+a+'" height="'+b+'" id="'+this.movieId+'" align="middle"><param name="allowScriptAccess" value="always" /><param name="allowFullScreen" value="false" /><param name="movie" value="'+ZeroClipboard.moviePath+'" /><param name="loop" value="false" /><param name="menu" value="false" /><param name="quality" value="best" /><param name="bgcolor" value="#ffffff" /><param name="flashvars" value="'+d+'"/><param name="wmode" value="transparent"/></object>'}else c+='<embed id="'+this.movieId+'" src="'+ZeroClipboard.moviePath+'" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="'+a+'" height="'+b+'" name="'+this.movieId+'" align="middle" allowScriptAccess="always" allowFullScreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="'+d+'" wmode="transparent" />';return c},hide:function(){this.div&&(this.div.style.left="-2000px")},show:function(){this.reposition()},destroy:function(){if(this.domElement&&this.div){this.hide(),this.div.innerHTML="";var a=document.getElementsByTagName("body")[0];try{a.removeChild(this.div)}catch(b){}this.domElement=null,this.div=null}},reposition:function(a){if(a&&(this.domElement=ZeroClipboard.$(a),this.domElement||this.hide()),this.domElement&&this.div){var b=ZeroClipboard.getDOMObjectPosition(this.domElement),c=this.div.style;c.left=""+b.left+"px",c.top=""+b.top+"px"}},setText:function(a){this.clipText=a,this.ready&&this.movie.setText(a)},addEventListener:function(a,b){a=a.toString().toLowerCase().replace(/^on/,""),this.handlers[a]||(this.handlers[a]=[]),this.handlers[a].push(b)},setHandCursor:function(a){this.handCursorEnabled=a,this.ready&&this.movie.setHandCursor(a)},setCSSEffects:function(a){this.cssEffects=!!a},receiveEvent:function(a,b){switch(a=a.toString().toLowerCase().replace(/^on/,"")){case"load":if(this.movie=document.getElementById(this.movieId),!this.movie){var c=this;return void setTimeout(function(){c.receiveEvent("load",null)},1)}if(!this.ready&&navigator.userAgent.match(/Firefox/)&&navigator.userAgent.match(/Windows/)){var c=this;return setTimeout(function(){c.receiveEvent("load",null)},100),void(this.ready=!0)}this.ready=!0;try{this.movie.setText(this.clipText)}catch(d){}try{this.movie.setHandCursor(this.handCursorEnabled)}catch(d){}break;case"mouseover":this.domElement&&this.cssEffects&&(this.domElement.addClass("hover"),this.recoverActive&&this.domElement.addClass("active"));break;case"mouseout":this.domElement&&this.cssEffects&&(this.recoverActive=!1,this.domElement.hasClass("active")&&(this.domElement.removeClass("active"),this.recoverActive=!0),this.domElement.removeClass("hover"));break;case"mousedown":this.domElement&&this.cssEffects&&this.domElement.addClass("active");break;case"mouseup":this.domElement&&this.cssEffects&&(this.domElement.removeClass("active"),this.recoverActive=!1)}if(this.handlers[a])for(var e=0,f=this.handlers[a].length;f>e;e++){var g=this.handlers[a][e];"function"==typeof g?g(this,b):"object"==typeof g&&2==g.length?g[0][g[1]](this,b):"string"==typeof g&&window[g](this,b)}}},function(a){a.widget("ui.tagit",{options:{allowDuplicates:!1,caseSensitive:!0,fieldName:"tags",placeholderText:null,readOnly:!1,removeConfirmation:!1,tagLimit:null,availableTags:[],autocomplete:{},showAutocompleteOnFocus:!1,allowSpaces:!1,singleField:!1,singleFieldDelimiter:",",singleFieldNode:null,animate:!0,tabIndex:null,beforeTagAdded:null,afterTagAdded:null,beforeTagRemoved:null,afterTagRemoved:null,onTagClicked:null,onTagLimitExceeded:null,onTagAdded:null,onTagRemoved:null,tagSource:null,onSubmitTags:null,onFocus:null,onBlur:null},_create:function(){var b=this;this.element.is("input")?(this.tagList=a("<ul></ul>").insertAfter(this.element),this.options.singleField=!0,this.options.singleFieldNode=this.element,this.element.addClass("tagit-hidden-field")):this.tagList=this.element.find("ul, ol").andSelf().last(),this.tagInput=a('<input type="text" />').addClass("ui-widget-content"),this.options.readOnly&&this.tagInput.attr("disabled","disabled"),this.options.tabIndex&&this.tagInput.attr("tabindex",this.options.tabIndex),this.options.placeholderText&&this.tagInput.attr("placeholder",this.options.placeholderText),this.options.autocomplete.source||(this.options.autocomplete.source=function(b,c){var d=b.term.toLowerCase(),e=a.grep(this.options.availableTags,function(a){return 0===a.toLowerCase().indexOf(d)});this.options.allowDuplicates||(e=this._subtractArray(e,this.assignedTags())),c(e)}),this.options.showAutocompleteOnFocus&&(this.tagInput.focus(function(a,c){b._showAutocomplete()}),"undefined"==typeof this.options.autocomplete.minLength&&(this.options.autocomplete.minLength=0)),a.isFunction(this.options.autocomplete.source)&&(this.options.autocomplete.source=a.proxy(this.options.autocomplete.source,this)),a.isFunction(this.options.tagSource)&&(this.options.tagSource=a.proxy(this.options.tagSource,this)),this.tagList.addClass("tagit").addClass("ui-widget ui-widget-content ui-corner-all").append(a('<li class="tagit-new"></li>').append(this.tagInput)).click(function(c){var d=a(c.target);if(d.hasClass("tagit-label")){var e=d.closest(".tagit-choice");e.hasClass("removed")||b._trigger("onTagClicked",c,{tag:e,tagLabel:b.tagLabel(e)})}else b.tagInput.focus()});var c=!1;if(this.options.singleField)if(this.options.singleFieldNode){var d=a(this.options.singleFieldNode),e=d.val().split(this.options.singleFieldDelimiter);d.val(""),a.each(e,function(a,d){b.createTag(d,null,!0),c=!0})}else this.options.singleFieldNode=a('<input type="hidden" style="display:none;" value="" name="'+this.options.fieldName+'" />'),this.tagList.after(this.options.singleFieldNode);if(c||this.tagList.children("li").each(function(){a(this).hasClass("tagit-new")||(b.createTag(a(this).text(),a(this).attr("class"),!0),a(this).remove())}),this.tagInput.keydown(function(c){if(c.which==a.ui.keyCode.BACKSPACE&&""===b.tagInput.val()){var d=b._lastTag();!b.options.removeConfirmation||d.hasClass("remove")?b.removeTag(d):b.options.removeConfirmation&&d.addClass("remove ui-state-highlight")}else b.options.removeConfirmation?b._lastTag().removeClass("remove ui-state-highlight"):c.which==a.ui.keyCode.ENTER&&""===b.tagInput.val()&&b._trigger("onSubmitTags",null,b.tagList);(c.which===a.ui.keyCode.COMMA&&c.shiftKey===!1||c.which===a.ui.keyCode.ENTER||c.which==a.ui.keyCode.TAB&&""!==b.tagInput.val()||c.which==a.ui.keyCode.SPACE&&b.options.allowSpaces!==!0&&('"'!=a.trim(b.tagInput.val()).replace(/^s*/,"").charAt(0)||'"'==a.trim(b.tagInput.val()).charAt(0)&&'"'==a.trim(b.tagInput.val()).charAt(a.trim(b.tagInput.val()).length-1)&&a.trim(b.tagInput.val()).length-1!==0))&&((c.which!==a.ui.keyCode.ENTER||""!==b.tagInput.val())&&c.preventDefault(),b.options.autocomplete.autoFocus&&b.tagInput.data("autocomplete-open")||(b.tagInput.autocomplete("close"),b.createTag(b._cleanedInput())))}).blur(function(a){b._trigger("onBlur",null,null),b.tagInput.data("autocomplete-open")||b.createTag(b._cleanedInput())}).focus(function(a){b._trigger("onFocus",null,null)}),this.options.availableTags||this.options.tagSource||this.options.autocomplete.source){
var f={select:function(a,c){return b.createTag(c.item.value),!1}};a.extend(f,this.options.autocomplete),f.source=this.options.tagSource||f.source,this.tagInput.autocomplete(f).bind("autocompleteopen.tagit",function(a,c){b.tagInput.data("autocomplete-open",!0)}).bind("autocompleteclose.tagit",function(a,c){b.tagInput.data("autocomplete-open",!1)}),this.tagInput.autocomplete("widget").addClass("tagit-autocomplete")}},destroy:function(){return a.Widget.prototype.destroy.call(this),this.element.unbind(".tagit"),this.tagList.unbind(".tagit"),this.tagInput.removeData("autocomplete-open"),this.tagList.removeClass(["tagit","ui-widget","ui-widget-content","ui-corner-all","tagit-hidden-field"].join(" ")),this.element.is("input")?(this.element.removeClass("tagit-hidden-field"),this.tagList.remove()):(this.element.children("li").each(function(){a(this).hasClass("tagit-new")?a(this).remove():(a(this).removeClass(["tagit-choice","ui-widget-content","ui-state-default","ui-state-highlight","ui-corner-all","remove","tagit-choice-editable","tagit-choice-read-only"].join(" ")),a(this).text(a(this).children(".tagit-label").text()))}),this.singleFieldNode&&this.singleFieldNode.remove()),this},_cleanedInput:function(){return a.trim(this.tagInput.val().replace(/^"(.*)"$/,"$1"))},_lastTag:function(){return this.tagList.find(".tagit-choice:last:not(.removed)")},_tags:function(){return this.tagList.find(".tagit-choice:not(.removed)")},assignedTags:function(){var b=this,c=[];return this.options.singleField?(c=a(this.options.singleFieldNode).val().split(this.options.singleFieldDelimiter),""===c[0]&&(c=[])):this._tags().each(function(){c.push(b.tagLabel(this))}),c},_updateSingleTagsField:function(b){a(this.options.singleFieldNode).val(b.join(this.options.singleFieldDelimiter)).trigger("change")},_subtractArray:function(b,c){for(var d=[],e=0;e<b.length;e++)-1==a.inArray(b[e],c)&&d.push(b[e]);return d},tagLabel:function(b){return this.options.singleField?a(b).find(".tagit-label:first").text():a(b).find("input:first").val()},_showAutocomplete:function(){this.tagInput.autocomplete("search","")},_findTagByLabel:function(b){var c=this,d=null;return this._tags().each(function(e){return c._formatStr(b)==c._formatStr(c.tagLabel(this))?(d=a(this),!1):void 0}),d},_isNew:function(a){return!this._findTagByLabel(a)},_formatStr:function(b){return this.options.caseSensitive?b:a.trim(b.toLowerCase())},_effectExists:function(b){return Boolean(a.effects&&(a.effects[b]||a.effects.effect&&a.effects.effect[b]))},createTag:function(b,c,d){var e=this;if(b=a.trim(b),this.options.preprocessTag&&(b=this.options.preprocessTag(b)),""===b)return!1;if(!this.options.allowDuplicates&&!this._isNew(b)){var f=this._findTagByLabel(b);return this._trigger("onTagExists",null,{existingTag:f,duringInitialization:d})!==!1&&this._effectExists("highlight")&&f.effect("highlight"),!1}if(this.options.tagLimit&&this._tags().length>=this.options.tagLimit)return this._trigger("onTagLimitExceeded",null,{duringInitialization:d}),!1;var g=a(this.options.onTagClicked?'<a class="tagit-label"></a>':'<span class="tagit-label"></span>').text(b),h=a("<li></li>").addClass("tagit-choice ui-widget-content ui-state-default ui-corner-all").addClass(c).append(g);if(this.options.readOnly)h.addClass("tagit-choice-read-only");else{h.addClass("tagit-choice-editable");var i=a("<span></span>").addClass("ui-icon ui-icon-close"),j=a('<a><span class="text-icon">×</span></a>').addClass("tagit-close").append(i).click(function(a){e.removeTag(h)});h.append(j)}if(!this.options.singleField){var k=g.html();h.append('<input type="hidden" value="'+k+'" name="'+this.options.fieldName+'" class="tagit-hidden-field" />')}if(this._trigger("beforeTagAdded",null,{tag:h,tagLabel:this.tagLabel(h),duringInitialization:d})!==!1){if(this.options.singleField){var l=this.assignedTags();l.push(b),this._updateSingleTagsField(l)}this._trigger("onTagAdded",null,h),this.tagInput.val(""),this.tagInput.parent().before(h),this._trigger("afterTagAdded",null,{tag:h,tagLabel:this.tagLabel(h),duringInitialization:d}),this.options.showAutocompleteOnFocus&&!d&&setTimeout(function(){e._showAutocomplete()},0)}},removeTag:function(b,c){if(c="undefined"==typeof c?this.options.animate:c,b=a(b),this._trigger("onTagRemoved",null,b),this._trigger("beforeTagRemoved",null,{tag:b,tagLabel:this.tagLabel(b)})!==!1){if(this.options.singleField){var d=this.assignedTags(),e=this.tagLabel(b);d=a.grep(d,function(a){return a!=e}),this._updateSingleTagsField(d)}if(c){b.addClass("removed");var f=this._effectExists("blind")?["blind",{direction:"horizontal"},"fast"]:["fast"],g=this;f.push(function(){b.remove(),g._trigger("afterTagRemoved",null,{tag:b,tagLabel:g.tagLabel(b)})}),b.fadeOut("fast").hide.apply(b,f).dequeue()}else b.remove(),this._trigger("afterTagRemoved",null,{tag:b,tagLabel:this.tagLabel(b)})}},removeTagByLabel:function(a,b){var c=this._findTagByLabel(a);if(!c)throw"No such tag exists with the name '"+a+"'";this.removeTag(c,b)},removeAll:function(){var a=this;this._tags().each(function(b,c){a.removeTag(c,!1)})}})}(jQuery),function(a){function b(a,b){return"function"==typeof a?a.call(b):a}function c(a){for(;a=a.parentNode;)if(a==document)return!0;return!1}function d(b,c){this.$element=a(b),this.options=c,this.enabled=!0,this.fixTitle()}var e=6;d.prototype={show:function(){var c=this.getTitle();if(c&&this.enabled){var d=this.tip();d.find(".tipsy-inner")[this.options.html?"html":"text"](c),d[0].className="tipsy",d.remove().css({top:0,left:0,visibility:"hidden",display:"block"}).prependTo(document.body),this.options.className&&d.addClass(b(this.options.className,this.$element[0]));var f,g=a.extend({},this.$element.offset(),{width:this.$element[0].offsetWidth,height:this.$element[0].offsetHeight}),h=d[0].offsetWidth,i=d[0].offsetHeight,j=b(this.options.gravity,this.$element[0]);switch(j.charAt(0)){case"n":f={top:g.top+g.height+this.options.offset,left:g.left+g.width/2-h/2},mo={top:parseInt(g.top+g.height+this.options.offset+e),opacity:this.options.opacity};break;case"s":f={top:g.top-i-this.options.offset,left:g.left+g.width/2-h/2},mo={top:parseInt(g.top-i-this.options.offset-e),opacity:this.options.opacity};break;case"e":f={top:g.top+g.height/2-i/2,left:g.left-h-this.options.offset},mo={left:parseInt(g.left-h-this.options.offset-e),opacity:this.options.opacity};break;case"w":f={top:g.top+g.height/2-i/2,left:g.left+g.width+this.options.offset},mo={left:parseInt(g.left+g.width+this.options.offset+e),opacity:this.options.opacity}}2==j.length&&("w"==j.charAt(1)?f.left=g.left+g.width/2-15:f.left=g.left+g.width/2-h+15),d.css(f).addClass("tipsy-"+j),d.find(".tipsy-arrow")[0].className="tipsy-arrow tipsy-arrow-"+j.charAt(0),this.options.fade?d.stop().css({opacity:0,display:"block",visibility:"visible"}).animate(mo,200):d.css({visibility:"visible",opacity:this.options.opacity})}},hide:function(){switch(gravity=b(this.options.gravity,this.$element[0]),gravity.charAt(0)){case"n":mo={top:parseInt(this.tip().css("top"))+e,opacity:0};break;case"s":mo={top:parseInt(this.tip().css("top"))-e,opacity:0};break;case"e":mo={left:parseInt(this.tip().css("left"))-e,opacity:0};break;case"w":mo={left:parseInt(this.tip().css("left"))+e,opacity:0}}this.options.fade?this.tip().stop().animate(mo,200,function(){a(this).remove()}):this.tip().remove()},fixTitle:function(){var a=this.$element;(a.attr("title")||"string"!=typeof a.attr("original-title"))&&a.attr("original-title",a.attr("title")||"").removeAttr("title")},getTitle:function(){var a,b=this.$element,c=this.options;this.fixTitle();var a,c=this.options;return"string"==typeof c.title?a=b.attr("title"==c.title?"original-title":c.title):"function"==typeof c.title&&(a=c.title.call(b[0])),a=(""+a).replace(/(^\s*|\s*$)/,""),a||c.fallback},tip:function(){return this.$tip||(this.$tip=a('<div class="tipsy"></div>').html('<div class="tipsy-arrow"></div><div class="tipsy-inner"></div>'),this.$tip.data("tipsy-pointee",this.$element[0])),this.$tip},validate:function(){this.$element[0].parentNode||(this.hide(),this.$element=null,this.options=null)},remove:function(){this.enabled=!1,this.$tip&&this.$tip.remove()},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1},toggleEnabled:function(){this.enabled=!this.enabled}},a.fn.tipsy=function(b){function c(c){var e=a.data(c,"tipsy");return e||(e=new d(c,a.fn.tipsy.elementOptions(c,b)),a.data(c,"tipsy",e)),e}function e(){var a=c(this);a.hoverState="in",0==b.delayIn?a.show():(a.fixTitle(),setTimeout(function(){"in"==a.hoverState&&a.show()},b.delayIn))}function f(){var a=c(this);a.hoverState="out",0==b.delayOut?a.hide():setTimeout(function(){"out"==a.hoverState&&a.hide()},b.delayOut)}if(b===!0)return this.data("tipsy");if("string"==typeof b){var g=this.data("tipsy");return g&&g[b](),this}if(b=a.extend({},a.fn.tipsy.defaults,b),b.live||this.each(function(){c(this)}),"manual"!=b.trigger){var h=b.live?"live":"bind",i="hover"==b.trigger?"mouseenter":"focus",j="hover"==b.trigger?"mouseleave":"blur";this[h](i,e)[h](j,f)}return this},a.fn.tipsy.defaults={className:null,delayIn:0,delayOut:0,fade:!1,fallback:"",gravity:"n",html:!1,live:!1,offset:0,opacity:.8,title:"title",trigger:"hover"},a.fn.tipsy.revalidate=function(){a(".tipsy").each(function(){var b=a.data(this,"tipsy-pointee");b&&c(b)||a(this).remove()})},a.fn.tipsy.elementOptions=function(b,c){return a.metadata?a.extend({},c,a(b).metadata()):c},a.fn.tipsy.autoNS=function(){return a(this).offset().top>a(document).scrollTop()+a(window).height()/2?"s":"n"},a.fn.tipsy.autoWE=function(){return a(this).offset().left>a(document).scrollLeft()+a(window).width()/2?"e":"w"},a.fn.tipsy.autoBounds=function(b,c){return function(){var d={ns:c[0],ew:c.length>1?c[1]:!1},e=a(document).scrollTop()+b,f=a(document).scrollLeft()+b,g=a(this);return g.offset().top<e&&(d.ns="n"),g.offset().left<f&&(d.ew="w"),a(window).width()+a(document).scrollLeft()-g.offset().left<b&&(d.ew="e"),a(window).height()+a(document).scrollTop()-g.offset().top<b&&(d.ns="s"),d.ns+(d.ew?d.ew:"")}}}(jQuery),function(){function a(a,b){try{for(var c in b)Object.defineProperty(a.prototype,c,{value:b[c],enumerable:!1})}catch(d){a.prototype=b}}function b(a){for(var b=-1,c=a.length,d=[];++b<c;)d.push(a[b]);return d}function c(a){return Array.prototype.slice.call(a)}function d(){}function e(a){return a}function f(){return this}function g(){return!0}function h(a){return"function"==typeof a?a:function(){return a}}function i(a,b,c){return function(){var d=c.apply(b,arguments);return arguments.length?a:d}}function j(a){return null!=a&&!isNaN(a)}function k(a){return a.length}function l(a){return null==a}function m(a){return a.replace(/^\s+|\s+$/g,"").replace(/\s+/g," ")}function n(a){for(var b=1;a*b%1;)b*=10;return b}function o(){}function p(a){function b(){for(var b,d=c,e=-1,f=d.length;++e<f;)(b=d[e].on)&&b.apply(this,arguments);return a}var c=[],e=new d;return b.on=function(b,d){var f,g=e.get(b);return arguments.length<2?g&&g.on:(g&&(g.on=null,c=c.slice(0,f=c.indexOf(g)).concat(c.slice(f+1)),e.remove(b)),d&&c.push(e.set(b,{on:d})),a)},b}function q(a,b){return b-(a?1+Math.floor(Math.log(a+Math.pow(10,1+Math.floor(Math.log(a)/Math.LN10)-b))/Math.LN10):1)}function r(a){return a+""}function s(a){for(var b=a.lastIndexOf("."),c=b>=0?a.substring(b):(b=a.length,""),d=[];b>0;)d.push(a.substring(b-=3,b+3));return d.reverse().join(",")+c}function t(a,b){var c=Math.pow(10,3*Math.abs(8-b));return{scale:b>8?function(a){return a/c}:function(a){return a*c},symbol:a}}function u(a){return function(b){return 0>=b?0:b>=1?1:a(b)}}function v(a){return function(b){return 1-a(1-b)}}function w(a){return function(b){return.5*(.5>b?a(2*b):2-a(2-2*b))}}function x(a){return a}function y(a){return function(b){return Math.pow(b,a)}}function z(a){return 1-Math.cos(a*Math.PI/2)}function A(a){return Math.pow(2,10*(a-1))}function B(a){return 1-Math.sqrt(1-a*a)}function C(a,b){var c;return arguments.length<2&&(b=.45),arguments.length<1?(a=1,c=b/4):c=b/(2*Math.PI)*Math.asin(1/a),function(d){return 1+a*Math.pow(2,10*-d)*Math.sin(2*(d-c)*Math.PI/b)}}function D(a){return a||(a=1.70158),function(b){return b*b*((a+1)*b-a)}}function E(a){return 1/2.75>a?7.5625*a*a:2/2.75>a?7.5625*(a-=1.5/2.75)*a+.75:2.5/2.75>a?7.5625*(a-=2.25/2.75)*a+.9375:7.5625*(a-=2.625/2.75)*a+.984375}function F(){d3.event.stopPropagation(),d3.event.preventDefault()}function G(){for(var a,b=d3.event;a=b.sourceEvent;)b=a;return b}function H(a){for(var b=new o,c=0,d=arguments.length;++c<d;)b[arguments[c]]=p(b);return b.of=function(c,d){return function(e){try{var f=e.sourceEvent=d3.event;e.target=a,d3.event=e,b[e.type].apply(c,d)}finally{d3.event=f}}},b}function I(a){return"transform"==a?d3.interpolateTransform:d3.interpolate}function J(a,b){return b=b-(a=+a)?1/(b-a):0,function(c){return(c-a)*b}}function K(a,b){return b=b-(a=+a)?1/(b-a):0,function(c){return Math.max(0,Math.min(1,(c-a)*b))}}function L(a,b,c){return new M(a,b,c)}function M(a,b,c){this.r=a,this.g=b,this.b=c}function N(a){return 16>a?"0"+Math.max(0,a).toString(16):Math.min(255,a).toString(16)}function O(a,b,c){var d,e,f,g=0,h=0,i=0;if(d=/([a-z]+)\((.*)\)/i.exec(a))switch(e=d[2].split(","),d[1]){case"hsl":return c(parseFloat(e[0]),parseFloat(e[1])/100,parseFloat(e[2])/100);case"rgb":return b(Q(e[0]),Q(e[1]),Q(e[2]))}return(f=Nd.get(a))?b(f.r,f.g,f.b):(null!=a&&"#"===a.charAt(0)&&(4===a.length?(g=a.charAt(1),g+=g,h=a.charAt(2),h+=h,i=a.charAt(3),i+=i):7===a.length&&(g=a.substring(1,3),h=a.substring(3,5),i=a.substring(5,7)),g=parseInt(g,16),h=parseInt(h,16),i=parseInt(i,16)),b(g,h,i))}function P(a,b,c){var d,e,f=Math.min(a/=255,b/=255,c/=255),g=Math.max(a,b,c),h=g-f,i=(g+f)/2;return h?(e=.5>i?h/(g+f):h/(2-g-f),d=a==g?(b-c)/h+(c>b?6:0):b==g?(c-a)/h+2:(a-b)/h+4,d*=60):e=d=0,R(d,e,i)}function Q(a){var b=parseFloat(a);return"%"===a.charAt(a.length-1)?Math.round(2.55*b):b}function R(a,b,c){return new S(a,b,c)}function S(a,b,c){this.h=a,this.s=b,this.l=c}function T(a,b,c){function d(a){return a>360?a-=360:0>a&&(a+=360),60>a?f+(g-f)*a/60:180>a?g:240>a?f+(g-f)*(240-a)/60:f}function e(a){return Math.round(255*d(a))}var f,g;return a%=360,0>a&&(a+=360),b=0>b?0:b>1?1:b,c=0>c?0:c>1?1:c,g=.5>=c?c*(1+b):c+b-c*b,f=2*c-g,L(e(a+120),e(a),e(a-120))}function U(a){return yd(a,Td),a}function V(a){return function(){return Od(a,this)}}function W(a){return function(){return Pd(a,this)}}function X(a,b){function c(){if(b=this.classList)return b.add(a);var b=this.className,c=null!=b.baseVal,d=c?b.baseVal:b;f.lastIndex=0,f.test(d)||(d=m(d+" "+a),c?b.baseVal=d:this.className=d)}function d(){if(b=this.classList)return b.remove(a);var b=this.className,c=null!=b.baseVal,d=c?b.baseVal:b;d=m(d.replace(f," ")),c?b.baseVal=d:this.className=d}function e(){(b.apply(this,arguments)?c:d).call(this)}var f=new RegExp("(^|\\s+)"+d3.requote(a)+"(\\s+|$)","g");if(arguments.length<2){var g=this.node();if(h=g.classList)return h.contains(a);var h=g.className;return f.lastIndex=0,f.test(null!=h.baseVal?h.baseVal:h)}return this.each("function"==typeof b?e:b?c:d)}function Y(a){return{__data__:a}}function Z(a){return function(){return Sd(this,a)}}function $(a){return arguments.length||(a=d3.ascending),function(b,c){return a(b&&b.__data__,c&&c.__data__)}}function _(a,b){for(var c=0,d=a.length;d>c;c++)for(var e,f=a[c],g=0,h=f.length;h>g;g++)(e=f[g])&&b(e,g,c);return a}function aa(a){return yd(a,Vd),a}function ba(a,b,c){yd(a,Xd);var e=new d,f=d3.dispatch("start","end"),g=de;return a.id=b,a.time=c,a.tween=function(b,c){return arguments.length<2?e.get(b):(null==c?e.remove(b):e.set(b,c),a)},a.ease=function(b){return arguments.length?(g="function"==typeof b?b:d3.ease.apply(d3,arguments),a):g},a.each=function(b,c){return arguments.length<2?ea.call(a,b):(f.on(b,c),a)},d3.timer(function(d){return _(a,function(a,h,i){function j(d){return p.active>b?l():(p.active=b,e.forEach(function(b,c){(c=c.call(a,q,h))&&m.push(c)}),f.start.call(a,q,h),k(d)||d3.timer(k,0,c),1)}function k(c){if(p.active!==b)return l();for(var d=(c-n)/o,e=g(d),i=m.length;i>0;)m[--i].call(a,e);return d>=1?(l(),Zd=b,f.end.call(a,q,h),Zd=0,1):void 0}function l(){return--p.count||delete a.__transition__,1}var m=[],n=a.delay,o=a.duration,p=(a=a.node).__transition__||(a.__transition__={active:0,count:0}),q=a.__data__;++p.count,d>=n?j(d):d3.timer(j,n,c)})},0,c),a}function ca(a,b,c){return""!=c&&Wd}function da(a,b){function c(a,c,d){var f=b.call(this,a,c);return null==f?""!=d&&Wd:d!=f&&e(d,f)}function d(a,c,d){return d!=b&&e(d,b)}var e=I(a);return"function"==typeof b?c:null==b?ca:(b+="",d)}function ea(a){var b=Zd,c=de,d=be,e=ce;return Zd=this.id,de=this.ease(),_(this,function(b,c,d){be=b.delay,ce=b.duration,a.call(b=b.node,b.__data__,c,d)}),Zd=b,de=c,be=d,ce=e,this}function fa(){for(var a,b=Date.now(),c=ge;c;)a=b-c.then,a>=c.delay&&(c.flush=c.callback(a)),c=c.next;var d=ga()-b;d>24?(isFinite(d)&&(clearTimeout(fe),fe=setTimeout(fa,d)),ee=0):(ee=1,he(fa))}function ga(){for(var a=null,b=ge,c=1/0;b;)b.flush?b=a?a.next=b.next:ge=b.next:(c=Math.min(c,b.then+b.delay),b=(a=b).next);return c}function ha(a){var b=[a.a,a.b],c=[a.c,a.d],d=ja(b),e=ia(b,c),f=ja(ka(c,b,-e))||0;b[0]*c[1]<c[0]*b[1]&&(b[0]*=-1,b[1]*=-1,d*=-1,e*=-1),this.rotate=(d?Math.atan2(b[1],b[0]):Math.atan2(-c[0],c[1]))*ie,this.translate=[a.e,a.f],this.scale=[d,f],this.skew=f?Math.atan2(e,f)*ie:0}function ia(a,b){return a[0]*b[0]+a[1]*b[1]}function ja(a){var b=Math.sqrt(ia(a,a));return b&&(a[0]/=b,a[1]/=b),b}function ka(a,b,c){return a[0]+=c*b[0],a[1]+=c*b[1],a}function la(a,b){var c=a.ownerSVGElement||a;if(c.createSVGPoint){var d=c.createSVGPoint();if(0>je&&(window.scrollX||window.scrollY)){c=d3.select(document.body).append("svg").style("position","absolute").style("top",0).style("left",0);var e=c[0][0].getScreenCTM();je=!(e.f||e.e),c.remove()}return je?(d.x=b.pageX,d.y=b.pageY):(d.x=b.clientX,d.y=b.clientY),d=d.matrixTransform(a.getScreenCTM().inverse()),[d.x,d.y]}var f=a.getBoundingClientRect();return[b.clientX-f.left-a.clientLeft,b.clientY-f.top-a.clientTop]}function ma(a){var b=a[0],c=a[a.length-1];return c>b?[b,c]:[c,b]}function na(a){return a.rangeExtent?a.rangeExtent():ma(a.range())}function oa(a,b){var c,d=0,e=a.length-1,f=a[d],g=a[e];return f>g&&(c=d,d=e,e=c,c=f,f=g,g=c),(c=g-f)&&(b=b(c),a[d]=b.floor(f),a[e]=b.ceil(g)),a}function pa(){return Math}function qa(a,b,c,d){function e(){var e=Math.min(a.length,b.length)>2?xa:wa,i=d?K:J;return g=e(a,b,i,c),h=e(b,a,i,d3.interpolate),f}function f(a){return g(a)}var g,h;return f.invert=function(a){return h(a)},f.domain=function(b){return arguments.length?(a=b.map(Number),e()):a},f.range=function(a){return arguments.length?(b=a,e()):b},f.rangeRound=function(a){return f.range(a).interpolate(d3.interpolateRound)},f.clamp=function(a){return arguments.length?(d=a,e()):d},f.interpolate=function(a){return arguments.length?(c=a,e()):c},f.ticks=function(b){return ua(a,b)},f.tickFormat=function(b){return va(a,b)},f.nice=function(){return oa(a,sa),e()},f.copy=function(){return qa(a,b,c,d)},e()}function ra(a,b){return d3.rebind(a,b,"range","rangeRound","interpolate","clamp")}function sa(a){return a=Math.pow(10,Math.round(Math.log(a)/Math.LN10)-1),{floor:function(b){return Math.floor(b/a)*a},ceil:function(b){return Math.ceil(b/a)*a}}}function ta(a,b){var c=ma(a),d=c[1]-c[0],e=Math.pow(10,Math.floor(Math.log(d/b)/Math.LN10)),f=b/d*e;return.15>=f?e*=10:.35>=f?e*=5:.75>=f&&(e*=2),c[0]=Math.ceil(c[0]/e)*e,c[1]=Math.floor(c[1]/e)*e+.5*e,c[2]=e,c}function ua(a,b){return d3.range.apply(d3,ta(a,b))}function va(a,b){return d3.format(",."+Math.max(0,-Math.floor(Math.log(ta(a,b)[2])/Math.LN10+.01))+"f")}function wa(a,b,c,d){var e=c(a[0],a[1]),f=d(b[0],b[1]);return function(a){return f(e(a))}}function xa(a,b,c,d){var e=[],f=[],g=0,h=Math.min(a.length,b.length)-1;for(a[h]<a[0]&&(a=a.slice().reverse(),b=b.slice().reverse());++g<=h;)e.push(c(a[g-1],a[g])),f.push(d(b[g-1],b[g]));return function(b){var c=d3.bisect(a,b,1,h)-1;return f[c](e[c](b))}}function ya(a,b){function c(c){return a(b(c))}var d=b.pow;return c.invert=function(b){return d(a.invert(b))},c.domain=function(e){return arguments.length?(b=e[0]<0?Aa:za,d=b.pow,a.domain(e.map(b)),c):a.domain().map(d)},c.nice=function(){return a.domain(oa(a.domain(),pa)),c},c.ticks=function(){var c=ma(a.domain()),e=[];if(c.every(isFinite)){var f=Math.floor(c[0]),g=Math.ceil(c[1]),h=d(c[0]),i=d(c[1]);if(b===Aa)for(e.push(d(f));f++<g;)for(var j=9;j>0;j--)e.push(d(f)*j);else{for(;g>f;f++)for(var j=1;10>j;j++)e.push(d(f)*j);e.push(d(f))}for(f=0;e[f]<h;f++);for(g=e.length;e[g-1]>i;g--);e=e.slice(f,g)}return e},c.tickFormat=function(a,e){if(arguments.length<2&&(e=ke),arguments.length<1)return e;var f,g=Math.max(.1,a/c.ticks().length),h=b===Aa?(f=-1e-12,Math.floor):(f=1e-12,Math.ceil);return function(a){return a/d(h(b(a)+f))<=g?e(a):""}},c.copy=function(){return ya(a.copy(),b)},ra(c,a)}function za(a){return Math.log(0>a?0:a)/Math.LN10}function Aa(a){return-Math.log(a>0?0:-a)/Math.LN10}function Ba(a,b){function c(b){return a(d(b))}var d=Ca(b),e=Ca(1/b);return c.invert=function(b){return e(a.invert(b))},c.domain=function(b){return arguments.length?(a.domain(b.map(d)),c):a.domain().map(e)},c.ticks=function(a){return ua(c.domain(),a)},c.tickFormat=function(a){return va(c.domain(),a)},c.nice=function(){return c.domain(oa(c.domain(),sa))},c.exponent=function(a){if(!arguments.length)return b;var f=c.domain();return d=Ca(b=a),e=Ca(1/b),c.domain(f)},c.copy=function(){return Ba(a.copy(),b)},ra(c,a)}function Ca(a){return function(b){return 0>b?-Math.pow(-b,a):Math.pow(b,a)}}function Da(a,b){function c(b){return g[((f.get(b)||f.set(b,a.push(b)))-1)%g.length]}function e(b,c){return d3.range(a.length).map(function(a){return b+c*a})}var f,g,h;return c.domain=function(e){if(!arguments.length)return a;a=[],f=new d;for(var g,h=-1,i=e.length;++h<i;)f.has(g=e[h])||f.set(g,a.push(g));return c[b.t](b.x,b.p)},c.range=function(a){return arguments.length?(g=a,h=0,b={t:"range",x:a},c):g},c.rangePoints=function(d,f){arguments.length<2&&(f=0);var i=d[0],j=d[1],k=(j-i)/(a.length-1+f);return g=e(a.length<2?(i+j)/2:i+k*f/2,k),h=0,b={t:"rangePoints",x:d,p:f},c},c.rangeBands=function(d,f){arguments.length<2&&(f=0);var i=d[1]<d[0],j=d[i-0],k=d[1-i],l=(k-j)/(a.length+f);return g=e(j+l*f,l),i&&g.reverse(),h=l*(1-f),b={t:"rangeBands",x:d,p:f},c},c.rangeRoundBands=function(d,f){arguments.length<2&&(f=0);var i=d[1]<d[0],j=d[i-0],k=d[1-i],l=Math.floor((k-j)/(a.length+f)),m=k-j-(a.length-f)*l;return g=e(j+Math.round(m/2),l),i&&g.reverse(),h=Math.round(l*(1-f)),b={t:"rangeRoundBands",x:d,p:f},c},c.rangeBand=function(){return h},c.rangeExtent=function(){return ma(b.x)},c.copy=function(){return Da(a,b)},c.domain(a)}function Ea(a,b){function c(){var c=0,f=(a.length,b.length);for(e=[];++c<f;)e[c-1]=d3.quantile(a,c/f);return d}function d(a){return isNaN(a=+a)?NaN:b[d3.bisect(e,a)]}var e;return d.domain=function(b){return arguments.length?(a=b.filter(function(a){return!isNaN(a)}).sort(d3.ascending),c()):a},d.range=function(a){return arguments.length?(b=a,c()):b},d.quantiles=function(){return e},d.copy=function(){return Ea(a,b)},c()}function Fa(a,b,c){function d(b){return c[Math.max(0,Math.min(g,Math.floor(f*(b-a))))]}function e(){return f=c.length/(b-a),g=c.length-1,d}var f,g;return d.domain=function(c){return arguments.length?(a=+c[0],b=+c[c.length-1],e()):[a,b]},d.range=function(a){return arguments.length?(c=a,e()):c},d.copy=function(){return Fa(a,b,c)},e()}function Ga(a){function b(a){return+a}return b.invert=b,b.domain=b.range=function(c){return arguments.length?(a=c.map(b),b):a},b.ticks=function(b){return ua(a,b)},b.tickFormat=function(b){return va(a,b)},b.copy=function(){return Ga(a)},b}function Ha(a){return a.innerRadius}function Ia(a){return a.outerRadius}function Ja(a){return a.startAngle}function Ka(a){return a.endAngle}function La(a){function b(b){function f(){k.push("M",i(a(l),j))}for(var g,k=[],l=[],m=-1,n=b.length,o=h(c),p=h(d);++m<n;)e.call(this,g=b[m],m)?l.push([+o.call(this,g,m),+p.call(this,g,m)]):l.length&&(f(),l=[]);return l.length&&f(),k.length?k.join(""):null}var c=Ma,d=Na,e=g,f=re,i=Oa,j=.7;return b.x=function(a){return arguments.length?(c=a,b):c},b.y=function(a){return arguments.length?(d=a,b):d},b.defined=function(a){return arguments.length?(e=a,b):e},b.interpolate=function(a){return arguments.length?(se.has(a+="")||(a=re),i=se.get(f=a),b):f},b.tension=function(a){return arguments.length?(j=a,b):j},b}function Ma(a){return a[0]}function Na(a){return a[1]}function Oa(a){for(var b=0,c=a.length,d=a[0],e=[d[0],",",d[1]];++b<c;)e.push("L",(d=a[b])[0],",",d[1]);return e.join("")}function Pa(a){for(var b=0,c=a.length,d=a[0],e=[d[0],",",d[1]];++b<c;)e.push("V",(d=a[b])[1],"H",d[0]);return e.join("")}function Qa(a){for(var b=0,c=a.length,d=a[0],e=[d[0],",",d[1]];++b<c;)e.push("H",(d=a[b])[0],"V",d[1]);return e.join("")}function Ra(a,b){return a.length<4?Oa(a):a[1]+Ua(a.slice(1,a.length-1),Va(a,b))}function Sa(a,b){return a.length<3?Oa(a):a[0]+Ua((a.push(a[0]),a),Va([a[a.length-2]].concat(a,[a[1]]),b))}function Ta(a,b,c){return a.length<3?Oa(a):a[0]+Ua(a,Va(a,b))}function Ua(a,b){if(b.length<1||a.length!=b.length&&a.length!=b.length+2)return Oa(a);var c=a.length!=b.length,d="",e=a[0],f=a[1],g=b[0],h=g,i=1;if(c&&(d+="Q"+(f[0]-2*g[0]/3)+","+(f[1]-2*g[1]/3)+","+f[0]+","+f[1],e=a[1],i=2),b.length>1){h=b[1],f=a[i],i++,d+="C"+(e[0]+g[0])+","+(e[1]+g[1])+","+(f[0]-h[0])+","+(f[1]-h[1])+","+f[0]+","+f[1];for(var j=2;j<b.length;j++,i++)f=a[i],h=b[j],d+="S"+(f[0]-h[0])+","+(f[1]-h[1])+","+f[0]+","+f[1]}if(c){var k=a[i];d+="Q"+(f[0]+2*h[0]/3)+","+(f[1]+2*h[1]/3)+","+k[0]+","+k[1]}return d}function Va(a,b){for(var c,d=[],e=(1-b)/2,f=a[0],g=a[1],h=1,i=a.length;++h<i;)c=f,f=g,g=a[h],d.push([e*(g[0]-c[0]),e*(g[1]-c[1])]);return d}function Wa(a){if(a.length<3)return Oa(a);var b=1,c=a.length,d=a[0],e=d[0],f=d[1],g=[e,e,e,(d=a[1])[0]],h=[f,f,f,d[1]],i=[e,",",f];for(_a(i,g,h);++b<c;)d=a[b],g.shift(),g.push(d[0]),h.shift(),h.push(d[1]),_a(i,g,h);for(b=-1;++b<2;)g.shift(),g.push(d[0]),h.shift(),h.push(d[1]),_a(i,g,h);return i.join("")}function Xa(a){if(a.length<4)return Oa(a);for(var b,c=[],d=-1,e=a.length,f=[0],g=[0];++d<3;)b=a[d],f.push(b[0]),g.push(b[1]);for(c.push($a(ve,f)+","+$a(ve,g)),--d;++d<e;)b=a[d],f.shift(),f.push(b[0]),g.shift(),g.push(b[1]),_a(c,f,g);return c.join("")}function Ya(a){for(var b,c,d=-1,e=a.length,f=e+4,g=[],h=[];++d<4;)c=a[d%e],g.push(c[0]),h.push(c[1]);for(b=[$a(ve,g),",",$a(ve,h)],--d;++d<f;)c=a[d%e],g.shift(),g.push(c[0]),h.shift(),h.push(c[1]),_a(b,g,h);return b.join("")}function Za(a,b){var c=a.length-1;if(c)for(var d,e,f=a[0][0],g=a[0][1],h=a[c][0]-f,i=a[c][1]-g,j=-1;++j<=c;)d=a[j],e=j/c,d[0]=b*d[0]+(1-b)*(f+e*h),d[1]=b*d[1]+(1-b)*(g+e*i);return Wa(a)}function $a(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]}function _a(a,b,c){a.push("C",$a(te,b),",",$a(te,c),",",$a(ue,b),",",$a(ue,c),",",$a(ve,b),",",$a(ve,c))}function ab(a,b){return(b[1]-a[1])/(b[0]-a[0])}function bb(a){for(var b=0,c=a.length-1,d=[],e=a[0],f=a[1],g=d[0]=ab(e,f);++b<c;)d[b]=g+(g=ab(e=f,f=a[b+1]));return d[b]=g,d}function cb(a){for(var b,c,d,e,f=[],g=bb(a),h=-1,i=a.length-1;++h<i;)b=ab(a[h],a[h+1]),Math.abs(b)<1e-6?g[h]=g[h+1]=0:(c=g[h]/b,d=g[h+1]/b,e=c*c+d*d,e>9&&(e=3*b/Math.sqrt(e),g[h]=e*c,g[h+1]=e*d));for(h=-1;++h<=i;)e=(a[Math.min(i,h+1)][0]-a[Math.max(0,h-1)][0])/(6*(1+g[h]*g[h])),f.push([e||0,g[h]*e||0]);return f}function db(a){return a.length<3?Oa(a):a[0]+Ua(a,cb(a))}function eb(a){for(var b,c,d,e=-1,f=a.length;++e<f;)b=a[e],c=b[0],d=b[1]+pe,b[0]=c*Math.cos(d),b[1]=c*Math.sin(d);return a}function fb(a){function b(b){function g(){q.push("M",k(a(s),n),m,l(a(r.reverse()),n),"Z")}for(var j,o,p,q=[],r=[],s=[],t=-1,u=b.length,v=h(c),w=h(e),x=c===d?function(){return o}:h(d),y=e===f?function(){return p}:h(f);++t<u;)i.call(this,j=b[t],t)?(r.push([o=+v.call(this,j,t),p=+w.call(this,j,t)]),s.push([+x.call(this,j,t),+y.call(this,j,t)])):r.length&&(g(),r=[],s=[]);return r.length&&g(),q.length?q.join(""):null}var c=Ma,d=Ma,e=0,f=Na,i=g,j=re,k=Oa,l=Oa,m="L",n=.7;return b.x=function(a){return arguments.length?(c=d=a,b):d},b.x0=function(a){return arguments.length?(c=a,b):c},b.x1=function(a){return arguments.length?(d=a,b):d},b.y=function(a){return arguments.length?(e=f=a,b):f},b.y0=function(a){return arguments.length?(e=a,b):e},b.y1=function(a){return arguments.length?(f=a,b):f},b.defined=function(a){return arguments.length?(i=a,b):i},b.interpolate=function(a){return arguments.length?(se.has(a+="")||(a=re),k=se.get(j=a),l=k.reverse||k,m=/-closed$/.test(a)?"M":"L",b):j},b.tension=function(a){return arguments.length?(n=a,b):n},b}function gb(a){return a.source}function hb(a){return a.target}function ib(a){return a.radius}function jb(a){return[a.x,a.y]}function kb(a){return function(){var b=a.apply(this,arguments),c=b[0],d=b[1]+pe;return[c*Math.cos(d),c*Math.sin(d)]}}function lb(){return 64}function mb(){return"circle"}function nb(a){var b=Math.sqrt(a/Math.PI);return"M0,"+b+"A"+b+","+b+" 0 1,1 0,"+-b+"A"+b+","+b+" 0 1,1 0,"+b+"Z"}function ob(a,b){a.attr("transform",function(a){return"translate("+b(a)+",0)"})}function pb(a,b){a.attr("transform",function(a){return"translate(0,"+b(a)+")"})}function qb(a,b,c){if(d=[],c&&b.length>1){for(var d,e,f,g=ma(a.domain()),h=-1,i=b.length,j=(b[1]-b[0])/++c;++h<i;)for(e=c;--e>0;)(f=+b[h]-e*j)>=g[0]&&d.push(f);for(--h,e=0;++e<c&&(f=+b[h]+e*j)<g[1];)d.push(f)}return d}function rb(){Be||(Be=d3.select("body").append("div").style("visibility","hidden").style("top",0).style("height",0).style("width",0).style("overflow-y","scroll").append("div").style("height","2000px").node().parentNode);var a,b=d3.event;try{Be.scrollTop=1e3,Be.dispatchEvent(b),a=1e3-Be.scrollTop}catch(c){a=b.wheelDelta||5*-b.detail}return a}function sb(a){for(var b=a.source,c=a.target,d=ub(b,c),e=[b];b!==d;)b=b.parent,e.push(b);for(var f=e.length;c!==d;)e.splice(f,0,c),c=c.parent;return e}function tb(a){for(var b=[],c=a.parent;null!=c;)b.push(a),a=c,c=c.parent;return b.push(a),b}function ub(a,b){if(a===b)return a;for(var c=tb(a),d=tb(b),e=c.pop(),f=d.pop(),g=null;e===f;)g=e,e=c.pop(),f=d.pop();return g}function vb(a){a.fixed|=2}function wb(a){a!==Ee&&(a.fixed&=1)}function xb(){Ee.fixed&=1,De=Ee=null}function yb(){Ee.px=d3.event.x,Ee.py=d3.event.y,De.resume()}function zb(a,b,c){var d=0,e=0;if(a.charge=0,!a.leaf)for(var f,g=a.nodes,h=g.length,i=-1;++i<h;)f=g[i],null!=f&&(zb(f,b,c),a.charge+=f.charge,d+=f.charge*f.cx,e+=f.charge*f.cy);if(a.point){a.leaf||(a.point.x+=Math.random()-.5,a.point.y+=Math.random()-.5);var j=b*c[a.point.index];a.charge+=a.pointCharge=j,d+=j*a.point.x,e+=j*a.point.y}a.cx=d/a.charge,a.cy=e/a.charge}function Ab(a){return 20}function Bb(a){return 1}function Cb(a){return a.x}function Db(a){return a.y}function Eb(a,b,c){a.y0=b,a.y=c}function Fb(a){return d3.range(a.length)}function Gb(a){for(var b=-1,c=a[0].length,d=[];++b<c;)d[b]=0;return d}function Hb(a){for(var b,c=1,d=0,e=a[0][1],f=a.length;f>c;++c)(b=a[c][1])>e&&(d=c,e=b);return d}function Ib(a){return a.reduce(Jb,0)}function Jb(a,b){return a+b[1]}function Kb(a,b){return Lb(a,Math.ceil(Math.log(b.length)/Math.LN2+1))}function Lb(a,b){for(var c=-1,d=+a[0],e=(a[1]-d)/b,f=[];++c<=b;)f[c]=e*c+d;return f}function Mb(a){return[d3.min(a),d3.max(a)]}function Nb(a,b){return d3.rebind(a,b,"sort","children","value"),a.links=Rb,a.nodes=function(b){return Ie=!0,(a.nodes=a)(b)},a}function Ob(a){return a.children}function Pb(a){return a.value}function Qb(a,b){return b.value-a.value}function Rb(a){return d3.merge(a.map(function(a){return(a.children||[]).map(function(b){return{source:a,target:b}})}))}function Sb(a,b){return a.value-b.value}function Tb(a,b){var c=a._pack_next;a._pack_next=b,b._pack_prev=a,b._pack_next=c,c._pack_prev=b}function Ub(a,b){a._pack_next=b,b._pack_prev=a}function Vb(a,b){var c=b.x-a.x,d=b.y-a.y,e=a.r+b.r;return e*e-c*c-d*d>.001}function Wb(a){function b(a){h=Math.min(a.x-a.r,h),i=Math.max(a.x+a.r,i),j=Math.min(a.y-a.r,j),k=Math.max(a.y+a.r,k)}var c,d,e,f,g,h=1/0,i=-(1/0),j=1/0,k=-(1/0),l=a.length;if(a.forEach(Xb),c=a[0],c.x=-c.r,c.y=0,b(c),l>1&&(d=a[1],d.x=d.r,d.y=0,
b(d),l>2)){e=a[2],_b(c,d,e),b(e),Tb(c,e),c._pack_prev=e,Tb(e,d),d=c._pack_next;for(var m=3;l>m;m++){_b(c,d,e=a[m]);var n=0,o=1,p=1;for(f=d._pack_next;f!==d;f=f._pack_next,o++)if(Vb(f,e)){n=1;break}if(1==n)for(g=c._pack_prev;g!==f._pack_prev&&!Vb(g,e);g=g._pack_prev,p++);n?(p>o||o==p&&d.r<c.r?Ub(c,d=f):Ub(c=g,d),m--):(Tb(c,e),d=e,b(e))}}for(var q=(h+i)/2,r=(j+k)/2,s=0,m=0;l>m;m++){var t=a[m];t.x-=q,t.y-=r,s=Math.max(s,t.r+Math.sqrt(t.x*t.x+t.y*t.y))}return a.forEach(Yb),s}function Xb(a){a._pack_next=a._pack_prev=a}function Yb(a){delete a._pack_next,delete a._pack_prev}function Zb(a){var b=a.children;b&&b.length?(b.forEach(Zb),a.r=Wb(b)):a.r=Math.sqrt(a.value)}function $b(a,b,c,d){var e=a.children;if(a.x=b+=d*a.x,a.y=c+=d*a.y,a.r*=d,e)for(var f=-1,g=e.length;++f<g;)$b(e[f],b,c,d)}function _b(a,b,c){var d=a.r+c.r,e=b.x-a.x,f=b.y-a.y;if(d&&(e||f)){var g=b.r+c.r,h=Math.sqrt(e*e+f*f),i=Math.max(-1,Math.min(1,(d*d+h*h-g*g)/(2*d*h))),j=Math.acos(i),k=i*(d/=h),l=Math.sin(j)*d;c.x=a.x+k*e+l*f,c.y=a.y+k*f-l*e}else c.x=a.x+d,c.y=a.y}function ac(a){return 1+d3.max(a,function(a){return a.y})}function bc(a){return a.reduce(function(a,b){return a+b.x},0)/a.length}function cc(a){var b=a.children;return b&&b.length?cc(b[0]):a}function dc(a){var b,c=a.children;return c&&(b=c.length)?dc(c[b-1]):a}function ec(a,b){return a.parent==b.parent?1:2}function fc(a){var b=a.children;return b&&b.length?b[0]:a._tree.thread}function gc(a){var b,c=a.children;return c&&(b=c.length)?c[b-1]:a._tree.thread}function hc(a,b){var c=a.children;if(c&&(e=c.length))for(var d,e,f=-1;++f<e;)b(d=hc(c[f],b),a)>0&&(a=d);return a}function ic(a,b){return a.x-b.x}function jc(a,b){return b.x-a.x}function kc(a,b){return a.depth-b.depth}function lc(a,b){function c(a,d){var e=a.children;if(e&&(g=e.length))for(var f,g,h=null,i=-1;++i<g;)f=e[i],c(f,h),h=f;b(a,d)}c(a,null)}function mc(a){for(var b,c=0,d=0,e=a.children,f=e.length;--f>=0;)b=e[f]._tree,b.prelim+=c,b.mod+=c,c+=b.shift+(d+=b.change)}function nc(a,b,c){a=a._tree,b=b._tree;var d=c/(b.number-a.number);a.change+=d,b.change-=d,b.shift+=c,b.prelim+=c,b.mod+=c}function oc(a,b,c){return a._tree.ancestor.parent==b.parent?a._tree.ancestor:c}function pc(a){return{x:a.x,y:a.y,dx:a.dx,dy:a.dy}}function qc(a,b){var c=a.x+b[3],d=a.y+b[0],e=a.dx-b[1]-b[3],f=a.dy-b[0]-b[2];return 0>e&&(c+=e/2,e=0),0>f&&(d+=f/2,f=0),{x:c,y:d,dx:e,dy:f}}function rc(a){return a.map(sc).join(",")}function sc(a){return/[",\n]/.test(a)?'"'+a.replace(/\"/g,'""')+'"':a}function tc(a,b){return function(c){return c&&a.hasOwnProperty(c.type)?a[c.type](c):b}}function uc(a){return"m0,"+a+"a"+a+","+a+" 0 1,1 0,"+-2*a+"a"+a+","+a+" 0 1,1 0,"+2*a+"z"}function vc(a,b){Ke.hasOwnProperty(a.type)&&Ke[a.type](a,b)}function wc(a,b){vc(a.geometry,b)}function xc(a,b){for(var c=a.features,d=0,e=c.length;e>d;d++)vc(c[d].geometry,b)}function yc(a,b){for(var c=a.geometries,d=0,e=c.length;e>d;d++)vc(c[d],b)}function zc(a,b){for(var c=a.coordinates,d=0,e=c.length;e>d;d++)b.apply(null,c[d])}function Ac(a,b){for(var c=a.coordinates,d=0,e=c.length;e>d;d++)for(var f=c[d],g=0,h=f.length;h>g;g++)b.apply(null,f[g])}function Bc(a,b){for(var c=a.coordinates,d=0,e=c.length;e>d;d++)for(var f=c[d][0],g=0,h=f.length;h>g;g++)b.apply(null,f[g])}function Cc(a,b){b.apply(null,a.coordinates)}function Dc(a,b){for(var c=a.coordinates[0],d=0,e=c.length;e>d;d++)b.apply(null,c[d])}function Ec(a){return a.source}function Fc(a){return a.target}function Gc(){function a(a){var b=Math.sin(a*=n)*o,c=Math.sin(n-a)*o,d=c*f+b*l,h=c*g+b*m,i=c*e+b*k;return[Math.atan2(h,d)/Je,Math.atan2(i,Math.sqrt(d*d+h*h))/Je]}var b,c,d,e,f,g,h,i,j,k,l,m,n,o;return a.distance=function(){return null==n&&(o=1/Math.sin(n=Math.acos(Math.max(-1,Math.min(1,e*k+d*j*Math.cos(h-b)))))),n},a.source=function(h){var i=Math.cos(b=h[0]*Je),j=Math.sin(b);return d=Math.cos(c=h[1]*Je),e=Math.sin(c),f=d*i,g=d*j,n=null,a},a.target=function(b){var c=Math.cos(h=b[0]*Je),d=Math.sin(h);return j=Math.cos(i=b[1]*Je),k=Math.sin(i),l=j*c,m=j*d,n=null,a},a}function Hc(a,b){var c=Gc().source(a).target(b);return c.distance(),c}function Ic(a){for(var b=0,c=0;;){if(a(b,c))return[b,c];0===b?(b=c+1,c=0):(b-=1,c+=1)}}function Jc(a,b,c,d){var e,f,g,h,i,j,k;return e=d[a],f=e[0],g=e[1],e=d[b],h=e[0],i=e[1],e=d[c],j=e[0],k=e[1],(k-g)*(h-f)-(i-g)*(j-f)>0}function Kc(a,b,c){return(c[0]-b[0])*(a[1]-b[1])<(c[1]-b[1])*(a[0]-b[0])}function Lc(a,b,c,d){var e=a[0],f=b[0],g=c[0],h=d[0],i=a[1],j=b[1],k=c[1],l=d[1],m=e-g,n=f-e,o=h-g,p=i-k,q=j-i,r=l-k,s=(o*p-r*m)/(r*n-o*q);return[e+s*n,i+s*q]}function Mc(a,b){var c={list:a.map(function(a,b){return{index:b,x:a[0],y:a[1]}}).sort(function(a,b){return a.y<b.y?-1:a.y>b.y?1:a.x<b.x?-1:a.x>b.x?1:0}),bottomSite:null},d={list:[],leftEnd:null,rightEnd:null,init:function(){d.leftEnd=d.createHalfEdge(null,"l"),d.rightEnd=d.createHalfEdge(null,"l"),d.leftEnd.r=d.rightEnd,d.rightEnd.l=d.leftEnd,d.list.unshift(d.leftEnd,d.rightEnd)},createHalfEdge:function(a,b){return{edge:a,side:b,vertex:null,l:null,r:null}},insert:function(a,b){b.l=a,b.r=a.r,a.r.l=b,a.r=b},leftBound:function(a){var b=d.leftEnd;do b=b.r;while(b!=d.rightEnd&&e.rightOf(b,a));return b=b.l},del:function(a){a.l.r=a.r,a.r.l=a.l,a.edge=null},right:function(a){return a.r},left:function(a){return a.l},leftRegion:function(a){return null==a.edge?c.bottomSite:a.edge.region[a.side]},rightRegion:function(a){return null==a.edge?c.bottomSite:a.edge.region[Ne[a.side]]}},e={bisect:function(a,b){var c={region:{l:a,r:b},ep:{l:null,r:null}},d=b.x-a.x,e=b.y-a.y,f=d>0?d:-d,g=e>0?e:-e;return c.c=a.x*d+a.y*e+.5*(d*d+e*e),f>g?(c.a=1,c.b=e/d,c.c/=d):(c.b=1,c.a=d/e,c.c/=e),c},intersect:function(a,b){var c=a.edge,d=b.edge;if(!c||!d||c.region.r==d.region.r)return null;var e=c.a*d.b-c.b*d.a;if(Math.abs(e)<1e-10)return null;var f,g,h=(c.c*d.b-d.c*c.b)/e,i=(d.c*c.a-c.c*d.a)/e,j=c.region.r,k=d.region.r;j.y<k.y||j.y==k.y&&j.x<k.x?(f=a,g=c):(f=b,g=d);var l=h>=g.region.r.x;return l&&"l"===f.side||!l&&"r"===f.side?null:{x:h,y:i}},rightOf:function(a,b){var c=a.edge,d=c.region.r,e=b.x>d.x;if(e&&"l"===a.side)return 1;if(!e&&"r"===a.side)return 0;if(1===c.a){var f=b.y-d.y,g=b.x-d.x,h=0,i=0;if(!e&&c.b<0||e&&c.b>=0?i=h=f>=c.b*g:(i=b.x+b.y*c.b>c.c,c.b<0&&(i=!i),i||(h=1)),!h){var j=d.x-c.region.l.x;i=c.b*(g*g-f*f)<j*f*(1+2*g/j+c.b*c.b),c.b<0&&(i=!i)}}else{var k=c.c-c.a*b.x,l=b.y-k,m=b.x-d.x,n=k-d.y;i=l*l>m*m+n*n}return"l"===a.side?i:!i},endPoint:function(a,c,d){a.ep[c]=d,a.ep[Ne[c]]&&b(a)},distance:function(a,b){var c=a.x-b.x,d=a.y-b.y;return Math.sqrt(c*c+d*d)}},f={list:[],insert:function(a,b,c){a.vertex=b,a.ystar=b.y+c;for(var d=0,e=f.list,g=e.length;g>d;d++){var h=e[d];if(!(a.ystar>h.ystar||a.ystar==h.ystar&&b.x>h.vertex.x))break}e.splice(d,0,a)},del:function(a){for(var b=0,c=f.list,d=c.length;d>b&&c[b]!=a;++b);c.splice(b,1)},empty:function(){return 0===f.list.length},nextEvent:function(a){for(var b=0,c=f.list,d=c.length;d>b;++b)if(c[b]==a)return c[b+1];return null},min:function(){var a=f.list[0];return{x:a.vertex.x,y:a.ystar}},extractMin:function(){return f.list.shift()}};d.init(),c.bottomSite=c.list.shift();for(var g,h,i,j,k,l,m,n,o,p,q,r,s,t=c.list.shift();;)if(f.empty()||(g=f.min()),t&&(f.empty()||t.y<g.y||t.y==g.y&&t.x<g.x))h=d.leftBound(t),i=d.right(h),m=d.rightRegion(h),r=e.bisect(m,t),l=d.createHalfEdge(r,"l"),d.insert(h,l),p=e.intersect(h,l),p&&(f.del(h),f.insert(h,p,e.distance(p,t))),h=l,l=d.createHalfEdge(r,"r"),d.insert(h,l),p=e.intersect(l,i),p&&f.insert(l,p,e.distance(p,t)),t=c.list.shift();else{if(f.empty())break;h=f.extractMin(),j=d.left(h),i=d.right(h),k=d.right(i),m=d.leftRegion(h),n=d.rightRegion(i),q=h.vertex,e.endPoint(h.edge,h.side,q),e.endPoint(i.edge,i.side,q),d.del(h),f.del(i),d.del(i),s="l",m.y>n.y&&(o=m,m=n,n=o,s="r"),r=e.bisect(m,n),l=d.createHalfEdge(r,s),d.insert(j,l),e.endPoint(r,Ne[s],q),p=e.intersect(j,l),p&&(f.del(j),f.insert(j,p,e.distance(p,m))),p=e.intersect(l,k),p&&f.insert(l,p,e.distance(p,m))}for(h=d.right(d.leftEnd);h!=d.rightEnd;h=d.right(h))b(h.edge)}function Nc(){return{leaf:!0,nodes:[],point:null}}function Oc(a,b,c,d,e,f){if(!a(b,c,d,e,f)){var g=.5*(c+e),h=.5*(d+f),i=b.nodes;i[0]&&Oc(a,i[0],c,d,g,h),i[1]&&Oc(a,i[1],g,d,e,h),i[2]&&Oc(a,i[2],c,h,g,f),i[3]&&Oc(a,i[3],g,h,e,f)}}function Pc(a){return{x:a[0],y:a[1]}}function Qc(){this._=new Date(arguments.length>1?Date.UTC.apply(this,arguments):arguments[0])}function Rc(a,b,c,d){for(var e,f,g=0,h=b.length,i=c.length;h>g;){if(d>=i)return-1;if(e=b.charCodeAt(g++),37==e){if(f=Ve[b.charAt(g++)],!f||(d=f(a,c,d))<0)return-1}else if(e!=c.charCodeAt(d++))return-1}return d}function Sc(a,b,c){return We.test(b.substring(c,c+=3))?c:-1}function Tc(a,b,c){Xe.lastIndex=0;var d=Xe.exec(b.substring(c,c+10));return d?c+=d[0].length:-1}function Uc(a,b,c){var d=Ze.get(b.substring(c,c+=3).toLowerCase());return null==d?-1:(a.m=d,c)}function Vc(a,b,c){$e.lastIndex=0;var d=$e.exec(b.substring(c,c+12));return d?(a.m=_e.get(d[0].toLowerCase()),c+=d[0].length):-1}function Wc(a,b,c){return Rc(a,Ue.c.toString(),b,c)}function Xc(a,b,c){return Rc(a,Ue.x.toString(),b,c)}function Yc(a,b,c){return Rc(a,Ue.X.toString(),b,c)}function Zc(a,b,c){bf.lastIndex=0;var d=bf.exec(b.substring(c,c+4));return d?(a.y=+d[0],c+=d[0].length):-1}function $c(a,b,c){bf.lastIndex=0;var d=bf.exec(b.substring(c,c+2));return d?(a.y=_c()+ +d[0],c+=d[0].length):-1}function _c(){return 1e3*~~((new Date).getFullYear()/1e3)}function ad(a,b,c){bf.lastIndex=0;var d=bf.exec(b.substring(c,c+2));return d?(a.m=d[0]-1,c+=d[0].length):-1}function bd(a,b,c){bf.lastIndex=0;var d=bf.exec(b.substring(c,c+2));return d?(a.d=+d[0],c+=d[0].length):-1}function cd(a,b,c){bf.lastIndex=0;var d=bf.exec(b.substring(c,c+2));return d?(a.H=+d[0],c+=d[0].length):-1}function dd(a,b,c){bf.lastIndex=0;var d=bf.exec(b.substring(c,c+2));return d?(a.M=+d[0],c+=d[0].length):-1}function ed(a,b,c){bf.lastIndex=0;var d=bf.exec(b.substring(c,c+2));return d?(a.S=+d[0],c+=d[0].length):-1}function fd(a,b,c){bf.lastIndex=0;var d=bf.exec(b.substring(c,c+3));return d?(a.L=+d[0],c+=d[0].length):-1}function gd(a,b,c){var d=cf.get(b.substring(c,c+=2).toLowerCase());return null==d?-1:(a.p=d,c)}function hd(a){var b=a.getTimezoneOffset(),c=b>0?"-":"+",d=~~(Math.abs(b)/60),e=Math.abs(b)%60;return c+Qe(d)+Qe(e)}function id(a){return a.toISOString()}function jd(a,b,c){function d(b){var c=a(b),d=f(c,1);return d-b>b-c?c:d}function e(c){return b(c=a(new Oe(c-1)),1),c}function f(a,c){return b(a=new Oe(+a),c),a}function g(a,d,f){var g=e(a),h=[];if(f>1)for(;d>g;)c(g)%f||h.push(new Date(+g)),b(g,1);else for(;d>g;)h.push(new Date(+g)),b(g,1);return h}function h(a,b,c){try{Oe=Qc;var d=new Qc;return d._=a,g(d,b,c)}finally{Oe=Date}}a.floor=a,a.round=d,a.ceil=e,a.offset=f,a.range=g;var i=a.utc=kd(a);return i.floor=i,i.round=kd(d),i.ceil=kd(e),i.offset=kd(f),i.range=h,a}function kd(a){return function(b,c){try{Oe=Qc;var d=new Qc;return d._=b,a(d,c)._}finally{Oe=Date}}}function ld(a,b,c){function d(b){return a(b)}return d.invert=function(b){return nd(a.invert(b))},d.domain=function(b){return arguments.length?(a.domain(b),d):a.domain().map(nd)},d.nice=function(a){var b=md(d.domain());return d.domain([a.floor(b[0]),a.ceil(b[1])])},d.ticks=function(c,e){var f=md(d.domain());if("function"!=typeof c){var g=f[1]-f[0],h=g/c,i=d3.bisect(ef,h);if(i==ef.length)return b.year(f,c);if(!i)return a.ticks(c).map(nd);Math.log(h/ef[i-1])<Math.log(ef[i]/h)&&--i,c=b[i],e=c[1],c=c[0].range}return c(f[0],new Date(+f[1]+1),e)},d.tickFormat=function(){return c},d.copy=function(){return ld(a.copy(),b,c)},d3.rebind(d,a,"range","rangeRound","interpolate","clamp")}function md(a){var b=a[0],c=a[a.length-1];return c>b?[b,c]:[c,b]}function nd(a){return new Date(a)}function od(a){return function(b){for(var c=a.length-1,d=a[c];!d[1](b);)d=a[--c];return d[0](b)}}function pd(a){var b=new Date(a,0,1);return b.setFullYear(a),b}function qd(a){var b=a.getFullYear(),c=pd(b),d=pd(b+1);return b+(a-c)/(d-c)}function rd(a){var b=new Date(Date.UTC(a,0,1));return b.setUTCFullYear(a),b}function sd(a){var b=a.getUTCFullYear(),c=rd(b),d=rd(b+1);return b+(a-c)/(d-c)}Date.now||(Date.now=function(){return+new Date});try{document.createElement("div").style.setProperty("opacity",0,"")}catch(td){var ud=CSSStyleDeclaration.prototype,vd=ud.setProperty;ud.setProperty=function(a,b,c){vd.call(this,a,b+"",c)}}d3={version:"2.9.6"};var wd=c;try{wd(document.documentElement.childNodes)[0].nodeType}catch(xd){wd=b}var yd=[].__proto__?function(a,b){a.__proto__=b}:function(a,b){for(var c in b)a[c]=b[c]};d3.map=function(a){var b=new d;for(var c in a)b.set(c,a[c]);return b},a(d,{has:function(a){return zd+a in this},get:function(a){return this[zd+a]},set:function(a,b){return this[zd+a]=b},remove:function(a){return a=zd+a,a in this&&delete this[a]},keys:function(){var a=[];return this.forEach(function(b){a.push(b)}),a},values:function(){var a=[];return this.forEach(function(b,c){a.push(c)}),a},entries:function(){var a=[];return this.forEach(function(b,c){a.push({key:b,value:c})}),a},forEach:function(a){for(var b in this)b.charCodeAt(0)===Ad&&a.call(this,b.substring(1),this[b])}});var zd="\x00",Ad=zd.charCodeAt(0);d3.functor=h,d3.rebind=function(a,b){for(var c,d=1,e=arguments.length;++d<e;)a[c=arguments[d]]=i(a,b,b[c]);return a},d3.ascending=function(a,b){return b>a?-1:a>b?1:a>=b?0:NaN},d3.descending=function(a,b){return a>b?-1:b>a?1:b>=a?0:NaN},d3.mean=function(a,b){var c,d=a.length,e=0,f=-1,g=0;if(1===arguments.length)for(;++f<d;)j(c=a[f])&&(e+=(c-e)/++g);else for(;++f<d;)j(c=b.call(a,a[f],f))&&(e+=(c-e)/++g);return g?e:void 0},d3.median=function(a,b){return arguments.length>1&&(a=a.map(b)),a=a.filter(j),a.length?d3.quantile(a.sort(d3.ascending),.5):void 0},d3.min=function(a,b){var c,d,e=-1,f=a.length;if(1===arguments.length){for(;++e<f&&(null==(c=a[e])||c!=c);)c=void 0;for(;++e<f;)null!=(d=a[e])&&c>d&&(c=d)}else{for(;++e<f&&(null==(c=b.call(a,a[e],e))||c!=c);)c=void 0;for(;++e<f;)null!=(d=b.call(a,a[e],e))&&c>d&&(c=d)}return c},d3.max=function(a,b){var c,d,e=-1,f=a.length;if(1===arguments.length){for(;++e<f&&(null==(c=a[e])||c!=c);)c=void 0;for(;++e<f;)null!=(d=a[e])&&d>c&&(c=d)}else{for(;++e<f&&(null==(c=b.call(a,a[e],e))||c!=c);)c=void 0;for(;++e<f;)null!=(d=b.call(a,a[e],e))&&d>c&&(c=d)}return c},d3.extent=function(a,b){var c,d,e,f=-1,g=a.length;if(1===arguments.length){for(;++f<g&&(null==(c=e=a[f])||c!=c);)c=e=void 0;for(;++f<g;)null!=(d=a[f])&&(c>d&&(c=d),d>e&&(e=d))}else{for(;++f<g&&(null==(c=e=b.call(a,a[f],f))||c!=c);)c=void 0;for(;++f<g;)null!=(d=b.call(a,a[f],f))&&(c>d&&(c=d),d>e&&(e=d))}return[c,e]},d3.random={normal:function(a,b){return arguments.length<2&&(b=1),arguments.length<1&&(a=0),function(){var c,d,e;do c=2*Math.random()-1,d=2*Math.random()-1,e=c*c+d*d;while(!e||e>1);return a+b*c*Math.sqrt(-2*Math.log(e)/e)}}},d3.sum=function(a,b){var c,d=0,e=a.length,f=-1;if(1===arguments.length)for(;++f<e;)isNaN(c=+a[f])||(d+=c);else for(;++f<e;)isNaN(c=+b.call(a,a[f],f))||(d+=c);return d},d3.quantile=function(a,b){var c=(a.length-1)*b+1,d=Math.floor(c),e=a[d-1],f=c-d;return f?e+f*(a[d]-e):e},d3.transpose=function(a){return d3.zip.apply(d3,a)},d3.zip=function(){if(!(d=arguments.length))return[];for(var a=-1,b=d3.min(arguments,k),c=new Array(b);++a<b;)for(var d,e=-1,f=c[a]=new Array(d);++e<d;)f[e]=arguments[e][a];return c},d3.bisector=function(a){return{left:function(b,c,d,e){for(arguments.length<3&&(d=0),arguments.length<4&&(e=b.length);e>d;){var f=d+e>>1;a.call(b,b[f],f)<c?d=f+1:e=f}return d},right:function(b,c,d,e){for(arguments.length<3&&(d=0),arguments.length<4&&(e=b.length);e>d;){var f=d+e>>1;c<a.call(b,b[f],f)?e=f:d=f+1}return d}}};var Bd=d3.bisector(function(a){return a});d3.bisectLeft=Bd.left,d3.bisect=d3.bisectRight=Bd.right,d3.first=function(a,b){var c,d=0,e=a.length,f=a[0];for(1===arguments.length&&(b=d3.ascending);++d<e;)b.call(a,f,c=a[d])>0&&(f=c);return f},d3.last=function(a,b){var c,d=0,e=a.length,f=a[0];for(1===arguments.length&&(b=d3.ascending);++d<e;)b.call(a,f,c=a[d])<=0&&(f=c);return f},d3.nest=function(){function a(b,h){if(h>=g.length)return e?e.call(f,b):c?b.sort(c):b;for(var i,j,k,l=-1,m=b.length,n=g[h++],o=new d,p={};++l<m;)(k=o.get(i=n(j=b[l])))?k.push(j):o.set(i,[j]);return o.forEach(function(b){p[b]=a(o.get(b),h)}),p}function b(a,c){if(c>=g.length)return a;var d,e=[],f=h[c++];for(d in a)e.push({key:d,values:b(a[d],c)});return f&&e.sort(function(a,b){return f(a.key,b.key)}),e}var c,e,f={},g=[],h=[];return f.map=function(b){return a(b,0)},f.entries=function(c){return b(a(c,0),0)},f.key=function(a){return g.push(a),f},f.sortKeys=function(a){return h[g.length-1]=a,f},f.sortValues=function(a){return c=a,f},f.rollup=function(a){return e=a,f},f},d3.keys=function(a){var b=[];for(var c in a)b.push(c);return b},d3.values=function(a){var b=[];for(var c in a)b.push(a[c]);return b},d3.entries=function(a){var b=[];for(var c in a)b.push({key:c,value:a[c]});return b},d3.permute=function(a,b){for(var c=[],d=-1,e=b.length;++d<e;)c[d]=a[b[d]];return c},d3.merge=function(a){return Array.prototype.concat.apply([],a)},d3.split=function(a,b){var c,d=[],e=[],f=-1,g=a.length;for(arguments.length<2&&(b=l);++f<g;)b.call(e,c=a[f],f)?e=[]:(e.length||d.push(e),e.push(c));return d},d3.range=function(a,b,c){if(arguments.length<3&&(c=1,arguments.length<2&&(b=a,a=0)),(b-a)/c===1/0)throw new Error("infinite range");var d,e=[],f=n(Math.abs(c)),g=-1;if(a*=f,b*=f,c*=f,0>c)for(;(d=a+c*++g)>b;)e.push(d/f);else for(;(d=a+c*++g)<b;)e.push(d/f);return e},d3.requote=function(a){return a.replace(Cd,"\\$&")};var Cd=/[\\\^\$\*\+\?\|\[\]\(\)\.\{\}]/g;d3.round=function(a,b){return b?Math.round(a*(b=Math.pow(10,b)))/b:Math.round(a)},d3.xhr=function(a,b,c){var d=new XMLHttpRequest;arguments.length<3?(c=b,b=null):b&&d.overrideMimeType&&d.overrideMimeType(b),d.open("GET",a,!0),b&&d.setRequestHeader("Accept",b),d.onreadystatechange=function(){if(4===d.readyState){var a=d.status;c(!a&&d.response||a>=200&&300>a||304===a?d:null)}},d.send(null)},d3.text=function(a,b,c){function d(a){c(a&&a.responseText)}arguments.length<3&&(c=b,b=null),d3.xhr(a,b,d)},d3.json=function(a,b){d3.text(a,"application/json",function(a){b(a?JSON.parse(a):null)})},d3.html=function(a,b){d3.text(a,"text/html",function(a){if(null!=a){var c=document.createRange();c.selectNode(document.body),a=c.createContextualFragment(a)}b(a)})},d3.xml=function(a,b,c){function d(a){c(a&&a.responseXML)}arguments.length<3&&(c=b,b=null),d3.xhr(a,b,d)};var Dd={svg:"http://www.w3.org/2000/svg",xhtml:"http://www.w3.org/1999/xhtml",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};d3.ns={prefix:Dd,qualify:function(a){var b=a.indexOf(":"),c=a;return b>=0&&(c=a.substring(0,b),a=a.substring(b+1)),Dd.hasOwnProperty(c)?{space:Dd[c],local:a}:a}},d3.dispatch=function(){for(var a=new o,b=-1,c=arguments.length;++b<c;)a[arguments[b]]=p(a);return a},o.prototype.on=function(a,b){var c=a.indexOf("."),d="";return c>0&&(d=a.substring(c+1),a=a.substring(0,c)),arguments.length<2?this[a].on(d):this[a].on(d,b)},d3.format=function(a){var b=Ed.exec(a),c=b[1]||" ",d=b[3]||"",e=b[5],f=+b[6],g=b[7],h=b[8],i=b[9],j=1,k="",l=!1;switch(h&&(h=+h.substring(1)),e&&(c="0",g&&(f-=Math.floor((f-1)/4))),i){case"n":g=!0,i="g";break;case"%":j=100,k="%",i="f";break;case"p":j=100,k="%",i="r";break;case"d":l=!0,h=0;break;case"s":j=-1,i="r"}return"r"!=i||h||(i="g"),i=Fd.get(i)||r,function(a){if(l&&a%1)return"";var b=0>a&&(a=-a)?"−":d;if(0>j){var m=d3.formatPrefix(a,h);a=m.scale(a),k=m.symbol}else a*=j;if(a=i(a,h),e){var n=a.length+b.length;f>n&&(a=new Array(f-n+1).join(c)+a),g&&(a=s(a)),a=b+a}else{g&&(a=s(a)),a=b+a;var n=a.length;f>n&&(a=new Array(f-n+1).join(c)+a)}return a+k}};var Ed=/(?:([^{])?([<>=^]))?([+\- ])?(#)?(0)?([0-9]+)?(,)?(\.[0-9]+)?([a-zA-Z%])?/,Fd=d3.map({g:function(a,b){return a.toPrecision(b)},e:function(a,b){return a.toExponential(b)},f:function(a,b){return a.toFixed(b)},r:function(a,b){return d3.round(a,b=q(a,b)).toFixed(Math.max(0,Math.min(20,b)))}}),Gd=["y","z","a","f","p","n","Î¼","m","","k","M","G","T","P","E","Z","Y"].map(t);d3.formatPrefix=function(a,b){var c=0;return a&&(0>a&&(a*=-1),b&&(a=d3.round(a,q(a,b))),c=1+Math.floor(1e-12+Math.log(a)/Math.LN10),c=Math.max(-24,Math.min(24,3*Math.floor((0>=c?c+1:c-1)/3)))),Gd[8+c/3]};var Hd=y(2),Id=y(3),Jd=function(){return x},Kd=d3.map({linear:Jd,poly:y,quad:function(){return Hd},cubic:function(){return Id},sin:function(){return z},exp:function(){return A},circle:function(){return B},elastic:C,back:D,bounce:function(){return E}}),Ld=d3.map({"in":x,out:v,"in-out":w,"out-in":function(a){return w(v(a))}});d3.ease=function(a){var b=a.indexOf("-"),c=b>=0?a.substring(0,b):a,d=b>=0?a.substring(b+1):"in";return c=Kd.get(c)||Jd,d=Ld.get(d)||x,u(d(c.apply(null,Array.prototype.slice.call(arguments,1))))},d3.event=null,d3.interpolate=function(a,b){for(var c,d=d3.interpolators.length;--d>=0&&!(c=d3.interpolators[d](a,b)););return c},d3.interpolateNumber=function(a,b){return b-=a,function(c){return a+b*c}},d3.interpolateRound=function(a,b){return b-=a,function(c){return Math.round(a+b*c)}},d3.interpolateString=function(a,b){var c,d,e,f,g,h=0,i=0,j=[],k=[];for(Md.lastIndex=0,d=0;c=Md.exec(b);++d)c.index&&j.push(b.substring(h,i=c.index)),k.push({i:j.length,x:c[0]}),j.push(null),h=Md.lastIndex;for(h<b.length&&j.push(b.substring(h)),d=0,f=k.length;(c=Md.exec(a))&&f>d;++d)if(g=k[d],g.x==c[0]){if(g.i)if(null==j[g.i+1])for(j[g.i-1]+=g.x,j.splice(g.i,1),e=d+1;f>e;++e)k[e].i--;else for(j[g.i-1]+=g.x+j[g.i+1],j.splice(g.i,2),e=d+1;f>e;++e)k[e].i-=2;else if(null==j[g.i+1])j[g.i]=g.x;else for(j[g.i]=g.x+j[g.i+1],j.splice(g.i+1,1),e=d+1;f>e;++e)k[e].i--;k.splice(d,1),f--,d--}else g.x=d3.interpolateNumber(parseFloat(c[0]),parseFloat(g.x));for(;f>d;)g=k.pop(),null==j[g.i+1]?j[g.i]=g.x:(j[g.i]=g.x+j[g.i+1],j.splice(g.i+1,1)),f--;return 1===j.length?null==j[0]?k[0].x:function(){return b}:function(a){for(d=0;f>d;++d)j[(g=k[d]).i]=g.x(a);return j.join("")}},d3.interpolateTransform=function(a,b){var c,d=[],e=[],f=d3.transform(a),g=d3.transform(b),h=f.translate,i=g.translate,j=f.rotate,k=g.rotate,l=f.skew,m=g.skew,n=f.scale,o=g.scale;return h[0]!=i[0]||h[1]!=i[1]?(d.push("translate(",null,",",null,")"),e.push({i:1,x:d3.interpolateNumber(h[0],i[0])},{i:3,x:d3.interpolateNumber(h[1],i[1])})):i[0]||i[1]?d.push("translate("+i+")"):d.push(""),j!=k?(j-k>180?k+=360:k-j>180&&(j+=360),e.push({i:d.push(d.pop()+"rotate(",null,")")-2,x:d3.interpolateNumber(j,k)})):k&&d.push(d.pop()+"rotate("+k+")"),l!=m?e.push({i:d.push(d.pop()+"skewX(",null,")")-2,x:d3.interpolateNumber(l,m)}):m&&d.push(d.pop()+"skewX("+m+")"),n[0]!=o[0]||n[1]!=o[1]?(c=d.push(d.pop()+"scale(",null,",",null,")"),e.push({i:c-4,x:d3.interpolateNumber(n[0],o[0])},{i:c-2,x:d3.interpolateNumber(n[1],o[1])})):(1!=o[0]||1!=o[1])&&d.push(d.pop()+"scale("+o+")"),c=e.length,function(a){for(var b,f=-1;++f<c;)d[(b=e[f]).i]=b.x(a);return d.join("")}},d3.interpolateRgb=function(a,b){a=d3.rgb(a),b=d3.rgb(b);var c=a.r,d=a.g,e=a.b,f=b.r-c,g=b.g-d,h=b.b-e;return function(a){return"#"+N(Math.round(c+f*a))+N(Math.round(d+g*a))+N(Math.round(e+h*a))}},d3.interpolateHsl=function(a,b){a=d3.hsl(a),b=d3.hsl(b);var c=a.h,d=a.s,e=a.l,f=b.h-c,g=b.s-d,h=b.l-e;return f>180?f-=360:-180>f&&(f+=360),function(a){return T(c+f*a,d+g*a,e+h*a).toString()}},d3.interpolateArray=function(a,b){var c,d=[],e=[],f=a.length,g=b.length,h=Math.min(a.length,b.length);for(c=0;h>c;++c)d.push(d3.interpolate(a[c],b[c]));for(;f>c;++c)e[c]=a[c];for(;g>c;++c)e[c]=b[c];return function(a){for(c=0;h>c;++c)e[c]=d[c](a);return e}},d3.interpolateObject=function(a,b){var c,d={},e={};for(c in a)c in b?d[c]=I(c)(a[c],b[c]):e[c]=a[c];for(c in b)c in a||(e[c]=b[c]);return function(a){for(c in d)e[c]=d[c](a);return e}};var Md=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g;d3.interpolators=[d3.interpolateObject,function(a,b){return b instanceof Array&&d3.interpolateArray(a,b)},function(a,b){return("string"==typeof a||"string"==typeof b)&&d3.interpolateString(a+"",b+"")},function(a,b){return("string"==typeof b?Nd.has(b)||/^(#|rgb\(|hsl\()/.test(b):b instanceof M||b instanceof S)&&d3.interpolateRgb(a,b)},function(a,b){return!isNaN(a=+a)&&!isNaN(b=+b)&&d3.interpolateNumber(a,b)}],d3.rgb=function(a,b,c){return 1===arguments.length?a instanceof M?L(a.r,a.g,a.b):O(""+a,L,T):L(~~a,~~b,~~c)},M.prototype.brighter=function(a){a=Math.pow(.7,arguments.length?a:1);var b=this.r,c=this.g,d=this.b,e=30;return b||c||d?(b&&e>b&&(b=e),c&&e>c&&(c=e),d&&e>d&&(d=e),L(Math.min(255,Math.floor(b/a)),Math.min(255,Math.floor(c/a)),Math.min(255,Math.floor(d/a)))):L(e,e,e)},M.prototype.darker=function(a){return a=Math.pow(.7,arguments.length?a:1),L(Math.floor(a*this.r),Math.floor(a*this.g),Math.floor(a*this.b))},M.prototype.hsl=function(){return P(this.r,this.g,this.b)},M.prototype.toString=function(){return"#"+N(this.r)+N(this.g)+N(this.b)};var Nd=d3.map({aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"});Nd.forEach(function(a,b){Nd.set(a,O(b,L,T))}),d3.hsl=function(a,b,c){return 1===arguments.length?a instanceof S?R(a.h,a.s,a.l):O(""+a,P,R):R(+a,+b,+c)},S.prototype.brighter=function(a){return a=Math.pow(.7,arguments.length?a:1),R(this.h,this.s,this.l/a)},S.prototype.darker=function(a){return a=Math.pow(.7,arguments.length?a:1),R(this.h,this.s,a*this.l)},S.prototype.rgb=function(){return T(this.h,this.s,this.l)},S.prototype.toString=function(){return this.rgb().toString()};var Od=function(a,b){return b.querySelector(a)},Pd=function(a,b){return b.querySelectorAll(a)},Qd=document.documentElement,Rd=Qd.matchesSelector||Qd.webkitMatchesSelector||Qd.mozMatchesSelector||Qd.msMatchesSelector||Qd.oMatchesSelector,Sd=function(a,b){return Rd.call(a,b)};"function"==typeof Sizzle&&(Od=function(a,b){return Sizzle(a,b)[0]||null},Pd=function(a,b){return Sizzle.uniqueSort(Sizzle(a,b))},Sd=Sizzle.matchesSelector);var Td=[];d3.selection=function(){return Ud},d3.selection.prototype=Td,Td.select=function(a){var b,c,d,e,f=[];"function"!=typeof a&&(a=V(a));for(var g=-1,h=this.length;++g<h;){f.push(b=[]),b.parentNode=(d=this[g]).parentNode;for(var i=-1,j=d.length;++i<j;)(e=d[i])?(b.push(c=a.call(e,e.__data__,i)),c&&"__data__"in e&&(c.__data__=e.__data__)):b.push(null)}return U(f)},Td.selectAll=function(a){var b,c,d=[];"function"!=typeof a&&(a=W(a));for(var e=-1,f=this.length;++e<f;)for(var g=this[e],h=-1,i=g.length;++h<i;)(c=g[h])&&(d.push(b=wd(a.call(c,c.__data__,h))),b.parentNode=c);return U(d)},Td.attr=function(a,b){function c(){this.removeAttribute(a)}function d(){this.removeAttributeNS(a.space,a.local)}function e(){this.setAttribute(a,b)}function f(){this.setAttributeNS(a.space,a.local,b)}function g(){var c=b.apply(this,arguments);null==c?this.removeAttribute(a):this.setAttribute(a,c)}function h(){var c=b.apply(this,arguments);null==c?this.removeAttributeNS(a.space,a.local):this.setAttributeNS(a.space,a.local,c)}if(a=d3.ns.qualify(a),arguments.length<2){var i=this.node();return a.local?i.getAttributeNS(a.space,a.local):i.getAttribute(a)}return this.each(null==b?a.local?d:c:"function"==typeof b?a.local?h:g:a.local?f:e)},Td.classed=function(a,b){var c=m(a).split(" "),d=c.length,e=-1;if(arguments.length>1){for(;++e<d;)X.call(this,c[e],b);return this}for(;++e<d;)if(!X.call(this,c[e]))return!1;return!0},Td.style=function(a,b,c){function d(){this.style.removeProperty(a)}function e(){this.style.setProperty(a,b,c)}function f(){var d=b.apply(this,arguments);null==d?this.style.removeProperty(a):this.style.setProperty(a,d,c)}return arguments.length<3&&(c=""),arguments.length<2?window.getComputedStyle(this.node(),null).getPropertyValue(a):this.each(null==b?d:"function"==typeof b?f:e)},Td.property=function(a,b){function c(){delete this[a]}function d(){this[a]=b}function e(){var c=b.apply(this,arguments);null==c?delete this[a]:this[a]=c}return arguments.length<2?this.node()[a]:this.each(null==b?c:"function"==typeof b?e:d)},Td.text=function(a){return arguments.length<1?this.node().textContent:this.each("function"==typeof a?function(){var b=a.apply(this,arguments);this.textContent=null==b?"":b}:null==a?function(){this.textContent=""}:function(){this.textContent=a})},Td.html=function(a){return arguments.length<1?this.node().innerHTML:this.each("function"==typeof a?function(){var b=a.apply(this,arguments);this.innerHTML=null==b?"":b}:null==a?function(){this.innerHTML=""}:function(){this.innerHTML=a})},Td.append=function(a){function b(){return this.appendChild(document.createElementNS(this.namespaceURI,a))}function c(){return this.appendChild(document.createElementNS(a.space,a.local))}return a=d3.ns.qualify(a),this.select(a.local?c:b)},Td.insert=function(a,b){function c(){return this.insertBefore(document.createElementNS(this.namespaceURI,a),Od(b,this))}function d(){return this.insertBefore(document.createElementNS(a.space,a.local),Od(b,this))}return a=d3.ns.qualify(a),this.select(a.local?d:c)},Td.remove=function(){return this.each(function(){var a=this.parentNode;a&&a.removeChild(this)})},Td.data=function(a,b){function c(a,c){var e,f,g,h=a.length,l=c.length,m=Math.min(h,l),n=Math.max(h,l),o=[],p=[],q=[];if(b){var r,s=new d,t=[],u=c.length;for(e=-1;++e<h;)r=b.call(f=a[e],f.__data__,e),s.has(r)?q[u++]=f:s.set(r,f),t.push(r);for(e=-1;++e<l;)r=b.call(c,g=c[e],e),
s.has(r)?(o[e]=f=s.get(r),f.__data__=g,p[e]=q[e]=null):(p[e]=Y(g),o[e]=q[e]=null),s.remove(r);for(e=-1;++e<h;)s.has(t[e])&&(q[e]=a[e])}else{for(e=-1;++e<m;)f=a[e],g=c[e],f?(f.__data__=g,o[e]=f,p[e]=q[e]=null):(p[e]=Y(g),o[e]=q[e]=null);for(;l>e;++e)p[e]=Y(c[e]),o[e]=q[e]=null;for(;n>e;++e)q[e]=a[e],p[e]=o[e]=null}p.update=o,p.parentNode=o.parentNode=q.parentNode=a.parentNode,i.push(p),j.push(o),k.push(q)}var e,f,g=-1,h=this.length;if(!arguments.length){for(a=new Array(h=(e=this[0]).length);++g<h;)(f=e[g])&&(a[g]=f.__data__);return a}var i=aa([]),j=U([]),k=U([]);if("function"==typeof a)for(;++g<h;)c(e=this[g],a.call(e,e.parentNode.__data__,g));else for(;++g<h;)c(e=this[g],a);return j.enter=function(){return i},j.exit=function(){return k},j},Td.datum=Td.map=function(a){return arguments.length<1?this.property("__data__"):this.property("__data__",a)},Td.filter=function(a){var b,c,d,e=[];"function"!=typeof a&&(a=Z(a));for(var f=0,g=this.length;g>f;f++){e.push(b=[]),b.parentNode=(c=this[f]).parentNode;for(var h=0,i=c.length;i>h;h++)(d=c[h])&&a.call(d,d.__data__,h)&&b.push(d)}return U(e)},Td.order=function(){for(var a=-1,b=this.length;++a<b;)for(var c,d=this[a],e=d.length-1,f=d[e];--e>=0;)(c=d[e])&&(f&&f!==c.nextSibling&&f.parentNode.insertBefore(c,f),f=c);return this},Td.sort=function(a){a=$.apply(this,arguments);for(var b=-1,c=this.length;++b<c;)this[b].sort(a);return this.order()},Td.on=function(a,b,c){arguments.length<3&&(c=!1);var d="__on"+a,e=a.indexOf(".");return e>0&&(a=a.substring(0,e)),arguments.length<2?(e=this.node()[d])&&e._:this.each(function(e,f){function g(a){var c=d3.event;d3.event=a;try{b.call(h,h.__data__,f)}finally{d3.event=c}}var h=this,i=h[d];i&&(h.removeEventListener(a,i,i.$),delete h[d]),b&&(h.addEventListener(a,h[d]=g,g.$=c),g._=b)})},Td.each=function(a){return _(this,function(b,c,d){a.call(b,b.__data__,c,d)})},Td.call=function(a){return a.apply(this,(arguments[0]=this,arguments)),this},Td.empty=function(){return!this.node()},Td.node=function(a){for(var b=0,c=this.length;c>b;b++)for(var d=this[b],e=0,f=d.length;f>e;e++){var g=d[e];if(g)return g}return null},Td.transition=function(){for(var a,b,c=[],d=-1,e=this.length;++d<e;){c.push(a=[]);for(var f=this[d],g=-1,h=f.length;++g<h;)a.push((b=f[g])?{node:b,delay:be,duration:ce}:null)}return ba(c,Zd||++Yd,Date.now())};var Ud=U([[document]]);Ud[0].parentNode=Qd,d3.select=function(a){return"string"==typeof a?Ud.select(a):U([[a]])},d3.selectAll=function(a){return"string"==typeof a?Ud.selectAll(a):U([wd(a)])};var Vd=[];d3.selection.enter=aa,d3.selection.enter.prototype=Vd,Vd.append=Td.append,Vd.insert=Td.insert,Vd.empty=Td.empty,Vd.node=Td.node,Vd.select=function(a){for(var b,c,d,e,f,g=[],h=-1,i=this.length;++h<i;){d=(e=this[h]).update,g.push(b=[]),b.parentNode=e.parentNode;for(var j=-1,k=e.length;++j<k;)(f=e[j])?(b.push(d[j]=c=a.call(e.parentNode,f.__data__,j)),c.__data__=f.__data__):b.push(null)}return U(g)};var Wd={},Xd=[],Yd=0,Zd=0,$d=0,_d=250,ae=d3.ease("cubic-in-out"),be=$d,ce=_d,de=ae;Xd.call=Td.call,d3.transition=function(a){return arguments.length?Zd?a.transition():a:Ud.transition()},d3.transition.prototype=Xd,Xd.select=function(a){var b,c,d,e=[];"function"!=typeof a&&(a=V(a));for(var f=-1,g=this.length;++f<g;){e.push(b=[]);for(var h=this[f],i=-1,j=h.length;++i<j;)(d=h[i])&&(c=a.call(d.node,d.node.__data__,i))?("__data__"in d.node&&(c.__data__=d.node.__data__),b.push({node:c,delay:d.delay,duration:d.duration})):b.push(null)}return ba(e,this.id,this.time).ease(this.ease())},Xd.selectAll=function(a){var b,c,d,e=[];"function"!=typeof a&&(a=W(a));for(var f=-1,g=this.length;++f<g;)for(var h=this[f],i=-1,j=h.length;++i<j;)if(d=h[i]){c=a.call(d.node,d.node.__data__,i),e.push(b=[]);for(var k=-1,l=c.length;++k<l;)b.push({node:c[k],delay:d.delay,duration:d.duration})}return ba(e,this.id,this.time).ease(this.ease())},Xd.attr=function(a,b){return this.attrTween(a,da(a,b))},Xd.attrTween=function(a,b){function c(a,c){var d=b.call(this,a,c,this.getAttribute(e));return d===Wd?(this.removeAttribute(e),null):d&&function(a){this.setAttribute(e,d(a))}}function d(a,c){var d=b.call(this,a,c,this.getAttributeNS(e.space,e.local));return d===Wd?(this.removeAttributeNS(e.space,e.local),null):d&&function(a){this.setAttributeNS(e.space,e.local,d(a))}}var e=d3.ns.qualify(a);return this.tween("attr."+a,e.local?d:c)},Xd.style=function(a,b,c){return arguments.length<3&&(c=""),this.styleTween(a,da(a,b),c)},Xd.styleTween=function(a,b,c){return arguments.length<3&&(c=""),this.tween("style."+a,function(d,e){var f=b.call(this,d,e,window.getComputedStyle(this,null).getPropertyValue(a));return f===Wd?(this.style.removeProperty(a),null):f&&function(b){this.style.setProperty(a,f(b),c)}})},Xd.text=function(a){return this.tween("text",function(b,c){this.textContent="function"==typeof a?a.call(this,b,c):a})},Xd.remove=function(){return this.each("end.transition",function(){var a;!this.__transition__&&(a=this.parentNode)&&a.removeChild(this)})},Xd.delay=function(a){return _(this,"function"==typeof a?function(b,c,d){b.delay=0|a.call(b=b.node,b.__data__,c,d)}:(a=0|a,function(b){b.delay=a}))},Xd.duration=function(a){return _(this,"function"==typeof a?function(b,c,d){b.duration=Math.max(1,0|a.call(b=b.node,b.__data__,c,d))}:(a=Math.max(1,0|a),function(b){b.duration=a}))},Xd.transition=function(){return this.select(f)};var ee,fe,ge=null;d3.timer=function(a,b,c){var d,e=!1,f=ge;if(arguments.length<3){if(arguments.length<2)b=0;else if(!isFinite(b))return;c=Date.now()}for(;f;){if(f.callback===a){f.then=c,f.delay=b,e=!0;break}d=f,f=f.next}e||(ge={callback:a,then:c,delay:b,next:ge}),ee||(fe=clearTimeout(fe),ee=1,he(fa))},d3.timer.flush=function(){for(var a,b=Date.now(),c=ge;c;)a=b-c.then,c.delay||(c.flush=c.callback(a)),c=c.next;ga()};var he=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){setTimeout(a,17)};d3.transform=function(a){var b=document.createElementNS(d3.ns.prefix.svg,"g"),c={a:1,b:0,c:0,d:1,e:0,f:0};return(d3.transform=function(a){b.setAttribute("transform",a);var d=b.transform.baseVal.consolidate();return new ha(d?d.matrix:c)})(a)},ha.prototype.toString=function(){return"translate("+this.translate+")rotate("+this.rotate+")skewX("+this.skew+")scale("+this.scale+")"};var ie=180/Math.PI;d3.mouse=function(a){return la(a,G())};var je=/WebKit/.test(navigator.userAgent)?-1:0;d3.touches=function(a,b){return arguments.length<2&&(b=G().touches),b?wd(b).map(function(b){var c=la(a,b);return c.identifier=b.identifier,c}):[]},d3.scale={},d3.scale.linear=function(){return qa([0,1],[0,1],d3.interpolate,!1)},d3.scale.log=function(){return ya(d3.scale.linear(),za)};var ke=d3.format(".0e");za.pow=function(a){return Math.pow(10,a)},Aa.pow=function(a){return-Math.pow(10,-a)},d3.scale.pow=function(){return Ba(d3.scale.linear(),1)},d3.scale.sqrt=function(){return d3.scale.pow().exponent(.5)},d3.scale.ordinal=function(){return Da([],{t:"range",x:[]})},d3.scale.category10=function(){return d3.scale.ordinal().range(le)},d3.scale.category20=function(){return d3.scale.ordinal().range(me)},d3.scale.category20b=function(){return d3.scale.ordinal().range(ne)},d3.scale.category20c=function(){return d3.scale.ordinal().range(oe)};var le=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"],me=["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5"],ne=["#393b79","#5254a3","#6b6ecf","#9c9ede","#637939","#8ca252","#b5cf6b","#cedb9c","#8c6d31","#bd9e39","#e7ba52","#e7cb94","#843c39","#ad494a","#d6616b","#e7969c","#7b4173","#a55194","#ce6dbd","#de9ed6"],oe=["#3182bd","#6baed6","#9ecae1","#c6dbef","#e6550d","#fd8d3c","#fdae6b","#fdd0a2","#31a354","#74c476","#a1d99b","#c7e9c0","#756bb1","#9e9ac8","#bcbddc","#dadaeb","#636363","#969696","#bdbdbd","#d9d9d9"];d3.scale.quantile=function(){return Ea([],[])},d3.scale.quantize=function(){return Fa(0,1,[0,1])},d3.scale.identity=function(){return Ga([0,1])},d3.svg={},d3.svg.arc=function(){function a(){var a=b.apply(this,arguments),f=c.apply(this,arguments),g=d.apply(this,arguments)+pe,h=e.apply(this,arguments)+pe,i=(g>h&&(i=g,g=h,h=i),h-g),j=i<Math.PI?"0":"1",k=Math.cos(g),l=Math.sin(g),m=Math.cos(h),n=Math.sin(h);return i>=qe?a?"M0,"+f+"A"+f+","+f+" 0 1,1 0,"+-f+"A"+f+","+f+" 0 1,1 0,"+f+"M0,"+a+"A"+a+","+a+" 0 1,0 0,"+-a+"A"+a+","+a+" 0 1,0 0,"+a+"Z":"M0,"+f+"A"+f+","+f+" 0 1,1 0,"+-f+"A"+f+","+f+" 0 1,1 0,"+f+"Z":a?"M"+f*k+","+f*l+"A"+f+","+f+" 0 "+j+",1 "+f*m+","+f*n+"L"+a*m+","+a*n+"A"+a+","+a+" 0 "+j+",0 "+a*k+","+a*l+"Z":"M"+f*k+","+f*l+"A"+f+","+f+" 0 "+j+",1 "+f*m+","+f*n+"L0,0Z"}var b=Ha,c=Ia,d=Ja,e=Ka;return a.innerRadius=function(c){return arguments.length?(b=h(c),a):b},a.outerRadius=function(b){return arguments.length?(c=h(b),a):c},a.startAngle=function(b){return arguments.length?(d=h(b),a):d},a.endAngle=function(b){return arguments.length?(e=h(b),a):e},a.centroid=function(){var a=(b.apply(this,arguments)+c.apply(this,arguments))/2,f=(d.apply(this,arguments)+e.apply(this,arguments))/2+pe;return[Math.cos(f)*a,Math.sin(f)*a]},a};var pe=-Math.PI/2,qe=2*Math.PI-1e-6;d3.svg.line=function(){return La(e)};var re="linear",se=d3.map({linear:Oa,"step-before":Pa,"step-after":Qa,basis:Wa,"basis-open":Xa,"basis-closed":Ya,bundle:Za,cardinal:Ta,"cardinal-open":Ra,"cardinal-closed":Sa,monotone:db}),te=[0,2/3,1/3,0],ue=[0,1/3,2/3,0],ve=[0,1/6,2/3,1/6];d3.svg.line.radial=function(){var a=La(eb);return a.radius=a.x,delete a.x,a.angle=a.y,delete a.y,a},Pa.reverse=Qa,Qa.reverse=Pa,d3.svg.area=function(){return fb(Object)},d3.svg.area.radial=function(){var a=fb(eb);return a.radius=a.x,delete a.x,a.innerRadius=a.x0,delete a.x0,a.outerRadius=a.x1,delete a.x1,a.angle=a.y,delete a.y,a.startAngle=a.y0,delete a.y0,a.endAngle=a.y1,delete a.y1,a},d3.svg.chord=function(){function a(a,h){var i=b(this,f,a,h),j=b(this,g,a,h);return"M"+i.p0+d(i.r,i.p1,i.a1-i.a0)+(c(i,j)?e(i.r,i.p1,i.r,i.p0):e(i.r,i.p1,j.r,j.p0)+d(j.r,j.p1,j.a1-j.a0)+e(j.r,j.p1,i.r,i.p0))+"Z"}function b(a,b,c,d){var e=b.call(a,c,d),f=i.call(a,e,d),g=j.call(a,e,d)+pe,h=k.call(a,e,d)+pe;return{r:f,a0:g,a1:h,p0:[f*Math.cos(g),f*Math.sin(g)],p1:[f*Math.cos(h),f*Math.sin(h)]}}function c(a,b){return a.a0==b.a0&&a.a1==b.a1}function d(a,b,c){return"A"+a+","+a+" 0 "+ +(c>Math.PI)+",1 "+b}function e(a,b,c,d){return"Q 0,0 "+d}var f=gb,g=hb,i=ib,j=Ja,k=Ka;return a.radius=function(b){return arguments.length?(i=h(b),a):i},a.source=function(b){return arguments.length?(f=h(b),a):f},a.target=function(b){return arguments.length?(g=h(b),a):g},a.startAngle=function(b){return arguments.length?(j=h(b),a):j},a.endAngle=function(b){return arguments.length?(k=h(b),a):k},a},d3.svg.diagonal=function(){function a(a,e){var f=b.call(this,a,e),g=c.call(this,a,e),h=(f.y+g.y)/2,i=[f,{x:f.x,y:h},{x:g.x,y:h},g];return i=i.map(d),"M"+i[0]+"C"+i[1]+" "+i[2]+" "+i[3]}var b=gb,c=hb,d=jb;return a.source=function(c){return arguments.length?(b=h(c),a):b},a.target=function(b){return arguments.length?(c=h(b),a):c},a.projection=function(b){return arguments.length?(d=b,a):d},a},d3.svg.diagonal.radial=function(){var a=d3.svg.diagonal(),b=jb,c=a.projection;return a.projection=function(a){return arguments.length?c(kb(b=a)):b},a},d3.svg.mouse=d3.mouse,d3.svg.touches=d3.touches,d3.svg.symbol=function(){function a(a,d){return(we.get(b.call(this,a,d))||nb)(c.call(this,a,d))}var b=mb,c=lb;return a.type=function(c){return arguments.length?(b=h(c),a):b},a.size=function(b){return arguments.length?(c=h(b),a):c},a};var we=d3.map({circle:nb,cross:function(a){var b=Math.sqrt(a/5)/2;return"M"+-3*b+","+-b+"H"+-b+"V"+-3*b+"H"+b+"V"+-b+"H"+3*b+"V"+b+"H"+b+"V"+3*b+"H"+-b+"V"+b+"H"+-3*b+"Z"},diamond:function(a){var b=Math.sqrt(a/(2*ye)),c=b*ye;return"M0,"+-b+"L"+c+",0 0,"+b+" "+-c+",0Z"},square:function(a){var b=Math.sqrt(a)/2;return"M"+-b+","+-b+"L"+b+","+-b+" "+b+","+b+" "+-b+","+b+"Z"},"triangle-down":function(a){var b=Math.sqrt(a/xe),c=b*xe/2;return"M0,"+c+"L"+b+","+-c+" "+-b+","+-c+"Z"},"triangle-up":function(a){var b=Math.sqrt(a/xe),c=b*xe/2;return"M0,"+-c+"L"+b+","+c+" "+-b+","+c+"Z"}});d3.svg.symbolTypes=we.keys();var xe=Math.sqrt(3),ye=Math.tan(30*Math.PI/180);d3.svg.axis=function(){function a(a){a.each(function(){var a,l=d3.select(this),m=null==j?c.ticks?c.ticks.apply(c,i):c.domain():j,n=null==b?c.tickFormat?c.tickFormat.apply(c,i):String:b,o=qb(c,m,k),p=l.selectAll(".minor").data(o,String),q=p.enter().insert("line","g").attr("class","tick minor").style("opacity",1e-6),r=d3.transition(p.exit()).style("opacity",1e-6).remove(),s=d3.transition(p).style("opacity",1),t=l.selectAll("g").data(m,String),u=t.enter().insert("g","path").style("opacity",1e-6),v=d3.transition(t.exit()).style("opacity",1e-6).remove(),w=d3.transition(t).style("opacity",1),x=na(c),y=l.selectAll(".domain").data([0]),z=(y.enter().append("path").attr("class","domain"),d3.transition(y)),A=c.copy(),B=this.__chart__||A;this.__chart__=A,u.append("line").attr("class","tick"),u.append("text");var C=u.select("line"),D=w.select("line"),E=t.select("text").text(n),F=u.select("text"),G=w.select("text");switch(d){case"bottom":a=ob,q.attr("y2",f),s.attr("x2",0).attr("y2",f),C.attr("y2",e),F.attr("y",Math.max(e,0)+h),D.attr("x2",0).attr("y2",e),G.attr("x",0).attr("y",Math.max(e,0)+h),E.attr("dy",".71em").attr("text-anchor","middle"),z.attr("d","M"+x[0]+","+g+"V0H"+x[1]+"V"+g);break;case"top":a=ob,q.attr("y2",-f),s.attr("x2",0).attr("y2",-f),C.attr("y2",-e),F.attr("y",-(Math.max(e,0)+h)),D.attr("x2",0).attr("y2",-e),G.attr("x",0).attr("y",-(Math.max(e,0)+h)),E.attr("dy","0em").attr("text-anchor","middle"),z.attr("d","M"+x[0]+","+-g+"V0H"+x[1]+"V"+-g);break;case"left":a=pb,q.attr("x2",-f),s.attr("x2",-f).attr("y2",0),C.attr("x2",-e),F.attr("x",-(Math.max(e,0)+h)),D.attr("x2",-e).attr("y2",0),G.attr("x",-(Math.max(e,0)+h)).attr("y",0),E.attr("dy",".32em").attr("text-anchor","end"),z.attr("d","M"+-g+","+x[0]+"H0V"+x[1]+"H"+-g);break;case"right":a=pb,q.attr("x2",f),s.attr("x2",f).attr("y2",0),C.attr("x2",e),F.attr("x",Math.max(e,0)+h),D.attr("x2",e).attr("y2",0),G.attr("x",Math.max(e,0)+h).attr("y",0),E.attr("dy",".32em").attr("text-anchor","start"),z.attr("d","M"+g+","+x[0]+"H0V"+x[1]+"H"+g)}if(c.ticks)u.call(a,B),w.call(a,A),v.call(a,A),q.call(a,B),s.call(a,A),r.call(a,A);else{var H=A.rangeBand()/2,I=function(a){return A(a)+H};u.call(a,I),w.call(a,I)}})}var b,c=d3.scale.linear(),d="bottom",e=6,f=6,g=6,h=3,i=[10],j=null,k=0;return a.scale=function(b){return arguments.length?(c=b,a):c},a.orient=function(b){return arguments.length?(d=b,a):d},a.ticks=function(){return arguments.length?(i=arguments,a):i},a.tickValues=function(b){return arguments.length?(j=b,a):j},a.tickFormat=function(c){return arguments.length?(b=c,a):b},a.tickSize=function(b,c,d){if(!arguments.length)return e;var h=arguments.length-1;return e=+b,f=h>1?+c:e,g=h>0?+arguments[h]:e,a},a.tickPadding=function(b){return arguments.length?(h=+b,a):h},a.tickSubdivide=function(b){return arguments.length?(k=+b,a):k},a},d3.svg.brush=function(){function a(f){f.each(function(){var f,g=d3.select(this),k=g.selectAll(".background").data([0]),l=g.selectAll(".extent").data([0]),m=g.selectAll(".resize").data(j,String);g.style("pointer-events","all").on("mousedown.brush",e).on("touchstart.brush",e),k.enter().append("rect").attr("class","background").style("visibility","hidden").style("cursor","crosshair"),l.enter().append("rect").attr("class","extent").style("cursor","move"),m.enter().append("g").attr("class",function(a){return"resize "+a}).style("cursor",function(a){return ze[a]}).append("rect").attr("x",function(a){return/[ew]$/.test(a)?-3:null}).attr("y",function(a){return/^[ns]/.test(a)?-3:null}).attr("width",6).attr("height",6).style("visibility","hidden"),m.style("display",a.empty()?"none":null),m.exit().remove(),h&&(f=na(h),k.attr("x",f[0]).attr("width",f[1]-f[0]),c(g)),i&&(f=na(i),k.attr("y",f[0]).attr("height",f[1]-f[0]),d(g)),b(g)})}function b(a){a.selectAll(".resize").attr("transform",function(a){return"translate("+k[+/e$/.test(a)][0]+","+k[+/^s/.test(a)][1]+")"})}function c(a){a.select(".extent").attr("x",k[0][0]),a.selectAll(".extent,.n>rect,.s>rect").attr("width",k[1][0]-k[0][0])}function d(a){a.select(".extent").attr("y",k[0][1]),a.selectAll(".extent,.e>rect,.w>rect").attr("height",k[1][1]-k[0][1])}function e(){function e(){var a=d3.event.changedTouches;return a?d3.touches(r,a)[0]:d3.mouse(r)}function j(){32==d3.event.keyCode&&(y||(p=null,z[0]-=k[1][0],z[1]-=k[1][1],y=2),F())}function l(){32==d3.event.keyCode&&2==y&&(z[0]+=k[1][0],z[1]+=k[1][1],y=0,F())}function m(){var a=e(),f=!1;q&&(a[0]+=q[0],a[1]+=q[1]),y||(d3.event.altKey?(p||(p=[(k[0][0]+k[1][0])/2,(k[0][1]+k[1][1])/2]),z[0]=k[+(a[0]<p[0])][0],z[1]=k[+(a[1]<p[1])][1]):p=null),w&&n(a,h,0)&&(c(u),f=!0),x&&n(a,i,1)&&(d(u),f=!0),f&&(b(u),t({type:"brush",mode:y?"move":"resize"}))}function n(a,b,c){var d,e,g=na(b),h=g[0],i=g[1],j=z[c],l=k[1][c]-k[0][c];return y&&(h-=j,i-=l+j),d=Math.max(h,Math.min(i,a[c])),y?e=(d+=j)+l:(p&&(j=Math.max(h,Math.min(i,2*p[c]-d))),d>j?(e=d,d=j):e=j),k[0][c]!==d||k[1][c]!==e?(f=null,k[0][c]=d,k[1][c]=e,!0):void 0}function o(){m(),u.style("pointer-events","all").selectAll(".resize").style("display",a.empty()?"none":null),d3.select("body").style("cursor",null),A.on("mousemove.brush",null).on("mouseup.brush",null).on("touchmove.brush",null).on("touchend.brush",null).on("keydown.brush",null).on("keyup.brush",null),t({type:"brushend"}),F()}var p,q,r=this,s=d3.select(d3.event.target),t=g.of(r,arguments),u=d3.select(r),v=s.datum(),w=!/^(n|s)$/.test(v)&&h,x=!/^(e|w)$/.test(v)&&i,y=s.classed("extent"),z=e(),A=d3.select(window).on("mousemove.brush",m).on("mouseup.brush",o).on("touchmove.brush",m).on("touchend.brush",o).on("keydown.brush",j).on("keyup.brush",l);if(y)z[0]=k[0][0]-z[0],z[1]=k[0][1]-z[1];else if(v){var B=+/w$/.test(v),C=+/^n/.test(v);q=[k[1-B][0]-z[0],k[1-C][1]-z[1]],z[0]=k[B][0],z[1]=k[C][1]}else d3.event.altKey&&(p=z.slice());u.style("pointer-events","none").selectAll(".resize").style("display",null),d3.select("body").style("cursor",s.style("cursor")),t({type:"brushstart"}),m(),F()}var f,g=H(a,"brushstart","brush","brushend"),h=null,i=null,j=Ae[0],k=[[0,0],[0,0]];return a.x=function(b){return arguments.length?(h=b,j=Ae[!h<<1|!i],a):h},a.y=function(b){return arguments.length?(i=b,j=Ae[!h<<1|!i],a):i},a.extent=function(b){var c,d,e,g,j;return arguments.length?(f=[[0,0],[0,0]],h&&(c=b[0],d=b[1],i&&(c=c[0],d=d[0]),f[0][0]=c,f[1][0]=d,h.invert&&(c=h(c),d=h(d)),c>d&&(j=c,c=d,d=j),k[0][0]=0|c,k[1][0]=0|d),i&&(e=b[0],g=b[1],h&&(e=e[1],g=g[1]),f[0][1]=e,f[1][1]=g,i.invert&&(e=i(e),g=i(g)),e>g&&(j=e,e=g,g=j),k[0][1]=0|e,k[1][1]=0|g),a):(b=f||k,h&&(c=b[0][0],d=b[1][0],f||(c=k[0][0],d=k[1][0],h.invert&&(c=h.invert(c),d=h.invert(d)),c>d&&(j=c,c=d,d=j))),i&&(e=b[0][1],g=b[1][1],f||(e=k[0][1],g=k[1][1],i.invert&&(e=i.invert(e),g=i.invert(g)),e>g&&(j=e,e=g,g=j))),h&&i?[[c,e],[d,g]]:h?[c,d]:i&&[e,g])},a.clear=function(){return f=null,k[0][0]=k[0][1]=k[1][0]=k[1][1]=0,a},a.empty=function(){return h&&k[0][0]===k[1][0]||i&&k[0][1]===k[1][1]},d3.rebind(a,g,"on")};var ze={n:"ns-resize",e:"ew-resize",s:"ns-resize",w:"ew-resize",nw:"nwse-resize",ne:"nesw-resize",se:"nwse-resize",sw:"nesw-resize"},Ae=[["n","e","s","w","nw","ne","se","sw"],["e","w"],["n","s"],[]];d3.behavior={},d3.behavior.drag=function(){function a(){this.on("mousedown.drag",b).on("touchstart.drag",b)}function b(){function a(){var a=h.parentNode,b=d3.event.changedTouches;return b?d3.touches(a,b)[0]:d3.mouse(a)}function b(){if(!h.parentNode)return e();var b=a(),c=b[0]-k[0],d=b[1]-k[1];l|=c|d,k=b,F(),i({type:"drag",x:b[0]+g[0],y:b[1]+g[1],dx:c,dy:d})}function e(){i({type:"dragend"}),l&&(F(),d3.event.target===j&&m.on("click.drag",f,!0)),m.on("mousemove.drag",null).on("touchmove.drag",null).on("mouseup.drag",null).on("touchend.drag",null)}function f(){F(),m.on("click.drag",null)}var g,h=this,i=c.of(h,arguments),j=d3.event.target,k=a(),l=0,m=d3.select(window).on("mousemove.drag",b).on("touchmove.drag",b).on("mouseup.drag",e,!0).on("touchend.drag",e,!0);d?(g=d.apply(h,arguments),g=[g.x-k[0],g.y-k[1]]):g=[0,0],F(),i({type:"dragstart"})}var c=H(a,"drag","dragstart","dragend"),d=null;return a.origin=function(b){return arguments.length?(d=b,a):d},d3.rebind(a,c,"on")},d3.behavior.zoom=function(){function a(){this.on("mousedown.zoom",g).on("mousewheel.zoom",h).on("mousemove.zoom",i).on("DOMMouseScroll.zoom",h).on("dblclick.zoom",j).on("touchstart.zoom",k).on("touchmove.zoom",l).on("touchend.zoom",k)}function b(a){return[(a[0]-t[0])/u,(a[1]-t[1])/u]}function c(a){return[a[0]*u+t[0],a[1]*u+t[1]]}function d(a){u=Math.max(v[0],Math.min(v[1],a))}function e(a,b){b=c(b),t[0]+=a[0]-b[0],t[1]+=a[1]-b[1]}function f(a){p&&p.domain(o.range().map(function(a){return(a-t[0])/u}).map(o.invert)),r&&r.domain(q.range().map(function(a){return(a-t[1])/u}).map(q.invert)),d3.event.preventDefault(),a({type:"zoom",scale:u,translate:t})}function g(){function a(){j=1,e(d3.mouse(g),l),f(h)}function c(){j&&F(),k.on("mousemove.zoom",null).on("mouseup.zoom",null),j&&d3.event.target===i&&k.on("click.zoom",d,!0)}function d(){F(),k.on("click.zoom",null)}var g=this,h=w.of(g,arguments),i=d3.event.target,j=0,k=d3.select(window).on("mousemove.zoom",a).on("mouseup.zoom",c),l=b(d3.mouse(g));window.focus(),F()}function h(){m||(m=b(d3.mouse(this))),d(Math.pow(2,.002*rb())*u),e(d3.mouse(this),m),f(w.of(this,arguments))}function i(){m=null}function j(){var a=d3.mouse(this),c=b(a);d(d3.event.shiftKey?u/2:2*u),e(a,c),f(w.of(this,arguments))}function k(){var a=d3.touches(this),c=Date.now();if(n=u,m={},a.forEach(function(a){m[a.identifier]=b(a)}),F(),1===a.length&&500>c-s){var g=a[0],h=b(a[0]);d(2*u),e(g,h),f(w.of(this,arguments))}s=c}function l(){var a=d3.touches(this),b=a[0],c=m[b.identifier];if(g=a[1]){var g,h=m[g.identifier];b=[(b[0]+g[0])/2,(b[1]+g[1])/2],c=[(c[0]+h[0])/2,(c[1]+h[1])/2],d(d3.event.scale*n)}e(b,c),f(w.of(this,arguments))}var m,n,o,p,q,r,s,t=[0,0],u=1,v=Ce,w=H(a,"zoom");return a.translate=function(b){return arguments.length?(t=b.map(Number),a):t},a.scale=function(b){return arguments.length?(u=+b,a):u},a.scaleExtent=function(b){return arguments.length?(v=null==b?Ce:b.map(Number),a):v},a.x=function(b){return arguments.length?(p=b,o=b.copy(),a):p},a.y=function(b){return arguments.length?(r=b,q=b.copy(),a):r},d3.rebind(a,w,"on")};var Be,Ce=[0,1/0];d3.layout={},d3.layout.bundle=function(){return function(a){for(var b=[],c=-1,d=a.length;++c<d;)b.push(sb(a[c]));return b}},d3.layout.chord=function(){function a(){var a,j,l,m,n,o={},p=[],q=d3.range(f),r=[];for(c=[],d=[],a=0,m=-1;++m<f;){for(j=0,n=-1;++n<f;)j+=e[m][n];p.push(j),r.push(d3.range(f)),a+=j}for(g&&q.sort(function(a,b){return g(p[a],p[b])}),h&&r.forEach(function(a,b){a.sort(function(a,c){return h(e[b][a],e[b][c])})}),a=(2*Math.PI-k*f)/a,j=0,m=-1;++m<f;){for(l=j,n=-1;++n<f;){var s=q[m],t=r[s][n],u=e[s][t],v=j,w=j+=u*a;o[s+"-"+t]={index:s,subindex:t,startAngle:v,endAngle:w,value:u}}d[s]={index:s,startAngle:l,endAngle:j,value:(j-l)/a},j+=k}for(m=-1;++m<f;)for(n=m-1;++n<f;){var x=o[m+"-"+n],y=o[n+"-"+m];(x.value||y.value)&&c.push(x.value<y.value?{source:y,target:x}:{source:x,target:y})}i&&b()}function b(){c.sort(function(a,b){return i((a.source.value+a.target.value)/2,(b.source.value+b.target.value)/2)})}var c,d,e,f,g,h,i,j={},k=0;return j.matrix=function(a){return arguments.length?(f=(e=a)&&e.length,c=d=null,j):e},j.padding=function(a){return arguments.length?(k=a,c=d=null,j):k},j.sortGroups=function(a){return arguments.length?(g=a,c=d=null,j):g},j.sortSubgroups=function(a){return arguments.length?(h=a,c=null,j):h},j.sortChords=function(a){return arguments.length?(i=a,c&&b(),j):i},j.chords=function(){return c||a(),c},j.groups=function(){return d||a(),d},j},d3.layout.force=function(){function a(a){return function(b,c,d,e,f){if(b.point!==a){var g=b.cx-a.x,h=b.cy-a.y,i=1/Math.sqrt(g*g+h*h);if(r>(e-c)*i){var j=b.charge*i*i;return a.px-=g*j,a.py-=h*j,!0}if(b.point&&isFinite(i)){var j=b.pointCharge*i*i;a.px-=g*j,a.py-=h*j}}return!b.charge}}function b(a){vb(Ee=a),De=j}var c,d,f,g,i,j={},k=d3.dispatch("start","tick","end"),l=[1,1],m=.9,n=Ab,o=Bb,p=-30,q=.1,r=.8,s=[],t=[];return j.tick=function(){if((d*=.99)<.005)return k.end({type:"end",alpha:d=0}),!0;var b,c,e,h,j,n,o,r,u,v=s.length,w=t.length;for(c=0;w>c;++c)e=t[c],h=e.source,j=e.target,r=j.x-h.x,u=j.y-h.y,(n=r*r+u*u)&&(n=d*g[c]*((n=Math.sqrt(n))-f[c])/n,r*=n,u*=n,j.x-=r*(o=h.weight/(j.weight+h.weight)),j.y-=u*o,h.x+=r*(o=1-o),h.y+=u*o);if((o=d*q)&&(r=l[0]/2,u=l[1]/2,c=-1,o))for(;++c<v;)e=s[c],e.x+=(r-e.x)*o,e.y+=(u-e.y)*o;if(p)for(zb(b=d3.geom.quadtree(s),d,i),c=-1;++c<v;)(e=s[c]).fixed||b.visit(a(e));for(c=-1;++c<v;)e=s[c],e.fixed?(e.x=e.px,e.y=e.py):(e.x-=(e.px-(e.px=e.x))*m,e.y-=(e.py-(e.py=e.y))*m);k.tick({type:"tick",alpha:d})},j.nodes=function(a){return arguments.length?(s=a,j):s},j.links=function(a){return arguments.length?(t=a,j):t},j.size=function(a){return arguments.length?(l=a,j):l},j.linkDistance=function(a){return arguments.length?(n=h(a),j):n},j.distance=j.linkDistance,j.linkStrength=function(a){return arguments.length?(o=h(a),j):o},j.friction=function(a){return arguments.length?(m=a,j):m},j.charge=function(a){return arguments.length?(p="function"==typeof a?a:+a,j):p},j.gravity=function(a){return arguments.length?(q=a,j):q},j.theta=function(a){return arguments.length?(r=a,j):r},j.alpha=function(a){return arguments.length?(d?d=a>0?a:0:a>0&&(k.start({type:"start",alpha:d=a}),d3.timer(j.tick)),j):d},j.start=function(){function a(a,d){for(var e,f=b(c),g=-1,h=f.length;++g<h;)if(!isNaN(e=f[g][a]))return e;return Math.random()*d}function b(){if(!e){for(e=[],d=0;k>d;++d)e[d]=[];for(d=0;m>d;++d){var a=t[d];e[a.source.index].push(a.target),e[a.target.index].push(a.source)}}return e[c]}var c,d,e,h,k=s.length,m=t.length,q=l[0],r=l[1];for(c=0;k>c;++c)(h=s[c]).index=c,h.weight=0;for(f=[],g=[],c=0;m>c;++c)h=t[c],"number"==typeof h.source&&(h.source=s[h.source]),"number"==typeof h.target&&(h.target=s[h.target]),f[c]=n.call(this,h,c),g[c]=o.call(this,h,c),++h.source.weight,++h.target.weight;for(c=0;k>c;++c)h=s[c],isNaN(h.x)&&(h.x=a("x",q)),isNaN(h.y)&&(h.y=a("y",r)),isNaN(h.px)&&(h.px=h.x),isNaN(h.py)&&(h.py=h.y);if(i=[],"function"==typeof p)for(c=0;k>c;++c)i[c]=+p.call(this,s[c],c);else for(c=0;k>c;++c)i[c]=p;return j.resume()},j.resume=function(){return j.alpha(.1)},j.stop=function(){return j.alpha(0)},j.drag=function(){c||(c=d3.behavior.drag().origin(e).on("dragstart",b).on("drag",yb).on("dragend",xb)),this.on("mouseover.force",vb).on("mouseout.force",wb).call(c)},d3.rebind(j,k,"on")};var De,Ee;d3.layout.partition=function(){function a(b,c,d,e){var f=b.children;if(b.x=c,b.y=b.depth*e,b.dx=d,b.dy=e,f&&(g=f.length)){var g,h,i,j=-1;for(d=b.value?d/b.value:0;++j<g;)a(h=f[j],c,i=h.value*d,e),c+=i}}function b(a){var c=a.children,d=0;if(c&&(e=c.length))for(var e,f=-1;++f<e;)d=Math.max(d,b(c[f]));return 1+d}function c(c,f){var g=d.call(this,c,f);return a(g[0],0,e[0],e[1]/b(g[0])),g}var d=d3.layout.hierarchy(),e=[1,1];return c.size=function(a){return arguments.length?(e=a,c):e},Nb(c,d)},d3.layout.pie=function(){function a(f,g){var h=f.map(function(c,d){return+b.call(a,c,d)}),i=+("function"==typeof d?d.apply(this,arguments):d),j=(("function"==typeof e?e.apply(this,arguments):e)-d)/d3.sum(h),k=d3.range(f.length);null!=c&&k.sort(c===Fe?function(a,b){return h[b]-h[a]}:function(a,b){return c(f[a],f[b])});var l=[];return k.forEach(function(a){var b;l[a]={data:f[a],value:b=h[a],startAngle:i,endAngle:i+=b*j}}),l}var b=Number,c=Fe,d=0,e=2*Math.PI;return a.value=function(c){return arguments.length?(b=c,a):b},a.sort=function(b){return arguments.length?(c=b,a):c},a.startAngle=function(b){return arguments.length?(d=b,a):d},a.endAngle=function(b){return arguments.length?(e=b,a):e},a};var Fe={};d3.layout.stack=function(){function a(e,i){var j=e.map(function(c,d){return b.call(a,c,d)}),k=j.map(function(b,c){return b.map(function(b,c){return[g.call(a,b,c),h.call(a,b,c)]})}),l=c.call(a,k,i);j=d3.permute(j,l),k=d3.permute(k,l);var m,n,o,p=d.call(a,k,i),q=j.length,r=j[0].length;for(n=0;r>n;++n)for(f.call(a,j[0][n],o=p[n],k[0][n][1]),m=1;q>m;++m)f.call(a,j[m][n],o+=k[m-1][n][1],k[m][n][1]);return e}var b=e,c=Fb,d=Gb,f=Eb,g=Cb,h=Db;return a.values=function(c){return arguments.length?(b=c,a):b},a.order=function(b){return arguments.length?(c="function"==typeof b?b:Ge.get(b)||Fb,a):c},a.offset=function(b){return arguments.length?(d="function"==typeof b?b:He.get(b)||Gb,a):d},a.x=function(b){return arguments.length?(g=b,a):g},a.y=function(b){return arguments.length?(h=b,a):h},a.out=function(b){return arguments.length?(f=b,a):f},a};var Ge=d3.map({"inside-out":function(a){var b,c,d=a.length,e=a.map(Hb),f=a.map(Ib),g=d3.range(d).sort(function(a,b){return e[a]-e[b]}),h=0,i=0,j=[],k=[];for(b=0;d>b;++b)c=g[b],i>h?(h+=f[c],j.push(c)):(i+=f[c],k.push(c));return k.reverse().concat(j)},reverse:function(a){return d3.range(a.length).reverse()},"default":Fb}),He=d3.map({silhouette:function(a){var b,c,d,e=a.length,f=a[0].length,g=[],h=0,i=[];for(c=0;f>c;++c){for(b=0,d=0;e>b;b++)d+=a[b][c][1];d>h&&(h=d),g.push(d)}for(c=0;f>c;++c)i[c]=(h-g[c])/2;return i},wiggle:function(a){var b,c,d,e,f,g,h,i,j,k=a.length,l=a[0],m=l.length,n=[];for(n[0]=i=j=0,c=1;m>c;++c){for(b=0,e=0;k>b;++b)e+=a[b][c][1];for(b=0,f=0,h=l[c][0]-l[c-1][0];k>b;++b){for(d=0,g=(a[b][c][1]-a[b][c-1][1])/(2*h);b>d;++d)g+=(a[d][c][1]-a[d][c-1][1])/h;f+=g*a[b][c][1]}n[c]=i-=e?f/e*h:0,j>i&&(j=i)}for(c=0;m>c;++c)n[c]-=j;return n},expand:function(a){var b,c,d,e=a.length,f=a[0].length,g=1/e,h=[];for(c=0;f>c;++c){for(b=0,d=0;e>b;b++)d+=a[b][c][1];if(d)for(b=0;e>b;b++)a[b][c][1]/=d;else for(b=0;e>b;b++)a[b][c][1]=g}for(c=0;f>c;++c)h[c]=0;return h},zero:Gb});d3.layout.histogram=function(){function a(a,f){for(var g,h,i=[],j=a.map(c,this),k=d.call(this,j,f),l=e.call(this,k,j,f),f=-1,m=j.length,n=l.length-1,o=b?1:1/m;++f<n;)g=i[f]=[],g.dx=l[f+1]-(g.x=l[f]),g.y=0;if(n>0)for(f=-1;++f<m;)h=j[f],h>=k[0]&&h<=k[1]&&(g=i[d3.bisect(l,h,1,n)-1],g.y+=o,g.push(a[f]));return i}var b=!0,c=Number,d=Mb,e=Kb;return a.value=function(b){return arguments.length?(c=b,a):c},a.range=function(b){return arguments.length?(d=h(b),a):d},a.bins=function(b){return arguments.length?(e="number"==typeof b?function(a){return Lb(a,b)}:h(b),a):e},a.frequency=function(c){return arguments.length?(b=!!c,a):b},a},d3.layout.hierarchy=function(){function a(b,g,h){var i=e.call(c,b,g),j=Ie?b:{data:b};if(j.depth=g,h.push(j),i&&(k=i.length)){for(var k,l,m=-1,n=j.children=[],o=0,p=g+1;++m<k;)l=a(i[m],p,h),l.parent=j,n.push(l),o+=l.value;d&&n.sort(d),f&&(j.value=o)}else f&&(j.value=+f.call(c,b,g)||0);return j}function b(a,d){var e=a.children,g=0;if(e&&(h=e.length))for(var h,i=-1,j=d+1;++i<h;)g+=b(e[i],j);else f&&(g=+f.call(c,Ie?a:a.data,d)||0);return f&&(a.value=g),g}function c(b){var c=[];return a(b,0,c),c}var d=Qb,e=Ob,f=Pb;return c.sort=function(a){return arguments.length?(d=a,c):d},c.children=function(a){return arguments.length?(e=a,c):e},c.value=function(a){return arguments.length?(f=a,c):f},c.revalue=function(a){return b(a,0),a},c};var Ie=!1;d3.layout.pack=function(){function a(a,d){var e=b.call(this,a,d),f=e[0];f.x=0,f.y=0,Zb(f);var g=c[0],h=c[1],i=1/Math.max(2*f.r/g,2*f.r/h);return $b(f,g/2,h/2,i),e}var b=d3.layout.hierarchy().sort(Sb),c=[1,1];return a.size=function(b){return arguments.length?(c=b,a):c},Nb(a,b)},d3.layout.cluster=function(){function a(a,e){var f,g=b.call(this,a,e),h=g[0],i=0;lc(h,function(a){var b=a.children;b&&b.length?(a.x=bc(b),a.y=ac(b)):(a.x=f?i+=c(a,f):0,a.y=0,f=a)});var j=cc(h),k=dc(h),l=j.x-c(j,k)/2,m=k.x+c(k,j)/2;return lc(h,function(a){a.x=(a.x-l)/(m-l)*d[0],a.y=(1-(h.y?a.y/h.y:1))*d[1]}),g}var b=d3.layout.hierarchy().sort(null).value(null),c=ec,d=[1,1];return a.separation=function(b){return arguments.length?(c=b,a):c},a.size=function(b){return arguments.length?(d=b,a):d},Nb(a,b)},
d3.layout.tree=function(){function a(a,e){function f(a,b){var d=a.children,e=a._tree;if(d&&(g=d.length)){for(var g,i,j,k=d[0],l=k,m=-1;++m<g;)j=d[m],f(j,i),l=h(j,i,l),i=j;mc(a);var n=.5*(k._tree.prelim+j._tree.prelim);b?(e.prelim=b._tree.prelim+c(a,b),e.mod=e.prelim-n):e.prelim=n}else b&&(e.prelim=b._tree.prelim+c(a,b))}function g(a,b){a.x=a._tree.prelim+b;var c=a.children;if(c&&(d=c.length)){var d,e=-1;for(b+=a._tree.mod;++e<d;)g(c[e],b)}}function h(a,b,d){if(b){for(var e,f=a,g=a,h=b,i=a.parent.children[0],j=f._tree.mod,k=g._tree.mod,l=h._tree.mod,m=i._tree.mod;h=gc(h),f=fc(f),h&&f;)i=fc(i),g=gc(g),g._tree.ancestor=a,e=h._tree.prelim+l-f._tree.prelim-j+c(h,f),e>0&&(nc(oc(h,a,d),a,e),j+=e,k+=e),l+=h._tree.mod,j+=f._tree.mod,m+=i._tree.mod,k+=g._tree.mod;h&&!gc(g)&&(g._tree.thread=h,g._tree.mod+=l-k),f&&!fc(i)&&(i._tree.thread=f,i._tree.mod+=j-m,d=a)}return d}var i=b.call(this,a,e),j=i[0];lc(j,function(a,b){a._tree={ancestor:a,prelim:0,mod:0,change:0,shift:0,number:b?b._tree.number+1:0}}),f(j),g(j,-j._tree.prelim);var k=hc(j,jc),l=hc(j,ic),m=hc(j,kc),n=k.x-c(k,l)/2,o=l.x+c(l,k)/2,p=m.depth||1;return lc(j,function(a){a.x=(a.x-n)/(o-n)*d[0],a.y=a.depth/p*d[1],delete a._tree}),i}var b=d3.layout.hierarchy().sort(null).value(null),c=ec,d=[1,1];return a.separation=function(b){return arguments.length?(c=b,a):c},a.size=function(b){return arguments.length?(d=b,a):d},Nb(a,b)},d3.layout.treemap=function(){function a(a,b){for(var c,d,e=-1,f=a.length;++e<f;)d=(c=a[e]).value*(0>b?0:b),c.area=isNaN(d)||0>=d?0:d}function b(c){var f=c.children;if(f&&f.length){var g,h,i,j=l(c),k=[],m=f.slice(),n=1/0,o=Math.min(j.dx,j.dy);for(a(m,j.dx*j.dy/c.value),k.area=0;(i=m.length)>0;)k.push(g=m[i-1]),k.area+=g.area,(h=d(k,o))<=n?(m.pop(),n=h):(k.area-=k.pop().area,e(k,o,j,!1),o=Math.min(j.dx,j.dy),k.length=k.area=0,n=1/0);k.length&&(e(k,o,j,!0),k.length=k.area=0),f.forEach(b)}}function c(b){var d=b.children;if(d&&d.length){var f,g=l(b),h=d.slice(),i=[];for(a(h,g.dx*g.dy/b.value),i.area=0;f=h.pop();)i.push(f),i.area+=f.area,null!=f.z&&(e(i,f.z?g.dx:g.dy,g,!h.length),i.length=i.area=0);d.forEach(c)}}function d(a,b){for(var c,d=a.area,e=0,f=1/0,g=-1,h=a.length;++g<h;)(c=a[g].area)&&(f>c&&(f=c),c>e&&(e=c));return d*=d,b*=b,d?Math.max(b*e*n/d,d/(b*f*n)):1/0}function e(a,b,c,d){var e,f=-1,g=a.length,h=c.x,j=c.y,k=b?i(a.area/b):0;if(b==c.dx){for((d||k>c.dy)&&(k=c.dy);++f<g;)e=a[f],e.x=h,e.y=j,e.dy=k,h+=e.dx=Math.min(c.x+c.dx-h,k?i(e.area/k):0);e.z=!0,e.dx+=c.x+c.dx-h,c.y+=k,c.dy-=k}else{for((d||k>c.dx)&&(k=c.dx);++f<g;)e=a[f],e.x=h,e.y=j,e.dx=k,j+=e.dy=Math.min(c.y+c.dy-j,k?i(e.area/k):0);e.z=!1,e.dy+=c.y+c.dy-j,c.x+=k,c.dx-=k}}function f(d){var e=g||h(d),f=e[0];return f.x=0,f.y=0,f.dx=j[0],f.dy=j[1],g&&h.revalue(f),a([f],f.dx*f.dy/f.value),(g?c:b)(f),m&&(g=e),e}var g,h=d3.layout.hierarchy(),i=Math.round,j=[1,1],k=null,l=pc,m=!1,n=.5*(1+Math.sqrt(5));return f.size=function(a){return arguments.length?(j=a,f):j},f.padding=function(a){function b(b){var c=a.call(f,b,b.depth);return null==c?pc(b):qc(b,"number"==typeof c?[c,c,c,c]:c)}function c(b){return qc(b,a)}if(!arguments.length)return k;var d;return l=null==(k=a)?pc:"function"==(d=typeof a)?b:"number"===d?(a=[a,a,a,a],c):c,f},f.round=function(a){return arguments.length?(i=a?Math.round:Number,f):i!=Number},f.sticky=function(a){return arguments.length?(m=a,g=null,f):m},f.ratio=function(a){return arguments.length?(n=a,f):n},Nb(f,h)},d3.csv=function(a,b){d3.text(a,"text/csv",function(a){b(a&&d3.csv.parse(a))})},d3.csv.parse=function(a){var b;return d3.csv.parseRows(a,function(a,c){if(c){for(var d={},e=-1,f=b.length;++e<f;)d[b[e]]=a[e];return d}return b=a,null})},d3.csv.parseRows=function(a,b){function c(){if(i.lastIndex>=a.length)return g;if(e)return e=!1,f;var b=i.lastIndex;if(34===a.charCodeAt(b)){for(var c=b;c++<a.length;)if(34===a.charCodeAt(c)){if(34!==a.charCodeAt(c+1))break;c++}i.lastIndex=c+2;var d=a.charCodeAt(c+1);return 13===d?(e=!0,10===a.charCodeAt(c+2)&&i.lastIndex++):10===d&&(e=!0),a.substring(b+1,c).replace(/""/g,'"')}var h=i.exec(a);return h?(e=44!==h[0].charCodeAt(0),a.substring(b,h.index)):(i.lastIndex=a.length,a.substring(b))}var d,e,f={},g={},h=[],i=/\r\n|[,\r\n]/g,j=0;for(i.lastIndex=0;(d=c())!==g;){for(var k=[];d!==f&&d!==g;)k.push(d),d=c();(!b||(k=b(k,j++)))&&h.push(k)}return h},d3.csv.format=function(a){return a.map(rc).join("\n")},d3.geo={};var Je=Math.PI/180;d3.geo.azimuthal=function(){function a(a){var b,d=a[0]*Je-c,j=a[1]*Je,k=Math.cos(d),l=Math.sin(d),m=Math.cos(j),n=Math.sin(j),o="orthographic"!==g?f*n+e*m*k:null,p="stereographic"===g?1/(1+o):"gnomonic"===g?1/o:"equidistant"===g?(b=Math.acos(o),b?b/Math.sin(b):0):"equalarea"===g?Math.sqrt(2/(1+o)):1,q=p*m*l,r=p*(f*m*k-e*n);return[h*q+i[0],h*r+i[1]]}var b,c,d,e,f,g="orthographic",h=200,i=[480,250];return a.invert=function(a){var b=(a[0]-i[0])/h,d=(a[1]-i[1])/h,j=Math.sqrt(b*b+d*d),k="stereographic"===g?2*Math.atan(j):"gnomonic"===g?Math.atan(j):"equidistant"===g?j:"equalarea"===g?2*Math.asin(.5*j):Math.asin(j),l=Math.sin(k),m=Math.cos(k);return[(c+Math.atan2(b*l,j*e*m+d*f*l))/Je,Math.asin(m*f-(j?d*l*e/j:0))/Je]},a.mode=function(b){return arguments.length?(g=b+"",a):g},a.origin=function(g){return arguments.length?(b=g,c=b[0]*Je,d=b[1]*Je,e=Math.cos(d),f=Math.sin(d),a):b},a.scale=function(b){return arguments.length?(h=+b,a):h},a.translate=function(b){return arguments.length?(i=[+b[0],+b[1]],a):i},a.origin([0,0])},d3.geo.albers=function(){function a(a){var b=d*(Je*a[0]-c),g=Math.sqrt(e-2*d*Math.sin(Je*a[1]))/d;return[i*g*Math.sin(b)+j[0],i*(g*Math.cos(b)-f)+j[1]]}function b(){var b=Je*h[0],i=Je*h[1],j=Je*g[1],k=Math.sin(b),l=Math.cos(b);return c=Je*g[0],d=.5*(k+Math.sin(i)),e=l*l+2*d*k,f=Math.sqrt(e-2*d*Math.sin(j))/d,a}var c,d,e,f,g=[-98,38],h=[29.5,45.5],i=1e3,j=[480,250];return a.invert=function(a){var b=(a[0]-j[0])/i,g=(a[1]-j[1])/i,h=f+g,k=Math.atan2(b,h),l=Math.sqrt(b*b+h*h);return[(c+k/d)/Je,Math.asin((e-l*l*d*d)/(2*d))/Je]},a.origin=function(a){return arguments.length?(g=[+a[0],+a[1]],b()):g},a.parallels=function(a){return arguments.length?(h=[+a[0],+a[1]],b()):h},a.scale=function(b){return arguments.length?(i=+b,a):i},a.translate=function(b){return arguments.length?(j=[+b[0],+b[1]],a):j},b()},d3.geo.albersUsa=function(){function a(a){var f=a[0],g=a[1];return(g>50?c:-140>f?d:21>g?e:b)(a)}var b=d3.geo.albers(),c=d3.geo.albers().origin([-160,60]).parallels([55,65]),d=d3.geo.albers().origin([-160,20]).parallels([8,18]),e=d3.geo.albers().origin([-60,10]).parallels([8,18]);return a.scale=function(f){return arguments.length?(b.scale(f),c.scale(.6*f),d.scale(f),e.scale(1.5*f),a.translate(b.translate())):b.scale()},a.translate=function(f){if(!arguments.length)return b.translate();var g=b.scale()/1e3,h=f[0],i=f[1];return b.translate(f),c.translate([h-400*g,i+170*g]),d.translate([h-190*g,i+200*g]),e.translate([h+580*g,i+430*g]),a},a.scale(b.scale())},d3.geo.bonne=function(){function a(a){var h=a[0]*Je-b,i=a[1]*Je-c;if(d){var j=e+d-i,k=h*Math.cos(i)/j;h=j*Math.sin(k),i=j*Math.cos(k)-e}else h*=Math.cos(i),i*=-1;return[f*h+g[0],f*i+g[1]]}var b,c,d,e,f=200,g=[480,250];return a.invert=function(a){var c=(a[0]-g[0])/f,h=(a[1]-g[1])/f;if(d){var i=e+h,j=Math.sqrt(c*c+i*i);h=e+d-j,c=b+j*Math.atan2(c,i)/Math.cos(h)}else h*=-1,c/=Math.cos(h);return[c/Je,h/Je]},a.parallel=function(b){return arguments.length?(e=1/Math.tan(d=b*Je),a):d/Je},a.origin=function(d){return arguments.length?(b=d[0]*Je,c=d[1]*Je,a):[b/Je,c/Je]},a.scale=function(b){return arguments.length?(f=+b,a):f},a.translate=function(b){return arguments.length?(g=[+b[0],+b[1]],a):g},a.origin([0,0]).parallel(45)},d3.geo.equirectangular=function(){function a(a){var d=a[0]/360,e=-a[1]/360;return[b*d+c[0],b*e+c[1]]}var b=500,c=[480,250];return a.invert=function(a){var d=(a[0]-c[0])/b,e=(a[1]-c[1])/b;return[360*d,-360*e]},a.scale=function(c){return arguments.length?(b=+c,a):b},a.translate=function(b){return arguments.length?(c=[+b[0],+b[1]],a):c},a},d3.geo.mercator=function(){function a(a){var d=a[0]/360,e=-(Math.log(Math.tan(Math.PI/4+a[1]*Je/2))/Je)/360;return[b*d+c[0],b*Math.max(-.5,Math.min(.5,e))+c[1]]}var b=500,c=[480,250];return a.invert=function(a){var d=(a[0]-c[0])/b,e=(a[1]-c[1])/b;return[360*d,2*Math.atan(Math.exp(-360*e*Je))/Je-90]},a.scale=function(c){return arguments.length?(b=+c,a):b},a.translate=function(b){return arguments.length?(c=[+b[0],+b[1]],a):c},a},d3.geo.path=function(){function a(a,b){"function"==typeof f&&(g=uc(f.apply(this,arguments))),j(a);var c=i.length?i.join(""):null;return i=[],c}function b(a){return h(a).join(",")}function c(a){for(var b=e(a[0]),c=0,d=a.length;++c<d;)b-=e(a[c]);return b}function d(a){for(var b=d3.geom.polygon(a[0].map(h)),c=b.area(),d=b.centroid(0>c?(c*=-1,1):-1),e=d[0],f=d[1],g=c,i=0,j=a.length;++i<j;)b=d3.geom.polygon(a[i].map(h)),c=b.area(),d=b.centroid(0>c?(c*=-1,1):-1),e-=d[0],f-=d[1],g-=c;return[e,f,6*g]}function e(a){return Math.abs(d3.geom.polygon(a.map(h)).area())}var f=4.5,g=uc(f),h=d3.geo.albersUsa(),i=[],j=tc({FeatureCollection:function(a){for(var b=a.features,c=-1,d=b.length;++c<d;)i.push(j(b[c].geometry))},Feature:function(a){j(a.geometry)},Point:function(a){i.push("M",b(a.coordinates),g)},MultiPoint:function(a){for(var c=a.coordinates,d=-1,e=c.length;++d<e;)i.push("M",b(c[d]),g)},LineString:function(a){var c=a.coordinates,d=-1,e=c.length;for(i.push("M");++d<e;)i.push(b(c[d]),"L");i.pop()},MultiLineString:function(a){for(var c,d,e,f=a.coordinates,g=-1,h=f.length;++g<h;){for(c=f[g],d=-1,e=c.length,i.push("M");++d<e;)i.push(b(c[d]),"L");i.pop()}},Polygon:function(a){for(var c,d,e,f=a.coordinates,g=-1,h=f.length;++g<h;)if(c=f[g],d=-1,(e=c.length-1)>0){for(i.push("M");++d<e;)i.push(b(c[d]),"L");i[i.length-1]="Z"}},MultiPolygon:function(a){for(var c,d,e,f,g,h,j=a.coordinates,k=-1,l=j.length;++k<l;)for(c=j[k],d=-1,e=c.length;++d<e;)if(f=c[d],g=-1,(h=f.length-1)>0){for(i.push("M");++g<h;)i.push(b(f[g]),"L");i[i.length-1]="Z"}},GeometryCollection:function(a){for(var b=a.geometries,c=-1,d=b.length;++c<d;)i.push(j(b[c]))}}),k=a.area=tc({FeatureCollection:function(a){for(var b=0,c=a.features,d=-1,e=c.length;++d<e;)b+=k(c[d]);return b},Feature:function(a){return k(a.geometry)},Polygon:function(a){return c(a.coordinates)},MultiPolygon:function(a){for(var b=0,d=a.coordinates,e=-1,f=d.length;++e<f;)b+=c(d[e]);return b},GeometryCollection:function(a){for(var b=0,c=a.geometries,d=-1,e=c.length;++d<e;)b+=k(c[d]);return b}},0),l=a.centroid=tc({Feature:function(a){return l(a.geometry)},Polygon:function(a){var b=d(a.coordinates);return[b[0]/b[2],b[1]/b[2]]},MultiPolygon:function(a){for(var b,c=a.coordinates,e=0,f=0,g=0,h=-1,i=c.length;++h<i;)b=d(c[h]),e+=b[0],f+=b[1],g+=b[2];return[e/g,f/g]}});return a.projection=function(b){return h=b,a},a.pointRadius=function(b){return"function"==typeof b?f=b:(f=+b,g=uc(f)),a},a},d3.geo.bounds=function(a){var b=1/0,c=1/0,d=-(1/0),e=-(1/0);return vc(a,function(a,f){b>a&&(b=a),a>d&&(d=a),c>f&&(c=f),f>e&&(e=f)}),[[b,c],[d,e]]};var Ke={Feature:wc,FeatureCollection:xc,GeometryCollection:yc,LineString:zc,MultiLineString:Ac,MultiPoint:zc,MultiPolygon:Bc,Point:Cc,Polygon:Dc};d3.geo.circle=function(){function a(){}function b(a){return i.distance(a)<h}function c(a){for(var b,c,e,f,g,j=-1,k=a.length,l=[];++j<k;)g=i.distance(e=a[j]),h>g?(c&&l.push(Hc(c,e)((f-h)/(f-g))),l.push(e),b=c=null):(c=e,!b&&l.length&&(l.push(Hc(l[l.length-1],c)((h-f)/(g-f))),b=c)),f=g;return b=a[0],c=l[0],!c||e[0]!==b[0]||e[1]!==b[1]||e[0]===c[0]&&e[1]===c[1]||l.push(c),d(l)}function d(a){for(var b,c,d,e=0,f=a.length,g=f?[a[0]]:a,h=i.source();++e<f;)for(d=i.source(a[e-1])(a[e]).coordinates,b=0,c=d.length;++b<c;)g.push(d[b]);return i.source(h),g}var f=[0,0],g=89.99,h=g*Je,i=d3.geo.greatArc().source(f).target(e);a.clip=function(a){return"function"==typeof f&&i.source(f.apply(this,arguments)),j(a)||null};var j=tc({FeatureCollection:function(a){var b=a.features.map(j).filter(e);return b&&(a=Object.create(a),a.features=b,a)},Feature:function(a){var b=j(a.geometry);return b&&(a=Object.create(a),a.geometry=b,a)},Point:function(a){return b(a.coordinates)&&a},MultiPoint:function(a){var c=a.coordinates.filter(b);return c.length&&{type:a.type,coordinates:c}},LineString:function(a){var b=c(a.coordinates);return b.length&&(a=Object.create(a),a.coordinates=b,a)},MultiLineString:function(a){var b=a.coordinates.map(c).filter(function(a){return a.length});return b.length&&(a=Object.create(a),a.coordinates=b,a)},Polygon:function(a){var b=a.coordinates.map(c);return b[0].length&&(a=Object.create(a),a.coordinates=b,a)},MultiPolygon:function(a){var b=a.coordinates.map(function(a){return a.map(c)}).filter(function(a){return a[0].length});return b.length&&(a=Object.create(a),a.coordinates=b,a)},GeometryCollection:function(a){var b=a.geometries.map(j).filter(e);return b.length&&(a=Object.create(a),a.geometries=b,a)}});return a.origin=function(b){return arguments.length?(f=b,"function"!=typeof f&&i.source(f),a):f},a.angle=function(b){return arguments.length?(h=(g=+b)*Je,a):g},d3.rebind(a,i,"precision")},d3.geo.greatArc=function(){function a(){for(var d=a.distance.apply(this,arguments),e=0,h=f/d,i=[b];(e+=h)<1;)i.push(g(e));return i.push(c),{type:"LineString",coordinates:i}}var b,c,d=Ec,e=Fc,f=6*Je,g=Gc();return a.distance=function(){return"function"==typeof d&&g.source(b=d.apply(this,arguments)),"function"==typeof e&&g.target(c=e.apply(this,arguments)),g.distance()},a.source=function(c){return arguments.length?(d=c,"function"!=typeof d&&g.source(b=d),a):d},a.target=function(b){return arguments.length?(e=b,"function"!=typeof e&&g.target(c=e),a):e},a.precision=function(b){return arguments.length?(f=b*Je,a):f/Je},a},d3.geo.greatCircle=d3.geo.circle,d3.geom={},d3.geom.contour=function(a,b){var c=b||Ic(a),d=[],e=c[0],f=c[1],g=0,h=0,i=NaN,j=NaN,k=0;do k=0,a(e-1,f-1)&&(k+=1),a(e,f-1)&&(k+=2),a(e-1,f)&&(k+=4),a(e,f)&&(k+=8),6===k?(g=-1===j?-1:1,h=0):9===k?(g=0,h=1===i?-1:1):(g=Le[k],h=Me[k]),g!=i&&h!=j&&(d.push([e,f]),i=g,j=h),e+=g,f+=h;while(c[0]!=e||c[1]!=f);return d};var Le=[1,0,1,1,-1,0,-1,1,0,0,0,0,-1,0,-1,NaN],Me=[0,-1,0,0,0,-1,0,0,1,-1,1,1,0,-1,0,NaN];d3.geom.hull=function(a){if(a.length<3)return[];var b,c,d,e,f,g,h,i,j,k,l=a.length,m=l-1,n=[],o=[],p=0;for(b=1;l>b;++b)a[b][1]<a[p][1]?p=b:a[b][1]==a[p][1]&&(p=a[b][0]<a[p][0]?b:p);for(b=0;l>b;++b)b!==p&&(e=a[b][1]-a[p][1],d=a[b][0]-a[p][0],n.push({angle:Math.atan2(e,d),index:b}));for(n.sort(function(a,b){return a.angle-b.angle}),j=n[0].angle,i=n[0].index,h=0,b=1;m>b;++b)c=n[b].index,j==n[b].angle?(d=a[i][0]-a[p][0],e=a[i][1]-a[p][1],f=a[c][0]-a[p][0],g=a[c][1]-a[p][1],d*d+e*e>=f*f+g*g?n[b].index=-1:(n[h].index=-1,j=n[b].angle,h=b,i=c)):(j=n[b].angle,h=b,i=c);for(o.push(p),b=0,c=0;2>b;++c)-1!==n[c].index&&(o.push(n[c].index),b++);for(k=o.length;m>c;++c)if(-1!==n[c].index){for(;!Jc(o[k-2],o[k-1],n[c].index,a);)--k;o[k++]=n[c].index}var q=[];for(b=0;k>b;++b)q.push(a[o[b]]);return q},d3.geom.polygon=function(a){return a.area=function(){for(var b=0,c=a.length,d=a[c-1][0]*a[0][1],e=a[c-1][1]*a[0][0];++b<c;)d+=a[b-1][0]*a[b][1],e+=a[b-1][1]*a[b][0];return.5*(e-d)},a.centroid=function(b){var c,d,e=-1,f=a.length,g=0,h=0,i=a[f-1];for(arguments.length||(b=-1/(6*a.area()));++e<f;)c=i,i=a[e],d=c[0]*i[1]-i[0]*c[1],g+=(c[0]+i[0])*d,h+=(c[1]+i[1])*d;return[g*b,h*b]},a.clip=function(b){for(var c,d,e,f,g,h,i=-1,j=a.length,k=a[j-1];++i<j;){for(c=b.slice(),b.length=0,f=a[i],g=c[(e=c.length)-1],d=-1;++d<e;)h=c[d],Kc(h,k,f)?(Kc(g,k,f)||b.push(Lc(g,h,k,f)),b.push(h)):Kc(g,k,f)&&b.push(Lc(g,h,k,f)),g=h;k=f}return b},a},d3.geom.voronoi=function(a){var b=a.map(function(){return[]});return Mc(a,function(a){var c,d,e,f,g,h;1===a.a&&a.b>=0?(c=a.ep.r,d=a.ep.l):(c=a.ep.l,d=a.ep.r),1===a.a?(g=c?c.y:-1e6,e=a.c-a.b*g,h=d?d.y:1e6,f=a.c-a.b*h):(e=c?c.x:-1e6,g=a.c-a.a*e,f=d?d.x:1e6,h=a.c-a.a*f);var i=[e,g],j=[f,h];b[a.region.l.index].push(i,j),b[a.region.r.index].push(i,j)}),b.map(function(b,c){var d=a[c][0],e=a[c][1];return b.forEach(function(a){a.angle=Math.atan2(a[0]-d,a[1]-e)}),b.sort(function(a,b){return a.angle-b.angle}).filter(function(a,c){return!c||a.angle-b[c-1].angle>1e-10})})};var Ne={l:"r",r:"l"};d3.geom.delaunay=function(a){var b=a.map(function(){return[]}),c=[];return Mc(a,function(c){b[c.region.l.index].push(a[c.region.r.index])}),b.forEach(function(b,d){var e=a[d],f=e[0],g=e[1];b.forEach(function(a){a.angle=Math.atan2(a[0]-f,a[1]-g)}),b.sort(function(a,b){return a.angle-b.angle});for(var h=0,i=b.length-1;i>h;h++)c.push([e,b[h],b[h+1]])}),c},d3.geom.quadtree=function(a,b,c,d,e){function f(a,b,c,d,e,f){if(!isNaN(b.x)&&!isNaN(b.y))if(a.leaf){var h=a.point;h?Math.abs(h.x-b.x)+Math.abs(h.y-b.y)<.01?g(a,b,c,d,e,f):(a.point=null,g(a,h,c,d,e,f),g(a,b,c,d,e,f)):a.point=b}else g(a,b,c,d,e,f)}function g(a,b,c,d,e,g){var h=.5*(c+e),i=.5*(d+g),j=b.x>=h,k=b.y>=i,l=(k<<1)+j;a.leaf=!1,a=a.nodes[l]||(a.nodes[l]=Nc()),j?c=h:e=h,k?d=i:g=i,f(a,b,c,d,e,g)}var h,i=-1,j=a.length;if(j&&isNaN(a[0].x)&&(a=a.map(Pc)),arguments.length<5)if(3===arguments.length)e=d=c,c=b;else{for(b=c=1/0,d=e=-(1/0);++i<j;)h=a[i],h.x<b&&(b=h.x),h.y<c&&(c=h.y),h.x>d&&(d=h.x),h.y>e&&(e=h.y);var k=d-b,l=e-c;k>l?e=c+k:d=b+l}var m=Nc();return m.add=function(a){f(m,a,b,c,d,e)},m.visit=function(a){Oc(a,m,b,c,d,e)},a.forEach(m.add),m},d3.time={};var Oe=Date;Qc.prototype={getDate:function(){return this._.getUTCDate()},getDay:function(){return this._.getUTCDay()},getFullYear:function(){return this._.getUTCFullYear()},getHours:function(){return this._.getUTCHours()},getMilliseconds:function(){return this._.getUTCMilliseconds()},getMinutes:function(){return this._.getUTCMinutes()},getMonth:function(){return this._.getUTCMonth()},getSeconds:function(){return this._.getUTCSeconds()},getTime:function(){return this._.getTime()},getTimezoneOffset:function(){return 0},valueOf:function(){return this._.valueOf()},setDate:function(){Pe.setUTCDate.apply(this._,arguments)},setDay:function(){Pe.setUTCDay.apply(this._,arguments)},setFullYear:function(){Pe.setUTCFullYear.apply(this._,arguments)},setHours:function(){Pe.setUTCHours.apply(this._,arguments)},setMilliseconds:function(){Pe.setUTCMilliseconds.apply(this._,arguments)},setMinutes:function(){Pe.setUTCMinutes.apply(this._,arguments)},setMonth:function(){Pe.setUTCMonth.apply(this._,arguments)},setSeconds:function(){Pe.setUTCSeconds.apply(this._,arguments)},setTime:function(){Pe.setTime.apply(this._,arguments)}};var Pe=Date.prototype;d3.time.format=function(a){function b(b){for(var d,e,f=[],g=-1,h=0;++g<c;)37==a.charCodeAt(g)&&(f.push(a.substring(h,g),(e=Ue[d=a.charAt(++g)])?e(b):d),h=g+1);return f.push(a.substring(h,g)),f.join("")}var c=a.length;return b.parse=function(b){var c={y:1900,m:0,d:1,H:0,M:0,S:0,L:0},d=Rc(c,a,b,0);if(d!=b.length)return null;"p"in c&&(c.H=c.H%12+12*c.p);var e=new Oe;return e.setFullYear(c.y,c.m,c.d),e.setHours(c.H,c.M,c.S,c.L),e},b.toString=function(){return a},b};var Qe=d3.format("02d"),Re=d3.format("03d"),Se=d3.format("04d"),Te=d3.format("2d"),Ue={a:function(a){return Ye[a.getDay()].substring(0,3)},A:function(a){return Ye[a.getDay()]},b:function(a){return af[a.getMonth()].substring(0,3)},B:function(a){return af[a.getMonth()]},c:d3.time.format("%a %b %e %H:%M:%S %Y"),d:function(a){return Qe(a.getDate())},e:function(a){return Te(a.getDate())},H:function(a){return Qe(a.getHours())},I:function(a){return Qe(a.getHours()%12||12)},j:function(a){return Re(1+d3.time.dayOfYear(a))},L:function(a){return Re(a.getMilliseconds())},m:function(a){return Qe(a.getMonth()+1)},M:function(a){return Qe(a.getMinutes())},p:function(a){return a.getHours()>=12?"PM":"AM"},S:function(a){return Qe(a.getSeconds())},U:function(a){return Qe(d3.time.sundayOfYear(a))},w:function(a){return a.getDay()},W:function(a){return Qe(d3.time.mondayOfYear(a))},x:d3.time.format("%m/%d/%y"),X:d3.time.format("%H:%M:%S"),y:function(a){return Qe(a.getFullYear()%100)},Y:function(a){return Se(a.getFullYear()%1e4)},Z:hd,"%":function(a){return"%"}},Ve={a:Sc,A:Tc,b:Uc,B:Vc,c:Wc,d:bd,e:bd,H:cd,I:cd,L:fd,m:ad,M:dd,p:gd,S:ed,x:Xc,X:Yc,y:$c,Y:Zc},We=/^(?:sun|mon|tue|wed|thu|fri|sat)/i,Xe=/^(?:Sunday|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday)/i,Ye=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],Ze=d3.map({jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11}),$e=/^(?:January|February|March|April|May|June|July|August|September|October|November|December)/gi,_e=d3.map({january:0,february:1,march:2,april:3,may:4,june:5,july:6,august:7,september:8,october:9,november:10,december:11}),af=["January","February","March","April","May","June","July","August","September","October","November","December"],bf=/\s*\d+/,cf=d3.map({am:0,pm:1});d3.time.format.utc=function(a){function b(a){try{Oe=Qc;var b=new Oe;return b._=a,c(b)}finally{Oe=Date}}var c=d3.time.format(a);return b.parse=function(a){try{Oe=Qc;var b=c.parse(a);return b&&b._}finally{Oe=Date}},b.toString=c.toString,b};var df=d3.time.format.utc("%Y-%m-%dT%H:%M:%S.%LZ");d3.time.format.iso=Date.prototype.toISOString?id:df,id.parse=function(a){var b=new Date(a);return isNaN(b)?null:b},id.toString=df.toString,d3.time.second=jd(function(a){return new Oe(1e3*Math.floor(a/1e3))},function(a,b){a.setTime(a.getTime()+1e3*Math.floor(b))},function(a){return a.getSeconds()}),d3.time.seconds=d3.time.second.range,d3.time.seconds.utc=d3.time.second.utc.range,d3.time.minute=jd(function(a){return new Oe(6e4*Math.floor(a/6e4))},function(a,b){a.setTime(a.getTime()+6e4*Math.floor(b))},function(a){return a.getMinutes()}),d3.time.minutes=d3.time.minute.range,d3.time.minutes.utc=d3.time.minute.utc.range,d3.time.hour=jd(function(a){var b=a.getTimezoneOffset()/60;return new Oe(36e5*(Math.floor(a/36e5-b)+b))},function(a,b){a.setTime(a.getTime()+36e5*Math.floor(b))},function(a){return a.getHours()}),d3.time.hours=d3.time.hour.range,d3.time.hours.utc=d3.time.hour.utc.range,d3.time.day=jd(function(a){return new Oe(a.getFullYear(),a.getMonth(),a.getDate())},function(a,b){a.setDate(a.getDate()+b)},function(a){return a.getDate()-1}),d3.time.days=d3.time.day.range,d3.time.days.utc=d3.time.day.utc.range,d3.time.dayOfYear=function(a){var b=d3.time.year(a);return Math.floor((a-b)/864e5-(a.getTimezoneOffset()-b.getTimezoneOffset())/1440)},Ye.forEach(function(a,b){a=a.toLowerCase(),b=7-b;var c=d3.time[a]=jd(function(a){return(a=d3.time.day(a)).setDate(a.getDate()-(a.getDay()+b)%7),a},function(a,b){a.setDate(a.getDate()+7*Math.floor(b))},function(a){var c=d3.time.year(a).getDay();return Math.floor((d3.time.dayOfYear(a)+(c+b)%7)/7)-(c!==b)});d3.time[a+"s"]=c.range,d3.time[a+"s"].utc=c.utc.range,d3.time[a+"OfYear"]=function(a){var c=d3.time.year(a).getDay();return Math.floor((d3.time.dayOfYear(a)+(c+b)%7)/7)}}),d3.time.week=d3.time.sunday,d3.time.weeks=d3.time.sunday.range,d3.time.weeks.utc=d3.time.sunday.utc.range,d3.time.weekOfYear=d3.time.sundayOfYear,d3.time.month=jd(function(a){return new Oe(a.getFullYear(),a.getMonth(),1)},function(a,b){a.setMonth(a.getMonth()+b)},function(a){return a.getMonth()}),d3.time.months=d3.time.month.range,d3.time.months.utc=d3.time.month.utc.range,d3.time.year=jd(function(a){return new Oe(a.getFullYear(),0,1)},function(a,b){a.setFullYear(a.getFullYear()+b)},function(a){return a.getFullYear()}),d3.time.years=d3.time.year.range,d3.time.years.utc=d3.time.year.utc.range;var ef=[1e3,5e3,15e3,3e4,6e4,3e5,9e5,18e5,36e5,108e5,216e5,432e5,864e5,1728e5,6048e5,2592e6,7776e6,31536e6],ff=[[d3.time.second,1],[d3.time.second,5],[d3.time.second,15],[d3.time.second,30],[d3.time.minute,1],[d3.time.minute,5],[d3.time.minute,15],[d3.time.minute,30],[d3.time.hour,1],[d3.time.hour,3],[d3.time.hour,6],[d3.time.hour,12],[d3.time.day,1],[d3.time.day,2],[d3.time.week,1],[d3.time.month,1],[d3.time.month,3],[d3.time.year,1]],gf=[[d3.time.format("%Y"),function(a){return!0}],[d3.time.format("%B"),function(a){return a.getMonth()}],[d3.time.format("%b %d"),function(a){return 1!=a.getDate()}],[d3.time.format("%a %d"),function(a){return a.getDay()&&1!=a.getDate()}],[d3.time.format("%I %p"),function(a){return a.getHours()}],[d3.time.format("%I:%M"),function(a){return a.getMinutes()}],[d3.time.format(":%S"),function(a){return a.getSeconds()}],[d3.time.format(".%L"),function(a){return a.getMilliseconds()}]],hf=d3.scale.linear(),jf=od(gf);ff.year=function(a,b){return hf.domain(a.map(qd)).ticks(b).map(pd)},d3.time.scale=function(){return ld(d3.scale.linear(),ff,jf)};var kf=ff.map(function(a){return[a[0].utc,a[1]]}),lf=[[d3.time.format.utc("%Y"),function(a){return!0}],[d3.time.format.utc("%B"),function(a){return a.getUTCMonth()}],[d3.time.format.utc("%b %d"),function(a){return 1!=a.getUTCDate()}],[d3.time.format.utc("%a %d"),function(a){return a.getUTCDay()&&1!=a.getUTCDate()}],[d3.time.format.utc("%I %p"),function(a){return a.getUTCHours()}],[d3.time.format.utc("%I:%M"),function(a){return a.getUTCMinutes()}],[d3.time.format.utc(":%S"),function(a){return a.getUTCSeconds()}],[d3.time.format.utc(".%L"),function(a){return a.getUTCMilliseconds()}]],mf=od(lf);kf.year=function(a,b){return hf.domain(a.map(sd)).ticks(b).map(rd)},d3.time.scale.utc=function(){return ld(d3.scale.linear(),kf,mf)}}(),function(a,b,c){function d(b){if(a.event&&a.event.contentOverflow!==c)return{x:a.event.offsetX,y:a.event.offsetY};if(b.offsetX!==c&&b.offsetY!==c)return{x:b.offsetX,y:b.offsetY};var d=b.target.parentNode.parentNode;return{x:b.layerX-d.offsetLeft,y:b.layerY-d.offsetTop}}function e(a,c,d){a=b.createElementNS(t,a);for(var e in c)a.setAttribute(e,c[e]);"[object Array]"!=Object.prototype.toString.call(d)&&(d=[d]);for(var f=0,g=d[0]&&d.length||0;g>f;f++)a.appendChild(d[f]);return a}function f(a){var b,c,d,e,f,g=a.h%360/60;f=a.v*a.s,e=f*(1-Math.abs(g%2-1)),b=c=d=a.v-f,g=~~g,b+=[f,e,0,0,e,f][g],c+=[e,f,f,e,0,0][g],d+=[0,0,e,f,f,e][g];var h=Math.floor(255*b),i=Math.floor(255*c),j=Math.floor(255*d);return{r:h,g:i,b:j,hex:"#"+(16777216|j|i<<8|h<<16).toString(16).slice(1)}}function g(a){var b=a.r,c=a.g,d=a.b;(a.r>1||a.g>1||a.b>1)&&(b/=255,c/=255,d/=255);var e,f,g,h;return g=Math.max(b,c,d),h=g-Math.min(b,c,d),e=0==h?null:g==b?(c-d)/h+(d>c?6:0):g==c?(d-b)/h+2:(b-c)/h+4,e=e%6*60,f=0==h?0:h/g,{h:e,s:f,v:g}}function h(b,e,g){return function(h){h=h||a.event;var i=d(h);b.h=i.y/e.offsetHeight*360+s,b.s=b.v=1;var j=f({h:b.h,s:1,v:1});g.style.backgroundColor=j.hex,b.callback&&b.callback(j.hex,{h:b.h-s,s:b.s,v:b.v},{r:j.r,g:j.g,b:j.b},c,i)}}function i(b,c){return function(e){e=e||a.event;var g=d(e),h=c.offsetWidth,i=c.offsetHeight;b.s=g.x/h,b.v=(i-g.y)/i;var j=f(b);b.callback&&b.callback(j.hex,{h:b.h-s,s:b.s,v:b.v},{r:j.r,g:j.g,b:j.b},g)}}function j(a,b,c){if(!(this instanceof j))return new j(a,b,c);if(this.h=0,this.s=1,this.v=1,c)this.callback=c,this.pickerElement=b,this.slideElement=a;else{var d=a;d.innerHTML=u,this.slideElement=d.getElementsByClassName("slide")[0],this.pickerElement=d.getElementsByClassName("picker")[0];var e=d.getElementsByClassName("slide-indicator")[0],f=d.getElementsByClassName("picker-indicator")[0];j.fixIndicators(e,f),this.callback=function(a,c,d,g,h){j.positionIndicators(e,f,h,g),b(a,c,d)}}if("SVG"==r){var g=q.cloneNode(!0),l=p.cloneNode(!0),n=g.getElementById("gradient-hsv"),o=g.getElementsByTagName("rect")[0];n.id="gradient-hsv-"+v,o.setAttribute("fill","url(#"+n.id+")");var s=[l.getElementById("gradient-black"),l.getElementById("gradient-white")],t=l.getElementsByTagName("rect");s[0].id="gradient-black-"+v,s[1].id="gradient-white-"+v,t[0].setAttribute("fill","url(#"+s[1].id+")"),t[1].setAttribute("fill","url(#"+s[0].id+")"),this.slideElement.appendChild(g),this.pickerElement.appendChild(l),v++}else this.slideElement.innerHTML=q,this.pickerElement.innerHTML=p;k(this.slideElement,"click",h(this,this.slideElement,this.pickerElement)),k(this.pickerElement,"click",i(this,this.pickerElement)),m(this,this.slideElement,h(this,this.slideElement,this.pickerElement)),m(this,this.pickerElement,i(this,this.pickerElement))}function k(a,b,c){a.attachEvent?a.attachEvent("on"+b,c):a.addEventListener&&a.addEventListener(b,c,!1)}function l(a,b,c){a.attachEvent?a.detachEvent("on"+b,c):a.addEventListener&&a.removeEventListener(b,c,!1)}function m(a,b,c){var d=!1;k(b,"mousedown",function(a){d=!0}),k(b,"mouseup",function(a){d=!1}),k(b,"mouseout",function(a){d=!1}),k(b,"mousemove",function(a){d&&c(a)})}function n(a,b,c){l(b,"mousedown"),l(b,"mouseup"),l(b,"mouseout"),l(b,"mousemove")}function o(a,b,c,d){a.h=b.h%360,a.s=b.s,a.v=b.v;var e=f(a),g={y:a.h*a.slideElement.offsetHeight/360,x:0},h=a.pickerElement.offsetHeight,i={x:a.s*a.pickerElement.offsetWidth,y:h-a.v*h};return a.pickerElement.style.backgroundColor=f({h:a.h,s:1,v:1}).hex,a.callback&&a.callback(d||e.hex,{h:a.h,s:a.s,v:a.v},c||{r:e.r,g:e.g,b:e.b},i,g),a}var p,q,r=a.SVGAngle||b.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")?"SVG":"VML",s=15,t="http://www.w3.org/2000/svg",u=['<div class="picker-wrapper">','<div class="picker"></div>','<div class="picker-indicator"></div>',"</div>",'<div class="slide-wrapper">','<div class="slide"></div>','<div class="slide-indicator"></div>',"</div>"].join("");"SVG"==r?(q=e("svg",{xmlns:"http://www.w3.org/2000/svg",version:"1.1",width:"100%",height:"100%"},[e("defs",{},e("linearGradient",{id:"gradient-hsv",x1:"0%",y1:"100%",x2:"0%",y2:"0%"},[e("stop",{offset:"0%","stop-color":"#FF0000","stop-opacity":"1"}),e("stop",{offset:"13%","stop-color":"#FF00FF","stop-opacity":"1"}),e("stop",{offset:"25%","stop-color":"#8000FF","stop-opacity":"1"}),e("stop",{offset:"38%","stop-color":"#0040FF","stop-opacity":"1"}),e("stop",{offset:"50%","stop-color":"#00FFFF","stop-opacity":"1"}),e("stop",{offset:"63%","stop-color":"#00FF40","stop-opacity":"1"}),e("stop",{offset:"75%","stop-color":"#0BED00","stop-opacity":"1"}),e("stop",{offset:"88%","stop-color":"#FFFF00","stop-opacity":"1"}),e("stop",{offset:"100%","stop-color":"#FF0000","stop-opacity":"1"})])),e("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:"url(#gradient-hsv)"})]),p=e("svg",{xmlns:"http://www.w3.org/2000/svg",version:"1.1",width:"100%",height:"100%"},[e("defs",{},[e("linearGradient",{id:"gradient-black",x1:"0%",y1:"100%",x2:"0%",y2:"0%"},[e("stop",{offset:"0%","stop-color":"#000000","stop-opacity":"1"}),e("stop",{offset:"100%","stop-color":"#CC9A81","stop-opacity":"0"})]),e("linearGradient",{id:"gradient-white",x1:"0%",y1:"100%",x2:"100%",y2:"100%"},[e("stop",{offset:"0%","stop-color":"#FFFFFF","stop-opacity":"1"}),e("stop",{offset:"100%","stop-color":"#CC9A81","stop-opacity":"0"})])]),e("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:"url(#gradient-white)"}),e("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:"url(#gradient-black)"})])):"VML"==r&&(q=['<DIV style="position: relative; width: 100%; height: 100%">','<v:rect style="position: absolute; top: 0; left: 0; width: 100%; height: 100%" stroked="f" filled="t">','<v:fill type="gradient" method="none" angle="0" color="red" color2="red" colors="8519f fuchsia;.25 #8000ff;24903f #0040ff;.5 aqua;41287f #00ff40;.75 #0bed00;57671f yellow"></v:fill>',"</v:rect>","</DIV>"].join(""),p=['<DIV style="position: relative; width: 100%; height: 100%">','<v:rect style="position: absolute; left: -1px; top: -1px; width: 101%; height: 101%" stroked="f" filled="t">','<v:fill type="gradient" method="none" angle="270" color="#FFFFFF" opacity="100%" color2="#CC9A81" o:opacity2="0%"></v:fill>',"</v:rect>",'<v:rect style="position: absolute; left: 0px; top: 0px; width: 100%; height: 101%" stroked="f" filled="t">','<v:fill type="gradient" method="none" angle="0" color="#000000" opacity="100%" color2="#CC9A81" o:opacity2="0%"></v:fill>',"</v:rect>","</DIV>"].join(""),b.namespaces.v||b.namespaces.add("v","urn:schemas-microsoft-com:vml","#default#VML"));var v=0;j.hsv2rgb=function(a){var b=f(a);return delete b.hex,b},j.hsv2hex=function(a){return f(a).hex},j.rgb2hsv=g,j.rgb2hex=function(a){return f(g(a)).hex},j.hex2hsv=function(a){return g(j.hex2rgb(a))},j.hex2rgb=function(a){return{r:parseInt(a.substr(1,2),16),g:parseInt(a.substr(3,2),16),b:parseInt(a.substr(5,2),16)}},j.prototype.setHsv=function(a){return o(this,a)},j.prototype.setRgb=function(a){
return o(this,g(a),a)},j.prototype.setHex=function(a){return o(this,j.hex2hsv(a),c,a)},j.positionIndicators=function(a,b,c,d){c&&(b.style.left="auto",b.style.right="0px",b.style.top="0px",a.style.top=c.y-a.offsetHeight/2+"px"),d&&(b.style.top=d.y-b.offsetHeight/2+"px",b.style.left=d.x-b.offsetWidth/2+"px")},j.prototype.unBind=function(){l(this.slideElement,"click",h(this,this.slideElement,this.pickerElement)),l(this.pickerElement,"click",i(this,this.pickerElement)),n(this,this.slideElement,h(this,this.slideElement,this.pickerElement)),n(this,this.pickerElement,i(this,this.pickerElement))},j.fixIndicators=function(a,b){b.style.pointerEvents="none",a.style.pointerEvents="none"},a.ColorPicker=j}(window,window.document),function(a){"use strict";"function"==typeof define&&define.amd?define(["jquery","jquery.ui.widget"],a):a(window.jQuery)}(function(a){"use strict";a.support.xhrFileUpload=!(!window.XMLHttpRequestUpload||!window.FileReader),a.support.xhrFormDataFileUpload=!!window.FormData,a.widget("blueimp.fileupload",{options:{namespace:void 0,dropZone:a(document),fileInput:void 0,replaceFileInput:!0,paramName:void 0,singleFileUploads:!0,limitMultiFileUploads:void 0,sequentialUploads:!1,limitConcurrentUploads:void 0,forceIframeTransport:!1,redirect:void 0,redirectParamName:void 0,postMessage:void 0,multipart:!0,maxChunkSize:void 0,uploadedBytes:void 0,recalculateProgress:!0,progressInterval:100,bitrateInterval:500,formData:function(a){return a.serializeArray()},add:function(a,b){b.submit()},processData:!1,contentType:!1,cache:!1},_refreshOptionsList:["namespace","dropZone","fileInput","multipart","forceIframeTransport"],_BitrateTimer:function(){this.timestamp=+new Date,this.loaded=0,this.bitrate=0,this.getBitrate=function(a,b,c){var d=a-this.timestamp;return(!this.bitrate||!c||d>c)&&(this.bitrate=(b-this.loaded)*(1e3/d)*8,this.loaded=b,this.timestamp=a),this.bitrate}},_isXHRUpload:function(b){return!b.forceIframeTransport&&(!b.multipart&&a.support.xhrFileUpload||a.support.xhrFormDataFileUpload)},_getFormData:function(b){var c;return"function"==typeof b.formData?b.formData(b.form):a.isArray(b.formData)?b.formData:b.formData?(c=[],a.each(b.formData,function(a,b){c.push({name:a,value:b})}),c):[]},_getTotal:function(b){var c=0;return a.each(b,function(a,b){c+=b.size||1}),c},_onProgress:function(a,b){if(a.lengthComputable){var c,d,e=+new Date;if(b._time&&b.progressInterval&&e-b._time<b.progressInterval&&a.loaded!==a.total)return;b._time=e,c=b.total||this._getTotal(b.files),d=parseInt(a.loaded/a.total*(b.chunkSize||c),10)+(b.uploadedBytes||0),this._loaded+=d-(b.loaded||b.uploadedBytes||0),b.lengthComputable=!0,b.loaded=d,b.total=c,b.bitrate=b._bitrateTimer.getBitrate(e,d,b.bitrateInterval),this._trigger("progress",a,b),this._trigger("progressall",a,{lengthComputable:!0,loaded:this._loaded,total:this._total,bitrate:this._bitrateTimer.getBitrate(e,this._loaded,b.bitrateInterval)})}},_initProgressListener:function(b){var c=this,d=b.xhr?b.xhr():a.ajaxSettings.xhr();d.upload&&(a(d.upload).bind("progress",function(a){var d=a.originalEvent;a.lengthComputable=d.lengthComputable,a.loaded=d.loaded,a.total=d.total,c._onProgress(a,b)}),b.xhr=function(){return d})},_initXHRData:function(b){var c,d=b.files[0],e=b.multipart||!a.support.xhrFileUpload,f=b.paramName[0];(!e||b.blob)&&(b.headers=a.extend(b.headers,{"X-File-Name":d.name,"X-File-Type":d.type,"X-File-Size":d.size}),b.blob?e||(b.contentType="application/octet-stream",b.data=b.blob):(b.contentType=d.type,b.data=d)),e&&a.support.xhrFormDataFileUpload&&(b.postMessage?(c=this._getFormData(b),b.blob?c.push({name:f,value:b.blob}):a.each(b.files,function(a,d){c.push({name:b.paramName[a]||f,value:d})})):(b.formData instanceof FormData?c=b.formData:(c=new FormData,a.each(this._getFormData(b),function(a,b){c.append(b.name,b.value)})),b.blob?c.append(f,b.blob,d.name):a.each(b.files,function(a,d){d instanceof Blob&&c.append(b.paramName[a]||f,d,d.name)})),b.data=c),b.blob=null},_initIframeSettings:function(b){b.dataType="iframe "+(b.dataType||""),b.formData=this._getFormData(b),b.redirect&&a("<a></a>").prop("href",b.url).prop("host")!==location.host&&b.formData.push({name:b.redirectParamName||"redirect",value:b.redirect})},_initDataSettings:function(a){this._isXHRUpload(a)?(this._chunkedUpload(a,!0)||(a.data||this._initXHRData(a),this._initProgressListener(a)),a.postMessage&&(a.dataType="postmessage "+(a.dataType||""))):this._initIframeSettings(a,"iframe")},_getParamName:function(b){var c=a(b.fileInput),d=b.paramName;return d?a.isArray(d)||(d=[d]):(d=[],c.each(function(){for(var b=a(this),c=b.prop("name")||"files[]",e=(b.prop("files")||[1]).length;e;)d.push(c),e-=1}),d.length||(d=[c.prop("name")||"files[]"])),d},_initFormSettings:function(b){b.form&&b.form.length||(b.form=a(b.fileInput.prop("form"))),b.paramName=this._getParamName(b),b.url||(b.url=b.form.prop("action")||location.href),b.type=(b.type||b.form.prop("method")||"").toUpperCase(),"POST"!==b.type&&"PUT"!==b.type&&(b.type="POST"),b.formAcceptCharset||(b.formAcceptCharset=b.form.attr("accept-charset"))},_getAJAXSettings:function(b){var c=a.extend({},this.options,b);return this._initFormSettings(c),this._initDataSettings(c),c},_enhancePromise:function(a){return a.success=a.done,a.error=a.fail,a.complete=a.always,a},_getXHRPromise:function(b,c,d){var e=a.Deferred(),f=e.promise();return c=c||this.options.context||f,b===!0?e.resolveWith(c,d):b===!1&&e.rejectWith(c,d),f.abort=e.promise,this._enhancePromise(f)},_chunkedUpload:function(b,c){var d,e,f,g,h=this,i=b.files[0],j=i.size,k=b.uploadedBytes=b.uploadedBytes||0,l=b.maxChunkSize||j,m=i.webkitSlice||i.mozSlice||i.slice;return this._isXHRUpload(b)&&m&&(k||j>l)&&!b.data?c?!0:k>=j?(i.error="uploadedBytes",this._getXHRPromise(!1,b.context,[null,"error",i.error])):(e=Math.ceil((j-k)/l),d=function(c){return c?d(c-=1).pipe(function(){var d=a.extend({},b);return d.blob=m.call(i,k+c*l,k+(c+1)*l),d.chunkIndex=c,d.chunksNumber=e,d.chunkSize=d.blob.size,h._initXHRData(d),h._initProgressListener(d),f=(a.ajax(d)||h._getXHRPromise(!1,d.context)).done(function(){d.loaded||h._onProgress(a.Event("progress",{lengthComputable:!0,loaded:d.chunkSize,total:d.chunkSize}),d),b.uploadedBytes=d.uploadedBytes+=d.chunkSize})}):h._getXHRPromise(!0,b.context)},g=d(e),g.abort=function(){return f.abort()},this._enhancePromise(g)):!1},_beforeSend:function(a,b){0===this._active&&(this._trigger("start"),this._bitrateTimer=new this._BitrateTimer),this._active+=1,this._loaded+=b.uploadedBytes||0,this._total+=this._getTotal(b.files)},_onDone:function(b,c,d,e){this._isXHRUpload(e)||this._onProgress(a.Event("progress",{lengthComputable:!0,loaded:1,total:1}),e),e.result=b,e.textStatus=c,e.jqXHR=d,this._trigger("done",null,e)},_onFail:function(a,b,c,d){d.jqXHR=a,d.textStatus=b,d.errorThrown=c,this._trigger("fail",null,d),d.recalculateProgress&&(this._loaded-=d.loaded||d.uploadedBytes||0,this._total-=d.total||this._getTotal(d.files))},_onAlways:function(a,b,c,d){this._active-=1,d.textStatus=b,c&&c.always?(d.jqXHR=c,d.result=a):(d.jqXHR=a,d.errorThrown=c),this._trigger("always",null,d),0===this._active&&(this._trigger("stop"),this._loaded=this._total=0,this._bitrateTimer=null)},_onSend:function(b,c){var d,e,f,g=this,h=g._getAJAXSettings(c),i=function(c,e){return g._sending+=1,h._bitrateTimer=new g._BitrateTimer,d=d||(c!==!1&&g._trigger("send",b,h)!==!1&&(g._chunkedUpload(h)||a.ajax(h))||g._getXHRPromise(!1,h.context,e)).done(function(a,b,c){g._onDone(a,b,c,h)}).fail(function(a,b,c){g._onFail(a,b,c,h)}).always(function(a,b,c){if(g._sending-=1,g._onAlways(a,b,c,h),h.limitConcurrentUploads&&h.limitConcurrentUploads>g._sending)for(var d,e=g._slots.shift();e;){if(d=e.state?"pending"===e.state():!e.isRejected()){e.resolve();break}e=g._slots.shift()}})};return this._beforeSend(b,h),this.options.sequentialUploads||this.options.limitConcurrentUploads&&this.options.limitConcurrentUploads<=this._sending?(this.options.limitConcurrentUploads>1?(e=a.Deferred(),this._slots.push(e),f=e.pipe(i)):f=this._sequence=this._sequence.pipe(i,i),f.abort=function(){var a=[void 0,"abort","abort"];return d?d.abort():(e&&e.rejectWith(f,a),i(!1,a))},this._enhancePromise(f)):i()},_onAdd:function(b,c){var d,e,f,g,h=this,i=!0,j=a.extend({},this.options,c),k=j.limitMultiFileUploads,l=this._getParamName(j);if((j.singleFileUploads||k)&&this._isXHRUpload(j))if(!j.singleFileUploads&&k)for(f=[],d=[],g=0;g<c.files.length;g+=k)f.push(c.files.slice(g,g+k)),e=l.slice(g,g+k),e.length||(e=l),d.push(e);else d=l;else f=[c.files],d=[l];return c.originalFiles=c.files,a.each(f||c.files,function(e,g){var j=a.extend({},c);return j.files=f?g:[g],j.paramName=d[e],j.submit=function(){return j.jqXHR=this.jqXHR=h._trigger("submit",b,this)!==!1&&h._onSend(b,this),this.jqXHR},i=h._trigger("add",b,j)}),i},_replaceFileInput:function(b){var c=b.clone(!0);a("<form></form>").append(c)[0].reset(),b.after(c).detach(),a.cleanData(b.unbind("remove")),this.options.fileInput=this.options.fileInput.map(function(a,d){return d===b[0]?c[0]:d}),b[0]===this.element[0]&&(this.element=c)},_handleFileTreeEntry:function(b,c){var d,e=this,f=a.Deferred(),g=function(a){a&&!a.entry&&(a.entry=b),f.resolve([a])};return c=c||"",b.isFile?b._file?(b._file.relativePath=c,f.resolve(b._file)):b.file(function(a){a.relativePath=c,f.resolve(a)},g):b.isDirectory?(d=b.createReader(),d.readEntries(function(a){e._handleFileTreeEntries(a,c+b.name+"/").done(function(a){f.resolve(a)}).fail(g)},g)):f.resolve([]),f.promise()},_handleFileTreeEntries:function(b,c){var d=this;return a.when.apply(a,a.map(b,function(a){return d._handleFileTreeEntry(a,c)})).pipe(function(){return Array.prototype.concat.apply([],arguments)})},_getDroppedFiles:function(b){b=b||{};var c=b.items;return c&&c.length&&(c[0].webkitGetAsEntry||c[0].getAsEntry)?this._handleFileTreeEntries(a.map(c,function(a){var b;return a.webkitGetAsEntry?(b=a.webkitGetAsEntry(),b&&(b._file=a.getAsFile()),b):a.getAsEntry()})):a.Deferred().resolve(a.makeArray(b.files)).promise()},_getFileInputFiles:function(b){b=a(b);var c,d,e=b.prop("webkitEntries")||b.prop("entries");if(e&&e.length)return this._handleFileTreeEntries(e);if(c=a.makeArray(b.prop("files")),!c.length){if(d=b.prop("value"),!d)return a.Deferred().reject([]).promise();c=[{name:d.replace(/^.*\\/,"")}]}return a.Deferred().resolve(c).promise()},_onChange:function(b){var c=b.data.fileupload,d={fileInput:a(b.target),form:a(b.target.form)};c._getFileInputFiles(d.fileInput).always(function(a){d.files=a,c.options.replaceFileInput&&c._replaceFileInput(d.fileInput),c._trigger("change",b,d)!==!1&&c._onAdd(b,d)})},_onPaste:function(b){var c=b.data.fileupload,d=b.originalEvent.clipboardData,e=d&&d.items||[],f={files:[]};return a.each(e,function(a,b){var c=b.getAsFile&&b.getAsFile();c&&f.files.push(c)}),c._trigger("paste",b,f)===!1||c._onAdd(b,f)===!1?!1:void 0},_onDrop:function(a){a.preventDefault();var b=a.data.fileupload,c=a.dataTransfer=a.originalEvent.dataTransfer,d={};b._getDroppedFiles(c).always(function(c){d.files=c,b._trigger("drop",a,d)!==!1&&b._onAdd(a,d)})},_onDragOver:function(a){var b=a.data.fileupload,c=a.dataTransfer=a.originalEvent.dataTransfer;return b._trigger("dragover",a)===!1?!1:(c&&(c.dropEffect="copy"),void a.preventDefault())},_initEventHandlers:function(){var a=this.options.namespace;this._isXHRUpload(this.options)&&this.options.dropZone.bind("dragover."+a,{fileupload:this},this._onDragOver).bind("drop."+a,{fileupload:this},this._onDrop).bind("paste."+a,{fileupload:this},this._onPaste),this.options.fileInput.bind("change."+a,{fileupload:this},this._onChange)},_destroyEventHandlers:function(){var a=this.options.namespace;this.options.dropZone.unbind("dragover."+a,this._onDragOver).unbind("drop."+a,this._onDrop).unbind("paste."+a,this._onPaste),this.options.fileInput.unbind("change."+a,this._onChange)},_setOption:function(b,c){var d=-1!==a.inArray(b,this._refreshOptionsList);d&&this._destroyEventHandlers(),a.Widget.prototype._setOption.call(this,b,c),d&&(this._initSpecialOptions(),this._initEventHandlers())},_initSpecialOptions:function(){var b=this.options;void 0===b.fileInput?b.fileInput=this.element.is("input:file")?this.element:this.element.find("input:file"):b.fileInput instanceof a||(b.fileInput=a(b.fileInput)),b.dropZone instanceof a||(b.dropZone=a(b.dropZone))},_create:function(){var b=this.options;a.extend(b,a(this.element[0].cloneNode(!1)).data()),b.namespace=b.namespace||this.widgetName,this._initSpecialOptions(),this._slots=[],this._sequence=this._getXHRPromise(!0),this._sending=this._active=this._loaded=this._total=0,this._initEventHandlers()},destroy:function(){this._destroyEventHandlers(),a.Widget.prototype.destroy.call(this)},enable:function(){a.Widget.prototype.enable.call(this),this._initEventHandlers()},disable:function(){this._destroyEventHandlers(),a.Widget.prototype.disable.call(this)},add:function(b){var c=this;b&&!this.options.disabled&&(b.fileInput&&!b.files?this._getFileInputFiles(b.fileInput).always(function(a){b.files=a,c._onAdd(null,b)}):(b.files=a.makeArray(b.files),this._onAdd(null,b)))},send:function(b){if(b&&!this.options.disabled){if(b.fileInput&&!b.files){var c,d,e=this,f=a.Deferred(),g=f.promise();return g.abort=function(){return d=!0,c?c.abort():(f.reject(null,"abort","abort"),g)},this._getFileInputFiles(b.fileInput).always(function(a){d||(b.files=a,c=e._onSend(null,b).then(function(a,b,c){f.resolve(a,b,c)},function(a,b,c){f.reject(a,b,c)}))}),this._enhancePromise(g)}if(b.files=a.makeArray(b.files),b.files.length)return this._onSend(null,b)}return this._getXHRPromise(!1,b&&b.context)}})}),function(a){"use strict";"function"==typeof define&&define.amd?define(["jquery","load-image","canvas-to-blob","./jquery.fileupload"],a):a(window.jQuery,window.loadImage)}(function(a,b){"use strict";a.widget("blueimpFP.fileupload",a.blueimp.fileupload,{options:{process:[],add:function(b,c){a(this).fileupload("process",c).done(function(){c.submit()})}},processActions:{load:function(c,d){var e=this,f=c.files[c.index],g=a.Deferred();return window.HTMLCanvasElement&&window.HTMLCanvasElement.prototype.toBlob&&("number"!==a.type(d.maxFileSize)||f.size<d.maxFileSize)&&(!d.fileTypes||d.fileTypes.test(f.type))?b(f,function(a){c.canvas=a,g.resolveWith(e,[c])},{canvas:!0}):g.rejectWith(e,[c]),g.promise()},resize:function(a,c){if(a.canvas){var d=b.scale(a.canvas,c);(d.width!==a.canvas.width||d.height!==a.canvas.height)&&(a.canvas=d,a.processed=!0)}return a},save:function(b,c){if(!b.canvas||!b.processed)return b;var d=this,e=b.files[b.index],f=e.name,g=a.Deferred(),h=function(a){a.name||(e.type===a.type?a.name=e.name:e.name&&(a.name=e.name.replace(/\..+$/,"."+a.type.substr(6)))),b.files[b.index]=a,g.resolveWith(d,[b])};return b.canvas.mozGetAsFile?h(b.canvas.mozGetAsFile(/^image\/(jpeg|png)$/.test(e.type)&&f||(f&&f.replace(/\..+$/,"")||"blob")+".png",e.type)):b.canvas.toBlob(h,e.type),g.promise()}},_processFile:function(b,c,d){var e=this,f=a.Deferred().resolveWith(e,[{files:b,index:c}]),g=f.promise();return e._processing+=1,a.each(d.process,function(a,b){g=g.pipe(function(a){return e.processActions[b.action].call(this,a,b)})}),g.always(function(){e._processing-=1,0===e._processing&&e.element.removeClass("fileupload-processing")}),1===e._processing&&e.element.addClass("fileupload-processing"),g},process:function(b){var c=this,d=a.extend({},this.options,b);return d.process&&d.process.length&&this._isXHRUpload(d)&&a.each(b.files,function(e,f){c._processingQueue=c._processingQueue.pipe(function(){var f=a.Deferred();return c._processFile(b.files,e,d).always(function(){f.resolveWith(c)}),f.promise()})}),this._processingQueue},_create:function(){a.blueimp.fileupload.prototype._create.call(this),this._processing=0,this._processingQueue=a.Deferred().resolveWith(this).promise()}})}),function(a){"use strict";"function"==typeof define&&define.amd?define(["jquery","tmpl","load-image","./jquery.fileupload-fp"],a):a(window.jQuery,window.tmpl,window.loadImage)}(function(a,b,c){"use strict";var d=(a.blueimpFP||a.blueimp).fileupload;a.widget("blueimpUI.fileupload",d,{options:{autoUpload:!1,maxNumberOfFiles:void 0,maxFileSize:void 0,minFileSize:void 0,acceptFileTypes:/.+$/i,previewSourceFileTypes:/^image\/(gif|jpeg|png)$/,previewSourceMaxFileSize:5e6,previewMaxWidth:80,previewMaxHeight:80,previewAsCanvas:!0,uploadTemplateId:"template-upload",downloadTemplateId:"template-download",filesContainer:void 0,prependFiles:!1,dataType:"json",add:function(b,c){var d=a(this).data("fileupload"),e=d.options,f=c.files;a(this).fileupload("process",c).done(function(){d._adjustMaxNumberOfFiles(-f.length),c.maxNumberOfFilesAdjusted=!0,c.files.valid=c.isValidated=d._validate(f),c.context=d._renderUpload(f).data("data",c),e.filesContainer[e.prependFiles?"prepend":"append"](c.context),d._renderPreviews(f,c.context),d._forceReflow(c.context),d._transition(c.context).done(function(){d._trigger("added",b,c)!==!1&&(e.autoUpload||c.autoUpload)&&c.autoUpload!==!1&&c.isValidated&&c.submit()})})},send:function(b,c){var d=a(this).data("fileupload");return c.isValidated||(c.maxNumberOfFilesAdjusted||(d._adjustMaxNumberOfFiles(-c.files.length),c.maxNumberOfFilesAdjusted=!0),d._validate(c.files))?(c.context&&c.dataType&&"iframe"===c.dataType.substr(0,6)&&c.context.find(".progress").addClass(!a.support.transition&&"progress-animated").attr("aria-valuenow",100).find(".bar").css("width","100%"),d._trigger("sent",b,c)):!1},done:function(b,c){var d,e=a(this).data("fileupload");c.context?c.context.each(function(f){var g=a.isArray(c.result)&&c.result[f]||{error:"emptyResult"};g.error&&e._adjustMaxNumberOfFiles(1),e._transition(a(this)).done(function(){var f=a(this);d=e._renderDownload([g]).replaceAll(f),e._forceReflow(d),e._transition(d).done(function(){c.context=a(this),e._trigger("completed",b,c)})})}):(a.isArray(c.result)&&(a.each(c.result,function(a,b){c.maxNumberOfFilesAdjusted&&b.error?e._adjustMaxNumberOfFiles(1):c.maxNumberOfFilesAdjusted||b.error||e._adjustMaxNumberOfFiles(-1)}),c.maxNumberOfFilesAdjusted=!0),d=e._renderDownload(c.result).appendTo(e.options.filesContainer),e._forceReflow(d),e._transition(d).done(function(){c.context=a(this),e._trigger("completed",b,c)}))},fail:function(b,c){var d,e=a(this).data("fileupload");c.maxNumberOfFilesAdjusted&&e._adjustMaxNumberOfFiles(c.files.length),c.context?c.context.each(function(f){if("abort"!==c.errorThrown){var g=c.files[f];g.error=g.error||c.errorThrown||!0,e._transition(a(this)).done(function(){var f=a(this);d=e._renderDownload([g]).replaceAll(f),e._forceReflow(d),e._transition(d).done(function(){c.context=a(this),e._trigger("failed",b,c)})})}else e._transition(a(this)).done(function(){a(this).remove(),e._trigger("failed",b,c)})}):"abort"!==c.errorThrown?(c.context=e._renderUpload(c.files).appendTo(e.options.filesContainer).data("data",c),e._forceReflow(c.context),e._transition(c.context).done(function(){c.context=a(this),e._trigger("failed",b,c)})):e._trigger("failed",b,c)},progress:function(a,b){if(b.context){var c=parseInt(b.loaded/b.total*100,10);b.context.find(".progress").attr("aria-valuenow",c).find(".bar").css("width",c+"%")}},progressall:function(b,c){var d=a(this),e=parseInt(c.loaded/c.total*100,10),f=d.find(".fileupload-progress"),g=f.find(".progress-extended");g.length&&g.html(d.data("fileupload")._renderExtendedProgress(c)),f.find(".progress").attr("aria-valuenow",e).find(".bar").css("width",e+"%")},start:function(b){var c=a(this).data("fileupload");c._transition(a(this).find(".fileupload-progress")).done(function(){c._trigger("started",b)})},stop:function(b){var c=a(this).data("fileupload");c._transition(a(this).find(".fileupload-progress")).done(function(){a(this).find(".progress").attr("aria-valuenow","0").find(".bar").css("width","0%"),a(this).find(".progress-extended").html("&nbsp;"),c._trigger("stopped",b)})},destroy:function(b,c){var d=a(this).data("fileupload");c.url&&(a.ajax(c),d._adjustMaxNumberOfFiles(1)),d._transition(c.context).done(function(){a(this).remove(),d._trigger("destroyed",b,c)})}},_enableDragToDesktop:function(){var b=a(this),c=b.prop("href"),d=b.prop("download"),e="application/octet-stream";b.bind("dragstart",function(a){try{a.originalEvent.dataTransfer.setData("DownloadURL",[e,d,c].join(":"))}catch(b){}})},_adjustMaxNumberOfFiles:function(a){"number"==typeof this.options.maxNumberOfFiles&&(this.options.maxNumberOfFiles+=a,this.options.maxNumberOfFiles<1?this._disableFileInputButton():this._enableFileInputButton())},_formatFileSize:function(a){return"number"!=typeof a?"":a>=1e9?(a/1e9).toFixed(2)+" GB":a>=1e6?(a/1e6).toFixed(2)+" MB":(a/1e3).toFixed(2)+" KB"},_formatBitrate:function(a){return"number"!=typeof a?"":a>=1e9?(a/1e9).toFixed(2)+" Gbit/s":a>=1e6?(a/1e6).toFixed(2)+" Mbit/s":a>=1e3?(a/1e3).toFixed(2)+" kbit/s":a+" bit/s"},_formatTime:function(a){var b=new Date(1e3*a),c=parseInt(a/86400,10);return c=c?c+"d ":"",c+("0"+b.getUTCHours()).slice(-2)+":"+("0"+b.getUTCMinutes()).slice(-2)+":"+("0"+b.getUTCSeconds()).slice(-2)},_formatPercentage:function(a){return(100*a).toFixed(2)+" %"},_renderExtendedProgress:function(a){return this._formatBitrate(a.bitrate)+" | "+this._formatTime(8*(a.total-a.loaded)/a.bitrate)+" | "+this._formatPercentage(a.loaded/a.total)+" | "+this._formatFileSize(a.loaded)+" / "+this._formatFileSize(a.total)},_hasError:function(a){return a.error?a.error:this.options.maxNumberOfFiles<0?"maxNumberOfFiles":this.options.acceptFileTypes.test(a.type)||this.options.acceptFileTypes.test(a.name)?this.options.maxFileSize&&a.size>this.options.maxFileSize?"maxFileSize":"number"==typeof a.size&&a.size<this.options.minFileSize?"minFileSize":null:"acceptFileTypes"},_validate:function(b){var c=this,d=!!b.length;return a.each(b,function(a,b){b.error=c._hasError(b),b.error&&(d=!1)}),d},_renderTemplate:function(b,c){if(!b)return a();var d=b({files:c,formatFileSize:this._formatFileSize,options:this.options});return d instanceof a?d:a(this.options.templatesContainer).html(d).children()},_renderPreview:function(b,d){var e=this,f=this.options,g=a.Deferred();return(c&&c(b,function(b){d.append(b),e._forceReflow(d),e._transition(d).done(function(){g.resolveWith(d)}),a.contains(document.body,d[0])||g.resolveWith(d)},{maxWidth:f.previewMaxWidth,maxHeight:f.previewMaxHeight,canvas:f.previewAsCanvas})||g.resolveWith(d))&&g},_renderPreviews:function(b,c){var d=this,e=this.options;return c.find(".preview span").each(function(c,f){var g=b[c];e.previewSourceFileTypes.test(g.type)&&("number"!==a.type(e.previewSourceMaxFileSize)||g.size<e.previewSourceMaxFileSize)&&(d._processingQueue=d._processingQueue.pipe(function(){var b=a.Deferred();return d._renderPreview(g,a(f)).done(function(){b.resolveWith(d)}),b.promise()}))}),this._processingQueue},_renderUpload:function(a){return this._renderTemplate(this.options.uploadTemplate,a)},_renderDownload:function(a){return this._renderTemplate(this.options.downloadTemplate,a).find("a[download]").each(this._enableDragToDesktop).end()},_startHandler:function(b){b.preventDefault();var c=a(this),d=c.closest(".template-upload"),e=d.data("data");e&&e.submit&&!e.jqXHR&&e.submit()&&c.prop("disabled",!0)},_cancelHandler:function(b){b.preventDefault();var c=a(this).closest(".template-upload"),d=c.data("data")||{};d.jqXHR?d.jqXHR.abort():(d.errorThrown="abort",b.data.fileupload._trigger("fail",b,d))},_deleteHandler:function(b){b.preventDefault();var c=a(this);b.data.fileupload._trigger("destroy",b,{context:c.closest(".template-download"),url:c.attr("data-url"),type:c.attr("data-type")||"DELETE",dataType:b.data.fileupload.options.dataType})},_forceReflow:function(b){return a.support.transition&&b.length&&b[0].offsetWidth},_transition:function(b){var c=a.Deferred();return a.support.transition&&b.hasClass("fade")?b.bind(a.support.transition.end,function(d){d.target===b[0]&&(b.unbind(a.support.transition.end),c.resolveWith(b))}).toggleClass("in"):(b.toggleClass("in"),c.resolveWith(b)),c},_initButtonBarEventHandlers:function(){var b=this.element.find(".fileupload-buttonbar"),c=this.options.filesContainer,d=this.options.namespace;b.find(".start").bind("click."+d,function(a){a.preventDefault(),c.find(".start button").click()}),b.find(".cancel").bind("click."+d,function(a){a.preventDefault(),c.find(".cancel button").click()}),b.find(".delete").bind("click."+d,function(a){a.preventDefault(),c.find(".delete input:checked").siblings("button").click(),b.find(".toggle").prop("checked",!1)}),b.find(".toggle").bind("change."+d,function(b){c.find(".delete input").prop("checked",a(this).is(":checked"))})},_destroyButtonBarEventHandlers:function(){this.element.find(".fileupload-buttonbar button").unbind("click."+this.options.namespace),this.element.find(".fileupload-buttonbar .toggle").unbind("change."+this.options.namespace)},_initEventHandlers:function(){d.prototype._initEventHandlers.call(this);var a={fileupload:this};this.options.filesContainer.delegate(".start button","click."+this.options.namespace,a,this._startHandler).delegate(".cancel button","click."+this.options.namespace,a,this._cancelHandler).delegate(".delete button","click."+this.options.namespace,a,this._deleteHandler),this._initButtonBarEventHandlers()},_destroyEventHandlers:function(){var a=this.options;this._destroyButtonBarEventHandlers(),a.filesContainer.undelegate(".start button","click."+a.namespace).undelegate(".cancel button","click."+a.namespace).undelegate(".delete button","click."+a.namespace),d.prototype._destroyEventHandlers.call(this)},_enableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!1).parent().removeClass("disabled")},_disableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!0).parent().addClass("disabled")},_initTemplates:function(){var a=this.options;a.templatesContainer=document.createElement(a.filesContainer.prop("nodeName")),b&&(a.uploadTemplateId&&(a.uploadTemplate=b(a.uploadTemplateId)),a.downloadTemplateId&&(a.downloadTemplate=b(a.downloadTemplateId)))},_initFilesContainer:function(){var b=this.options;void 0===b.filesContainer?b.filesContainer=this.element.find(".files"):b.filesContainer instanceof a||(b.filesContainer=a(b.filesContainer))},_stringToRegExp:function(a){var b=a.split("/"),c=b.pop();return b.shift(),new RegExp(b.join("/"),c)},_initRegExpOptions:function(){var b=this.options;"string"===a.type(b.acceptFileTypes)&&(b.acceptFileTypes=this._stringToRegExp(b.acceptFileTypes)),"string"===a.type(b.previewSourceFileTypes)&&(b.previewSourceFileTypes=this._stringToRegExp(b.previewSourceFileTypes))},_initSpecialOptions:function(){d.prototype._initSpecialOptions.call(this),this._initFilesContainer(),this._initTemplates(),this._initRegExpOptions()},_create:function(){d.prototype._create.call(this),this._refreshOptionsList.push("filesContainer","uploadTemplateId","downloadTemplateId"),a.blueimpFP||(this._processingQueue=a.Deferred().resolveWith(this).promise(),this.process=function(){return this._processingQueue})},enable:function(){d.prototype.enable.call(this),this.element.find("input, button").prop("disabled",!1),this._enableFileInputButton()},disable:function(){this.element.find("input, button").prop("disabled",!0),this._disableFileInputButton(),d.prototype.disable.call(this)}})}),function(a,b,c){L.drawVersion="0.2.3",L.drawLocal={draw:{toolbar:{actions:{title:"Cancel drawing",text:"Cancel"},undo:{title:"Delete last point drawn",text:"Delete last point"},buttons:{polyline:"Draw a polyline",polygon:"Draw a polygon",rectangle:"Draw a rectangle",circle:"Draw a circle",marker:"Draw a marker"}},handlers:{circle:{tooltip:{start:"Click and drag to draw circle."}},marker:{tooltip:{start:"Click map to place marker."}},polygon:{tooltip:{start:"Click to start drawing shape.",cont:"Click to continue drawing shape.",end:"Click first point to close this shape."}},polyline:{error:"<strong>Error:</strong> shape edges cannot cross!",tooltip:{start:"Click to start drawing line.",cont:"Click to continue drawing line.",end:"Click last point to finish line."}},rectangle:{tooltip:{start:"Click and drag to draw rectangle."}},simpleshape:{tooltip:{end:"Release mouse to finish drawing."}}}},edit:{toolbar:{actions:{save:{title:"Save changes.",text:"Save"},cancel:{title:"Cancel editing, discards all changes.",text:"Cancel"}},buttons:{edit:"Edit layers.",editDisabled:"No layers to edit.",remove:"Delete layers.",removeDisabled:"No layers to delete."}},handlers:{edit:{tooltip:{text:"Drag handles, or marker to edit feature.",subtext:"Click cancel to undo changes."}},remove:{tooltip:{text:"Click on a feature to remove"}}}}},L.Draw={},L.Draw.Feature=L.Handler.extend({includes:L.Mixin.Events,initialize:function(a,b){this._map=a,this._container=a._container,this._overlayPane=a._panes.overlayPane,this._popupPane=a._panes.popupPane,b&&b.shapeOptions&&(b.shapeOptions=L.Util.extend({},this.options.shapeOptions,b.shapeOptions)),L.setOptions(this,b)},enable:function(){this._enabled||(this.fire("enabled",{handler:this.type}),this._map.fire("draw:drawstart",{layerType:this.type}),L.Handler.prototype.enable.call(this))},disable:function(){this._enabled&&(L.Handler.prototype.disable.call(this),this._map.fire("draw:drawstop",{layerType:this.type}),this.fire("disabled",{handler:this.type}))},addHooks:function(){var a=this._map;a&&(L.DomUtil.disableTextSelection(),a.getContainer().focus(),this._tooltip=new L.Tooltip(this._map),L.DomEvent.on(this._container,"keyup",this._cancelDrawing,this))},removeHooks:function(){this._map&&(L.DomUtil.enableTextSelection(),this._tooltip.dispose(),this._tooltip=null,L.DomEvent.off(this._container,"keyup",this._cancelDrawing,this))},setOptions:function(a){L.setOptions(this,a)},_fireCreatedEvent:function(a){this._map.fire("draw:created",{layer:a,layerType:this.type})},_cancelDrawing:function(a){27===a.keyCode&&this.disable()}}),L.Draw.Polyline=L.Draw.Feature.extend({statics:{TYPE:"polyline"},Poly:L.Polyline,options:{allowIntersection:!0,repeatMode:!1,drawError:{color:"#b00b00",timeout:2500},icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"}),guidelineDistance:20,maxGuideLineLength:4e3,shapeOptions:{stroke:!0,color:"#f06eaa",weight:4,opacity:.5,fill:!1,clickable:!0},metric:!0,showLength:!0,zIndexOffset:2e3},initialize:function(a,b){this.options.drawError.message=L.drawLocal.draw.handlers.polyline.error,b&&b.drawError&&(b.drawError=L.Util.extend({},this.options.drawError,b.drawError)),this.type=L.Draw.Polyline.TYPE,L.Draw.Feature.prototype.initialize.call(this,a,b)},addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this),this._map&&(this._markers=[],this._markerGroup=new L.LayerGroup,this._map.addLayer(this._markerGroup),this._poly=new L.Polyline([],this.options.shapeOptions),this._tooltip.updateContent(this._getTooltipText()),this._mouseMarker||(this._mouseMarker=L.marker(this._map.getCenter(),{icon:L.divIcon({className:"leaflet-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})),this._mouseMarker.on("mousedown",this._onMouseDown,this).addTo(this._map),this._map.on("mousemove",this._onMouseMove,this).on("mouseup",this._onMouseUp,this).on("zoomend",this._onZoomEnd,this))},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this),this._clearHideErrorTimeout(),this._cleanUpShape(),this._map.removeLayer(this._markerGroup),delete this._markerGroup,delete this._markers,this._map.removeLayer(this._poly),delete this._poly,this._mouseMarker.off("mousedown",this._onMouseDown,this).off("mouseup",this._onMouseUp,this),this._map.removeLayer(this._mouseMarker),delete this._mouseMarker,this._clearGuides(),this._map.off("mousemove",this._onMouseMove,this).off("zoomend",this._onZoomEnd,this)},deleteLastVertex:function(){if(!(this._markers.length<=1)){var a=this._markers.pop(),b=this._poly,c=this._poly.spliceLatLngs(b.getLatLngs().length-1,1)[0];this._markerGroup.removeLayer(a),b.getLatLngs().length<2&&this._map.removeLayer(b),this._vertexChanged(c,!1)}},addVertex:function(a){
var b=this._markers.length;return b>0&&!this.options.allowIntersection&&this._poly.newLatLngIntersects(a)?void this._showErrorTooltip():(this._errorShown&&this._hideErrorTooltip(),this._markers.push(this._createMarker(a)),this._poly.addLatLng(a),2===this._poly.getLatLngs().length&&this._map.addLayer(this._poly),void this._vertexChanged(a,!0))},_finishShape:function(){var a=this._poly.newLatLngIntersects(this._poly.getLatLngs()[0],!0);return!this.options.allowIntersection&&a||!this._shapeIsValid()?void this._showErrorTooltip():(this._fireCreatedEvent(),this.disable(),void(this.options.repeatMode&&this.enable()))},_shapeIsValid:function(){return!0},_onZoomEnd:function(){this._updateGuide()},_onMouseMove:function(a){var b=a.layerPoint,c=a.latlng;this._currentLatLng=c,this._updateTooltip(c),this._updateGuide(b),this._mouseMarker.setLatLng(c),L.DomEvent.preventDefault(a.originalEvent)},_vertexChanged:function(a,b){this._updateFinishHandler(),this._updateRunningMeasure(a,b),this._clearGuides(),this._updateTooltip()},_onMouseDown:function(a){var b=a.originalEvent;this._mouseDownOrigin=L.point(b.clientX,b.clientY)},_onMouseUp:function(b){if(this._mouseDownOrigin){var c=L.point(b.originalEvent.clientX,b.originalEvent.clientY).distanceTo(this._mouseDownOrigin);Math.abs(c)<9*(a.devicePixelRatio||1)&&this.addVertex(b.latlng)}this._mouseDownOrigin=null},_updateFinishHandler:function(){var a=this._markers.length;a>1&&this._markers[a-1].on("click",this._finishShape,this),a>2&&this._markers[a-2].off("click",this._finishShape,this)},_createMarker:function(a){var b=new L.Marker(a,{icon:this.options.icon,zIndexOffset:2*this.options.zIndexOffset});return this._markerGroup.addLayer(b),b},_updateGuide:function(a){var b=this._markers.length;b>0&&(a=a||this._map.latLngToLayerPoint(this._currentLatLng),this._clearGuides(),this._drawGuide(this._map.latLngToLayerPoint(this._markers[b-1].getLatLng()),a))},_updateTooltip:function(a){var b=this._getTooltipText();a&&this._tooltip.updatePosition(a),this._errorShown||this._tooltip.updateContent(b)},_drawGuide:function(a,b){var c,d,e,f=Math.floor(Math.sqrt(Math.pow(b.x-a.x,2)+Math.pow(b.y-a.y,2))),g=this.options.guidelineDistance,h=this.options.maxGuideLineLength,i=f>h?f-h:g;for(this._guidesContainer||(this._guidesContainer=L.DomUtil.create("div","leaflet-draw-guides",this._overlayPane));f>i;i+=this.options.guidelineDistance)c=i/f,d={x:Math.floor(a.x*(1-c)+c*b.x),y:Math.floor(a.y*(1-c)+c*b.y)},e=L.DomUtil.create("div","leaflet-draw-guide-dash",this._guidesContainer),e.style.backgroundColor=this._errorShown?this.options.drawError.color:this.options.shapeOptions.color,L.DomUtil.setPosition(e,d)},_updateGuideColor:function(a){if(this._guidesContainer)for(var b=0,c=this._guidesContainer.childNodes.length;c>b;b++)this._guidesContainer.childNodes[b].style.backgroundColor=a},_clearGuides:function(){if(this._guidesContainer)for(;this._guidesContainer.firstChild;)this._guidesContainer.removeChild(this._guidesContainer.firstChild)},_getTooltipText:function(){var a,b,c=this.options.showLength;return 0===this._markers.length?a={text:L.drawLocal.draw.handlers.polyline.tooltip.start}:(b=c?this._getMeasurementString():"",a=1===this._markers.length?{text:L.drawLocal.draw.handlers.polyline.tooltip.cont,subtext:b}:{text:L.drawLocal.draw.handlers.polyline.tooltip.end,subtext:b}),a},_updateRunningMeasure:function(a,b){var c,d,e=this._markers.length;1===this._markers.length?this._measurementRunningTotal=0:(c=e-(b?2:1),d=a.distanceTo(this._markers[c].getLatLng()),this._measurementRunningTotal+=d*(b?1:-1))},_getMeasurementString:function(){var a,b=this._currentLatLng,c=this._markers[this._markers.length-1].getLatLng();return a=this._measurementRunningTotal+b.distanceTo(c),L.GeometryUtil.readableDistance(a,this.options.metric)},_showErrorTooltip:function(){this._errorShown=!0,this._tooltip.showAsError().updateContent({text:this.options.drawError.message}),this._updateGuideColor(this.options.drawError.color),this._poly.setStyle({color:this.options.drawError.color}),this._clearHideErrorTimeout(),this._hideErrorTimeout=setTimeout(L.Util.bind(this._hideErrorTooltip,this),this.options.drawError.timeout)},_hideErrorTooltip:function(){this._errorShown=!1,this._clearHideErrorTimeout(),this._tooltip.removeError().updateContent(this._getTooltipText()),this._updateGuideColor(this.options.shapeOptions.color),this._poly.setStyle({color:this.options.shapeOptions.color})},_clearHideErrorTimeout:function(){this._hideErrorTimeout&&(clearTimeout(this._hideErrorTimeout),this._hideErrorTimeout=null)},_cleanUpShape:function(){this._markers.length>1&&this._markers[this._markers.length-1].off("click",this._finishShape,this)},_fireCreatedEvent:function(){var a=new this.Poly(this._poly.getLatLngs(),this.options.shapeOptions);L.Draw.Feature.prototype._fireCreatedEvent.call(this,a)}}),L.Draw.Polygon=L.Draw.Polyline.extend({statics:{TYPE:"polygon"},Poly:L.Polygon,options:{showArea:!1,shapeOptions:{stroke:!0,color:"#f06eaa",weight:4,opacity:.5,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0}},initialize:function(a,b){L.Draw.Polyline.prototype.initialize.call(this,a,b),this.type=L.Draw.Polygon.TYPE},_updateFinishHandler:function(){var a=this._markers.length;1===a&&this._markers[0].on("click",this._finishShape,this),a>2&&(this._markers[a-1].on("dblclick",this._finishShape,this),a>3&&this._markers[a-2].off("dblclick",this._finishShape,this))},_getTooltipText:function(){var a,b;return 0===this._markers.length?a=L.drawLocal.draw.handlers.polygon.tooltip.start:this._markers.length<3?a=L.drawLocal.draw.handlers.polygon.tooltip.cont:(a=L.drawLocal.draw.handlers.polygon.tooltip.end,b=this._getMeasurementString()),{text:a,subtext:b}},_getMeasurementString:function(){var a=this._area;return a?L.GeometryUtil.readableArea(a,this.options.metric):null},_shapeIsValid:function(){return this._markers.length>=3},_vertexAdded:function(){if(!this.options.allowIntersection&&this.options.showArea){var a=this._poly.getLatLngs();this._area=L.GeometryUtil.geodesicArea(a)}},_cleanUpShape:function(){var a=this._markers.length;a>0&&(this._markers[0].off("click",this._finishShape,this),a>2&&this._markers[a-1].off("dblclick",this._finishShape,this))}}),L.SimpleShape={},L.Draw.SimpleShape=L.Draw.Feature.extend({options:{repeatMode:!1},initialize:function(a,b){this._endLabelText=L.drawLocal.draw.handlers.simpleshape.tooltip.end,L.Draw.Feature.prototype.initialize.call(this,a,b)},addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this),this._map&&(this._mapDraggable=this._map.dragging.enabled(),this._mapDraggable&&this._map.dragging.disable(),this._container.style.cursor="crosshair",this._tooltip.updateContent({text:this._initialLabelText}),this._map.on("mousedown",this._onMouseDown,this).on("mousemove",this._onMouseMove,this))},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this),this._map&&(this._mapDraggable&&this._map.dragging.enable(),this._container.style.cursor="",this._map.off("mousedown",this._onMouseDown,this).off("mousemove",this._onMouseMove,this),L.DomEvent.off(b,"mouseup",this._onMouseUp,this),this._shape&&(this._map.removeLayer(this._shape),delete this._shape)),this._isDrawing=!1},_onMouseDown:function(a){this._isDrawing=!0,this._startLatLng=a.latlng,L.DomEvent.on(b,"mouseup",this._onMouseUp,this).preventDefault(a.originalEvent)},_onMouseMove:function(a){var b=a.latlng;this._tooltip.updatePosition(b),this._isDrawing&&(this._tooltip.updateContent({text:this._endLabelText}),this._drawShape(b))},_onMouseUp:function(){this._shape&&this._fireCreatedEvent(),this.disable(),this.options.repeatMode&&this.enable()}}),L.Draw.Rectangle=L.Draw.SimpleShape.extend({statics:{TYPE:"rectangle"},options:{shapeOptions:{stroke:!0,color:"#f06eaa",weight:4,opacity:.5,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0}},initialize:function(a,b){this.type=L.Draw.Rectangle.TYPE,this._initialLabelText=L.drawLocal.draw.handlers.rectangle.tooltip.start,L.Draw.SimpleShape.prototype.initialize.call(this,a,b)},_drawShape:function(a){this._shape?this._shape.setBounds(new L.LatLngBounds(this._startLatLng,a)):(this._shape=new L.Rectangle(new L.LatLngBounds(this._startLatLng,a),this.options.shapeOptions),this._map.addLayer(this._shape))},_fireCreatedEvent:function(){var a=new L.Rectangle(this._shape.getBounds(),this.options.shapeOptions);L.Draw.SimpleShape.prototype._fireCreatedEvent.call(this,a)}}),L.Draw.Circle=L.Draw.SimpleShape.extend({statics:{TYPE:"circle"},options:{shapeOptions:{stroke:!0,color:"#f06eaa",weight:4,opacity:.5,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0},showRadius:!0,metric:!0},initialize:function(a,b){this.type=L.Draw.Circle.TYPE,this._initialLabelText=L.drawLocal.draw.handlers.circle.tooltip.start,L.Draw.SimpleShape.prototype.initialize.call(this,a,b)},_drawShape:function(a){this._shape?this._shape.setRadius(this._startLatLng.distanceTo(a)):(this._shape=new L.Circle(this._startLatLng,this._startLatLng.distanceTo(a),this.options.shapeOptions),this._map.addLayer(this._shape))},_fireCreatedEvent:function(){var a=new L.Circle(this._startLatLng,this._shape.getRadius(),this.options.shapeOptions);L.Draw.SimpleShape.prototype._fireCreatedEvent.call(this,a)},_onMouseMove:function(a){var b,c=a.latlng,d=this.options.showRadius,e=this.options.metric;this._tooltip.updatePosition(c),this._isDrawing&&(this._drawShape(c),b=this._shape.getRadius().toFixed(1),this._tooltip.updateContent({text:this._endLabelText,subtext:d?"Radius: "+L.GeometryUtil.readableDistance(b,e):""}))}}),L.Draw.Marker=L.Draw.Feature.extend({statics:{TYPE:"marker"},options:{icon:new L.Icon.Default,repeatMode:!1,zIndexOffset:2e3},initialize:function(a,b){this.type=L.Draw.Marker.TYPE,L.Draw.Feature.prototype.initialize.call(this,a,b)},addHooks:function(){L.Draw.Feature.prototype.addHooks.call(this),this._map&&(this._tooltip.updateContent({text:L.drawLocal.draw.handlers.marker.tooltip.start}),this._mouseMarker||(this._mouseMarker=L.marker(this._map.getCenter(),{icon:L.divIcon({className:"leaflet-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})),this._mouseMarker.on("click",this._onClick,this).addTo(this._map),this._map.on("mousemove",this._onMouseMove,this))},removeHooks:function(){L.Draw.Feature.prototype.removeHooks.call(this),this._map&&(this._marker&&(this._marker.off("click",this._onClick,this),this._map.off("click",this._onClick,this).removeLayer(this._marker),delete this._marker),this._mouseMarker.off("click",this._onClick,this),this._map.removeLayer(this._mouseMarker),delete this._mouseMarker,this._map.off("mousemove",this._onMouseMove,this))},_onMouseMove:function(a){var b=a.latlng;this._tooltip.updatePosition(b),this._mouseMarker.setLatLng(b),this._marker?(b=this._mouseMarker.getLatLng(),this._marker.setLatLng(b)):(this._marker=new L.Marker(b,{icon:this.options.icon,zIndexOffset:this.options.zIndexOffset}),this._marker.on("click",this._onClick,this),this._map.on("click",this._onClick,this).addLayer(this._marker))},_onClick:function(){this._fireCreatedEvent(),this.disable(),this.options.repeatMode&&this.enable()},_fireCreatedEvent:function(){var a=new L.Marker(this._marker.getLatLng(),{icon:this.options.icon});L.Draw.Feature.prototype._fireCreatedEvent.call(this,a)}}),L.Edit=L.Edit||{},L.Edit.Poly=L.Handler.extend({options:{icon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"})},initialize:function(a,b){this._poly=a,L.setOptions(this,b)},addHooks:function(){this._poly._map&&(this._markerGroup||this._initMarkers(),this._poly._map.addLayer(this._markerGroup))},removeHooks:function(){this._poly._map&&(this._poly._map.removeLayer(this._markerGroup),delete this._markerGroup,delete this._markers)},updateMarkers:function(){this._markerGroup.clearLayers(),this._initMarkers()},_initMarkers:function(){this._markerGroup||(this._markerGroup=new L.LayerGroup),this._markers=[];var a,b,c,d,e=this._poly._latlngs;for(a=0,c=e.length;c>a;a++)d=this._createMarker(e[a],a),d.on("click",this._onMarkerClick,this),this._markers.push(d);var f,g;for(a=0,b=c-1;c>a;b=a++)(0!==a||L.Polygon&&this._poly instanceof L.Polygon)&&(f=this._markers[b],g=this._markers[a],this._createMiddleMarker(f,g),this._updatePrevNext(f,g))},_createMarker:function(a,b){var c=new L.Marker(a,{draggable:!0,icon:this.options.icon});return c._origLatLng=a,c._index=b,c.on("drag",this._onMarkerDrag,this),c.on("dragend",this._fireEdit,this),this._markerGroup.addLayer(c),c},_removeMarker:function(a){var b=a._index;this._markerGroup.removeLayer(a),this._markers.splice(b,1),this._poly.spliceLatLngs(b,1),this._updateIndexes(b,-1),a.off("drag",this._onMarkerDrag,this).off("dragend",this._fireEdit,this).off("click",this._onMarkerClick,this)},_fireEdit:function(){this._poly.edited=!0,this._poly.fire("edit")},_onMarkerDrag:function(a){var b=a.target;L.extend(b._origLatLng,b._latlng),b._middleLeft&&b._middleLeft.setLatLng(this._getMiddleLatLng(b._prev,b)),b._middleRight&&b._middleRight.setLatLng(this._getMiddleLatLng(b,b._next)),this._poly.redraw()},_onMarkerClick:function(a){var b=L.Polygon&&this._poly instanceof L.Polygon?4:3,c=a.target;this._poly._latlngs.length<b||(this._removeMarker(c),this._updatePrevNext(c._prev,c._next),c._middleLeft&&this._markerGroup.removeLayer(c._middleLeft),c._middleRight&&this._markerGroup.removeLayer(c._middleRight),c._prev&&c._next?this._createMiddleMarker(c._prev,c._next):c._prev?c._next||(c._prev._middleRight=null):c._next._middleLeft=null,this._fireEdit())},_updateIndexes:function(a,b){this._markerGroup.eachLayer(function(c){c._index>a&&(c._index+=b)})},_createMiddleMarker:function(a,b){var c,d,e,f=this._getMiddleLatLng(a,b),g=this._createMarker(f);g.setOpacity(.6),a._middleRight=b._middleLeft=g,d=function(){var d=b._index;g._index=d,g.off("click",c,this).on("click",this._onMarkerClick,this),f.lat=g.getLatLng().lat,f.lng=g.getLatLng().lng,this._poly.spliceLatLngs(d,0,f),this._markers.splice(d,0,g),g.setOpacity(1),this._updateIndexes(d,1),b._index++,this._updatePrevNext(a,g),this._updatePrevNext(g,b),this._poly.fire("editstart")},e=function(){g.off("dragstart",d,this),g.off("dragend",e,this),this._createMiddleMarker(a,g),this._createMiddleMarker(g,b)},c=function(){d.call(this),e.call(this),this._fireEdit()},g.on("click",c,this).on("dragstart",d,this).on("dragend",e,this),this._markerGroup.addLayer(g)},_updatePrevNext:function(a,b){a&&(a._next=b),b&&(b._prev=a)},_getMiddleLatLng:function(a,b){var c=this._poly._map,d=c.project(a.getLatLng()),e=c.project(b.getLatLng());return c.unproject(d._add(e)._divideBy(2))}}),L.Polyline.addInitHook(function(){this.editing||(L.Edit.Poly&&(this.editing=new L.Edit.Poly(this),this.options.editable&&this.editing.enable()),this.on("add",function(){this.editing&&this.editing.enabled()&&this.editing.addHooks()}),this.on("remove",function(){this.editing&&this.editing.enabled()&&this.editing.removeHooks()}))}),L.Edit=L.Edit||{},L.Edit.SimpleShape=L.Handler.extend({options:{moveIcon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-move"}),resizeIcon:new L.DivIcon({iconSize:new L.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon leaflet-edit-resize"})},initialize:function(a,b){this._shape=a,L.Util.setOptions(this,b)},addHooks:function(){this._shape._map&&(this._map=this._shape._map,this._markerGroup||this._initMarkers(),this._map.addLayer(this._markerGroup))},removeHooks:function(){if(this._shape._map){this._unbindMarker(this._moveMarker);for(var a=0,b=this._resizeMarkers.length;b>a;a++)this._unbindMarker(this._resizeMarkers[a]);this._resizeMarkers=null,this._map.removeLayer(this._markerGroup),delete this._markerGroup}this._map=null},updateMarkers:function(){this._markerGroup.clearLayers(),this._initMarkers()},_initMarkers:function(){this._markerGroup||(this._markerGroup=new L.LayerGroup),this._createMoveMarker(),this._createResizeMarker()},_createMoveMarker:function(){},_createResizeMarker:function(){},_createMarker:function(a,b){var c=new L.Marker(a,{draggable:!0,icon:b,zIndexOffset:10});return this._bindMarker(c),this._markerGroup.addLayer(c),c},_bindMarker:function(a){a.on("dragstart",this._onMarkerDragStart,this).on("drag",this._onMarkerDrag,this).on("dragend",this._onMarkerDragEnd,this)},_unbindMarker:function(a){a.off("dragstart",this._onMarkerDragStart,this).off("drag",this._onMarkerDrag,this).off("dragend",this._onMarkerDragEnd,this)},_onMarkerDragStart:function(a){var b=a.target;b.setOpacity(0),this._shape.fire("editstart")},_fireEdit:function(){this._shape.edited=!0,this._shape.fire("edit")},_onMarkerDrag:function(a){var b=a.target,c=b.getLatLng();b===this._moveMarker?this._move(c):this._resize(c),this._shape.redraw()},_onMarkerDragEnd:function(a){var b=a.target;b.setOpacity(1),this._fireEdit()},_move:function(){},_resize:function(){}}),L.Edit=L.Edit||{},L.Edit.Rectangle=L.Edit.SimpleShape.extend({_createMoveMarker:function(){var a=this._shape.getBounds(),b=a.getCenter();this._moveMarker=this._createMarker(b,this.options.moveIcon)},_createResizeMarker:function(){var a=this._getCorners();this._resizeMarkers=[];for(var b=0,c=a.length;c>b;b++)this._resizeMarkers.push(this._createMarker(a[b],this.options.resizeIcon)),this._resizeMarkers[b]._cornerIndex=b},_onMarkerDragStart:function(a){L.Edit.SimpleShape.prototype._onMarkerDragStart.call(this,a);var b=this._getCorners(),c=a.target,d=c._cornerIndex;this._oppositeCorner=b[(d+2)%4],this._toggleCornerMarkers(0,d)},_onMarkerDragEnd:function(a){var b,c,d=a.target;d===this._moveMarker&&(b=this._shape.getBounds(),c=b.getCenter(),d.setLatLng(c)),this._toggleCornerMarkers(1),this._repositionCornerMarkers(),L.Edit.SimpleShape.prototype._onMarkerDragEnd.call(this,a)},_move:function(a){for(var b,c=this._shape.getLatLngs(),d=this._shape.getBounds(),e=d.getCenter(),f=[],g=0,h=c.length;h>g;g++)b=[c[g].lat-e.lat,c[g].lng-e.lng],f.push([a.lat+b[0],a.lng+b[1]]);this._shape.setLatLngs(f),this._repositionCornerMarkers()},_resize:function(a){var b;this._shape.setBounds(L.latLngBounds(a,this._oppositeCorner)),b=this._shape.getBounds(),this._moveMarker.setLatLng(b.getCenter())},_getCorners:function(){var a=this._shape.getBounds(),b=a.getNorthWest(),c=a.getNorthEast(),d=a.getSouthEast(),e=a.getSouthWest();return[b,c,d,e]},_toggleCornerMarkers:function(a){for(var b=0,c=this._resizeMarkers.length;c>b;b++)this._resizeMarkers[b].setOpacity(a)},_repositionCornerMarkers:function(){for(var a=this._getCorners(),b=0,c=this._resizeMarkers.length;c>b;b++)this._resizeMarkers[b].setLatLng(a[b])}}),L.Rectangle.addInitHook(function(){L.Edit.Rectangle&&(this.editing=new L.Edit.Rectangle(this),this.options.editable&&this.editing.enable())}),L.Edit=L.Edit||{},L.Edit.Circle=L.Edit.SimpleShape.extend({_createMoveMarker:function(){var a=this._shape.getLatLng();this._moveMarker=this._createMarker(a,this.options.moveIcon)},_createResizeMarker:function(){var a=this._shape.getLatLng(),b=this._getResizeMarkerPoint(a);this._resizeMarkers=[],this._resizeMarkers.push(this._createMarker(b,this.options.resizeIcon))},_getResizeMarkerPoint:function(a){var b=this._shape._radius*Math.cos(Math.PI/4),c=this._map.project(a);return this._map.unproject([c.x+b,c.y-b])},_move:function(a){var b=this._getResizeMarkerPoint(a);this._resizeMarkers[0].setLatLng(b),this._shape.setLatLng(a)},_resize:function(a){var b=this._moveMarker.getLatLng(),c=b.distanceTo(a);this._shape.setRadius(c)}}),L.Circle.addInitHook(function(){L.Edit.Circle&&(this.editing=new L.Edit.Circle(this),this.options.editable&&this.editing.enable()),this.on("add",function(){this.editing&&this.editing.enabled()&&this.editing.addHooks()}),this.on("remove",function(){this.editing&&this.editing.enabled()&&this.editing.removeHooks()})}),L.LatLngUtil={cloneLatLngs:function(a){for(var b=[],c=0,d=a.length;d>c;c++)b.push(this.cloneLatLng(a[c]));return b},cloneLatLng:function(a){return L.latLng(a.lat,a.lng)}},L.GeometryUtil=L.extend(L.GeometryUtil||{},{geodesicArea:function(a){var b,c,d=a.length,e=0,f=L.LatLng.DEG_TO_RAD;if(d>2){for(var g=0;d>g;g++)b=a[g],c=a[(g+1)%d],e+=(c.lng-b.lng)*f*(2+Math.sin(b.lat*f)+Math.sin(c.lat*f));e=6378137*e*6378137/2}return Math.abs(e)},readableArea:function(a,b){var c;return b?c=a>=1e4?(1e-4*a).toFixed(2)+" ha":a.toFixed(2)+" m&sup2;":(a*=.836127,c=a>=3097600?(a/3097600).toFixed(2)+" mi&sup2;":a>=4840?(a/4840).toFixed(2)+" acres":Math.ceil(a)+" yd&sup2;"),c},readableDistance:function(a,b){var c;return b?c=a>1e3?(a/1e3).toFixed(2)+" km":Math.ceil(a)+" m":(a*=1.09361,c=a>1760?(a/1760).toFixed(2)+" miles":Math.ceil(a)+" yd"),c}}),L.Util.extend(L.LineUtil,{segmentsIntersect:function(a,b,c,d){return this._checkCounterclockwise(a,c,d)!==this._checkCounterclockwise(b,c,d)&&this._checkCounterclockwise(a,b,c)!==this._checkCounterclockwise(a,b,d)},_checkCounterclockwise:function(a,b,c){return(c.y-a.y)*(b.x-a.x)>(b.y-a.y)*(c.x-a.x)}}),L.Polyline.include({intersects:function(){var a,b,c,d=this._originalPoints,e=d?d.length:0;if(this._tooFewPointsForIntersection())return!1;for(a=e-1;a>=3;a--)if(b=d[a-1],c=d[a],this._lineSegmentsIntersectsRange(b,c,a-2))return!0;return!1},newLatLngIntersects:function(a,b){return this._map?this.newPointIntersects(this._map.latLngToLayerPoint(a),b):!1},newPointIntersects:function(a,b){var c=this._originalPoints,d=c?c.length:0,e=c?c[d-1]:null,f=d-2;return this._tooFewPointsForIntersection(1)?!1:this._lineSegmentsIntersectsRange(e,a,f,b?1:0)},_tooFewPointsForIntersection:function(a){var b=this._originalPoints,c=b?b.length:0;return c+=a||0,!this._originalPoints||3>=c},_lineSegmentsIntersectsRange:function(a,b,c,d){var e,f,g=this._originalPoints;d=d||0;for(var h=c;h>d;h--)if(e=g[h-1],f=g[h],L.LineUtil.segmentsIntersect(a,b,e,f))return!0;return!1}}),L.Polygon.include({intersects:function(){var a,b,c,d,e,f=this._originalPoints;return this._tooFewPointsForIntersection()?!1:(a=L.Polyline.prototype.intersects.call(this))?!0:(b=f.length,c=f[0],d=f[b-1],e=b-2,this._lineSegmentsIntersectsRange(d,c,e,1))}}),L.Control.Draw=L.Control.extend({options:{position:"topleft",draw:{},edit:!1},initialize:function(a){if(L.version<"0.7")throw new Error("Leaflet.draw 0.2.3+ requires Leaflet 0.7.0+. Download latest from https://github.com/Leaflet/Leaflet/");L.Control.prototype.initialize.call(this,a);var b,c;this._toolbars={},L.DrawToolbar&&this.options.draw&&(c=new L.DrawToolbar(this.options.draw),b=L.stamp(c),this._toolbars[b]=c,this._toolbars[b].on("enable",this._toolbarEnabled,this)),L.EditToolbar&&this.options.edit&&(c=new L.EditToolbar(this.options.edit),b=L.stamp(c),this._toolbars[b]=c,this._toolbars[b].on("enable",this._toolbarEnabled,this))},onAdd:function(a){var b,c=L.DomUtil.create("div","leaflet-draw"),d=!1,e="leaflet-draw-toolbar-top";for(var f in this._toolbars)this._toolbars.hasOwnProperty(f)&&(b=this._toolbars[f].addToolbar(a),b&&(d||(L.DomUtil.hasClass(b,e)||L.DomUtil.addClass(b.childNodes[0],e),d=!0),c.appendChild(b)));return c},onRemove:function(){for(var a in this._toolbars)this._toolbars.hasOwnProperty(a)&&this._toolbars[a].removeToolbar()},setDrawingOptions:function(a){for(var b in this._toolbars)this._toolbars[b]instanceof L.DrawToolbar&&this._toolbars[b].setOptions(a)},_toolbarEnabled:function(a){var b=""+L.stamp(a.target);for(var c in this._toolbars)this._toolbars.hasOwnProperty(c)&&c!==b&&this._toolbars[c].disable()}}),L.Map.mergeOptions({drawControlTooltips:!0,drawControl:!1}),L.Map.addInitHook(function(){this.options.drawControl&&(this.drawControl=new L.Control.Draw,this.addControl(this.drawControl))}),L.Toolbar=L.Class.extend({includes:[L.Mixin.Events],initialize:function(a){L.setOptions(this,a),this._modes={},this._actionButtons=[],this._activeMode=null},enabled:function(){return null!==this._activeMode},disable:function(){this.enabled()&&this._activeMode.handler.disable()},addToolbar:function(a){var b,c=L.DomUtil.create("div","leaflet-draw-section"),d=0,e=this._toolbarClass||"",f=this.getModeHandlers(a);for(this._toolbarContainer=L.DomUtil.create("div","leaflet-draw-toolbar leaflet-bar"),this._map=a,b=0;b<f.length;b++)f[b].enabled&&this._initModeHandler(f[b].handler,this._toolbarContainer,d++,e,f[b].title);return d?(this._lastButtonIndex=--d,this._actionsContainer=L.DomUtil.create("ul","leaflet-draw-actions"),c.appendChild(this._toolbarContainer),c.appendChild(this._actionsContainer),c):void 0},removeToolbar:function(){for(var a in this._modes)this._modes.hasOwnProperty(a)&&(this._disposeButton(this._modes[a].button,this._modes[a].handler.enable,this._modes[a].handler),this._modes[a].handler.disable(),this._modes[a].handler.off("enabled",this._handlerActivated,this).off("disabled",this._handlerDeactivated,this));this._modes={};for(var b=0,c=this._actionButtons.length;c>b;b++)this._disposeButton(this._actionButtons[b].button,this._actionButtons[b].callback,this);this._actionButtons=[],this._actionsContainer=null},_initModeHandler:function(a,b,c,d,e){var f=a.type;this._modes[f]={},this._modes[f].handler=a,this._modes[f].button=this._createButton({title:e,className:d+"-"+f,container:b,callback:this._modes[f].handler.enable,context:this._modes[f].handler}),this._modes[f].buttonIndex=c,this._modes[f].handler.on("enabled",this._handlerActivated,this).on("disabled",this._handlerDeactivated,this)},_createButton:function(a){var b=L.DomUtil.create("a",a.className||"",a.container);return b.href="#",a.text&&(b.innerHTML=a.text),a.title&&(b.title=a.title),L.DomEvent.on(b,"click",L.DomEvent.stopPropagation).on(b,"mousedown",L.DomEvent.stopPropagation).on(b,"dblclick",L.DomEvent.stopPropagation).on(b,"click",L.DomEvent.preventDefault).on(b,"click",a.callback,a.context),b},_disposeButton:function(a,b){L.DomEvent.off(a,"click",L.DomEvent.stopPropagation).off(a,"mousedown",L.DomEvent.stopPropagation).off(a,"dblclick",L.DomEvent.stopPropagation).off(a,"click",L.DomEvent.preventDefault).off(a,"click",b)},_handlerActivated:function(a){this.disable(),this._activeMode=this._modes[a.handler],L.DomUtil.addClass(this._activeMode.button,"leaflet-draw-toolbar-button-enabled"),this._showActionsToolbar(),this.fire("enable")},_handlerDeactivated:function(){this._hideActionsToolbar(),L.DomUtil.removeClass(this._activeMode.button,"leaflet-draw-toolbar-button-enabled"),this._activeMode=null,this.fire("disable")},_createActions:function(a){var b,c,d,e,f=this._actionsContainer,g=this.getActions(a),h=g.length;for(c=0,d=this._actionButtons.length;d>c;c++)this._disposeButton(this._actionButtons[c].button,this._actionButtons[c].callback);for(this._actionButtons=[];f.firstChild;)f.removeChild(f.firstChild);for(var i=0;h>i;i++)"enabled"in g[i]&&!g[i].enabled||(b=L.DomUtil.create("li","",f),e=this._createButton({title:g[i].title,text:g[i].text,container:b,callback:g[i].callback,context:g[i].context}),this._actionButtons.push({button:e,callback:g[i].callback}))},_showActionsToolbar:function(){var a=this._activeMode.buttonIndex,b=this._lastButtonIndex,c=this._activeMode.button.offsetTop-1;this._createActions(this._activeMode.handler),this._actionsContainer.style.top=c+"px",0===a&&(L.DomUtil.addClass(this._toolbarContainer,"leaflet-draw-toolbar-notop"),L.DomUtil.addClass(this._actionsContainer,"leaflet-draw-actions-top")),a===b&&(L.DomUtil.addClass(this._toolbarContainer,"leaflet-draw-toolbar-nobottom"),L.DomUtil.addClass(this._actionsContainer,"leaflet-draw-actions-bottom")),this._actionsContainer.style.display="block"},_hideActionsToolbar:function(){this._actionsContainer.style.display="none",L.DomUtil.removeClass(this._toolbarContainer,"leaflet-draw-toolbar-notop"),L.DomUtil.removeClass(this._toolbarContainer,"leaflet-draw-toolbar-nobottom"),L.DomUtil.removeClass(this._actionsContainer,"leaflet-draw-actions-top"),L.DomUtil.removeClass(this._actionsContainer,"leaflet-draw-actions-bottom")}}),L.Tooltip=L.Class.extend({initialize:function(a){this._map=a,this._popupPane=a._panes.popupPane,this._container=a.options.drawControlTooltips?L.DomUtil.create("div","leaflet-draw-tooltip",this._popupPane):null,this._singleLineLabel=!1},dispose:function(){this._container&&(this._popupPane.removeChild(this._container),this._container=null)},updateContent:function(a){return this._container?(a.subtext=a.subtext||"",0!==a.subtext.length||this._singleLineLabel?a.subtext.length>0&&this._singleLineLabel&&(L.DomUtil.removeClass(this._container,"leaflet-draw-tooltip-single"),this._singleLineLabel=!1):(L.DomUtil.addClass(this._container,"leaflet-draw-tooltip-single"),this._singleLineLabel=!0),this._container.innerHTML=(a.subtext.length>0?'<span class="leaflet-draw-tooltip-subtext">'+a.subtext+"</span><br />":"")+"<span>"+a.text+"</span>",this):this},updatePosition:function(a){var b=this._map.latLngToLayerPoint(a),c=this._container;return this._container&&(c.style.visibility="inherit",L.DomUtil.setPosition(c,b)),this},showAsError:function(){return this._container&&L.DomUtil.addClass(this._container,"leaflet-error-draw-tooltip"),this},removeError:function(){return this._container&&L.DomUtil.removeClass(this._container,"leaflet-error-draw-tooltip"),this}}),L.DrawToolbar=L.Toolbar.extend({options:{polyline:{},polygon:{},rectangle:{},circle:{},marker:{}},initialize:function(a){for(var b in this.options)this.options.hasOwnProperty(b)&&a[b]&&(a[b]=L.extend({},this.options[b],a[b]));this._toolbarClass="leaflet-draw-draw",L.Toolbar.prototype.initialize.call(this,a)},getModeHandlers:function(a){return[{enabled:this.options.polyline,handler:new L.Draw.Polyline(a,this.options.polyline),title:L.drawLocal.draw.toolbar.buttons.polyline},{enabled:this.options.polygon,handler:new L.Draw.Polygon(a,this.options.polygon),title:L.drawLocal.draw.toolbar.buttons.polygon},{enabled:this.options.rectangle,handler:new L.Draw.Rectangle(a,this.options.rectangle),title:L.drawLocal.draw.toolbar.buttons.rectangle},{enabled:this.options.circle,handler:new L.Draw.Circle(a,this.options.circle),title:L.drawLocal.draw.toolbar.buttons.circle},{enabled:this.options.marker,handler:new L.Draw.Marker(a,this.options.marker),title:L.drawLocal.draw.toolbar.buttons.marker}]},getActions:function(a){return[{enabled:a.deleteLastVertex,title:L.drawLocal.draw.toolbar.undo.title,text:L.drawLocal.draw.toolbar.undo.text,callback:a.deleteLastVertex,context:a},{title:L.drawLocal.draw.toolbar.actions.title,text:L.drawLocal.draw.toolbar.actions.text,callback:this.disable,context:this}]},setOptions:function(a){L.setOptions(this,a);for(var b in this._modes)this._modes.hasOwnProperty(b)&&a.hasOwnProperty(b)&&this._modes[b].handler.setOptions(a[b])}}),L.EditToolbar=L.Toolbar.extend({options:{edit:{selectedPathOptions:{color:"#fe57a1",opacity:.6,dashArray:"10, 10",fill:!0,fillColor:"#fe57a1",fillOpacity:.1}},remove:{},featureGroup:null},initialize:function(a){a.edit&&("undefined"==typeof a.edit.selectedPathOptions&&(a.edit.selectedPathOptions=this.options.edit.selectedPathOptions),a.edit=L.extend({},this.options.edit,a.edit)),a.remove&&(a.remove=L.extend({},this.options.remove,a.remove)),this._toolbarClass="leaflet-draw-edit",L.Toolbar.prototype.initialize.call(this,a),this._selectedFeatureCount=0},getModeHandlers:function(a){var b=this.options.featureGroup;return[{enabled:this.options.edit,handler:new L.EditToolbar.Edit(a,{featureGroup:b,selectedPathOptions:this.options.edit.selectedPathOptions}),title:L.drawLocal.edit.toolbar.buttons.edit},{enabled:this.options.remove,handler:new L.EditToolbar.Delete(a,{featureGroup:b}),title:L.drawLocal.edit.toolbar.buttons.remove}]},getActions:function(){return[{title:L.drawLocal.edit.toolbar.actions.save.title,text:L.drawLocal.edit.toolbar.actions.save.text,callback:this._save,context:this},{title:L.drawLocal.edit.toolbar.actions.cancel.title,text:L.drawLocal.edit.toolbar.actions.cancel.text,callback:this.disable,context:this}]},addToolbar:function(a){var b=L.Toolbar.prototype.addToolbar.call(this,a);return this._checkDisabled(),this.options.featureGroup.on("layeradd layerremove",this._checkDisabled,this),b},removeToolbar:function(){this.options.featureGroup.off("layeradd layerremove",this._checkDisabled,this),
L.Toolbar.prototype.removeToolbar.call(this)},disable:function(){this.enabled()&&(this._activeMode.handler.revertLayers(),L.Toolbar.prototype.disable.call(this))},_save:function(){this._activeMode.handler.save(),this._activeMode.handler.disable()},_checkDisabled:function(){var a,b=this.options.featureGroup,c=0!==b.getLayers().length;this.options.edit&&(a=this._modes[L.EditToolbar.Edit.TYPE].button,c?L.DomUtil.removeClass(a,"leaflet-disabled"):L.DomUtil.addClass(a,"leaflet-disabled"),a.setAttribute("title",c?L.drawLocal.edit.toolbar.buttons.edit:L.drawLocal.edit.toolbar.buttons.editDisabled)),this.options.remove&&(a=this._modes[L.EditToolbar.Delete.TYPE].button,c?L.DomUtil.removeClass(a,"leaflet-disabled"):L.DomUtil.addClass(a,"leaflet-disabled"),a.setAttribute("title",c?L.drawLocal.edit.toolbar.buttons.remove:L.drawLocal.edit.toolbar.buttons.removeDisabled))}}),L.EditToolbar.Edit=L.Handler.extend({statics:{TYPE:"edit"},includes:L.Mixin.Events,initialize:function(a,b){if(L.Handler.prototype.initialize.call(this,a),this._selectedPathOptions=b.selectedPathOptions,this._featureGroup=b.featureGroup,!(this._featureGroup instanceof L.FeatureGroup))throw new Error("options.featureGroup must be a L.FeatureGroup");this._uneditedLayerProps={},this.type=L.EditToolbar.Edit.TYPE},enable:function(){!this._enabled&&this._hasAvailableLayers()&&(this.fire("enabled",{handler:this.type}),this._map.fire("draw:editstart",{handler:this.type}),L.Handler.prototype.enable.call(this),this._featureGroup.on("layeradd",this._enableLayerEdit,this).on("layerremove",this._disableLayerEdit,this))},disable:function(){this._enabled&&(this._featureGroup.off("layeradd",this._enableLayerEdit,this).off("layerremove",this._disableLayerEdit,this),L.Handler.prototype.disable.call(this),this._map.fire("draw:editstop",{handler:this.type}),this.fire("disabled",{handler:this.type}))},addHooks:function(){var a=this._map;a&&(a.getContainer().focus(),this._featureGroup.eachLayer(this._enableLayerEdit,this),this._tooltip=new L.Tooltip(this._map),this._tooltip.updateContent({text:L.drawLocal.edit.handlers.edit.tooltip.text,subtext:L.drawLocal.edit.handlers.edit.tooltip.subtext}),this._map.on("mousemove",this._onMouseMove,this))},removeHooks:function(){this._map&&(this._featureGroup.eachLayer(this._disableLayerEdit,this),this._uneditedLayerProps={},this._tooltip.dispose(),this._tooltip=null,this._map.off("mousemove",this._onMouseMove,this))},revertLayers:function(){this._featureGroup.eachLayer(function(a){this._revertLayer(a)},this)},save:function(){var a=new L.LayerGroup;this._featureGroup.eachLayer(function(b){b.edited&&(a.addLayer(b),b.edited=!1)}),this._map.fire("draw:edited",{layers:a})},_backupLayer:function(a){var b=L.Util.stamp(a);this._uneditedLayerProps[b]||(a instanceof L.Polyline||a instanceof L.Polygon||a instanceof L.Rectangle?this._uneditedLayerProps[b]={latlngs:L.LatLngUtil.cloneLatLngs(a.getLatLngs())}:a instanceof L.Circle?this._uneditedLayerProps[b]={latlng:L.LatLngUtil.cloneLatLng(a.getLatLng()),radius:a.getRadius()}:a instanceof L.Marker&&(this._uneditedLayerProps[b]={latlng:L.LatLngUtil.cloneLatLng(a.getLatLng())}))},_revertLayer:function(a){var b=L.Util.stamp(a);a.edited=!1,this._uneditedLayerProps.hasOwnProperty(b)&&(a instanceof L.Polyline||a instanceof L.Polygon||a instanceof L.Rectangle?a.setLatLngs(this._uneditedLayerProps[b].latlngs):a instanceof L.Circle?(a.setLatLng(this._uneditedLayerProps[b].latlng),a.setRadius(this._uneditedLayerProps[b].radius)):a instanceof L.Marker&&a.setLatLng(this._uneditedLayerProps[b].latlng))},_toggleMarkerHighlight:function(a){if(a._icon){var b=a._icon;b.style.display="none",L.DomUtil.hasClass(b,"leaflet-edit-marker-selected")?(L.DomUtil.removeClass(b,"leaflet-edit-marker-selected"),this._offsetMarker(b,-4)):(L.DomUtil.addClass(b,"leaflet-edit-marker-selected"),this._offsetMarker(b,4)),b.style.display=""}},_offsetMarker:function(a,b){var c=parseInt(a.style.marginTop,10)-b,d=parseInt(a.style.marginLeft,10)-b;a.style.marginTop=c+"px",a.style.marginLeft=d+"px"},_enableLayerEdit:function(a){var b,c=a.layer||a.target||a,d=c instanceof L.Marker;(!d||c._icon)&&(this._backupLayer(c),this._selectedPathOptions&&(b=L.Util.extend({},this._selectedPathOptions),d?this._toggleMarkerHighlight(c):(c.options.previousOptions=L.Util.extend({dashArray:null},c.options),c instanceof L.Circle||c instanceof L.Polygon||c instanceof L.Rectangle||(b.fill=!1),c.setStyle(b))),d?(c.dragging.enable(),c.on("dragend",this._onMarkerDragEnd)):c.editing.enable())},_disableLayerEdit:function(a){var b=a.layer||a.target||a;b.edited=!1,this._selectedPathOptions&&(b instanceof L.Marker?this._toggleMarkerHighlight(b):(b.setStyle(b.options.previousOptions),delete b.options.previousOptions)),b instanceof L.Marker?(b.dragging.disable(),b.off("dragend",this._onMarkerDragEnd,this)):b.editing.disable()},_onMarkerDragEnd:function(a){var b=a.target;b.edited=!0},_onMouseMove:function(a){this._tooltip.updatePosition(a.latlng)},_hasAvailableLayers:function(){return 0!==this._featureGroup.getLayers().length}}),L.EditToolbar.Delete=L.Handler.extend({statics:{TYPE:"remove"},includes:L.Mixin.Events,initialize:function(a,b){if(L.Handler.prototype.initialize.call(this,a),L.Util.setOptions(this,b),this._deletableLayers=this.options.featureGroup,!(this._deletableLayers instanceof L.FeatureGroup))throw new Error("options.featureGroup must be a L.FeatureGroup");this.type=L.EditToolbar.Delete.TYPE},enable:function(){!this._enabled&&this._hasAvailableLayers()&&(this.fire("enabled",{handler:this.type}),this._map.fire("draw:deletestart",{handler:this.type}),L.Handler.prototype.enable.call(this),this._deletableLayers.on("layeradd",this._enableLayerDelete,this).on("layerremove",this._disableLayerDelete,this))},disable:function(){this._enabled&&(this._deletableLayers.off("layeradd",this._enableLayerDelete,this).off("layerremove",this._disableLayerDelete,this),L.Handler.prototype.disable.call(this),this._map.fire("draw:deletestop",{handler:this.type}),this.fire("disabled",{handler:this.type}))},addHooks:function(){var a=this._map;a&&(a.getContainer().focus(),this._deletableLayers.eachLayer(this._enableLayerDelete,this),this._deletedLayers=new L.layerGroup,this._tooltip=new L.Tooltip(this._map),this._tooltip.updateContent({text:L.drawLocal.edit.handlers.remove.tooltip.text}),this._map.on("mousemove",this._onMouseMove,this))},removeHooks:function(){this._map&&(this._deletableLayers.eachLayer(this._disableLayerDelete,this),this._deletedLayers=null,this._tooltip.dispose(),this._tooltip=null,this._map.off("mousemove",this._onMouseMove,this))},revertLayers:function(){this._deletedLayers.eachLayer(function(a){this._deletableLayers.addLayer(a)},this)},save:function(){this._map.fire("draw:deleted",{layers:this._deletedLayers})},_enableLayerDelete:function(a){var b=a.layer||a.target||a;b.on("click",this._removeLayer,this)},_disableLayerDelete:function(a){var b=a.layer||a.target||a;b.off("click",this._removeLayer,this),this._deletedLayers.removeLayer(b)},_removeLayer:function(a){var b=a.layer||a.target||a;this._deletableLayers.removeLayer(b),this._deletedLayers.addLayer(b)},_onMouseMove:function(a){this._tooltip.updatePosition(a.latlng)},_hasAvailableLayers:function(){return 0!==this._deletableLayers.getLayers().length}})}(window,document),function(b){function c(){return"Markdown.mk_block( "+uneval(this.toString())+", "+uneval(this.trailing)+", "+uneval(this.lineNumber)+" )"}function d(){var a=require("util");return"Markdown.mk_block( "+a.inspect(this.toString())+", "+a.inspect(this.trailing)+", "+a.inspect(this.lineNumber)+" )"}function e(a){for(var b=0,c=-1;-1!==(c=a.indexOf("\n",c+1));)b++;return b}function f(a,b){function c(a){this.len_after=a,this.name="close_"+b}var d=a+"_state",e="strong"==a?"em_state":"strong_state";return function(f,g){if(this[d][0]==b)return this[d].shift(),[f.length,new c(f.length-b.length)];var h=this[e].slice(),i=this[d].slice();this[d].unshift(b);var j=this.processInline(f.substr(b.length)),k=j[j.length-1];this[d].shift();if(k instanceof c){j.pop();var l=f.length-k.len_after;return[l,[a].concat(j)]}return this[e]=h,this[d]=i,[b.length,b]}}function g(a){for(var b=a.split(""),c=[""],d=!1;b.length;){var e=b.shift();switch(e){case" ":d?c[c.length-1]+=e:c.push("");break;case"'":case'"':d=!d;break;case"\\":e=b.shift();default:c[c.length-1]+=e}}return c}function h(a){return q(a)&&a.length>1&&"object"==typeof a[1]&&!q(a[1])?a[1]:void 0}function i(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function j(a){if("string"==typeof a)return i(a);var b=a.shift(),c={},d=[];for(!a.length||"object"!=typeof a[0]||a[0]instanceof Array||(c=a.shift());a.length;)d.push(j(a.shift()));var e="";for(var f in c)e+=" "+f+'="'+i(c[f])+'"';return"img"==b||"br"==b||"hr"==b?"<"+b+e+"/>":"<"+b+e+">"+d.join("")+"</"+b+">"}function k(a,b,c){var d;c=c||{};var e=a.slice(0);"function"==typeof c.preprocessTreeNode&&(e=c.preprocessTreeNode(e,b));var f=h(e);if(f){e[1]={};for(d in f)e[1][d]=f[d];f=e[1]}if("string"==typeof e)return e;switch(e[0]){case"header":e[0]="h"+e[1].level,delete e[1].level;break;case"bulletlist":e[0]="ul";break;case"numberlist":e[0]="ol";break;case"listitem":e[0]="li";break;case"para":e[0]="p";break;case"markdown":e[0]="html",f&&delete f.references;break;case"code_block":e[0]="pre",d=f?2:1;var g=["code"];g.push.apply(g,e.splice(d,e.length-d)),e[d]=g;break;case"inlinecode":e[0]="code";break;case"img":e[1].src=e[1].href,delete e[1].href;break;case"linebreak":e[0]="br";break;case"link":e[0]="a";break;case"link_ref":e[0]="a";var i=b[f.ref];if(!i)return f.original;delete f.ref,f.href=i.href,i.title&&(f.title=i.title),delete f.original;break;case"img_ref":e[0]="img";var i=b[f.ref];if(!i)return f.original;delete f.ref,f.src=i.href,i.title&&(f.title=i.title),delete f.original}if(d=1,f){for(var j in e[1]){d=2;break}1===d&&e.splice(d,1)}for(;d<e.length;++d)e[d]=k(e[d],b,c);return e}function l(a){for(var b=h(a)?2:1;b<a.length;)"string"==typeof a[b]?b+1<a.length&&"string"==typeof a[b+1]?a[b]+=a.splice(b+1,1)[0]:++b:(l(a[b]),++b)}var m=b.Markdown=function(a){switch(typeof a){case"undefined":this.dialect=m.dialects.Gruber;break;case"object":this.dialect=a;break;default:if(!(a in m.dialects))throw new Error("Unknown Markdown dialect '"+String(a)+"'");this.dialect=m.dialects[a]}this.em_state=[],this.strong_state=[],this.debug_indent=""};b.parse=function(a,b){var c=new m(b);return c.toTree(a)},b.toHTML=function(a,c,d){var e=b.toHTMLTree(a,c,d);return b.renderJsonML(e)},b.toHTMLTree=function(a,b,c){"string"==typeof a&&(a=this.parse(a,b));var d=h(a),e={};d&&d.references&&(e=d.references);var f=k(a,e,c);return l(f),f};var n=m.mk_block=function(a,b,e){1==arguments.length&&(b="\n\n");var f=new String(a);return f.trailing=b,f.inspect=d,f.toSource=c,void 0!=e&&(f.lineNumber=e),f};m.prototype.split_blocks=function(a,b){a=a.replace(/(\r\n|\n|\r)/g,"\n");var c,d=/([\s\S]+?)($|\n#|\n(?:\s*\n|$)+)/g,f=[],g=1;for(null!=(c=/^(\s*\n)/.exec(a))&&(g+=e(c[0]),d.lastIndex=c[0].length);null!==(c=d.exec(a));)"\n#"==c[2]&&(c[2]="\n",d.lastIndex--),f.push(n(c[1],c[2],g)),g+=e(c[0]);return f},m.prototype.processBlock=function(a,b){var c=this.dialect.block,d=c.__order__;if("__call__"in c)return c.__call__.call(this,a,b);for(var e=0;e<d.length;e++){var f=c[d[e]].call(this,a,b);if(f)return(!q(f)||f.length>0&&!q(f[0]))&&this.debug(d[e],"didn't return a proper array"),f}return[]},m.prototype.processInline=function(a){return this.dialect.inline.__call__.call(this,String(a))},m.prototype.toTree=function(a,b){var c=a instanceof Array?a:this.split_blocks(a),d=this.tree;try{for(this.tree=b||this.tree||["markdown"];c.length;){var e=this.processBlock(c.shift(),c);e.length&&this.tree.push.apply(this.tree,e)}return this.tree}finally{b&&(this.tree=d)}},m.prototype.debug=function(){var a=Array.prototype.slice.call(arguments);a.unshift(this.debug_indent),"undefined"!=typeof print&&print.apply(print,a),"undefined"!=typeof console&&"undefined"!=typeof console.log&&console.log.apply(null,a)},m.prototype.loop_re_over_block=function(a,b,c){for(var d,e=b.valueOf();e.length&&null!=(d=a.exec(e));)e=e.substr(d[0].length),c.call(this,d);return e},m.dialects={},m.dialects.Gruber={block:{atxHeader:function(a,b){var c=a.match(/^(#{1,6})\s*(.*?)\s*#*\s*(?:\n|$)/);if(!c)return void 0;var d=["header",{level:c[1].length}];return Array.prototype.push.apply(d,this.processInline(c[2])),c[0].length<a.length&&b.unshift(n(a.substr(c[0].length),a.trailing,a.lineNumber+2)),[d]},setextHeader:function(a,b){var c=a.match(/^(.*)\n([-=])\2\2+(?:\n|$)/);if(!c)return void 0;var d="="===c[2]?1:2,e=["header",{level:d},c[1]];return c[0].length<a.length&&b.unshift(n(a.substr(c[0].length),a.trailing,a.lineNumber+2)),[e]},code:function(a,b){var c=[],d=/^(?: {0,3}\t| {4})(.*)\n?/;if(!a.match(d))return void 0;a:for(;;){var e=this.loop_re_over_block(d,a.valueOf(),function(a){c.push(a[1])});if(e.length){b.unshift(n(e,a.trailing));break a}if(!b.length)break a;if(!b[0].match(d))break a;c.push(a.trailing.replace(/[^\n]/g,"").substring(2)),a=b.shift()}return[["code_block",c.join("\n")]]},horizRule:function(a,b){var c=a.match(/^(?:([\s\S]*?)\n)?[ \t]*([-_*])(?:[ \t]*\2){2,}[ \t]*(?:\n([\s\S]*))?$/);if(!c)return void 0;var d=[["hr"]];return c[1]&&d.unshift.apply(d,this.processBlock(c[1],[])),c[3]&&b.unshift(n(c[3])),d},lists:function(){function a(a){return new RegExp("(?:^("+i+"{0,"+a+"} {0,3})("+f+")\\s+)|(^"+i+"{0,"+(a-1)+"}[ ]{0,4})")}function b(a){return a.replace(/ {0,3}\t/g,"    ")}function c(a,b,c,d){if(b)return void a.push(["para"].concat(c));var e=a[a.length-1]instanceof Array&&"para"==a[a.length-1][0]?a[a.length-1]:a;d&&a.length>1&&c.unshift(d);for(var f=0;f<c.length;f++){var g=c[f],h="string"==typeof g;h&&e.length>1&&"string"==typeof e[e.length-1]?e[e.length-1]+=g:e.push(g)}}function d(a,b){for(var c=new RegExp("^("+i+"{"+a+"}.*?\\n?)*$"),d=new RegExp("^"+i+"{"+a+"}","gm"),e=[];b.length>0&&c.exec(b[0]);){var f=b.shift(),g=f.replace(d,"");e.push(n(g,f.trailing,f.lineNumber))}return e}function e(a,b,c){var d=a.list,e=d[d.length-1];if(!(e[1]instanceof Array&&"para"==e[1][0]))if(b+1==c.length)e.push(["para"].concat(e.splice(1,e.length-1)));else{var f=e.pop();e.push(["para"].concat(e.splice(1,e.length-1)),f)}}var f="[*+-]|\\d+\\.",g=/[*+-]/,h=new RegExp("^( {0,3})("+f+")[ 	]+"),i="(?: {0,3}\\t| {4})";return function(f,i){function j(a){var b=g.exec(a[2])?["bulletlist"]:["numberlist"];return n.push({list:b,indent:a[1]}),b}var k=f.match(h);if(!k)return void 0;for(var l,m,n=[],p=j(k),q=!1,r=[n[0].list];;){for(var s=f.split(/(?=\n)/),t="",u=0;u<s.length;u++){var v="",w=s[u].replace(/^\n/,function(a){return v=a,""}),x=a(n.length);if(k=w.match(x),void 0!==k[1]){t.length&&(c(l,q,this.processInline(t),v),q=!1,t=""),k[1]=b(k[1]);var y=Math.floor(k[1].length/4)+1;if(y>n.length)p=j(k),l.push(p),l=p[1]=["listitem"];else{var z=!1;for(m=0;m<n.length;m++)if(n[m].indent==k[1]){p=n[m].list,n.splice(m+1,n.length-(m+1)),z=!0;break}z||(y++,y<=n.length?(n.splice(y,n.length-y),p=n[y-1].list):(p=j(k),l.push(p))),l=["listitem"],p.push(l)}v=""}w.length>k[0].length&&(t+=v+w.substr(k[0].length))}t.length&&(c(l,q,this.processInline(t),v),q=!1,t="");var A=d(n.length,i);A.length>0&&(o(n,e,this),l.push.apply(l,this.toTree(A,[])));var B=i[0]&&i[0].valueOf()||"";if(!B.match(h)&&!B.match(/^ /))break;f=i.shift();var C=this.dialect.block.horizRule(f,i);if(C){r.push.apply(r,C);break}o(n,e,this),q=!0}return r}}(),blockquote:function(a,b){if(!a.match(/^>/m))return void 0;var c=[];if(">"!=a[0]){for(var d=a.split(/\n/),e=[],f=a.lineNumber;d.length&&">"!=d[0][0];)e.push(d.shift()),f++;var g=n(e.join("\n"),"\n",a.lineNumber);c.push.apply(c,this.processBlock(g,[])),a=n(d.join("\n"),a.trailing,f)}for(;b.length&&">"==b[0][0];){var i=b.shift();a=n(a+a.trailing+i,i.trailing,a.lineNumber)}var j=a.replace(/^> ?/gm,""),k=(this.tree,this.toTree(j,["blockquote"])),l=h(k);return l&&l.references&&(delete l.references,r(l)&&k.splice(1,1)),c.push(k),c},referenceDefn:function(a,b){var c=/^\s*\[(.*?)\]:\s*(\S+)(?:\s+(?:(['"])(.*?)\3|\((.*?)\)))?\n?/;if(!a.match(c))return void 0;h(this.tree)||this.tree.splice(1,0,{});var d=h(this.tree);void 0===d.references&&(d.references={});var e=this.loop_re_over_block(c,a,function(a){a[2]&&"<"==a[2][0]&&">"==a[2][a[2].length-1]&&(a[2]=a[2].substring(1,a[2].length-1));var b=d.references[a[1].toLowerCase()]={href:a[2]};void 0!==a[4]?b.title=a[4]:void 0!==a[5]&&(b.title=a[5])});return e.length&&b.unshift(n(e,a.trailing)),[]},para:function(a,b){return[["para"].concat(this.processInline(a))]}}},m.dialects.Gruber.inline={__oneElement__:function(a,b,c){var d,e;b=b||this.dialect.inline.__patterns__;var f=new RegExp("([\\s\\S]*?)("+(b.source||b)+")");if(d=f.exec(a),!d)return[a.length,a];if(d[1])return[d[1].length,d[1]];var e;return d[2]in this.dialect.inline&&(e=this.dialect.inline[d[2]].call(this,a.substr(d.index),d,c||[])),e=e||[d[2].length,d[2]]},__call__:function(a,b){function c(a){"string"==typeof a&&"string"==typeof e[e.length-1]?e[e.length-1]+=a:e.push(a)}for(var d,e=[];a.length>0;)d=this.dialect.inline.__oneElement__.call(this,a,b,e),a=a.substr(d.shift()),o(d,c);return e},"]":function(){},"}":function(){},__escape__:/^\\[\\`\*_{}\[\]()#\+.!\-]/,"\\":function(a){return this.dialect.inline.__escape__.exec(a)?[2,a.charAt(1)]:[1,"\\"]},"![":function(a){var b=a.match(/^!\[(.*?)\][ \t]*\([ \t]*([^")]*?)(?:[ \t]+(["'])(.*?)\3)?[ \t]*\)/);if(b){b[2]&&"<"==b[2][0]&&">"==b[2][b[2].length-1]&&(b[2]=b[2].substring(1,b[2].length-1)),b[2]=this.dialect.inline.__call__.call(this,b[2],/\\/)[0];var c={alt:b[1],href:b[2]||""};return void 0!==b[4]&&(c.title=b[4]),[b[0].length,["img",c]]}return b=a.match(/^!\[(.*?)\][ \t]*\[(.*?)\]/),b?[b[0].length,["img_ref",{alt:b[1],ref:b[2].toLowerCase(),original:b[0]}]]:[2,"!["]},"[":function s(a){var b=String(a),c=m.DialectHelpers.inline_until_char.call(this,a.substr(1),"]");if(!c)return[1,"["];var s,d,e=1+c[0],f=c[1];a=a.substr(e);var g=a.match(/^\s*\([ \t]*([^"']*)(?:[ \t]+(["'])(.*?)\2)?[ \t]*\)/);if(g){var h=g[1];if(e+=g[0].length,h&&"<"==h[0]&&">"==h[h.length-1]&&(h=h.substring(1,h.length-1)),!g[3])for(var i=1,j=0;j<h.length;j++)switch(h[j]){case"(":i++;break;case")":0==--i&&(e-=h.length-j,h=h.substring(0,j))}return h=this.dialect.inline.__call__.call(this,h,/\\/)[0],d={href:h||""},void 0!==g[3]&&(d.title=g[3]),s=["link",d].concat(f),[e,s]}return g=a.match(/^\s*\[(.*?)\]/),g?(e+=g[0].length,d={ref:(g[1]||String(f)).toLowerCase(),original:b.substr(0,e)},s=["link_ref",d].concat(f),[e,s]):1==f.length&&"string"==typeof f[0]?(d={ref:f[0].toLowerCase(),original:b.substr(0,e)},s=["link_ref",d,f[0]],[e,s]):[1,"["]},"<":function(a){var b;return null!=(b=a.match(/^<(?:((https?|ftp|mailto):[^>]+)|(.*?@.*?\.[a-zA-Z]+))>/))?b[3]?[b[0].length,["link",{href:"mailto:"+b[3]},b[3]]]:"mailto"==b[2]?[b[0].length,["link",{href:b[1]},b[1].substr("mailto:".length)]]:[b[0].length,["link",{href:b[1]},b[1]]]:[1,"<"]},"`":function(a){var b=a.match(/(`+)(([\s\S]*?)\1)/);return b&&b[2]?[b[1].length+b[2].length,["inlinecode",b[3]]]:[1,"`"]},"  \n":function(a){return[3,["linebreak"]]}},m.dialects.Gruber.inline["**"]=f("strong","**"),m.dialects.Gruber.inline.__=f("strong","__"),m.dialects.Gruber.inline["*"]=f("em","*"),m.dialects.Gruber.inline._=f("em","_"),m.buildBlockOrder=function(a){var b=[];for(var c in a)"__order__"!=c&&"__call__"!=c&&b.push(c);a.__order__=b},m.buildInlinePatterns=function(a){var b=[];for(var c in a)if(!c.match(/^__.*__$/)){var d=c.replace(/([\\.*+?|()\[\]{}])/g,"\\$1").replace(/\n/,"\\n");b.push(1==c.length?d:"(?:"+d+")")}b=b.join("|"),a.__patterns__=b;var e=a.__call__;a.__call__=function(a,c){return void 0!=c?e.call(this,a,c):e.call(this,a,b)}},m.DialectHelpers={},m.DialectHelpers.inline_until_char=function(a,b){for(var c=0,d=[];;){if(a.charAt(c)==b)return c++,[c,d];if(c>=a.length)return null;var e=this.dialect.inline.__oneElement__.call(this,a.substr(c));c+=e[0],d.push.apply(d,e.slice(1))}},m.subclassDialect=function(a){function b(){}function c(){}return b.prototype=a.block,c.prototype=a.inline,{block:new b,inline:new c}},m.buildBlockOrder(m.dialects.Gruber.block),m.buildInlinePatterns(m.dialects.Gruber.inline),m.dialects.Maruku=m.subclassDialect(m.dialects.Gruber),m.dialects.Maruku.processMetaHash=function(a){for(var b=g(a),c={},d=0;d<b.length;++d)if(/^#/.test(b[d]))c.id=b[d].substring(1);else if(/^\./.test(b[d]))c["class"]?c["class"]=c["class"]+b[d].replace(/./," "):c["class"]=b[d].substring(1);else if(/\=/.test(b[d])){var e=b[d].split(/\=/);c[e[0]]=e[1]}return c},m.dialects.Maruku.block.document_meta=function(a,b){if(a.lineNumber>1)return void 0;if(!a.match(/^(?:\w+:.*\n)*\w+:.*$/))return void 0;h(this.tree)||this.tree.splice(1,0,{});var c=a.split(/\n/);for(p in c){var d=c[p].match(/(\w+):\s*(.*)$/),e=d[1].toLowerCase(),f=d[2];this.tree[1][e]=f}return[]},m.dialects.Maruku.block.block_meta=function(b,c){var d=b.match(/(^|\n) {0,3}\{:\s*((?:\\\}|[^\}])*)\s*\}$/);if(!d)return void 0;var e,f=this.dialect.processMetaHash(d[2]);if(""===d[1]){var g=this.tree[this.tree.length-1];if(e=h(g),"string"==typeof g)return void 0;e||(e={},g.splice(1,0,e));for(a in f)e[a]=f[a];return[]}var i=b.replace(/\n.*$/,""),j=this.processBlock(i,[]);e=h(j[0]),e||(e={},j[0].splice(1,0,e));for(a in f)e[a]=f[a];return j},m.dialects.Maruku.block.definition_list=function(a,b){var c,d,e=/^((?:[^\s:].*\n)+):\s+([\s\S]+)$/,f=["dl"];if(!(d=a.match(e)))return void 0;for(var g=[a];b.length&&e.exec(b[0]);)g.push(b.shift());for(var h=0;h<g.length;++h){var d=g[h].match(e),i=d[1].replace(/\n$/,"").split(/\n/),j=d[2].split(/\n:\s+/);for(c=0;c<i.length;++c)f.push(["dt",i[c]]);for(c=0;c<j.length;++c)f.push(["dd"].concat(this.processInline(j[c].replace(/(\n)\s+/,"$1"))))}return[f]},m.dialects.Maruku.block.table=function t(a,b){var c,d,e=function(a,b){b=b||"\\s",b.match(/^[\\|\[\]{}?*.+^$]$/)&&(b="\\"+b);for(var c,d=[],e=new RegExp("^((?:\\\\.|[^\\\\"+b+"])*)"+b+"(.*)");c=a.match(e);)d.push(c[1]),a=c[2];return d.push(a),d},f=/^ {0,3}\|(.+)\n {0,3}\|\s*([\-:]+[\-| :]*)\n((?:\s*\|.*(?:\n|$))*)(?=\n|$)/,g=/^ {0,3}(\S(?:\\.|[^\\|])*\|.*)\n {0,3}([\-:]+\s*\|[\-| :]*)\n((?:(?:\\.|[^\\|])*\|.*(?:\n|$))*)(?=\n|$)/;if(d=a.match(f))d[3]=d[3].replace(/^\s*\|/gm,"");else if(!(d=a.match(g)))return void 0;var t=["table",["thead",["tr"]],["tbody"]];d[2]=d[2].replace(/\|\s*$/,"").split("|");var h=[];for(o(d[2],function(a){a.match(/^\s*-+:\s*$/)?h.push({align:"right"}):a.match(/^\s*:-+\s*$/)?h.push({align:"left"}):a.match(/^\s*:-+:\s*$/)?h.push({align:"center"}):h.push({})}),d[1]=e(d[1].replace(/\|\s*$/,""),"|"),c=0;c<d[1].length;c++)t[1][1].push(["th",h[c]||{}].concat(this.processInline(d[1][c].trim())));return o(d[3].replace(/\|\s*$/gm,"").split("\n"),function(a){var b=["tr"];for(a=e(a,"|"),c=0;c<a.length;c++)b.push(["td",h[c]||{}].concat(this.processInline(a[c].trim())));t[2].push(b)},this),[t]},m.dialects.Maruku.inline["{:"]=function(a,b,c){if(!c.length)return[2,"{:"];var d=c[c.length-1];if("string"==typeof d)return[2,"{:"];var e=a.match(/^\{:\s*((?:\\\}|[^\}])*)\s*\}/);if(!e)return[2,"{:"];var f=this.dialect.processMetaHash(e[1]),g=h(d);g||(g={},d.splice(1,0,g));for(var i in f)g[i]=f[i];return[e[0].length,""]},m.dialects.Maruku.inline.__escape__=/^\\[\\`\*_{}\[\]()#\+.!\-|:]/,m.buildBlockOrder(m.dialects.Maruku.block),m.buildInlinePatterns(m.dialects.Maruku.inline);var o,q=Array.isArray||function(a){return"[object Array]"==Object.prototype.toString.call(a)};o=Array.prototype.forEach?function(a,b,c){return a.forEach(b,c)}:function(a,b,c){for(var d=0;d<a.length;d++)b.call(c||a,a[d],d,a)};var r=function(a){for(var b in a)if(hasOwnProperty.call(a,b))return!1;return!0};b.renderJsonML=function(a,b){b=b||{},b.root=b.root||!1;var c=[];if(b.root)c.push(j(a));else for(a.shift(),!a.length||"object"!=typeof a[0]||a[0]instanceof Array||a.shift();a.length;)c.push(j(a.shift()));return c.join("\n\n")}}(function(){return"undefined"==typeof exports?(window.markdown={},window.markdown):exports}()),function(a){var b=function(){var b={years:"datepickerViewYears",moths:"datepickerViewMonths",days:"datepickerViewDays"},c={wrapper:'<div class="datepicker"><div class="datepickerBorderT" /><div class="datepickerBorderB" /><div class="datepickerBorderL" /><div class="datepickerBorderR" /><div class="datepickerBorderTL" /><div class="datepickerBorderTR" /><div class="datepickerBorderBL" /><div class="datepickerBorderBR" /><div class="datepickerContainer"><table cellspacing="0" cellpadding="0"><tbody><tr></tr></tbody></table></div></div>',head:["<td>",'<table cellspacing="0" cellpadding="0">',"<thead>","<tr>",'<th class="datepickerGoPrev"><a href="#"><span><%=prev%></span></a></th>','<th colspan="5" class="datepickerMonth"><a href="#"><span></span></a></th>','<th class="datepickerGoNext"><a href="#"><span><%=next%></span></a></th>',"</tr>",'<tr class="datepickerDoW">',"<th><span><%=week%></span></th>","<th><span><%=day1%></span></th>","<th><span><%=day2%></span></th>","<th><span><%=day3%></span></th>","<th><span><%=day4%></span></th>","<th><span><%=day5%></span></th>","<th><span><%=day6%></span></th>","<th><span><%=day7%></span></th>","</tr>","</thead>","</table></td>"],space:'<td class="datepickerSpace"><div></div></td>',days:['<tbody class="datepickerDays">',"<tr>",'<th class="datepickerWeek"><a href="#"><span><%=weeks[0].week%></span></a></th>','<td class="<%=weeks[0].days[0].classname%>"><a href="#"><span><%=weeks[0].days[0].text%></span></a></td>','<td class="<%=weeks[0].days[1].classname%>"><a href="#"><span><%=weeks[0].days[1].text%></span></a></td>','<td class="<%=weeks[0].days[2].classname%>"><a href="#"><span><%=weeks[0].days[2].text%></span></a></td>','<td class="<%=weeks[0].days[3].classname%>"><a href="#"><span><%=weeks[0].days[3].text%></span></a></td>','<td class="<%=weeks[0].days[4].classname%>"><a href="#"><span><%=weeks[0].days[4].text%></span></a></td>','<td class="<%=weeks[0].days[5].classname%>"><a href="#"><span><%=weeks[0].days[5].text%></span></a></td>','<td class="<%=weeks[0].days[6].classname%>"><a href="#"><span><%=weeks[0].days[6].text%></span></a></td>',"</tr>","<tr>",'<th class="datepickerWeek"><a href="#"><span><%=weeks[1].week%></span></a></th>','<td class="<%=weeks[1].days[0].classname%>"><a href="#"><span><%=weeks[1].days[0].text%></span></a></td>','<td class="<%=weeks[1].days[1].classname%>"><a href="#"><span><%=weeks[1].days[1].text%></span></a></td>','<td class="<%=weeks[1].days[2].classname%>"><a href="#"><span><%=weeks[1].days[2].text%></span></a></td>','<td class="<%=weeks[1].days[3].classname%>"><a href="#"><span><%=weeks[1].days[3].text%></span></a></td>','<td class="<%=weeks[1].days[4].classname%>"><a href="#"><span><%=weeks[1].days[4].text%></span></a></td>','<td class="<%=weeks[1].days[5].classname%>"><a href="#"><span><%=weeks[1].days[5].text%></span></a></td>','<td class="<%=weeks[1].days[6].classname%>"><a href="#"><span><%=weeks[1].days[6].text%></span></a></td>',"</tr>","<tr>",'<th class="datepickerWeek"><a href="#"><span><%=weeks[2].week%></span></a></th>','<td class="<%=weeks[2].days[0].classname%>"><a href="#"><span><%=weeks[2].days[0].text%></span></a></td>','<td class="<%=weeks[2].days[1].classname%>"><a href="#"><span><%=weeks[2].days[1].text%></span></a></td>','<td class="<%=weeks[2].days[2].classname%>"><a href="#"><span><%=weeks[2].days[2].text%></span></a></td>','<td class="<%=weeks[2].days[3].classname%>"><a href="#"><span><%=weeks[2].days[3].text%></span></a></td>','<td class="<%=weeks[2].days[4].classname%>"><a href="#"><span><%=weeks[2].days[4].text%></span></a></td>','<td class="<%=weeks[2].days[5].classname%>"><a href="#"><span><%=weeks[2].days[5].text%></span></a></td>','<td class="<%=weeks[2].days[6].classname%>"><a href="#"><span><%=weeks[2].days[6].text%></span></a></td>',"</tr>","<tr>",'<th class="datepickerWeek"><a href="#"><span><%=weeks[3].week%></span></a></th>','<td class="<%=weeks[3].days[0].classname%>"><a href="#"><span><%=weeks[3].days[0].text%></span></a></td>','<td class="<%=weeks[3].days[1].classname%>"><a href="#"><span><%=weeks[3].days[1].text%></span></a></td>','<td class="<%=weeks[3].days[2].classname%>"><a href="#"><span><%=weeks[3].days[2].text%></span></a></td>','<td class="<%=weeks[3].days[3].classname%>"><a href="#"><span><%=weeks[3].days[3].text%></span></a></td>','<td class="<%=weeks[3].days[4].classname%>"><a href="#"><span><%=weeks[3].days[4].text%></span></a></td>','<td class="<%=weeks[3].days[5].classname%>"><a href="#"><span><%=weeks[3].days[5].text%></span></a></td>','<td class="<%=weeks[3].days[6].classname%>"><a href="#"><span><%=weeks[3].days[6].text%></span></a></td>',"</tr>","<tr>",'<th class="datepickerWeek"><a href="#"><span><%=weeks[4].week%></span></a></th>','<td class="<%=weeks[4].days[0].classname%>"><a href="#"><span><%=weeks[4].days[0].text%></span></a></td>','<td class="<%=weeks[4].days[1].classname%>"><a href="#"><span><%=weeks[4].days[1].text%></span></a></td>','<td class="<%=weeks[4].days[2].classname%>"><a href="#"><span><%=weeks[4].days[2].text%></span></a></td>','<td class="<%=weeks[4].days[3].classname%>"><a href="#"><span><%=weeks[4].days[3].text%></span></a></td>','<td class="<%=weeks[4].days[4].classname%>"><a href="#"><span><%=weeks[4].days[4].text%></span></a></td>','<td class="<%=weeks[4].days[5].classname%>"><a href="#"><span><%=weeks[4].days[5].text%></span></a></td>','<td class="<%=weeks[4].days[6].classname%>"><a href="#"><span><%=weeks[4].days[6].text%></span></a></td>',"</tr>","<tr>",'<th class="datepickerWeek"><a href="#"><span><%=weeks[5].week%></span></a></th>','<td class="<%=weeks[5].days[0].classname%>"><a href="#"><span><%=weeks[5].days[0].text%></span></a></td>','<td class="<%=weeks[5].days[1].classname%>"><a href="#"><span><%=weeks[5].days[1].text%></span></a></td>','<td class="<%=weeks[5].days[2].classname%>"><a href="#"><span><%=weeks[5].days[2].text%></span></a></td>','<td class="<%=weeks[5].days[3].classname%>"><a href="#"><span><%=weeks[5].days[3].text%></span></a></td>','<td class="<%=weeks[5].days[4].classname%>"><a href="#"><span><%=weeks[5].days[4].text%></span></a></td>','<td class="<%=weeks[5].days[5].classname%>"><a href="#"><span><%=weeks[5].days[5].text%></span></a></td>','<td class="<%=weeks[5].days[6].classname%>"><a href="#"><span><%=weeks[5].days[6].text%></span></a></td>',"</tr>","</tbody>"],months:['<tbody class="<%=className%>">',"<tr>",'<td colspan="2"><a href="#"><span><%=data[0]%></span></a></td>','<td colspan="2"><a href="#"><span><%=data[1]%></span></a></td>','<td colspan="2"><a href="#"><span><%=data[2]%></span></a></td>','<td colspan="2"><a href="#"><span><%=data[3]%></span></a></td>',"</tr>","<tr>",'<td colspan="2"><a href="#"><span><%=data[4]%></span></a></td>','<td colspan="2"><a href="#"><span><%=data[5]%></span></a></td>','<td colspan="2"><a href="#"><span><%=data[6]%></span></a></td>','<td colspan="2"><a href="#"><span><%=data[7]%></span></a></td>',"</tr>","<tr>",'<td colspan="2"><a href="#"><span><%=data[8]%></span></a></td>','<td colspan="2"><a href="#"><span><%=data[9]%></span></a></td>','<td colspan="2"><a href="#"><span><%=data[10]%></span></a></td>','<td colspan="2"><a href="#"><span><%=data[11]%></span></a></td>',"</tr>","</tbody>"]},d={flat:!1,starts:1,prev:"&#9664;",next:"&#9654;",lastSel:!1,mode:"single",view:"days",calendars:1,format:"Y-m-d",position:"bottom",eventName:"click",onRender:function(){return{}},onChange:function(){return!0},onShow:function(){return!0},onBeforeShow:function(){return!0},onHide:function(){return!0},locale:{days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],daysShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun"],daysMin:["Su","Mo","Tu","We","Th","Fr","Sa","Su"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],monthsShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],weekMin:"wk"}},e=function(b){var d,e,f,h,i,j,k,l,m,n=a(b).data("datepicker"),o=a(b),p=Math.floor(n.calendars/2),q=0;
o.find("td>table tbody").remove();for(var r=0;r<n.calendars;r++){switch(d=new Date(n.current),d.addMonths(-p+r),m=o.find("table").eq(r+1),m[0].className){case"datepickerViewDays":f=g(d,"B, Y");break;case"datepickerViewMonths":f=d.getFullYear();break;case"datepickerViewYears":f=d.getFullYear()-6+" - "+(d.getFullYear()+5)}m.find("thead tr:first th:eq(1) span").text(f),f=d.getFullYear()-6,e={data:[],className:"datepickerYears"};for(var s=0;12>s;s++)e.data.push(f+s);l=tmpl(c.months.join(""),e),d.setDate(1),e={weeks:[],test:10},h=d.getMonth();var f=(d.getDay()-n.starts)%7;for(d.addDays(-(f+(0>f?7:0))),i=-1,q=0;42>q;){j=parseInt(q/7,10),k=q%7,e.weeks[j]||(i=d.getWeekNumber(),e.weeks[j]={week:i,days:[]}),e.weeks[j].days[k]={text:d.getDate(),classname:[]},h!=d.getMonth()&&e.weeks[j].days[k].classname.push("datepickerNotInMonth"),0==d.getDay()&&e.weeks[j].days[k].classname.push("datepickerSunday"),6==d.getDay()&&e.weeks[j].days[k].classname.push("datepickerSaturday");var t=n.onRender(d),u=d.valueOf();u===n.date[0]&&e.weeks[j].days[k].classname.push("datepickerSelectedFirst"),u+86399e3===n.date[1]&&e.weeks[j].days[k].classname.push("datepickerSelectedLast"),(t.selected||n.date==u||a.inArray(u,n.date)>-1||"range"==n.mode&&u>=n.date[0]&&u<=n.date[1])&&e.weeks[j].days[k].classname.push("datepickerSelected"),t.disabled&&e.weeks[j].days[k].classname.push("datepickerDisabled"),t.className&&e.weeks[j].days[k].classname.push(t.className),e.weeks[j].days[k].classname=e.weeks[j].days[k].classname.join(" "),q++,d.addDays(1)}l=tmpl(c.days.join(""),e)+l,e={data:n.locale.monthsShort,className:"datepickerMonths"},l=tmpl(c.months.join(""),e)+l,m.append(l)}},f=function(a,b){if(a.constructor==Date)return new Date(a);for(var c,d,e,f,g,h=a.split(/\W+/),i=b.split(/\W+/),j=new Date,k=0;k<h.length;k++)switch(i[k]){case"d":case"e":c=parseInt(h[k],10);break;case"m":d=parseInt(h[k],10)-1;break;case"Y":case"y":e=parseInt(h[k],10),e+=e>100?0:29>e?2e3:1900;break;case"H":case"I":case"k":case"l":f=parseInt(h[k],10);break;case"P":case"p":/pm/i.test(h[k])&&12>f?f+=12:/am/i.test(h[k])&&f>=12&&(f-=12);break;case"M":g=parseInt(h[k],10)}return new Date(void 0===e?j.getFullYear():e,void 0===d?j.getMonth():d,void 0===c?j.getDate():c,void 0===f?j.getHours():f,void 0===g?j.getMinutes():g,0)},g=function(a,b){var c=a.getMonth(),d=a.getDate(),e=a.getFullYear(),f=(a.getWeekNumber(),a.getDay()),g=a.getHours(),h=g>=12,i=h?g-12:g,j=a.getDayOfYear();0==i&&(i=12);for(var k,l=a.getMinutes(),m=a.getSeconds(),n=b.split(""),o=0;o<n.length;o++){switch(k=n[o],n[o]){case"a":k=a.getDayName();break;case"A":k=a.getDayName(!0);break;case"b":k=a.getMonthName();break;case"B":k=a.getMonthName(!0);break;case"C":k=1+Math.floor(e/100);break;case"d":k=10>d?"0"+d:d;break;case"e":k=d;break;case"H":k=10>g?"0"+g:g;break;case"I":k=10>i?"0"+i:i;break;case"j":k=100>j?10>j?"00"+j:"0"+j:j;break;case"k":k=g;break;case"l":k=i;break;case"m":k=9>c?"0"+(1+c):1+c;break;case"M":k=10>l?"0"+l:l;break;case"p":case"P":k=h?"PM":"AM";break;case"s":k=Math.floor(a.getTime()/1e3);break;case"S":k=10>m?"0"+m:m;break;case"u":k=f+1;break;case"w":k=f;break;case"y":k=(""+e).substr(2,2);break;case"Y":k=e}n[o]=k}return n.join("")},h=function(a){Date.prototype.tempDate||(Date.prototype.tempDate=null,Date.prototype.months=a.months,Date.prototype.monthsShort=a.monthsShort,Date.prototype.days=a.days,Date.prototype.daysShort=a.daysShort,Date.prototype.getMonthName=function(a){return this[a?"months":"monthsShort"][this.getMonth()]},Date.prototype.getDayName=function(a){return this[a?"days":"daysShort"][this.getDay()]},Date.prototype.addDays=function(a){this.setDate(this.getDate()+a),this.tempDate=this.getDate()},Date.prototype.addMonths=function(a){null==this.tempDate&&(this.tempDate=this.getDate()),this.setDate(1),this.setMonth(this.getMonth()+a),this.setDate(Math.min(this.tempDate,this.getMaxDays()))},Date.prototype.addYears=function(a){null==this.tempDate&&(this.tempDate=this.getDate()),this.setDate(1),this.setFullYear(this.getFullYear()+a),this.setDate(Math.min(this.tempDate,this.getMaxDays()))},Date.prototype.getMaxDays=function(){var a,b=new Date(Date.parse(this)),c=28;for(a=b.getMonth(),c=28;b.getMonth()==a;)c++,b.setDate(c);return c-1},Date.prototype.getFirstDay=function(){var a=new Date(Date.parse(this));return a.setDate(1),a.getDay()},Date.prototype.getWeekNumber=function(){var a=new Date(this);a.setDate(a.getDate()-(a.getDay()+6)%7+3);var b=a.valueOf();return a.setMonth(0),a.setDate(4),Math.round((b-a.valueOf())/6048e5)+1},Date.prototype.getDayOfYear=function(){var a=new Date(this.getFullYear(),this.getMonth(),this.getDate(),0,0,0),b=new Date(this.getFullYear(),0,0,0,0,0),c=a-b;return Math.floor(c/24*60*60*1e3)})},i=function(b){var c=a(b).data("datepicker"),d=a("#"+c.id);if(!c.extraHeight){var e=a(b).find("div");c.extraHeight=e.get(0).offsetHeight+e.get(1).offsetHeight,c.extraWidth=e.get(2).offsetWidth+e.get(3).offsetWidth}var f=d.find("table:first").get(0),g=f.offsetWidth,h=f.offsetHeight;d.css({width:g+c.extraWidth+"px",height:h+c.extraHeight+"px"}).find("div.datepickerContainer").css({width:g+"px",height:h+"px"})},j=function(b){a(b.target).is("span")&&(b.target=b.target.parentNode);var c=a(b.target);if(c.is("a")){if(b.target.blur(),c.hasClass("datepickerDisabled"))return!1;var d=a(this).data("datepicker"),f=c.parent(),g=f.parent().parent().parent(),h=a("table",this).index(g.get(0))-1,i=new Date(d.current),j=!1,l=!1;if(f.is("th"))if(f.hasClass("datepickerWeek")&&"range"==d.mode&&!f.next().hasClass("datepickerDisabled")){var m=parseInt(f.next().text(),10);i.addMonths(h-Math.floor(d.calendars/2)),f.next().hasClass("datepickerNotInMonth")&&i.addMonths(m>15?-1:1),i.setDate(m),d.date[0]=i.setHours(0,0,0,0).valueOf(),i.setHours(23,59,59,0),i.addDays(6),d.date[1]=i.valueOf(),l=!0,j=!0,d.lastSel=!1}else{if(f.hasClass("datepickerMonth"))return!1;if(f.parent().parent().is("thead")){switch(g.get(0).className){case"datepickerViewDays":d.current.addMonths(f.hasClass("datepickerGoPrev")?-1:1);break;case"datepickerViewMonths":d.current.addYears(f.hasClass("datepickerGoPrev")?-1:1);break;case"datepickerViewYears":d.current.addYears(f.hasClass("datepickerGoPrev")?-12:12)}l=!0}}else if(f.is("td")&&!f.hasClass("datepickerDisabled")){switch(g.get(0).className){case"datepickerViewMonths":d.current.setMonth(g.find("tbody.datepickerMonths td").index(f)),d.current.setFullYear(parseInt(g.find("thead th.datepickerMonth span").text(),10)),d.current.addMonths(Math.floor(d.calendars/2)-h),g.get(0).className="datepickerViewDays";break;case"datepickerViewYears":d.current.setFullYear(parseInt(c.text(),10)),g.get(0).className="datepickerViewMonths";break;default:var m=parseInt(c.text(),10);switch(i.addMonths(h-Math.floor(d.calendars/2)),f.hasClass("datepickerNotInMonth")&&i.addMonths(m>15?-1:1),i.setDate(m),d.mode){case"multiple":m=i.setHours(0,0,0,0).valueOf(),a.inArray(m,d.date)>-1?a.each(d.date,function(a,b){return b==m?(d.date.splice(a,1),!1):void 0}):d.date.push(m);break;case"range":d.lastSel||(d.date[0]=i.setHours(0,0,0,0).valueOf()),m=i.setHours(23,59,59,0).valueOf(),m<d.date[0]?(d.date[1]=d.date[0]+86399e3,d.date[0]=m-86399e3):d.date[1]=m,d.lastSel=!d.lastSel;break;default:d.date=i.valueOf()}}l=!0,j=!0}l&&e(this),j&&d.onChange.apply(this,k(d))}return!1},k=function(b){var c;return"single"==b.mode?(c=new Date(b.date),[g(c,b.format),c,b.el]):(c=[[],[],b.el],a.each(b.date,function(a,d){var e=new Date(d);c[0].push(g(e,b.format)),c[1].push(e)}),c)},l=function(){var a="CSS1Compat"==document.compatMode;return{l:window.pageXOffset||(a?document.documentElement.scrollLeft:document.body.scrollLeft),t:window.pageYOffset||(a?document.documentElement.scrollTop:document.body.scrollTop),w:window.innerWidth||(a?document.documentElement.clientWidth:document.body.clientWidth),h:window.innerHeight||(a?document.documentElement.clientHeight:document.body.clientHeight)}},m=function(a,b,c){if(a==b)return!0;if(a.contains)return a.contains(b);if(a.compareDocumentPosition)return!!(16&a.compareDocumentPosition(b));for(var d=b.parentNode;d&&d!=c;){if(d==a)return!0;d=d.parentNode}return!1},n=function(b){var c=a("#"+a(this).data("datepickerId"));if(!c.is(":visible")){var d=c.get(0);e(d);var f=c.data("datepicker");f.onBeforeShow.apply(this,[c.get(0)]);var g=a(this).offset(),h=l(),j=g.top,k=g.left;a.curCSS(d,"display");switch(c.css({visibility:"hidden",display:"block"}),i(d),f.position){case"top":j-=d.offsetHeight;break;case"left":k-=d.offsetWidth;break;case"right":k+=this.offsetWidth;break;case"bottom":j+=this.offsetHeight}j+d.offsetHeight>h.t+h.h&&(j=g.top-d.offsetHeight),j<h.t&&(j=g.top+this.offsetHeight+d.offsetHeight),k+d.offsetWidth>h.l+h.w&&(k=g.left-d.offsetWidth),k<h.l&&(k=g.left+this.offsetWidth),c.css({visibility:"visible",display:"block",top:j+"px",left:k+"px"}),0!=f.onShow.apply(this,[c.get(0)])&&c.show(),a(document).bind("mousedown",{cal:c,trigger:this},o)}return!1},o=function(b){b.target==b.data.trigger||m(b.data.cal.get(0),b.target,b.data.cal.get(0))||(0!=b.data.cal.data("datepicker").onHide.apply(this,[b.data.cal.get(0)])&&b.data.cal.hide(),a(document).unbind("mousedown",o))};return{init:function(g){return g=a.extend({},d,g||{}),h(g.locale),g.calendars=Math.max(1,parseInt(g.calendars,10)||1),g.mode=/single|multiple|range/.test(g.mode)?g.mode:"single",this.each(function(){if(!a(this).data("datepicker")){if(g.el=this,g.date.constructor==String&&(g.date=f(g.date,g.format),g.date.setHours(0,0,0,0)),"single"!=g.mode)if(g.date.constructor!=Array)g.date=[g.date.valueOf()],"range"==g.mode&&g.date.push(new Date(g.date[0]).setHours(23,59,59,0).valueOf());else{for(var d=0;d<g.date.length;d++)g.date[d]=f(g.date[d],g.format).setHours(0,0,0,0).valueOf();"range"==g.mode&&(g.date[1]=new Date(g.date[1]).setHours(23,59,59,0).valueOf())}else g.date=g.date.valueOf();g.current?g.current=f(g.current,g.format):g.current=new Date,g.current.setDate(1),g.current.setHours(0,0,0,0);var h,k="datepicker_"+parseInt(1e3*Math.random());g.id=k,a(this).data("datepickerId",g.id);var l=a(c.wrapper).attr("id",k).bind("click",j).data("datepicker",g);g.className&&l.addClass(g.className);for(var m="",d=0;d<g.calendars;d++)h=g.starts,d>0&&(m+=c.space),m+=tmpl(c.head.join(""),{week:g.locale.weekMin,prev:g.prev,next:g.next,day1:g.locale.daysMin[h++%7],day2:g.locale.daysMin[h++%7],day3:g.locale.daysMin[h++%7],day4:g.locale.daysMin[h++%7],day5:g.locale.daysMin[h++%7],day6:g.locale.daysMin[h++%7],day7:g.locale.daysMin[h++%7]});l.find("tr:first").append(m).find("table").addClass(b[g.view]),e(l.get(0)),g.flat?(l.appendTo(this).show().css("position","relative"),i(l.get(0))):(l.appendTo(document.body),a(this).bind(g.eventName,n))}})},showPicker:function(){return this.each(function(){a(this).data("datepickerId")&&n.apply(this)})},hidePicker:function(){return this.each(function(){a(this).data("datepickerId")&&a("#"+a(this).data("datepickerId")).hide()})},setDate:function(b,c){return this.each(function(){if(a(this).data("datepickerId")){var d=a("#"+a(this).data("datepickerId")),g=d.data("datepicker");if(g.date=b,g.date.constructor==String&&(g.date=f(g.date,g.format),g.date.setHours(0,0,0,0)),"single"!=g.mode)if(g.date.constructor!=Array)g.date=[g.date.valueOf()],"range"==g.mode&&g.date.push(new Date(g.date[0]).setHours(23,59,59,0).valueOf());else{for(var h=0;h<g.date.length;h++)g.date[h]=f(g.date[h],g.format).setHours(0,0,0,0).valueOf();"range"==g.mode&&(g.date[1]=new Date(g.date[1]).setHours(23,59,59,0).valueOf())}else g.date=g.date.valueOf();c&&(g.current=new Date("single"!=g.mode?g.date[0]:g.date)),e(d.get(0))}})},getDate:function(b){return this.size()>0?k(a("#"+a(this).data("datepickerId")).data("datepicker"))[b?0:1]:void 0},clear:function(){return this.each(function(){if(a(this).data("datepickerId")){var b=a("#"+a(this).data("datepickerId")),c=b.data("datepicker");"single"!=c.mode&&(c.date=[],e(b.get(0)))}})},fixLayout:function(){return this.each(function(){if(a(this).data("datepickerId")){var b=a("#"+a(this).data("datepickerId")),c=b.data("datepicker");c.flat&&i(b.get(0))}})}}}();a.fn.extend({DatePicker:b.init,DatePickerHide:b.hidePicker,DatePickerShow:b.showPicker,DatePickerSetDate:b.setDate,DatePickerGetDate:b.getDate,DatePickerClear:b.clear,DatePickerLayout:b.fixLayout})}(jQuery),function(){var a={};this.tmpl=function b(c,d){var e=/\W/.test(c)?new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+c.replace(/[\r\t\n]/g," ").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):a[c]=a[c]||b(document.getElementById(c).innerHTML);return d?e(d):e}}(),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}};a=function(){function a(a){this.el=a,this.dragleave=b(this.dragleave,this),this.dragenter=b(this.dragenter,this),this.supportsEventConstructors()&&(this.first=!1,this.second=!1,this.el.addEventListener("dragenter",this.dragenter,!1),this.el.addEventListener("dragleave",this.dragleave,!1))}return a.prototype.dragenter=function(a){return this.first?this.second=!0:(this.first=!0,this.el.dispatchEvent(new CustomEvent("dragster:enter",{bubbles:!0,cancelable:!0,detail:{dataTransfer:a.dataTransfer}})))},a.prototype.dragleave=function(a){return this.second?this.second=!1:this.first&&(this.first=!1),this.first||this.second?void 0:this.el.dispatchEvent(new CustomEvent("dragster:leave",{bubbles:!0,cancelable:!0,detail:{dataTransfer:a.dataTransfer}}))},a.prototype.removeListeners=function(){return this.el.removeEventListener("dragenter",this.dragenter,!1),this.el.removeEventListener("dragleave",this.dragleave,!1)},a.prototype.supportsEventConstructors=function(){try{new CustomEvent("z")}catch(a){return!1}return!0},a.prototype.reset=function(){return this.first=!1,this.second=!1},a}(),window.Dragster=a}.call(this),function(){var a,b,c,d,e,f,g,h,i=[].slice,j={}.hasOwnProperty,k=function(a,b){function c(){this.constructor=a}for(var d in b)j.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};g=function(){},b=function(){function a(){}return a.prototype.addEventListener=a.prototype.on,a.prototype.on=function(a,b){return this._callbacks=this._callbacks||{},this._callbacks[a]||(this._callbacks[a]=[]),this._callbacks[a].push(b),this},a.prototype.emit=function(){var a,b,c,d,e,f;if(d=arguments[0],a=2<=arguments.length?i.call(arguments,1):[],this._callbacks=this._callbacks||{},c=this._callbacks[d])for(e=0,f=c.length;f>e;e++)b=c[e],b.apply(this,a);return this},a.prototype.removeListener=a.prototype.off,a.prototype.removeAllListeners=a.prototype.off,a.prototype.removeEventListener=a.prototype.off,a.prototype.off=function(a,b){var c,d,e,f,g;if(!this._callbacks||0===arguments.length)return this._callbacks={},this;if(d=this._callbacks[a],!d)return this;if(1===arguments.length)return delete this._callbacks[a],this;for(e=f=0,g=d.length;g>f;e=++f)if(c=d[e],c===b){d.splice(e,1);break}return this},a}(),a=function(a){function c(a,b){var e,f,g;if(this.element=a,this.version=c.version,this.defaultOptions.previewTemplate=this.defaultOptions.previewTemplate.replace(/\n*/g,""),this.clickableElements=[],this.listeners=[],this.files=[],"string"==typeof this.element&&(this.element=document.querySelector(this.element)),!this.element||null==this.element.nodeType)throw new Error("Invalid dropzone element.");if(this.element.dropzone)throw new Error("Dropzone already attached.");if(c.instances.push(this),this.element.dropzone=this,e=null!=(g=c.optionsForElement(this.element))?g:{},this.options=d({},this.defaultOptions,e,null!=b?b:{}),this.options.forceFallback||!c.isBrowserSupported())return this.options.fallback.call(this);if(null==this.options.url&&(this.options.url=this.element.getAttribute("action")),!this.options.url)throw new Error("No URL provided.");if(this.options.acceptedFiles&&this.options.acceptedMimeTypes)throw new Error("You can't provide both 'acceptedFiles' and 'acceptedMimeTypes'. 'acceptedMimeTypes' is deprecated.");this.options.acceptedMimeTypes&&(this.options.acceptedFiles=this.options.acceptedMimeTypes,delete this.options.acceptedMimeTypes),this.options.method=this.options.method.toUpperCase(),(f=this.getExistingFallback())&&f.parentNode&&f.parentNode.removeChild(f),this.options.previewsContainer!==!1&&(this.options.previewsContainer?this.previewsContainer=c.getElement(this.options.previewsContainer,"previewsContainer"):this.previewsContainer=this.element),this.options.clickable&&(this.options.clickable===!0?this.clickableElements=[this.element]:this.clickableElements=c.getElements(this.options.clickable,"clickable")),this.init()}var d,e;return k(c,a),c.prototype.Emitter=b,c.prototype.events=["drop","dragstart","dragend","dragenter","dragover","dragleave","addedfile","removedfile","thumbnail","error","errormultiple","processing","processingmultiple","uploadprogress","totaluploadprogress","sending","sendingmultiple","success","successmultiple","canceled","canceledmultiple","complete","completemultiple","reset","maxfilesexceeded","maxfilesreached","queuecomplete"],c.prototype.defaultOptions={url:null,method:"post",withCredentials:!1,parallelUploads:2,uploadMultiple:!1,maxFilesize:256,paramName:"file",createImageThumbnails:!0,maxThumbnailFilesize:10,thumbnailWidth:120,thumbnailHeight:120,filesizeBase:1e3,maxFiles:null,filesizeBase:1e3,params:{},clickable:!0,ignoreHiddenFiles:!0,acceptedFiles:null,acceptedMimeTypes:null,autoProcessQueue:!0,autoQueue:!0,addRemoveLinks:!1,previewsContainer:null,capture:null,dictDefaultMessage:"Drop files here to upload",dictFallbackMessage:"Your browser does not support drag'n'drop file uploads.",dictFallbackText:"Please use the fallback form below to upload your files like in the olden days.",dictFileTooBig:"File is too big ({{filesize}}MiB). Max filesize: {{maxFilesize}}MiB.",dictInvalidFileType:"You can't upload files of this type.",dictResponseError:"Server responded with {{statusCode}} code.",dictCancelUpload:"Cancel upload",dictCancelUploadConfirmation:"Are you sure you want to cancel this upload?",dictRemoveFile:"Remove file",dictRemoveFileConfirmation:null,dictMaxFilesExceeded:"You can not upload any more files.",accept:function(a,b){return b()},init:function(){return g},forceFallback:!1,fallback:function(){var a,b,d,e,f,g;for(this.element.className=""+this.element.className+" dz-browser-not-supported",g=this.element.getElementsByTagName("div"),e=0,f=g.length;f>e;e++)a=g[e],/(^| )dz-message($| )/.test(a.className)&&(b=a,a.className="dz-message");return b||(b=c.createElement('<div class="dz-message"><span></span></div>'),this.element.appendChild(b)),d=b.getElementsByTagName("span")[0],d&&(d.textContent=this.options.dictFallbackMessage),this.element.appendChild(this.getFallbackForm())},resize:function(a){var b,c,d;return b={srcX:0,srcY:0,srcWidth:a.width,srcHeight:a.height},c=a.width/a.height,b.optWidth=this.options.thumbnailWidth,b.optHeight=this.options.thumbnailHeight,null==b.optWidth&&null==b.optHeight?(b.optWidth=b.srcWidth,b.optHeight=b.srcHeight):null==b.optWidth?b.optWidth=c*b.optHeight:null==b.optHeight&&(b.optHeight=1/c*b.optWidth),d=b.optWidth/b.optHeight,a.height<b.optHeight||a.width<b.optWidth?(b.trgHeight=b.srcHeight,b.trgWidth=b.srcWidth):c>d?(b.srcHeight=a.height,b.srcWidth=b.srcHeight*d):(b.srcWidth=a.width,b.srcHeight=b.srcWidth/d),b.srcX=(a.width-b.srcWidth)/2,b.srcY=(a.height-b.srcHeight)/2,b},drop:function(a){return this.element.classList.remove("dz-drag-hover")},dragstart:g,dragend:function(a){return this.element.classList.remove("dz-drag-hover")},dragenter:function(a){return this.element.classList.add("dz-drag-hover")},dragover:function(a){return this.element.classList.add("dz-drag-hover")},dragleave:function(a){return this.element.classList.remove("dz-drag-hover")},paste:g,reset:function(){return this.element.classList.remove("dz-started")},addedfile:function(a){var b,d,e,f,g,h,i,j,k,l,m,n,o;if(this.element===this.previewsContainer&&this.element.classList.add("dz-started"),this.previewsContainer){for(a.previewElement=c.createElement(this.options.previewTemplate.trim()),a.previewTemplate=a.previewElement,this.previewsContainer.appendChild(a.previewElement),l=a.previewElement.querySelectorAll("[data-dz-name]"),f=0,i=l.length;i>f;f++)b=l[f],b.textContent=a.name;for(m=a.previewElement.querySelectorAll("[data-dz-size]"),g=0,j=m.length;j>g;g++)b=m[g],b.innerHTML=this.filesize(a.size);for(this.options.addRemoveLinks&&(a._removeLink=c.createElement('<a class="dz-remove" href="javascript:undefined;" data-dz-remove>'+this.options.dictRemoveFile+"</a>"),a.previewElement.appendChild(a._removeLink)),d=function(b){return function(d){return d.preventDefault(),d.stopPropagation(),a.status===c.UPLOADING?c.confirm(b.options.dictCancelUploadConfirmation,function(){return b.removeFile(a)}):b.options.dictRemoveFileConfirmation?c.confirm(b.options.dictRemoveFileConfirmation,function(){return b.removeFile(a)}):b.removeFile(a)}}(this),n=a.previewElement.querySelectorAll("[data-dz-remove]"),o=[],h=0,k=n.length;k>h;h++)e=n[h],o.push(e.addEventListener("click",d));return o}},removedfile:function(a){var b;return a.previewElement&&null!=(b=a.previewElement)&&b.parentNode.removeChild(a.previewElement),this._updateMaxFilesReachedClass()},thumbnail:function(a,b){var c,d,e,f;if(a.previewElement){for(a.previewElement.classList.remove("dz-file-preview"),f=a.previewElement.querySelectorAll("[data-dz-thumbnail]"),d=0,e=f.length;e>d;d++)c=f[d],c.alt=a.name,c.src=b;return setTimeout(function(b){return function(){return a.previewElement.classList.add("dz-image-preview")}}(this),1)}},error:function(a,b){var c,d,e,f,g;if(a.previewElement){for(a.previewElement.classList.add("dz-error"),"String"!=typeof b&&b.error&&(b=b.error),f=a.previewElement.querySelectorAll("[data-dz-errormessage]"),g=[],d=0,e=f.length;e>d;d++)c=f[d],g.push(c.textContent=b);return g}},errormultiple:g,processing:function(a){return a.previewElement&&(a.previewElement.classList.add("dz-processing"),a._removeLink)?a._removeLink.textContent=this.options.dictCancelUpload:void 0},processingmultiple:g,uploadprogress:function(a,b,c){var d,e,f,g,h;if(a.previewElement){for(g=a.previewElement.querySelectorAll("[data-dz-uploadprogress]"),h=[],e=0,f=g.length;f>e;e++)d=g[e],"PROGRESS"===d.nodeName?h.push(d.value=b):h.push(d.style.width=""+b+"%");return h}},totaluploadprogress:g,sending:g,sendingmultiple:g,success:function(a){return a.previewElement?a.previewElement.classList.add("dz-success"):void 0},successmultiple:g,canceled:function(a){return this.emit("error",a,"Upload canceled.")},canceledmultiple:g,complete:function(a){return a._removeLink&&(a._removeLink.textContent=this.options.dictRemoveFile),a.previewElement?a.previewElement.classList.add("dz-complete"):void 0},completemultiple:g,maxfilesexceeded:g,maxfilesreached:g,queuecomplete:g,previewTemplate:'<div class="dz-preview dz-file-preview">\n  <div class="dz-image"><img data-dz-thumbnail /></div>\n  <div class="dz-details">\n    <div class="dz-size"><span data-dz-size></span></div>\n    <div class="dz-filename"><span data-dz-name></span></div>\n  </div>\n  <div class="dz-progress"><span class="dz-upload" data-dz-uploadprogress></span></div>\n  <div class="dz-error-message"><span data-dz-errormessage></span></div>\n  <div class="dz-success-mark">\n    <svg width="54px" height="54px" viewBox="0 0 54 54" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">\n      <title>Check</title>\n      <defs></defs>\n      <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" sketch:type="MSPage">\n        <path d="M23.5,31.8431458 L17.5852419,25.9283877 C16.0248253,24.3679711 13.4910294,24.366835 11.9289322,25.9289322 C10.3700136,27.4878508 10.3665912,30.0234455 11.9283877,31.5852419 L20.4147581,40.0716123 C20.5133999,40.1702541 20.6159315,40.2626649 20.7218615,40.3488435 C22.2835669,41.8725651 24.794234,41.8626202 26.3461564,40.3106978 L43.3106978,23.3461564 C44.8771021,21.7797521 44.8758057,19.2483887 43.3137085,17.6862915 C41.7547899,16.1273729 39.2176035,16.1255422 37.6538436,17.6893022 L23.5,31.8431458 Z M27,53 C41.3594035,53 53,41.3594035 53,27 C53,12.6405965 41.3594035,1 27,1 C12.6405965,1 1,12.6405965 1,27 C1,41.3594035 12.6405965,53 27,53 Z" id="Oval-2" stroke-opacity="0.198794158" stroke="#747474" fill-opacity="0.816519475" fill="#FFFFFF" sketch:type="MSShapeGroup"></path>\n      </g>\n    </svg>\n  </div>\n  <div class="dz-error-mark">\n    <svg width="54px" height="54px" viewBox="0 0 54 54" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">\n      <title>Error</title>\n      <defs></defs>\n      <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" sketch:type="MSPage">\n        <g id="Check-+-Oval-2" sketch:type="MSLayerGroup" stroke="#747474" stroke-opacity="0.198794158" fill="#FFFFFF" fill-opacity="0.816519475">\n          <path d="M32.6568542,29 L38.3106978,23.3461564 C39.8771021,21.7797521 39.8758057,19.2483887 38.3137085,17.6862915 C36.7547899,16.1273729 34.2176035,16.1255422 32.6538436,17.6893022 L27,23.3431458 L21.3461564,17.6893022 C19.7823965,16.1255422 17.2452101,16.1273729 15.6862915,17.6862915 C14.1241943,19.2483887 14.1228979,21.7797521 15.6893022,23.3461564 L21.3431458,29 L15.6893022,34.6538436 C14.1228979,36.2202479 14.1241943,38.7516113 15.6862915,40.3137085 C17.2452101,41.8726271 19.7823965,41.8744578 21.3461564,40.3106978 L27,34.6568542 L32.6538436,40.3106978 C34.2176035,41.8744578 36.7547899,41.8726271 38.3137085,40.3137085 C39.8758057,38.7516113 39.8771021,36.2202479 38.3106978,34.6538436 L32.6568542,29 Z M27,53 C41.3594035,53 53,41.3594035 53,27 C53,12.6405965 41.3594035,1 27,1 C12.6405965,1 1,12.6405965 1,27 C1,41.3594035 12.6405965,53 27,53 Z" id="Oval-2" sketch:type="MSShapeGroup"></path>\n        </g>\n      </g>\n    </svg>\n  </div>\n</div>'},d=function(){var a,b,c,d,e,f,g;for(d=arguments[0],c=2<=arguments.length?i.call(arguments,1):[],f=0,g=c.length;g>f;f++){b=c[f];for(a in b)e=b[a],d[a]=e}return d},c.prototype.getAcceptedFiles=function(){var a,b,c,d,e;for(d=this.files,e=[],b=0,c=d.length;c>b;b++)a=d[b],a.accepted&&e.push(a);return e},c.prototype.getRejectedFiles=function(){var a,b,c,d,e;for(d=this.files,e=[],b=0,c=d.length;c>b;b++)a=d[b],a.accepted||e.push(a);return e},c.prototype.getFilesWithStatus=function(a){var b,c,d,e,f;for(e=this.files,f=[],c=0,d=e.length;d>c;c++)b=e[c],b.status===a&&f.push(b);return f},c.prototype.getQueuedFiles=function(){return this.getFilesWithStatus(c.QUEUED)},c.prototype.getUploadingFiles=function(){return this.getFilesWithStatus(c.UPLOADING)},c.prototype.getActiveFiles=function(){var a,b,d,e,f;for(e=this.files,f=[],b=0,d=e.length;d>b;b++)a=e[b],(a.status===c.UPLOADING||a.status===c.QUEUED)&&f.push(a);return f},c.prototype.init=function(){var a,b,d,e,f,g,h;for("form"===this.element.tagName&&this.element.setAttribute("enctype","multipart/form-data"),this.element.classList.contains("dropzone")&&!this.element.querySelector(".dz-message")&&this.element.appendChild(c.createElement('<div class="dz-default dz-message"><span>'+this.options.dictDefaultMessage+"</span></div>")),this.clickableElements.length&&(d=function(a){return function(){return a.hiddenFileInput&&document.body.removeChild(a.hiddenFileInput),a.hiddenFileInput=document.createElement("input"),a.hiddenFileInput.setAttribute("type","file"),(null==a.options.maxFiles||a.options.maxFiles>1)&&a.hiddenFileInput.setAttribute("multiple","multiple"),a.hiddenFileInput.className="dz-hidden-input",null!=a.options.acceptedFiles&&a.hiddenFileInput.setAttribute("accept",a.options.acceptedFiles),null!=a.options.capture&&a.hiddenFileInput.setAttribute("capture",a.options.capture),a.hiddenFileInput.style.visibility="hidden",a.hiddenFileInput.style.position="absolute",a.hiddenFileInput.style.top="0",a.hiddenFileInput.style.left="0",a.hiddenFileInput.style.height="0",a.hiddenFileInput.style.width="0",document.body.appendChild(a.hiddenFileInput),a.hiddenFileInput.addEventListener("change",function(){var b,c,e,f;if(c=a.hiddenFileInput.files,c.length)for(e=0,f=c.length;f>e;e++)b=c[e],a.addFile(b);return d()})}}(this))(),this.URL=null!=(g=window.URL)?g:window.webkitURL,h=this.events,e=0,f=h.length;f>e;e++)a=h[e],this.on(a,this.options[a]);return this.on("uploadprogress",function(a){return function(){return a.updateTotalUploadProgress()}}(this)),this.on("removedfile",function(a){return function(){return a.updateTotalUploadProgress()}}(this)),this.on("canceled",function(a){return function(b){return a.emit("complete",b)}}(this)),this.on("complete",function(a){return function(b){return 0===a.getUploadingFiles().length&&0===a.getQueuedFiles().length?setTimeout(function(){return a.emit("queuecomplete")},0):void 0}}(this)),b=function(a){return a.stopPropagation(),a.preventDefault?a.preventDefault():a.returnValue=!1},this.listeners=[{element:this.element,events:{dragstart:function(a){return function(b){return a.emit("dragstart",b)}}(this),dragenter:function(a){return function(c){return b(c),a.emit("dragenter",c)}}(this),dragover:function(a){return function(c){var d;try{d=c.dataTransfer.effectAllowed}catch(e){}return c.dataTransfer.dropEffect="move"===d||"linkMove"===d?"move":"copy",b(c),a.emit("dragover",c)}}(this),dragleave:function(a){return function(b){return a.emit("dragleave",b)}}(this),drop:function(a){return function(c){return b(c),a.drop(c)}}(this),dragend:function(a){return function(b){return a.emit("dragend",b)}}(this)}}],this.clickableElements.forEach(function(a){return function(b){return a.listeners.push({element:b,events:{click:function(d){return b!==a.element||d.target===a.element||c.elementInside(d.target,a.element.querySelector(".dz-message"))?a.hiddenFileInput.click():void 0}}})}}(this)),this.enable(),this.options.init.call(this)},c.prototype.destroy=function(){var a;return this.disable(),this.removeAllFiles(!0),(null!=(a=this.hiddenFileInput)?a.parentNode:void 0)&&(this.hiddenFileInput.parentNode.removeChild(this.hiddenFileInput),this.hiddenFileInput=null),delete this.element.dropzone,c.instances.splice(c.instances.indexOf(this),1)},c.prototype.updateTotalUploadProgress=function(){var a,b,c,d,e,f,g,h;if(d=0,c=0,a=this.getActiveFiles(),a.length){for(h=this.getActiveFiles(),f=0,g=h.length;g>f;f++)b=h[f],d+=b.upload.bytesSent,c+=b.upload.total;e=100*d/c}else e=100;return this.emit("totaluploadprogress",e,c,d)},c.prototype._getParamName=function(a){return"function"==typeof this.options.paramName?this.options.paramName(a):""+this.options.paramName+(this.options.uploadMultiple?"["+a+"]":"")},c.prototype.getFallbackForm=function(){var a,b,d,e;return(a=this.getExistingFallback())?a:(d='<div class="dz-fallback">',this.options.dictFallbackText&&(d+="<p>"+this.options.dictFallbackText+"</p>"),d+='<input type="file" name="'+this._getParamName(0)+'" '+(this.options.uploadMultiple?'multiple="multiple"':void 0)+' /><input type="submit" value="Upload!"></div>',b=c.createElement(d),"FORM"!==this.element.tagName?(e=c.createElement('<form action="'+this.options.url+'" enctype="multipart/form-data" method="'+this.options.method+'"></form>'),e.appendChild(b)):(this.element.setAttribute("enctype","multipart/form-data"),this.element.setAttribute("method",this.options.method)),null!=e?e:b)},c.prototype.getExistingFallback=function(){var a,b,c,d,e,f;for(b=function(a){var b,c,d;for(c=0,d=a.length;d>c;c++)if(b=a[c],/(^| )fallback($| )/.test(b.className))return b},f=["div","form"],d=0,e=f.length;e>d;d++)if(c=f[d],a=b(this.element.getElementsByTagName(c)))return a},c.prototype.setupEventListeners=function(){var a,b,c,d,e,f,g;for(f=this.listeners,g=[],d=0,e=f.length;e>d;d++)a=f[d],g.push(function(){var d,e;d=a.events,e=[];for(b in d)c=d[b],e.push(a.element.addEventListener(b,c,!1));return e}());return g},c.prototype.removeEventListeners=function(){
var a,b,c,d,e,f,g;for(f=this.listeners,g=[],d=0,e=f.length;e>d;d++)a=f[d],g.push(function(){var d,e;d=a.events,e=[];for(b in d)c=d[b],e.push(a.element.removeEventListener(b,c,!1));return e}());return g},c.prototype.disable=function(){var a,b,c,d,e;for(this.clickableElements.forEach(function(a){return a.classList.remove("dz-clickable")}),this.removeEventListeners(),d=this.files,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(this.cancelUpload(a));return e},c.prototype.enable=function(){return this.clickableElements.forEach(function(a){return a.classList.add("dz-clickable")}),this.setupEventListeners()},c.prototype.filesize=function(a){var b,c,d,e,f,g,h,i;for(g=["TB","GB","MB","KB","b"],d=e=null,c=h=0,i=g.length;i>h;c=++h)if(f=g[c],b=Math.pow(this.options.filesizeBase,4-c)/10,a>=b){d=a/Math.pow(this.options.filesizeBase,4-c),e=f;break}return d=Math.round(10*d)/10,"<strong>"+d+"</strong> "+e},c.prototype._updateMaxFilesReachedClass=function(){return null!=this.options.maxFiles&&this.getAcceptedFiles().length>=this.options.maxFiles?(this.getAcceptedFiles().length===this.options.maxFiles&&this.emit("maxfilesreached",this.files),this.element.classList.add("dz-max-files-reached")):this.element.classList.remove("dz-max-files-reached")},c.prototype.drop=function(a){var b,c;a.dataTransfer&&(this.emit("drop",a),b=a.dataTransfer.files,b.length&&(c=a.dataTransfer.items,c&&c.length&&null!=c[0].webkitGetAsEntry?this._addFilesFromItems(c):this.handleFiles(b)))},c.prototype.paste=function(a){var b,c;if(null!=(null!=a&&null!=(c=a.clipboardData)?c.items:void 0))return this.emit("paste",a),b=a.clipboardData.items,b.length?this._addFilesFromItems(b):void 0},c.prototype.handleFiles=function(a){var b,c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(this.addFile(b));return e},c.prototype._addFilesFromItems=function(a){var b,c,d,e,f;for(f=[],d=0,e=a.length;e>d;d++)c=a[d],null!=c.webkitGetAsEntry&&(b=c.webkitGetAsEntry())?b.isFile?f.push(this.addFile(c.getAsFile())):b.isDirectory?f.push(this._addFilesFromDirectory(b,b.name)):f.push(void 0):null!=c.getAsFile&&(null==c.kind||"file"===c.kind)?f.push(this.addFile(c.getAsFile())):f.push(void 0);return f},c.prototype._addFilesFromDirectory=function(a,b){var c,d;return c=a.createReader(),d=function(a){return function(c){var d,e,f;for(e=0,f=c.length;f>e;e++)d=c[e],d.isFile?d.file(function(c){return a.options.ignoreHiddenFiles&&"."===c.name.substring(0,1)?void 0:(c.fullPath=""+b+"/"+c.name,a.addFile(c))}):d.isDirectory&&a._addFilesFromDirectory(d,""+b+"/"+d.name)}}(this),c.readEntries(d,function(a){return"undefined"!=typeof console&&null!==console&&"function"==typeof console.log?console.log(a):void 0})},c.prototype.accept=function(a,b){return a.size>1024*this.options.maxFilesize*1024?b(this.options.dictFileTooBig.replace("{{filesize}}",Math.round(a.size/1024/10.24)/100).replace("{{maxFilesize}}",this.options.maxFilesize)):c.isValidFile(a,this.options.acceptedFiles)?null!=this.options.maxFiles&&this.getAcceptedFiles().length>=this.options.maxFiles?(b(this.options.dictMaxFilesExceeded.replace("{{maxFiles}}",this.options.maxFiles)),this.emit("maxfilesexceeded",a)):this.options.accept.call(this,a,b):b(this.options.dictInvalidFileType)},c.prototype.addFile=function(a){return a.upload={progress:0,total:a.size,bytesSent:0},this.files.push(a),a.status=c.ADDED,this.emit("addedfile",a),this._enqueueThumbnail(a),this.accept(a,function(b){return function(c){return c?(a.accepted=!1,b._errorProcessing([a],c)):(a.accepted=!0,b.options.autoQueue&&b.enqueueFile(a)),b._updateMaxFilesReachedClass()}}(this))},c.prototype.enqueueFiles=function(a){var b,c,d;for(c=0,d=a.length;d>c;c++)b=a[c],this.enqueueFile(b);return null},c.prototype.enqueueFile=function(a){if(a.status!==c.ADDED||a.accepted!==!0)throw new Error("This file can't be queued because it has already been processed or was rejected.");return a.status=c.QUEUED,this.options.autoProcessQueue?setTimeout(function(a){return function(){return a.processQueue()}}(this),0):void 0},c.prototype._thumbnailQueue=[],c.prototype._processingThumbnail=!1,c.prototype._enqueueThumbnail=function(a){return this.options.createImageThumbnails&&a.type.match(/image.*/)&&a.size<=1024*this.options.maxThumbnailFilesize*1024?(this._thumbnailQueue.push(a),setTimeout(function(a){return function(){return a._processThumbnailQueue()}}(this),0)):void 0},c.prototype._processThumbnailQueue=function(){return this._processingThumbnail||0===this._thumbnailQueue.length?void 0:(this._processingThumbnail=!0,this.createThumbnail(this._thumbnailQueue.shift(),function(a){return function(){return a._processingThumbnail=!1,a._processThumbnailQueue()}}(this)))},c.prototype.removeFile=function(a){return a.status===c.UPLOADING&&this.cancelUpload(a),this.files=h(this.files,a),this.emit("removedfile",a),0===this.files.length?this.emit("reset"):void 0},c.prototype.removeAllFiles=function(a){var b,d,e,f;for(null==a&&(a=!1),f=this.files.slice(),d=0,e=f.length;e>d;d++)b=f[d],(b.status!==c.UPLOADING||a)&&this.removeFile(b);return null},c.prototype.createThumbnail=function(a,b){var c;return c=new FileReader,c.onload=function(d){return function(){return"image/svg+xml"===a.type?(d.emit("thumbnail",a,c.result),void(null!=b&&b())):d.createThumbnailFromUrl(a,c.result,b)}}(this),c.readAsDataURL(a)},c.prototype.createThumbnailFromUrl=function(a,b,c){var d;return d=document.createElement("img"),d.onload=function(b){return function(){var e,g,h,i,j,k,l,m;return a.width=d.width,a.height=d.height,h=b.options.resize.call(b,a),null==h.trgWidth&&(h.trgWidth=h.optWidth),null==h.trgHeight&&(h.trgHeight=h.optHeight),e=document.createElement("canvas"),g=e.getContext("2d"),e.width=h.trgWidth,e.height=h.trgHeight,f(g,d,null!=(j=h.srcX)?j:0,null!=(k=h.srcY)?k:0,h.srcWidth,h.srcHeight,null!=(l=h.trgX)?l:0,null!=(m=h.trgY)?m:0,h.trgWidth,h.trgHeight),i=e.toDataURL("image/png"),b.emit("thumbnail",a,i),null!=c?c():void 0}}(this),null!=c&&(d.onerror=c),d.src=b},c.prototype.processQueue=function(){var a,b,c,d;if(b=this.options.parallelUploads,c=this.getUploadingFiles().length,a=c,!(c>=b)&&(d=this.getQueuedFiles(),d.length>0)){if(this.options.uploadMultiple)return this.processFiles(d.slice(0,b-c));for(;b>a;){if(!d.length)return;this.processFile(d.shift()),a++}}},c.prototype.processFile=function(a){return this.processFiles([a])},c.prototype.processFiles=function(a){var b,d,e;for(d=0,e=a.length;e>d;d++)b=a[d],b.processing=!0,b.status=c.UPLOADING,this.emit("processing",b);return this.options.uploadMultiple&&this.emit("processingmultiple",a),this.uploadFiles(a)},c.prototype._getFilesWithXhr=function(a){var b,c;return c=function(){var c,d,e,f;for(e=this.files,f=[],c=0,d=e.length;d>c;c++)b=e[c],b.xhr===a&&f.push(b);return f}.call(this)},c.prototype.cancelUpload=function(a){var b,d,e,f,g,h,i;if(a.status===c.UPLOADING){for(d=this._getFilesWithXhr(a.xhr),e=0,g=d.length;g>e;e++)b=d[e],b.status=c.CANCELED;for(a.xhr.abort(),f=0,h=d.length;h>f;f++)b=d[f],this.emit("canceled",b);this.options.uploadMultiple&&this.emit("canceledmultiple",d)}else((i=a.status)===c.ADDED||i===c.QUEUED)&&(a.status=c.CANCELED,this.emit("canceled",a),this.options.uploadMultiple&&this.emit("canceledmultiple",[a]));return this.options.autoProcessQueue?this.processQueue():void 0},e=function(){var a,b;return b=arguments[0],a=2<=arguments.length?i.call(arguments,1):[],"function"==typeof b?b.apply(this,a):b},c.prototype.uploadFile=function(a){return this.uploadFiles([a])},c.prototype.uploadFiles=function(a){var b,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L;for(w=new XMLHttpRequest,x=0,B=a.length;B>x;x++)b=a[x],b.xhr=w;p=e(this.options.method,a),u=e(this.options.url,a),w.open(p,u,!0),w.withCredentials=!!this.options.withCredentials,s=null,g=function(c){return function(){var d,e,f;for(f=[],d=0,e=a.length;e>d;d++)b=a[d],f.push(c._errorProcessing(a,s||c.options.dictResponseError.replace("{{statusCode}}",w.status),w));return f}}(this),t=function(c){return function(d){var e,f,g,h,i,j,k,l,m;if(null!=d)for(f=100*d.loaded/d.total,g=0,j=a.length;j>g;g++)b=a[g],b.upload={progress:f,total:d.total,bytesSent:d.loaded};else{for(e=!0,f=100,h=0,k=a.length;k>h;h++)b=a[h],(100!==b.upload.progress||b.upload.bytesSent!==b.upload.total)&&(e=!1),b.upload.progress=f,b.upload.bytesSent=b.upload.total;if(e)return}for(m=[],i=0,l=a.length;l>i;i++)b=a[i],m.push(c.emit("uploadprogress",b,f,b.upload.bytesSent));return m}}(this),w.onload=function(b){return function(d){var e;if(a[0].status!==c.CANCELED&&4===w.readyState){if(s=w.responseText,w.getResponseHeader("content-type")&&~w.getResponseHeader("content-type").indexOf("application/json"))try{s=JSON.parse(s)}catch(f){d=f,s="Invalid JSON response from server."}return t(),200<=(e=w.status)&&300>e?b._finished(a,s,d):g()}}}(this),w.onerror=function(b){return function(){return a[0].status!==c.CANCELED?g():void 0}}(this),r=null!=(G=w.upload)?G:w,r.onprogress=t,j={Accept:"application/json","Cache-Control":"no-cache","X-Requested-With":"XMLHttpRequest"},this.options.headers&&d(j,this.options.headers);for(h in j)i=j[h],w.setRequestHeader(h,i);if(f=new FormData,this.options.params){H=this.options.params;for(o in H)v=H[o],f.append(o,v)}for(y=0,C=a.length;C>y;y++)b=a[y],this.emit("sending",b,w,f);if(this.options.uploadMultiple&&this.emit("sendingmultiple",a,w,f),"FORM"===this.element.tagName)for(I=this.element.querySelectorAll("input, textarea, select, button"),z=0,D=I.length;D>z;z++)if(l=I[z],m=l.getAttribute("name"),n=l.getAttribute("type"),"SELECT"===l.tagName&&l.hasAttribute("multiple"))for(J=l.options,A=0,E=J.length;E>A;A++)q=J[A],q.selected&&f.append(m,q.value);else(!n||"checkbox"!==(K=n.toLowerCase())&&"radio"!==K||l.checked)&&f.append(m,l.value);for(k=F=0,L=a.length-1;L>=0?L>=F:F>=L;k=L>=0?++F:--F)f.append(this._getParamName(k),a[k],a[k].name);return w.send(f)},c.prototype._finished=function(a,b,d){var e,f,g;for(f=0,g=a.length;g>f;f++)e=a[f],e.status=c.SUCCESS,this.emit("success",e,b,d),this.emit("complete",e);return this.options.uploadMultiple&&(this.emit("successmultiple",a,b,d),this.emit("completemultiple",a)),this.options.autoProcessQueue?this.processQueue():void 0},c.prototype._errorProcessing=function(a,b,d){var e,f,g;for(f=0,g=a.length;g>f;f++)e=a[f],e.status=c.ERROR,this.emit("error",e,b,d),this.emit("complete",e);return this.options.uploadMultiple&&(this.emit("errormultiple",a,b,d),this.emit("completemultiple",a)),this.options.autoProcessQueue?this.processQueue():void 0},c}(b),a.version="4.0.1",a.options={},a.optionsForElement=function(b){return b.getAttribute("id")?a.options[c(b.getAttribute("id"))]:void 0},a.instances=[],a.forElement=function(a){if("string"==typeof a&&(a=document.querySelector(a)),null==(null!=a?a.dropzone:void 0))throw new Error("No Dropzone found for given element. This is probably because you're trying to access it before Dropzone had the time to initialize. Use the `init` option to setup any additional observers on your Dropzone.");return a.dropzone},a.autoDiscover=!0,a.discover=function(){var b,c,d,e,f,g;for(document.querySelectorAll?d=document.querySelectorAll(".dropzone"):(d=[],b=function(a){var b,c,e,f;for(f=[],c=0,e=a.length;e>c;c++)b=a[c],/(^| )dropzone($| )/.test(b.className)?f.push(d.push(b)):f.push(void 0);return f},b(document.getElementsByTagName("div")),b(document.getElementsByTagName("form"))),g=[],e=0,f=d.length;f>e;e++)c=d[e],a.optionsForElement(c)!==!1?g.push(new a(c)):g.push(void 0);return g},a.blacklistedBrowsers=[/opera.*Macintosh.*version\/12/i],a.isBrowserSupported=function(){var b,c,d,e,f;if(b=!0,window.File&&window.FileReader&&window.FileList&&window.Blob&&window.FormData&&document.querySelector)if("classList"in document.createElement("a"))for(f=a.blacklistedBrowsers,d=0,e=f.length;e>d;d++)c=f[d],c.test(navigator.userAgent)&&(b=!1);else b=!1;else b=!1;return b},h=function(a,b){var c,d,e,f;for(f=[],d=0,e=a.length;e>d;d++)c=a[d],c!==b&&f.push(c);return f},c=function(a){return a.replace(/[\-_](\w)/g,function(a){return a.charAt(1).toUpperCase()})},a.createElement=function(a){var b;return b=document.createElement("div"),b.innerHTML=a,b.childNodes[0]},a.elementInside=function(a,b){if(a===b)return!0;for(;a=a.parentNode;)if(a===b)return!0;return!1},a.getElement=function(a,b){var c;if("string"==typeof a?c=document.querySelector(a):null!=a.nodeType&&(c=a),null==c)throw new Error("Invalid `"+b+"` option provided. Please provide a CSS selector or a plain HTML element.");return c},a.getElements=function(a,b){var c,d,e,f,g,h,i,j;if(a instanceof Array){e=[];try{for(f=0,h=a.length;h>f;f++)d=a[f],e.push(this.getElement(d,b))}catch(k){c=k,e=null}}else if("string"==typeof a)for(e=[],j=document.querySelectorAll(a),g=0,i=j.length;i>g;g++)d=j[g],e.push(d);else null!=a.nodeType&&(e=[a]);if(null==e||!e.length)throw new Error("Invalid `"+b+"` option provided. Please provide a CSS selector, a plain HTML element or a list of those.");return e},a.confirm=function(a,b,c){return window.confirm(a)?b():null!=c?c():void 0},a.isValidFile=function(a,b){var c,d,e,f,g;if(!b)return!0;for(b=b.split(","),d=a.type,c=d.replace(/\/.*$/,""),f=0,g=b.length;g>f;f++)if(e=b[f],e=e.trim(),"."===e.charAt(0)){if(-1!==a.name.toLowerCase().indexOf(e.toLowerCase(),a.name.length-e.length))return!0}else if(/\/\*$/.test(e)){if(c===e.replace(/\/.*$/,""))return!0}else if(d===e)return!0;return!1},"undefined"!=typeof jQuery&&null!==jQuery&&(jQuery.fn.dropzone=function(b){return this.each(function(){return new a(this,b)})}),"undefined"!=typeof module&&null!==module?module.exports=a:window.Dropzone=a,a.ADDED="added",a.QUEUED="queued",a.ACCEPTED=a.QUEUED,a.UPLOADING="uploading",a.PROCESSING=a.UPLOADING,a.CANCELED="canceled",a.ERROR="error",a.SUCCESS="success",e=function(a){var b,c,d,e,f,g,h,i,j,k;for(h=a.naturalWidth,g=a.naturalHeight,c=document.createElement("canvas"),c.width=1,c.height=g,d=c.getContext("2d"),d.drawImage(a,0,0),e=d.getImageData(0,0,1,g).data,k=0,f=g,i=g;i>k;)b=e[4*(i-1)+3],0===b?f=i:k=i,i=f+k>>1;return j=i/g,0===j?1:j},f=function(a,b,c,d,f,g,h,i,j,k){var l;return l=e(b),a.drawImage(b,c,d,f,g,h,i,j,k/l)},d=function(a,b){var c,d,e,f,g,h,i,j,k;if(e=!1,k=!0,d=a.document,j=d.documentElement,c=d.addEventListener?"addEventListener":"attachEvent",i=d.addEventListener?"removeEventListener":"detachEvent",h=d.addEventListener?"":"on",f=function(c){return"readystatechange"!==c.type||"complete"===d.readyState?(("load"===c.type?a:d)[i](h+c.type,f,!1),!e&&(e=!0)?b.call(a,c.type||c):void 0):void 0},g=function(){var a;try{j.doScroll("left")}catch(b){return a=b,void setTimeout(g,50)}return f("poll")},"complete"!==d.readyState){if(d.createEventObject&&j.doScroll){try{k=!a.frameElement}catch(l){}k&&g()}return d[c](h+"DOMContentLoaded",f,!1),d[c](h+"readystatechange",f,!1),a[c](h+"load",f,!1)}},a._autoDiscoverFunction=function(){return a.autoDiscover?a.discover():void 0},d(window,a._autoDiscoverFunction)}.call(this),function(a,b){if("function"==typeof define&&define.amd)define(["underscore","jquery","backbone"],function(c,d,e){b(a,e,c,d)});else if("undefined"!=typeof exports){var c=require("underscore"),d=require("jquery"),e=require("backbone");b(a,c,d,e)}else b(a,a.Backbone,a._,a.$)}(this,function(a,b,c,d){"use strict";var e=c.clone(b.Model.prototype),f=b.Model.extend({fileAttribute:"file",save:function(a,f,g){var h,i=this.attributes;if(null==a||"object"==typeof a?(h=a,g=f):(h={})[a]=f,g=c.extend({validate:!0},g),h&&!g.wait){if(!this.set(h,g))return!1}else if(!this._validate(h,g))return!1;var j=c.extend({},i,h);if(h&&g.wait&&(this.attributes=j),g.formData===!0||g.formData!==!1&&j[this.fileAttribute]&&j[this.fileAttribute]instanceof File||j[this.fileAttribute]instanceof FileList||j[this.fileAttribute]instanceof Blob){var k=c.clone(j),l=j[this.fileAttribute];k=b.Model.prototype._flatten(k),k[this.fileAttribute]=l;var m=new FormData;c.each(k,function(a,b){return a instanceof FileList?void c.each(a,function(a){m.append(b,a)}):void m.append(b,a)}),g.data=m,g.processData=!1,g.contentType=!1;var n=this;g.xhr=function(){var a=d.ajaxSettings.xhr();return a.upload.addEventListener("progress",n._progressHandler.bind(n),!1),a}}return h&&g.wait&&(this.attributes=i),e.save.call(this,h,g)},_flatten:function(a){var b={};for(var c in a)if(a.hasOwnProperty(c))if("object"==typeof a[c]){var d=this._flatten(a[c]);for(var e in d)d.hasOwnProperty(e)&&(b[c+"."+e]=d[e])}else b[c]=a[c];return b},_progressHandler:function(a){if(a.lengthComputable){var b=a.loaded/a.total;this.trigger("progress",b)}}});b.Model=f}),CodeMirror.defineMode("postgres",function(a){function b(a){return new RegExp("^(?:"+a.join("|")+")$","i")}function c(a,b){var c=a.next();if(h=null,"$"==c||"?"==c)return a.match(/^[\w\d]*/),"variable-2";if("<"==c&&!a.match(/^[\s\u00a0=]/,!1))return a.match(/^[^\s\u00a0>]*>?/),"atom";if('"'==c||"'"==c)return b.tokenize=d(c),b.tokenize(a,b);if("`"==c)return b.tokenize=e(c),b.tokenize(a,b);if(/[{}\(\),\.;\[\]]/.test(c))return h=c,null;if("-"!=c){if(l.test(c))return a.eatWhile(l),null;if(":"==c)return a.eatWhile(/[\w\d\._\-]/),"atom";if(a.eatWhile(/[_\w\d]/),a.eat(":"))return a.eatWhile(/[\w\d_\-]/),"atom";var f=a.current();return j.test(f)?null:k.test(f)?"keyword":"variable"}var g=a.next();return"-"==g?(a.skipToEnd(),"comment"):void 0}function d(a){return function(b,d){for(var e,f=!1;null!=(e=b.next());){if(e==a&&!f){d.tokenize=c;break}f=!f&&"\\"==e}return"string"}}function e(a){return function(b,d){for(var e,f=!1;null!=(e=b.next());){if(e==a&&!f){d.tokenize=c;break}f=!f&&"\\"==e}return"variable-2"}}function f(a,b,c){a.context={prev:a.context,indent:a.indent,col:c,type:b}}function g(a){a.indent=a.context.indent,a.context=a.context.prev}var h,i=a.indentUnit,j=b(["str","lang","langmatches","datatype","bound","sameterm","isiri","isuri","isblank","isliteral","union","a"]),k=b(["ABS","ACCESSIBLE","ADD","ALL","ALTER","ANALYZE","AND","ANY","ARRAY","ARRAY_AGG","ARRAY_MAX_CARDINALITY","AS","ASC","ASENSITIVE","AT","AVG","BEFORE","BEGIN","BETWEEN","BIGINT","BINARY","BLOB","BOOLEAN","BOTH","BY","CALL","CASCADE","CASE","CAST","CEIL","CEILING","CHANGE","CHAR","CHARACTER","CHARACTER_LENGTH","CHAR_LENGTH","CHECK","CLOB","CLOSE","COLLATE","COLLECT","COLUMN","COLUMNS","CONDITION","CONSTRAINT","CONTAINS","CONTINUE","CONVERT","CORR","COUNT","CREATE","CROSS","CUBE","CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP","CURRENT_USER","CURSOR","CYCLE","DATABASE","DATABASES","DATE","DAY","DAY_HOUR","DAY_MICROSECOND","DAY_MINUTE","DAY_SECOND","DEC","DECIMAL","DECLARE","DEFAULT","DELAYED","DELETE","DESC","DESCRIBE","DETERMINISTIC","DISTINCT","DISTINCTROW","DIV","DOUBLE","DROP","DUAL","EACH","ELEMENT","ELSE","ELSEIF","ENCLOSED","END","EQUALS","ESCAPE","ESCAPED","EVERY","EXCEPT","EXEC","EXISTS","EXIT","EXP","EXPLAIN","EXTRACT","FALSE","FETCH","FILTER","FLOAT","FLOAT4","FLOAT8","FLOOR","FOR","FORCE","FOREIGN","FROM","FULL","FULLTEXT","GRANT","GROUP","GROUPS","HAVING","HIGH_PRIORITY","HOLD","HOUR","HOUR_MICROSECOND","HOUR_MINUTE","HOUR_SECOND","IDENTITY","IF","IGNORE","ILIKE","IN","INDEX","INFILE","INNER","INOUT","INSENSITIVE","INSERT","INT","INT1","INT2","INT3","INT4","INT8","INTEGER","INTERSECT","INTERSECTION","INTERVAL","INTO","IS","ITERATE","JOIN","KEY","KEYS","KILL","LAG","LARGE","LEADING","LEAVE","LEFT","LIKE","LIKE_REGEX","LIMIT","LINEAR","LINES","LN","LOAD","LOCALTIME","LOCALTIMESTAMP","LOCK","LONG","LONGBLOB","LONGTEXT","LOOP","LOWER","LOW_PRIORITY","MASTER_SSL_VERIFY_SERVER_CERT","MATCH","MAX","MEDIUMBLOB","MEDIUMINT","MEDIUMTEXT","MIDDLEINT","MIN","MINUTE","MINUTE_MICROSECOND","MINUTE_SECOND","MOD","MODIFIES","MODULE","MONTH","MULTISET","NATURAL","NO","NONE","NORMALIZE","NOT","NO_WRITE_TO_BINLOG","NULL","NULLIF","NUMERIC","OF","OFFSET","OLD","ON","ONLY","OPEN","OPTIMIZE","OPTION","OPTIONALLY","OR","ORDER","OUT","OUTER","OUTFILE","OVER","OVERLAY","PARAMETER","PERCENT","PERIOD","POSITION","POWER","PRECISION","PRIMARY","PROCEDURE","PURGE","RANGE","READ","READS","READ_WRITE","REAL","REFERENCES","REGEXP","RELEASE","RENAME","REPEAT","REPLACE","REQUIRE","RESTRICT","RESULT","RETURN","REVOKE","RIGHT","RLIKE","ROWS","SCHEMA","SCHEMAS","SECOND_MICROSECOND","SELECT","SENSITIVE","SEPARATOR","SET","SHOW","SIMILAR","SMALLINT","SOME","SPATIAL","SPECIFIC","SQL","SQLEXCEPTION","SQLSTATE","SQLWARNING","SQL_BIG_RESULT","SQL_CALC_FOUND_ROWS","SQL_SMALL_RESULT","SQRT","SSL","STARTING","STDEV","STRAIGHT_JOIN","SUBSTRING","SUM","TABLE","TERMINATED","THEN","TIME","TIMESTAMP","TINYBLOB","TINYINT","TINYTEXT","TO","TRAILING","TRIGGER","TRIM","TRIM_ARRAY","TRUE","TRUNCATE","UNDO","UNION","UNIQUE","UNKNOWN","UNLOCK","UNSIGNED","UPDATE","UPPER","USAGE","USE","USING","UTC_DATE","UTC_TIME","UTC_TIMESTAMP","VALUE","VALUES","VALUE_OF","VARBINARY","VARCHAR","VARCHARACTER","VARYING","WHEN","WHENEVER","WHERE","WHILE","WITH","WITHIN","WITHOUT","WRITE","XOR","YEAR_MONTH","ZEROFILL"]),l=/[*+\-<>=&|]/;return{startState:function(a){return{tokenize:c,context:null,indent:0,col:0}},token:function(a,b){if(a.sol()&&(b.context&&null==b.context.align&&(b.context.align=!1),b.indent=a.indentation()),a.eatSpace())return null;var c=b.tokenize(a,b);if("comment"!=c&&b.context&&null==b.context.align&&"pattern"!=b.context.type&&(b.context.align=!0),"("==h)f(b,")",a.column());else if("["==h)f(b,"]",a.column());else if("{"==h)f(b,"}",a.column());else if(/[\]\}\)]/.test(h)){for(;b.context&&"pattern"==b.context.type;)g(b);b.context&&h==b.context.type&&g(b)}else"."==h&&b.context&&"pattern"==b.context.type?g(b):/atom|string|variable/.test(c)&&b.context&&(/[\}\]]/.test(b.context.type)?f(b,"pattern",a.column()):"pattern"!=b.context.type||b.context.align||(b.context.align=!0,b.context.col=a.column()));return c},indent:function(a,b){var c=b&&b.charAt(0),d=a.context;if(/[\]\}]/.test(c))for(;d&&"pattern"==d.type;)d=d.prev;var e=d&&c==d.type;return d?"pattern"==d.type?d.col:d.align?d.col+(e?0:1):d.indent+(e?0:i):0}}}),CodeMirror.defineMIME("text/x-postgres","postgres"),function(a){"object"==typeof exports&&"object"==typeof module?a(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],a):a(CodeMirror)}(function(a){"use strict";a.defineMode("xml",function(b,c){function d(a,b){function c(c){return b.tokenize=c,c(a,b)}var d=a.next();if("<"==d)return a.eat("!")?a.eat("[")?a.match("CDATA[")?c(g("atom","]]>")):null:a.match("--")?c(g("comment","-->")):a.match("DOCTYPE",!0,!0)?(a.eatWhile(/[\w\._\-]/),c(h(1))):null:a.eat("?")?(a.eatWhile(/[\w\._\-]/),b.tokenize=g("meta","?>"),"meta"):(x=a.eat("/")?"closeTag":"openTag",b.tokenize=e,"tag bracket");if("&"==d){var f;return f=a.eat("#")?a.eat("x")?a.eatWhile(/[a-fA-F\d]/)&&a.eat(";"):a.eatWhile(/[\d]/)&&a.eat(";"):a.eatWhile(/[\w\.\-:]/)&&a.eat(";"),f?"atom":"error"}return a.eatWhile(/[^&<]/),null}function e(a,b){var c=a.next();if(">"==c||"/"==c&&a.eat(">"))return b.tokenize=d,x=">"==c?"endTag":"selfcloseTag","tag bracket";if("="==c)return x="equals",null;if("<"==c){b.tokenize=d,b.state=l,b.tagName=b.tagStart=null;var e=b.tokenize(a,b);return e?e+" error":"error"}return/[\'\"]/.test(c)?(b.tokenize=f(c),b.stringStartCol=a.column(),b.tokenize(a,b)):(a.match(/^[^\s\u00a0=<>\"\']*[^\s\u00a0=<>\"\'\/]/),"word")}function f(a){var b=function(b,c){for(;!b.eol();)if(b.next()==a){c.tokenize=e;break}return"string"};return b.isInAttribute=!0,b}function g(a,b){return function(c,e){for(;!c.eol();){if(c.match(b)){e.tokenize=d;break}c.next()}return a}}function h(a){return function(b,c){for(var e;null!=(e=b.next());){if("<"==e)return c.tokenize=h(a+1),c.tokenize(b,c);if(">"==e){if(1==a){c.tokenize=d;break}return c.tokenize=h(a-1),c.tokenize(b,c)}}return"meta"}}function i(a,b,c){this.prev=a.context,this.tagName=b,this.indent=a.indented,this.startOfLine=c,(z.doNotIndent.hasOwnProperty(b)||a.context&&a.context.noIndent)&&(this.noIndent=!0)}function j(a){a.context&&(a.context=a.context.prev)}function k(a,b){for(var c;;){if(!a.context)return;if(c=a.context.tagName,!z.contextGrabbers.hasOwnProperty(c)||!z.contextGrabbers[c].hasOwnProperty(b))return;j(a)}}function l(a,b,c){return"openTag"==a?(c.tagStart=b.column(),m):"closeTag"==a?n:l}function m(a,b,c){return"word"==a?(c.tagName=b.current(),y="tag",q):(y="error",m)}function n(a,b,c){if("word"==a){var d=b.current();return c.context&&c.context.tagName!=d&&z.implicitlyClosed.hasOwnProperty(c.context.tagName)&&j(c),c.context&&c.context.tagName==d?(y="tag",o):(y="tag error",p)}return y="error",p}function o(a,b,c){return"endTag"!=a?(y="error",o):(j(c),l)}function p(a,b,c){return y="error",o(a,b,c)}function q(a,b,c){if("word"==a)return y="attribute",r;if("endTag"==a||"selfcloseTag"==a){var d=c.tagName,e=c.tagStart;return c.tagName=c.tagStart=null,"selfcloseTag"==a||z.autoSelfClosers.hasOwnProperty(d)?k(c,d):(k(c,d),c.context=new i(c,d,e==c.indented)),l}return y="error",q}function r(a,b,c){return"equals"==a?s:(z.allowMissing||(y="error"),q(a,b,c))}function s(a,b,c){return"string"==a?t:"word"==a&&z.allowUnquoted?(y="string",q):(y="error",q(a,b,c))}function t(a,b,c){return"string"==a?t:q(a,b,c)}var u=b.indentUnit,v=c.multilineTagIndentFactor||1,w=c.multilineTagIndentPastTag;null==w&&(w=!0);var x,y,z=c.htmlMode?{autoSelfClosers:{area:!0,base:!0,br:!0,col:!0,command:!0,embed:!0,frame:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0},implicitlyClosed:{dd:!0,li:!0,optgroup:!0,option:!0,p:!0,rp:!0,rt:!0,tbody:!0,td:!0,tfoot:!0,th:!0,tr:!0},contextGrabbers:{dd:{dd:!0,dt:!0},dt:{dd:!0,dt:!0},li:{li:!0},option:{option:!0,optgroup:!0},optgroup:{optgroup:!0},p:{address:!0,article:!0,aside:!0,blockquote:!0,dir:!0,div:!0,dl:!0,fieldset:!0,footer:!0,form:!0,h1:!0,h2:!0,h3:!0,h4:!0,h5:!0,h6:!0,header:!0,hgroup:!0,hr:!0,menu:!0,nav:!0,ol:!0,p:!0,pre:!0,section:!0,table:!0,ul:!0},rp:{rp:!0,rt:!0},rt:{rp:!0,rt:!0},tbody:{tbody:!0,tfoot:!0},td:{td:!0,th:!0},tfoot:{tbody:!0},th:{td:!0,th:!0},thead:{tbody:!0,tfoot:!0},tr:{tr:!0}},doNotIndent:{pre:!0},allowUnquoted:!0,allowMissing:!0,caseFold:!0}:{autoSelfClosers:{},implicitlyClosed:{},contextGrabbers:{},doNotIndent:{},allowUnquoted:!1,allowMissing:!1,caseFold:!1},A=c.alignCDATA;return{startState:function(){return{tokenize:d,state:l,indented:0,tagName:null,tagStart:null,context:null}},token:function(a,b){if(!b.tagName&&a.sol()&&(b.indented=a.indentation()),a.eatSpace())return null;x=null;var c=b.tokenize(a,b);return(c||x)&&"comment"!=c&&(y=null,b.state=b.state(x||c,a,b),y&&(c="error"==y?c+" error":y)),c},indent:function(b,c,f){var g=b.context;if(b.tokenize.isInAttribute)return b.tagStart==b.indented?b.stringStartCol+1:b.indented+u;if(g&&g.noIndent)return a.Pass;if(b.tokenize!=e&&b.tokenize!=d)return f?f.match(/^(\s*)/)[0].length:0;if(b.tagName)return w?b.tagStart+b.tagName.length+2:b.tagStart+u*v;if(A&&/<!\[CDATA\[/.test(c))return 0;var h=c&&/^<(\/)?([\w_:\.-]*)/.exec(c);if(h&&h[1])for(;g;){if(g.tagName==h[2]){g=g.prev;break}if(!z.implicitlyClosed.hasOwnProperty(g.tagName))break;g=g.prev}else if(h)for(;g;){var i=z.contextGrabbers[g.tagName];if(!i||!i.hasOwnProperty(h[2]))break;g=g.prev}for(;g&&!g.startOfLine;)g=g.prev;return g?g.indent+u:0},electricInput:/<\/[\s\w:]+>$/,blockCommentStart:"<!--",blockCommentEnd:"-->",configuration:c.htmlMode?"html":"xml",helperType:c.htmlMode?"html":"xml"}}),a.defineMIME("text/xml","xml"),a.defineMIME("application/xml","xml"),a.mimeModes.hasOwnProperty("text/html")||a.defineMIME("text/html",{name:"xml",htmlMode:!0})}),$.fn.draggableOverlay=function(a){var b=this,c=null,d=null,e=this;if("disable"===a||void 0==a.container)return this.addClass("disabled"),void this.css("cursor","");a=$.extend({horizontal_guides:[],vertical_guides:[],padding:0,stickiness:7,cursor:"move"},a);var f,g,h,i=a.container,j=a.horizontal_guides,k=a.vertical_guides,l=[];$(".rule").remove(),c=$("<div class='rule' />"),i.append(c),c.offset({top:0}).css({left:0}),d=$("<div class='rule horizontal' />"),i.append(d),d.offset({top:0}).css({left:0});for(var m=0;m<j.length;m++){var n=j[m],o=$("<div class='guide horizontal' />");i.append(o),o.offset({top:n}).css({left:0})}for(var m=0;m<k.length;m++){var n=k[m],o=$("<div class='guide vertical' />");i.append(o),o.offset({left:n}).css({top:0})}var p=function(m){if(b.hasClass("disabled"))return void m.stopPropagation();m.stopPropagation();var n=$(this).addClass("draggable");$(this).css({bottom:"auto",right:"auto",left:$(this).position().left,top:$(this).position().top});var o=n.outerHeight(),p=n.outerWidth(),q=n.offset().top+o-m.pageY,r=n.offset().left+p-m.pageX,s=i.offset().left,t=i.offset().top,u=i.width(),v=i.height();h=[],l=[],f=[],g=[];var w=$(this).hasClass("desktop")?"desktop":"mobile";$(this).hasClass("snap")&&(e.each(function(a,b){if(!$(b).hasClass("draggable")&&$(b).hasClass(w)&&!$(b).hasClass("disabled")&&$(b).hasClass("snap")){var c=$(b).offset().top;g.push(c),g.push(c+$(b).height());var d=$(b).offset().left;f.push(d),f.push(d+$(b).width())}}),h=h.concat(f,k),l=l.concat(g,j));var x=function(b){for(var e=b.pageY+q-o,f=b.pageX+r-p,g=e,i=f,j=s+u,k=t+v,m=0;m<l.length;m++){var n=l[m];if(e>=n-a.stickiness-a.padding&&e<=n+a.stickiness+a.padding){e=n,d.offset({top:e}).css({left:0,opacity:1});break}if(e+o<=n+a.stickiness+a.padding&&e+o>=n-a.stickiness-a.padding){e=n-o,d.offset({top:e+o}).css({left:0,opacity:1});break}}for(var m=0;m<h.length;m++){var n=h[m];if(f>=n-a.stickiness-a.padding&&f<=n+a.stickiness+a.padding){f=n,c.offset({left:f}).css({top:0,opacity:1});break}if(f+p<=n+a.stickiness+a.padding&&f+p>=n-a.stickiness-a.padding){f=n-p,c.offset({left:f+p}).css({top:0,opacity:1});break}}f-a.stickiness<s?f=s:f+p+a.stickiness>j&&(f=j-p),e-a.stickiness<t?e=t:e+o+a.stickiness>k&&(e=k-o),e==g&&f==i?($(this).find(".draggable").removeClass("sticky"),$(".rule").css({opacity:0})):$(this).find(".draggable").addClass("sticky");var w={top:e,left:f};$(".draggable").offset(w)};n.parents().on("mousemove",x)},q=function(){$(".draggable").parents().off("mousemove"),$(".rule").css({opacity:0}),$(".draggable").removeClass("sticky"),$(".draggable").removeClass("draggable")};return $("body").on("mouseup",q),this.on("mousedown",p).on("mouseup",q)},CodeMirror.defineMode("carto",function(a){function b(a,b){return j=b,a}function c(a){for(var b=0;b<l.length;b++)if(a===l[b])return!0}function d(a,d){var e=a.next();if("@"==e)return a.eatWhile(/[\w\-]/),b("meta",a.current());if("/"==e&&a.eat("*"))return d.tokenize=g,g(a,d);if("<"==e&&a.eat("!"))return d.tokenize=h,h(a,d);if("="==e)b(null,"compare");else{if("|"==e&&a.eat("="))return b(null,"compare");if('"'==e||"'"==e)return d.tokenize=i(e),d.tokenize(a,d);if("/"==e){if(a.eat("/"))return d.tokenize=f,f(a,d);if("string"==j||"("==j)return b("string","string");if(void 0!=d.stack[d.stack.length-1])return b(null,e);if(a.eatWhile(/[\a-zA-Z0-9\-_.\s]/),/\/|\)|#/.test(a.peek()||a.eatSpace()&&")"==a.peek())||a.eol())return b("string","string")}else{if("!"==e)return a.match(/^\s*\w*/),b("keyword","important");if(/\d/.test(e))return a.eatWhile(/[\w.%]/),b("number","unit");if(/[,+<>*\/]/.test(e))return"="==a.peek()||"a"==j?b("string","string"):b(null,"select-op");if(!/[;{}:\[\]()~\|]/.test(e)){if("."==e)return"("==j||"string"==j?b("string","string"):(a.eatWhile(/[\a-zA-Z0-9\-_]/)," "==a.peek()&&a.eatSpace(),")"==a.peek()?b("number","unit"):b("tag","tag"));if("#"==e)return a.eatWhile(/[A-Za-z0-9]/),(4==a.current().length||7==a.current().length)&&null!=a.current().match(/[A-Fa-f0-9]{6}|[A-Fa-f0-9]{3}/,!1)?a.current().substring(1)!=a.current().match(/[A-Fa-f0-9]{6}|[A-Fa-f0-9]{3}/,!1)?b("atom","tag"):(a.eatSpace(),/[\/<>.(){!$%^&*_\-\\?=+\|#'~`]/.test(a.peek())?b("atom","tag"):"}"==a.peek()?b("color","unit"):/[a-zA-Z\\]/.test(a.peek())?b("color","unit"):a.eol()?b("color","unit"):b("color","unit")):(a.eatWhile(/[\w\\\-]/),b("atom","tag"));if("&"==e)return a.eatWhile(/[\w\-]/),b(null,e);if(a.eatWhile(/[\w\\\-_%.{]/),"string"==j)return b("string","string");if(null!=a.current().match(/(^http$|^https$)/))return a.eatWhile(/[\w\\\-_%.{:\/]/),b("string","string");if("<"==a.peek()||">"==a.peek())return b("tag","tag");if(/\(/.test(a.peek()))return b(null,e);if("/"==a.peek()&&void 0!=d.stack[d.stack.length-1])return b("string","string");if(a.current().match(/\-\d|\-.\d/))return b("number","unit");
if(c(a.current().toLowerCase()))return b("tag","tag");if(/\/|[\s\)]/.test(a.peek()||a.eol()||a.eatSpace()&&"/"==a.peek())&&-1!==a.current().indexOf("."))return"{"==a.current().substring(a.current().length-1,a.current().length)?(a.backUp(1),b("tag","tag")):(a.eatSpace(),/[{<>.a-zA-Z\/]/.test(a.peek())||a.eol()?b("tag","tag"):b("string","string"));if(a.eol()||"["==a.peek()||"#"==a.peek()||"tag"==j)return"{"==a.current().substring(a.current().length-1,a.current().length)&&a.backUp(1),b("tag","tag");if("compare"==j||"a"==j||"("==j)return b("string","string");if("|"==j||"-"==a.current()||"["==j)return b(null,e);if(":"==a.peek()){a.next();var k=":"==a.peek()?!0:!1;if(k)a.backUp(1);else{var l=a.pos,o=a.current().length;a.eatWhile(/[a-z\\\-]/);var p=a.pos;if(null!=a.current().substring(o-1).match(n))return a.backUp(p-(l-1)),b("tag","tag");a.backUp(p-(l-1))}return k?b("tag","tag"):b("variable","variable")}return m.hasOwnProperty(a.current())?b("color","unit"):b("variable","variable")}if(":"==e)return a.eatWhile(/[a-z\\\-]/),n.test(a.current())?b("tag","tag"):":"==a.peek()?(a.next(),a.eatWhile(/[a-z\\\-]/),a.current().match(/\:\:\-(o|ms|moz|webkit)\-/)?b("string","string"):n.test(a.current().substring(1))?b("tag","tag"):b(null,e)):b(null,e);if("~"!=e)return b(null,e);if("r"==j)return b("string","string")}}}function e(a){for(var b={},c=0;c<a.length;++c)b[a[c]]=!0;return b}function f(a,c){return a.skipToEnd(),c.tokenize=d,b("comment","comment")}function g(a,c){for(var e,f=!1;null!=(e=a.next());){if(f&&"/"==e){c.tokenize=d;break}f="*"==e}return b("comment","comment")}function h(a,c){for(var e,f=0;null!=(e=a.next());){if(f>=2&&">"==e){c.tokenize=d;break}f="-"==e?f+1:0}return b("comment","comment")}function i(a){return function(c,e){for(var f,g=!1;null!=(f=c.next())&&(f!=a||g);)g=!g&&"\\"==f;return g||(e.tokenize=d),b("string","string")}}var j,k=a.indentUnit,l="a abbr acronym address applet area article aside audio b base basefont bdi bdo big blockquote body br button canvas caption cite code col colgroup command datalist dd del details dfn dir div dl dt em embed fieldset figcaption figure font footer form frame frameset h1 h2 h3 h4 h5 h6 head header hgroup hr html i iframe img input ins keygen kbd label legend li link map mark menu meta meter nav noframes noscript object ol optgroup option output p param pre progress q rp rt ruby s samp script section select small source span strike strong style sub summary sup table tbody td textarea tfoot th thead time title tr track tt u ul var video wbr".split(" "),m=e(color_keywords),n=/(^\:root$|^\:nth\-child$|^\:nth\-last\-child$|^\:nth\-of\-type$|^\:nth\-last\-of\-type$|^\:first\-child$|^\:last\-child$|^\:first\-of\-type$|^\:last\-of\-type$|^\:only\-child$|^\:only\-of\-type$|^\:empty$|^\:link|^\:visited$|^\:active$|^\:hover$|^\:focus$|^\:target$|^\:lang$|^\:enabled^\:disabled$|^\:checked$|^\:first\-line$|^\:first\-letter$|^\:before$|^\:after$|^\:not$|^\:required$|^\:invalid$)/;return{startState:function(a){return{tokenize:d,baseIndent:a||0,stack:[]}},token:function(a,b){if(a.eatSpace())return null;var c=b.tokenize(a,b),d=b.stack[b.stack.length-1];return"hash"==j&&"rule"==d?c="atom":"variable"==c&&("rule"==d?c=null:d&&"@media{"!=d||(c="when"==a.current()?"variable":/[\s,|\s\)|\s]/.test(a.peek())?"tag":j)),"rule"==d&&/^[\{\};]$/.test(j)&&b.stack.pop(),"{"==j?"@media"==d?b.stack[b.stack.length-1]="@media{":b.stack.push("{"):"}"==j?b.stack.pop():"@media"==j?b.stack.push("@media"):"{"==d&&"comment"!=j&&b.stack.push("rule"),c},indent:function(a,b){var c=a.stack.length;return/^\}/.test(b)&&(c-="rule"==a.stack[a.stack.length-1]?2:1),a.baseIndent+c*k},electricChars:"}"}}),CodeMirror.defineMIME("text/x-carto","carto");var color_keywords=["aliceblue","antiquewhite","aqua","aquamarine","azure","beige","bisque","black","blanchedalmond","blue","blueviolet","brown","burlywood","cadetblue","chartreuse","chocolate","coral","cornflowerblue","cornsilk","crimson","cyan","darkblue","darkcyan","darkgoldenrod","darkgray","darkgreen","darkkhaki","darkmagenta","darkolivegreen","darkorange","darkorchid","darkred","darksalmon","darkseagreen","darkslateblue","darkslategray","darkturquoise","darkviolet","deeppink","deepskyblue","dimgray","dodgerblue","firebrick","floralwhite","forestgreen","fuchsia","gainsboro","ghostwhite","gold","goldenrod","gray","grey","green","greenyellow","honeydew","hotpink","indianred","indigo","ivory","khaki","lavender","lavenderblush","lawngreen","lemonchiffon","lightblue","lightcoral","lightcyan","lightgoldenrodyellow","lightgray","lightgreen","lightpink","lightsalmon","lightseagreen","lightskyblue","lightslategray","lightsteelblue","lightyellow","lime","limegreen","linen","magenta","maroon","mediumaquamarine","mediumblue","mediumorchid","mediumpurple","mediumseagreen","mediumslateblue","mediumspringgreen","mediumturquoise","mediumvioletred","midnightblue","mintcream","mistyrose","moccasin","navajowhite","navy","oldlace","olive","olivedrab","orange","orangered","orchid","palegoldenrod","palegreen","paleturquoise","palevioletred","papayawhip","peachpuff","peru","pink","plum","powderblue","purple","red","rosybrown","royalblue","saddlebrown","salmon","sandybrown","seagreen","seashell","sienna","silver","skyblue","slateblue","slategray","snow","springgreen","steelblue","tan","teal","thistle","tomato","turquoise","violet","wheat","white","whitesmoke","yellow","yellowgreen"];cdb.Utils={},cdb.Utils.stripHTML=function(a,b){b=(((b||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var c=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;return a&&"string"==typeof a?a.replace(c,function(a,c){return b.indexOf("<"+c.toLowerCase()+">")>-1?a:""}):""},cdb.Utils.removeHTMLEvents=function(a){return a?a.replace(/ on\w+="[^"]*"/g,""):""},cdb.Utils.truncate=function(a,b){return a.substr(0,b-1)+(a.length>b?"&hellip;":"")},cdb.Utils.isURL=function(a){var b=/^((http|https|ftp)\:\/\/)/g;return a?b.test(a):!1},cdb.Utils.readablizeBytes=function(a,b){if(!a||isNaN(a))return 0;var c=["bytes","kB","MB","GB","TB","PB"],d=Math.floor(Math.log(a)/Math.log(1024)),e=(a/Math.pow(1024,Math.floor(d))).toFixed(2);return b&&(e=parseInt(e)),e+" "+c[d]},cdb.Utils.isEmpty=function(a){return!a||0===a.length},cdb.Utils.isBlank=function(a){return!a||/^\s*$/.test(a)},cdb.Utils.formatNumber=function(a){if(!a)return"0";var b=a.toString().split(".");return b[0]=b[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),b.join(".")},cdb.Utils.rgbToHex=function(a,b,c){function d(a){var b=a.toString(16);return 1==b.length?"0"+b:b}return"#"+d(a)+d(b)+d(c)},cdb.Utils.hexToRGB=function(a){var b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return b?{r:parseInt(b[1],16),g:parseInt(b[2],16),b:parseInt(b[3],16)}:null},cdb.Utils.genRandomPass=function(a){function b(){var a=Math.random();return a=parseInt(1e3*a),a=a%94+33}function c(a){return a>=33&&47>=a?!0:a>=58&&64>=a?!0:a>=91&&96>=a?!0:a>=123&&126>=a?!0:!1}a=isNaN(a)?"":a;var d="",e=a?!1:!0;for(e&&(a=Math.random(),a=parseInt(100*a),a=a%7+6),i=0;i<a;i++){for(numI=b();c(numI);)numI=b();d+=String.fromCharCode(numI)}return d},cdb.Utils.pad=function(a,b){for(var c=a+"";c.length<b;)c="0"+c;return c},cdb.Utils.sanitizeString=function(a){return a.replace(/[^a-z0-9\s]/gi,"").replace(/[_\s]/g,"-")},cdb.Utils.readizableNumber=function(a){return a>=1e9?(a/1e9).toFixed(1)+"G":a>=1e6?(a/1e6).toFixed(1)+"M":a>=1e3?(a/1e3).toFixed(1)+"K":a},cdb.Utils.getFileExtension=function(a){return a?a.substr(a.lastIndexOf(".")+1):""},cdb.Utils.getGetOrdinal=function(a){if(!a)return"";var b=["th","st","nd","rd"],c=a%100;return a+(b[(c-20)%10]||b[c]||b[0])},cdb.admin.DropdownMenu=cdb.ui.common.Dropdown.extend({show:function(){var a=$.Deferred(),b=this;return this.delegateEvents(),this.$el.css({marginTop:"down"==b.options.vertical_position?"-10px":"10px",opacity:0,display:"block"}).animate({margin:"0",opacity:1},{duration:this.options.speedIn,complete:function(){a.resolve()}}),this.trigger("onDropdownShown",this.el),a.promise()},openAt:function(a,b){var c=$.Deferred();return this.$el.css({top:b,left:a,width:this.options.width}).addClass(("up"==this.options.vertical_position?"vertical_top":"vertical_bottom")+" "+("right"==this.options.horizontal_position?"horizontal_right":"horizontal_left")+" tick_"+this.options.tick),this.isOpen=!0,$.when(this.show()).done(function(){c.resolve()}),c.promise()},hide:function(a){if(!this.isOpen)return void(a&&a());var b=this;this.isOpen=!1,this.$el.animate({marginTop:"down"==b.options.vertical_position?"10px":"-10px",opacity:0},this.options.speedOut,function(){$(b.options.target).removeClass("selected"),b.$el.hide(),a&&a(),b.trigger("onDropdownHidden",b.el)})}}),cdb.admin.StringField=cdb.core.View.extend({tagName:"div",className:"field string",default_options:{template_name:"old_common/views/forms/string_field",label:!1,autoResize:!0,readOnly:!1},events:{"change textarea":"_onChange","keydown textarea":"_onKeyDown"},initialize:function(){_.defaults(this.options,this.default_options),_.bindAll(this,"_onChange","_onKeyDown"),this.template_base=this.options.template_base?_.template(this.options.template_base):cdb.templates.getTemplate(this.options.template_name),this.valid=!0,this._setOS()},render:function(){return this.$el.html(this.template_base(_.extend(this.model.toJSON(),this.options))),this.options.readOnly&&this.undelegateEvents(),this.options.autoResize&&this._resize(),this},_setOS:function(){var a=navigator.userAgent.toLowerCase();this.so="rest",/mac os/.test(a)&&(this.so="mac")},isValid:function(){return this.valid},_onChange:function(a){var b=$(a.target).val();this.model.set("value",b)},_onKeyDown:function(a){if(("mac"==this.so&&a.metaKey||"rest"==this.so&&a.ctrlKey)&&13==a.keyCode)return a.preventDefault(),this._triggerEvent("ENTER"),!1;var b=$(a.target).val();this.model.set("value",b),this.options.autoResize&&this._resize()},_resize:function(){var a=this.$("textarea");a&&setTimeout(function(){a.height(20),a.height(a[0].scrollHeight-22)})},_triggerEvent:function(a,b){this.trigger(a,b,this)}}),cdb.forms.Color=cdb.core.View.extend({className:"form-view form_color",events:{"click .image-picker":"_openImagePicker","click .color-picker":"_openColorPicker"},initialize:function(){this.template=cdb.templates.getTemplate("old_common/views/color_form"),this.property=this.options.property,this.model.bind("change",this.render,this),this.image_property=this.options.extra?this.options.extra.image_property:null,this.image_kind=this.options.extra?this.options.extra.image_kind:null,this.image_kind=this.image_kind||"marker"},render:function(){return this.$el.html(this.template({image_kind:this.image_kind,image_property:this.image_property,image_value:this.model.get(this.image_property),color:this.model.get(this.property)})),this.image_property&&this._createTooltips(),this},_createTooltips:function(){this.addView(new cdb.common.TipsyTooltip({el:this.$(".image-picker"),delayIn:100}))},_createPicker:function(){var a,b,c;this.options.extra&&(this.options.extra.tick&&(a=this.options.extra.tick),this.options.extra.picker_vertical_position&&(b=this.options.extra.picker_vertical_position),this.options.extra.picker_horizontal_position&&(c=this.options.extra.picker_horizontal_position)),this.color_picker=new cdb.admin.ColorPicker({target:this.$el,colors:this.options.colors,extra_colors:this.options.extra_colors,tick:a,vertical_position:b,horizontal_position:c}).bind("colorChosen",function(a,b){this.image_property==this.property?this.model.set(this.property,a):(this.model.unset(this.image_property,{silent:!0}),this.model.set(this.property,a)),b&&this._destroyPicker()},this),this._bindColorPicker(),this.addView(this.color_picker)},_destroyPicker:function(){this.color_picker&&(this._unbindColorPicker(),this.removeView(this.color_picker),this.color_picker.hide(),delete this.color_picker)},_bindColorPicker:function(){cdb.god.bind("closeDialogs",this._destroyPicker,this),cdb.god.bind("closeDialogs:color",this._destroyPicker,this)},_unbindColorPicker:function(){cdb.god.unbind("closeDialogs",this._destroyPicker,this),cdb.god.unbind("closeDialogs:color",this._destroyPicker,this)},setExtraColors:function(a){this.color_picker&&this.color_picker.setColors("extra_colors",a)},setColors:function(a){this.color_picker&&this.color_picker.setColors("colors",a)},_openImagePicker:function(a){if(this.killEvent(a),!this.image_property)return this;if(cdb.god.trigger("closeDialogs:color"),this.user=new cdb.admin.User(window.user_data),this.user.featureEnabled("new_modals")){var b=new cdb.editor.ImagePickerView({user:this.user,kind:this.image_kind});b.appendToBody(),b.bind("fileChosen",function(a){this.image_property&&(this.image_property==this.property?this.model.set(this.image_property,"url("+a+")"):(this.model.unset(this.property,{silent:!0}),this.model.set(this.image_property,"url("+a+")")))},this)}else this.image_picker&&this.image_picker.clean(),this.image_picker=new cdb.admin.AssetManager({user:this.options.user_data||window.user_data,kind:this.image_kind}),this.image_picker.appendToBody().open(),this.image_picker.bind("fileChosen",function(a){this.image_property&&(this.image_property==this.property?this.model.set(this.image_property,"url("+a+")"):(this.model.unset(this.property,{silent:!0}),this.model.set(this.image_property,"url("+a+")")))},this)},_openColorPicker:function(a){this.killEvent(a),this.color_picker&&this._destroyPicker(),cdb.god.trigger("closeDialogs:color"),this.color_picker||(this._createPicker(),$("body").append(this.color_picker.render().el),this.color_picker.init(this.model.get(this.property)))}}),cdb.forms.ColorWizard=cdb.forms.Color.extend({_createPicker:function(){if(this.model.layer&&this.model.layer.get("tile_style")){var a=this.model.layer.get("tile_style"),b=new cdb.admin.CartoParser(a);this.options.extra_colors=b.colorsUsed({mode:"hex"})}cdb.forms.Color.prototype._createPicker.call(this)}}),cdb.forms.Hidden=cdb.core.View.extend({className:"form-view form_hidden",initialize:function(){this.add_related_model(this.model)}}),cdb.forms.SimpleNumber=cdb.core.View.extend({className:"form-view form_spinner",defaults:{max:999999999999,min:-999999999999,inc:1,width:25,pattern:/^-?[0-9]+\.?[0-9]*$/,debounce_time:200,disable_triggering:!1},events:{"click .plus":"_plus","click .minus":"_minus","keypress input.value":"_checkInputPress","keydown input.value":"_checkInputPress","keyup input.value":"_checkInputUp","change .value":"_checkValueChange",click:"_showSlider"},initialize:function(){_.bindAll(this,"_fireChange","_checkNumber"),this.property=this.options.property,this.model.bind("change",this.render,this),(!this.options.pattern||"object"!=typeof this.options.pattern||"object"==typeof this.options.pattern&&!this.options.pattern.test)&&delete this.options.pattern,_.defaults(this.options,this.defaults),this.options.noSlider||this._initSlider(),this.options.debounce_time>0&&(this._fireChange=_.debounce(this._fireChange,this.options.debounce_time))},render:function(a){var b=this.options.initValue||this.model.get(this.property);return a&&_.isNumber(a)&&(b=a),this.$el.html('<input class="value" '+(this.options.disabled?"readonly":"")+' value="" style="width:'+this.options.width+'px!important"/><a href="#" class="plus">+</a><a href="#" class="minus">-</a>'),this.$(".value").val(b),this.options.classes&&this.$el.addClass(this.options.classes),this.options.disabled&&(this.undelegateEvents(),this.$el.addClass("disabled").find("a").bind("click",this.killEvent)),this},_fireChange:function(){this.model.change()},_changeValue:function(a){this.model.set(a,{silent:!0}),this._fireChange()},inc:function(a){var b={},c=b[this.property]=parseFloat(this.model.get(this.property))+a;c=b[this.property]=Math.min(this.options.max,c.toFixed?c.toFixed(1):1*c),b[this.property]=Math.max(this.options.min,c),this._changeValue(b),this.render(b[this.property])},_plus:function(a){return a&&a.preventDefault(),this.trigger("saved",this),this.inc(this.options.inc),!1},_minus:function(a){return a&&a.preventDefault(),this.trigger("saved",this),this.inc(-this.options.inc),!1},_initSlider:function(){var a=this;this.spinner_slider=new cdb.admin.SpinnerSlider({target:this.$el,template_base:"old_common/views/spinner_slider"}).bind("valueSet",function(b){var c={};c[a.property]=b,a.model.set(c)}).bind("valueChanged",function(b){a.$el.find(".value").val(b)}),this.addView(this.spinner_slider)},_checkNumber:function(a){return this.options.pattern.test(a)},_checkInputPress:function(a){var b=String.fromCharCode(a.charCode);return"-"==b||"."==b||1*b!==NaN?!0:(a.preventDefault(),a.stopPropagation(),!1)},_checkInputUp:function(a){this.value?null:this.value=this.model.get(this.property);var b=$(a.target).val();return 40==a.keyCode?(a.preventDefault(),a.stopPropagation(),this.inc(-this.options.inc),this._saveValue(a),this.$el.find("input").focus(),!1):38==a.keyCode?(a.preventDefault(),a.stopPropagation(),this.inc(this.options.inc),this._saveValue(a),this.$el.find("input").focus(),!1):13===a.keyCode?(this._saveValue(a,!0),!1):(this._checkNumber(b)||"-"==b||""==b?"-"!=b&&""!=b&&(this.value=$(a.target).val()):this.$el.find("input.value").val(this.value),!0)},_checkValueChange:function(a){var b=$(a.target).val();return b=""==b||"-"==b?0:1*b,this._checkNumber(b)?(this._saveValue(a,!0),this.value=$(a.target).val()):this.$el.find("input.value").val(this.value),!0},_saveValue:function(a,b){var c={},d=this.$el.find("input.value").val(),e=this.options.min<0&&this.options.max>0?0:this.options.min,f=""==d||"-"==d?e:1*d;f<this.options.min&&(f=this.options.min),f>this.options.max&&(f=this.options.max),this.$el.find("input.value").val(f),c[this.property]=f,this.model.set(c),this.trigger("saved",this),b&&!this.options.disable_triggering&&cdb.god.trigger("closeDialogs")},_showSlider:function(a){a.preventDefault(),a.stopPropagation(),this.$el.find("input").focus()}}),cdb.forms.SimpleNumberWithLabel=cdb.forms.SimpleNumber.extend({className:"form-view form_spinner with-label",render:function(a){var b=this.options.initValue||this.model.get(this.property);return a&&_.isNumber(a)&&(b=a),this.$el.html('<span class="label">'+this.options.label+'</span><div class="input"><input class="value" '+(this.options.disabled?"readonly":"")+' value="" style="width:'+this.options.width+'px!important"/><a href="#" class="plus">+</a><a href="#" class="minus">-</a></div>'),this.$(".value").val(b),this.options.classes&&this.$el.addClass(this.options.classes),this.options.disabled&&(this.undelegateEvents(),this.$el.addClass("disabled").find("a").bind("click",this.killEvent)),this}}),cdb.forms.Spinner=cdb.core.View.extend({className:"form-view form_spinner",defaults:{max:999999999999,min:-999999999999,inc:1,width:25,pattern:/^-?[0-9]+\.?[0-9]*$/,debounce_time:200},events:{"click .plus":"_plus","click .minus":"_minus","keypress input.value":"_checkInputPress","keydown input.value":"_checkInputPress","keyup input.value":"_checkInputUp","change .value":"_checkValueChange",click:"_showSlider"},initialize:function(){_.bindAll(this,"_fireChange","_checkNumber"),this.property=this.options.property,this.model.bind("change",this.render,this),(!this.options.pattern||"object"!=typeof this.options.pattern||"object"==typeof this.options.pattern&&!this.options.pattern.test)&&delete this.options.pattern,_.defaults(this.options,this.defaults),this.options.noSlider||this._initSlider(),this.options.debounce_time>0&&(this._fireChange=_.debounce(this._fireChange,this.options.debounce_time))},render:function(a){var b=this.options.initValue||this.model.get(this.property);return a&&_.isNumber(a)&&(b=a),this.$el.html('<input class="value" '+(this.options.disabled?"readonly":"")+' value="" style="width:'+this.options.width+'px!important"/><a href="#" class="plus">+</a><a href="#" class="minus">-</a>'),this.$(".value").val(b),this.options.disabled&&(this.undelegateEvents(),this.$el.addClass("disabled").find("a").bind("click",this.killEvent)),this},_fireChange:function(){this.model.change()},_changeValue:function(a){this.model.set(a,{silent:!0}),this._fireChange()},inc:function(a){var b={},c=b[this.property]=this.model.get(this.property)+a;c=b[this.property]=Math.min(this.options.max,c.toFixed?c.toFixed(1):1*c),b[this.property]=Math.max(this.options.min,c),this._changeValue(b),this.render(b[this.property])},_plus:function(a){return a&&a.preventDefault(),this.inc(this.options.inc),!1},_minus:function(a){return a&&a.preventDefault(),this.inc(-this.options.inc),!1},_initSlider:function(){var a=this;this.spinner_slider=new cdb.admin.SpinnerSlider({target:this.$el,template_base:"old_common/views/spinner_slider"}).bind("valueSet",function(b){var c={};c[a.property]=b,a.model.set(c)}).bind("valueChanged",function(b){a.$el.find(".value").val(b)}),this.addView(this.spinner_slider)},_checkNumber:function(a){return this.options.pattern.test(a)},_checkInputPress:function(a){var b=String.fromCharCode(a.charCode);return"-"==b||"."==b||1*b!==NaN?!0:(a.preventDefault(),a.stopPropagation(),!1)},_checkInputUp:function(a){this.value?null:this.value=this.model.get(this.property);var b=$(a.target).val();return 13===a.keyCode?(this._saveValue(a),!1):(this._checkNumber(b)||"-"==b||""==b?"-"!=b&&""!=b&&(this.value=$(a.target).val()):this.$el.find("input.value").val(this.value),!0)},_checkValueChange:function(a){var b=$(a.target).val();return b=""==b||"-"==b?0:1*b,this._checkNumber(b)?(this._saveValue(a),this.value=$(a.target).val()):this.$el.find("input.value").val(this.value),!0},_saveValue:function(a){var b={},c=this.$el.find("input.value").val(),d=this.options.min<0&&this.options.max>0?0:this.options.min,e=""==c||"-"==c?d:1*c;this.$el.find("input.value").val(e),b[this.property]=e,this.model.set(b),cdb.god.trigger("closeDialogs")},_showSlider:function(a){this.options.noSlider||(a.stopPropagation(),cdb.god.unbind("closeDialogs",this.spinner_slider.hide,this.spinner_slider),cdb.god.trigger("closeDialogs"),this.spinner_slider.el.parentElement||($("body").append(this.spinner_slider.render().el),this.spinner_slider.init(this.options.max,this.options.min,this.options.inc,this.$el.find("input.value").val()),cdb.god.bind("closeDialogs",this.spinner_slider.hide,this.spinner_slider),cdb.god.bind("closeDialogs:color",this.spinner_slider.hide,this.spinner_slider)),this.$el.find("input.value").focus())}}),cdb.forms.Opacity=cdb.forms.Spinner.extend({initialize:function(){_.defaults(this.options,{max:1,min:0,inc:.1}),this.$el.addClass("opacity"),cdb.forms.Spinner.prototype.initialize.call(this)}}),cdb.forms.SimpleOpacity=cdb.forms.SimpleNumber.extend({initialize:function(){_.defaults(this.options,{max:1,min:0,inc:.1}),this.$el.addClass("opacity"),cdb.forms.Spinner.prototype.initialize.call(this)}}),cdb.forms.OpacityPolygon=cdb.forms.Spinner.extend({initialize:function(){_.defaults(this.options,{max:1,min:0,inc:.1}),this.$el.addClass("opacity"),this.model.bind("change",function(){this.switchProperty()},this),cdb.forms.Spinner.prototype.initialize.call(this)},switchProperty:function(){if(this.model.get("polygon-pattern-file")){if(!this.originalProperty){this.originalProperty=this.property,this.property="polygon-pattern-opacity";var a=this.model.get(this.property);this.model.set(this.property,void 0===a?this.model.get(this.originalProperty):a),this.model.unset(this.originalProperty)}}else"polygon-pattern-opacity"===this.property&&(this.property=this.originalProperty,this.originalProperty=null,this.model.set(this.property,this.model.get("polygon-pattern-opacity")),this.model.unset("polygon-pattern-opacity"))}}),cdb.forms.Width=cdb.forms.Spinner.extend({initialize:function(){_.defaults(this.options,{max:40,min:0,inc:.5}),cdb.forms.Spinner.prototype.initialize.call(this)}}),cdb.forms.Combo=cdb.core.View.extend({className:"form-view form_combo",options:{minimumResultsForSearch:20,placeholder:"",formatResult:!1,formatSelection:!1,matcher:!1,dropdownCssClass:""},events:{"change select":"_changeSelection"},initialize:function(){_.bindAll(this,"_onUpdate","_changeSelection"),this.data=this.options.extra,this.model&&(this.add_related_model(this.model),this.model.bind("change:"+this.options.property,this._onUpdate,this))},deselect:function(){this.$el.find("select").val("").change()},updateData:function(a){this.data=a,this._onUpdate()},_onUpdate:function(){this.render()},_getOptions:function(){var a=_.map(this.data,function(a){return _.isArray(a)?'<option value="'+a[1]+'">'+a[0]+"</option>":"<option>"+a+"</option>"}).join("");return this.options.placeholder&&(a="<option></option>"+a),a},_setValue:function(a){this.$select.val(a)},render:function(){this.$select=$("<select>"+this._getOptions()+"</select>");var a=this.model&&this.model.get("method")&&this.model.get("method").replace(/ /g,"_").toLowerCase();if(this.$select.attr({style:this.options.width?"width:"+this.options.width:""}),this.$select.addClass(this.options.property+(a?" "+a:"")),this.options.disabled&&this.$select.attr("disabled",""),this._setValue(this.model&&this.model.get(this.options.property)||this.options.property),this.$el.html(this.$select),!this.options||!this.options.plainSelect){var b=this.$("select");b.select2("destroy");var c={minimumResultsForSearch:this.options.minimumResultsForSearch,placeholder:this.options.placeholder,dropdownCssClass:this.options.dropdownCssClass};this.options.formatResult&&(c.formatResult=this._formatResult),this.options.formatSelection&&(c.formatSelection=this._formatSelection),this.options.matcher&&(c.matcher=this._matcher),b.select2(c)}return this},_changeSelection:function(a){var b={},c=this.$("select").val();b[this.options.property]=c,this.model&&(c?this.model.set(b):this.model.set(b,{silent:!0})),c&&this.trigger("change",b[this.options.property])},_formatResult:function(a){return a.id||a.text},_matcher:function(a,b,c){return b.toUpperCase().indexOf(a.toUpperCase())>=0},clean:function(){this.$select.select2("destroy"),cdb.core.View.prototype.clean.call(this)}}),cdb.forms.Switch=cdb.core.View.extend({events:{click:"_onClick"},tagName:"a",className:"form-view form_switch",initialize:function(){this.property=this.options.property,this.model.bind("change:"+this.property,this._change,this)},_onClick:function(a){if(a.preventDefault(),!this.$el.hasClass("inactive")){var b={},c=!this.model.get(this.property);b[this.property]=c,this.model.set(b),this.trigger("switched",this.property,c)}return!1},_change:function(){this.model.get(this.property)?this.$el.removeClass("disabled").addClass("enabled"):this.$el.removeClass("enabled").addClass("disabled")},render:function(){return this.$el.append("<span class='handle'></span>"),this._change(),this}}),cdb.forms.TextAlign=cdb.core.View.extend({className:"form-view form_align",defaults:{debounce_time:200},events:{"click .align":"_align"},initialize:function(){_.bindAll(this,"_fireChange"),this.property=this.options.property,this.template=cdb.templates.getTemplate("old_common/views/text_align"),this.model.bind("change",this.render,this),(!this.options.pattern||"object"!=typeof this.options.pattern||"object"==typeof this.options.pattern&&!this.options.pattern.test)&&delete this.options.pattern,_.defaults(this.options,this.defaults),this.options.debounce_time>0&&(this._fireChange=_.debounce(this._fireChange,this.options.debounce_time))},_fireChange:function(){this.model.change()},_align:function(a){a&&a.preventDefault();var b=$(a.target).attr("data-align"),c={};c[this.property]=b,this.model.set(c,{silent:!0}),this._fireChange()},render:function(a){var b=this.options.initValue||this.model.get(this.property),c=this.options.alignments||{},d=void 0===c.left?!0:c.left,e=void 0===c.right?!0:c.right,f=void 0===c.center?!0:c.center;return this.$el.html(this.template({left:d,right:e,center:f})),this.$el.find("a[data-align='"+b+"']").addClass("selected"),this.options.disabled&&(this.undelegateEvents(),this.$el.addClass("disabled").find("a").bind("click",this.killEvent)),this}}),cdb.admin.overlays.Text=cdb.geo.ui.Text.extend({className:"text overlay snap",template_name:"table/views/overlays/text",events:{"mouseenter .text":"_onMouseEnter","click .close":"_close","click .content":"_onClickEdit","click .text":"_onClickEdit","dblclick .content":"_onDblClick","dblclick .text":"_onDblClick","keyup .text":"_onKeyUp","paste .text":"_onPaste"},form_data:[{name:"Text",form:{"font-size":{type:"simple_number",value:12,min:5,max:50,inc:2,disable_triggering:!0},color:{type:"color",value:"#FFF",extra:{tick:"left",picker_horizontal_position:"left",picker_vertical_position:"down"}},"font-family-name":{type:"select",value:"Helvetica",extra:["Helvetica","Droid Sans","Vollkorn","Roboto","Open Sans","Lato","Graduate","Gravitas One","Old Standard TT"]},"text-align":{type:"text_align",value:"left"}}},{name:"Box",form:{"box-color":{type:"color",value:"#000",extra:{tick:"left",picker_horizontal_position:"left",picker_vertical_position:"down"}},"box-opacity":{type:"simple_opacity",value:.7,min:0,max:1,inc:.1,disable_triggering:!0},"box-padding":{type:"simple_number_with_label",value:10,min:5,max:200,inc:1,label:"P",disable_triggering:!0}}},{name:"Max Width",form:{"box-width":{type:"simple_number",value:300,min:50,max:2e3,inc:10,disable_triggering:!0}}}],initialize:function(){_.bindAll(this,"_close","_onChangeMode","_onKeyDown"),this.template=this.getTemplate(this.template_name),this._setupModels()},_setupModels:function(){var a=this,b=this.model.get("extra");this.model.set({text:b.text},{silent:!0});var c=function(){a._applyStyle(!0)};this.model.bind("remove",this.hide,this),this.model.bind("change:style",c,this),this.model.bind("change:text",this._setText,this),this.model.bind("change:display",this._onChangeDisplay,this),this.model.bind("change:extra",this._onChangeExtra,this),this.model.bind("change:selected",this._onChangeSelected,this),this.editModel=new cdb.core.Model({mode:""}),this.editModel.bind("change:mode",this._onChangeMode,this),this.add_related_model(this.editModel)},_onKeyUp:function(a){this.timeout&&clearTimeout(this.timeout),this.model.set({text:this.$text.html()},{silent:!0})},_onClickEdit:function(a){this.killEvent(a),cdb.god.trigger("closeOverlayDropdown"),$(document).bind("keydown",this._onKeyDown),this._savePosition(!1),this.trigger("clickEdit",this.model,this.form_data),this.model.set("selected",!0)},_onKeyDown:function(a){var b=this.model.get("selected");if(b){var c="editable"==this.editModel.get("mode"),d=this.$(".overlay_text").is(":focus");($(a.target).hasClass("overlay_text")||$(a.target).hasClass("cartodb-map"))&&(a.keyCode!==$.ui.keyCode.BACKSPACE||c&&d||(this.killEvent(a),this._close()))}a.keyCode===$.ui.keyCode.ESCAPE&&this.editModel.set("mode","")},_onPaste:function(a){var b=this;setTimeout(function(){var a=cdb.Utils.stripHTML(b.model.get("text"));b.model.set("text",a)},200)},_onDblClick:function(a){this.killEvent(a),this._savePosition(!0)},_savePosition:function(a){var b=this.model.get("extra"),c=this.model.get("x"),d=this.model.get("y"),e=this.$el.position().left,f=this.$el.position().top;b.portrait_dominant_side,b.landscape_dominant_side;0===d&&"bottom"===s&&(f=d),0===c&&"right"===r&&(e=c);var g=!0;if((e===c&&d===f||0===c&&"right"===r&&d===f||0==d&&"bottom"===s&&e===c)&&(g=!1,this.$el.addClass("selected"),a))return void this.editModel.set("mode","editable");c=this.$el.position().left,d=this.$el.position().top;var h=this.$el.width(),i=this.$el.height(),j=$(".cartodb-map").width()-c,k=$(".cartodb-map").height()-d,l=j-h,m=k-i,n=$(".cartodb-map").width(),o=$(".cartodb-map").width(),p=(c+h/2)/n*100,q=(d+i/2)/o*100,r=l>=c?"left":"right",s=m>=d?"top":"bottom";b.default_position=!1,b.landscape_dominant_side=r,b.portrait_dominant_side=s,b.top_percentage=q,b.left_percentage=p,b.right_position=l,b.bottom_position=m,b.right=j,b.bottom=k,b.width=h,b.height=i,this.model.set({extra:b},{silent:!0}),this.model.set({x:c,y:d}),g&&this.model.save()},_onMouseDown:function(){},_onMouseEnter:function(){this.$el.addClass("hover"),"editable"===this.editModel.get("mode")&&this.timeout&&clearTimeout(this.timeout)},show:function(a){this.$el.show(),this.$el.addClass("animated bounceIn");
},hide:function(a){var b=this;this.$el.removeClass("animated bounceIn").addClass("animated bounceOut").removeClass("selected"),a&&_.isFunction(a)&&a(),$(document).unbind("keydown",this._onKeyDown),cdb.god.unbind("closeDialogs",this._onCloseDialogs,this),setTimeout(function(){b.clean()},550)},_close:function(a){this.killEvent(a);var b=this;this.hide(function(){b.trigger("remove",b)})},_onChangeDisplay:function(){var a=this.model.get("display");a?this.show():this.$el.hide()},_onChangeExtra:function(){var a=this.model.get("extra");a.text=this.model.get("text"),this.model.set({extra:a},{silent:!0})},_applyStyle:function(a){var b=this.model.get("style"),c=b["box-color"],d=b["box-opacity"],e=b["box-width"],f=b["box-padding"],g=b["font-family-name"];this.$text.css(b),this.$(".content").css("padding",f),this.$text.css("font-size",b["font-size"]+"px"),this.$el.css("z-index",b["z-index"]);var h="rgba("+parseInt(c.slice(-6,-4),16)+","+parseInt(c.slice(-4,-2),16)+","+parseInt(c.slice(-2),16)+", "+d+" )";this.$el.css("background-color",h),this.$el.css("max-width",e);var i="";"Droid Sans"==g?i="droid":"Vollkorn"==g?i="vollkorn":"Open Sans"==g?i="open_sans":"Roboto"==g?i="roboto":"Lato"==g?i="lato":"Graduate"==g?i="graduate":"Gravitas One"==g?i="gravitas_one":"Old Standard TT"==g&&(i="old_standard_tt"),this.$el.css("width","auto"),this.$el.removeClass("droid").removeClass("vollkorn").removeClass("roboto").removeClass("open_sans").removeClass("lato").removeClass("graduate").removeClass("gravitas_one").removeClass("old_standard_tt"),this.$el.addClass(i),a&&this.model.save()},_onChangeSelected:function(){var a=this.model.get("selected");a?this.$el.addClass("selected"):(this.$el.removeClass("selected"),this._disableEditingMode())},_onChangeMode:function(){var a=this.editModel.get("mode");"editable"===a?this._enableEditingMode():this._disableEditingMode()},_enableEditingMode:function(){this.$el.addClass("editable").addClass("disabled"),this.$text.attr("contenteditable",!0).focus();var a=this.model.get("style"),b=a["box-width"],c=this.model.get("text");this.$el.css("width","auto"),this.$el.css("max-width",b),this.$text.html(c),this.$(".hint").fadeIn(150)},_isEmptyText:function(a){var b=new RegExp(/^(<div>)*(<br ?\/?>)*(<\/div>)*$/);return a.trim()&&!a.trim().match(b)?!1:!0},_disableEditingMode:function(){$(document).unbind("keydown",this._onKeyDown);var a=this._transformToMarkdown(this.model.get("text"));if(this.editModel.set("mode",""),this._isEmptyText(a))this._close();else{var b=this;b.$(".hint").fadeOut(150,function(){b.$el.removeClass("editable").removeClass("disabled"),b.$text.attr("contenteditable",!1),b.$el.css("width","auto"),setTimeout(function(){var c=b.$el.width(),d=b.model.get("extra");d.width=c,b.model.set({extra:d},{silent:!0}),b.model.isNew()||b.model.save(),b.$text.html(a),b.$el.css("width","auto")},100),b.model.isNew()||b.model.save()})}},_setText:function(){var a=this.model.get("text"),b=this._transformToMarkdown(a),c=this.model.get("extra");c.text=a,c.rendered_text=b,this.model.set({extra:c},{silent:!0}),b&&this.$text.html(b)},_transformToMarkdown:function(a){return a=markdown.toHTML(a),a=a.replace(/&lt;/g,"<"),a=a.replace(/&gt;/g,">"),a=a.replace(/<p>/g,""),a=a.replace(/&amp;nbsp;/g," "),a=a.replace(/<\/p>/g,"")},_place:function(){var a=this.editModel.get("mode"),b=this.model.get("extra");if("editable"!==a&&b){var c=b.landscape_dominant_side,d=b.portrait_dominant_side;"bottom"===d?(this.$el.offset({bottom:b.bottom_position}),this.$el.css({top:"auto",bottom:b.bottom_position})):this.$el.offset({top:this.model.get("y"),bottom:"auto"}),"right"===c?(this.$el.offset({right:b.right_position}),this.$el.css({left:"auto",right:b.right_position})):this.$el.offset({left:this.model.get("x"),right:"auto"})}},_onCloseDialogs:function(){void 0!==this.model.get("selected")&&this.model.set("selected",!1)},render:function(){this._place(),this.$el.append(this.template(this.model.attributes)),this.$text=this.$(".content div.text");var a=this._transformToMarkdown(this.model.get("text"));return this.$text.html(a),this._applyStyle(!1),this._onChangeExtra(),this.$el.addClass(this.model.get("device")),cdb.god.unbind("closeDialogs",this._onCloseDialogs,this),cdb.god.bind("closeDialogs",this._onCloseDialogs,this),this}}),cdb.admin.ImportPane=cdb.core.View.extend({className:"import-pane",initialize:function(){this.model=new cdb.admin.ImportPaneModel},render:function(){return this.$el.append(this.template({chosen:this.options.chosen})),this},getValue:function(){return this.model.toJSON()},setValue:function(a){this.model&&this.model.set(a)},submitUpload:function(){cdb.log.info('import pane without upload function "submitUpload"')}}),cdb.admin.ImportUrlPane=cdb.admin.ImportPane.extend({className:"import-pane import-url-pane",events:{"focusin input.url-input":"_onInputFocusIn","focusout input.url-input":"_onInputFocusOut","submit form":"_onSubmitForm","keyup input":"_onInputChange","keydown input":"_onInputChange"},_TEXTS:{urlError:_t("There is an error in the URL you've inserted. Please recheck.")},initialize:function(){if(this.user=this.options.user,!this.options.service_name||!this.options.type)throw new TypeError("Missing type or service name for import URL pane");if(this.model=new cdb.core.Model({type:this.options.type,value:"",interval:"0",service_name:this.options.service_name,service_item_id:"",valid:!1}),!this.options.template)throw new TypeError("Missing template for import URL pane");this.template=cdb.templates.getTemplate(this.options.template),this.render(),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.append(this.template()),this._initViews(),this},_initViews:function(){this.import_info=new cdb.admin.ImportInfo({el:this.$("div.infobox"),model:this.model,acceptSync:this.options.acceptSync||this.user.get("actions").sync_tables}),this.addView(this.import_info)},_initBinds:function(){_.bindAll(this,"_onInputChange","_onSubmitForm","_onInputFocusIn","_onInputFocusOut"),this.model.bind("change:value change:interval",this._onValueChange,this)},_onInputChange:function(a){var b=$(a.target).val();return 13===a.which?(this._onSubmitForm(),!1):(this.model.set({value:b,service_item_id:b,valid:this._checkValid(b)}),void this._triggerAction("valueChange",b))},_onInputFocusIn:function(){this.$("div.upload").addClass("active")},_onInputFocusOut:function(){this.$("div.upload").removeClass("active")},_onSubmitForm:function(a){return a&&this.killEvent(a),this.model.get("valid")?this._triggerAction("fileChosen",this.model.attributes):this.import_info.activeTab("error",this._TEXTS.urlError),!1},_onValueChange:function(){this._triggerAction("valueChange",this.model.get("value"))},_triggerAction:function(a,b){this.trigger(a,b,this)},_checkValid:function(a){return cdb.Utils.isURL(a)}}),cdb.admin.ImportInfo=cdb.core.View.extend({_TEXTS:{upgrade:_t('To mantain your data in sync with the source                         <a href="#/showUpgrade">upgrade your plan</a>.'),xls_tip:_t("XLS files take longer than CSV files. Export it as                     CSV from Excel to import faster!"),zip_tip:_t("Did you know you can upload compressed files?                     They will import faster!")},initialize:function(){this._initPanes(),this.model.bind("change:value",this._onChangeValue,this)},render:function(){},_initPanes:function(){this.importXLSTip=new cdb.admin.ImportInfo.Message({className:"info tips xls-tips",msg:this._TEXTS.xls_tip}),this.importZipTip=new cdb.admin.ImportInfo.Message({className:"info tips zip-tips",msg:this._TEXTS.zip_tip}),this.syncPane=new cdb.admin.ImportInfo.Sync,this.syncPane.bind("periodChange",this._updatePeriod,this),this.syncDisabledPane=new cdb.admin.ImportInfo.Message({className:"info no-sync",msg:this._TEXTS.upgrade}),this.syncDisabledPane.bind("showUpgrade",this._triggerUpgrade,this),this.errorPane=new cdb.admin.ImportInfo.Message({className:"info error"}),this.errorPane.bind("showUpgrade",this._triggerUpgrade,this),this.panes=new cdb.ui.common.TabPane({el:this.$el}),this.panes.addTab("xls",this.importXLSTip),this.panes.addTab("zip",this.importZipTip),this.panes.addTab("sync",this.syncPane),this.panes.addTab("sync_disabled",this.syncDisabledPane),this.panes.addTab("error",this.errorPane),this.panes.bind("tabEnabled",this._showTab,this),this.panes.bind("tabDisabled",this._hideTab,this),this.addView(this.panes),this.$el.append(this.panes.render())},_onChangeValue:function(){var a=this.model.get("value");this.panes.activePane;if(a)if(cdb.Utils.isURL(a)&&void 0!==this.options.acceptSync)if(this.options.acceptSync)this.activeTab("sync");else{var b=/\.[0-9a-z]+$/i,c=a.match(b);if(c){var d=c[0].toLowerCase(),e=_.contains(this.options.fileTypes,d.replace(".",""));if(e){if(".xls"===d||".xlsx"===d)return this.activeTab("xls"),!1;var f=[".zip",".tar",".gz",".tgz",".bz2"];if(!_.contains(f,d))return this.activeTab("zip"),!1}}this.activeTab("sync_disabled")}else this._hideTab();else this._hideTab()},activeTab:function(a,b){var c=this.panes.getPane(a);b&&c.setMessage(b),this.panes.activeTab==a?this._showTab():this.panes.active(a)},hideTab:function(){var a=this.panes.activePane;setTimeout(function(){a.$el.removeClass("active")},50)},_showTab:function(){var a=this.panes.activePane;setTimeout(function(){a.$el.addClass("active")},50)},_hideTab:function(){var a=this.panes.activePane;this.panes.activePane.$el.removeClass("active"),setTimeout(function(){a.reset()},500)},_updatePeriod:function(a){this.model.set("interval",a)},_triggerUpgrade:function(){this.trigger("showUpgrade")}}),cdb.common.Url=cdb.core.Model.extend({initialize:function(a){if(!a.base_url)throw new Error("base_url is required")},urlToPath:function(){return cdb.common.Url.byBaseUrl(this.toString.apply(this,arguments))},pathname:function(){return this.toString().match(/^.+\/\/[^\/]+(.*)$/)[1]},toString:function(){return this._joinArgumentsWithSlashes(this.get("base_url"),Array.prototype.slice.call(arguments,0))},_joinArgumentsWithSlashes:function(){return _.chain(arguments).flatten().compact().value().join("/")}},{byBaseUrl:function(a){return new cdb.common.Url({base_url:a})}}),cdb.common.DashboardVisUrl=cdb.common.Url.extend({lockedItems:function(){return this.urlToPath("locked")},sharedItems:function(){return this.urlToPath("shared")},likedItems:function(){return this.urlToPath("liked")}}),cdb.ui.common.BackgroundImporter=cdb.core.View.extend({default_options:{import_:{state:""}},events:{"click a.error":"_showError","click a.table":"_showTable","click a.cancel":"_showCancel"},className:"background_importer",initialize:function(){_.bindAll(this,"show","hide","changeState"),_.defaults(this.options,this.default_options),this.template_base=cdb.templates.getTemplate(this.options.template_base),this.import_=this.options.import_,this.current_state=this.import_.state||"",this.add_related_model(this.import_)},render:function(){var a=this.template_base(this.import_);return this.$el.html(a),a.length>50&&(this.$el.stop().css({opacity:1}).animate({bottom:"20px"},500),this.delegateEvents()),this},changeState:function(a){var b=this;return this.current_state==a.state?!1:(this.current_state=a.state,this.import_=a,void 0!=this.import_.success&&(this.import_.state=this.import_.success?"complete":"failure"),void this.$el.stop().animate({opacity:0},150,function(){b.render()}))},_showTable:function(a){a.preventDefault(),window.location.href=cdb.config.prefixUrl()+"/tables/"+(this.import_.table_name||this.import_.table_id)},_showCancel:function(a){a.preventDefault(),this.trigger("canceled"),this.hide()},_showError:function(a){a.preventDefault();var b=new cdb.admin.CreateErrorDialog({$el:$("body"),model:this.import_});this.$el.append(b.render().el),b.open(),this.$el.animate({bottom:"-35px"},300)},hide:function(){this.$el.stop().animate({opacity:0,bottom:"-35px"},500)}}),cdb.admin.BaseDialog=cdb.ui.common.Dialog.extend({hide:function(a){var b=this,c=parseInt(this.$el.find(".modal").css("marginTop"),10);this.$el.find(".modal").animate({marginTop:c-50,opacity:0},300,function(){b.options.clean_on_hide&&b.clean(),a&&a()}),this.$el.find(".mamufas").fadeOut(300),this.trigger("was_removed",this)},open:function(a){if(this.trigger("will_open",this),this.$el.find(".modal").css({opacity:"0",marginTop:"170px"}),this.$el.find(".mamufas").fadeIn(),a&&a.center){var b=this.$(".modal").height()/2;this.$(".modal").css({top:"50%",opacity:"0",marginTop:-b+50}).animate({marginTop:-b,opacity:1},300)}else this.$el.find(".modal").animate({marginTop:"120px",opacity:1},300)},setWizard:function(a){this.option=a||0,_.bindAll(this,"_changeOption"),this.$el.delegate("ul > li > a.radiobutton","click",this._changeOption)},activeWizardOption:function(a){var b=this.$("li[data-option="+a+"]");b.find(" > a.radiobutton").click()},render:function(){return cdb.ui.common.Dialog.prototype.render.call(this),this.activeWizardOption(this.option),this},_changeOption:function(a){a.preventDefault();var b=$(a.target),c=b.closest("ul"),d=b.closest("li");return b.hasClass("disabled")||b.hasClass("selected")?!1:(c.find("li.active").removeClass("active").find(" > a.radiobutton").removeClass("selected"),this.option=d.attr("data-option"),b.addClass("selected"),void d.addClass("active"))},centerInScreen:function(a){var b=this.$el.find(".modal:visible:eq(0)"),c=b.height();c>0&&b.animate({marginTop:-(c/2)},a?300:0)},enableOkButton:function(){this.$("a.ok").removeClass("disabled").removeAttr("disabled","disabled")},disableOkButton:function(){this.$("a.ok").addClass("disabled").attr("disabled","disabled")}}),cdb.common.CreateDialog=cdb.admin.BaseDialog.extend({_TEXTS:{title:_t("Select the source to import new data"),ok:_t("Create table")},_UPLOADER:{url:"/api/v1/imports",maxFileSize:1e8,maxUploadFiles:1,acceptFileTypes:["csv","xls","xlsx","zip","kml","geojson","json","ods","kmz","tsv","gpx","tar","gz","tgz","osm","bz2","tif","tiff","txt","sql"],acceptSync:!1},options:{tabs:["file","gdrive","dropbox","twitter","scratch","success","error"],option:"file",where:"table"},initialize:function(){var a=this;this.tabs=this.options.tabs,this.user=this.options.user,this.options.states=this.options.states||cdb.common.CreateDialog.states,this.model=new cdb.common.CreateDialog.Model,this._setUserLimits();var b=window.location.protocol+"//"+cdb.config.get("account_host")+"/account/"+this.user.get("username")+"/upgrade",c=this.user.get("show_upgrade_message")&&"free"===this.user.get("acount_type").toLowerCase();_.extend(this.options,{title:this._TEXTS.title,description:"",template_name:"old_common/views/create_dialog/create_dialog_base",clean_on_hide:!0,ok_button_classes:"button green disabled",ok_title:this._TEXTS.ok,modal_type:"create-dialog",width:585,can_trial:c,upgrade_url:b}),cdb.admin.BaseDialog.prototype.initialize.apply(this),setTimeout(function(){a._checkData()},100)},render_content:function(){var a=this,b=new cdb.common.CreateDialog.Content({model:this.model,user:this.options.user,tabs:this.options.tabs,states:this.options.states,option:this.options.option,uploader:this._UPLOADER,$dialog:this.$el});this.$(".content").append(b.render().el),b.bind("showUpgrade",this._showUpgrade,this),b.bind("changeSize",function(){setTimeout(function(){a.centerInScreen(!0)},300)},this),this.addView(b);var c=new cdb.common.CreateDialog.Uploader({model:this.model,user:this.options.user,uploader:this._UPLOADER});this.$(".content").append(c.render().el),c.bind("creationComplete",this._onCreationComplete,this),this.addView(c)},centerInScreen:function(){var a=this.$(".modal").height()/2;this.$(".modal").animate({top:"50%",marginTop:-a},150)},_setUserLimits:function(){this.options.uploader&&(this._UPLOADER=_.extend(this._UPLOADER,this.options.uploader)),_.isNull(this.user.get("remaining_byte_quota"))||(this._UPLOADER.maxFileSize=this.user.get("remaining_byte_quota")*(this.user.get("actions").import_quota||1)),_.isNull(this.user.get("remaining_table_quota"))||(this._UPLOADER.remainingQuota=_.isNull(this.user.get("remaining_table_quota"))||this.user.get("remaining_table_quota")>0),!_.isNull(this.user.get("actions"))&&this.user.get("actions").sync_tables&&(this._UPLOADER.acceptSync=this.user.get("actions").sync_tables)},_checkData:function(){if(!_.isEmpty(this.options.data)){var a=this.options.data;this.model.set({state:"added",option:"file",upload:{type:a.files?"file":"url",value:a.files&&a.files[0]||a.url,valid:!0,interval:0,progress:0}})}},_onCreationComplete:function(){this.trigger("importCompleted",this.model.get("upload"),this)},_onCreationDone:function(){this.trigger("importDone",this.model.get("upload"),this)},_showUpgrade:function(){this.trigger("showUpgrade",this),this.hide()},_keydown:function(a){var b=["idle","reset","abort","added","error"],c=this.model.get("state");27===a.keyCode&&_.contains(b,c)&&this.hide()},hide:function(){this.trigger("closedDialog",this),cdb.admin.BaseDialog.prototype.hide.call(this)},_ok:function(a){a&&this.killEvent(a);var b=this.model.get("state"),c=this.model.get("option"),d=this.model.get("upload").valid;switch(b){case"idle":case"abort":case"reset":d&&("layer"===c?this._onCreationComplete():this.model.set("state","selected"));break;case"enqueued":case"pending":case"importing":case"uploading":case"unpacking":this.trigger("importStarted",this.model.get("upload"),this);break;case"getting":case"creating":break;case"complete":this._onCreationDone();break;case"error":this.hide();break;default:cdb.log.info(b+" state not listed")}},clean:function(){$(document).unbind("keydown",this._keydown),cdb.admin.BaseDialog.prototype.clean.call(this)}}),cdb.common.CreateDialog.Actions=cdb.core.View.extend({_VALID_STATES_OK:["idle","reset","abort","added","importing","uploading","unpacking","complete","error"],initialize:function(){this.enabled_tabs=this.options.enabled_tabs,this.tabs=this.options.tabs,this.panes=this.options.panes,this.$dialog=this.options.$dialog,this.states=this.options.states,this._initBinds()},_initBinds:function(){this.model.bind("change",this._setState,this)},_setState:function(a,b){var c=this.model.get("state"),d=this.states[c],e=this.model.get("option");if(!d)return cdb.log.info("State "+c+" not defined"),!1;if(d.title&&(b.changes.state||b.changes.option)){var f=d.title.enabled["default"];void 0!==d.title.enabled[e]&&(f=d.title.enabled[e]),this.$dialog.find("h3")[f?"removeClass":"addClass"]("disabled")}if(d.navigation&&(b.changes.state||b.changes.option)){var f=d.navigation.enabled;this.$dialog.find(".create-tabs-navigation")[f?"removeClass":"addClass"]("disabled")}if(d.tabs&&b.changes.state){var g=d.tabs,f=g.enabled,h=this.model.get("navigation"),i=this;"error"!==c?_.each(this.panes.tabs,function(a,b){i.panes.activeTab!==b&&"error"!==b&&i.$dialog.find(".create-tab a."+b)[f?"removeClass":"addClass"]("disabled")}):(i.$dialog.find(".create-tab").each(function(a,b){var c=$(b).hasClass("error"),d=$(b).text(),e=i.model.get("error").error_code,f=i.model.get("error").title;d=(f?f:d)+(c&&e?" ("+e+")":""),$(b).css("z-index",1).find("> a").removeClass("selected").addClass(c?"show":"hide").find("span").text(d),c&&$(b).css({right:"other"===h?"-25%":"auto",left:"other"!==h?"-25%":"auto"})}),setTimeout(function(){i.$dialog.find(".create-tab.error").fadeIn(250);var a=d.ok.classes,b=i.$dialog.find("a.ok");b.text(q).removeClass().addClass(a),i.$dialog.find(".create-tab a.error").addClass("selected")},300))}var j=48,k=(this.$dialog.find(".create-content").height(),this.$dialog.find(".create-panes").height());if(d.content&&(b.changes.state||b.changes.option)){var f=d.content.enabled,l=this.$dialog.find(".create-content");l[f?"removeClass":"addClass"]("fixed"),f?l.height("auto"):l.animate({height:j},250);var m=["idle","reset","abort","added","error"],n="scratch"===e&&_.contains(m,c)?!0:!1;l[n?"addClass":"removeClass"]("compressed")}if(d.content&&b.changes.state){var f=d.content.enabled,l=this.$dialog.find(".create-panes");l.height(f?"auto":k);var o={opacity:f?1:0,marginTop:f?0:-(k+30)};l.animate(o,150),"error"===c&&(this.$dialog.find(".create-tab").animate({height:"110px"},150),this.$dialog.find(".create-tab.error span").fadeIn(200),l.find("div.item_queue_id").show())}if(d.progress&&(b.changes.state||b.changes.upload)){var p=d.progress,f=p.enabled,l=this.$dialog.find(".create-progress"),o={opacity:f?1:0};if(l.animate(o,150)[f?"show":"hide"](),("creating"===c||"uploading"===c)&&(this.$dialog.find(".info.sync").fadeOut(100),this.$dialog.find(".no-sync").fadeOut(100),this.$dialog.find(".create-content").animate({height:50},150),this.$dialog.find(".create-tab span").fadeOut(250),this.$dialog.find(".create-tab").animate({height:80},150)),p.text){var q=p.text["default"];if(void 0!==p.text[e]&&(q=p.text[e]),e&&_.isObject(p.text)&&p.text[e]){this.model.get("upload").type;p.text[this.model.get("option")][this.model.get("upload").type]&&(q=p.text[this.model.get("option")][this.model.get("upload").type])}l.find("p").text(q)}this.model.get("upload").progress?l.find(".progress-total").width(this.model.get("upload").progress+"%"):l.find(".progress-total").width("100%")}if(d.success&&(b.changes.state||b.changes.upload)){var f=d.success.enabled["default"];d.success.enabled[e]&&(f=d.success.enabled[e]),this.$dialog.find(".create-success")[f?"show":"hide"](),this.$dialog.find(".import-pane")[f?"hide":"show"](),this.$dialog.find(".ok.button").removeClass("disabled")}if(d.abort&&(b.changes.state||b.changes.upload)){var f=d.abort.enabled;this.$dialog.find("span.progress-stop")[f?"show":"hide"]()}if(d.upgrade&&(b.changes.state||b.changes.upload)){var f=d.upgrade.enabled;this.$dialog.find(".upgrade_message")[f?"show":"hide"]()}if(d.close&&(b.changes.state||b.changes.upload)){var f=d.close.enabled;this.$dialog.find("a.close")[f?"show":"hide"]()}if(b.changes.option){var f=_.contains(this.enabled_tabs,e),l=this.$dialog.find("div.foot");f?l.removeAttr("style"):l.hide()}if(d.ok&&(b.changes.state||b.changes.upload||b.changes.option)){var q=d.ok.text["default"];d.ok.text[e]&&(q=d.ok.text[e]);var r=d.ok.classes,s=d.ok.parent,l=this.$dialog.find("a.ok");l.text(q).removeClass().addClass(r),this.$dialog.find(".foot").removeClass("middle to_right").addClass(s);var t=this.model.get("upload").valid&&_.contains(this._VALID_STATES_OK,c)||"complete"==this.model.get("state");l[t?"removeClass":"addClass"]("disabled")}}}),cdb.common.CreateDialog.Content=cdb.core.View.extend({className:"create-dialog-content",_TABS:{layer:{method:"_genLayerPane",title:_t("Select layer")},file:{method:"_genFilePane",title:_t("Data file")},gdrive:{method:"_genGDrivePane",title:_t("Google Drive"),label:_t("(Google SpreadSheet, .CSV)")},dropbox:{method:"_genDropboxPane",label:_t("(CSV, XLS, KML, GPX)"),title:_t("Dropbox")},twitter:{method:"_genTwitterPane",title:_t("Twitter"),template:"old_common/views/import/import_twitter_disabled"},scratch:{method:"_genScratchPane",title:_t("Empty dataset")},instagram:{type:"other",method:"_genInstagramPane",title:_t("Instagram")},arcgis:{type:"other",method:"_genArcgisPane",title:_t("ArcGIS Server"),template:"old_common/views/import/import_arcgis_disabled"},salesforce:{type:"other",method:"_genSalesforcePane",title:_t("Salesforce"),template:"old_common/views/import/import_salesforce_disabled"},mailchimp:{type:"other",method:"_genMailchimpPane",title:_t("MailChimp"),label:" ",show_formats_link:!1,template:"old_common/views/import/import_mailchimp_disabled"},success:{method:"_genSuccessPane",title:_t("Ok")},error:{method:"_genErrorPane",title:_t("There has been an error with your import")}},_TAB_TEMPLATE:"<li class='create-tab <%- name %>'><a href='#/<%- name %>' class='<%- name %>'><i class='create-icon <%- name %>'></i><span><%= title %></span></a></li>",_TEXTS:{maxFileSize:_t('Looks like your file is too big for your available quota. <a                       href="#/showUpgrade" class="button green small upgrade">Upgrade now</a>'),limits:{key:_t("<%- name %> key is not specified and panel can't be enabled"),account:_t("<%- name %> data source is not available in your plan. Please upgrade"),limits:_t("You've reached the limits for your account. Please upgrade"),credits:_t("You've reached the available <%- name %> credits for your account this month")}},events:{"click .stop":"_onStopUpload","click .create-tabs-navigation a.popular":"_onNavTabClick","click .create-tabs-navigation a.other":"_onNavTabClick"},initialize:function(){this.tabs=this.options.tabs||[],this.enabled_tabs=this.tabs,this.option=this.options.option,this.uploader=this.options.uploader,this.user=this.options.user,this.$dialog=this.options.$dialog,this.template=cdb.templates.getTemplate(this.options.template||"old_common/views/create_dialog/create_dialog_content"),this._initBinds()},render:function(){return this._destroyBinds(),this.clearSubViews(),this.$el.empty(),this.$el.append(this.template()),this._genTabs(),this._genPanes(),this._setBinds(),this._genActionsController(),this._setSelectedTab(this.option),this},_initBinds:function(){_.bindAll(this,"_onNavTabClick","_onStopUpload")},_genTabs:function(){var a=this,b="",c="";_.each(this.tabs,function(d){a._TABS[d]?a._TABS[d].type?c+=_.template(a._TAB_TEMPLATE)({name:d,title:a._TABS[d].title}):b+=_.template(a._TAB_TEMPLATE)({name:d,title:a._TABS[d].title}):cdb.log.info("Create tab "+d+" doesn't exist")}),this.$(".create-tabs > .popular").append(b),this.$(".create-tabs > .other").append(c),this.create_tabs=new cdb.admin.Tabs({el:this.$(".create-tabs"),slash:!0}),this.addView(this.create_tabs)},_genPanes:function(){var a=this;this.create_panes=new cdb.ui.common.TabPane({el:this.$(".create-panes")}),this.addView(this.create_panes),this.create_tabs.linkToPanel(this.create_panes),_.each(this.tabs,function(b){if(a._TABS[b]){var c=a[a._TABS[b].method]();c&&(a.create_panes.addTab(b,c),a.addView(c))}else cdb.log.info("Create pane "+b+" doesn't exist")})},_genFilePane:function(){if(!this._canCreate())return this._setFailedTab("file","limits"),!1;var a=new cdb.admin.ImportFilePane({maxFileSize:this.uploader.maxFileSize,maxUploadFiles:this.uploader.maxUploadFiles,acceptFileTypes:this.uploader.acceptFileTypes,acceptSync:this.uploader.acceptSync});return a.bind("fileChosen",this._onValueChosen,this),a.bind("valueChange",this._onValueChange,this),a.bind("showUpgrade",this._onShowUpgrade,this),a},_genLayerPane:function(){var a=new cdb.admin.ImportLayerPane({user:this.user});return a.bind("valueChange",this._onValueChange,this),a},_genGDrivePane:function(){if(!cdb.config.get("oauth_gdrive"))return this._setFailedTab("gdrive","key"),!1;if(!this._canCreate())return this._setFailedTab("gdrive","limits"),!1;var a=new cdb.admin.ImportServicePane({service:"gdrive",acceptFileTypes:this.uploader.acceptFileTypes,label:this._TABS.gdrive.label,acceptSync:this.uploader.acceptSync});return a.bind("fileChosen",this._onValueChosen,this),a.bind("valueChange",this._onValueChange,this),a.bind("showUpgrade",this._onShowUpgrade,this),a.bind("changeSize",this._onPaneChangeSize,this),a},_genDropboxPane:function(){if(!cdb.config.get("oauth_dropbox"))return this._setFailedTab("dropbox","key"),!1;if(!this._canCreate())return this._setFailedTab("dropbox","limits"),!1;var a=new cdb.admin.ImportServicePane({service:"dropbox",label:this._TABS.dropbox.label,acceptFileTypes:this.uploader.acceptFileTypes,acceptSync:this.uploader.acceptSync});return a.bind("fileChosen",this._onValueChosen,this),a.bind("valueChange",this._onValueChange,this),a.bind("showUpgrade",this._onShowUpgrade,this),a.bind("changeSize",this._onPaneChangeSize,this),a},_genTwitterPane:function(){if(!this._canCreate())return this._setFailedTab("twitter","limits"),!1;if(!cdb.config.get("datasource_search_twitter"))return this._setFailedTab("twitter","key"),!1;if(!this.user.get("twitter").enabled){this.enabled_tabs=_.without(this.enabled_tabs,"twitter");var a=new cdb.admin.ImportMessagePane({className:"import-message-pane twitter-message-pane",template:this._TABS.twitter.template});return a}if(this.user.get("twitter").quota-this.user.get("twitter").monthly_use<=0&&this.user.get("twitter").hard_limit)return this._setFailedTab("twitter","credits"),!1;var b=new cdb.admin.ImportTwitterPane({user:this.user,acceptSync:this.uploader.acceptSync});return b.bind("fileChosen",this._onValueChosen,this),b.bind("valueChange",this._onValueChange,this),b.bind("showUpgrade",this._onShowUpgrade,this),b.bind("changeSize",this._onPaneChangeSize,this),b},_genScratchPane:function(){return this._canCreate()?new cdb.admin.ImportEmptyPane:(this._setFailedTab("scratch","limits"),!1)},_genInstagramPane:function(){if(!cdb.config.get("oauth_instagram"))return this._setFailedTab("instagram","key"),!1;if(!this._canCreate())return this._setFailedTab("instagram","limits"),!1;var a=new cdb.admin.ImportInstagramPane({service:"instagram",template:"old_common/views/import/import_service_instagram",acceptSync:!1});return a.bind("fileChosen",this._onValueChosen,this),a.bind("valueChange",this._onValueChange,this),a.bind("showUpgrade",this._onShowUpgrade,this),a.bind("changeSize",this._onPaneChangeSize,this),a},_genArcgisPane:function(){if(!this._canCreate())return this._setFailedTab("arcgis","limits"),!1;if(this.user.get("actions")&&!this.user.get("actions").arcgis_datasource){this.enabled_tabs=_.without(this.enabled_tabs,"arcgis");var a=new cdb.admin.ImportMessagePane({className:"import-message-pane arcgis-message-pane",template:this._TABS.arcgis.template});return a}var b=new cdb.admin.ImportArcGISPane({template:"old_common/views/import/import_arcgis",user:this.user,type:"service",service_name:"arcgis",acceptSync:this.user.get("actions")&&this.user.get("actions").sync_tables});return b.bind("fileChosen",this._onValueChosen,this),b.bind("valueChange",this._onValueChange,this),b.bind("changeSize",this._onPaneChangeSize,this),b},_genSalesforcePane:function(){if(!this._canCreate())return this._setFailedTab("salesforce","limits"),!1;if(!this.user.featureEnabled("salesforce_import")){this.enabled_tabs=_.without(this.enabled_tabs,"salesforce");var a=new cdb.admin.ImportMessagePane({className:"import-message-pane salesforce-message-pane",template:this._TABS.salesforce.template});return a}var b=new cdb.admin.ImportUrlPane({className:"import-pane import-salesforce-pane",template:"old_common/views/import/import_salesforce",user:this.user,type:"url",service_name:"salesforce",acceptSync:this.user.get("actions")&&this.user.get("actions").sync_tables});return b.bind("fileChosen",this._onValueChosen,this),b.bind("valueChange",this._onValueChange,this),b.bind("changeSize",this._onPaneChangeSize,this),b},_genMailchimpPane:function(){if(!cdb.config.get("oauth_mailchimp"))return this._setFailedTab("mailchimp","key"),!1;if(!this._canCreate())return this._setFailedTab("mailchimp","limits"),!1;if(!this.user.featureEnabled("mailchimp_import"))return this.enabled_tabs=_.without(this.enabled_tabs,"mailchimp"),new cdb.admin.ImportMessagePane({className:"import-message-pane mailchimp-message-pane",template:this._TABS.mailchimp.template});var a=new cdb.admin.ImportServicePane({service:"mailchimp",filename_field:"filename",item_kind:"list",label:this._TABS.mailchimp.label,show_formats_link:this._TABS.mailchimp.show_formats_link,acceptFileTypes:this.uploader.acceptFileTypes,acceptSync:this.uploader.acceptSync});return a.bind("fileChosen",this._onValueChosen,this),a.bind("valueChange",this._onValueChange,this),a.bind("showUpgrade",this._onShowUpgrade,this),a.bind("changeSize",this._onPaneChangeSize,this),a},_genSuccessPane:function(){return new cdb.admin.ImportSuccessPane({model:this.model})},_genErrorPane:function(){return new cdb.admin.ImportErrorPane({model:this.model})},_genActionsController:function(){var a=new cdb.common.CreateDialog.Actions({enabled_tabs:this.enabled_tabs,tabs:this.create_tabs,panes:this.create_panes,model:this.model,states:this.options.states,$dialog:this.$dialog});this.addView(a)},_setSelectedTab:function(a){this._TABS[a]?this.create_panes.active(a):this.tabs&&this.tabs.length>0?this.create_panes.active(this.tabs[0]):cdb.log.info("No create-tabs no fun");
},_setFailedTab:function(a,b){var c=this.create_tabs.getTab(a);c.addClass("disabled"),this._createTooltip(a,b)},_createTooltip:function(a,b){var c=this,d=this.create_tabs.getTab(a),e=new cdb.common.TipsyTooltip({el:d,title:function(){return _.template(c._TEXTS.limits[b])({name:c._TABS[a].title})}});this.addView(e)},_setBinds:function(){this.create_panes.bind("tabEnabled",this._onTabChange,this),this.model.bind("change:state",this._onStateChange,this),this.model.bind("change:navigation",this._onNavigationChange,this)},_destroyBinds:function(){this.create_panes&&this.create_panes.unbind("tabEnabled",null,this)},_onTabChange:function(a){if("error"!==a){var b=this.create_panes.getPane(a).getValue(),c=_.extend(b,{progress:0}),d=this._TABS[a]&&this._TABS[a].type?this._TABS[a].type:"popular";this.model.set({navigation:d,option:a,upload:c})}},_onNavTabClick:function(a){a&&this.killEvent(a);var b=this,c=$(a.target).attr("href")&&$(a.target).attr("href").replace("#/",""),d=[];_.each(this.tabs,function(a){b._TABS[a].type||"popular"!==c?c===b._TABS[a].type&&d.push(a):d.push(a)}),d.length>0&&this.create_panes.active(d[0])},_onNavigationChange:function(){var a=this.model.get("navigation"),b=this.$(".create-tabs-navigation"),c=this.$(".create-tabs"),d=b.find("a."+a),e=this.$dialog.find(".create-dialog").css("width");c.animate({marginLeft:"other"===a?"-"+e:0},{queue:!1,duration:200}),b.find("a").removeClass("selected"),d.addClass("selected")},_onStateChange:function(a,b){if("added"===this.model.get("state")){var c=this.create_panes.getPane(this.model.get("option"));c.setValue(this.model.get("upload"))}"error"===this.model.get("state")&&this.create_panes.active("error")},_onValueChange:function(){var a=this.create_panes.getActivePane().getValue(),b=_.extend(a,{progress:0});this.model.set({upload:b})},_onValueChosen:function(a){this.model.set({state:"selected",upload:a})},_onPaneChangeSize:function(){this.trigger("changeSize",this)},_onShowUpgrade:function(){this.trigger("showUpgrade",this)},_onStopUpload:function(a){a&&this.killEvent(a),this.model.set({state:"reset"})},_canCreate:function(){return(null===this.user.get("table_quota")||this.user.get("remaining_table_quota")>0)&&(null===this.user.get("quota_in_bytes")||this.user.get("remaining_byte_quota")>0)?!0:!1},clean:function(){this._destroyBinds(),cdb.core.View.prototype.clean.call(this)}}),cdb.common.CreateDialog.Model=cdb.core.Model.extend({defaults:{navigation:"popular",state:"idle",option:"file",upload:{valid:!1,progress:0,type:"",value:"",interval:0,item_queue_id:""}}}),cdb.common.CreateDialog.states={idle:{title:{enabled:{"default":!1,twitter:!1}},navigation:{enabled:!0},tabs:{enabled:!0},content:{enabled:!0},progress:{enabled:!1},close:{enabled:!0},upgrade:{enabled:!0},abort:{enabled:!1},ok:{text:{"default":_t("Create dataset"),layer:_t("Add layer"),scratch:_t("Create empty dataset")},classes:"ok button green",parent:"to_right"}},reset:{title:{enabled:{"default":!0,twitter:!1}},navigation:{enabled:!0},tabs:{enabled:!0},content:{enabled:!0},progress:{enabled:!1},close:{enabled:!0},upgrade:{enabled:!0},abort:{enabled:!1},ok:{text:{"default":_t("Create dataset"),layer:_t("Add layer"),scratch:_t("Create empty dataset")},classes:"ok button green",parent:"to_right "}},added:{title:{enabled:{"default":!1}},navigation:{enabled:!0},tabs:{enabled:!0},content:{enabled:!0},progress:{enabled:!1},close:{enabled:!0},upgrade:{enabled:!0},abort:{enabled:!1},ok:{text:{"default":_t("Create dataset"),scratch:_t("Create empty dataset")},classes:"ok button green",parent:"to_right"}},selected:{title:{enabled:{"default":!1}},navigation:{enabled:!1},tabs:{enabled:!1},content:{enabled:!1},progress:{enabled:!0,text:{"default":_t("Uploading your data"),file:{file:_t("Uploading your data"),url:_t("Downloading file")},gdrive:_t("Uploading your data"),dropbox:_t("Uploading your data"),layer:_t(""),scratch:_t("Uploading your data"),twitter:_t("Importing. Depending on the amount of tweets, this can take a while"),arcgis:_t("Importing your ArcGIS data")}},close:{enabled:!1},upgrade:{enabled:!1},abort:{enabled:!0},ok:{text:{"default":_t("Hide this window")},classes:"ok disabled button grey",parent:"middle"}},pending:{},getting:{title:{enabled:{"default":!1}},navigation:{enabled:!1},tabs:{enabled:!1},content:{enabled:!1},progress:{enabled:!0,text:{"default":_t("Downloading your data"),file:{file:_t("Uploading your data"),url:_t("Downloading file")},gdrive:_t("Downloading your Google Drive file"),dropbox:_t("Downloading your Dropbox file"),layer:_t(""),scratch:_t(""),twitter:_t(""),arcgis:_t("")}},close:{enabled:!1},upgrade:{enabled:!1},abort:{enabled:!0},ok:{text:{"default":_t("Hide this window")},classes:"ok disabled button grey",parent:"middle"}},uploading:{title:{enabled:{"default":!1}},navigation:{enabled:!1},tabs:{enabled:!1},content:{enabled:!1},progress:{enabled:!0,text:{"default":_t("Uploading your data"),file:{file:_t("Uploading your data"),url:_t("Downloading file")},gdrive:_t("Uploading your Google Drive file"),dropbox:_t("Uploading your Dropbox file"),layer:_t(""),scratch:_t("Uploading your data"),twitter:_t("Importing. Depending on the amount of tweets, this can take a while"),arcgis:_t("Importing your ArcGIS data")}},close:{enabled:!1},upgrade:{enabled:!1},abort:{enabled:!1},ok:{text:{"default":_t("Hide this window")},classes:"ok button grey",parent:"middle"}},importing:{navigation:{enabled:!1},tabs:{enabled:!1},content:{enabled:!1},progress:{enabled:!0,text:{"default":_t("Importing your file"),file:_t("Importing your file"),gdrive:_t("Importing your Google Drive file"),dropbox:_t("Importing your Dropbox file"),layer:_t(""),scratch:_t("Importing your dataset"),twitter:_t("Importing. Depending on the amount of tweets, this can take a while"),arcgis:_t("Importing your ArcGIS data")}}},guessing:{navigation:{enabled:!1},tabs:{enabled:!1},content:{enabled:!1},progress:{enabled:!0,text:{"default":_t("Guessing geocodable content on your file"),file:_t("Guessing geocodable content on your file"),gdrive:_t("Guessing geocodable content on your Google Drive file"),dropbox:_t("Guessing geocodable content on your Dropbox file"),layer:_t(""),scratch:_t("Guessing geocodable content on your dataset"),twitter:_t("Guessing content. Depending on the amount of tweets, this can take a while"),arcgis:_t("Guessing geocodable content of your ArcGIS data")}}},geocoding:{navigation:{enabled:!1},tabs:{enabled:!1},content:{enabled:!1},progress:{enabled:!0,text:{"default":_t("Geocoding your data"),file:_t("Geocoding your file"),gdrive:_t("Geocoding your Google Drive file"),dropbox:_t("Geocoding your Dropbox file"),layer:_t(""),scratch:_t("Geocoding your dataset"),twitter:_t("Geocoding. Depending on the amount of tweets, this can take a while"),arcgis:_t("Geocoding your ArcGIS data")}}},unpacking:{navigation:{enabled:!1},tabs:{enabled:!1},content:{enabled:!1},progress:{enabled:!0,text:{"default":_t("Unpacking your data"),file:_t("Unpacking your data"),gdrive:_t("Unpacking your Google Drive file"),dropbox:_t("Unpacking your Dropbox file"),layer:_t(""),scratch:_t(""),twitter:_t("Unpacking your Twitter data"),arcgis:_t("Unpacking your ArcGIS data")}}},creating:{navigation:{enabled:!1},tabs:{enabled:!1},content:{enabled:!1},progress:{enabled:!0,text:{"default":_t("Creating your dataset"),file:_t("Creating your dataset"),gdrive:_t("Creating your dataset"),dropbox:_t("Creating your dataset"),layer:_t("Creating your dataset"),scratch:_t("Creating your dataset"),twitter:_t("Creating your dataset"),arcgis:_t("Creating your dataset")}},close:{enabled:!1},upgrade:{enabled:!1},abort:{enabled:!1},ok:{text:{"default":_t("Hide this window")},classes:"ok disabled button grey",parent:"middle"}},complete:{navigation:{enabled:!1},tabs:{enabled:!1},content:{enabled:!0},progress:{enabled:!1},close:{enabled:!0},upgrade:{enabled:!1},abort:{enabled:!1},success:{enabled:{"default":!1,twitter:!0}},ok:{text:{"default":_t(""),twitter:_t("Go to dataset")},classes:"ok button grey",parent:"middle"}},abort:{title:{enabled:{"default":!0,twitter:!1}},navigation:{enabled:!0},tabs:{enabled:!0},content:{enabled:!0},progress:{enabled:!1},close:{enabled:!0},upgrade:{enabled:!0},abort:{enabled:!1},ok:{text:{"default":_t("Create dataset"),layer:_t("Add layer"),scratch:_t("Create empty dataset")},classes:"ok button green",parent:"to_right"}},error:{title:{enabled:{"default":!1}},navigation:{enabled:!1},tabs:{enabled:!0},content:{enabled:!0},progress:{enabled:!1},close:{enabled:!0},upgrade:{enabled:!1},abort:{enabled:!1},ok:{text:{"default":_t("Close")},classes:"ok button grey",parent:"to_right"}}},cdb.common.CreateDialog.Uploader=cdb.core.View.extend({initialize:function(){this.uploader_options=this.options.uploader,this.user=this.options.user,this.template=cdb.templates.getTemplate(this.options.template||"old_common/views/create_dialog/create_dialog_uploader"),this._initBinds()},render:function(){return this.$el.append(this.template()),this._createUploader(),this},_initBinds:function(){_.bindAll(this,"_onUploadProgress","_onUploadStart","_onUploadAbort","_onUploadAdd","_onUploadComplete","_onUploadError","_onImportError"),this.model.bind("change:state",this._manageUpload,this)},_createUploader:function(){this.$upload=this.$("form.create-dialog-uploader"),this.$upload.fileupload({dropZone:this.$(".non-dropzone"),url:cdb.config.prefixUrl()+this.uploader_options.url,paramName:"filename",formData:this._formData,progressInterval:100,bitrateInterval:500,maxFileSize:this.uploader_options.maxFileSize,autoUpload:!0,limitMultiFileUploads:this.uploader_options.maxUploadFiles,limitConcurrentUploads:this.uploader_options.maxUploadFiles,acceptFileTypes:this._setValidFileExtensions(this.uploader_options.acceptFileTypes),add:this._onUploadAdd,progress:this._onUploadProgress,start:this._onUploadStart,done:this._onUploadComplete,fail:this._onUploadError}),this.uploader=this.$upload.data("fileupload")},_manageUpload:function(a,b,c){if("selected"===b){if("file"===this.model.get("upload").type)return this.$upload.fileupload("add",{files:this.model.get("upload").value}),!1;if("url"===this.model.get("upload").type||"service"===this.model.get("upload").type){var d=this._generateImportData();return this[this.model.get("upload").interval>0?"_createSync":"_createImport"](d),!1}if("empty"===this.model.get("upload").type)return this._createTable(),!1;cdb.log.info("Import type "+this.model.get("upload").type+" is not defined!")}"abort"===b&&this._onUploadAbort()},_onUploadStart:function(a,b){this.model.set("state","getting")},_onUploadProgress:function(a,b){var c=b.loaded,d=b.total,e=_.clone(this.model.get("upload"));e.progress=c/d*100,this.model.set("upload",e)},_onUploadAbort:function(a){this.model.set("state","abort"),a&&a.preventDefault(),this.jqXHR.abort()},_onUploadError:function(a,b){var c;if(b&&b.jqXHR&&429===b.jqXHR.status){var d=JSON.parse(b.jqXHR.responseText);c=d.errors.imports}this._onImportError(null,c)},_onUploadComplete:function(a,b){var c=_.extend(this.model.get("upload"),{item_queue_id:b.result.item_queue_id});this.model.set({upload:c}),this._checkImport()},_onUploadAdd:function(a,b){1===b.originalFiles.length&&(this.jqXHR=b.submit())},_formData:function(a){return[{name:"content_guessing",value:!0}]},_setValidFileExtensions:function(a){return RegExp("(.|/)("+a.join("|")+")$","i")},_generateImportData:function(){var a={content_guessing:!0,interval:this.model.get("upload").interval},b=this.model.get("upload").type,c=this.model.get("option");if("url"===b&&_.extend(a,{url:this.model.get("upload").value}),"service"===b){var d="twitter"===c?JSON.stringify(this.model.get("upload").service_item_id):this.model.get("upload").service_item_id;_.extend(a,{value:this.model.get("upload").value,service_name:this.model.get("upload").service_name,service_item_id:d})}return a},_createSync:function(a){var b=this,c=new cdb.admin.TableSynchronization(a);c.save(null,{success:function(a){var c=_.extend(b.model.get("upload"),a.get("data_import"));b.model.set("upload",c),b._checkImport()},error:this._onImportError})},_createImport:function(a){var b=this,c=new cdb.admin.Imports(a);c.save(null,{success:function(a,c){var d=_.extend(b.model.get("upload"),{item_queue_id:c.item_queue_id});b.model.set("upload",d),b._checkImport()},error:this._onImportError})},_checkImport:function(){if(!this.model.get("upload").item_queue_id)return cdb.log.info("No item queue id is defined for importing"),!1;this.model.set("state","uploading"),this.importation&&(this.importation.unbind(),this.importation.destroyCheck());var a=this.importation=new cdb.admin.Import({item_queue_id:this.model.get("upload").item_queue_id});this.model.get("upload").endpoint&&a.setUrlRoot(this.model.get("upload").endpoint),a.bind("importComplete",this._onImportComplete,this),a.bind("importError",this._onImportError,this),a.bind("importChange",this._onImportChange,this),a.pollCheck()},_onImportComplete:function(a){if(a.unbind(),a.get("table_name")){var b=this.model.get("upload");b.table_name=a.get("table_name"),a.get("tables_created_count")&&a.get("tables_created_count")>1&&(b.tables_created_count=a.get("tables_created_count")),a.get("tweets_cost")&&(b.tweets_cost=a.get("tweets_cost")),a.get("tweets_georeferenced")&&(b.tweets_georeferenced=a.get("tweets_georeferenced")),a.get("tweets_overquota")&&(b.tweets_overquota=a.get("tweets_overquota")),"twitter_search"===this.model.get("upload").service_name&&(b.tweets_left=Math.max(0,this.options.user.get("twitter").quota-(this.options.user.get("twitter").monthly_use+(b.tweets_georeferenced||0)))),a.get("any_table_raster")&&(b.any_table_raster=!0),this.model.set({state:"complete",upload:b}),this.trigger("creationComplete")}else cdb.log.error("Table creation/importation is returning null ids"),this._onImportError(a)},_onImportError:function(a,b){a&&a.unbind&&a.unbind();var c=this.model.get("upload"),d={};a&&a.get&&a.get("item_queue_id")&&(c.item_queue_id=a.get("item_queue_id")),a&&a.get&&a.get("error_code")&&(d.error_code=a.get("error_code")),a&&a.get&&a.get("get_error_text")&&(d.title=a.get("get_error_text").title,d.what_about=a.get("get_error_text").what_about),b&&(d={what_about:b}),this.model.set({state:"error",option:"error",upload:c,error:d})},_onImportChange:function(a){this.model.set("state",a.get("state"))},_createTable:function(){var a=this,b=new cdb.admin.CartoDBTableMetadata;this.model.set("state","creating"),b.save({},{success:function(b){var c=a.model.get("upload");c.table_name=b.get("name"),a.model.set({state:"complete",upload:c}),a.trigger("creationComplete")},error:function(b,c){var d={code:b&&b.get("error_code"),title:b&&b.get("get_error_text")&&b.get("get_error_text").title,about:b&&b.get("get_error_text")&&b.get("get_error_text").what_about,item_queue_id:b&&b.get("item_queue_id")};if(c&&c.responseText){var e=JSON.parse(arguments[1].responseText);e&&e.errors&&e.errors[0]&&(d.title=e.errors[0])}a.model.set({state:"error",error:d})}}),this.model.set("state","creating")},clean:function(){this.importation&&(this.importation.unbind(),this.importation.destroyCheck()),this.$upload.fileupload("destroy"),this.jqXHR&&this._onUploadAbort(),cdb.core.View.prototype.clean.call(this)}}),cdb.admin.CreateErrorDialog=cdb.admin.BaseDialog.extend({initialize:function(){_.extend(this.options,{title:"An error occurred when importing your data",description:"",clean_on_hide:!0,ok_button_classes:"button grey",ok_title:"Ok, close it",cancel_button_classes:"underline margin15",modal_type:"confirmation",width:600,modal_class:"error"}),this.constructor.__super__.initialize.apply(this)},render_content:function(){var a=cdb.templates.getTemplate("old_common/views/error_dialog_content"),b={number:this.model.error_code,description:this.model.get_error_text.title,about:this.model.get_error_text.what_about,item_queue_id:""};return this.$content=a(b),this.$el.find("div.content").addClass("error_content").removeClass("content"),this.$content}}),cdb.admin.CustomScrolls=cdb.core.View.extend({events:{scroll:"checkScroll"},initialize:function(){var a=this;this.render(),this.timeout=setTimeout(function(){a.checkScroll()},300)},render:function(){return this.options.parent.append('<span class="top scroll"></span><span class="bottom scroll"></span>'),this},checkScroll:function(a){var b=this.$el.outerHeight(),c=this.$el[0].scrollTop,d=(this.$el[0].scrollLeft,this.$el[0].scrollHeight-b),e=this.options.parent,f=e.find("span.top"),g=e.find("span.bottom");0==c?f.hide():f.show(),c==d?g.hide():g.show()}}),cdb.admin.DeleteDialogItemsCollection=Backbone.Collection.extend({model:"DeleteDialogItem"}),cdb.admin.DeleteDialogItemModel=cdb.core.Model.extend({defaults:{open:!1}}),cdb.admin.DeleteDialogItem=cdb.core.View.extend({events:{"click .open":"_onClick"},initialize:function(){_.bindAll(this,"_toggle"),this.model.bind("change:open",this._onToggle,this),this.template=cdb.templates.getTemplate("old_common/views/delete_dialog_item")},_onToggle:function(){this.model.get("open")?this.$el.addClass("open"):this.$el.removeClass("open")},_onClick:function(a){a.preventDefault(),a.stopPropagation(),this._toggle()},_toggle:function(){this.model.set("open",!this.model.get("open"))},render:function(){var a=this,b=_.map(this.model.get("visualizations"),function(b){var c="";if(a.options.user.isInsideOrg())var c=(b.permission.owner,b.permission.owner.username!==a.options.user.get("username")?" (Created by "+b.permission.owner.username+")":"");return'<a href="'+cdb.config.prefixUrl()+"/viz/"+b.id+'">'+b.name+c+"</a>"}).join(", ").replace(/,\s([^,]+)$/," and $1"),c=_.extend(this.model.toJSON(),{visualization_list:b}),d=this.template(c);return this.$el.html(d),this.$el}}),cdb.admin.DeleteDialog=cdb.admin.BaseDialog.extend({events:function(){return _.extend({},cdb.admin.BaseDialog.prototype.events,{"click .export":"_showExport","click .modal.export nav a":"hide"})},_TEXTS:{title:_t("Delete this dataset"),default_message:_t("You are about to delete this dataset. Doing so will result in the deletion of this layer."),delete_vis_message:_t("You are about to delete this dataset. Doing so will result in the deletion of this layer. Also, deleting this layer will affect the following maps."),cancel_title:_t("Export my data first"),ok_title:_t("Ok, delete")},initialize:function(){_.bindAll(this,"ok","_showVisualizations"),this.options=_.extend({title:this._TEXTS.title,content:this._TEXTS.default_message,template_name:"old_common/views/delete_dialog_base",clean_on_hide:!0,enter_to_confirm:!0,ok_button_classes:"button grey",ok_title:this._TEXTS.ok_title,cancel_button_classes:"underline margin15 export",cancel_title:this._TEXTS.cancel_title,modal_type:"confirmation",width:574,modal_class:"delete_table_dialog"},this.options),this.elder("initialize")},render_content:function(){return this.$el.find(".loader").fadeIn(250),this.model.fetch({wait:!0,success:this._showVisualizations,error:function(a){}}),this.getTemplate("old_common/views/delete_table_dialog")(this.options)},_addItem:function(a){var b=new cdb.admin.DeleteDialogItem({className:a.get("type"),model:a,user:this.options.user});this.$el.find(".content").append(b.render())},_showVisualizations:function(){var a=this,b=function(){var b=a.model.get("table_visualization").id,c=_.filter(a.model.get("dependent_visualizations"),function(a){return a.id!=b?a:void 0}),d=a.model.get("non_dependent_visualizations");if((c.length>0||d.length>0)&&a.$el.find(".content p").html(a._TEXTS.delete_vis_message),a.items=new cdb.admin.DeleteDialogItemsCollection,a.items.bind("add",a._addItem,a),d&&d.length>0){var e=new cdb.admin.DeleteDialogItemModel({type:"non_dependent",visualizations:d});a.items.add(e)}if(c&&c.length>0){var e=new cdb.admin.DeleteDialogItemModel({type:"dependent",visualizations:c});a.items.add(e)}a.$el.find(".content").fadeIn(250),a.$el.find(".foot").fadeIn(250)};this.$el.find(".loader").fadeOut(250,b)},_showExport:function(a){a.preventDefault();var b=this,c=new cdb.admin.ExportTableDialog({model:this.model,config:window.config,user_data:this.options.user.toJSON(),autoClose:!0});$("body").append(c.render().el),c.open(),b.hide();var d=this.options.clean_on_hide;this.options.clean_on_hide=!1,c.bind("generating",function(a){b.$("p").html(a),b.open(),this.options.clean_on_hide=d})},_ok:function(a){a&&a.preventDefault(),this.ok&&this.ok(),this.hide()},wait:function(){return this.dfd=$.Deferred(),this.dfd.promise()},ok:function(a){this.killEvent(a),this.dfd.resolve()}}),cdb.admin.DeleteVisualizationDialog=cdb.admin.BaseDialog.extend({_TEXTS:{users_visibility:_t("Also, by deteleting this map you will be revoking access to the                             following users within your organization:")},initialize:function(a){_.extend(this.options,{title:"Delete this map",template_name:"old_common/views/dialog_base",clean_on_hide:!0,enter_to_confirm:!0,ok_button_classes:"button grey",ok_title:"Ok, delete",cancel_button_classes:"underline margin15",modal_type:"confirmation",width:510,modal_class:"delete_dialog"}),this.constructor.__super__.initialize.apply(this)},render_content:function(){var a=$("<div>"),b=this.getTemplate("old_common/views/delete_visualization_dialog")();if(a.append(b),this.model.permission&&this.model.permission.acl.size()>0){var c=new cdb.ui.common.UserListWarning({className:"common-users-list warning margin10",list:this._generateUsersList(),msg:this._TEXTS.users_visibility});a.append(c.render().el),this.addView(c)}return a},_generateUsersList:function(){return this.model.permission.acl.map(function(a){var b=a.get("entity");return{id:b.get("id"),type:a.get("type"),username:b.get("username")||b.get("name"),avatar_url:b.get("avatar_url"),visualizations:[]}})}}),cdb.admin.ErrorStats=cdb.core.Model.extend({defaults:{name:"trackJs",people:"configure",template:"old_common/views/trackjs",enable_logs:!1},initialize:function(a){a&&a.user_data&&(this.user_data=a.user_data),window[this.get("name")]&&this._setService()},_setService:function(){if(this.get("people")&&this.user_data){var a=cdb.templates.getTemplate(this.get("template"));window[this.get("name")][this.get("people")](JSON.parse(a(this.user_data)))}this.get("enable_logs")&&(cdb.log=window[this.get("name")])}}),cdb.admin.ExportTableDialog=cdb.admin.BaseDialog.extend({_CSV_FILTER:"SELECT * FROM (%%sql%%) as subq ",_MAX_SQL_GET_LENGTH:1e3,events:cdb.core.View.extendEvents({"click .export:not(.disabled)":"_export"}),formats:[{format:"csv",fetcher:"fetchCSV",geomRequired:!1},{format:"shp",fetcher:"fetch",geomRequired:!0},{format:"kml",fetcher:"fetch",geomRequired:!0},{format:"svg",fetcher:"fetchSVG",geomRequired:!0},{format:"geojson",fetcher:"fetch",geomRequired:!0}],initialize:function(){_.extend(this.options,{title:"Select your file type",description:"",template_name:"old_common/views/dialog_base",clean_on_hide:!0,ok_button_classes:"button grey",ok_title:"",modal_type:"",width:510,modal_class:"export_table_dialog",include_footer:!1,table_id:this.model.id}),this.constructor.__super__.initialize.apply(this),_.bindAll(this,"_export"),this.baseUrl=cdb.config.getSqlApiUrl(),this.model.bind("change:geometry_types",function(){this.refresh()},this)},getFormat:function(a){for(var b in this.formats)if(this.formats[b].format===a)return this.formats[b]},_export:function(a){this.killEvent(a);var b=$(a.currentTarget),c=b.data("format"),d=this.getFormat(c);this[d.fetcher](c)},getBaseOptions:function(){var a={};return a.filename=this.model.get("name"),this.options.user_data&&(a.api_key=this.options.user_data.api_key),a},getPlainSql:function(){return this.options.sql?sql=this.options.sql:this.model.sqlView?sql=this.model.sqlView.getSQL():sql="select * from "+this.model.get("name"),sql},getGeomFilteredSql:function(){var a=this.getPlainSql();return this.model.isGeoreferenced()?this._CSV_FILTER.replace(/%%sql%%/g,a):a},_fetch:function(a,b){if(this.$(".error").html("").hide(),this.$(".format").val(a.format),this.$(".q").val(b),this.$(".filename").val(a.filename),this.$(".api_key").val(a.api_key),this.$(".generating").fadeIn(),this.$(".geospatial").fadeOut(),"csv"===a.format?this.$(".skipfields").val("the_geom_webmercator"):this.$(".skipfields").val("the_geom,the_geom_webmercator"),cdb.god.trigger("mixpanel","Exported table data",{filename:this.$('form input[name="filename"]').val(),type:this.$('form input[name="format"]').val()}),cdb.god.trigger("metrics","export_table",{email:window.user_data&&window.user_data.email,data:{filename:this.$('form input[name="filename"]').val(),type:this.$('form input[name="format"]').val()}}),b.length<this._MAX_SQL_GET_LENGTH){var c=this.$("form").attr("action")+"?"+this.$("form").serialize();this._fetchGET(c)}else this.submit();this.$(".db").attr("disabled","disabled"),this.$(".skipfields").attr("disabled","disabled"),this.options.autoClose&&(this.hide(),this.trigger("generating",this.$(".generating").html()))},showError:function(a){this.$(".generating").hide(),this.$(".error").html("<p>"+a+"</p>").fadeIn()},_fetchGET:function(a){function b(a){var b=null;try{var c=JSON.parse(a);b=c.error[0]}catch(d){a&&-1!==a.indexOf("error")&&(b="an error occurred")}return b}var c,d=this,e=window.open(a);e.onload=function(){clearInterval(c);var a=b(e.document.body.textContent);a?d.showError(a):d.hide(),e.close()},window.focus(),c=setInterval(function(){(e.closed||e.document&&0===e.document.body.textContent.length)&&(d.hide(),clearInterval(c))},100)},submit:function(){this.$("form").submit()},fetch:function(a){var b=this.getBaseOptions();b.format=a;var c=this.getPlainSql();this._fetch(b,c)},fetchCSV:function(){var a=this.getBaseOptions();a.format="csv";var b=this.getGeomFilteredSql();this.$(".skipfields").removeAttr("disabled"),this._fetch(a,b)},fetchSVG:function(){this.$(".db").removeAttr("disabled"),this.fetch("svg")},render_content:function(){return this.getTemplate("old_common/views/export_table_dialog")({formats:this.formats,url:this.baseUrl,isGeoreferenced:this.model.isGeoreferenced()})},refresh:function(){this.$(".content").html(this.render_content())}}),cdb.admin.ExportTableOptions=cdb.core.View.extend({className:"download_buttons",_CSV_FILTER:"SELECT * FROM (%%sql%%) as subq ",_MAX_SQL_GET_LENGTH:1e3,events:cdb.core.View.extendEvents({"click .export:not(.disabled)":"_export"}),formats:[{format:"csv",fetcher:"fetchCSV",geomRequired:!1},{format:"shp",fetcher:"fetch",geomRequired:!0},{format:"kml",fetcher:"fetch",geomRequired:!0},{format:"svg",fetcher:"fetchSVG",geomRequired:!0},{format:"geojson",fetcher:"fetch",geomRequired:!0},{format:"api call",fetcher:"showAPIDialog"}],initialize:function(){_.extend(this.options,{title:"Select your file type",description:"",template_name:"old_common/views/dialog_base",clean_on_hide:!0,ok_button_classes:"button grey",ok_title:"",modal_type:"",width:510,modal_class:"export_table_dialog",include_footer:!1,table_id:this.model.id}),_.bindAll(this,"_export"),this.baseUrl=cdb.config.getSqlApiUrl(),this.model.bind("change:geometry_types",function(){this.refresh()},this)},getFormat:function(a){for(var b in this.formats)if(this.formats[b].format===a)return this.formats[b]},_export:function(a){this.killEvent(a);var b=$(a.currentTarget),c=b.data("format"),d=this.getFormat(c);this[d.fetcher](c)},getBaseOptions:function(){var a={};this.model.get("name");return-1!==this.model.get("name").search(".")&&(a.filename=this.model.getUnqualifiedName()),this.options.user_data&&(a.api_key=this.options.user_data.api_key),a},getPlainSql:function(){return this.options.sql?sql=this.options.sql:this.model.sqlView?sql=this.model.sqlView.getSQL():sql="select * from "+this.model.get("name"),sql},getGeomFilteredSql:function(){var a=this.getPlainSql();return this.model.isGeoreferenced()?this._CSV_FILTER.replace(/%%sql%%/g,a):a},_fetch:function(a,b){if(this.$(".error").html("").hide(),this.$(".format").val(a.format),this.$(".q").val(b),this.$(".filename").val(a.filename),this.$(".api_key").val(a.api_key),this.$(".generating").fadeIn(),this.$(".geospatial").fadeOut(),"csv"===a.format?this.$(".skipfields").val("the_geom_webmercator"):this.$(".skipfields").val("the_geom,the_geom_webmercator"),cdb.god.trigger("mixpanel","Exported table data",{filename:this.$('form input[name="filename"]').val(),type:this.$('form input[name="format"]').val()}),cdb.god.trigger("metrics","export_table",{email:window.user_data&&window.user_data.email,data:{filename:this.$('form input[name="filename"]').val(),type:this.$('form input[name="format"]').val()}}),b.length<this._MAX_SQL_GET_LENGTH){var c=this.$("form").attr("action")+"?"+this.$("form").serialize();this._fetchGET(c)}else this.submit();this.$(".db").attr("disabled","disabled"),this.$(".skipfields").attr("disabled","disabled"),this.options.autoClose&&this.trigger("generating",this.$(".generating").html())},showError:function(a){this.$(".generating").hide(),this.$(".error").html("<p>"+a+"</p>").fadeIn()},_fetchGET:function(a){function b(a){var b=null;try{var c=JSON.parse(a);b=c.error[0]}catch(d){a&&-1!==a.indexOf("error")&&(b="an error occurred")}return b}var c,d=this,e=window.open(a);e.onload=function(){clearInterval(c);var a=b(e.document.body.textContent);a?d.showError(a):d.hide(),e.close()},window.focus(),c=setInterval(function(){(e.closed||e.document&&0===e.document.body.textContent.length)&&clearInterval(c)},100)},submit:function(){this.$("form").submit()},fetch:function(a){var b=this.getBaseOptions();b.format=a;var c=this.getPlainSql();this._fetch(b,c)},fetchCSV:function(){var a=this.getBaseOptions();a.format="csv";var b=this.getGeomFilteredSql();this.$(".skipfields").removeAttr("disabled"),this._fetch(a,b)},fetchSVG:function(){this.$(".db").removeAttr("disabled"),this.fetch("svg")},showAPIDialog:function(){var a=new cdb.admin.BaseDialog({title:"Query this table",table:this.model.attributes,schema:this.model.attributes.original_schema.slice(0,5),url:this.baseUrl,original_schema:this.model.attributes.original_schema,template_name:"old_common/views/api_dialog",clean_on_hide:!0,enter_to_confirm:!0,ok_button_classes:"right button grey",ok_title:"Ok, close",cancel_button_classes:"underline margin15",modal_type:"api",width:592});a.ok=function(){},$("body").append(a.render().el),a.open()},render:function(){var a=this.getTemplate("old_common/views/export_table_options")({formats:this.formats,url:this.baseUrl,isGeoreferenced:this.model.isGeoreferenced(),title:this.model.getUnqualifiedName()});return this.$el.html(a),this},refresh:function(){this.$(".content").html(this.render())}}),cdb.admin.BooleanField=cdb.admin.StringField.extend({className:"field boolean",default_options:{template_name:"old_common/views/forms/boolean_field",label:!1,readOnly:!1},events:{"click a.radiobutton":"_onChange"},_onChange:function(a){a.preventDefault();var b=$(a.target).closest("a.radiobutton"),c=b.text().toLowerCase();this.model.get("value")!=c&&(this.model.set("value",c),this._setSelected(b))},_setSelected:function(a){this.$("a.selected").removeClass("selected"),a.addClass("selected")},_resize:function(){},_triggerEvent:function(a,b){this.trigger(a,b,this)}}),cdb.admin.ColorPicker=cdb.admin.DropdownMenu.extend({className:"dropdown color_picker border",_PICKER_DELAY:800,_COLORS:["#136400","#229A00","#B81609","#D6301D","#F84F40","#41006D","#7B00B4","#A53ED5","#2E5387","#3E7BB6","#5CA2D1","#FF6600","#FF9900","#FFCC00","#FFFFFF","#012700","#055D00","#850200","#B40903","#F11810","#11002F","#3B007F","#6B0FB2","#081B47","#0F3B82","#2167AB","#FF2900","#FF5C00","#FFA300","#000000"],default_options:{width:197,speedIn:150,speedOut:300,vertical_position:"up",horizontal_position:"right",horizontal_offset:5,vertical_offset:0,tick:"right",dragUpdate:!1,template_base:"old_common/views/color_picker"},events:{"click a.advanced":"_openAdvanced","click .default-colors li a":"_clickedColor","keyup input.text":"_checkColor","change input.text":"_checkColor","submit form":"_submitColor",click:"stopPropagation"},initialize:function(){cdb.admin.DropdownMenu.prototype.initialize.call(this),this.model=new cdb.core.Model({visible:!1,colors:this._COLORS,extra_colors:this.options.extra_colors,
color:""}),this.options.target&&$(this.options.target).off("click",this._handleClick),this._initBinds()},_initBinds:function(){_.bindAll(this,"open","hide","_handleClick","_keydown","_openAdvanced","_setPicker","_setColor","_onPickerMouseMove","_onPickerMouseUp","_submitColor"),this.model.bind("change:colors change:extra_colors change:color",this.render,this)},render:function(){var a=this.model.toJSON(),b=this;return a.extra_colors&&(a.extra_colors=_.filter(_.uniq(this.options.extra_colors),function(a){return!_.contains(b._COLORS,a.toUpperCase())})),this.$el.html(this.template_base(a)).css({width:this.options.width}),ColorPicker.fixIndicators(this.$(".slider-indicator").get(0),this.$(".picker-indicator").get(0)),this.color_picker=ColorPicker(this.$(".slider").get(0),this.$(".picker").get(0),this._setPicker),this},stopPropagation:function(a){a.stopPropagation()},_checkColor:function(a){a.preventDefault();var b=new RGBColor(this.$("input.text").val());b.ok?(this.$("input.text").removeClass("error"),this.$("form > span.color").css("background",b.toHex())):this.$("input.text").addClass("error")},setColors:function(a,b){return a&&b?void this.model.set(a,b):(cdb.log.info("No attribute or value for color picker model"),!1)},init:function(a){a=a||"#FFFFFF",this.model.set("color",a),this._setColor(a),this.open()},_clickedColor:function(a){a.preventDefault();var b=$(a.target).attr("href");this._triggerColor(b,!0),this.hide()},_setPicker:function(a,b,c,d,e){this._setColor(a),ColorPicker.positionIndicators(this.$(".slider-indicator").get(0),this.$(".picker-indicator").get(0),e,d)},_setColor:function(a){this.$("form > span.color").css("background",a),this.$("input.text").val(a)},_submitColor:function(a){a&&a.preventDefault();var b=new RGBColor(this.$("input.text").val());b.ok&&(this._triggerColor(b.toHex(),!0),this.hide())},_onPickerMouseMove:function(){if(this.options.dragUpdate){var a=new RGBColor(this.$("input.text").val());a.ok&&this._triggerColor(a.toHex(),!1)}},_onPickerMouseUp:function(){var a=new RGBColor(this.$("input.text").val());a.ok&&this._triggerColor(a.toHex(),!1)},_bindAdvancedPicker:function(){this.$(".slider").bind("mousemove",this._onPickerMouseMove),this.$(".picker").bind("mousemove",this._onPickerMouseMove),this.$(".picker").bind("mouseup",this._onPickerMouseUp),this.$(".slider").bind("mouseup",this._onPickerMouseUp)},_destroyAdvancedPicker:function(){this.$(".slider").unbind("mousemove",this._onPickerMouseMove),this.$(".picker").unbind("mousemove",this._onPickerMouseMove),this.$(".picker").unbind("mouseup",this._onPickerMouseUp),this.$(".slider").unbind("mouseup",this._onPickerMouseUp)},_openAdvanced:function(a){a&&a.preventDefault(),this._bindAdvancedPicker(),this.$("div.top").addClass("advanced"),this.positionate(a);var b=new RGBColor(this.$("input.text").val());b.ok&&this.color_picker.setHex(b.toHex())},_triggerColor:function(a,b){this.trigger("colorChosen",a,b,this.el)},positionate:function(a,b){var c=this.options.target,d=c[this.options.position||"offset"](),e=c.outerWidth(),f=c.outerHeight(),g=this.$el.outerWidth(),h=this.$el.outerHeight();this.$el.css({top:d.top+parseInt("up"==this.options.vertical_position?-h-10-this.options.vertical_offset:f+10-this.options.vertical_offset),left:d.left+parseInt("left"==this.options.horizontal_position?this.options.horizontal_offset-15:e-g+15-this.options.horizontal_offset)}).addClass(("up"==this.options.vertical_position?"vertical_top":"vertical_bottom")+" "+("right"==this.options.horizontal_position?"horizontal_right":"horizontal_left")+" tick_"+this.options.tick)},open:function(a,b){b&&$(b)||this.options.target;this.positionate(a,b),this.show(),this.model.set("visible",!0)},hide:function(a){var b=this;this.$el.animate({marginTop:"down"==b.options.vertical_position?"10px":"-10px",opacity:0},this.options.speedOut,function(){$(b.options.target).removeClass("selected"),b.clean()}),this.model.set("visible",!1)},clean:function(){this.color_picker&&this.color_picker.unBind(),this.options.target&&$(this.options.target).unbind("click",this._handleClick),cdb.admin.DropdownMenu.prototype.clean.call(this)}}),cdb.admin.DateField=cdb.admin.StringField.extend({className:"field date",timezone:"00:00",default_options:{template_name:"old_common/views/forms/date_field",label:!1,readOnly:!1},events:{"change input.time":"_onChange","keyup input.time":"_onKeyUp"},initialize:function(){_.defaults(this.options,this.default_options),_.bindAll(this,"_onChange","_onKeyUp","_onChangeModel"),this.template_base=this.options.template_base?_.template(this.options.template_base):cdb.templates.getTemplate(this.options.template_name);var a=this._splitDate(this.model.get("value"));this.timezone=this._getTimeZone(this.model.get("value")),this.date_model=new cdb.core.Model,this.valid=!0,this.date_model.bind("change",this._onChangeModel),this.date_model.set(a),this.bind("clean",this._reClean)},render:function(){return this.$el.html(this.template_base(_.extend(this.model.toJSON(),this.options))),this._initViews(),this.options.readOnly&&this.undelegateEvents(),this},_initViews:function(){var a=this.days=new cdb.forms.Spinner({el:this.$el.find("div.day"),model:this.date_model,disabled:this.options.readOnly,property:"day",min:1,max:31,inc:1,width:15,noSlider:!0,pattern:/^([12]?\d{0,1}|3[01]{0,2})$/});this.addView(this.days),this.$("div.day").append(a.render());var b=this.years=new cdb.forms.Spinner({el:this.$el.find("div.year"),model:this.date_model,disabled:this.options.readOnly,property:"year",min:1900,max:2100,width:28,noSlider:!0,pattern:/^([0-9]{0,4})$/});this.addView(this.years),this.$("div.year").append(b.render());var c=this.months=new cdb.forms.Combo({el:this.$el.find("div.month"),model:this.date_model,disabled:this.options.readOnly,property:"month",width:"140px",extra:[["January",1],["February",2],["March",3],["April",4],["May",5],["June",6],["July",7],["August",8],["September",9],["October",10],["November",11],["December",12]]});this.addView(this.months),this.$("div.month").append(c.render()),this.$("input.time").val(this.date_model.get("time"))},_getTimeZone:function(a){if(a){var b=a.match(/\+(.*)$/);if(b&&2==b.length)return b[1]}return this.timezone},_splitDate:function(a){var b={},c=new Date,d=c.getDate(),e=c.getMonth()+1,f=c.getFullYear(),g=c.getHours()+":"+c.getMinutes()+":"+c.getSeconds();if(""==a)b.day=d,b.month=e,b.year=f,b.time=g;else try{var h=a.split("T");if(h.length>1){var i=h[0].split("-");b.time=h[1].substr(0,8),b.day=parseInt(i[2]),b.month=parseInt(i[1]),b.year=parseInt(i[0])}else b.day=d,b.month=e,b.year=f,b.time=g}catch(j){b.day=d,b.month=e,b.year=f,b.time=g}return b},_toDate:function(a){return a.year+"-"+a.month+"-"+a.day+"T"+a.time+"+"+this.timezone},_checkTime:function(a){var b=/^([01]{1}[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/;return b.test(a)?!0:!1},_onChange:function(a){var b=this.$("input.time").val();this._checkTime(b)&&this.date_model.set("time",b)},_onChangeModel:function(a){this.model.set("value",this._toDate(this.date_model.toJSON()))},_onKeyDown:function(){},_onKeyUp:function(a){var b=$(a.target).val();if(this._checkTime(b)){if(13===a.keyCode)return a.preventDefault(),this._triggerEvent("ENTER"),!1;this.valid=!0,this.date_model.set("time",b),$(a.target).removeClass("error")}else this.valid=!1,$(a.target).addClass("error")},_reClean:function(){this.date_model.unbind("change"),this.date_model.destroy()}}),cdb.admin.EditInPlace=cdb.core.View.extend({events:{"click .value":"_onClick","keyup input":"_onKeyUp","blur input":"_onBlur"},initialize:function(){this.options=_.extend({disabled:!1,stripHTML:!1},this.options),_.bindAll(this,"_close","_onKeyUp"),this._observedField=this.options.observe,this.disabled=this.options.disabled,this.stripHTML=this.options.stripHTML,this.template=this.options.template_name?this.getTemplate(this.options.template_name):this.getTemplate("table/menu_modules/legends/views/edit_in_place"),this._setupConfig(),this.add_related_model(this.model),this.model.bind("change:"+this._observedField,this._updateValue,this),this.render()},_setupConfig:function(){this.config=new cdb.core.Model({mode:"view"}),this.add_related_model(this.config),this.config.bind("change:mode",this._updateMode,this)},_updateMode:function(a){if("edit"==this.config.get("mode"))this.$el.find(".value").hide(),this.$input.show(),this.$input.focus();else{this.$el.find(".value").show(),this.$input.hide();var b=this.model.get(this._observedField);this.$input.val(b),this.$el.find(".value span").html(b)}},_updateValue:function(){var a=this.model.get(this._observedField);return this.stripHTML&&(a=cdb.Utils.stripHTML(a)),cdb.Utils.isBlank(a)?(this.$input.text(""),this.$el.find(".value").addClass("empty"),this.$el.find(".value span").text("empty"),void this.trigger("change",null,this)):(this.$input.text(a),this.$el.find(".value span").html(a),this.$el.find(".value").removeClass("empty"),void this.trigger("change",a,this))},_close:function(a){a&&a.preventDefault(),a&&a.stopPropagation(),this.config.set("mode","view"),this._preventEmptyValue()},_preventEmptyValue:function(){var a=this.model.get(this._observedField);cdb.Utils.isBlank(a)?(this.$el.find(".value").addClass("empty"),this.$el.find(".value span").text("empty")):this.$el.find(".value").removeClass("empty")},_onBlur:function(a){var b=this.$el.find("input").val();this.stripHTML&&(b=cdb.Utils.stripHTML(b)),this.model.set(this._observedField,b),this._close()},_onKeyUp:function(a){if(13==a.keyCode){var b=this.$el.find("input").val();this.stripHTML&&(b=cdb.Utils.stripHTML(b)),this.model.set(this._observedField,b),this._close()}else 27==a.keyCode&&this._close()},_onClick:function(a){a&&a.preventDefault(),a&&a.stopPropagation(),this.disabled||this.config.set("mode","edit")},render:function(){var a=!0,b=this.model.get(this._observedField);this.stripHTML&&(b=cdb.Utils.stripHTML(b)),cdb.Utils.isBlank(b)?(b="empty",this.$el.append('<input type="text" value="" />')):(a=!1,this.$el.append('<input type="text" value="'+b+'" />')),this.$el.append(this.template({value:b})),this.$el.addClass("edit_in_place"),this.disabled&&this.$el.addClass("disabled"),a?this.$el.find(".value").addClass("empty"):this.$el.find(".value").removeClass("empty"),this.$input=this.$el.find("input"),this.options.maxWidth&&this.$el.find("span").css("max-width",this.options.maxWidth)}}),cdb.forms.ColumnTypeCombo=cdb.forms.Combo.extend({options:{minimumResultsForSearch:20,placeholder:"",formatResult:!0,matcher:!0,dropdownCssClass:"column-type"},_formatResult:function(a){return'<span class="value">'+a.id+'</span><span class="type">'+(a.text&&a.text.charAt(0))+"</span>"},_matcher:function(a,b,c){var d=$(c).val();return d.toUpperCase().indexOf(a.toUpperCase())>=0}}),cdb.forms.Form=cdb.core.View.extend({tagName:"ul",widgets:{color:"ColorWizard",opacity:"Opacity",simple_opacity:"SimpleOpacity",opacity_polygon:"OpacityPolygon",number:"Spinner",simple_number:"SimpleNumber",simple_number_with_label:"SimpleNumberWithLabel",width:"Width",select:"Combo",hidden:"Hidden","switch":"Switch",text_align:"TextAlign"},field_template:_.template('<li <% if (className) { %>class="<%- className %>"<% } %>><span><%-name %></span><span class="field"></li>'),initialize:function(){this.fields={},this.form_data=this.options.form_data,this.bind("clean",function(){this.fields=null},this)},updateForm:function(a){this.form_data=a},_renderField:function(a){var b=this,c=$(this.field_template({name:a.title||a.name,className:a.className||!1}));return _(a.form).each(function(d,e){var f=window.cdb.forms[b.widgets[d.type]];if(f){var g=d;_.extend(g,{property:e,model:b.model,extra:d.extra,field_name:a.name});var h=new f(g);c.find(".field").append(h.render().el),h.on("saved",function(){b.trigger("saved",b)}),b.addView(h)}else cdb.log.error("field class not found "+d.type)}),a.text&&$("<span class='text light'>"+a.text+"</span>").insertAfter(c.find(".field div:eq(0)")),c},getFieldByName:function(a){return this.fields[a]},getFieldsByName:function(a){return _.filter(this._subviews,function(b){return b.options.field_name===a?b:void 0})},render:function(){var a=this;return this.clearSubViews(),_(this.filter).each(function(a){a.destroy()}),this.$el.html(""),_(this.form_data).each(function(b){var c=a._renderField(b);a.fields[b.name]=c,a.$el.append(c)}),this}}),cdb.admin.GeometryField=cdb.admin.StringField.extend({className:"field geometry",default_options:{template_name:"old_common/views/forms/geometry_field",label:!1,readOnly:!1},events:{"click .switch":"_chooseEditor","keyup input":"_onKeyInputUp","keydown textarea":"_onKeyTextareaDown","change textarea":"_onChange"},initialize:function(){_.defaults(this.options,this.default_options),_.bindAll(this,"_chooseEditor","_onKeyInputUp","_onKeyTextareaDown"),this.template_base=this.options.template_base?_.template(this.options.template_base):cdb.templates.getTemplate(this.options.template_name),this.valid=!0,this.row=this.options.row,this._setOS()},render:function(){return this.$el.html(this.template_base(_.extend(this.model.toJSON(),this.options))),this._initViews(),this.options.readOnly&&this.undelegateEvents(),this},_initViews:function(){this.model.get("value");this.row.isGeomLoaded()?this._chooseGeom():this._loadGeom()},_loadGeom:function(){var a=this;this.row.bind("change",function(){a.model.set("value",a.row.get("the_geom")),a._chooseGeom()},this),this.row.fetch({rowNumber:this.options.rowNumber})},_chooseGeom:function(){var a=null;try{a=JSON.parse(this.model.get("value"))}catch(b){}this.options.readOnly?(this.$(".loader").remove(),this.$(".selector").show(),this.$("textarea").val(this.model.get("value"))):a&&"point"!=a.type.toLowerCase()?(this.status="rest",this.$(".loader").remove(),this.$(".rest").show(),this.$("textarea").val(this.model.get("value"))):(this.status="point",this.$(".loader").remove(),this.$(".point").show(),this.$(".selector").show(),a&&(this.$("input.longitude").val(a.coordinates[0]),this.$("input.latitude").val(a.coordinates[1]),this.$("textarea").val(JSON.stringify(a))))},_chooseEditor:function(a){this.killEvent(a);var b=$(a.target).closest("a");this.status="point"==this.status?"rest":"point",b.removeClass("rest"==this.status?"disabled":"enabled").addClass("rest"==this.status?"enabled":"disabled"),this.updateInputs(),"rest"==this.status?(this.$(".point").hide(),this.$(".rest").show(),this.valid=!0):(this.$(".point").show(),this.$(".rest").hide(),this.valid=this._checkInputs())},updateInputs:function(){if(this.model.get("value"))try{var a=JSON.parse(this.model.get("value"));this.$("input.longitude").val(a.coordinates[0]),this.$("input.latitude").val(a.coordinates[1]),this.$("textarea").val(JSON.stringify(a))}catch(b){return!1}},_checkNumber:function(a,b){var c=/^-?(?:[0-9]+|[0-9]*\.[0-9]+)$/;return c.test(a)?"lat"===b?a>=-90&&90>=a?!0:!1:"lon"===b?a>=-180&&180>=a?!0:!1:!0:!1},_checkInputs:function(){var a=!0,b=this.$("input.latitude"),c=this.$("input.longitude");return this._checkNumber(b.val(),"lat")?b.removeClass("error"):(b.addClass("error"),a=!1),this._checkNumber(c.val(),"lon")?c.removeClass("error"):(c.addClass("error"),a=!1),a},_onKeyInputUp:function(a){if(this._checkInputs()){if(13===a.keyCode)return a.preventDefault(),this._triggerEvent("ENTER"),!1;this.valid=!0;var b=parseFloat(this.$("input.latitude").val()),c=parseFloat(this.$("input.longitude").val());this.model.set("value",JSON.stringify({type:"Point",coordinates:[c,b]}))}else this.valid=!1},_onKeyTextareaDown:function(a){if(("mac"==this.so&&a.metaKey||"rest"==this.so&&a.ctrlKey)&&13==a.keyCode)return a.preventDefault(),this._triggerEvent("ENTER"),!1;var b=$(a.target).val();this.model.set("value",b)}}),cdb.forms.IntervalCombo=cdb.forms.Combo.extend({_PERIODS:[["Never",0],["Every hour",3600],["Every day",86400],["Every week",604800],["Every month",2592e3]],initialize:function(){_.bindAll(this,"_onUpdate","_changeSelection"),this.data=_.clone(this._PERIODS),this.placeholder=this.options.placeholder||"",this.options.remove_never&&this.data.shift(),this.model&&(this.add_related_model(this.model),this.model.bind("change:"+this.options.property,this._onUpdate))}}),cdb.admin.NumberField=cdb.admin.StringField.extend({className:"field number",default_options:{template_name:"old_common/views/forms/number_field",label:!1,readOnly:!1},events:{"change input":"_onChange","keyup input":"_onKeyUp","keydown input":"_onKeyDown"},_checkNumber:function(a){var b=/^-?(?:[0-9]+|[0-9]*\.[0-9]+)$/;return b.test(a)?!0:!1},_onChange:function(a){var b=$(a.target).val();this._checkNumber(b)&&this.model.set("value",b)},_onKeyDown:function(a){var b=$(a.target).val();(("mac"==this.so&&a.metaKey||"rest"==this.so&&a.ctrlKey)&&13==a.keyCode||13==a.keyCode)&&(""===b||this._checkNumber(b))&&(this._setValid(b),this._triggerEvent("ENTER"))},_onKeyUp:function(a){var b=$(a.target).val();""===b||this._checkNumber(b)?this._setValid(b):this._setInvalid(b)},_setInvalid:function(a){this.valid=!1,this.$('input[type="text"]').addClass("error")},_setValid:function(a){this.valid=!0,""===a&&(a="null"),this.$('input[type="text"]').removeClass("error"),this.model.set("value",a)},_resize:function(){}}),cdb.admin.SpinnerSlider=cdb.admin.DropdownMenu.extend({className:"dropdown spinner_slider border",default_options:{width:26,speedIn:150,speedOut:300,vertical_position:"up",horizontal_position:"right",horizontal_offset:32,vertical_offset:0,tick:"top"},events:{click:"_stopPropagation"},_stopPropagation:function(a){a.stopPropagation(),a.preventDefault()},init:function(a,b,c,d){var e=this;this.$el.find("div.slider-ui").slider({orientation:"vertical",max:a,min:b,step:c,value:d,slide:function(a,b){e.trigger("valueChanged",b.value,this.el)},change:function(a,b){e.trigger("valueSet",b.value,this.el)}}),this.open()},hide:function(a){var b=this;this.isOpen=!1,this.$el.animate({marginTop:"down"==b.options.vertical_position?"10px":"-10px",opacity:0},this.options.speedOut,function(){$(b.options.target).removeClass("selected"),b.$el.hide(),b.$el.find("div.slider-ui").slider("destroy"),b.remove()})}}),cdb.forms.CustomTextCombo=cdb.forms.ColumnTypeCombo.extend({className:"form_combo form_custom_text_combo",options:{minimumResultsForSearch:20,placeholder:"",formatResult:!0,formatSelection:!0,matcher:!0,freeText:!0,dropdownCssClass:"column-type custom_text_combo"},render:function(){this.$select=$("<select>"+this._getOptions()+"</select>");var a=this.model&&this.model.get("method")&&this.model.get("method").replace(/ /g,"_").toLowerCase();if(this.$select.attr({style:this.options.width?"width:"+this.options.width:""}),this.$select.addClass(this.options.property+(a?" "+a:"")),this.options.disabled&&this.$select.attr("disabled",""),this._setValue(this.model&&this.model.get(this.options.property)||this.options.property),this.$el.html(this.$select),!this.options||!this.options.plainSelect){var b=this.$("select");b.select2("destroy");var c={minimumResultsForSearch:this.options.minimumResultsForSearch,placeholder:this.options.placeholder,dropdownCssClass:this.options.dropdownCssClass,freeText:this.options.freeText};this.options.formatSelection&&(c.formatSelection=this._formatSelection),this.options.formatResult&&(c.formatResult=this._formatResult),this.options.matcher&&(c.matcher=this._matcher),b.select2(c)}var d=this.model.get(this.options.property);return""===d||this._valueAsOption(this.model.get(this.options.property))||b.select2("val",this.model.get(this.options.property)),this},_valueAsOption:function(a){return void 0!==_.find(this.options.extra,function(b){return b[1]===a})},_formatSelection:function(a){return a?a.id:a.text},_changeSelection:function(a){var b=this.$("select").val()||this.$("select").data("select2").data().id,c=!this._valueAsOption(b),d={};d[this.options.property]=b,d[this.options.text||"text"]=c?!0:!1,b&&this.model.set(d),this.$(".select2-choice > div").removeClass().addClass(c?"free-text-icon":"combo-option-icon")}}),cdb.admin.GlobalError=cdb.core.View.extend({DEFAULT_TAG:"",initialize:function(){_.bindAll(this,"hide"),this._lastType=-1,this._lastTag=this.DEFAULT_TAG},templates:{info:"old_common/views/notifications/info",warn:"old_common/views/notifications/info",error:"old_common/views/notifications/info",load:"old_common/views/notifications/loading"},priority:{error:3,warn:2,info:1,load:0},getTypeTemplate:function(a){var b=this.templates[a]?this.templates[a]:this.templates.info,c=this.getTemplate(b);return c},showError:function(a,b,c,d){d=d||this.DEFAULT_TAG,c=void 0===c?2e3:c,b||(b="info");var e=this.priority[b]||0,f=this.priority[this._lastType]||0;f>e||(this._lastType=b,this._lastTag=d,this.$el.html(this.getTypeTemplate(b)({text:a,type:b})),this._timer&&clearTimeout(this._timer),c>0&&(this._timer=setTimeout(this.hide,c)),this.show())},show:function(){this.$el.find("p").stop().animate({marginTop:0},500)},hide:function(a){a=a||this.DEFAULT_TAG,this._lastTag===a&&(this.$el.find("p").stop().animate({marginTop:40},500),this._timer=0,this._lastType=-1,this._lastTag=this.DEFAULT_TAG)},listenGlobal:function(){cdb.god.bind("error",this.showError,this)}}),cdb.admin.Header=cdb.core.View.extend({_TEXTS:{saving:_t("Saving..."),saved:_t("Saved"),error:_t("Something went wrong, try again later"),metadata:{edit:_t("Edit metadata..."),view:_t("View metadata...")},visualization:{loader:_t("Changing to visualization"),created:_t("Visualization created")},share:{publish:_t("PUBLISH"),visualize:_t("VISUALIZE")},share_privacy:{ok_next:_t("Share it now!")},rename:{title:_t("Rename your {{ vis }}"),desc_table:_t("<strong>This change will affect your API calls.</strong> If you are accessing                     this table via API don't forget to update the name in the API calls after                     changing the name."),desc_vis:_t("<strong>This change will affect your embed maps and vizjson url.</strong> If you have published                     this visualization don't forget to check the url and replace the name."),readonly:_t("It is not possible to rename<br/>the table in <%- mode %> mode"),owner:_t("It is not possible to rename<br/>the table if you are not the owner"),ok:_t("Yes, do it")}},_MAX_DESCRIPTION_LENGTH:200,events:{"click a.title":"_changeTitle","click .metadata a":"_changeMetadata","click a.options":"_openOptionsMenu","click a.share":"_shareVisualization","click a.privacy":"_showPrivacyDialog","click header nav a":"_onTabClick"},initialize:function(a){_.bindAll(this,"_changeTitle","_setPrivacy"),this.$body=$("body"),this.dataLayer=null,this.globalError=this.options.globalError,this._initBinds(),this.setInfo()},setActiveLayer:function(a){this.dataLayer&&(this.dataLayer.unbind("applySQLView applyFilter errorSQLView clearSQLView",this.setEditableInfo,this),this.dataLayer.table.unbind("change:isSync",this.setEditableInfo,this),this.dataLayer.table.unbind("change:permission",this.setInfo,this)),this.dataLayer=a.model,this.model.isVisualization()||(this.dataLayer.bind("applySQLView applyFilter errorSQLView clearSQLView",this.setEditableInfo,this),this.dataLayer.table.bind("change:isSync",this.setEditableInfo,this),this.dataLayer.table.bind("change:permission",this.setInfo,this),this.setEditableInfo())},_initBinds:function(){this.model.bind("change:name",this._setName,this),this.model.bind("change:type",this.setInfo,this),this.model.bind("change:privacy",this._setPrivacy,this),this.model.bind("change:permission",this._setSharedCount,this)},_openOptionsMenu:function(a){this.killEvent(a);var b=this,c=$(a.target);this.options_menu=new cdb.admin.HeaderOptionsMenu({target:$(a.target),model:this.options.visualization,dataLayer:this.dataLayer,user:this.options.user,private_tables:this.options.user.get("actions").private_tables,geocoder:this.options.geocoder,globalError:this.options.globalError,template_base:"table/header/views/options_menu"}).bind("onDropdownShown",function(a){cdb.god.unbind("closeDialogs",b.options_menu.hide,b.options_menu),cdb.god.trigger("closeDialogs"),cdb.god.bind("closeDialogs",b.options_menu.hide,b.options_menu)}).bind("onDropdownHidden",function(){this.clean(),c.unbind("click"),cdb.god.unbind(null,null,b.options_menu)}),this.$body.append(this.options_menu.render().el),this.options_menu.open(a)},_shareVisualization:function(a){if(this.killEvent(a),this.options.user.featureEnabled("new_modals"))if(this.model.isVisualization())this._createPublishView();else{var b=new cdb.editor.CreateVisFirstView({clean_on_hide:!0,enter_to_confirm:!0,model:this.model,router:window.table_router,title:"A map is required to publish",explanation:"A map is a shareable mix of layers, styles and queries. You can view all your maps in your dashboard."});b.appendToBody()}else this.controller&&this.controller.clean(),this.controller=new cdb.admin.ShareController({model:this.model,user:this.options.user,config:this.options.config})},_createPublishView:function(){var a=new cdb.editor.PublishView({clean_on_hide:!0,enter_to_confirm:!0,user:this.options.user,model:this.model});a.render().appendToBody()},_showPrivacyDialog:function(a){if(a&&this.killEvent(a),!this.model.isOwnedByUser(this.options.user))return!1;if(this.options.user.featureEnabled("new_modals")){var b=new cdb.editor.ChangePrivacyView({vis:this.model,user:this.options.user,enter_to_confirm:!0,clean_on_hide:!0});b.appendToBody()}else this.privacy_dialog=new cdb.admin.PrivacyDialog({model:this.model,config:this.options.config,user:this.options.user}),this.privacy_dialog.appendToBody(),this.privacy_dialog.open({center:!0})},setInfo:function(){this._setName(),this._setSyncInfo(),this._setVisualization(),this._setMetadata()},setEditableInfo:function(){this._setName(),this._setSyncInfo(),this._setMetadata()},_setPrivacy:function(){var a=this.$("a.privacy");this._setSharedCount();var b=this.model.get("privacy").toLowerCase();"public"==b?a.removeClass("private").removeClass("link_protected").removeClass("password_protected").removeClass("organization").addClass("public"):"link"==b?a.removeClass("public").removeClass("private").removeClass("password_protected").removeClass("organization").addClass("link_protected"):"private"==b?a.removeClass("public").removeClass("link_protected").removeClass("password_protected").removeClass("organization").addClass("private"):"password"==b?a.removeClass("private").removeClass("link_protected").removeClass("public").removeClass("organization").addClass("password_protected"):"organization"==b&&a.removeClass("private").removeClass("link_protected").removeClass("public").removeClass("password_protected").addClass("organization");var c=this.model.permission.isOwner(this.options.user);a.find("i")[c?"removeClass":"addClass"]("disabled")},_setSharedCount:function(){var a=this.model.permission.isOwner(this.options.user),b=this.$("a.privacy i");if(b.empty(),a){var c=$("<span>").addClass("shared_users");if(this.model.permission.acl.size()>0){var d=0,e=this.model.permission.getUsersWithAnyPermission();this.model.permission.getUsersWithPermission("org");d=this.model.permission.getUsersWithPermission("org").length>0?"ORG":e.length,c.text(0!==d?d:""),b.append(c)}}},_setMetadata:function(){var a=this.model.permission.isOwner(this.options.user),b=this.dataLayer&&this.dataLayer.table&&this.dataLayer.table.isInSQLView(),c=this.$(".metadata a"),d=this._TEXTS.metadata.edit,e="#/edit-metadata";(!a||b)&&(d=this._TEXTS.metadata.view,e="#/view-metadata"),c.attr("href",e).text(d)},_setSyncInfo:function(){this.sync_info&&this.sync_info.clean(),!this.model.isVisualization()&&this.isSyncTable()?(this.$el.addClass("synced"),this.sync_info=new cdb.admin.SyncInfo({dataLayer:this.dataLayer,user:this.options.user}),this.$(".sync_status").append(this.sync_info.render().el),this.addView(this.sync_info)):this.$el.removeClass("synced")},_setName:function(){var a=this.$("h1 a.title");a[this.isVisEditable()&&!this.isSyncTable()?"removeClass":"addClass"]("disabled").text(this.model.get("name")),document.title=this.model.get("name")+" | CartoDB"},_setVisualization:function(){var a=this.$("a.back"),b=this.$("a.share"),c=this.model.isVisualization();if(c){b.find("span").text(this._TEXTS.share.publish),this._setPrivacy();var d=cdb.config.prefixUrl()+"/dashboard/maps";a.attr("href",d)}else{b.find("span").text(this._TEXTS.share.visualize),this._setPrivacy();var d=cdb.config.prefixUrl()+"/dashboard/datasets";a.attr("href",d)}},_changeMetadata:function(a){var b,c=this;a.preventDefault(),b=this.options.user.featureEnabled("new_modals")?new cdb.editor.EditVisMetadataView({maxLength:this._MAX_DESCRIPTION_LENGTH,vis:this.model,dataLayer:this.dataLayer&&this.dataLayer.table,user:this.options.user,clean_on_hide:!0,enter_to_confirm:!1,onShowPrivacy:function(){c._showPrivacyDialog()},onDone:function(a){a&&!this.vis.isVisualization()&&(window.table_router.navigate(c._generateTableUrl(),{trigger:!1}),window.table_router.addToHistory())}}):new cdb.admin.MetadataDialog({maxLength:this._MAX_DESCRIPTION_LENGTH,vis:this.model,user:this.options.user,onResponse:function(a){c._onSetAttributes(a)}}),b.appendToBody(),b.open({center:!0})},_changeTitle:function(a){function b(){var a=$(this),c=a.data("tipsy");c&&a.tipsy("hide").unbind("mouseleave",b)}function c(a){if(a!==d.model.get("name")&&""!=a){var b=cdb.Utils.stripHTML(a,"");d.model.isVisualization()?d._onSetAttributes({name:b}):(d.change_confirmation&&d.change_confirmation.clean(),d.options.user.featureEnabled("new_modals")?d.change_confirmation=cdb.editor.ViewFactory.createDialogByTemplate("common/dialogs/confirm_rename_dataset"):d.change_confirmation=new cdb.admin.BaseDialog({title:d._TEXTS.rename.title.replace("{{ vis }}",d.model.isVisualization()?"visualization":"table"),description:d._TEXTS.rename["desc_"+(d.model.isVisualization()?"vis":"table")],template_name:"old_common/views/confirm_dialog",clean_on_hide:!0,enter_to_confirm:!0,ok_button_classes:"right button grey",ok_title:d._TEXTS.rename.ok,cancel_button_classes:"underline margin15",modal_type:"confirmation",width:500}),d.change_confirmation.ok=function(){d._onSetAttributes({name:b}),this.close&&this.close()},d.change_confirmation.appendToBody().open())}}this.killEvent(a);var d=this,e=this.model.permission.isOwner(this.options.user);if(this.isVisEditable()){this.title_dialog&&this.title_dialog.clean(),cdb.god.trigger("closeDialogs");var f=this.title_dialog=new cdb.admin.EditTextDialog({initial_value:this.model.get("name"),template_name:"table/views/edit_name",clean_on_hide:!0,modal_class:"edit_name_dialog",onResponse:c});cdb.god.bind("closeDialogs",f.hide,f);var g=$(a.target).offset();g.left-=$(window).scrollLeft(),g.top-=$(window).scrollTop();var h=Math.max($(a.target).width()+100,280);f.showAt(g.left-20,g.top-10,h)}else{var i=$(a.target);i.bind("mouseleave",b).tipsy({fade:!0,trigger:"manual",html:!0,title:function(){var a=d.isSyncTable()?"sync":"read-only";return _.template(d._TEXTS.rename[e?"readonly":"owner"])({mode:a})}}).tipsy("show")}},_onSetAttributes:function(a){var b=this.model.toJSON(),c=a;if(this.model.set(a,{silent:!0}),this.model.hasChanged()){var d=this;this.globalError.showError(this._TEXTS.saving,"load",-1),this.model.save({},{wait:!0,success:function(a){c.name===b.name||d.model.isVisualization()||(window.table_router.navigate(d._generateTableUrl(),{trigger:!1}),window.table_router.addToHistory()),d.globalError.showError(d._TEXTS.saved,"info",3e3)},error:function(a,c){var e=c&&JSON.parse(c.responseText).errors[0];d.globalError.showError(e,"error",3e3),d.model.set(b,{silent:!0}),d.setInfo()}})}},isVisEditable:function(){if(this.model.isVisualization())return!0;var a=this.model.map.layers&&this.model.map.layers.last()&&this.model.map.layers.last().table;return a&&(!a||!a.isReadOnly()&&a.permission.isOwner(this.options.user))?!0:!1},isSyncTable:function(){return this.dataLayer&&this.dataLayer.table?this.dataLayer.table.isSync():!1},_generateTableUrl:function(a){var b="";if(this.model.isVisualization())b+="/viz/"+this.model.get("id");else{var c=this.model.permission.isOwner(this.options.user),d=new cdb.admin.CartoDBTableMetadata(this.model.get("table"));if(c)b+="/tables/"+d.getUnqualifiedName();else{
var e=this.model.permission.owner.get("username");b+="/tables/"+e+"."+d.getUnqualifiedName()}}var f=a?$(a.target).attr("href"):window.location.pathname;return b+=-1!=f.search("/map")?"/map":"/table"},_onTabClick:function(a){a.preventDefault(),window.table_router.navigate(this._generateTableUrl(a),{trigger:!0})}}),cdb.admin.hotkeys={_keyMap:{68:"s",67:"c",83:"s"},enable:function(){$("body").bind("keydown",function(a){if(a.altKey&&a.ctrlKey){var b=cdb.admin.hotkeys._keyMap[a.keyCode];if(b)return cdb.god.trigger("hotkey:"+b,a),a.preventDefault(),a.stopPropagation(),!1}})}},cdb.common.DatePicker=cdb.core.View.extend({_MAX_RANGE:30,className:"custom-datepicker",options:{flat:!0,date:["2008-07-31","2008-07-31"],current:"2008-07-31",calendars:2,mode:"range",starts:1},events:{"click a.dates":"_toggleCalendar"},initialize:function(){this.model=new cdb.core.Model({fromDate:"",fromHour:0,fromMin:0,toDate:"",toHour:23,toMin:59,user_timezone:0}),this.template=this.options.template||cdb.templates.getTemplate("old_common/views/custom_datapicker"),this._initBinds(),this._setToday()},render:function(){var a=this;return this.clearSubViews(),this.$el.append(this.template(_.extend(this.model.attributes,{max_days:this._MAX_RANGE}))),setTimeout(function(){a._initCalendar(),a._hideCalendar(),a._initTimers()},100),this},_initBinds:function(){_.bindAll(this,"_onDatesChange","_onDocumentClick"),this.model.bind("change",this._setValues,this),this.model.bind("change",this._onValuesChange,this),$(document).bind("click",this._onDocumentClick)},_destroyBinds:function(){$(document).unbind("click",this._onDocumentClick)},_setValues:function(a,b){var c="Choose your dates",d=this.model.attributes;d.fromDate&&d.toDate&&(c="From <em>"+this.model.get("fromDate")+" "+(cdb.Utils.pad(this.model.get("fromHour"),2)+":"+cdb.Utils.pad(this.model.get("fromMin"),2))+"</em> to <em>"+this.model.get("toDate")+" "+(cdb.Utils.pad(this.model.get("toHour"),2)+":"+cdb.Utils.pad(this.model.get("toMin"),2))+"</em>"),this.$(".label").html(c)},_setToday:function(){var a=moment(new Date).format("YYYY-MM-DD"),b=moment(new Date).subtract(this._MAX_RANGE-1,"days").format("YYYY-MM-DD");this.options.date=[b,a],this.options.current=a,this.model.set({fromDate:b,toDate:a})},_initCalendar:function(){var a="div.calendar div.datepicker";if(document.body.contains(this.$(a)[0])){this.calendar=this.$(a).DatePicker(_.extend(this.options,{onChange:this._onDatesChange,onRender:function(a){var b=a.valueOf(),c=new Date,d=new Date;return d.setDate(c.getDate()-30),d>b||b>c?{disabled:!0}:""}}))}},_onDatesChange:function(a,b){var c=moment(a[0]),d=moment(a[1]);Math.abs(c.diff(d,"days"))>this._MAX_RANGE&&(a[1]=moment(a[0]).add("days",this._MAX_RANGE).format("YYYY-MM-DD"),this.$("div.calendar div.datepicker").DatePickerSetDate([a[0],a[1]])),this.model.set({fromDate:a[0],toDate:a[1]})},_hideCalendar:function(a){a&&this.killEvent(a),this.$("div.calendar").hide()},_toggleCalendar:function(a){a&&a.preventDefault(),this.$("div.calendar").toggle()},_initTimers:function(){var a=this.$("div.from"),b=new cdb.forms.Spinner({model:this.model,property:"fromHour",min:0,max:23,inc:1,width:15,pattern:/^([12]?\d{0,1}|3[01]{0,2})$/,debounce_time:0});a.find(".hour").append(b.render().el),this.addView(b);var c=new cdb.forms.Spinner({model:this.model,property:"fromMin",min:0,max:59,inc:1,width:15,pattern:/^([12345]?\d{0,1})$/,debounce_time:0});a.find(".min").append(c.render().el),this.addView(c);var d=this.$("div.to"),e=new cdb.forms.Spinner({model:this.model,property:"toHour",min:0,max:23,inc:1,width:15,pattern:/^([12]?\d{0,1}|3[01]{0,2})$/,debounce_time:0});d.find(".hour").append(e.render().el),this.addView(e);var f=new cdb.forms.Spinner({model:this.model,property:"toMin",min:0,max:59,inc:1,width:15,pattern:/^([12345]?\d{0,1})$/,debounce_time:0});d.find(".min").append(f.render().el),this.addView(f)},_onValuesChange:function(){this.trigger("changeDate",this.model.toJSON(),this)},getDates:function(){return this.model.toJSON()},closeCalendar:function(){this.$("div.calendar").hide()},_onDocumentClick:function(a){var b=$(a.target);0===b.closest(".custom-datepicker").length&&this.closeCalendar()},clean:function(){this._destroyBinds(),this.closeCalendar(),this.$("div.calendar div.datepicker").DatePickerHide(),cdb.core.View.prototype.clean.call(this)}}),cdb.admin.ImportArcGISPane=cdb.admin.ImportUrlPane.extend({className:"import-pane import-arcgis-pane",_initViews:function(){this.import_info=new cdb.admin.ArcGISImportInfo({el:this.$("div.infobox"),model:this.model,acceptSync:this.options.acceptSync||this.user.get("actions").sync_tables}),this.addView(this.import_info)}}),cdb.admin.ImportDropboxPane=cdb.admin.ImportPane.extend({_TEXTS:{button:{idle:_t("Choose from Dropbox"),selected:_t("Change in Dropbox")},fileError:"You have to choose a valid Dropbox file."},className:"import-pane import-pane-dropbox",events:{"click #dropbox-chooser":"_onDropboxClick"},initialize:function(){cdb.admin.ImportPane.prototype.initialize.call(this),_.bindAll(this,"_onDbxChooserSuccess"),this.template=this.options.template||cdb.templates.getTemplate("old_common/views/import/import_dropbox"),this.model.bind("change:value",this._onValueChange,this),this.render(),this._initImportInfo()},render:function(){var a="";return this.options.acceptFileTypes&&(a="."+this.options.acceptFileTypes.join(" .")),this.$el.html(this.template({extensions:a})),this},_initImportInfo:function(){this.import_info=new cdb.admin.DropboxImportInfo({el:this.$("div.infobox"),model:this.model,acceptSync:this.options.acceptSync}),this.import_info.bind("showUpgrade",function(){this.trigger("showUpgrade")},this),this.addView(this.import_info)},_setFilename:function(a){this.$("p.filename").text(a),this.$("p.info").hide(),this.$(".dropbox-dropin-btn").html('<span class="dropin-btn-status"></span>'+this._TEXTS.button.selected)},_onValueChange:function(){this.trigger("valueChange",this.model.toJSON()),this.$el[this.model.get("value")?"addClass":"removeClass"]("value-selected")},submitUpload:function(){this.model.get("value")?this.trigger("fileChosen",this.model.toJSON()):this.import_info.activeTab("error",this._TEXTS.fileError)},_onDropboxClick:function(a){a&&a.preventDefault(),Dropbox.choose({success:this._onDbxChooserSuccess,multiselect:!1,linkType:"direct",extensions:_.map(this.options.acceptFileTypes,function(a){return"."+a})})},_onDbxChooserSuccess:function(a){a&&a[0]&&(this._setFilename(a[0].name||a[0].link),this.model.set({type:"url",value:a[0].link}))}}),cdb.admin.ImportEmptyPane=cdb.admin.ImportPane.extend({className:"create-empty",initialize:function(){cdb.admin.ImportPane.prototype.initialize.call(this),this.model.set({value:"empty",type:"empty",valid:!0}),this.render()},render:function(){return this}}),cdb.admin.ImportErrorPane=cdb.core.View.extend({className:"create-error",_TEXTS:{what_about:_t('Sorry, something went wrong and we\'re not sure what. Contact us at                     <a href="mailto:support@cartodb.com">support@cartodb.com</a>.')},initialize:function(){this.template=cdb.templates.getTemplate(this.options.template||"old_common/views/import/import_error"),this._initBinds(),this.render()},render:function(){var a={item_queue_id:this.model.get("upload")&&this.model.get("upload").item_queue_id||"",what_about:this.model.get("error")&&this.model.get("error").what_about||this._TEXTS.what_about};return this.$el.html(this.template(a)),this},_initBinds:function(){this.model.bind("change",this.render,this)}}),cdb.admin.ImportFilePane=cdb.admin.ImportPane.extend({events:{"click div.url p":"_activateTextInput","focusin input.url-input":"_focusIn","focusout input.url-input":"_focusOut","keyup input.url-input":"_onInputChange","paste input.url-input":"_onInputPaste","submit form":"submitUpload"},_UPLOADER:{url:"",maxFileSize:1e8,maxUploadFiles:1,acceptFileTypes:["csv","xls","xlsx","zip","kml","geojson","json","ods","kmz","tsv","gpx","tar","gz","tgz","osm","bz2","tif","tiff","txt","sql"],acceptSync:!1,resolution:""},_TEXTS:{acceptFileTypesError:"{filename} has invalid extension. Only {extensions} are allowed.",urlError:"There is an error in the URL you've inserted. Please recheck.",abortError:"You have decided cancel the upload, start mapping with other file.",maxFileSizeError:"{filename} is too large. You can import files up to {quota}.",resolutionError:"{filename} is too big. You can only import files up to {resolution}.",connectionError:"Sorry, there was a problem with the upload, try again please.",maxUploadFilesError:"Sorry, we don't support upload more than one file at a time right now, but soon!"},initialize:function(){cdb.admin.ImportPane.prototype.initialize.call(this),_.bindAll(this,"_activateTextInput","_onInputPaste","_onInputChange","_onDragOver","_onDrop","submitUpload","_onUploadError","_onUploadSubmit","_focusIn","_focusOut"),this.template=this.options.template||cdb.templates.getTemplate("old_common/views/import/import_file"),this.model.on("change:value change:interval",this._onValueChange,this),this.render()},render:function(){var a=$("<div>");a.append(this.template());var b=this;return _.each(this.options,function(a,c){void 0!==b._TEXTS[c]&&(b._TEXTS[c]=a),void 0!==b._UPLOADER[c]&&(b._UPLOADER[c]=a)}),this._initUploader(a),this._initImportInfo(a),this.$el.append(a),this},_initUploader:function(a){var b=this.$upload=a.find("form");b.fileupload({dropZone:b,url:this._UPLOADER.url,paramName:"filename",progressInterval:100,bitrateInterval:500,maxFileSize:this._UPLOADER.maxFileSize,autoUpload:!1,limitMultiFileUploads:this._UPLOADER.maxUploadFiles,limitConcurrentUploads:this._UPLOADER.maxUploadFiles,acceptFileTypes:this._setValidFileExtensions(this._UPLOADER.acceptFileTypes),add:this._onUploadAdd,submit:this._onUploadSubmit,drop:this._onDrop,dragover:this._onDragOver,fail:this._onUploadError}),b.bind("mouseleave",function(){$(this).removeClass("drop")})},_initImportInfo:function(a){this.import_info=new cdb.admin.ImportInfo({el:a.find("div.infobox"),model:this.model,fileTypes:this._UPLOADER.acceptFileTypes,acceptSync:this._UPLOADER.acceptSync}),this.import_info.bind("showUpgrade",function(){this.trigger("showUpgrade")},this),this.addView(this.import_info)},_activateTextInput:function(a){this.$("input.url-input").focus()},_focusIn:function(a){this.$("div.upload").addClass("active")},_focusOut:function(a){this.$("div.upload").removeClass("active")},_onInputPaste:function(a){setTimeout(this._onInputChange,100)},_onInputChange:function(a){var b=this.getURL();return a&&13==a.keyCode?(this.submitUpload(),!1):void this.model.set({type:"url",value:b,valid:cdb.Utils.isURL(b)?!0:!1})},_onValueChange:function(){"file"!=this.model.get("type")&&(this[""==this.model.get("value")?"_showUploader":"_hideUploader"](),this.trigger("valueChange",this.model.get("value"),this))},_showUploader:function(a){this.$("div.holder").fadeIn()},_hideUploader:function(){this.$("div.holder").fadeOut("fast")},cleanInput:function(){this.$("input.url-input").val(""),this._onInputChange()},_onDragOver:function(){this.$upload.addClass("drop")},_onDrop:function(a,b){return b.files.length>0&&(this.$upload.removeClass("drop"),b.files.length>this._UPLOADER.maxUploadFiles)?(this._onUploadError(null,{files:[{name:"",error:"maxUploadFiles"}]}),!1):void 0},_setValidFileExtensions:function(a){return RegExp("(.|/)("+a.join("|")+")$","i")},submitUpload:function(a){a&&this.killEvent(a);var b=this.getURL();cdb.Utils.isURL(b)?this._send():this.import_info.activeTab("error",this._TEXTS.urlError)},_onUploadError:function(a,b){var c=b.files[0].error||b.errorThrown,d=b.files[0].name,e=this._TEXTS[c+"Error"].replace("{filename}",d).replace("{extensions}",this._UPLOADER.acceptFileTypes.join(", ")).replace("{resolution}",this._UPLOADER.resolution).replace("{quota}",cdb.Utils.readablizeBytes(this._UPLOADER.maxFileSize));this.import_info.activeTab("error",e)},_onUploadAdd:function(a,b){b.submit()},_onUploadSubmit:function(a,b){return this.$upload.data("fileupload")._validate(b.files)?(this.model.set({type:"file",value:b.files[0],interval:0,valid:!0}),this._send(),!1):void 0},getURL:function(){return this.$("input.url-input").val()},setValue:function(a){"file"===a.type?this.$upload.fileupload("add",{files:[a.value]}):(this.model.set(a,{silent:!0}),this._send())},_send:function(){this.trigger("fileChosen",this.model.toJSON())},clean:function(){this.$upload.fileupload("destroy"),this.$upload.unbind("mouseleave"),cdb.admin.ImportPane.prototype.clean.call(this)}}),cdb.admin.ImportGdrivePane=cdb.admin.ImportPane.extend({className:"import-pane import-pane-gdrive",events:{"click .gdrive-chooser":"_onClickGDButton"},_UPLOADER:{acceptFileTypes:["application/vnd.google-apps.spreadsheet"]},initialize:function(){cdb.admin.ImportPane.prototype.initialize.call(this),_.bindAll(this,"_pickerCallback","_driveApiLoaded","_onPickerLoaded"),this.template=this.options.template||cdb.templates.getTemplate("old_common/views/import/import_gdrive"),this.model.set("enabled",!1),this.model.bind("change:value",this._onValueChange,this),this.model.bind("change:enabled",this._onEnabledChange,this),this.render(),this._initImportInfo(),this._setGDrive()},render:function(){return this.$el.append(this.template()),this},_initImportInfo:function(){this.import_info=new cdb.admin.GDriveImportInfo({el:this.$("div.infobox"),model:this.model,acceptSync:this.options.acceptSync}),this.import_info.bind("showUpgrade",function(){this.trigger("showUpgrade")},this),this.addView(this.import_info)},_setFilename:function(a){this.$("p.filename").text(a),this.$("p.info").hide(),this.$(".gdrive-chooser").text("Change selection")},_onValueChange:function(){this.trigger("valueChange",this.model.toJSON()),this.$el[this.model.get("value")?"addClass":"removeClass"]("value-selected")},_onEnabledChange:function(){this.$(".gdrive-chooser")[this.model.get("enabled")?"removeClass":"addClass"]("disabled")},submitUpload:function(){this.model.get("value")?this.trigger("fileChosen",this.model.toJSON()):this.import_info.activeTab("error",this._TEXTS.fileError)},_setGDrive:function(){gapi.client.setApiKey(cdb.config.get("gdrive_app_key")),gapi.client.load("drive","v2",this._driveApiLoaded),google.load("picker","1",{callback:this._onPickerLoaded})},_onPickerLoaded:function(){this.model.set("enabled",!0)},_driveApiLoaded:function(){this._doAuth(!0)},_doAuth:function(a,b){gapi.auth.authorize({client_id:cdb.config.get("gdrive_app_id")+".apps.googleusercontent.com",scope:"https://www.googleapis.com/auth/drive.readonly",immediate:a},b)},_onClickGDButton:function(a){if(a&&this.killEvent(a),this.model.get("enabled")){var b=gapi.auth.getToken();b?this._showPicker():this._doAuth(!1,function(){this._showPicker()}.bind(this))}},_showPicker:function(a){this.killEvent(a);var b=gapi.auth.getToken().access_token;this.picker=(new google.picker.PickerBuilder).addView(new google.picker.View(google.picker.ViewId.DOCS)).setAppId(cdb.config.get("gdrive_app_id")+".apps.googleusercontent.com").setOAuthToken(b).setCallback(this._pickerCallback).build().setVisible(!0)},_pickerCallback:function(a){if(a.action==google.picker.Action.PICKED){var b=a.docs[0].url+"&output=csv",c=a.docs[0].name;this.model.set({type:"url",value:b}),this._setFilename(c)}}}),cdb.admin.ArcGISImportInfo=cdb.admin.ImportInfo.extend({_TEXTS:{help:_t("Only an ArcGIS layer can be synchronized")},_initPanes:function(){this.syncPane=new cdb.admin.ImportInfo.Sync,this.syncPane.bind("periodChange",this._updatePeriod,this),this.syncHelp=new cdb.admin.ImportInfo.Message({className:"info sync-help",msg:this._TEXTS.help}),this.errorPane=new cdb.admin.ImportInfo.Message({className:"info error"}),this.panes=new cdb.ui.common.TabPane({el:this.$el}),this.panes.addTab("sync",this.syncPane),this.panes.addTab("error",this.errorPane),this.panes.addTab("help",this.syncHelp),this.panes.bind("tabEnabled",this._showTab,this),this.panes.bind("tabDisabled",this._hideTab,this),this.addView(this.panes),this.$el.append(this.panes.render())},_canSync:function(a){return-1!==a.search(/([0-9]+\/|[0-9]+)/)},_onChangeValue:function(){var a=this.model.get("value");this.panes.activePane;if(a&&cdb.Utils.isURL(a))if(void 0!==this.options.acceptSync){if(!this._canSync(a))return this.activeTab("help"),!1;if(this._canSync(a))return this.activeTab("sync"),!1;this._hideTab()}else this._hideTab();else this._hideTab()}}),cdb.admin.DropboxImportInfo=cdb.admin.ImportInfo.extend({_TEXTS:{help:_t("Only files in your Public folder can be synced automatically."),upgrade:_t('To mantain your data in sync with the source <a href="#/showUpgrade">upgrade your plan</a>.')},_initPanes:function(){this.syncPane=new cdb.admin.ImportInfo.Sync,this.syncPane.bind("periodChange",this._updatePeriod,this),this.syncDisabledPane=new cdb.admin.ImportInfo.Message({className:"info no-sync",msg:this._TEXTS.upgrade}),this.syncDisabledPane.bind("showUpgrade",this._triggerUpgrade,this),this.syncHelp=new cdb.admin.ImportInfo.Message({className:"info sync-help",msg:this._TEXTS.help}),this.errorPane=new cdb.admin.ImportInfo.Message({className:"info error"}),this.panes=new cdb.ui.common.TabPane({el:this.$el}),this.panes.addTab("sync",this.syncPane),this.panes.addTab("sync_disabled",this.syncDisabledPane),this.panes.addTab("error",this.errorPane),this.panes.addTab("help",this.syncHelp),this.panes.bind("tabEnabled",this._showTab,this),this.panes.bind("tabDisabled",this._hideTab,this),this.addView(this.panes),this.$el.append(this.panes.render())},_isPublicFile:function(a){return-1!=a.search("/Public/")},_onChangeValue:function(){var a=this.model.get("value");this.panes.activePane;if(a)if(void 0!==this.options.acceptSync){if(!this._isPublicFile(a))return this.activeTab("help"),!1;if(!this.options.acceptSync&&this._isPublicFile(a))return this.activeTab("sync_disabled"),!1;if(this.options.acceptSync&&this._isPublicFile(a))return this.activeTab("sync"),!1;this._hideTab()}else this._hideTab();else this._hideTab()}}),cdb.admin.GDriveImportInfo=cdb.admin.ImportInfo.extend({_isPublicFile:function(a){return!0},_onChangeValue:function(){var a=this.model.get("value");this.panes.activePane;a&&this._isPublicFile(a)&&void 0!==this.options.acceptSync?this.options.acceptSync?this.activeTab("sync"):this.activeTab("sync_disabled"):this._hideTab()}}),cdb.admin.ImportInfo.Message=cdb.core.View.extend({className:"info msg",tagName:"div",_MSG:"",events:{"click a":"_triggerEvent"},initialize:function(a){_.bindAll(this,"_triggerEvent"),a.msg&&(this._MSG=a.msg),this.render()},render:function(){return this.$el.html("<p>"+this._MSG+"</p>"),this},_triggerEvent:function(a){a.preventDefault();var b=$(a.target).attr("href").replace(/#\//g,"");this.trigger(b)},setMessage:function(a){this._MSG=a,this.render()},reset:function(){}}),cdb.admin.ImportInfo.Sync=cdb.core.View.extend({className:"info sync",tagName:"div",_DAYS:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31],initialize:function(){this.template=cdb.templates.getTemplate("old_common/views/sync_selector"),this.model=new cdb.core.Model({period:0}),this.render()},render:function(){return this.clearSubViews(),this.$el.html(this.template(this.model.toJSON())),this._renderPeriod(),this._renderCustom(),this},_renderPeriod:function(){var a=new cdb.forms.IntervalCombo({el:this.$(".period"),model:this.model,property:"period",width:"108px"});a.bind("change",this._onChangePeriod,this),a.render(),this.addView(a)},_renderCustom:function(){if("Custom"==this.model.get("period")){var a=new cdb.forms.Combo({el:this.$(".day"),model:this.model,property:"day",width:"40px",extra:this._DAYS});a.bind("change",function(){cdb.log.info("day changed")},this),a.render(),this.addView(a)}},_onChangePeriod:function(a){this.trigger("periodChange",a)},setMessage:function(){},reset:function(){this.model.set("period",0),this.model.unset("day"),this.model.unset("time"),this.render()}}),cdb.admin.ServiceImportInfo=cdb.admin.ImportInfo.extend({_TEXTS:{token:_t("Checking if you've already logged with this service..."),oauth:_t("Instructions to connect your account should appear in a popup. If you can't see it,                     check your pop-up blocker configuration."),error:_t("There was an error trying to get your service token or you didn't                     finish the oAuth process. Try again please."),list:_t("A list of your files will be displayed in a moment."),upgrade:_t('To mantain your data in sync with the source <a href="#/showUpgrade">upgrade your plan</a>.')},_initPanes:function(){this.syncPane=new cdb.admin.ImportInfo.Sync,this.syncPane.bind("periodChange",this._updatePeriod,this),this.syncDisabledPane=new cdb.admin.ImportInfo.Message({className:"info no-sync",msg:this._TEXTS.upgrade}),this.syncDisabledPane.bind("showUpgrade",this._triggerUpgrade,this),this.tokenHelp=new cdb.admin.ImportInfo.Message({className:"info tips token",msg:this._TEXTS.token}),this.oauthHelp=new cdb.admin.ImportInfo.Message({className:"info tips oauth",msg:this._TEXTS.oauth}),this.listHelp=new cdb.admin.ImportInfo.Message({className:"info tips list",msg:this._TEXTS.list}),this.errorPane=new cdb.admin.ImportInfo.Message({className:"info error",msg:this._TEXTS.error}),this.panes=new cdb.ui.common.TabPane({el:this.$el}),this.panes.addTab("sync",this.syncPane),this.panes.addTab("sync_disabled",this.syncDisabledPane),this.panes.addTab("oauth",this.oauthHelp),this.panes.addTab("token",this.tokenHelp),this.panes.addTab("list",this.listHelp),this.panes.addTab("error",this.errorPane),this.panes.bind("tabEnabled",this._showTab,this),this.panes.bind("tabDisabled",this._hideTab,this),this.addView(this.panes),this.$el.append(this.panes.render())},_onChangeValue:function(){var a=this.model.get("value");this.panes.activePane;if(a)if(void 0!==this.options.acceptSync){if(!this.options.acceptSync)return this.activeTab("sync_disabled"),!1;if(this.options.acceptSync)return this.activeTab("sync"),!1;this._hideTab()}else this._hideTab();else this._hideTab()}}),cdb.admin.ImportLayerPane=cdb.admin.ImportPane.extend({className:"import-pane import-layer-pane",initialize:function(){this.tables=new cdb.admin.Visualizations,this.user=this.options.user,this.model=new cdb.core.Model({type:"layer",value:"",table_name:"",interval:"0",valid:!1}),this.template=cdb.templates.getTemplate(this.options.template||"old_common/views/import/import_layer"),this.render(),this._fetchTables(),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.append(this.template()),this._initViews(),this},_initViews:function(){var a=cdb.ui.common.VisualizationsSelector;this.tableCombo=new a({model:this.tables,user:this.user}),this.tableCombo.bind("change",this._onTableSelected,this),this.$(".tableListCombo").append(this.tableCombo.render().el),this.addView(this.tableCombo)},_initBinds:function(){this.model.bind("change",this._onValueChange,this)},_fetchTables:function(a){this.tables.options.set({type:"table",per_page:1e5,table_data:!1});var b={data:{o:{updated_at:"desc"},exclude_raster:!0}};this.tables.bind("reset",this._onTablesFetched,this),this.tables.bind("error",this._onTablesError,this),this.tables.fetch(b),this.add_related_model(this.tables)},_onTablesFetched:function(){this.tables.unbind(null,null,this),this._toggleElements(["span.loader","p.warning.error"],!1,!0),this._showTablesList()},_onTablesError:function(){this._toggleElements(["span.loader"],!1,!0),this._removeTablesList(),this._toggleElements(["p.warning.error"],!0,!1)},_onTableSelected:function(a){if(a){var b=this;this._toggleElements(["p.warning.geo"],!1,!1);var c=this.tables.find(function(b){return b.get("name")==a.name}),d=new cdb.admin.CartoDBTableMetadata({id:c.get("table").id});d.fetch({success:function(a){var c=b.tableCombo.getSelected();c&&c.name==a.get("name")&&0==a.statsGeomColumnTypes().length&&b._toggleElements(["p.warning.geo"],!0,!1)}}),this._getTableName(a)}},_getTableName:function(a){var b=this.tables.find(function(b){return b.id===a.vis_id});if(b){var c=b.get("table").name||a.name;this.model.set({value:c,table_name:c,valid:!0})}},_toggleElements:function(a,b,c){var d=this;_.each(a,function(a){c?d.$(a)[b?"slideDown":"slideUp"]("slow").animate({opacity:b?1:0},{queue:!1,duration:"slow"}):d.$(a)[b?"show":"hide"]()})},_showTablesList:function(){this.$(".options").css("opacity",1),this.$("p.message").fadeIn(),this.$(".combo_wrapper").fadeIn()},_removeTablesList:function(){this.$(".options ul.options").remove()},_onValueChange:function(){this.trigger("valueChange",this.model.toJSON(),this)}}),cdb.admin.ImportMessagePane=cdb.admin.ImportPane.extend({className:"import-message-pane",options:{message:_t("Import pane disabled")},initialize:function(){this.model=new cdb.core.Model({value:"",valid:!1}),this.template=cdb.templates.getTemplate(this.options.template),this.render()},render:function(){return this.$el.append(this.template()),this}}),cdb.admin.ImportPaneModel=cdb.core.Model.extend({defaults:{type:"",value:"",interval:"0",valid:!1}}),cdb.admin.ImportServicePane=cdb.admin.ImportPane.extend({defaults:{filename_field:"id"},_TEXTS:{},_DATASOURCE_NAME:"",_WINDOW_INTERVAL:1e3,className:"import-pane import-service-pane",events:{"click a.service-button":"_checkToken","click a.change":"_showList"},initialize:function(){return this.options.service?(this._DATASOURCE_NAME=this.options.service,this.options=_.extend(this.defaults,this.options),this.model=new cdb.core.Model({type:"service",value:"",interval:"0",service_name:this.options.service,service_item_id:"",valid:!1}),this.template=cdb.templates.getTemplate(this.options.template||"old_common/views/import/import_service"),this._initModels(),this._initBinds(),void this.render()):(cdb.log.info("Service provider not set!"),!1)},render:function(){return this.$el.html(this.template({label:this.options.label||"",show_formats_link:void 0===this.options.show_formats_link?!0:!1,item_kind:this.options.item_kind||"file",service:this._DATASOURCE_NAME})),this._initViews(),this},_initModels:function(){this.token=new cdb.admin.ServiceToken(null,{datasource_name:this._DATASOURCE_NAME}),this.service=new cdb.admin.ServiceOauth(null,{datasource_name:this._DATASOURCE_NAME}),this.collection=new cdb.admin.ServiceCollection(null,{datasource_name:this._DATASOURCE_NAME})},_initViews:function(){var a=new cdb.admin.ImportServiceList({el:this.$("div.list"),collection:this.collection,acceptFileTypes:this.options.acceptFileTypes});a.bind("fileSelected",this._selectFile,this),this.addView(a),this.import_info=new cdb.admin.ServiceImportInfo({el:this.$("div.infobox"),model:this.model,acceptSync:this.options.acceptSync}),this.import_info.bind("showUpgrade",function(){this.trigger("showUpgrade")},this),this.addView(this.import_info)},_initBinds:function(){_.bindAll(this,"_showError","_showList","_changeToList"),this.model.bind("change:state",this._onStateChange,this),this.model.bind("change:interval",this._triggerChange,this),this.service.bind("change:url",this._openWindow,this)},_checkToken:function(a){a&&this.killEvent(a),this._changeModel("token","");var b=this;this.token.fetch({success:function(a){a.get("oauth_valid")?b._getFiles():b._getOauthURL()},error:function(a){b._getOauthURL()}})},_changeToList:function(a){a&&this.killEvent(a),this._changeModel("list","")},_changeModel:function(a,b,c){var d=_.extend({state:a,value:b,service_item_id:b,valid:"chosen"===a?!0:!1},c);this.model.set(d),this._triggerChange()},_onStateChange:function(a,b){var c=cdb.admin.service_states[b];if(!c)return cdb.log.info("service state not defined"),!1;this.$(".loader")[c.loader?"show":"hide"](),this.$("div.list")[c.list?"show":"hide"](),this.$("div.input")[c.list?"hide":"show"]();var d=this.$("p.msg");d[c.msg?"show":"hide"](),c.msg&&d.text(_.template(c.msg)({service:this._DATASOURCE_NAME}));var e=this.$("p.filename");e[c.file?"show":"hide"](),c.file&&e.text(this.model.get("filename")).attr("title",this.model.get("filename"));var f=this.$(".service-button");_.each(c.service,function(a,b){f[b](a)});var g=this.$(".change");_.each(c.change,function(a,b){g[b](a)}),this.import_info.activeTab(c.info)},_selectFile:function(a){this._changeModel("chosen",a.get("id"),{filename:a.get(this.options.filename_field)})},_showError:function(){this._changeModel("error","")},_showList:function(a){a&&this.killEvent(a),this._changeModel("retrieved","")},_getOauthURL:function(){this._changeModel("oauth",""),this.service.set({url:""},{silent:!0}),this.service.fetch()},_getFiles:function(){this._changeModel("retrieving",""),this.collection.fetch({data:{filter:this.options.acceptFileTypes},error:this._showError,success:this._showList})},_openWindow:function(){var a=this.service.get("url"),b=this,c=window.open(a,null,"menubar=no,toolbar=no,width=600,height=495"),d=window.setInterval(function(){c&&c.closed?(b._getFiles(),clearInterval(d)):c||(b._changeModel("error",""),clearInterval(d))},this._WINDOW_INTERVAL)},_triggerChange:function(){this.trigger("valueChange",this.model.toJSON()),this.trigger("changeSize",this)},submitUpload:function(){this.model.get("value")&&this.trigger("fileChosen",this.model.toJSON())}}),cdb.admin.ImportInstagramPane=cdb.admin.ImportServicePane.extend({}),cdb.admin.service_states={token:{loader:!0,list:!1,msg:_t("Checking token..."),file:!1,info:"token",change:{css:{display:"none"}},service:{css:{display:"none"}}},oauth:{loader:!0,list:!1,msg:_t("Requesting oAuth..."),file:!1,info:"oauth",change:{css:{display:"none"}},service:{css:{display:"none"}}},retrieving:{loader:!0,list:!1,msg:_t("Getting information..."),file:!1,info:"list",change:{css:{display:"none"}},service:{css:{display:"none"}}},retrieved:{loader:!1,list:!0,msg:!1,file:!1,info:"",change:{css:{display:"none"}},service:{css:{display:"none"}}},error:{loader:!1,list:!1,msg:!1,file:!1,info:"error",change:{css:{display:"none"}},service:{css:{display:"block"}}},chosen:{loader:!1,list:!1,msg:!1,file:!0,info:"",change:{css:{display:"block"}},service:{css:{display:"none"}}}},cdb.admin.ImportSuccessPane=cdb.core.View.extend({className:"create-success",initialize:function(){this.template=cdb.templates.getTemplate(this.options.template||"old_common/views/import/import_success"),this._initBinds(),this.render()},render:function(){var a=this.model.get("upload")&&this.model.get("option")||"",b=this.model.get("upload")&&this.model.get("upload").tweets_cost||0,c=this.model.get("upload")&&this.model.get("upload").tweets_overquota||!1,d=this.model.get("upload")&&cdb.Utils.formatNumber(this.model.get("upload").tweets_georeferenced)||0,e=this.model.get("upload")&&this.model.get("upload").table_name,f=this.model.get("upload")&&cdb.Utils.formatNumber(this.model.get("upload").tweets_left)||0,g={service:a,tweets_cost:b,tweets_overquota:c,tweets_georeferenced:d,table_name:e,tweets_left:f};return this.$el.html(this.template(g)),this},_initBinds:function(){this.model.bind("change",this.render,this)}}),cdb.admin.ImportTwitterPane=cdb.admin.ImportPane.extend({className:"import-pane import-twitter-pane",_TIPSYS:["i.help"],_TEXTS:{category:{limit:{characters:_t("Maximum characters per category are 1014"),terms:_t("Maximum terms per category are 29")}},date:{error:_t("Date range has to be before today and at least one category is required")}},initialize:function(){this.user=this.options.user,this.model=new cdb.core.Model({type:"service",service_name:"twitter_search",value:{},service_item_id:{},interval:"0",valid:!1}),this.template=cdb.templates.getTemplate(this.options.template||"old_common/views/import/import_twitter"),this.render(),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.append(this.template(this.user.get("twitter"))),this._initViews(),this},_initViews:function(){var a=new cdb.common.TwitterCategories;a.bind("changeCategory",this._onCategoriesChange,this),a.bind("submitCategory",this._onSubmit,this),a.bind("limitCategory",this._onCategoryLimit,this),a.bind("noLimitCategory",this._onCategoryNoLimit,this),a.bind("addCategory",this._onAddRemoveCategory,this),a.bind("removeCategory",this._onAddRemoveCategory,this),
this.$(".twitter-categories").append(a.render().el),this.addView(a);var b=this.datepicker=new cdb.common.DatePicker;b.bind("changeDate",this._onDateChange,this),this.$(".twitter-date").append(b.render().el),this.addView(b),this._onDateChange(b.getDates()),this.error_info=new cdb.admin.ImportInfo({el:this.$("div.infobox"),model:this.model}),this.addView(this.error_info),this._createTipsys()},_initBinds:function(){this.model.bind("change",this._onValueChange,this)},_onAddRemoveCategory:function(){this.trigger("changeSize",this)},_onCategoryLimit:function(a,b){var c="";_.each(a,function(a){0===a.counter&&(c="characters"),a.terms.length>=b._MAX_TERMS&&(c="terms")}),this.error_info.activeTab("error",this._TEXTS.category.limit[c])},_onCategoryNoLimit:function(a,b){this.error_info.hideTab()},_onCategoriesChange:function(a,b){var c=this.model.get("value");c.categories=_.filter(a,function(a){return a.category&&a.terms.length>0}),this.model.set({value:c,service_item_id:c}),this._checkValid()},_onDateChange:function(a,b){var c=this.model.get("value");c.dates=a,this.model.set({value:c,service_item_id:c}),this._checkValid()},_onValueChange:function(){this.trigger("valueChange",this.model.toJSON(),this)},_onSubmit:function(){this.model.get("valid")?this.trigger("fileChosen",this.model.toJSON()):this.error_info.activeTab("error",this._TEXTS.date.error),this._closeCalendar()},_checkValid:function(){var a=this.model.get("value").categories,b=this.model.get("value").dates,c=moment(b.fromDate)<=moment(new Date),d=a&&a.length>0&&b&&b.fromDate&&b.toDate&&c;this.model.set("valid",d)},_closeCalendar:function(a){this.datepicker.closeCalendar()},_createTipsys:function(){var a=this;_.each(this._TIPSYS,function(b){var c=new cdb.common.TipsyTooltip({el:a.$(b)});a.addView(c)})}}),cdb.admin.ImportServiceItem=cdb.core.View.extend({tagName:"li",events:{"click a":"_selectFile"},initialize:function(){_.bindAll(this,"_selectFile"),this.template=this.options.template||cdb.templates.getTemplate("old_common/views/import/import_service_item")},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},_selectFile:function(a){a&&this.killEvent(a),this.trigger("fileSelected",this.model,this)}}),cdb.admin.ImportServiceList=cdb.core.View.extend({_TEXTS:{empty:_t("No files with the required extensions are available in your account")},initialize:function(){this._initBinds()},render:function(){return this.clearSubViews(),this.$("ul").html(""),0===this.collection.size()?(this.$("ul").append($("<li>").addClass("empty").text(this._TEXTS.empty)),!1):(this.collection.each(function(a){var b=new cdb.admin.ImportServiceItem({model:a});b.bind("fileSelected",this._fileSelected,this),this.$("ul").append(b.render().el),this.addView(b)},this),this.custom_scroll=new cdb.admin.CustomScrolls({el:this.$("ul"),parent:this.$el}),this.addView(this.custom_scroll),this)},_initBinds:function(){this.collection.bind("reset",this.render,this)},_fileSelected:function(a){this.trigger("fileSelected",a,this)}}),cdb.admin.ServiceItem=cdb.core.Model.extend({defaults:{id:"",filename:"",checksum:"",service:"",size:"",title:""}}),cdb.admin.ServiceCollection=Backbone.Collection.extend({_DATASOURCE_NAME:"dropbox",model:cdb.admin.ServiceItem,initialize:function(a,b){b.datasource_name&&(this._DATASOURCE_NAME=b.datasource_name)},fetch:function(){return this.trigger("fetch",this),Backbone.Collection.prototype.fetch.apply(this,arguments)},parse:function(a){return a.files},url:function(a){var b=cdb.config.urlVersion("imports_service",a);return"/api/"+b+"/imports/service/"+this._DATASOURCE_NAME+"/list_files"}}),cdb.admin.ServiceOauth=cdb.core.Model.extend({_DATASOURCE_NAME:"dropbox",initialize:function(a,b){b.datasource_name&&(this._DATASOURCE_NAME=b.datasource_name)},url:function(a){var b=cdb.config.urlVersion("imports_service",a);return"/api/"+b+"/imports/service/"+this._DATASOURCE_NAME+"/auth_url"},parse:function(a){return a}}),cdb.admin.ServiceToken=cdb.core.Model.extend({_DATASOURCE_NAME:"dropbox",initialize:function(a,b){b.datasource_name&&(this._DATASOURCE_NAME=b.datasource_name)},url:function(a){var b=cdb.config.urlVersion("imports_service",a);return"/api/"+b+"/imports/service/"+this._DATASOURCE_NAME+"/token_valid"},parse:function(a){return a}}),function(){var a=function(a){this.name=a};a.prototype.get=function(a){if(localStorage.getItem(this.name)){if(void 0===a)return JSON.parse(localStorage.getItem(this.name));var b=JSON.parse(localStorage.getItem(this.name));return b[a]}return[]},a.prototype.search=function(a){var b=JSON.parse(localStorage.getItem(this.name));for(var c in b)if(b[c][a])return b[c][a];return null},a.prototype.set=function(a){return localStorage.getItem(this.name)||localStorage.setItem(this.name,"[]"),localStorage.setItem(this.name,JSON.stringify(a))},a.prototype.add=function(a){var b=this.get();return b?(b.push(a),this.set(b)):void 0},a.prototype.remove=function(a){var b=this.get();return b.splice(a,a),this.set(b)},a.prototype.destroy=function(){delete localStorage[this.name]},cdb.admin.localStorage=a}(),cdb.admin.LockVisualizationDialog=cdb.admin.BaseDialog.extend({events:cdb.ui.common.Dialog.extendEvents({"click .back":"_back","click .continue":"_cancel"}),default_options:{cancelEnabled:!0,include_footer:!0,cancel_button_classes:""},initialize:function(){this.user=this.options.user,_.extend(this.options,{width:500,clean_on_hide:!0,template_name:"old_common/views/lock_visualization_dialog",ok_button_classes:"button grey",modal_class:"lock_visualization",modal_type:"notification",ownerName:this.model.permission.owner.get("username"),isOwner:this.model.permission.isOwner(this.user),isVisLock:this.model.get("locked"),visName:this.model.get("name"),visType:this.model.isVisualization()?"map":"dataset",belongsOrg:this.options.user.isInsideOrg(),sharedPeople:this.model.permission.acl.size()}),cdb.admin.BaseDialog.prototype.initialize.apply(this)},_keydown:function(a){this.options.cancelEnabled!==!1&&27===a.keyCode&&this._cancel()},_cancel:function(a){this.killEvent(a),this.hide()},_back:function(a){this.killEvent(a);var b=this.model.isVisualization()?"visualizations":"tables";window.location.href=cdb.config.prefixUrl()+"/dashboard/"+b},ok:function(){var a=this;this.model.save({locked:!this.model.get("locked")},{wait:!0,success:function(){a.options.onResponse&&a.options.onResponse()}})}}),cdb.admin.MapboxToTileLayerFactory=cdb.core.Model.extend({defaults:{url:"",accessToken:""},_MAPBOX:{version:4,https:"https://dnv9my2eseobd.cloudfront.net",base:"https://a.tiles.mapbox.com/"},createTileLayer:function(a){var b,c=this.get("url"),d=this._lowerXYZ(c),e=this.get("accessToken"),f="json",g=["a","b","c"];d.indexOf("{x}")<0&&-1!==d.indexOf("tiles.mapbox.com")?(b=this._getMapBoxMapID(d),b&&(f="mapbox_id",d=b)):-1!==d.indexOf("{x}")?(f="xyz",d=d.replace(/\{s\}/g,function(){return g[Math.floor(3*Math.random())]}).replace(/\{x\}/g,"0").replace(/\{y\}/g,"0").replace(/\{z\}/g,"0")):d&&d.indexOf("http")<0&&null!=d.match(/(.*?)\.(.*)/)&&3===d.match(/(.*?)\.(.*)/).length?(f="mapbox_id",b=c):d=this._fixHTTPS(d);var h,i=this;if("mapbox"===f)a.success(this._newTileLayer({tiles:[d]}));else if("xyz"===f)h=new Image,h.onload=function(){a.success(i._newTileLayer({tiles:[i._lowerXYZ(c)]}))},h.onerror=function(){a.error(i._errorToMsg())},h.src=d;else if("mapbox_id"===f){var j="?access_token="+e,k=this._MAPBOX.base+"v"+this._MAPBOX.version+"/"+b,l=k+"/{z}/{x}/{y}.png"+j,m=k+".json"+j,n=setTimeout(function(){a.error(i._errorToMsg())},5e3);$.ajax({url:m,success:function(b){clearTimeout(n),a.success(i._newTileLayer({tiles:[l],attribution:b.attribution,minzoom:b.minzoom,maxzoom:b.maxzoom,name:b.name}))},error:function(b){clearTimeout(n),a.error(i._errorToMsg(b))}})}else a.error(this._errorToMsg())},_newTileLayer:function(a){return _.isArray(a)&&_.size(a)>0&&(a=_.first(a)),new cdb.admin.TileLayer({urlTemplate:a.tiles[0],attribution:a.attribution||null,maxZoom:a.maxzoom||21,minZoom:a.minzoom||0,name:a.name||""})},_errorToMsg:function(a){return"object"!=typeof a&&a?a:a&&a.status&&401===a.status?"Error retrieving your basemap. Please, check your access token.":"This URL is not valid."},_lowerXYZ:function(a){return a.replace(/\{S\}/g,"{s}").replace(/\{X\}/g,"{x}").replace(/\{Y\}/g,"{y}").replace(/\{Z\}/g,"{z}")},_getMapBoxMapID:function(a){var b=/https?:\/\/[a-z]?\.?tiles\.mapbox.com\/v(\d)\/([^\/.]*)\.([^\/.]*)/,c=/https?:\/\/tiles\.mapbox\.com\/(.*?)\/edit\/(.*?)(\?|#)/,d="";return d=a.match(b),d&&d[1]&&d[2]?d[2]+"."+d[3]:(d=a.match(c),d&&d[1]&&d[2]?d[1]+"."+d[2]:void 0)},_fixHTTPS:function(a,b){if(b=b||location,0!==a.indexOf("https")&&"https:"===b.protocol){var c=a.indexOf("mapbox.com");return-1!==c?this._MAPBOX.https+a.substr(c+"mapbox.com".length):a.replace(/http/,"https")}return a}}),cdb.admin.Metrics=cdb.core.Model.extend({initialize:function(a){this.bindEvents()},bindEvents:function(){cdb.god.bind("metrics",this._setTrack,this)},_setTrack:function(a,b){if(window.hubspot_token){window._hsq=window._hsq||[],window._hsq.push(["identify",{email:b.email}]);var c;switch(a){case"published_visualization":c=window.hubspot_ids.published_visualization;break;case"visited_dashboard":c=window.hubspot_ids.visited_dashboard;break;case"connect_dataset":c=window.hubspot_ids.connect_dataset;break;case"create_map":c=window.hubspot_ids.create_map;break;case"export_table":c=window.hubspot_ids.export_table;break;case"select_wms":c=window.hubspot_ids.select_wms;break;case"color_basemap":c=window.hubspot_ids.color_basemap;break;case"pattern_basemap":c=window.hubspot_ids.pattern_basemap;break;case"geocoding":c=window.hubspot_ids.geocoding;break;case"visual_merge":c=window.hubspot_ids.visual_merge;break;case"common_data":c=window.hubspot_ids.common_data;break;case"cartocss_manually":c=window.hubspot_ids.cartocss_manually;break;case"wizard":c=window.hubspot_ids.wizard;break;case"filter":c=window.hubspot_ids.filter;break;case"query":c=window.hubspot_ids.query;break;case"logged_in":c=window.hubspot_ids.logged_in;break;case"visited_dashboard_first_time":c=window.hubspot_ids.visited_dashboard_first_time}window._hsq.push(["trackEvent",{id:c,value:b.data}])}}}),cdb.admin.Mixpanel=cdb.core.Model.extend({initialize:function(a){""!==a.token&&(this._setMixpanel(a.token),this._setUser(a.user),this.bindEvents())},_setMixpanel:function(a){mixpanel.init(a)},_setUser:function(a){mixpanel.identify(a.username),mixpanel.name_tag(a.username),mixpanel.people.set({$email:a.email,$username:a.username,account_type:a.account_type,table_count:a.table_count,last_visualization_created_at:a.last_visualization_created_at,visualization_count:a.visualization_count,failed_import_count:a.failed_import_count,success_import_count:a.success_import_count,quota_space:a.db_size_in_megabytes}),a.organization&&mixpanel.people.set({enterprise_org:a.organization.name})},bindEvents:function(){cdb.god.bind("mixpanel",this._setTrack,this),cdb.god.bind("mixpanel_people",this._peopleSet,this)},_setTrack:function(a,b){mixpanel.track(a,b)},_peopleSet:function(a){mixpanel.people.set(a)}}),cdb.admin.VisPrivacySelector=cdb.core.View.extend({_TYPES:[{type:"PUBLIC",title:_t("Public"),description:_t("All people can view it."),error:_t(""),limitation:!1},{type:"LINK",title:_t("Only people with the link"),description:_t("Only visible to people with the link."),error:_t("Enabled for paid accounts."),limitation:"private"},{type:"PASSWORD",title:_t("Password protected"),description:_t("Only people with password can view this."),error:_t("Only for visualizations and paid accounts."),limitation:"private_maps"},{type:"PRIVATE",title:_t("Private"),description:_t("This is only accessible by yourself."),error:_t("Enabled for paid accounts."),limitation:"private"}],initialize:function(){this.collection=new Backbone.Collection(this._TYPES),this.user=this.options.user,this._initViews(),this._initBinds()},render:function(){return this.selected.render(),this.list.hide(),this},_initViews:function(){this.selected=new cdb.admin.VisPrivacySelectorCurrent({model:this.model,user:this.user,collection:this.collection}),this.$el.append(this.selected.render().el),this.selected.bind("showList",this.showList,this),this.addView(this.selected),this.list=new cdb.admin.VisPrivacySelectorList({model:this.model,user:this.user,source:this.options.source,upgrade_url:this.options.upgrade_url,collection:this.collection}),this.list.bind("onSelect",this.hideList,this),this.$el.append(this.list.render().el),this.addView(this.list)},_initBinds:function(){this.model.bind("change:privacy",this.render,this)},_destroyBinds:function(){},showList:function(){this.list.render().show()},hideList:function(){this.list.hide()}}),cdb.admin.VisPrivacySelectorList=cdb.core.View.extend({tagName:"ul",className:"privacy-list",initialize:function(){_.bindAll(this,"_addPrivacyItem"),this.user=this.options.user},render:function(){return this.clearSubViews(),this.collection.each(this._addPrivacyItem),this},_addPrivacyItem:function(a){var b=!0;if(a.get("limitation")&&("private"!==a.get("limitation")||this.user.get("actions").private_tables||(b=!1),"private_maps"!==a.get("limitation")||this.user.get("actions").private_maps&&this.model.get("isVisualization")||(b=!1)),"private_maps"!==a.get("limitation")||this.model.get("isVisualization")){var c=new cdb.admin.VisPrivacySelectorItem({model:a,is_visualization:this.model.get("isVisualization"),upgrade_url:this.options.upgrade_url,enabled:b,source:this.options.source,selected:this.model.get("privacy").toLowerCase()===a.get("type").toLowerCase()});c.bind("privacyChanged",this._onChangePrivacy,this),this.$el.append(c.render().el),this.addView(c)}},_onChangePrivacy:function(a){this.trigger("onSelect",this),this.model.set("privacy",a)}}),cdb.admin.VisPrivacySelectorItem=cdb.core.View.extend({tagName:"li",className:"privacy-item",events:{"click a.upgrade":"_onUpgradeClick",click:"_onClick"},initialize:function(){_.bindAll(this,"_onClick","_onUpgradeClick"),this.template=cdb.templates.getTemplate("old_common/views/privacy_dialog/vis_privacy_selector_item")},render:function(){var a={type:this.model.get("type"),selected:this.options.selected,enabled:this.options.enabled,title:this.model.get("title"),description:this.model.get("description"),error:this.model.get("error"),organization:this.model.get("organization")};return this.$el.html(this.template(a)),this},_onUpgradeClick:function(a){this.killEvent(a);var b=(this.model.get("isVisualization"),this.options.is_visualization?"Visualization":"Table"),c="Trying_Marking_"+b+"_Private",d=this.options.source||b,e="Upgrade_from_"+(d.charAt(0).toUpperCase()+d.slice(1)),f=this.model.get("type"),g=this.options.upgrade_url+"?utm_source="+c+"&utm_medium=referral&utm_campaign="+e+"&utm_content="+f;window.location=g},_onClick:function(a){this.killEvent(a),this.options.enabled&&this.trigger("privacyChanged",this.model.get("type"),this)}}),cdb.admin.VisPrivacySelectorCurrent=cdb.admin.VisPrivacySelectorItem.extend({tagName:"div",className:"privacy-item current-privacy-item",render:function(){var a=this.collection.where({type:this.model.get("privacy")});0===a.length&&cdb.log.info("No privacy type associated with "+this.model.get("privacy"));var b={type:a[0].get("type"),selected:!1,enabled:!0,title:a[0].get("title"),description:a[0].get("description"),error:a[0].get("error"),organization:a[0].get("organization")};return this.$el.html(this.template(b)),this},_onClick:function(a){this.killEvent(a),this.trigger("showList",this)}}),cdb.admin.PrivacyDialog=cdb.admin.BaseDialog.extend({_DEFAULT_PASSWORD:"FAKE123456",_TEXTS:{title:{vis:_t("Map privacy settings"),table:_t("Dataset privacy settings")},privacy_change:{table:_t("If you change the privacy of this dataset, you will be deleting or changing the maps of the                           following users within your organization:"),visualization:_t("If you change the privacy of this map you will be revoking access to it to the                           following users within your organization:")},ok_title:_t("Save settings")},events:{"click .settings-ok.ok":"_checkPrivacy","click .warning-ok.ok":"_savePrivacy","click .cancel":"_cancel","click .close":"_cancel",click:"_hideList"},initialize:function(){_.bindAll(this,"ok"),this.options.user&&this.model||cdb.log.info("A user and a visualization model are required"),this.user=this.options.user,this.upgrade_url=window.location.protocol+"//"+this.options.config.account_host+"/account/"+this.user.get("username")+"/upgrade",this._genModelClones(),this.options=_.extend({title:this.model.isVisualization()?this._TEXTS.title.vis:this._TEXTS.title.table,template_name:"old_common/views/privacy_dialog/privacy_dialog",clean_on_hide:!0,enter_to_confirm:!1,ok_button_classes:"button grey",ok_title:this._TEXTS.ok_title,width:490,modal_class:"vis_privacy_dialog"},this.options),this.elder("initialize"),this._bindModels()},render_content:function(){this.vis_privacy_selector=new cdb.admin.VisPrivacySelector({model:this.vis_model,user:this.user,upgrade_url:this.upgrade_url,source:this.options.source}),this.$(".vis_privacy_selector").append(this.vis_privacy_selector.render().el),this.user.organization&&(this.org_list=new cdb.admin.UserOrgList({model:this.vis_model,permission:this.vis_perm,user:this.user,writePermissionEnabled:!this.model.isVisualization()}),this.$(".org_users_list").append(this.org_list.render().el)),this.user.get("actions")&&this.user.get("actions").private_tables&&(this.privacy_password=new cdb.admin.PrivacyPassword({vis:this.vis_model,attribute:"password",default_value:this._DEFAULT_PASSWORD}),this.$(".modal:eq(0) .foot").append(this.privacy_password.render().el));var a=this.model,b="permission";this.model.isVisualization()||(a=this.table_data=new cdb.admin.CartoDBTableMetadata({id:this.model.get("table").id,no_data_fetch:!0}),a.fetch(),b="visualizations"),this.warning_list=new cdb.ui.common.UserListWarning({list:[],msg:this._TEXTS.privacy_change["permission"===b?"visualization":"table"]}),this.$(".warning_users_list").append(this.warning_list.render().el),this.addView(this.warning_list),this._checkState()},_checkState:function(){var a=this.vis_model.get("privacy").toLowerCase();return this._checkButton(),"public"===a?(this.org_list&&this.org_list.show(),this.privacy_password&&this.privacy_password.hide(),!1):"link"===a?(this.org_list&&this.org_list.show(),this.privacy_password&&this.privacy_password.hide(),!1):"password"===a?(this.org_list&&this.org_list.show(),this.privacy_password&&this.privacy_password.show(),!1):"organization"===a?(this.org_list&&this.org_list.show(),this.privacy_password&&this.privacy_password.hide(),!1):"private"===a?(this.org_list&&this.org_list.show(),this.privacy_password&&this.privacy_password.hide(),!1):void cdb.log.info("An undefined privacy status was selected - "+this.vis_model.get("privacy"))},_checkButton:function(){var a=this.vis_model.get("privacy").toLowerCase(),b=this.$(".settings-ok");if("password"===a){var c=this.vis_model.get("password");b[c?"removeClass":"addClass"]("disabled")}else b.removeClass("disabled")},_hideList:function(a){this.killEvent(a),this.vis_privacy_selector&&this.vis_privacy_selector.hideList()},_genModelClones:function(){var a=this.model.get("privacy");this.vis_model=new cdb.core.Model({privacy:this.model.get("privacy"),isVisualization:this.model.isVisualization(),related_tables:this.model.related_tables}),"password"===a.toLowerCase()&&this.vis_model.set("password",this._DEFAULT_PASSWORD);var b=_.clone(this.model.permission.attributes);delete b.id,this.vis_perm=new cdb.admin.Permission(b)},_bindModels:function(){this.vis_model.bind("change:password",this._checkButton,this),this.vis_model.bind("change:privacy",this._checkState,this),this.vis_model.bind("change:privacy",this._resetModels,this),this.add_related_model(this.vis_model)},_saveModels:function(){var a=this,b=this.vis_model.get("privacy").toLowerCase();this.vis_model.unset("isVisualization"),"password"===b&&this.vis_model.get("password")===this._DEFAULT_PASSWORD&&this.vis_model.unset("password"),this.model.save(this.vis_model.attributes,{wait:!0,success:function(){a.options.user.isInsideOrg()&&(a.model.permission.acl.reset(a.vis_perm.acl.models),a.model.permission.save())}})},_getUsersAffected:function(){var a=this.vis_perm.getUsersWithAnyPermission();return this.vis_perm.getUsersWithPermission("org").length>0?[]:this.model.isVisualization()?[]:this.model.isVisualization()?[]:this._getRelatedUserVisualizations(a)},_getRelatedUserVisualizations:function(a){if(this.model.isVisualization())return[];var b=_.pluck(a,"id"),c=this,d=_.union(this.table_data.get("dependent_visualizations"),this.table_data.get("non_dependent_visualizations"));return _.compact(d.map(function(a){return c.user.get("id")===a.permission.owner.id||_.contains(b,a.permission.owner.id)?void 0:{id:a.permission.owner.id,type:"user",username:a.permission.owner.username,avatar_url:a.permission.owner.avatar_url,visualizations:[a.name]}}))},_resetModels:function(){var a=this.vis_model.get("privacy").toLowerCase();"password"!==a&&this.vis_model.unset("password")},_showWarning:function(){this.$("section.modal:eq(0)").animate({top:0,opacity:0},300),this.$(".modal.warning").css({marginTop:0,display:"block",opacity:0}).animate({top:"0",marginTop:-(this.$(".modal.warning").outerHeight()/2)>>1,opacity:1},300)},_checkPrivacy:function(a){this.killEvent(a);var b=this.vis_model.get("privacy").toLowerCase();if("password"===b&&!this.vis_model.get("password"))return!1;var c=this._getUsersAffected();c.length>0&&this.user.isInsideOrg()?(this.warning_list.changeList(c),this._showWarning()):this._savePrivacy()},cancel:function(a){a&&this.killEvent(a),this._resetModels()},_savePrivacy:function(a){this.killEvent(a),this._saveModels(),this.hide()},_ok:function(){},ok:function(){}}),cdb.admin.PrivacyPassword=cdb.core.View.extend({_DEFAULT_VALUE:"FAKE123456",className:"privacy-password",tagName:"div",events:{"focusin input.password":"_onInputFocusIn","focusout input.password":"_onInputFocusOut","keyup input.password":"_onInputChange","click input.submit":"_onFormSubmit","submit form":"_onFormSubmit"},initialize:function(){_.bindAll(this,"_onFormSubmit","_onInputFocusIn","_onInputFocusOut","_onInputChange"),this.options.default_value&&(this._DEFAULT_VALUE=this.options.default_value),this.template=cdb.templates.getTemplate("old_common/views/privacy_dialog/privacy_password"),this.model=new cdb.core.Model({statue:"idle"}),this.vis=this.options.vis,this.model_attribute=this.options.attribute},render:function(){var a="";return this.vis.get(this.model_attribute)&&(a=this._DEFAULT_VALUE),this.$el.html(this.template({value:a})),this},_onInputFocusIn:function(){this.$("form").addClass("focus")},_onInputChange:function(){var a=this.$("form input.password").val();this.$("form input.submit")[a===this._DEFAULT_VALUE||a===this.vis.get(this.model_attribute)?"addClass":"removeClass"]("disabled")},_onInputFocusOut:function(){this.$("form").removeClass("focus")},_onFormSubmit:function(a){this.killEvent(a);var b=this.$("form input.password").val();this.$("form input.submit").addClass("disabled"),this.vis.set(this.model_attribute,b)}}),cdb.admin.UserOrgList=cdb.core.View.extend({tagName:"div",className:"org_users_wrapper",initialize:function(){if(this.permission=this.options.permission,this.organization=this.options.user.organization,this.user=this.options.user,!this.permission||!this.organization)throw new Error("permission and organization are mandatory");this._initBinds(),this._userViews={}},render:function(){return this.clearSubViews(),this._destroyScroll(),this.$el.empty(),this.$el.append($("<ul>")),this._renderOrganization(),this.organization.users.each(this._renderUser.bind(this)),this.organization.users.size()>3&&this._renderScroll(),this},_destroyScroll:function(){var a=this.$el.hasClass("scrollpane");a&&null!==this.$el.data()&&(this.$("ul").data().jsp&&this.$("ul").data().jsp.destroy(),this.$el.removeClass("scrollpane"),this.$("ul").removeClass("scrollpane"))},_renderScroll:function(){var a=this;a.$el.addClass("scrollpane"),setTimeout(function(){a.$("ul").addClass("scrollpane").jScrollPane({verticalDragMinHeight:20});var b=new cdb.common.ScrollPaneGradient({list:a.$(".scrollpane")});a.$el.append(b.render().el),a.addView(b)},0)},_renderUser:function(a){var b=new cdb.admin.UserListItem({model:a,permission:this.permission,vis:this.model,hasPermissions:!0,writePermissionEnabled:this.options.writePermissionEnabled});this._userViews[a.cid]=b,this.addView(b),this.$("ul").append(b.render().el)},_renderOrganization:function(){var a=new cdb.admin.OrgListItem({model:this.organization,permission:this.permission,vis:this.model,template:"old_common/views/privacy_dialog/user_list_all",hasPermissions:!0,writePermissionEnabled:this.options.writePermissionEnabled});this.addView(a),this.$("ul").append(a.render().el)},_initBinds:function(){this.model.bind("change:privacy",this.render,this),this.organization.users.bind("add",function(a,b){this._renderUser(a)},this),this.add_related_model(this.permission),this.add_related_model(this.organization),this.add_related_model(this.organization.users)}}),cdb.admin.UserListItem=cdb.core.View.extend({tagName:"li",events:{"click .switch":"toggleReadOnly","click .canwrite":"toggleWrite"},initialize:function(){this.vis=this.options.vis,this.permission=this.options.permission,this.template=cdb.templates.getTemplate(this.options.template||"old_common/views/privacy_dialog/user_list_item_view"),void 0!==this.options.writePermissionEnabled?this.writePermissionEnabled=this.options.writePermissionEnabled:this.writePermissionEnabled=!0,this._initBinds()},render:function(){this._destroyTooltip();var a=this.model.attributes;return this.$el.html(this.template({avatar_url:a.avatar_url,username:a.username,hasPermissions:this.options.hasPermissions,writePermissionEnabled:this.writePermissionEnabled})),this._switchFields(),this.options.hasPermissions||this._createTooltip(),this},_createTooltip:function(){this.$("div.info[original-title]").length>0&&this.$("div.info[original-title]").tipsy({fade:!0,gravity:"s",title:function(){return $(this).attr("original-title")}})},_destroyTooltip:function(){this.$("div.info[data-tipsy]").length>0&&this.$("div.info").unbind("mouseenter mouseleave").tipsy("remove")},_initBinds:function(){this.permission.acl.bind("add remove reset change",this._switchFields,this),this.add_related_model(this.permission)},toggleReadOnly:function(a){this.killEvent(a);var b=this.permission.getPermission(this.model);"rw"===b||"r"===b?this.permission.removePermission(this.model):this.permission.setPermission(this.model,"r")},toggleWrite:function(a){this.killEvent(a);var b=this.permission.getPermission(this.model),c="organization"===this.vis.get("privacy").toLowerCase();b?this.permission.setPermission(this.model,"rw"!==b?"rw":"r"):c||this.permission.setPermission(this.model,"rw")},_switchFields:function(){var a=this.$(".switch"),b=this.$(".canwrite"),c=this.$(".info"),d=this.permission.getPermission(this.model),e="organization"===this.vis.get("privacy").toLowerCase();b.removeClass("disabled enabled"),a.removeClass("disabled enabled"),d&&"n"!==d?(a.addClass("enabled"),b.addClass("rw"===d?"enabled":""),this.options.hasPermissions&&c.removeClass("disabled")):(b.addClass(e?"disabled":""),a.addClass("disabled"),c[!e&&this.options.hasPermissions?"removeClass":"addClass"]("disabled"))},clean:function(){this._destroyTooltip(),cdb.core.View.prototype.clean.call(this)}}),cdb.admin.OrgListItem=cdb.admin.UserListItem.extend({toggleReadOnly:function(a){this.killEvent(a);var b=this.permission.getPermission(this.model);"r"===b||"rw"===b?this.permission.removePermission(this.model):this.permission.setPermission(this.model,"r")},toggleWrite:function(a){var b=this;this.killEvent(a);var c=this.permission.getPermission(this.model);this.model.users.size(),this.model.users.find(function(a){"rw"===b.permission.getPermission(a)});"rw"===c?this.permission.setPermission(this.model,"r"):this.permission.setPermission(this.model,"rw")}}),cdb.common.ScrollPaneGradient=cdb.core.View.extend({initialize:function(){this.options.list||cdb.log.info("No Scrollpane list defined! -> options.list"),this.$scrollpane=this.options.list,this._initBinds()},render:function(){return this.$el.append('<span class="top scroll"></span><span class="bottom scroll"></span>'),this},_initBinds:function(){_.bindAll(this,"checkScroll"),this.$scrollpane.bind("jsp-scroll-y",this.checkScroll),this.$scrollpane.bind("jsp-scroll-x",this.checkScroll)},_destroyBinds:function(){this.$scrollpane.unbind("jsp-scroll-y",this.checkScroll),this.$scrollpane.unbind("jsp-scroll-x",this.checkScroll)},checkScroll:function(a,b,c,d){var e=this.$("span.top"),f=this.$("span.bottom");c?e.hide():e.show(),d?f.hide():f.show()},clean:function(){this._destroyBinds(),cdb.core.View.prototype.clean.call(this)}}),cdb.admin.SharePrivateTablesDialog=cdb.admin.BaseDialog.extend({_TEXTS:{title:_t("Cannot make this visualization public"),ok_close:_t("Ok, close"),ok_next:_t("Share now!")},initialize:function(){this.options=_.extend({title:this._TEXTS.title,template_name:"old_common/views/dialog_base",clean_on_hide:!0,enter_to_confirm:!0,ok_button_classes:"button grey",ok_title:this._TEXTS.ok_close,cancel_button_classes:"hide",modal_type:"confirmation",width:510,modal_class:"share_private_tables_dialog"},this.options),this.active=!this._anyPrivateTable(),this.elder("initialize")},render_content:function(){var a=$("<div>").append(this.getTemplate("old_common/views/share_private_tables_dialog")(this.model.toJSON())),b=this;return this.model.related_tables&&this.model.related_tables.each(function(c){if(c.get("privacy")&&"private"==c.get("privacy").toLowerCase()){var d=new cdb.admin.PrivateTable({model:c});a.find("ul").append(d.render().el),d.bind("changed",b._checkTables,b),d.bind("error",b._showError,b),d.bind("loading",b._hideError,b),b.addView(d)}}),a},_anyPrivateTable:function(){return this.model.related_tables?this.model.related_tables.filter(function(a){return"private"==a.get("privacy").toLowerCase()}).length>0:!1},_checkTables:function(){if(!this._anyPrivateTable()){this.active=!0;var a=this.options.ok_next||this._TEXTS.ok_next;this.trigger("allTablesPublic"),this.$("a.ok").text(a).attr("href","#/"+a.replace(/ /g,"-").toLowerCase())}},_showError:function(){this.$("p.error").show()},_hideError:function(){this.$("p.error").hide()},_ok:function(a){a&&a.preventDefault(),this.active&&this.ok&&this.ok(),this.hide()}}),cdb.admin.PrivateTable=cdb.core.View.extend({_TEXTS:{privacy:{"public":_t("public")}},tagName:"li",events:{"click .make_public":"_makePublic"},initialize:function(){_.bindAll(this,"_makePublic"),this.template=cdb.templates.getTemplate("old_common/views/share_private_table_view"),this.loading=!1,this._initBinds()},_initBinds:function(){this.model.bind("change:privacy",this._changePrivacy,this)},render:function(){return this.$el.append(this.template(this.model.toJSON())),this},_changePrivacy:function(){this._hideLoader(),this.$("a.make_public").fadeOut(),this.$("span.status").removeClass("private").addClass("public").text(this._TEXTS.privacy["public"].toUpperCase())},_makePublic:function(a){if(a.preventDefault(),!this.loading){var b=this;b.loading=!0,this.trigger("loading"),this._showLoader(),this.model.save({privacy:"PUBLIC"},{silent:!0,wait:!0,success:function(a){b.trigger("changed"),b.loading=!1,b._changePrivacy()},error:function(){b.loading=!1,b._hideLoader(),b.trigger("error")}})}},_showLoader:function(){this.$("a.button").addClass("disabled"),this.$("span.loader").show()},_hideLoader:function(){this.$("a.button").removeClass("disabled"),this.$("span.loader").hide()}}),cdb.admin.SmallDialog=cdb.ui.common.Dialog.extend({className:"floating",initialize:function(){_.extend(this.options,{title:"",description:"",clean_on_hide:!0}),cdb.ui.common.Dialog.prototype.initialize.apply(this),this.render(),$(document.body).append(this.el)},showAt:function(a,b,c,d){this.$el.css({top:b,left:a,
minWidth:c}),d&&this.$el.find("> textarea, > input").css({minWidth:c-22}),this.show()},showAtElement:function(a){var b=$(a).offset();this.showAt(b.left,b.top)}}),cdb.admin.EditTextDialog=cdb.admin.SmallDialog.extend({events:cdb.core.View.extendEvents({"keypress input":"_keyPress",click:"_stopPropagation"}),initialize:function(){_.defaults(this.options,{template_name:"old_common/views/dialog_small_edit",ok_title:"Save",modal_class:"edit_text_dialog",clean_on_hide:!0}),this.constructor.__super__.initialize.apply(this)},render_content:function(){this._focusInput();var a='<input value="'+this.options.initial_value.replace(/\"/g,"&quot;").replace(/\'/g,"&#39;")+'" ';return this.options.maxLength&&(a+="maxLength = "+this.options.maxLength),a+=' type="text"/>'},_stopPropagation:function(a){a.stopPropagation()},_focusInput:function(){var a=this;setTimeout(function(){var b=a.$el.outerWidth()-a.$el.find("a.button").outerWidth()-35;a.$el.find("input").width(b).focus()},0)},_keyPress:function(a){13===a.keyCode&&this._ok()},ok:function(){this.options.onResponse&&this.options.onResponse(this.$("input").val())}}),cdb.admin.EditMarkdownDialog=cdb.admin.SmallDialog.extend({events:cdb.core.View.extendEvents({"keypress input":"_keyPress",click:"_stopPropagation"}),initialize:function(){_.defaults(this.options,{old_template_name:"old_common/views/dialog_markdown_edit",ok_title:"Save",modal_class:"edit_name_dialog markdown",clean_on_hide:!0}),this.constructor.__super__.initialize.apply(this)},render_content:function(){this._focusInput();var a='<div class="input_field"><input value="'+this.options.initial_value.replace(/\"/g,"&quot;").replace(/\'/g,"&#39;")+'" ';return this.options.maxLength&&(a+="maxLength = "+this.options.maxLength),a+=' type="text"/><div class="hint"><strong>**bold**</strong> <em>*italics*</em> [link title](url)</div></div>'},_stopPropagation:function(a){a.stopPropagation()},_focusInput:function(){var a=this;setTimeout(function(){var b=a.$el.outerWidth()-a.$el.find("a.button").outerWidth()-35;a.$el.find(".input_field").width(b),a.$el.find(".input_field input").focus()},0)},_keyPress:function(a){13===a.keyCode&&this._ok()},ok:function(){this.options.onResponse&&this.options.onResponse(this.$("input").val())}}),cdb.admin.ColumnSelectorModel=cdb.core.Model.extend({defaults:{selected:!1,showRadio:!0,showSwitch:!0,visible:!0,enabled:!0,columnType:""}}),cdb.admin.ColumnSelector=cdb.core.View.extend({tagName:"li",events:{"click a.radiobutton":"_onRadioClick","click a.switch":"_onSwitchClick"},initialize:function(){_.bindAll(this,"_onSwitchSelected"),this.model.bind("change:joinType",this._onJoinTypeChange,this),this.model.bind("change:selected",this._onRadioSelected,this),this.model.bind("change:switchSelected",this._onSwitchSelected,this),this.model.bind("change:enableRadio",this._onToggleRadio,this),this.model.bind("change:enabled",this._onToggle,this),this.model.bind("change:visible",this._onToggleVisiblity,this),this.model.bind("change:showRadio",this._onToggleRadioVisiblity,this),this.model.bind("change:showSwitch",this._onToggleSwitchVisiblity,this),this._setKeyColumnEnabled()},_onToggle:function(){this.model.get("enabled")?this.$el.find(".radiobutton").removeClass("disabled"):this.$el.find(".radiobutton").addClass("disabled")},_onToggleRadio:function(){this.model.get("enableRadio")?this.$el.find(".radiobutton").removeClass("disabled"):this.$el.find(".radiobutton").addClass("disabled")},_onToggleVisiblity:function(){this.model.get("visible")?this.$el.slideDown(250):this.$el.slideUp(250)},_onToggleRadioVisiblity:function(){this.model.get("showRadio")?this.$el.find(".radiobutton .radio").animate({opacity:1},{duration:150,complete:function(){$(this).parent().removeClass("hidden_radio")}}):this.$el.find(".radiobutton .radio").animate({opacity:0},{duration:150,complete:function(){$(this).parent().addClass("hidden_radio")}})},_onToggleSwitchVisiblity:function(){this.model.get("showSwitch")?this.$el.find(".switch").fadeIn(250,function(){$(this).removeClass("hidden")}):this.$el.find(".switch").fadeOut(250,function(){$(this).addClass("hidden")})},render:function(){this.$el.html("");var a=$(cdb.templates.getTemplate("old_common/views/column_selector")(this.model.toJSON()));return this.$el.append(a),this},_onJoinTypeChange:function(a){this.model.set({selected:!1},{silent:!0}),this._setKeyColumnEnabled(),this.render()},_setKeyColumnEnabled:function(){var a=!0,b=!0,c=!1,d=this.model.get("name"),e=this.model.get("joinType"),f=this.model.get("source");"regular"==e&&"the_geom"!=d&&(c=!0),"spatial"==e&&("the_geom"!=d&&(c=!0),"origin"==f&&(a=!1),"destiny"==f&&(b=!1)),this.model.set({enabled:c,showSwitch:b,showRadio:a})},_unselectKey:function(){this.model.get("selected")&&(this.model.set({selected:!1},{silent:!0}),this.$el.find("a.radiobutton").removeClass("selected"))},_onRadioClick:function(a){return this.killEvent(a),this.model.get("enabled")&&this.model.get("showRadio")?(this.model.set("selected",!0),void this.trigger("keyColumn",this.model.get("name"),!0)):!1},_onRadioSelected:function(){var a=this.model.get("selected"),b=this.$el.find("a.radiobutton");a&&(b.addClass("selected"),this.trigger("keyColumn",this.model.get("name"),!0))},setSilent:function(a){this.model.set({switchSelected:a},{silent:!0}),this.$el.find("a.switch").removeClass(a?"disabled":"enabled").addClass(a?"enabled":"disabled"),this.trigger("addColumn",this.model.get("name"),a)},_onSwitchSelected:function(){var a=this.model.get("switchSelected");this.$el.find("a.switch").removeClass(a?"disabled":"enabled").addClass(a?"enabled":"disabled"),this.trigger("mergeColumns",this.model.get("name"),a)},_onSwitchClick:function(a){this.killEvent(a),this.model.set("switchSelected",!this.model.get("switchSelected"))}}),cdb.admin.TableColumnSelector=cdb.core.View.extend({className:"table_column_selector",events:{"change div.select.tables":"_selectTable","click div.merge_all a":"_toggleMergeAllColumns","click div.merge_methods li a":"onClickMergeMethod"},initialize:function(){_.bindAll(this,"_setTables","_selectTable","_setColumns","_setKeyColumn","_setMergeColumns","_setSilentMergeColumns","_toggleMergeAllColumns","onClickMergeMethod","_setupSpatialColumns"),this.template=cdb.templates.getTemplate("old_common/views/table_column_selector"),this.subColumns=[],this.keyColumn=null,this.mergeColumns=[],this.schema=[],this.table_name=this.model&&this.model.get("name")||null},render:function(){var a=_.clone(this.model?this.model.toJSON():{});return a.choose_table_text=this.options.choose_table_text,a.source=this.options.source,this.$el.append(this.template(a)),this.model&&this._setColumns({schema:this.model.get("schema")}),this._initWidgets(),this.model||this._getTables(),this},_addColumns:function(a){var b=this;this._cleanColumns(),this.schema=_.compact(_.map(a,function(a,c){return _.contains(b.options.filteredColumns,a[0])?void 0:{name:a[0],columnType:a[1]}})),_.each(this.schema,function(a,c){b._addColumn(a.name,a.columnType)})},_addColumn:function(a,b){var c=!0,d=!0;"count"==this.mergeMethod&&"destiny"==this.options.source&&"spatial"==this.options.joinType&&(c=!1),"count"!=this.mergeMethod&&"destiny"==this.options.source&&"spatial"==this.options.joinType&&"number"!=b&&(d=!1),"spatial"==this.options.joinType&&"origin"==this.options.source&&(c=!1);var e="the_geom"==a&&"destiny"==this.options.source?!1:!0,f=new cdb.admin.ColumnSelectorModel({selected:!1,switchSelected:e,name:a,columnType:b,joinType:this.options.joinType,enabled:d,showRadio:c,source:this.options.source}),g=new cdb.admin.ColumnSelector({model:f}).bind("keyColumn",this._setKeyColumn).bind("mergeColumns",this._setMergeColumns).bind("addColumn",this._setSilentMergeColumns);this.$el.find(".columns > ul").append(g.render().el),this.addView(g),this.subColumns.push(g),"the_geom"==a&&"destiny"==this.options.source||this.mergeColumns.push(a)},_cleanColumns:function(){_.each(this.subColumns,function(a,b){a.unbind("keyColumn mergeColumns").clean()}),this.subColumns=[],this.mergeColumns=[]},_initWidgets:function(){var a="";this.model&&(a=this.model.get("name"));var b=this.tables=new cdb.forms.Combo({el:this.$el.find("div.select.tables"),model:this.model,property:"name",width:"227px",disabled:!0,placeholder:a});this.$el.find("div.select.tables").append(b.render()),this.addView(this.tables)},_getTables:function(){var a=new cdb.admin.Visualizations;a.options.set({type:"table",per_page:1e5,table_data:!1});var b={data:{o:{updated_at:"desc"},exclude_raster:!0}};a.bind("reset",this._setTables,this),a.fetch(b)},_setTables:function(a){var b=this.$el.find("select"),c=this,d=a.filter(function(a){return!_.contains(c.options.filteredTables,a.get("name"))}),e="<option></option>";_.each(d,function(a){var b=a.get("table");b&&(e+='<option value="'+b.id+'">'+a.get("name")+"</option>")}),b.select2("destroy"),b.html(""),b.append(e),b.removeAttr("disabled"),b.select2({placeholder:"Select one of your datasets",minimumResultsForSearch:20})},_selectOption:function(a){this.keyColumn=null,this.table_name=this.$el.find("option[value='"+a+"']").text(),this._getColumns(a),this.$el.find("div.table").addClass("chosen"),this._hideMergeAll()},_selectTable:function(a){a&&this._selectOption($(a.target).select2("val")),this.tableSelected=!0,this.trigger("tableSelected",this),this.setMergeMethod(this.mergeMethod)},_getColumns:function(a){this.options.url&&a&&$.ajax({url:this.options.url+a,dataType:"jsonp",success:this._setColumns})},_setColumns:function(a){this._addColumns(a.schema),this._selectKeyByDefault(),this._updateFooter(),this._setupTheGeom()},_showTheGeom:function(){var a=this._getTheGeom();a&&(a.model.set({visible:!0}),a.$el.show())},_hideTheGeom:function(){var a=this._getTheGeom();a&&(a.model.set({visible:!1}),a.$el.hide())},_setupTheGeom:function(){"regular"==this.options.joinType?this._showTheGeom():"spatial"==this.options.joinType&&this._hideTheGeom()},_setupRegularMerge:function(){this._setupTheGeom()},_setupSpatialMerge:function(){this._setupTheGeom(),this._hideCountCover(),"spatial"==this.options.joinType&&(this.tableSelected&&this.setMergeMethod(),this._toggleNextButton())},_selectRegularKey:function(){var a=(this._getTheGeom(),this._getKeyColumn());a&&(a.model.set({selected:!0}),this.keyColumn=a.model.get("name"))},_selectSpatialKey:function(){this._getTheGeom();if("destiny"==this.options.source){var a=this._getKeyColumn();a&&(a.model.set({selected:!0}),this.keyColumn=a.model.get("name"))}},_selectKeyByDefault:function(){this.subColumns.length>0&&("regular"==this.options.joinType?this._selectRegularKey():"spatial"==this.options.joinType&&this._selectSpatialKey(),this.trigger("keyColumnChanged",this))},_getNumber:function(){return _.find(this.subColumns,function(a){return"number"==a.model.get("columnType")})},_getTheGeom:function(){return _.find(this.subColumns,function(a){return"the_geom"==a.model.get("name")})},_getKeyColumn:function(){return _.find(this.subColumns,function(a){return a.model.get("enabled")&&"the_geom"!=a.model.get("name")})},_setKeyColumn:function(a,b){this.keyColumn=a,_.each(this.subColumns,function(b){b.model.get("name")!=a&&b._unselectKey()}),this.trigger("keyColumnChanged",this)},_setSilentMergeColumns:function(a,b){b?this.mergeColumns.push(a):this.mergeColumns=_.without(this.mergeColumns,a),this.mergeColumns=_.uniq(this.mergeColumns),this._checkAllSelector()},_setMergeColumns:function(a,b){b?this.mergeColumns.push(a):this.mergeColumns=_.without(this.mergeColumns,a),this._checkAllSelector(),this.trigger("columnChanged",{source:this.options.source,name:a,value:b},this)},setJoinType:function(a){this.options.joinType=a,"regular"==a&&(this.mergeMethod=null),this.keyColumn=null;var b=this;_.each(this.subColumns,function(c){c.model.set({switchSelected:"the_geom"==c.model.attributes.name&&"destiny"==b.options.source?!1:!0,joinType:a})}),this._selectKeyByDefault(),this._updateFooter()},_updateFooter:function(){this.table_name&&(this._hideMergeMethods(),this._hideMergeAll(),"regular"==this.options.joinType?this._showMergeAll():"origin"==this.options.source?this._showMergeAll():this._showMergeMethods())},_setupSpatialColumns:function(){"spatial"==this.options.joinType&&("count"==this.mergeMethod?this._showCountCover():("sum"==this.mergeMethod||"avg"==this.mergeMethod)&&(this._hideCountCover(),_.each(this.subColumns,function(a){"number"!=a.model.get("columnType")?a.model.set({enabled:!1,showRadio:!0}):a.model.set({enabled:!0,showRadio:!0})})))},_hideCountCover:function(){this.$el.find(".cover").fadeOut(200)},_showCountCover:function(){this.$el.find(".cover").fadeIn(200)},resetMergeMethods:function(){this.$el.find(".merge_methods li a").removeClass("selected")},setMergeMethod:function(a){a||(a="count"),this.mergeMethod=a,this._setupSpatialColumns(),this._selectKeyByDefault(),this.$el.find(".merge_methods li a."+a).addClass("selected"),this._toggleNextButton()},onClickMergeMethod:function(a){this.killEvent(a),this.resetMergeMethods(),this.mergeMethod=$(a.target).text().toLowerCase(),this._setupSpatialColumns(),this._selectKeyByDefault(),$(a.target).addClass("selected"),this._toggleNextButton()},_toggleNextButton:function(){var a=!0,b=this._getNumber();void 0==b&&"count"!=this.mergeMethod&&(a=!1),this.trigger("mergeMethodSelected",a)},_toggleMergeAllColumns:function(a){this.killEvent(a);var b=$(a.target).closest("a"),c=this.mergeColumns.length==this.subColumns.length;c?b.removeClass("enabled").addClass("disabled"):b.removeClass("disabled").addClass("enabled"),_.each(this.subColumns,function(a){a.model.get("switchSelected")!=!c&&a.model.set({switchSelected:!c})}),c?this.mergeColumns=[]:this.mergeColumns=_.map(this.subColumns,function(a){return a.model.get("name")})},_checkAllSelector:function(){var a=this.$el.find("div.merge_all a");this.mergeColumns.length==this.subColumns.length?a.removeClass("disabled").addClass("enabled"):a.removeClass("enabled").addClass("disabled")},_enableTipsy:function(){this.options.tipsy_enabled?this.options.tipsy_enabled=!0:$(".merge_methods a").tipsy({gravity:"s",html:!0,live:!0,fade:!0,title:function(){return $(this).attr("data-tipsy")}})},_showMergeMethods:function(){var a=this.$el.find("div.merge_methods");a.find("a").removeClass("disabled").removeClass("hidden").addClass("enabled"),this._enableTipsy(),a.show(),this.setMergeMethod(this.mergeMethod)},_hideMergeMethods:function(){this.$el.find(".merge_methods").addClass("hidden").hide()},_showMergeAll:function(){var a=this.$el.find(".merge_all");a.find("a").removeClass("disabled").addClass("enabled"),a.show()},_hideMergeAll:function(){this.$el.find("div.merge_all").hide()}}),cdb.admin.TablePrivacyWarning=cdb.admin.BaseDialog.extend({_TEXTS:{title:_t("Change table privacy"),msg:_t("Your are about to change this table privacy. Please note that if you do it, you will unpublish and turn into private {{ affected }}."),affected:_t("the visualizations below"),no_affected:_t("the related visualizations"),ok_title:_t("Ok, do it")},initialize:function(){this.options=_.extend({title:this._TEXTS.title,template_name:"old_common/views/dialog_base",clean_on_hide:!0,enter_to_confirm:!0,ok_button_classes:"button grey",ok_title:this._TEXTS.ok_title,cancel_button_classes:"underline margin15",modal_type:"confirmation",width:510,modal_class:"table_privacy_dialog"},this.options),this.affected_visualizations=this.options.affected_visualizations,this.elder("initialize")},render_content:function(){var a=$("<div></div>");return a.append("<p>"+this._TEXTS.msg.replace("{{ affected }}",this.affected_visualizations&&this.affected_visualizations.length>1?this._TEXTS.affected:this._TEXTS.no_affected)+"</p>"),a.append("<ul></ul>"),_.each(this.affected_visualizations,function(b){"table"!=b.type&&a.find("ul").append("<li><a href='"+cdb.config.prefixUrl()+"/viz/"+b.id+"/' target='_blank'>"+b.name+"</a></li>")}),a}}),cdb.admin.Tabs=cdb.core.View.extend({events:{click:"_click"},initialize:function(){_.bindAll(this,"activate"),this.preventDefault=!1},activate:function(a){this.$("a").removeClass("selected"),this.$('a[href$="#'+(this.options.slash?"/":"")+a+'"]').addClass("selected")},desactivate:function(a){this.$('a[href$="#'+(this.options.slash?"/":"")+a+'"]').removeClass("selected")},disable:function(a){this.$('a[href$="#'+(this.options.slash?"/":"")+a+'"]').addClass("disabled")},enable:function(a){this.$('a[href$="#'+(this.options.slash?"/":"")+a+'"]').removeClass("disabled")},getTab:function(a){return this.$('a[href$="#'+(this.options.slash?"/":"")+a+'"]')},disableAll:function(){this.$("a").addClass("disabled")},removeDisabled:function(){this.$(".disabled").parent().remove()},_click:function(a){a&&this.preventDefault&&a.preventDefault();var b=$(a.target).closest("a"),c=b.attr("href");if(!b.hasClass("disabled")&&c){var d=c.replace("#/","#").split("#")[1];this.trigger("click",d)}},linkToPanel:function(a){this.preventDefault=!0,a.bind("tabEnabled",this.activate,this),this.bind("click",a.active,a)}}),cdb.common.TipsyTooltip=cdb.core.View.extend({options:{gravity:"s",fade:!0},initialize:function(a){return void 0===a.el?(cdb.log.info("Element is needed to have tipsy tooltip working"),!1):(this._tipsyOpenedManually="manual"===a.trigger,void this._initTipsy())},showTipsy:function(){this.$el.tipsy("show")},hideTipsy:function(){this.$el.tipsy("hide")},_initTipsy:function(){this.$el.tipsy(this.options),this.tipsy=this.$el.data("tipsy")},_destroyTipsy:function(){this.tipsy&&(this.tipsy.hide(),this.$el.unbind("mouseleave mouseenter")),this._tipsyOpenedManually&&this.$el.tipsy("hide")},clean:function(){this._destroyTipsy(),cdb.core.View.prototype.clean.call(this)}}),cdb.admin.TooltipTrails=cdb.core.View.extend({className:"tooltip-trails",tagName:"div",options:{msg:_t("Checking tooltip-trails"),offset:[15,5]},render:function(){return this.$el.append(this.options.msg),this},show:function(a){this.$el.css({"margin-left":this.options.offset[0],"margin-top":this.options.offset[1],left:a.left,top:a.top}),this.$el.show()},move:function(a){this.$el.css(a)},hide:function(){this.$el.hide(),this.clean()}}),cdb.common.TwitterCategories=cdb.core.View.extend({_MAX_CATEGORIES:4,_MAX_TERMS:29,initialize:function(){var a=this._generateCategory();this.collection=new cdb.common.TwitterCategories.Collection([a]),this._initBinds()},render:function(){return this.clearSubViews(),this.collection.each(this._addCategory,this),this},_initBinds:function(){this.collection.bind("change",this._manageCategories,this),this.collection.bind("change",this._onCategoryChange,this)},_manageCategories:function(){var a=this.collection.size(),b=this.collection.filter(function(a){return 0===a.get("terms").length});if(0===b.length&&a<this._MAX_CATEGORIES){var c=this._generateCategory();return this.collection.add(c),this._addCategory(c),!1}if(b.length>0){var c=_.first(b),d=_.find(this._subviews,function(a){return c.cid===a.model.cid}),e=d.$el.index();if(1===a)return!1;if(e===a-1)return!1;e!==a-1&&b.length>1&&(c=b[1],d=_.find(this._subviews,function(a){return c.cid===a.model.cid}),this._removeCategory(d)),this._setCategoryIndex()}},_setCategoryIndex:function(){var a=this;this.$(".twitter-category").each(function(b,c){var d=$(c).find("input.category").val().replace("Category ","");if(d!==b+1){var e=a.collection.find(function(a){return a.get("category")===d});e.set("category",(b+1).toString())}})},_generateCategory:function(){return new cdb.common.TwitterCategories.Model({terms:[],category:(this.collection?this.collection.size()+1:1).toString()})},_addCategory:function(a){var b=new cdb.common.TwitterCategory({model:a});b.bind("submit",this._onCategorySubmit,this),b.bind("limit",this._onCategoryLimit,this),b.bind("nolimit",this._onCategoryNoLimit,this),this.$el.append(b.render().el),this.addView(b),this.trigger("addCategory")},_removeCategory:function(a){a.hide(),a.clean(),a.model.destroy(),this.trigger("removeCategory")},_onCategorySubmit:function(){this.trigger("submitCategory",this.collection.toJSON(),this)},_onCategoryLimit:function(){this.trigger("limitCategory",this.collection.toJSON(),this)},_onCategoryNoLimit:function(){this.trigger("noLimitCategory",this.collection.toJSON(),this)},_onCategoryChange:function(){this.trigger("changeCategory",this.collection.toJSON(),this)}}),cdb.common.TwitterCategories.Collection=Backbone.Collection.extend({model:cdb.common.TwitterCategories.Model}),cdb.common.TwitterCategories.Model=cdb.core.Model.extend({_MAX_COUNTER:1014,_CHAR_MAP:{" ":2,"-":2,_:2,".":2},defaults:{terms:[],category:"",counter:1014},initialize:function(){this._initBinds()},_initBinds:function(){this.bind("change:terms",this._setCounter,this)},_setCounter:function(){var a=this._MAX_COUNTER,b=this;this.get("terms").length>1&&(a-=4*(this.get("terms").length-1)),_.each(this.get("terms"),function(c){_.each(c,function(c){void 0!==b._CHAR_MAP[c]?a-=b._CHAR_MAP[c]:a--})}),this.set("counter",Math.max(0,a))}}),cdb.common.TwitterCategory=cdb.core.View.extend({className:"twitter-category",_MAX_CATEGORIES:4,_MAX_TERMS:29,events:{"focusout input.text":"_onInputFocusOut","focusin input.text":"_onInputFocusIn","keydown input.text":"_onInputChange","keypress input.text":"_onInputChange","keyup input.text":"_onInputChange"},initialize:function(){this.template=cdb.templates.getTemplate("old_common/views/twitter_categories/twitter_category"),this._initBinds()},render:function(){return this.$el.append(this.template({terms:this.model.get("terms"),category:this.model.get("category"),counter:this.model.get("counter")})),this.show(),this},_initBinds:function(){_.bindAll(this,"_onInputChange"),this.model.bind("change:category",this._onCategoryChange,this)},_onCategoryChange:function(){this.$("input.category").val("Category "+this.model.get("category"))},_onInputChange:function(a){var b=$(a.target).val();if(13===a.keyCode)return a.preventDefault(),this.trigger("submit",this.model,this),!1;if((0===this.model.get("counter")||this.model.get("terms").length>this._MAX_TERMS)&&37!==a.keyCode&&39!==a.keyCode&&8!==a.keyCode&&b.length>0)return this.killEvent(a),this.trigger("limit",this.model,this),!1;this.trigger("nolimit",this.model,this);var c=$(a.target),d=c.hasClass("terms")?"terms":"category",b=c.val(),e={};"terms"===d&&(b=b?b.split(","):[]),e[d]=b,this.model.set(e)},_onInputFocusOut:function(){this.$el.removeClass("focus")},_onInputFocusIn:function(){this.$el.addClass("focus")},show:function(){this.$el.addClass("enabled")},hide:function(){this.$el.removeClass("enabled")}}),cdb.admin.UpgradeDialog=cdb.admin.BaseDialog.extend({events:function(){return _.extend({},cdb.admin.BaseDialog.prototype.events,{"click ul.instances li a":"_onInstanceClick","click a.year_paid":"_onYearPaidClick"})},initialize:function(){_.bindAll(this,"_setInstance","_onYearPaidClick","_onInstanceClick"),_.extend(this.options,{title:"You have reached your account limits",description:"Why don’t you think in upgrading your account?",width:932,clean_on_hide:!0,template_name:"old_common/views/upgrade_dialog_base",ok_title:"Upgrade your account",ok_button_classes:"button blue",modal_class:"upgrade_account",modal_type:"notification",protocol:"http:"}),this.constructor.__super__.initialize.apply(this)},render_content:function(){var a=this.$content=$("<ul>").addClass("instances"),b=this,c=!1,d=window.location.protocol;d.indexOf("file")>=0&&(d="http:");var e=$.ajax({url:d+"//"+this.options.config.account_host+"/account/"+this.model.get("username")+".json",type:"GET",dataType:this.options.requestDataType||"jsonp",success:function(d){c=!0,d.available_plans.length>0?b._renderPlans(a,d):b._renderDedicated(a,d)},error:function(b){c=!0,a.addClass("disabled")}});return setTimeout(function(){c||(e.abort(),a.addClass("disabled"))},3e3),this.$content},_renderPlans:function(a,b){var c=this,d=this.model.get("username"),e=cdb.templates.getTemplate("old_common/views/upgrade_dialog_content");_.each(b.available_plans,function(b){b.price=c._formatNumber(b.price),b.tables_quota?b.tables_quota="Up to "+b.tables_quota+" tables":b.tables_quota="Unlimited tables",b.bytes_quota?b.bytes_quota="Up to "+c._readablizeBytes(b.bytes_quota):b.bytes_quota="Unlimited quota",b.lump_sum&&b.lump_sum.price&&(b.lump_sum.price=c._formatNumber(b.lump_sum.price)),"FREE"!=b.title&&a.append(e(b))}),this.$content.prepend('<form class="hide" action="'+window.location.protocol+"//"+this.options.config.account_host+"/account/"+d+'/process_change_subscription" method="POST"><input type="text" name="server" value="" /></form>'),this._setInstance(a,b.available_plans),a.addClass("active"),this.$("div.foot").show()},_renderDedicated:function(a,b){var c=(this.model.get("username"),cdb.templates.getTemplate("old_common/views/upgrade_dedicated_dialog_content"));this.$(".modal").animate({width:608},200),this.$("div.content").html("").append(c()),this.$("div.head p").remove()},_setInstance:function(a,b){var c,d=this.model.get("account_type"),e=this;_.each(b,function(a,b){a.title==d&&(c=b,e.plan=a.recurly_plan_code)}),0==c&&(c++,this.plan=b[c].recurly_plan_code),a.find(" > li:eq("+c+")").addClass("selected").find("a.button").removeClass("grey").addClass("selected green"),a.find("form input").val(this.plan)},_readablizeBytes:function(a){var b=["bytes","KB","MB","GB","TB","PB"],c=Math.floor(Math.log(a)/Math.log(1024));return(a/Math.pow(1024,Math.floor(c))).toFixed(0)+" "+b[c]},_formatNumber:function(a){var b=new String(a);b=b.split("").reverse();for(var c="",d=0;d<=b.length-1;d++)c=b[d]+c,(d+1)%3==0&&b.length-1!==d&&(c=","+c);return c},_onInstanceClick:function(a){a.preventDefault();var b=$(a.target).closest("li"),c=b.data("recurly_plan_code");return c==self.plan?!1:(this.$("li.selected").removeClass("selected"),this.$("a.selected").removeClass("selected green").addClass("grey"),b.addClass("selected").find("a.button").removeClass("grey").addClass("selected green"),void this.$("form input").val(c))},_onYearPaidClick:function(a){a.preventDefault();var b=$(a.target).data("recurly_plan_code");this.$("form input").val(b),this.$("form").submit(),this.hide()},ok:function(){this.$("form").submit(),this.hide()},hide:function(){var a=this;this.$el.find(".modal").animate({marginTop:"50px",opacity:0},300,function(){a.options.clean_on_hide&&a.clean()}),this.$el.find(".mamufas").fadeOut(300),this.trigger("closedDialog",this,this)}}),cdb.admin.upload_states={reset:{enable:!0,option:0,hideUpload:!0,title:"New table",description:"Choose between the following options to create a new table.",hideClose:!1,ok:{removeClasses:"grey",addClasses:"disabled green",text:"Create table"},list:{animate:{properties:{marginTop:"0px",height:"100%",opacity:1},options:{duration:500}}},loader:{animate:{properties:{top:"<%- top %>",opacity:0},options:{duration:500,queue:!1}},removeClasses:"creating uploading",addClasses:"",css:{}},stop:!1,showLoader:!1},creating:{enable:!1,option:2,hideUpload:!0,title:"Creating your table...",description:"Give us some seconds to create it and then you will be redirected.",hideClose:!0,ok:{removeClasses:"",addClasses:"disabled",text:"Create table"},list:{animate:{properties:{marginTop:"-30px",height:"0",opacity:"0"},options:{duration:800,queue:!0}}},loader:{animate:{properties:{top:"<%- top %>"},options:{duration:500,queue:!1}},removeClasses:"",addClasses:"creating",text:"Creating your table...",progress:100,css:{}},stop:!1,showLoader:!0},uploading:{enable:!1,option:0,hideUpload:!1,title:"Uploading your data",description:"Depending on your internet connection, this could take some time.",hideClose:!0,ok:{removeClasses:"",addClasses:"disabled",text:"Create table"},list:{animate:{properties:{marginTop:"-10px",height:"0",opacity:"0"},options:{duration:800,queue:!0}}},loader:{animate:{properties:{top:"<%- top %>",opacity:1},options:{duration:500,queue:!1}},removeClasses:"",addClasses:"creating",text:"Uploading your table...",progress:4,css:{top:"110px",opacity:0}},stop:!0,showLoader:!0},importing:{enable:!0,option:3,hideUpload:!1,title:"Your file is being processed",description:"You can now hide this window and follow the progress at the bottom left corner of your screen.",description_new_layer:"After your data is imported we'll add the new layer",ok:{removeClasses:"green disabled",addClasses:"grey",text:"Hide this window"},hideClose:!0,foot:{text:""},list:{animate:{properties:{marginTop:"-10px",height:"0",opacity:"0"},options:{duration:800,queue:!0}}},loader:{animate:{properties:{top:"<%- top %>",left:"40px",opacity:1},options:{duration:500,queue:!1}},removeClasses:"uploading",addClasses:"creating",text:"Processing file...",progress:100,css:{top:"110px",opacity:0}},stop:!1,showLoader:!0}},cdb.common.DashboardDatasetsUrl=cdb.common.DashboardVisUrl.extend({dataLibrary:function(){return this.urlToPath("library")}}),cdb.common.DashboardUrl=cdb.common.Url.extend({datasets:function(){return new cdb.common.DashboardDatasetsUrl({base_url:this.urlToPath("datasets")})},maps:function(){return new cdb.common.DashboardVisUrl({base_url:this.urlToPath("maps")})}}),cdb.common.DatasetUrl=cdb.common.Url.extend({edit:function(){return this.urlToPath()},"public":function(){return this.urlToPath("public")}}),cdb.common.MapUrl=cdb.common.Url.extend({edit:function(){return this.urlToPath("map")},"public":function(){return this.urlToPath("public_map")}}),cdb.common.OrganizationUrl=cdb.common.Url.extend({edit:function(a){if(!a)throw new Error("User is needed to create the url");return this.urlToPath(a.get("username")+"/edit")},create:function(){return this.urlToPath("new")}}),cdb.common.UserUrl=cdb.common.Url.extend({initialize:function(a){if(cdb.common.Url.prototype.initialize.apply(this,arguments),_.isUndefined(a.is_org_admin))throw new Error("is_org_admin is required")},organization:function(){return this.get("is_org_admin")?this.urlToPath("organization"):this.urlToPath("account")},accountSettings:function(){return this.urlToPath("profile")},publicProfile:function(){return this.urlToPath("maps")},apiKeys:function(){return this.urlToPath("your_apps")},logout:function(){return this.urlToPath("logout")},dashboard:function(){return new cdb.common.DashboardUrl({base_url:this.urlToPath("dashboard")})}}),cdb.ui.common.UserListWarning=cdb.core.View.extend({className:"common-users-list warning",options:{list:[],msg:_t("Next users list will be affected by your changes:"),type:"permission"},initialize:function(){this.model=new cdb.core.Model({list:this.options.list}),this.template=this.options.template_name?this.getTemplate(this.options.template_name):this.getTemplate("old_common/views/users_list_warning"),this._initBinds()},render:function(){this.clearSubViews(),this.$el.empty();var a=this.template({users:this.model.get("list"),msg:this.options.msg});if(0===this.model.get("list").length&&(a=""),this.$el.append(a),this.model.get("list").length>0){new cdb.admin.CustomScrolls({parent:this.$(".list-wrapper"),el:this.$("ul")})}return this},_initBinds:function(){this.model.bind("change:list",this.render,this)},changeList:function(a){this.model.set("list",a)}}),cdb.admin.VideoModel=cdb.core.Model.extend({defaults:{minimized:!0,size:{minimized:{width:420,height:236},maximized:{width:700,height:393}}},initialize:function(){this._initLocalStorage();var a=this.defaults.minimized;this.videoData&&void 0!==this.videoData.minimized&&(a=this.videoData.minimized);var b=this.defaults.size[a?"minimized":"maximized"];this.set({minimized:a,width:b.width,height:b.height,seconds:this.videoData?this.videoData.seconds:0,top:this.videoData?this.videoData.top:null,left:this.videoData?this.videoData.left:20,bottom:this.videoData?this.videoData.bottom:20}),this.bind("change",this._onChangeProperty,this),this.bind("change:minimized",this._onChangeMinimized,this)},_initLocalStorage:function(){this.localStorage=new cdb.admin.localStorage("VideoPlayer"),this.videoData=this.localStorage.get("currentVideo")||{};var a=this.get("video_id");a?(this._storeVideoID(a),this.videoData=this.localStorage.get("currentVideo")):this.set("video_id",this.videoData.video_id)},_onChangeMinimized:function(){var a=this.defaults.size[this.get("minimized")?"minimized":"maximized"];
this.set("width",a.width),this.set("height",a.height)},_onChangeProperty:function(a){this.videoData=a.attributes,this._saveVideoData()},_saveVideoData:function(){this.set(this.videoData),this.localStorage.set({currentVideo:this.videoData})},_storeVideoID:function(a){this.videoData.video_id=a,this._saveVideoData()},clearStoredData:function(a){this.set("video_id",null),this.videoData={},this.localStorage.set({currentVideo:null})}}),cdb.admin.VideoPlayer=cdb.core.View.extend({className:"VideoPlayer",events:{dblclick:"_toggle","click .js-toggle":"_toggle","click .js-close":"close",mouseenter:"_mouseEnter",mouseleave:"_mouseLeave"},initialize:function(a){_.bindAll(this,"_onInitDraggable","_onStopDragging","_onCloseAnimationFinished"),this.template=cdb.templates.getTemplate("dashboard/views/video_player"),this._initModel()},render:function(){var a=this;return this.clearSubViews(),this.hasVideoData()&&(this.$el.html(this.template({id:this.model.get("video_id")})),this.$el.draggable({stop:a._onStopDragging,create:a._onInitDraggable}),this.video=this.$el.find("iframe"),this._loadScript()),this},_initModel:function(){this.model=new cdb.admin.VideoModel({video_id:this.options.id}),this.model.bind("change:minimized",this._onChangeMinimized,this)},_loadScript:function(){var a=this;$.getScript("//f.vimeocdn.com/js/froogaloop2.min.js",function(){a._initVideoBinds()})},_initVideoBinds:function(){var a=this;this.player=$f(this.video[0]),this.player.addEvent("ready",function(){a._seekToStoredPosition(),a.player.addEvent("pause",function(b){a.model.set("status","stop")}),a.player.addEvent("finish",function(b){a.model.set("status","stop"),a.close(!1,{dontHide:!0})}),a.player.addEvent("play",function(b){a.model.set("status","play")}),a.player.addEvent("playProgress",function(b){a.model.set("seconds",b.seconds)})})},_removeVideoBinds:function(){this.player&&this.player.removeEvent("ready")},_onInitDraggable:function(a,b){var c=this.model.get("bottom"),d=this.model.get("left"),e=this.model.get("height"),f=this.model.get("width"),g=$(window).width();d+f>g&&(d=g-f-20),this.$el.css({position:"fixed",left:d,bottom:c}),0>c?this.$el.animate({bottom:20,width:f,height:e},{easing:"easeOutQuad",duration:200}):this.$el.animate({width:f,height:e},{easing:"easeOutQuad",duration:200})},_onStopDragging:function(a,b){var c=$(window).height(),d=b.position.top,e=b.position.left,f=c-(d+this.$el.outerHeight(!0));this.$el.css({bottom:"auto"}),this.model.set({top:d,left:e,bottom:f})},_mouseEnter:function(){this.$el.find(".VideoControls").fadeIn(150)},_mouseLeave:function(){this.$el.find(".VideoControls").fadeOut(150)},hasVideoData:function(){return this.model.get("video_id")?!0:!1},_seekToStoredPosition:function(){var a=this,b=this.model.get("seconds");b&&this.player.api("seekTo",b),"stop"===this.model.get("status")&&setTimeout(function(){a.player.api("pause")},100)},close:function(a,b){a&&this.killEvent(a),b&&b.dontHide?this.model.clearStoredData():this.$el.animate({width:0,height:0,opacity:0},{easing:"easeInQuad",duration:200,complete:this._onCloseAnimationFinished})},_onCloseAnimationFinished:function(){this.model.clearStoredData(),this._removeVideoBinds(),this.remove()},_toggle:function(a){a&&this.killEvent(a),this.model.set("minimized",!this.model.get("minimized"))},_onChangeMinimized:function(){function a(a){if(h+a>d){var b=d-h-c.$el.outerWidth(!0);c.$el.css({left:"auto",right:b})}}function b(a){0>g||c.$el.offset().top<0?c.$el.animate({top:20},100):0>g-a||c.$el.offset().top-a<0?c.$el.css({bottom:"auto",top:g}):0>f?c.$el.css({top:"auto",bottom:20}):g+a>e&&c.$el.css({top:"auto",bottom:f})}var c=this,d=$(window).width(),e=$(window).height(),f=($(document).height(),this.model.get("bottom")),g=this.model.get("top"),h=(this.$el.offset().top,this.$el.position().left),i=this.model.get("width"),j=this.model.get("height");a(i),b(j),this.$el.animate({width:i,height:j},{easing:"easeOutQuad",duration:200,complete:function(){var a=$(window).height()-($(".VideoPlayer").offset().top+$(".VideoPlayer").outerHeight(!0));c.model.set("bottom",a)}})}}),cdb.ui.common.VisualizationsSelector=cdb.core.View.extend({className:"visualizations-selector",events:{"select change":"_onComboChange"},initialize:function(){this.model&&this.options.user||cdb.log.info("Visualizations and user models are required"),this.user=this.options.user,this._initBinds()},render:function(){this.clearSubViews();var a=$("<div>");this.$el.append(a);var b=new cdb.forms.VisualizationCombo({el:a,property:"table",width:"100%",extra:this._generateList()});return b.bind("change",this._onComboChange,this),this.$el.append(b.render().el),this.addView(b),this._onComboChange(),this},_initBinds:function(){this.model.bind("reset",this.render,this)},_generateList:function(){return this.model.map(function(a){var b={vis_id:a.get("id"),name:a.get("name"),username:"",avatar:"",permission:""};if(this.user.isInsideOrg()&&a.permission.owner){var c=a.permission.owner.renderData(this.user);b=_.extend(b,{username:c.username,avatar:c.avatar_url,permission:a.permission.getPermission(this.user)===cdb.admin.Permission.READ_ONLY?"READ":null})}return b},this)},_onComboChange:function(){this.trigger("change",this.getSelected(),this)},enable:function(){this.$("select").select2("enable")},disable:function(){this.$("select").select2("disable")},getSelected:function(){var a=$(this.$("select").select2("data").element).data();return _.isEmpty(a)||!a.vis_id||"undefined"===a.vis_id?null:$(this.$("select").select2("data").element).data()}}),cdb.forms.VisualizationCombo=cdb.forms.Combo.extend({_ITEM_TEMPLATE:_t('       <div class="vis-info-item <%- username ? "shared" : "" %>">        <div class="value" title="<%- id %>" alt="<%- id %>"><%- id %></div>        <% if (username) { %>          <div class="by">            <% if (permission) { %>              <span class="permission round grey"><%- permission %></span>            <% } %>            <span class="username">by <%- username %></span>            <% if (avatar) { %>              <img class="avatar" src="<%= avatar %>" title="<%- username %>" alt="<%- username %>"/>            <% } %>          </div>        <% } %>      </div>    '),options:{minimumResultsForSearch:20,placeholder:"",formatResult:!0,matcher:!0,dropdownCssClass:"visualizations-dropdown"},initialize:function(){_.bindAll(this,"_onUpdate","_changeSelection","_formatResult"),cdb.forms.Combo.prototype.initialize.call(this)},_getOptions:function(){var a=_.map(this.data,function(a){return'<option data-vis_id="'+a.vis_id+'" data-permission="'+a.permission+'" data-name="'+a.name+'" " data-avatar="'+a.avatar+'" data-username="'+a.username+'">'+a.name+"</option>"}).join("");return this.options.placeholder&&(a="<option></option>"+a),a},_formatResult:function(a){var b=$(a.element).data();return b.id=a.id,_.template(this._ITEM_TEMPLATE)(b)},_matcher:function(a,b,c){var d=$(c).val();return d.toUpperCase().indexOf(a.toUpperCase())>=0}}),cdb.admin.WizardDialog=cdb.ui.common.Dialog.extend({}),function(){var a=cdb.core.View.extend({tagName:"a",events:{click:"click"},initialize:function(){_.bindAll(this,"click"),this.elder("initialize"),this.enabled=!0},render:function(){return this.$el.addClass(this.className),this.$el.append(this.className),this.$el.attr("href","#"+this.className),this.$el.append($("<span>").addClass("error")),this.$el.append($("<span>").addClass("run")),this.$el.tipsy({gravity:"e",fade:!0,offset:-10,title:function(){return $(this).attr("class").replace("_mod","").replace(/_/g," ").replace("selected","")}}),this},show:function(){this.$el.css("display","block")},addClass:function(a){this.$el.addClass(a)},removeClass:function(a){this.$el.removeClass(a)},enable:function(a){this.enabled=a,a?this.$el.removeClass("disabled"):this.$el.addClass("disabled")},click:function(a){return a&&a.preventDefault(),this.$el.tipsy("hide"),this.enabled&&this.trigger("click",this.className),!1}});cdb.admin.RightMenu=cdb.core.View.extend({tagName:"section",initialize:function(){this.panels=new cdb.ui.common.TabPane,this.tabs=new cdb.admin.Tabs,this.buttons=[],this.addView(this.panels),this.template=this.getTemplate("table/views/right_panel"),this.isOpen=!0},render:function(){return this.$el.append(this.template({})),this.panels.setElement(this.$(".layer-views")),this.tabs.setElement(this.$(".layer-sidebar")),this},addToolButton:function(a,b){var c=this._addButton(a,b);return buttons=this.$(".edit"),buttons.append(c.render().$el),c},_addButton:function(b,c){var d=new a;return d.className=b,d.sections=_.isArray(c)?c:[c],this.addView(d),this.buttons.push(d),d.show(),this.activeSection&&(_.include(d.sections,this.activeSection)||d.hide()),d},addClassToButton:function(a,b){var c=this.getButtonByClass(a);c&&c.addClass(b)},removeClassFromButton:function(a,b){var c=this.getButtonByClass(a);c&&c.removeClass(b)},addModule:function(a,b){b=b||["table"],this.panels.addTab(a.buttonClass,a);var c=this._addButton(a.buttonClass,b),d=this.$(".tools");d.append(c.render().$el),this.activeSection&&(_.include(c.sections,this.activeSection)||c.hide()),c.bind("click",this.toggle,this),c.bind("click",this.panels.active,this.panels)},active:function(a){this.panels.active(a),this.tabs.activate(a)},showTools:function(a){this.activeSection=a,_(this.buttons).each(function(b){_.include(b.sections,a)?b.show():b.hide()})},enabledButtonsForSection:function(a){return _(this.buttons).filter(function(b){return _.include(b.sections,a)})},disableModule:function(a){var b=this.getButtonByClass(a);if(b){b.enable(!1);var c=this.panels.getPane(a);c&&c.disabled&&c.disabled()}},enableModule:function(a){var b=this.getButtonByClass(a);if(b){b.enable(!0);var c=this.panels.getPane(a);c&&c.enabled&&c.enabled()}},toggle:function(a){this.trigger("toggle",a)},getButtonByClass:function(a){for(var b=0,c=this.buttons.length;c>b;b++)if(this.buttons[b].className===a)return this.buttons[b];return null}})}(),cdb.admin.DEFAULT_BASEMAPS={CartoDB:[{url:"http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",subdomains:"abcd",minZoom:0,maxZoom:18,name:"Positron",className:"positron_rainbow",attribution:'© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="http://cartodb.com/attributions">CartoDB</a>'},{url:"http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",subdomains:"abcd",minZoom:0,maxZoom:18,name:"Dark matter",className:"dark_matter_rainbow",attribution:'© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="http://cartodb.com/attributions">CartoDB</a>'},{url:"http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png",subdomains:"abcd",minZoom:0,maxZoom:18,name:"Positron (lite)",className:"positron_lite_rainbow",attribution:'© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="http://cartodb.com/attributions">CartoDB</a>'},{url:"http://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png",subdomains:"abcd",minZoom:0,maxZoom:18,name:"Dark matter (lite)",className:"dark_matter_lite_rainbow",attribution:'© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="http://cartodb.com/attributions">CartoDB</a>'},{url:"https://cartocdn_{s}.global.ssl.fastly.net/base-antique/{z}/{x}/{y}.png",subdomains:"abcd",minZoom:0,maxZoom:10,name:"CartoDB World Antique",className:"antique_cartodb",attribution:""},{url:"https://cartocdn_{s}.global.ssl.fastly.net/base-eco/{z}/{x}/{y}.png",subdomains:"abcd",minZoom:0,maxZoom:10,name:"CartoDB World Eco",className:"eco_cartodb",attribution:""},{url:"https://cartocdn_{s}.global.ssl.fastly.net/base-flatblue/{z}/{x}/{y}.png",subdomains:"abcd",minZoom:0,maxZoom:10,name:"CartoDB World Flat Blue",className:"flat_blue",attribution:""},{url:"https://cartocdn_{s}.global.ssl.fastly.net/base-midnight/{z}/{x}/{y}.png",subdomains:"abcd",minZoom:0,maxZoom:10,name:"CartoDB World Midnight Commander",className:"midnight_cartodb",attribution:""}],Stamen:[{url:"https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png",subdomains:"abcd",minZoom:0,maxZoom:18,name:"Toner",className:"toner_stamen",attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.'},{url:"https://stamen-tiles-{s}.a.ssl.fastly.net/toner-background/{z}/{x}/{y}.png",subdomains:"abcd",minZoom:0,maxZoom:18,name:"Toner Background",className:"toner_background_stamen",attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.'},{url:"https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png",subdomains:"abcd",minZoom:0,maxZoom:18,name:"Toner Lite",className:"toner_lite_stamen",attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.'},{url:"https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lines/{z}/{x}/{y}.png",subdomains:"abcd",minZoom:0,maxZoom:18,name:"Toner Lines",className:"toner_lines_stamen",attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.'},{url:"https://stamen-tiles-{s}.a.ssl.fastly.net/toner-hybrid/{z}/{x}/{y}.png",subdomains:"abcd",minZoom:0,maxZoom:18,name:"Toner Hybrid",className:"toner_hybrid_stamen",attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.'},{url:"https://stamen-tiles-{s}.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.png",subdomains:"abcd",minZoom:0,maxZoom:18,name:"Watercolor",className:"watercolor_stamen",attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>.'}]},cdb.admin.Module=cdb.core.View.extend({_STORAGE_NAMESPACE:"cdb.localStorage.module.",_ACTION:{type:"narrow",width:450},getModuleAction:function(){return this._ACTION},triggerModuleAction:function(){this.trigger("tabChanged",this.getModuleAction())}}),cdb.admin.mod=cdb.admin.mod||{},cdb.admin.mod.CartoCSSEditor=cdb.admin.Module.extend({_TEXTS:{tip:"<strong>Ctrl + SPACE</strong> to autocomplete. <strong><%- key %> + S</strong> to apply your styles."},_ACTION:{type:"show",width:600},buttonClass:"cartocss_mod",type:"tool",events:{"click .actions button":"applyStyle","click .actions a.next":"_do","click .actions a.back":"_undo","click .doc_info":"_showDoc"},initialize:function(){_.bindAll(this,"_onKeyUpEditor"),this.template=this.getTemplate("table/menu_modules/views/carto_editor"),this.model.bind("change",this._updateStyle,this),this.add_related_model(this.model),this.add_related_model(this.model.table);var a=this.model.get("tile_style_history"),b=(this.model.tile_style_history_position,this.model.get("tile_style"));b&&""!=b&&a&&-1===_.indexOf(a,b)&&(a.push(b),this.model.set({tile_style_history:a},{silent:!0})),this.model.tile_style_history_position=-1!==_.indexOf(a,b)?_.indexOf(a,b):0,this.model.bind("parseError",this._showErrorFromServer,this),this.model.bind("tileOk",this._checkLocalErrors,this),this.model.table.bind("change:schema",this._checkLocalErrors,this),this._initBinds(),cdb.god.bind("end_show",this.activated,this),this.add_related_model(cdb.god)},buildAutocomplete:function(){if(this.autocomplete=[],"undefined"!=typeof window._mapnik_reference_latest){var a=_mapnik_reference_latest.symbolizers;for(var b in a){var c=a[b];for(var d in c){var e=c[d].css;e&&e.length&&this.autocomplete.push(e)}}}},activated:function(){this.codeEditor&&(this.codeEditor.refresh(),this.codeEditor.focus(),this._adjustCodeEditorSize())},render:function(){return this.clearSubViews(),this.$el.append(this.template({})),this._initHelp(),this._initEditor(),this._updateStyle(),this._adjustCodeEditorSize(),this},_initBinds:function(){var a=navigator.userAgent.toLowerCase(),b="rest",c="ctrl+s",d=this;/mac os/.test(a)&&(c="meta+s",b="mac"),this.$el.bind("keydown",c,function(a){("mac"==b&&a.metaKey||"rest"==b&&a.ctrlKey)&&83==a.keyCode&&(a.preventDefault(),d.applyStyle())})},_initEditor:function(){var a=this;this.codeEditor=CodeMirror.fromTextArea(this.$("textarea")[0],{mode:"text/x-carto",tabMode:"indent",matchBrackets:!0,lineNumbers:!0,lineWrapping:!0,onKeyEvent:this._onKeyUpEditor,extraKeys:{"Ctrl-Space":function(b){a._showAutocomplete(b)}}});var b=new cdb.admin.CodemirrorColorPicker({editor:this.codeEditor,model:this.model});b.bind("colorChosen",this.applyStyle,this),this.addView(b),this.$("a.next, a.back").tipsy({gravity:"s",fade:!0})},_initHelp:function(){var a="rest",b=navigator.userAgent.toLowerCase();/mac os/.test(b)&&(a="mac");var c=new cdb.admin.mod.HTMLEditorHelp({localStorageKey:this._STORAGE_NAMESPACE+this.model.table.get("id"),text:_.template(this._TEXTS.tip)({key:"mac"==a?"CMD":"Ctrl"})}).bind("hide show",this._adjustCodeEditorSize,this);this.$el.append(c.render().$el),this.addView(c)},_showAutocomplete:function(a){CodeMirror.showHint(a,CodeMirror.hint["custom-list-with-type"],{completeSingle:!1,list:_.union(this._getTableName(),this._getSQLColumns())})},_getTableName:function(){return[[this.model.table.get("name"),"T"]]},_getSQLColumns:function(){return _.map(this.model.table.get("schema"),function(a){return[a[0],"C"]})},_onKeyUpEditor:function(a,b){var c=b.keyCode?b.keyCode:b.which;if("keyup"==b.type&&27!=c){var d=this;this.autocomplete_timeout&&clearTimeout(this.autocomplete_timeout),this.autocomplete_timeout=setTimeout(function(){var b=a.getCursor(),c=a.getTokenAt(b).string,e=d.model.table.get("schema");if(e&&c.length>2){var f=_.union(d.model.table.get("schema"),d._getTableName()),g=_.compact(_.map(f,function(a){return-1!=a[0].search(c)?a[0]:null}));!a.state.completionActive&&c.length>2&&g.length>0&&d._showAutocomplete(a)}},150)}},formatStyle:function(a){try{if(a&&a.length){a=a.replace(/{/g,"{\n").replace(/}/g,"}\n").replace(/;/g,";\n");for(var b=a.split("\n"),c=[],d=0,e=0;e<b.length;++e)c.push(d),-1!=b[e].indexOf("{")&&++d,-1!=b[e].indexOf("}")&&--d;for(var f=[],e=0;e<b.length;++e){var g="";b[e].indexOf("}")>=0&&(c[e]-=1);for(var h=0;h<c[e];++h)g+="  ";f.push(g+b[e])}return"/** this cartoCSS has been processed in order to be compatible with the new cartodb 2.0 */\n\n"+f.join("\n")}}catch(i){}return a},_updateStyle:function(){var a=this.model.get("tile_style"),b=this.codeEditor.getValue();this.codeEditor&&a&&a!=b&&(-1===a.indexOf("\n")&&(a=this.formatStyle(a)),this.codeEditor.setValue(a),this.codeEditor.refresh()),this.model.get("tile_style_history")&&this._checkDoButtons()},_parseError:function(a){var b=[];for(var c in a){var d=a[c];if(d)if(d.length>0){var e=d.match(/.*:(\d+):(\d+)\s*(.*)/);e?b.push({line:parseInt(e[1],10),message:e[3]}):b.push({line:null,message:d})}else d.line&&b.push(d)}return b.sort(function(a,b){return a.line-b.line}),b=_.uniq(b,!0,function(a){return a.line+a.message})},_showErrorFromServer:function(a){this._showError(this._parseError(a))},_showError:function(a){var b=a;if(b.length>0){var c=_(b).map(function(a){return a.line?"line "+a.line+": "+a.message:a.error||a.message});this._renderError(c.join("</br>"))}},_renderError:function(a){this.trigger("hasErrors");var b=this.$(".actions").outerHeight();this.$(".info").addClass("error").html("<p>"+a+"</p>").css({bottom:b+(this.model.get("visible")?0:57)}).show(),this._adjustCodeEditorSize()},_adjustCodeEditorSize:function(){var a=this.$(".info").is(":visible")?this.$(".info").outerHeight():0,b=this.$(".help-tip").is(":visible")?36:0,c=this.model.get("visible")?0:57;this.$(".CodeMirror-wrap").css({bottom:a+c+80,top:b})},_checkLocalErrors:function(){var a=this.model.get("tile_style"),b=new cdb.admin.CartoParser(a);if(b.errors().length)this._showError(this._parseError(b.errors()));else{var c=this.checkVariables(b.variablesUsed());if(c.length)return void this._showError(c)}this._clearErrors()},_clearErrors:function(){this.trigger("clearError"),this.$(".info").html("").removeClass("error").hide(),this._adjustCodeEditorSize()},_do:function(a){a.preventDefault();var b=this.model.redoHistory("tile_style");return this.codeEditor&&this.codeEditor.setValue(b),this._checkDoButtons(),!1},_undo:function(a){a.preventDefault();var b=this.model.undoHistory("tile_style");return this.codeEditor&&this.codeEditor.setValue(b),this._checkDoButtons(),!1},checkVariables:function(a){var b=this.model.table.columnNames(),c=[];for(var d in a)_.contains(b,a[d])||c.push({error:"sql/table must contain "+a[d]+" variable"});return c},applyStyle:function(){this._clearErrors();var a=this.codeEditor.getValue(),b=new cdb.admin.CartoParser(a);if(b.errors().length){var c=this._parseError(b.errors());c&&this._showError(c)}else{var d=this.checkVariables(b.variablesUsed());if(d.length)return void this._showError(d);this.model.addToHistory("tile_style",a),this.model.save({tile_style:a,tile_style_custom:!0}),this.trigger("applyStyle",a)}cdb.god.trigger("mixpanel","Applying a CartoCSS style manually",{style:a}),cdb.god.trigger("metrics","cartocss_manually",{email:window.user_data.email,data:{style:a}})},hasChanges:function(){return this.model.get("tile_style")!=this.codeEditor.getValue()},_checkDoButtons:function(){this.model.isHistoryAtLastPosition("tile_style")?this.$el.find("a.next").addClass("disabled"):this.$el.find("a.next").removeClass("disabled"),this.model.isHistoryAtFirstPosition("tile_style")?this.$el.find("a.back").addClass("disabled"):this.$el.find("a.back").removeClass("disabled")},_showDoc:function(a){a.preventDefault();var b=new cdb.admin.CartoCSSInfo;$("body").append(b.render().el),b.open()}}),cdb.admin.mod.CartoCSSWizard=cdb.admin.Module.extend({buttonClass:"wizards_mod",type:"tool",events:{"click  .wizard_arrows a":"_onArrowClick"},initialize:function(){var a=this;a.active=!1,this.currentWizard=null,this.wizard_properties=this.model.wizard_properties,this.add_related_model(this.model),this.add_related_model(this.options.table),this.add_related_model(this.wizard_properties),this.position=0,this.tabs=new cdb.admin.Tabs,this.addView(this.tabs),this.tabs.preventDefault=!0,this.tabs.bind("click",this._onWizardClick,this),this.tabs.bind("click",function(){cdb.god.trigger("mixpanel","Choose a wizard",{type:this.wizard_properties.get("type")}),cdb.god.trigger("metrics","wizard",{email:window.user_data.email,data:{type:this.wizard_properties.get("type")}})},this),this.wizard_properties.bind("change:type",function(){this.enableTabs()},this),this.wizard_properties.bind("change:type",this.renderWizards,this),this.options.table.bind("change:geometry_types",function(){this.enableTabs(),this.renderWizards()},this)},_onWizardClick:function(a){this.trigger("activeWizard",a,this),this.wizard_properties.active(a,{zoom:this.options.map.get("zoom")})},_enableModules:function(a){this.trigger("modules",a.MODULES)},_onArrowClick:function(a){this.killEvent(a);var b=$(a.target);if(b.hasClass("disabled"))return!1;var c=b.attr("href").replace("#","");this._moveNavigation(c)},_resetNavigation:function(){var a=this.$("ul.vis_options"),b=a.find("li").size(),c=92+Math.ceil(30/b);$right=this.$("a.right"),$left=this.$("a.left"),a.parent().removeClass("left_shadow");var d=a.find("a.selected").parent(),e=d.index(),f=a.find("li").size();if(e>=3){a.parent().addClass("left_shadow"),this.position=e-2;var g=this.position*c;e>=b-1&&(g+=18),a.animate({left:-g+"px"},{queue:!1,duration:250}),$left.removeClass("disabled"),$right[f-1==e?"addClass":"removeClass"]("disabled")}else a.animate({left:"0"},{queue:!1,duration:250}),$left.addClass("disabled"),$right[b>3?"removeClass":"addClass"]("disabled"),this.position=0;this.animation=!1},_moveNavigation:function(a){if(this.animation)return!1;var b=this.$("ul.vis_options"),c=3,d=b.find("li").size(),e=100+Math.ceil(40/d),f=b.parent().outerWidth()||380,g=d*(e+5),h=parseInt(b.css("left").replace("px",""))||0,i=this.$("a.right"),j=this.$("a.left"),k=this;if(f>g)return j.addClass("disabled"),i.addClass("disabled"),!1;if("left"==a)e>-h&&(e=-h),this.position--,0==this.position&&b.parent().removeClass("left_shadow");else{if(f-h>=g)return!1;e>g+h&&(e=g+h),this.position++,b.parent().addClass("left_shadow")}this.position+c>=d?i.addClass("disabled"):i.removeClass("disabled"),0==this.position?j.addClass("disabled"):j.removeClass("disabled"),this.animation=!0;var l="-=";"left"==a&&(l="+="),b.animate({left:l+e+"px"},200,function(){k.animation=!1})},_setThumbnails:function(){var a=this.options.table.geomColumnTypes().join("-");this.$(".vis_options li a").each(function(b,c){$(c).addClass(a)})},activated:function(){this.active=!0},deactivated:function(){this.active=!1},enableTabs:function(){this.renderTabs(),this.tabs.disableAll();var a=this.wizard_properties.getEnabledWizards();for(var b in a)this.tabs.enable(a[b]);this._setThumbnails(),this.tabs.removeDisabled(),this.tabs.activate(this.wizard_properties.get("type")),this._resetNavigation()},renderTabs:function(){this.tabs.$el.html(this.getTemplate("table/menu_modules/views/carto_wizard_tabs")())},renderWizards:function(){var a=this.wizard_properties.get("type");if(a){cdb.core.Profiler.metric("cartowizard:renderWizards").inc();var b=this.$(".forms"),c=this.options.wizards[a];if(this.currentWizard&&this.currentWizard.clean(),b.html(""),c){var d=new cdb.admin.mod[c]({table:this.options.table,layer:this.options.model,wizard_properties:this.wizard_properties,style:this.model.get("style"),map:this.options.map});b.append(d.render().el),this.currentWizard=d,this.addView(this.currentWizard),this._enableModules(this.currentWizard)}}},render:function(){return this.$el.html(""),this.$el.append(this.getTemplate("table/menu_modules/views/carto_wizard")()),this.tabs.setElement(this.$("ul.vis_options")),this.enableTabs(),this.renderWizards(),this}}),cdb.admin.mod.SimpleWizard=cdb.core.View.extend({MODULES:["infowindow","legends"],initialize:function(){this.cartoProperties=this.options.wizard_properties,this.type=this.type||"polygon",this.add_related_model(this.cartoProperties),this.add_related_model(this.options.table);var a=new Backbone.Model;a.set(this.cartoProperties.attributes);var b=!1;this.cartoProperties.bind("change",function(){b=!0,a.set(this.cartoProperties.attributes),b=!1},this),a.bind("change",function(){a.changed["marker-fill"]&&(a.unset("marker-file"),this.cartoProperties.unset("marker-file")),b||(this.cartoProperties.enableGeneration(),this.cartoProperties.set(a.attributes))},this),this.form=new cdb.forms.Form({form_data:this.cartoProperties.formData(this.type),model:a}),this.addView(this.form),this._bindChanges(),this.cartoProperties.bind("change:form",function(){this.form.updateForm(this.cartoProperties.formData(this.type)),this.render()},this)},_generateSQL:function(){return null},isValid:function(){return!0},_bindChanges:function(){this.cartoProperties.bind("change:text-name",this.showTextFields,this),this.cartoProperties.bind("change:text-allow-overlap",function(a,b){this.cartoProperties.set({"text-placement-type":"true"===b?"dummy":"simple","text-label-position-tolerance":"true"===b?0:10})},this),this.cartoProperties.bind("change:marker-width",function(a,b){this.cartoProperties.has("text-dy")&&this.cartoProperties.set("text-dy",-b)},this)},showTextFields:function(){var a=this,b=a.form.getFieldByName("Label Font");if(b){var c=a.form.getFieldByName("Label Halo"),d=a.form.getFieldByName("Label Offset"),e=a.form.getFieldByName("Label Text"),f=a.form.getFieldByName("Label Overlap"),g=a.form.getFieldByName("Label Placement"),h=a.cartoProperties.get("text-name");h&&"None"!==h?(b&&b.show(),c&&c.show(),d&&d.show(),f&&f.show(),g&&g.show(),e.addClass("border")):(b&&b.hide(),c&&c.hide(),d&&d.hide(),f&&f.hide(),g&&g.hide(),e.removeClass("border"))}},_unbindChanges:function(){this.cartoProperties.unbind(null,null,this)},render:function(){var a=$("<div>").addClass("wrapper"),b=$("<div>").addClass("content");return b.append(this.form.render().el),a.append(b),this.custom_scroll&&(this.removeView(this.custom_scroll),this.custom_scroll.clean()),this.custom_scroll=new cdb.admin.CustomScrolls({el:a,parent:a.parent()}),this.addView(this.custom_scroll),this.$el.html(a),this.showTextFields(),this},renderError:function(a){var b=$("<div>").addClass("wrapper"),c=$("<div>").addClass("no_content").html(a);b.append(c),this.$el.html(b)},_searchFieldByName:function(a){return _.find(this.options.form||this.geomForm,function(b){return b.name===a})},_getNumberColumns:function(){return _.filter(this.options.table.columnNamesByType("number"),function(a){return"cartodb_id"!=a})},_getColumns:function(){return _.filter(this.options.table.columnNames(),function(a){return"cartodb_id"!=a})},_getColorColumns:function(){var a=this,b=[],c=this.options.table.get("schema");return _.each(c,function(c){_.contains(a.options.table.hiddenColumns,c[0])||"date"==c[1]||"geometry"==c[1]||b.push(c[0])}),b}}),cdb.admin.LayersPanel=cdb.ui.common.TabPane.extend({className:"table_panel",animation_time:300,_MAX_LAYERS:3,_MIN_LAYERS:1,_TEXTS:{visualization:{msg:_t("If you want to add multiple layers you need to create a visualization."),error:_t("Error adding that table into the new visualization"),forbidden:_t("The layer can't be added, some users don't have rights to see this table")},remove:{title:_t("Delete this layer"),desc:_t("You are about to delete this layer. Doing so won't remove your table,                 only this visualization will be affected."),ok:_t("Delete layer")},cant_remove:{title:_t("Delete this layer"),desc:_t("You can't remove all layers from the visualization, it needs at least one to make it work."),ok:_t("Close")},sort:{torque:_t("Animated layers must be on top of other layers."),tiled:_t("Tiled layers can't be above animated layers.")},raster:_t("You can't add a raster layer into a visualization"),error:{"default":_t("Something went wrong, try again later")}},events:{"click .add_layer":"_addLayerDialog"},initialize:function(){this.layer_panels=[],this.vis=this.options.vis,this.master_vis=this.options.master_vis,this.map=this.vis.map,this.globalError=this.options.globalError;var a=this.options.user.get("max_layers");isNaN(a)||this._MAX_LAYERS==a||(this._MAX_LAYERS=a),_.bindAll(this,"_sortStart","_sortChange","_sortBeforeStop","_sortLayers","_manageLayers","_checkResize","_moveSortTooltip"),this.map.layers.bind("add",this._newLayer,this),this.map.layers.bind("reset",this._resetLayers,this),this.map.layers.bind("add remove",this._updateLayerPositionLabel,this),$(window).bind("resize",this._checkResize),this.add_related_model(this.map),this._bindSort(),this.model=new cdb.core.Model({open:!0,activeWorkView:"table"}),this.model.bind("change:open",this._setPanelState,this),this.vis.bind("change:type",this.hide,this),this.add_related_model(this.vis),cdb.ui.common.TabPane.prototype.initialize.call(this)},_setPanelState:function(){this.$el[this.model.get("open")?"addClass":"removeClass"]("opened")},_resetLayers:function(){this.removeTabs(),this.layer_panels=[],this._addLayers(this.map.layers)},_addLayers:function(a){this._addLayerAddButton();var b=this;a.each(function(a,c){b._addLayer(a,c)}),this._setDefaultLayer()},_newLayer:function(a){this._addLayer(a)},_addLayer:function(a,b){var c=this;if("CartoDB"==a.get("type")||"torque"==a.get("type")){
var d=new cdb.admin.LayerPanelView({model:a,vis:c.vis,user:c.options.user,globalError:c.options.globalError});d.bind("toggle",c._toggle,c),d.bind("switchTo",c._switchTo,c),d.bind("delete",c._openDeleteLayerDialog,c),d.bind("show",c.show,c),d.bind("destroy",c._removeLayer,c),d.bind("addColumn",c._addColumn,c),c.addTab(a.cid,d,{after:0}),d.setActiveWorkView(c.model.get("activeWorkView")),c.layer_panels.push(d),c._bindLayerTooltip(d),b||(c._switchTo(d,!0),d.setPanelStatus()),c._checkLayers()}},_addColumn:function(){table.tableTab.tableView.addColumn()},_removeLayer:function(a){var b=this.getPane(a),c=this;this.layer_panels=_.filter(this.layer_panels,function(a){return a!=b?a:void 0});var d=function(a){var b=c.getPane(a);c.trigger("switch",b),c.vis.save("active_layer_id",b.dataLayer.id),c.show(b.panels.activeTab),c.unbind("tabEnabled",d)};this.bind("tabEnabled",d),this._unbindLayerTooltip(b),this.removeTab(a),this._checkLayers(),this._manageLayers(),1===c.map.layers.getDataLayers().length&&c.map.layers.last().set("visible",!0)},_setDefaultLayer:function(){var a=this.vis.get("active_layer_id"),b=_.last(this.layer_panels);if(a)for(var c in this.layer_panels){var d=this.layer_panels[c];if(d.dataLayer.id==a){b=d;break}}b&&this._switchTo(b,!1)},_checkLayers:function(){var a=this.map.layers.getDataLayers().length;a>=this._MAX_LAYERS?this._hideLayerButton():this._showLayerButton(),1==a?this._unbindSort():this._bindSort()},_addLayerAddButton:function(){this.$(".add_layer").remove();var a=this.getTemplate("table/views/add_layer");this.$el.prepend(a())},_showLayerButton:function(){this.$("section.add_layer").show()},_hideLayerButton:function(){this.$("section.add_layer").hide()},_addLayerDialog:function(a){if(this.killEvent(a),this.options.user.featureEnabled("new_modals"))if(this.vis.isVisualization())this._createAddLayerDialog();else{var b=this,c=new cdb.editor.CreateVisFirstView({clean_on_hide:!0,enter_to_confirm:!0,model:this.vis,router:window.table_router,title:"A map is required to add layers",explanation:"A map is a shareable mix of layers, styles and queries. You can view all your maps in your dashboard.",success:function(){b._createAddLayerDialog()}});c.appendToBody()}else this.new_layer_dlg&&this.new_layer_dlg.clean(),this.new_layer_dlg=new cdb.admin.CreateLayerDialog({user:this.options.user,data:{},states:cdb.admin.CreateLayerDialog.states,tabs:["layer","file","gdrive","dropbox","twitter","scratch","arcgis","salesforce","success","error"],option:"layer",where:"table"}),this.new_layer_dlg.bind("importCompleted",this._importCompleted,this).bind("importDone",this._importDone,this).bind("showUpgrade",this._showUpgrade,this),this.new_layer_dlg.appendToBody().open({center:!0})},_createAddLayerDialog:function(){var a=new cdb.editor.AddLayerModel({},{vis:this.vis,map:this.map,user:this.options.user}),b=new cdb.editor.AddLayerView({model:a,user:this.options.user});b.appendToBody()},_showUpgrade:function(){var a=new cdb.admin.UpgradeDialog({model:this.options.user,config:cdb.config});this.$el.append(a.render().el),a.open()},_importDone:function(a,b){this._addVisLayer(a,b)},_importCompleted:function(a,b){return"twitter_search"===a.service_name?(this.options.user.fetch(),!1):a.any_table_raster?(this.options.user.fetch(),b.hide(),this.globalError.showError(this._TEXTS.raster,"warn"),!1):void this._addVisLayer(a,b)},_addVisLayer:function(a,b){var c=this,d=a.table_name,e=c.options.user.get("name");b.hide(),this.master_vis.isVisualization()?this.map.addCartodbLayerFromTable(d,e,{vis:c.vis,success:function(){c.map.layers.saveLayers()},error:function(a,b){"forbidden"===a&&c.create_vis_dialog.onCreationError(null,c._TEXTS.visualization.forbidden)}}):(this.create_vis_dialog&&this.create_vis_dialog.clean(),this.create_vis_dialog=new cdb.admin.CreateVizDialog({model:this.master_vis,msg:this._TEXTS.visualization.msg}),this.create_vis_dialog.ok=function(a){c.map.addCartodbLayerFromTable(d,e,{success:function(){c.map.layers.saveLayers({silent:!0});var a=window.table_router.history.length>0&&_.last(window.table_router.history).split("/"),b="/viz/"+c.master_vis.get("id")+"/"+(a[2]||"table");window.table_router.navigate(b,{trigger:!1}),window.table_router.addToHistory()},error:function(){c.create_vis_dialog.onCreationError(null,c._TEXTS.visualization.error)}})},c.create_vis_dialog.appendToBody().open())},_bindLayerTooltip:function(a){var b=this;this._unbindLayerTooltip(a),a&&a.$("a.info").tipsy({live:!0,gravity:"e",offset:0,fade:!0,title:function(){return!b.vis.isVisualization()||b.model.get("open")?"":$(this).find("span.name").text()}})},_unbindLayerTooltip:function(a){a&&a.$("a.info").unbind("mouseenter mouseleave"),a&&a.$("a.info").data("tipsy")&&a.$("a.info").data("tipsy").remove()},_hideLayerTooltip:function(a){a&&a.$("a.info").tipsy("hide")},_unbindSort:function(){this.$el.sortable("destroy")},_bindSort:function(){this._unbindSort(),this.$el.sortable({axis:"y",items:"> .layer_panel",handle:".layer-info a.info",contaiment:"parent",opacity:.5,start:this._sortStart,change:this._sortChange,beforeStop:this._sortBeforeStop,update:this._sortLayers,forcePlaceholderSize:!1})},_sortStart:function(a,b){this.sort_actions={original_layer_pos:$(b.item).index(),$layer:$(b.item)};var c=$(b.item).outerHeight();$(b.placeholder).outerHeight(c)},_sortChange:function(a,b){var c=_.contains(this.map.layers.pluck("type"),"torque"),d="torque"==$(b.item).attr("layer-type"),e=$(b.item).outerHeight();c?d?(1==b.placeholder.index()?(this.cancelSort=!1,this._removeSortTooltip()):(this.cancelSort=!0,this.sortTooltip||this._addSortTooltip(a,"torque")),this.$("section.add_layer").after($(b.placeholder).outerHeight(e).css("display","block"))):1!=b.placeholder.index()?(this.cancelSort=!1,$(b.placeholder).outerHeight(e).css("display","block"),this._removeSortTooltip()):(this.cancelSort=!0,this.$("section.layer_panel:eq("+this.sort_actions.original_layer_pos+")").before($(b.placeholder).outerHeight(e).css("display","block")),this.sortTooltip||this._addSortTooltip(a,"tiled")):(this.cancelSort=!1,$(b.placeholder).outerHeight(e).css("display","block"))},_sortBeforeStop:function(){this._removeSortTooltip(),this.cancelSort&&this.$el.sortable("cancel"),this.cancelSort=!1},_addSortTooltip:function(a,b){this.sortTooltip=new cdb.admin.TooltipTrails({className:"tooltip-trails",msg:this._TEXTS.sort[b]}),this.sort_actions.$layer.bind("mousemove",this._moveSortTooltip),this.$el.append(this.sortTooltip.render().el),this.sortTooltip.show({left:a.pageX-this.$el.offset().left,top:a.pageY-this.$el.offset().top}),this.addView(this.sortTooltip)},_moveSortTooltip:function(a){var b=this.$el.offset(),c={left:a.pageX-b.left,top:a.pageY-b.top};this.sortTooltip.move(c)},_removeSortTooltip:function(){this.sort_actions.$layer.unbind("mousemove",this._moveSortTooltip),this.sortTooltip&&(this.sortTooltip.clean(),this.removeView(this.sortTooltip),delete this.sortTooltip)},_sortLayers:function(){var a=this,b=1,c=a.map.layers.size();this.$el.children().each(function(d,e){var f=e.getAttribute("model-id");if(f){var g=a.map.layers.get(f);g&&(g.set({order:c-b},{silent:!0}),b++)}}),this.map.layers.unbind("reset",this._resetLayers,this),this.map.layers.saveLayers({complete:function(){a._updateLayerPositionLabel(),a.map.layers.bind("reset",a._resetLayers,a)}})},_updateLayerPositionLabel:function(){_.each(this.layer_panels,function(a){a.setLayerOrder(a.model)})},_manageLayers:function(){var a=this.map.layers.getDataLayers().length;if(0==a)return!1;var b=this.activePane.$el;this.$(".layer_panel").removeClass("active"),b.addClass("active"),this.$(".layer_panel").not(".layer_panel.active").css({height:66});var c=b.prevAll(".layer_panel").size(),d=0==c?0:43*c,e=b.nextAll(".layer_panel").size(),f=0==e?0:43*e,g=-15;this._MAX_LAYERS==a&&(g+=43),b.css({height:this.$el.height()-(d+f)+g})},_checkResize:function(a){this.resize&&clearTimeout(this.resize);var b=this;this.resize=setTimeout(b._manageLayers,100)},show:function(a){var b=this.getActivePane();b.tabs.activate(a),b.panels.active(a),this.movePanel()},movePanel:function(){var a=this.getActivePane();if(!a)return!1;this._hideDropdowns();var b=a.panels.getActivePane(),c=b.getModuleAction();cdb.god.trigger("panel_action",c.type),this.model.set("open",!0),this.$el.animate({width:c.width,right:0},this.animation_time,function(){cdb.god.trigger("end_"+c.type)})},hide:function(a){var b=this.$el.width();this.getActivePane();this._hideDropdowns(),cdb.god.trigger("panel_action","hide"),this.model.set("open",!1),this.$el.animate({right:63-b},this.animation_time)},_hideDropdowns:function(){cdb.god.trigger("closeDialogs"),cdb.god.trigger("closeDialogs:color")},_switchTo:function(a,b){this.activePane&&this.activePane.unbind("tabChanged",null,null),a.bind("tabChanged",this.movePanel,this),this.activePane==a&&(void 0!==b?b===!0?this.show(a.panels.activeTab):this.hide():this.model.get("open")?this.hide():this.show(a.panels.activeTab)),this.activePane!=a&&(this._hideLayerTooltip(a),this.active(a.dataLayer.cid),a.dataLayer.id&&this.vis.get("active_layer_id")!=a.dataLayer.id&&this.vis.save("active_layer_id",a.dataLayer.id),void 0===b&&this.show(a.panels.activeTab)),this.trigger("switch",a),this._manageLayers()},_toggle:function(a){this.model.get("open")&&a==this.getActivePane().panels.activeTab?this.hide(a):this.show(a)},_openDeleteLayerDialog:function(a){if(this.options.user.featureEnabled("new_modals")){var b=new cdb.editor.DeleteLayerView({model:a.model});return void b.appendToBody()}var c=this,d=!0;this.map.layers.getDataLayers().length<=this._MIN_LAYERS&&(d=!1),this.remove_dlg&&this.remove_dlg.clean(),this.remove_dlg=new cdb.admin.BaseDialog({title:c._TEXTS[d?"remove":"cant_remove"].title,description:c._TEXTS[d?"remove":"cant_remove"].desc,template_name:"old_common/views/confirm_dialog",clean_on_hide:!0,enter_to_confirm:!0,ok_button_classes:"right button grey",ok_title:c._TEXTS[d?"remove":"cant_remove"].ok,cancel_button_classes:"underline margin15 "+(d?"":"hide"),modal_type:"confirmation",width:500}),d&&(this.remove_dlg.ok=function(){a.model.destroy({error:function(){c.globalError.showError(c._TEXTS.error["default"],"error",3e3)},wait:!0})}),this.remove_dlg.appendToBody().open()},setActiveWorkView:function(a){this.hide(),this.model.set("activeWorkView",a),this.each(function(b,c){c.setActiveWorkView(a)})},clean:function(){$(window).unbind("resize",this._checkResize),this.resize&&clearTimeout(this.resize),this._unbindSort(),cdb.ui.common.TabPane.prototype.clean.call(this)}}),cdb.admin.AssetManager=cdb.admin.BaseDialog.extend({_TEXTS:{title:_t("Select a {marker_kind} image"),ok:{assets:_t("Set image"),makis:_t("Set image"),file:_t("Upload image"),dropbox:_t("Upload image")},upload:{error:_t("There was a problem with the upload, please try it again."),url_error:_t("The url provided was not valid, please try another one.")}},_UPLOADER:{url:"/api/v1/users/<%- id %>/assets",uploads:1,maxFileSize:1048576,acceptFileTypes:["png","svg","jpeg","jpg"],acceptSync:void 0,resolution:"1024x1024"},initialize:function(){if(_.bindAll(this,"_onUploadStart","_onUploadAbort","_onUploadAdd","_onUploadComplete","_onUploadError"),this.model=new cdb.core.Model({state:"idle"}),this.model.bind("change:state",this._checkOKButton,this),this.user=this.options.user,this.kind=this.options.kind,!this.kind)throw new Error("kind should be passed");this.collection=new cdb.admin.Assets([],{user:this.user}),_.extend(this.options,{title:i18n.format(this._TEXTS.title,{marker_kind:this.kind}),description:"",template_name:"old_common/views/dialog_base",clean_on_hide:!0,ok_button_classes:"button grey disabled",cancel_button_classes:"hide",ok_title:this._TEXTS.ok,modal_type:"creation asset_manager",width:"marker"===this.kind?740:643}),this.constructor.__super__.initialize.apply(this)},render_content:function(){var a=this.$content=$("<div>");return this.temp_content=this.getTemplate("table/views/asset_manager/asset_manager"),a.append(this.temp_content({kind:this.kind})),this.init_assets(a),this.render_option_tabs(a),this._init_uploader(a),a},render_option_tabs:function(a){this.upload_tabs=new cdb.admin.Tabs({el:a.find(".upload-tabs"),slash:!0}),this.addView(this.upload_tabs),this.upload_panes=new cdb.ui.common.TabPane({el:a.find(".upload-panes")}),this.upload_panes.bind("tabEnabled",this._checkOKButton,this),this.addView(this.upload_panes),this.upload_tabs.linkToPanel(this.upload_panes),this._renderAssetsPane(a),"marker"===this.kind&&(this._renderMakisPane(a),this._renderSimpleiconPane(a),this._renderPinmapsiconPane(a)),this._renderFilePane(a),this._renderDropboxPane(a),a.append(this.upload_panes.render()),this.upload_panes.active("marker"===this.kind?"simpleicon":"file")},_renderAssetsPane:function(){this.assetsPane=new cdb.admin.AssetsPane({collection:this.collection,kind:this.kind})},_renderSimpleiconPane:function(){this.simpleiconPane=new cdb.admin.StaticAssetsPane({collection:this.collection,kind:this.kind,icons:simpleicon.icons,disclaimer:simpleicon.disclaimer,folder:"simpleicon",size:""}),this.simpleiconPane.bind("fileChosen",this._checkOKButton,this),this.upload_panes.addTab("simpleicon",this.simpleiconPane),this.upload_panes.bind("tabEnabled:simpleicon",function(){this.simpleiconPane.render(),this.upload_panes.unbind("tabEnabled:simpleicon",null,null)},this)},_renderPinmapsiconPane:function(){this.pinmapsPane=new cdb.admin.StaticAssetsPane({collection:this.collection,kind:this.kind,icons:pin_maps.icons,disclaimer:pin_maps.disclaimer,folder:"pin-maps",size:""}),this.pinmapsPane.bind("fileChosen",this._checkOKButton,this),this.upload_panes.addTab("pin-maps",this.pinmapsPane),this.upload_panes.bind("tabEnabled:pin-maps",function(){this.pinmapsPane.render(),this.upload_panes.unbind("tabEnabled:pin-maps",null,null)},this)},_renderMakisPane:function(){this.makisPane=new cdb.admin.StaticAssetsPane({collection:this.collection,kind:this.kind,icons:maki_icons.icons,disclaimer:maki_icons.disclaimer,folder:"maki-icons",size:"18"}),this.makisPane.bind("fileChosen",this._checkOKButton,this),this.upload_panes.addTab("maki",this.makisPane),this.upload_panes.bind("tabEnabled:maki",function(){this.makisPane.render(),this.upload_panes.unbind("tabEnabled:maki",null,null)},this)},_renderFilePane:function(){this.filePane=new cdb.admin.ImportFilePane({template:cdb.templates.getTemplate("table/views/asset_manager/import_asset_file"),maxFileSize:this._UPLOADER.maxFileSize,maxUploadFiles:this._UPLOADER.uploads,acceptFileTypes:this._UPLOADER.acceptFileTypes,acceptSync:this._UPLOADER.acceptSync,resolution:this._UPLOADER.resolution}),this.filePane.bind("fileChosen",this._uploadData,this),this.filePane.bind("valueChange",this._checkOKButton,this),this.upload_panes.addTab("file",this.filePane)},_renderDropboxPane:function(a){cdb.config.get("dropbox_api_key")?(this.dropboxPane=new cdb.admin.ImportDropboxPane({template:cdb.templates.getTemplate("table/views/asset_manager/import_asset_dropbox"),acceptFileTypes:this._UPLOADER.acceptFileTypes,acceptSync:this._UPLOADER.acceptSync}),this.dropboxPane.bind("valueChange",this._uploadData,this),this.upload_panes.addTab("dropbox",this.dropboxPane)):a.find("a.dropbox").parent().remove()},init_assets:function(){this.collection.bind("add remove reset",this._onAssetsFetched,this),this.collection.bind("change",this._checkOKButton,this),this.collection.fetch()},_onAssetsFetched:function(){var a=this.collection.where({kind:this.kind}).length;0===a?(this.upload_tabs.disable("assets"),this.upload_panes.removeTab("assets"),this.upload_panes.active("marker"===this.kind?"simpleicon":"file")):(this.upload_tabs.enable("assets"),this.upload_panes.getPane("assets")||this.upload_panes.addTab("assets",this.assetsPane),this.upload_panes.active("assets")),this.$(".dialog-content > div.assets").remove(),this.$("div.uploader, a.ok").show()},_init_uploader:function(a){this.$loader=a.find("div.upload-progress"),this.$list=a.find("div.dialog-content"),this.$import=a.find("div.upload"),this.$error=this.$("section.modal.error"),this.$importation=this.$("section.modal:eq(0)");var b=this.$upload=a.find("form.dialog-uploader");return b.fileupload({dropZone:this.$(".non-dropzone"),url:_.template(cdb.config.prefixUrl()+this._UPLOADER.url)(this.user),paramName:"filename",progressInterval:100,bitrateInterval:500,maxFileSize:this._UPLOADER.maxFileSize,autoUpload:!0,limitMultiFileUploads:this._UPLOADER.uploads,limitConcurrentUploads:this._UPLOADER.uploads,acceptFileTypes:this._setValidFileExtensions(this._UPLOADER.acceptFileTypes),add:this._onUploadAdd,start:this._onUploadStart,done:this._onUploadComplete,fail:this._onUploadError,formData:{kind:this.kind}}),this.uploader=this.$upload.data("fileupload"),this.$content},_setValidFileExtensions:function(a){return RegExp("(.|/)("+a.join("|")+")$","i")},_uploadData:function(a){"file"===a.type?this.$upload.fileupload("add",{files:a.value}):this._uploadFromUrl(a)},_uploadFromUrl:function(a){if("url"!=a.type){var b={name:a.value};if(this.uploader._validate([b]),b.error)return this._onUploadError(null,{files:[b]}),!1}this.upload_panes.active("file"),this._changeState("uploading"),this.model.set("state","uploading");var c=this;$.ajax({type:"POST",url:_.template(cdb.config.prefixUrl()+this._UPLOADER.url)(this.user),data:{url:a.value,kind:this.kind},success:function(a){c._onUploadComplete()},error:function(b){var d={error:"connection",name:a.value};c._onUploadError(null,{jqXHR:b,files:[d]})}})},_onUploadStart:function(a,b){this.model.set("state","uploading"),this._changeState("uploading")},_onUploadAbort:function(a){this.model.set("state","idle"),a&&a.preventDefault(),this.jqXHR.abort()},_onUploadComplete:function(){this.model.set("state","idle"),this.collection.fetch(),this.filePane.cleanInput(),this._changeState("reset")},_onUploadAdd:function(a,b){1==b.originalFiles.length&&(this.jqXHR=b.submit())},_onUploadError:function(a,b){if(this.model.set("state","idle"),this._changeState("reset"),this._changeState("reset"),this.filePane){this.upload_panes.active("file");var c=b.jqXHR&&b.jqXHR.responseText&&-1!=b.jqXHR.responseText.search("file is too big");c&&(b.errorThrown="resolution"),"Bad Request"==b.errorThrown&&(b.files[0].error="connection"),"resolution"==b.errorThrown&&(b.files[0].error="resolution"),"abort"==b.errorThrown&&(b.files[0].error="abort"),this.filePane._onUploadError(null,{files:b.files})}},_checkOKButton:function(){var a=this.upload_panes.activePane,b=this.upload_panes.activeTab,c=this.model.get("state"),d=a.getValue(),e=this._TEXTS.ok[b];this.$("a.ok").text(e)[d&&"idle"===c?"removeClass":"addClass"]("disabled")},_showLoader:function(){this.$loader.addClass("active")},_hideLoader:function(){this.$loader.removeClass("active creating uploading")},_changeState:function(a){var b=cdb.admin.upload_asset_states[a];this.$importation.find("a.close").stop()[b.hideClose?"fadeOut":"fadeIn"](),this.$list.stop().animate(b.list.animate.properties,b.list.animate.options);var c=this.$list.position();b.loader.progress&&(this.$loader.find("span").width(b.loader.progress+"%"),this.$loader.find("p").text(b.loader.text)),b.loader.animate.properties.top=_.template(String(b.loader.animate.properties.top),{top:c.top}),"reset"==a&&(b.loader.animate.properties.top=b.loader.animate.properties.top-20),this.$loader.removeClass(b.loader.removeClasses).addClass(b.loader.addClasses).css(b.loader.css).stop().animate(b.loader.animate.properties,b.loader.animate.options),b.stop?this.$loader.find("a.stop").show():this.$loader.find("a.stop").hide(),b.showLoader?this._showLoader():this._hideLoader()},_ok:function(a){a&&a.preventDefault();var b=this.upload_panes.activePane,c=this.upload_panes.activeTab,d=this.model.get("state"),e=b.getValue();this._TEXTS.ok[c];return"idle"===d&&e?("file"===c||"dropbox"===c?b.submitUpload():(this.trigger("fileChosen",e),this.hide()),!1):!1},open:function(a){this.trigger("will_open",this),this.$(".modal").css({opacity:"0",marginTop:"120px"}),this.$(".mamufas").fadeIn(),this.$(".modal").animate({marginTop:"70px",opacity:1},300)},clean:function(){this.$upload.fileupload("destroy"),this.$upload.unbind("mouseleave"),$(document).unbind("keydown",this._keydown),this.jqXHR&&this._onUploadAbort(),cdb.ui.common.Dialog.prototype.clean.call(this)}}),cdb.admin.AssetsItem=cdb.core.View.extend({_SIZE:42,_MIN_SIZE:32,tagName:"li",className:"assets-item",options:{template:"table/views/asset_manager/asset_item"},events:{"click a.delete":"_openDropdown",click:"_onClick"},initialize:function(){this.template=cdb.templates.getTemplate(this.options.template),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.append(this.template(this.model.toJSON())),this._calcBkgImg(this.model.get("public_url")),this},_initBinds:function(){_.bindAll(this,"_onClick","_openDropdown"),this.model.bind("change:state",this._changeState,this),this.model.bind("destroy",this.remove,this)},_calcBkgImg:function(a){var b=new Image,c=this;b.onload=function(){var a=this.width,b=this.height,d=c.$("a.image");c.$el.css("background","none"),"marker"===c.model.get("kind")?b>c._SIZE?d.css({"background-size":"cover","background-origin":"content-box"}):(a||b)<c._MIN_SIZE&&d.css({"background-size":c._MIN_SIZE+"px"}):(a||b)>c._SIZE?d.css({"background-size":"cover","background-origin":"content-box"}):d.css({"background-position":"0 0","background-repeat":"repeat"})},b.onerror=function(a){cdb.log.info(a)},b.src=a},_onClick:function(a){this.killEvent(a),"selected"!=this.model.get("state")&&"destroying"!=this.model.get("state")&&(this.trigger("selected",this.model),this.model.set("state","selected"))},_changeState:function(){this.$el.removeClass("is-idle is-selected is-destroying").addClass("is-"+this.model.get("state"))},_openDropdown:function(a){var b=this;this.killEvent(a),a.stopImmediatePropagation(),this.dropdown=new cdb.admin.DropdownMenu({className:"dropdown border tiny",target:$(a.target),width:196,speedIn:150,speedOut:300,template_base:"table/views/asset_manager/remove_asset",vertical_position:"down",horizontal_position:"left",horizontal_offset:3,tick:"left"}),this.dropdown.bind("optionClicked",function(a){a.preventDefault(),b._deleteAsset()}),$("body").append(this.dropdown.render().el),this.dropdown.open(a),cdb.god.bind("closeDialogs",this.dropdown.hide,this.dropdown)},_deleteAsset:function(){var a=this;this.model.set("state","destroying"),this.model.destroy({success:function(){},error:function(){a.model.set("state","idle")}})}}),cdb.admin.AssetsPane=cdb.core.View.extend({tagName:"div",className:"assets",initialize:function(){this.template=this.options.template||cdb.templates.getTemplate("table/views/asset_manager/uploaded_assets_pane"),this.model=new cdb.core.Model({value:""}),this.collection.bind("add reset",this.render,this)},render:function(){this.clearSubViews(),this.$el.html(this.template());var a=this.collection.where({kind:this.options.kind}),b=this;return _(a).each(function(a){var c=new cdb.admin.AssetsItem({model:a});c.bind("selected",b._selectItem,b),b.$("ul").append(c.render().el),b.addView(c)}),this._selectLastAsset(),this},_selectLastAsset:function(){var a;this.collection.each(function(b){"selected"===b.get("state")&&b.set("state","idle"),b.get("kind")==this.options.kind&&(a=b)},this),a&&(this.model.set("value",a.get("public_url")),a.set("state","selected"))},_selectItem:function(a){this.model.set("value",a.get("public_url")),this._unselectItems(a)},_unselectItems:function(a){this.collection.each(function(b){b!=a&&"selected"==b.get("state")&&b.set("state","idle")})},getValue:function(){return this.model.get("value")}});var maki_icons={disclaimer:_t('<a href="https://github.com/mapbox/maki" target="_blank">Maki Icons</a>, an open source project by <a href="http://mapbox.com" target="_blank">Mapbox</a>'),icons:[{name:"Circle stroked",icon:"circle-stroked"},{name:"Circle solid",icon:"circle"},{name:"Square stroked",icon:"square-stroked"},{name:"Square solid",icon:"square"},{name:"Triangle stroked",icon:"triangle-stroked"},{name:"Triangle solid",icon:"triangle"},{name:"Star stroked",icon:"star-stroked"},{name:"Star solid",icon:"star"},{name:"Cross",icon:"cross"},{name:"Marker Stroke",icon:"marker-stroked"},{name:"Marker Solid",icon:"marker"},{name:"Religious Jewish",icon:"religious-jewish"},{name:"Religious Christian",icon:"religious-christian"},{name:"Religious Muslim",icon:"religious-muslim"},{name:"Cemetery",icon:"cemetery"},{name:"Rocket",icon:"rocket"},{name:"Airport",icon:"airport"},{name:"Heliport",icon:"heliport"},{name:"Rail",icon:"rail"},{name:"Rail Metro",icon:"rail-metro"},{name:"Rail Light",icon:"rail-light"},{name:"Bus",icon:"bus"},{name:"Fuel",icon:"fuel"},{name:"Parking",tags:["parking","transportation"],icon:"parking"},{name:"Parking Garage",tags:["parking","transportation","garage"],icon:"parking-garage"},{name:"Airfield",tags:["airfield","airport","plane","landing strip"],icon:"airfield"},{name:"Roadblock",tags:["roadblock","stop","warning","dead end"],icon:"roadblock"},{name:"Ferry",tags:["ship","boat","water","ferry","transportation"],icon:"ferry"},{name:"Harbor",tags:["marine","dock","water","wharf"],icon:"harbor"},{name:"Bicycle",tags:["cycling","cycle","transportation"],icon:"bicycle"},{name:"Park",tags:["recreation","park","forest","tree","green","woods","nature"],icon:"park"},{name:"Park 2",tags:["recreation","park","forest","tree","green","woods","nature"],icon:"park2"},{name:"Museum",tags:["recreation","museum","tourism"],icon:"museum"},{name:"Lodging",tags:["lodging","hotel","recreation","motel","tourism"],icon:"lodging"},{name:"Monument",tags:["recreation","statue","monument","tourism"],icon:"monument"},{name:"Zoo",tags:["recreation","zoo","animal","giraffe"],icon:"zoo"},{name:"Garden",tags:["recreation","garden","park","flower","nature"],icon:"garden"},{name:"Campsite",tags:["recreation","campsite","camp","camping","tent","nature"],icon:"campsite"},{name:"Theatre",tags:["recreation","theatre","theater","entertainment","play","performance"],icon:"theatre"},{name:"Art gallery",tags:["art","center","museum","gallery","creative","recreation","entertainment","studio"],icon:"art-gallery"},{name:"Pitch",tags:["pitch","track","athletic","sports","field"],icon:"pitch"},{name:"Soccer",tags:["soccer","sports"],icon:"soccer"},{name:"American Football",tags:["football","sports"],icon:"america-football"},{name:"Tennis",tags:["tennis","court","ball","sports"],icon:"tennis"},{name:"Basketball",tags:["basketball","ball","sports"],icon:"basketball"},{name:"Baseball",tags:["baseball","softball","ball","sports"],icon:"baseball"},{name:"Golf",tags:["golf","sports","course"],icon:"golf"},{name:"Swimming",tags:["swimming","water","swim","sports"],icon:"swimming"},{name:"Cricket",tags:["cricket","sports"],icon:"cricket"},{name:"Skiing",tags:["winter","skiing","ski","sports"],icon:"skiing"},{name:"School",tags:["school","highschool","elementary","children","amenity","middle"],icon:"school"},{name:"College",tags:["college","school","amenity","university"],icon:"college"},{name:"Library",tags:["library","books","amenity"],icon:"library"},{name:"Post",tags:["post","office","amenity","mail","letter"],icon:"post"},{name:"Fire station",tags:["fire","station","amenity"],icon:"fire-station"},{name:"Town hall",tags:["townhall","mayor","building","amenity","government"],icon:"town-hall"},{name:"Police",tags:["police","jail","arrest","amenity","station"],icon:"police"},{name:"Prison",tags:["prison","jail","amenity"],icon:"prison"},{name:"Embassy",tags:["embassy","diplomacy","consulate","amenity","flag"],icon:"embassy"},{name:"Beer",tags:["bar","beer","drink","commercial","biergarten","pub"],icon:"beer"},{name:"Restaurant",tags:["restaurant","commercial"],icon:"restaurant"},{name:"Cafe",tags:["cafe","coffee","commercial","tea"],icon:"cafe"},{name:"Shop",tags:["shop","mall","commercial","store"],icon:"shop"},{name:"Fast Food",tags:["food","fast","commercial","burger","drive-through"],icon:"fast-food"},{name:"Bar",tags:["bar","drink","commercial","club","martini","lounge"],icon:"bar"},{name:"Bank",tags:["bank","atm","commercial","money"],icon:"bank"},{name:"Grocery",tags:["food","grocery","commercial","store","market"],icon:"grocery"},{name:"Cinema",tags:["cinema","theatre","film","movie","commercial","theater","entertainment"],icon:"cinema"},{name:"Pharmacy",tags:["pharmacy","drugs","medication","social","medicine","prescription"],icon:"pharmacy"},{name:"Hospital",tags:["hospital","health","medication","social","medicine","medical","clinic"],icon:"hospital"},{name:"Danger",tags:["minefield","landmine","disaster","dangerous","hazard"],icon:"danger"},{name:"Industrial",tags:["industrial","factory","property","building"],icon:"industrial"},{name:"Warehouse",tags:["warehouse","property","storage","building"],icon:"warehouse"},{name:"Commercial",tags:["commercial","property","business","building"],icon:"commercial"},{name:"Building",tags:["building","property","structure","business","building"],icon:"building"},{name:"Place of worship",tags:["religion","ceremony","religious","nondenominational","church","temple"],icon:"place-of-worship"},{name:"Alcohol shop",tags:["alcohol","liquor","store","shop","beer","wine","vodka"],icon:"alcohol-shop"},{name:"Logging",tags:["logger","chainsaw","woods","industry"],icon:"logging"},{name:"Oil well",tags:["oil","natural","environment","industry","resources"],icon:"oil-well"},{name:"Slaughterhouse",tags:["cows","cattle","food","meat","industry","resources"],icon:"slaughterhouse"},{name:"Dam",tags:["water","natural","hydro","hydroelectric","energy","environment","industry","resources"],icon:"dam"},{name:"Water",tags:["water","natural","hydro","lake","river","ocean","resources"],icon:"water"},{name:"Wetland",tags:["water","swamp","natural"],icon:"wetland"},{name:"Disability",tags:["handicap","wheelchair","access"],icon:"disability"},{name:"Telephone",tags:["payphone","call"],icon:"telephone"},{name:"Emergency Telephone",tags:["payphone","danger","safety","call"],icon:"emergency-telephone"},{name:"Toilets",tags:["bathroom","men","women","sink","washroom","lavatory"],icon:"toilets"},{name:"Waste Basket",tags:["trash","rubbish","bin","garbage"],icon:"waste-basket"},{name:"Music",tags:["stage","performance","band","concert","venue"],icon:"music"},{name:"Land Use",tags:["zoning","usage","area"],icon:"land-use"},{name:"City",tags:["area","point","place","urban"],icon:"city"},{name:"Town",tags:["area","point","place","small"],icon:"town"},{name:"Village",tags:["area","point","place","small","rural"],icon:"village"},{name:"Farm",tags:["building","farming","crops","plants","agriculture","rural"],icon:"farm"},{name:"Bakery",tags:["bakery","pastry","croissant","food","shop","bread"],icon:"bakery"},{name:"Dog Park",tags:["dog","pet"],icon:"dog-park"},{name:"Lighthouse",tags:["building","navigation","nautical","ocean","logistics"],icon:"lighthouse"},{name:"Clothing Store",tags:["clothing","store","shop"],icon:"clothing-store"},{name:"Polling Place",icon:"polling-place"},{name:"Playground",icon:"playground"},{name:"Entrance",icon:"entrance"},{name:"Heart",icon:"heart"},{name:"London Underground",icon:"london-underground"},{name:"Minefield",icon:"minefield"},{name:"Rail Underground",icon:"rail-underground"},{name:"Rail Above",icon:"rail-above"},{name:"Camera",icon:"camera"},{name:"Laundry",icon:"laundry"},{name:"Car",icon:"car"},{name:"Suitcase",icon:"suitcase"},{name:"Hairdresser",icon:"hairdresser"},{name:"Chemist",icon:"chemist"},{name:"Mobile phone",icon:"mobilephone"},{name:"Scooter",icon:"scooter"}]},patterns={icons:[{kind:"pattern",ext:"png",name:"diagonal_1px_fast",icon:"diagonal_1px_fast"},{kind:"pattern",ext:"png",name:"diagonal_1px_med",icon:"diagonal_1px_med"},{kind:"pattern",ext:"png",name:"diagonal_1px_slow",icon:"diagonal_1px_slow"},{kind:"pattern",ext:"png",name:"diagonal_2px_fast",icon:"diagonal_2px_fast"},{kind:"pattern",ext:"png",name:"diagonal_2px_med",icon:"diagonal_2px_med"},{kind:"pattern",ext:"png",name:"diagonal_2px_slow",icon:"diagonal_2px_slow"},{kind:"pattern",ext:"png",
name:"donuts_4px_med",icon:"donuts_4px_med"},{kind:"pattern",ext:"png",name:"donuts_6px_med",icon:"donuts_6px_med"},{kind:"pattern",ext:"png",name:"dots_2px_fast",icon:"dots_2px_fast"},{kind:"pattern",ext:"png",name:"dots_2px_med",icon:"dots_2px_med"},{kind:"pattern",ext:"png",name:"dots_2px_slow",icon:"dots_2px_slow"},{kind:"pattern",ext:"png",name:"dots_4px_fast",icon:"dots_4px_fast"},{kind:"pattern",ext:"png",name:"dots_4px_med",icon:"dots_4px_med"},{kind:"pattern",ext:"png",name:"dots_6px_fast",icon:"dots_6px_fast"},{kind:"pattern",ext:"png",name:"dots_6px_med",icon:"dots_6px_med"}]},pin_maps={disclaimer:_t('<a href="http://www.flaticon.com/packs/pins-of-maps/" target="_blank">Pin Maps</a>, icons by <a href="http://freepik.com" target="_blank">freepik.com</a>'),icons:[{name:"air",icon:"air"},{name:"air2",icon:"air2"},{name:"anchor2",icon:"anchor2"},{name:"anchor3",icon:"anchor3"},{name:"bag1",icon:"bag1"},{name:"bag2",icon:"bag2"},{name:"balloon",icon:"balloon"},{name:"black41",icon:"black41"},{name:"boat1",icon:"boat1"},{name:"book16",icon:"book16"},{name:"building",icon:"building"},{name:"burger",icon:"burger"},{name:"bus6",icon:"bus6"},{name:"caravan2",icon:"caravan2"},{name:"church1",icon:"church1"},{name:"church3",icon:"church3"},{name:"club",icon:"club"},{name:"cocktail3",icon:"cocktail3"},{name:"coffee2",icon:"coffee2"},{name:"dark11",icon:"dark11"},{name:"disabled",icon:"disabled"},{name:"dog2",icon:"dog2"},{name:"favourite1",icon:"favourite1"},{name:"flag5",icon:"flag5"},{name:"flat",icon:"flat"},{name:"hotel",icon:"hotel"},{name:"information3",icon:"information3"},{name:"location10",icon:"location10"},{name:"location11",icon:"location11"},{name:"location5",icon:"location5"},{name:"location6",icon:"location6"},{name:"location7",icon:"location7"},{name:"location8",icon:"location8"},{name:"location9",icon:"location9"},{name:"marker2",icon:"marker2"},{name:"marker3",icon:"marker3"},{name:"marker4",icon:"marker4"},{name:"marker5",icon:"marker5"},{name:"marker6",icon:"marker6"},{name:"marker7",icon:"marker7"},{name:"monument2",icon:"monument2"},{name:"mountains",icon:"mountains"},{name:"p",icon:"p"},{name:"petrol",icon:"petrol"},{name:"petrol2",icon:"petrol2"},{name:"pharmacy",icon:"pharmacy"},{name:"phone13",icon:"phone13"},{name:"pin10",icon:"pin10"},{name:"pins",icon:"pins"},{name:"pins1",icon:"pins1"},{name:"pins10",icon:"pins10"},{name:"pins11",icon:"pins11"},{name:"pins12",icon:"pins12"},{name:"pins13",icon:"pins13"},{name:"pins14",icon:"pins14"},{name:"pins15",icon:"pins15"},{name:"pins16",icon:"pins16"},{name:"pins17",icon:"pins17"},{name:"pins18",icon:"pins18"},{name:"pins19",icon:"pins19"},{name:"pins2",icon:"pins2"},{name:"pins20",icon:"pins20"},{name:"pins21",icon:"pins21"},{name:"pins22",icon:"pins22"},{name:"pins23",icon:"pins23"},{name:"pins24",icon:"pins24"},{name:"pins25",icon:"pins25"},{name:"pins26",icon:"pins26"},{name:"pins27",icon:"pins27"},{name:"pins28",icon:"pins28"},{name:"pins29",icon:"pins29"},{name:"pins3",icon:"pins3"},{name:"pins30",icon:"pins30"},{name:"pins31",icon:"pins31"},{name:"pins32",icon:"pins32"},{name:"pins33",icon:"pins33"},{name:"pins34",icon:"pins34"},{name:"pins35",icon:"pins35"},{name:"pins36",icon:"pins36"},{name:"pins37",icon:"pins37"},{name:"pins38",icon:"pins38"},{name:"pins39",icon:"pins39"},{name:"pins4",icon:"pins4"},{name:"pins40",icon:"pins40"},{name:"pins41",icon:"pins41"},{name:"pins42",icon:"pins42"},{name:"pins43",icon:"pins43"},{name:"pins44",icon:"pins44"},{name:"pins45",icon:"pins45"},{name:"pins46",icon:"pins46"},{name:"pins47",icon:"pins47"},{name:"pins48",icon:"pins48"},{name:"pins49",icon:"pins49"},{name:"pins5",icon:"pins5"},{name:"pins50",icon:"pins50"},{name:"pins51",icon:"pins51"},{name:"pins52",icon:"pins52"},{name:"pins53",icon:"pins53"},{name:"pins54",icon:"pins54"},{name:"pins55",icon:"pins55"},{name:"pins56",icon:"pins56"},{name:"pins57",icon:"pins57"},{name:"pins58",icon:"pins58"},{name:"pins59",icon:"pins59"},{name:"pins6",icon:"pins6"},{name:"pins60",icon:"pins60"},{name:"pins61",icon:"pins61"},{name:"pins62",icon:"pins62"},{name:"pins63",icon:"pins63"},{name:"pins64",icon:"pins64"},{name:"pins65",icon:"pins65"},{name:"pins66",icon:"pins66"},{name:"pins67",icon:"pins67"},{name:"pins68",icon:"pins68"},{name:"pins69",icon:"pins69"},{name:"pins7",icon:"pins7"},{name:"pins70",icon:"pins70"},{name:"pins71",icon:"pins71"},{name:"pins72",icon:"pins72"},{name:"pins73",icon:"pins73"},{name:"pins74",icon:"pins74"},{name:"pins75",icon:"pins75"},{name:"pins76",icon:"pins76"},{name:"pins77",icon:"pins77"},{name:"pins78",icon:"pins78"},{name:"pins79",icon:"pins79"},{name:"pins8",icon:"pins8"},{name:"pins80",icon:"pins80"},{name:"pins81",icon:"pins81"},{name:"pins82",icon:"pins82"},{name:"pins83",icon:"pins83"},{name:"pins84",icon:"pins84"},{name:"pins85",icon:"pins85"},{name:"pins86",icon:"pins86"},{name:"pins87",icon:"pins87"},{name:"pins88",icon:"pins88"},{name:"pins89",icon:"pins89"},{name:"pins9",icon:"pins9"},{name:"pins90",icon:"pins90"},{name:"pins91",icon:"pins91"},{name:"position",icon:"position"},{name:"restaurant2",icon:"restaurant2"},{name:"right14",icon:"right14"},{name:"road3",icon:"road3"},{name:"shop2",icon:"shop2"},{name:"shopping8",icon:"shopping8"},{name:"sit",icon:"sit"},{name:"ski1",icon:"ski1"},{name:"soccer1",icon:"soccer1"},{name:"suitcase1",icon:"suitcase1"},{name:"suitcase2",icon:"suitcase2"},{name:"telephone3",icon:"telephone3"},{name:"tent",icon:"tent"},{name:"tent1",icon:"tent1"},{name:"train3",icon:"train3"},{name:"train4",icon:"train4"},{name:"turn7",icon:"turn7"},{name:"walk",icon:"walk"},{name:"wifi11",icon:"wifi11"}]},simpleicon={disclaimer:_t('<a href="http://www.flaticon.com/packs/simpleicon-places/" target="_blank">SimpleIcons Places</a>, icons by <a href="http://www.simpleicon.com" target="_blank">simpleicon.com</a>'),icons:[{name:"beach3",icon:"beach3"},{name:"beach4",icon:"beach4"},{name:"boat12",icon:"boat12"},{name:"building21",icon:"building21"},{name:"building22",icon:"building22"},{name:"building23",icon:"building23"},{name:"building24",icon:"building24"},{name:"buildings5",icon:"buildings5"},{name:"castle7",icon:"castle7"},{name:"church7",icon:"church7"},{name:"coconut5",icon:"coconut5"},{name:"compass44",icon:"compass44"},{name:"compass45",icon:"compass45"},{name:"compass46",icon:"compass46"},{name:"compass47",icon:"compass47"},{name:"compass49",icon:"compass49"},{name:"compass50",icon:"compass50"},{name:"factory7",icon:"factory7"},{name:"factory8",icon:"factory8"},{name:"flag31",icon:"flag31"},{name:"flag32",icon:"flag32"},{name:"heart206",icon:"heart206"},{name:"home84",icon:"home84"},{name:"home85",icon:"home85"},{name:"home86",icon:"home86"},{name:"home87",icon:"home87"},{name:"home88",icon:"home88"},{name:"home89",icon:"home89"},{name:"home90",icon:"home90"},{name:"map35",icon:"map35"},{name:"map36",icon:"map36"},{name:"map37",icon:"map37"},{name:"map38",icon:"map38"},{name:"map39",icon:"map39"},{name:"map40",icon:"map40"},{name:"map41",icon:"map41"},{name:"map42",icon:"map42"},{name:"map43",icon:"map43"},{name:"map44",icon:"map44"},{name:"map45",icon:"map45"},{name:"map46",icon:"map46"},{name:"map47",icon:"map47"},{name:"map48",icon:"map48"},{name:"map49",icon:"map49"},{name:"map50",icon:"map50"},{name:"map51",icon:"map51"},{name:"map52",icon:"map52"},{name:"map53",icon:"map53"},{name:"map54",icon:"map54"},{name:"map55",icon:"map55"},{name:"map56",icon:"map56"},{name:"map57",icon:"map57"},{name:"map58",icon:"map58"},{name:"map59",icon:"map59"},{name:"map60",icon:"map60"},{name:"palm9",icon:"palm9"},{name:"placeholder4",icon:"placeholder4"},{name:"sailboat5",icon:"sailboat5"},{name:"sunbathing",icon:"sunbathing"},{name:"sunbathing1",icon:"sunbathing1"},{name:"tower15",icon:"tower15"},{name:"town",icon:"town"}]};if(cdb.admin.StaticAssetItem=cdb.admin.AssetsItem.extend({events:{click:"_onClick"},_deleteAsset:function(){},_openDropdown:function(){}}),cdb.admin.StaticAssetsPane=cdb.admin.AssetsPane.extend({className:"assets static",initialize:function(){this.template=this.options.template||cdb.templates.getTemplate("table/views/asset_manager/static_assets_pane"),this.model=new cdb.core.Model({value:""}),this.options.icons||cdb.log.info("A list of icons is necessary to make the list available");var a={};void 0!==this.options.folder&&(a.folder=this.options.folder),void 0!==this.options.size&&(a.size=this.options.size),void 0!==this.options.host&&(a.host=this.options.host),void 0!==this.options.ext&&(a.ext=this.options.ext),_.isEmpty(a)||(this.options.icons=_.map(this.options.icons,function(b){return _.extend(b,a)})),this.collection=new cdb.admin.StaticAssets(this.options.icons)},render:function(){this.clearSubViews(),this.$el.html(this.template());var a=this.collection.where({kind:this.options.kind}),b=this;_(a).each(function(a){var c=new cdb.admin.StaticAssetItem({className:"assets-item "+(b.options.folder||""),template:"table/views/asset_manager/static_asset_item",model:a});c.bind("selected",b._selectItem,b),b.$("ul").append(c.render().el),b.addView(c)}),this.options.disclaimer&&this.$el.prepend('<div class="disclaimer">'+this.options.disclaimer+"</div>");var c=new cdb.admin.CustomScrolls({el:this.$("ul"),parent:this.$el});return this.addView(c),this},_selectItem:function(a){cdb.admin.AssetsPane.prototype._selectItem.call(this,a),this.trigger("fileChosen",this)}}),cdb.admin.upload_asset_states={reset:{enable:!0,hideClose:!1,list:{animate:{properties:{marginTop:"0px",height:"100%",opacity:1},options:{duration:500,queue:!1,complete:function(){$(this).css("overflow","hidden")}}}},loader:{animate:{properties:{top:"<%- top %>",opacity:0},options:{duration:500,queue:!1}},removeClasses:"creating uploading",addClasses:"",css:{}},stop:!1,showLoader:!1},uploading:{enable:!1,list:{animate:{properties:{marginTop:"-30px",height:"0",opacity:"0"},options:{duration:1200,queue:!0,complete:function(){$(this).css("overflow","hidden")}}}},loader:{animate:{properties:{top:"<%- top %>",opacity:1},options:{duration:800,queue:!1}},removeClasses:"",addClasses:"creating",text:"Uploading your image...",progress:100,css:{}},stop:!1,showLoader:!0}},cdb.admin.BackgroundGeocoder=cdb.core.View.extend({events:{"click a.cancel":"_onCancel"},className:"background_importer",initialize:function(){_.bindAll(this,"show","hide","_onCancel"),this.template_base=cdb.templates.getTemplate(this.options.template_base)},render:function(){if(!this.model.isNew()){var a=this.template_base(this.model.toJSON());this.$el.html(a),this.$el.stop().css({opacity:1}).animate({bottom:"20px"},500),this.delegateEvents()}return this},bindGeocoder:function(){this.model.bind("geocodingStarted",this.changeState,this),this.model.bind("geocodingChange",this._setProgress,this),this.model.bind("geocodingReset geocodingComplete geocodingError",this.hide,this)},_setProgress:function(){var a=this.model.toJSON();a.total_rows&&this.$("label.count").text(" "+a.processed_rows+"/"+a.total_rows),"completed"==a.state&&(this.$("label.strong.light").html("FINISHING"),this.$("label.count").remove()),this.started||this.changeState()},changeState:function(){var a=this;this.started=!0,this.$el.stop().animate({opacity:0},150,function(){a.render()})},_onCancel:function(a){a.preventDefault(),this.model.cancelGeocoding(),this.hide()},hide:function(){this.started=!1,this.$el.stop().animate({opacity:0,bottom:"-35px"},500)}}),cdb.admin.BackgroundTab=cdb.core.View.extend({_TEXTS:{geocoding_error:_t("There was a problem with our geocoder, check again later")},initialize:function(){this.table=this.options.table,this.user=this.options.user,this.initBinds(),this.initViews(),this.getGeocodifications()},initBinds:function(){this.model.bind("change:kind",this._onChangeKind,this),this.model.bind("geocodingComplete geocodingCanceled",this.updateUser,this),this.model.bind("geocodingError",this._onGeocodingError,this)},initViews:function(){this.bkg_geocoder=new cdb.admin.BackgroundGeocoder({template_base:"table/views/geocoder_progress",model:this.model}),this.bkg_geocoder.bindGeocoder(),this.$el.append(this.bkg_geocoder.render().el),this.addView(this.bkg_geocoder)},setActiveLayer:function(a,b){this.model.resetGeocoding(),this.table=a.table,this.checkGeocodification()},_onChangeKind:function(){!this.model.get("id")&&this.model.get("kind")&&this.model.save({table_name:this.table.get("id")},{wait:!1,success:function(a){a.pollCheck()}})},_onChangeFormatter:function(){!this.model.get("id")&&this.model.get("formatter")&&this.model.save({table_name:this.table.get("id")},{wait:!1,success:function(a){a.pollCheck()}})},getGeocodifications:function(){if(this.geocodings)this.checkGeocodification();else{var a=this,b=this.geocodings=new cdb.admin.Geocodings;b.fetch({success:function(b){a.geocodings=new Backbone.Collection(b.get("geocodings")),a.checkGeocodification()},error:function(b){a.geocodings=new Backbone.Collection,cdb.log.info("Geocoding API is not working! -> getGeocodifications")}})}},checkGeocodification:function(){if(this.geocodings&&this.table&&this.table.get("id")){var a,b=this;if(this.geocodings.length>0&&(a=this.geocodings.filter(function(a){return a.get("table_name")==b.table.get("id")&&"finished"!=a.get("state")})),a&&a.length>0){var c=a[0];this.model.set(c.toJSON(),{silent:!0}),this.model.pollCheck()}}},_onGeocodingError:function(){this.updateUser()},updateUser:function(){this.user.fetch()}}),cdb.admin.BaseMapAdder=cdb.admin.BaseDialog.extend({_TEXTS:{title:_t("Add your basemap"),description:_t("Add your XYZ, WMS, NASA or Mapbox maps"),ok:_t("Add basemap")},_WAITING_INPUT_TIME:1e3,events:function(){return _.extend({},cdb.admin.BaseDialog.prototype.events)},initialize:function(){_.bindAll(this,"_successChooser","_errorChooser","_checkOKButton"),_.extend(this.options,{title:this._TEXTS.title,description:this._TEXTS.description,clean_on_hide:!0,cancel_button_classes:"margin15",ok_button_classes:"button grey",ok_title:this._TEXTS.ok,modal_type:"compressed",width:512,modal_class:"basemap_chooser_dialog"}),this.constructor.__super__.initialize.apply(this),this.map=this.options.map,this.model=new cdb.core.Model({enabled:!0,url:""})},render_content:function(){var a=this.$content=$("<div>");return this.temp_content=cdb.templates.getTemplate("table/views/basemap/basemap_chooser_dialog"),a.append(this.temp_content()),this.render_basemap_tabs(a),a},render_basemap_tabs:function(a){this.basemap_tabs=new cdb.admin.Tabs({el:a.find(".basemap-tabs"),slash:!0}),this.addView(this.basemap_tabs),this.mapboxPane=new cdb.admin.MapboxBasemapChooserPane({layer_ids:this.options.layer_ids}),this.mapboxPane.bind("successChooser",this._successChooser,this),this.mapboxPane.bind("errorChooser",this._errorChooser),this.mapboxPane.bind("inputChange",this._checkOKButton),this.zxyPane=new cdb.admin.ZXYBasemapChooserPane({layer_ids:this.options.layer_ids}),this.zxyPane.bind("successChooser",this._successChooser,this),this.zxyPane.bind("errorChooser",this._errorChooser),this.zxyPane.bind("inputChange",this._checkOKButton),this.nasaPane=new cdb.admin.NASABasemapChooserPane({layer_ids:this.options.layer_ids}),this.nasaPane.bind("successChooser",this._successChooser,this),this.nasaPane.bind("errorChooser",this._errorChooser),this.nasaPane.bind("inputChange",this._checkOKButton),this.wmsPane=new cdb.admin.WMSBasemapChooserPane({layer_ids:this.options.layer_ids}),this.wmsPane.bind("chooseWMSLayers",this._chooseWMSLayers,this),this.wmsPane.bind("errorChooser",this._errorChooser),this.wmsPane.bind("inputChange",this._checkOKButton),this.basemap_panes=new cdb.ui.common.TabPane({el:a.find(".basemap-panes")}),this.basemap_panes.addTab("mapbox",this.mapboxPane),this.basemap_panes.addTab("xyz",this.zxyPane),this.basemap_panes.addTab("wms",this.wmsPane),this.basemap_panes.addTab("nasa",this.nasaPane),this.basemap_panes.bind("tabEnabled",this._checkOKButton,this),this.basemap_tabs.linkToPanel(this.basemap_panes),this.addView(this.basemap_panes),a.append(this.basemap_panes.render()),this.basemap_panes.active("xyz")},getURL:function(){return this.basemap_panes.activePane.$el.find("input[type='text']").val()},_checkOKButton:function(){var a=this.$("a.ok"),b="addClass",c=this.getURL();b=c?"removeClass":"addClass",a[b]("disabled")},_reloadWMSPane:function(){this.removeView(this.basemap_panes),this.$el.find(".content").html(this.render_content()),this.basemap_panes.active("wms"),this.centerInScreen(!0),this._enableCancel()},_chooseWMSLayers:function(a){var b=a.get("wms_url").replace(/\?.*/,""),c=a.get("layers");return 0==c.length?void this._errorChooser():(this.basemap_panes.activePane._hideLoader(),this.basemap_panes.removeTab("wms"),this.wmsNewPane=new cdb.admin.WMSBasemapLayersPane({url:b,format:a.get("format"),layers:a.get("layers")}),this.wmsNewPane.bind("successChooser",this._successChooser,this),this.wmsNewPane.bind("reloadWMSPane",this._reloadWMSPane,this),this.wmsNewPane.bind("enableBack",this._enableBack,this),this.basemap_panes.addTab("wms",this.wmsNewPane),this.$el.find(".scrollpane").jScrollPane({showArrows:!0}),this.model.set("enabled",!0),void this.centerInScreen(!0))},_enableCancel:function(a){var b=this;this.$el.find(".cancel").off("click"),this.$el.find(".cancel").text("Cancel"),this.$el.find(".cancel").on("click",function(a){a.preventDefault(a),a.stopPropagation(a),b._cancel()})},_enableBack:function(){var a=this;this.$el.find(".cancel").text("Back"),this.$el.find(".cancel").off("click"),this.$el.find(".cancel").on("click",function(b){b.preventDefault(b),b.stopPropagation(b),a._reloadWMSPane()})},_setBounds:function(a){a&&4===a.length&&this.map.setBounds([[a[1],a[0]],[a[3],a[2]]])},_successChooser:function(a,b){var c=a.get("bounding_boxes");c&&this._setBounds(c),this.basemap_panes.activePane._hideLoader(),a.set("className",a._generateClassName(b)),this.options.baseLayers.add(a),a.save(),this.basemap_panes.activePane._hideError(),this.hide(),this.options.ok&&this.options.ok(a)},_errorChooser:function(){this.model.set("enabled",!0)},_ok:function(a){a&&a.preventDefault&&a.preventDefault();var b=_.map(this.basemap_panes.activePane.$("input[type='text']"),function(a){return $(a).val()});this.model.get("enabled")&&(this.model.set("enabled",!1),this.basemap_panes.activePane.checkTileJson.apply(this.basemap_panes.activePane,b))}}),cdb.admin.BasemapChooserPane=cdb.core.View.extend({className:"basemap-pane",render:function(){return this.$el.append(this.template({placeholder:this.options.placeholder,type:this.options.type})),this}}),cdb.admin.MapboxBasemapChooserPane=cdb.admin.BasemapChooserPane.extend({className:"basemap-pane",events:{'focusin input[type="text"]':"_focusIn",'focusout input[type="text"]':"_focusOut",'keyup input[type="text"]':"_onInputChange",'paste input[type="text"]':"_onInputPaste"},initialize:function(){_.bindAll(this,"_errorChooser","_onInputChange"),this.template=this.options.template||cdb.templates.getTemplate("table/views/basemap/basemap_chooser_mapbox_pane"),this.render()},render:function(){return this.$el.html(this.template({placeholder:"Insert your Mapbox map URL or map id",placeholder_access_token:"Insert your Mapbox access token",error:"Your Mapbox map URL or your Mapbox map id is not valid."})),this},_onInputPaste:function(a){setTimeout(this._onInputChange,100)},_onInputChange:function(a){var b=this.$("input[type='text']"),c=b.val();return a&&13==a.keyCode?!1:void(""==c?(this._hideLoader(),this._hideError(),this.trigger("inputChange","",this)):this.trigger("inputChange",c,this))},_hideLoader:function(){this.$el.find("div.loader").hide()},_showLoader:function(){this.$el.find("div.loader").show()},_hideError:function(){this.$el.find("input").removeClass("error"),this.$("div.info").removeClass("error active")},_focusIn:function(a){$(a.target).closest("div.input").addClass("active")},_focusOut:function(a){$(a.target).closest("div.input").removeClass("active")},checkTileJson:function(a,b){if(!b)return this._errorChooser("Error retrieving your basemap. Please, check your access token.");this._hideError(),this._showLoader();var c=this.$("input");c.attr("disabled");var d=this,e=new cdb.admin.MapboxToTileLayerFactory({url:a,accessToken:b});e.createTileLayer({success:function(a){var b=a.get("urlTemplate"),c=a._generateClassName(b);_.include(d.options.layer_ids,c)?d._errorChooser("This basemap is already added."):d.trigger("successChooser",a,b)},error:function(a){d._errorChooser(a)}})},_errorChooser:function(a){var b=this.$("input");this._hideLoader(),this.$(".info p").html(a),this.$("input").addClass("error"),this.$("div.info").addClass("error active"),b.attr("disabled"),this.trigger("errorChooser","",this)}}),cdb.admin.NASABasemapChooserPane=cdb.admin.BasemapChooserPane.extend({className:"basemap-pane nasa-pane",_NASA:{day:{url:"http://map1.vis.earthdata.nasa.gov/wmts-webmerc/MODIS_Terra_CorrectedReflectance_TrueColor/default/<%- date %>/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpeg",limit:"2012-05-01","default":"2012-05-01",attribution:'<a href="http://earthdata.nasa.gov/gibs" target="_blank">NASA EOSDIS GIBS</a>',name:"NASA Terra",maxZoom:9,minZoom:1},night:{url:"http://map1.vis.earthdata.nasa.gov/wmts-webmerc/VIIRS_CityLights_2012/default/<%- date %>/GoogleMapsCompatible_Level8/{z}/{y}/{x}.jpeg",limit:"2012-05-01","default":"2012-05-02",attribution:'<a href="http://earthdata.nasa.gov/gibs" target="_blank">NASA EOSDIS GIBS</a>',name:"NASA Earth at night",maxZoom:8,minZoom:1}},_TEXTS:{disclaimer:_t("NASA text"),errors:{added:_t("This basemap is already added"),future:_t("Sorry, NASA does not provide images of the future (yet)"),limit:_t("These images aren't available because NASA was busy doing other things prior to this date ;)")}},events:{},initialize:function(){this.model=new cdb.core.Model({value:this._getYesterdayDate(),type:"day"}),this.template=cdb.templates.getTemplate("table/views/basemap/basemap_chooser_nasa_pane"),this._initBinds(),this.render()},render:function(){this.clearSubViews(),this.$el.html(this.template({disclaimer:this._TEXTS.disclaimer,error:""}));var a=this.date=new cdb.admin.DateField({model:this.model});this.$("div.date").append(a.render().el),this.addView(a);var b=new cdb.forms.Combo({model:this.model,property:"type",width:"80px",extra:["day","night"]});return this.$("div.type").append(b.render().el),this.addView(b),this},_initBinds:function(){this.model.bind("change",this._setValue,this)},_getYesterdayDate:function(){var a=new Date;return a.setDate(a.getDate()-1),a.getFullYear()+"-"+("0"+(a.getMonth()+1)).slice(-2)+"-"+("0"+a.getDate()).slice(-2)+"T00:00:00"},_isValidDate:function(a){var b=this.model.get("type"),c=new Date(a.replace(/-/g,"/").split("T")[0]),d=new Date,e=new Date(this._NASA[b].limit),f="",g=!0;return c>d&&(f=this._TEXTS.errors.future,g=!1),e>c&&(f=this._TEXTS.errors.limit,g=!1),{valid:g,error:f}},_setURL:function(a,b){var c=new Date(a.replace(/-/g,"/").split("T")[0]),a=c.getFullYear()+"-"+("0"+(c.getMonth()+1)).slice(-2)+"-"+("0"+c.getDate()).slice(-2);return _.template(this._NASA[b].url)({date:a})},_setValue:function(a,b){var b=this.model.get("value"),c=this.model.get("type");this.date&&(a.changed&&a.changed.type&&"night"===a.changed.type?(this.date.hide(),b=this._NASA[c]["default"]):this.date.show());var d=this._isValidDate(b);d.valid?(this._hideError(),this.$("input.url").val(this._setURL(b,c)),this.trigger("inputChange",b,this)):(this._showError(d.error),this.$("input.url").val(""),this.trigger("inputChange","",this))},_lowerXYZ:function(a){return a.replace(/\{S\}/g,"{s}").replace(/\{X\}/g,"{x}").replace(/\{Y\}/g,"{y}").replace(/\{Z\}/g,"{z}")},_hideLoader:function(){},_hideError:function(){var a=this;this.$("div.info").removeClass("active"),setTimeout(function(){a.$("div.info p").html("")},100)},_showError:function(a){a&&this.$(".info p").html(a),this.$("div.info").addClass("active")},checkTileJson:function(a){this._successChooser({tiles:[this._lowerXYZ(a)]})},_successChooser:function(a){var b=this.model.get("type"),c=this.model.get("value"),d=this._isValidDate(c);if(!d.valid)return void this.trigger("errorChooser");_.isArray(a)&&_.size(a)>0&&(a=_.first(a));var e=this._NASA[b].name;if("day"===b&&this.model.get("value")){var c=new Date(this.model.get("value").replace(/-/g,"/").split("T")[0]);e=e+" "+c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate()}var f=new cdb.admin.TileLayer({urlTemplate:a.tiles[0],attribution:this._NASA[b].attribution,maxZoom:this._NASA[b].maxZoom,minZoom:this._NASA[b].minZoom,name:e}),e=f._generateClassName(a.tiles[0]);return _.include(this.options.layer_ids,e)?(this._showError(this._TEXTS.errors.added),this.trigger("errorChooser"),!1):void this.trigger("successChooser",f,a.tiles[0])}}),cdb.admin.WMSBasemapLayersPaneItem=cdb.core.Model.extend({}),cdb.admin.WMSBasemapLayersPaneItems=Backbone.Collection.extend({model:cdb.admin.WMSBasemapLayersPaneItem}),cdb.admin.WMSBasemapLayersPaneItemView=cdb.core.View.extend({tagName:"li",template_base:'<div class="msg"><strong><%- name %></strong></div> <a href="#/add-this" class="button grey smaller right">Add this</a>',events:{"click a.button":"_onClickLayer"},initialize:function(){this.template=_.template(this.template_base)},_onClickLayer:function(a){this.killEvent(a);var b=this,c={wms_url:this.options.url,layer:this.model.get("name"),srs:this.model.get("srs"),title:this.model.get("title"),name:this.model.get("name"),bounding_boxes:this.model.get("bounding_boxes")},d=new cdb.admin.WMSService(c);cdb.god.trigger("mixpanel","WMS layer selected",c),cdb.god.trigger("metrics","select_wms",{email:window.user_data.email,data:c}),this.trigger("layer_selected"),d.save({},{success:function(a){var c;try{c=a.newTileLayer()}catch(d){}if(c){var e=c._generateClassName(c.get("urlTemplate"));b.trigger("layer_choosen",c,e)}}})},render:function(){var a=this.model.toJSON();return this.$el.html(this.template(a)),this}}),cdb.admin.WMSBasemapLayersPane=cdb.core.View.extend({className:"basemap-pane",initialize:function(){var a=this;_.bindAll(this,"_showLoader"),this.template=this.options.template||cdb.templates.getTemplate("table/views/basemap/basemap_chooser_wms_pane"),this._loadLayers(this.options.layers),this.render(),setTimeout(function(){a.trigger("enableBack",this)},200)},checkTileJson:function(){},_loadLayers:function(a){var b=_.map(a,function(a){return new cdb.admin.WMSBasemapLayersPaneItem({name:a.name,title:a.title,srs:a.srs,crs:a.crs,bounding_boxes:a.llbbox})});this.items=new cdb.admin.WMSBasemapLayersPaneItems(b)},_hideLoader:function(){},_hideError:function(){},_showLoader:function(){this.$el.append(cdb.templates.getTemplate("table/views/basemap/basemap_chooser_wms_proxy_loader")()),this.$(".basemap_chooser_wms_items").hide()},render:function(){this.clearSubViews(),this.$el.html(this.template({layers:this.options.layers}));var a=this;return this.items.each(function(b){var c=new cdb.admin.WMSBasemapLayersPaneItemView({model:b,url:a.options.url});a.$("ul").append(c.render().$el),a.addView(c),c.bind("layer_selected",a._showLoader,this),c.bind("layer_choosen",function(b){a.trigger("successChooser",b,"wms_name")})}),this}}),cdb.admin.WMSService=Backbone.Model.extend({_PROXY_URL:"//cartodb-wms.global.ssl.fastly.net/api",_PROXY_TILES:"//cartodb-wms.global.ssl.fastly.net/mapproxy",methodToURL:{read:"/check",create:"/add"},sync:function(a,b,c){return c=c||{},c.url=this.url(a.toLowerCase()),c.dataType="jsonp",a="READ",Backbone.sync.apply(this,arguments)},url:function(a){var b=this._PROXY_URL+this.methodToURL[a],c=this.get("wms_url"),d=document.createElement("a");d.href=c;var e=d.search.substr(1).split("&"),f=_.find(e,function(a){return-1!==a.toLowerCase().indexOf("request=getcapabilities")}),g=_.find(e,function(a){return-1!==a.toLowerCase().indexOf("service=wms")});f||e.push("request=GetCapabilities"),g||e.push("service=WMS"),c+="?"+e.join("&"),b+="?url="+encodeURIComponent(c);var h="wmts"===this.get("type");return b+="&type="+(h?"wmts":"wms"),"create"===a&&(this.get("layer")&&this.get("srs")?(b+="&layer="+this.get("layer"),b+="&srs=EPSG:"+this.get("srs")[0].split(":")[1]):h&&this.get("layer")&&this.get("matrix_sets").length>0&&(b+="&layer="+this.get("layer"),b+="&matrix_set="+cdb.admin.WMSService.supportedMatrixSets(this.get("matrix_sets"))[0])),b},newTileLayer:function(){if(!this.get("mapproxy_id"))throw new Error("mapproxy_id must be set");return new cdb.admin.TileLayer({urlTemplate:this._PROXY_TILES+"/"+this.get("mapproxy_id")+"/wmts/map/webmercator/{z}/{x}/{y}.png",attribution:this.get("attribution")||null,maxZoom:21,minZoom:0,name:this.get("title")||this.get("name"),proxy:!0,bounding_boxes:this.get("bounding_boxes")})}},{SUPPORTED_MATRIX_SETS:["EPSG:4326","EPSG:4258"],supportedMatrixSets:function(a){return _.intersection(a,this.SUPPORTED_MATRIX_SETS)}}),cdb.admin.WMSBasemapChooserPane=cdb.admin.BasemapChooserPane.extend({_TEXTS:{error:_t("Your WMS base URL is not valid or doesn't contain                       any layer with supported projections (3857, 900913)."),placeholder:_t("Insert your WMS base URL")},className:"basemap-pane",events:{'focusin input[type="text"]':"_focusIn",'focusout input[type="text"]':"_focusOut",'keyup input[type="text"]':"_onInputChange",'paste input[type="text"]':"_onInputPaste"},initialize:function(){_.bindAll(this,"_onSuccess","_errorChooser","_onInputChange","checkTileJson"),this.template=this.options.template||cdb.templates.getTemplate("table/views/basemap/basemap_chooser_pane"),this.render()},render:function(){return this.$el.html(this.template({placeholder:this._TEXTS.placeholder,error:this._TEXTS.error})),this},_onInputPaste:function(a){setTimeout(this._onInputChange,100)},_onInputChange:function(a){var b=this.$("input[type='text']"),c=b.val();return a&&13==a.keyCode?!1:void(""==c?(this._hideLoader(),this._hideError(),this.trigger("inputChange","",this)):this.trigger("inputChange",c,this))},_hideLoader:function(){this.$el.find("div.loader").hide()},_showLoader:function(){this.$el.find("div.loader").show()},_hideError:function(){this.$el.find("input").removeClass("error"),this.$("div.info").removeClass("error active")},_showError:function(){this.$el.find("input").addClass("error"),this.$el.find("div.info").addClass("error active")},_fixHTTPS:function(a,b){return b=b||location,0!==a.indexOf("https")&&"https:"===b.protocol?a.replace(/http/,"https"):a},_focusIn:function(a){$(a.target).closest("div.input").addClass("active")},_focusOut:function(a){$(a.target).closest("div.input").removeClass("active")},_lowerXYZ:function(a){return a.replace(/\{S\}/g,"{s}").replace(/\{X\}/g,"{x}").replace(/\{Y\}/g,"{y}").replace(/\{Z\}/g,"{z}")},_addHTTP:function(a){return 0!==a.indexOf("http://")&&0!==a.indexOf("https://")?"http://"+a:a},checkTileJson:function(a){this._hideError(),this._showLoader();var b=this._addHTTP(a);if(cdb.Utils.isBlank(a)||"http://"===b)return void this._errorChooser();var c=this;w=new cdb.admin.WMSService({wms_url:b}),w.bind("change:layers",function(){c.trigger("chooseWMSLayers",w)}),w.fetch({success:this._onSuccess,error:this._errorChooser})},_onSuccess:function(a,b){if(b&&b.error)return void this._errorChooser();var c=a.get("layers");0==c.length&&this._errorChooser()},_errorChooser:function(a){var b=this.$el.find("input");this._hideLoader(),this._showError(),b.attr("disabled"),this.trigger("errorChooser")}}),cdb.admin.ZXYBasemapChooserPane=cdb.admin.BasemapChooserPane.extend({className:"basemap-pane",events:{'focusin input[type="text"]':"_focusIn",'focusout input[type="text"]':"_focusOut",'keyup input[type="text"]':"_onInputChange",'paste input[type="text"]':"_onInputPaste"},initialize:function(){_.bindAll(this,"_errorChooser","_warningChooser","_onInputChange","_checkInput"),this.template=this.options.template||cdb.templates.getTemplate("table/views/basemap/basemap_chooser_pane"),this.render()},render:function(){return this.$el.html(this.template({placeholder:"Insert your XYZ URL template",error:"Your XYZ URL template is not valid."})),this},_onInputPaste:function(a){setTimeout(this._onInputChange,100)},_onInputChange:function(a){var b=this.$("input[type='text']"),c=b.val();
return a&&13==a.keyCode?!1:void(""==c?(this._hideLoader(),this._hideError(),this.trigger("inputChange","",this)):(this.trigger("inputChange",c,this),this._checkInput(c)))},_checkInput:function(a){try{var b=cdb.admin.TileLayer.byCustomURL(a)}catch(c){return void this._hideError()}this._showLoader(),this._checkTile(b)},_hideLoader:function(){this.$el.find("div.loader").hide()},_showLoader:function(){this.$el.find("div.loader").show()},_hideError:function(){this.$el.find("input").removeClass("warning"),this.$("div.info").removeClass("warning active"),this.$el.find("input").removeClass("error"),this.$("div.info").removeClass("error active")},_showWarning:function(a){"object"!=typeof a&&a||(a="We couldn't validate this URL. If you're sure it contains data, go on and click on 'Add Basemap'"),this.$(".info p").html(a),this.$el.find("input").removeClass("error"),this.$el.find("div.info").removeClass("error"),this.$el.find("input").addClass("warning"),this.$el.find("div.info").addClass("warning active")},_showError:function(a){"object"!=typeof a&&a||(a="This URL is not valid."),this.$(".info p").html(a),this.$el.find("input").addClass("error"),this.$el.find("div.info").addClass("error active")},_focusIn:function(a){$(a.target).closest("div.input").addClass("active")},_focusOut:function(a){$(a.target).closest("div.input").removeClass("active")},checkTileJson:function(a){this._hideError(),this._showLoader(),this.$("input").attr("disabled");try{var b=cdb.admin.TileLayer.byCustomURL(a)}catch(c){return void this._errorChooser()}this._successChooser(b)},_checkTile:function(a){var b=this;a.validateTemplateURL({success:function(){b._hideError(),b._hideLoader()},error:function(){b._warningChooser()}})},_successChooser:function(a){var b=a.get("urlTemplate"),c=a._generateClassName(b);return _.include(this.options.layer_ids,c)?void this._errorChooser("This basemap is already added."):void this.trigger("successChooser",a,b)},_warningChooser:function(a){this._hideLoader(),this._showWarning(a),this.$el.find("input").attr("disabled"),this.trigger("errorChooser")},_errorChooser:function(a){this._hideLoader(),this._showError(a),this.$el.find("input").attr("disabled"),this.trigger("errorChooser")}}),cdb.admin.BaseLayerButton=cdb.core.View.extend({bindMap:function(a){a.bind("savingLayers",this.disable,this),a.bind("savingLayersFinish",this.enable,this)},disable:function(){this.$el.addClass("disabled"),this.undelegateEvents()},enable:function(){this.$el.removeClass("disabled"),this.delegateEvents()},selectButton:function(){this.$el.parents(".dropdown.basemap").find("li.selected").removeClass("selected"),this.$el.addClass("selected")}}),cdb.admin.DropdownBasemap=cdb.ui.common.Dropdown.extend({className:"dropdown basemap",defaults:{speedIn:50,speedOut:50,basemaps_per_list:8,available_basemaps:{}},events:{"click a.add":"_openSelector",click:"killEvent"},initialize:function(){_.bindAll(this,"add","setActiveBaselayer","open","hide","_handleClick","_keydown"),_.defaults(this.options,this.defaults),this.template_base=cdb.templates.getTemplate(this.options.template_base),$(this.options.target).bind({click:this._handleClick}),$(document).bind("keydown",this._keydown),this.isOpen=!1,this.baseLayers=this.options.baseLayers,this.user=this.options.user,this._setupBindings()},_setupBindings:function(){this._bindBaseLayers(),this._bindMapView()},_bindBaseLayers:function(){this.baseLayers&&(this.baseLayers.bind("reset",this.render,this),this.baseLayers.bind("add",this.add,this))},_bindMapView:function(){var a=this;this.model.layers.bind("change add reset",function(b){a._checkPlainColor(),a.setActiveBaselayer(b)})},_checkPlainColor:function(){var a=this.model.getBaseLayer();a&&"Plain"==a.get("type")&&(a.get("color")?this.background_color.model=a:this.background_image.model=a)},_toggleAddBaseLayer:function(){var a=this.$el.find(".add_basemap"),b=this.$el.find(".custom ul.yours");b.find("li").length<=this.defaults.basemaps_per_list?(a.removeClass("hidden"),a.parent().append(a)):a.addClass("hidden")},googleMapsEnabled:function(){return"undefined"!=typeof google&&"undefined"!=typeof google.maps},add:function(a){var b,c=(a.get("type")&&a.get("type").toLowerCase(),a.get("proxy"));if("wms"===a.get("className")||c)b=new cdb.admin.BaseMapView({model:a,map:this.model,className:"wms"});else if("googlemaps"===a.get("className")){if(!this.googleMapsEnabled())return;b=new cdb.admin.GMapsBaseView({model:a,map:this.model})}else{if(this.user.featureEnabled("google_maps")&&"Google"!==a.get("category"))return;b=new cdb.admin.BaseMapView({model:a,map:this.model})}a.bind("destroy",this._toggleAddBaseLayer,this),this.addView(b);var d=b.model.get("name");d?d.replace(/_/g,""):d="Custom basemap "+b.model.get("order"),b.model.set("name",d);var e=$(b.render().el),f=b.model.get("base_type")||"default";f.toLowerCase();var g=cdb.templates.getTemplate("table/views/basemap/basemap_dropdown_cat");if(f){var h=a.get("category");h=h||"Others";var i=".custom ul."+h.toLowerCase(),j=this.$(i);j.length||($(g({category:h})).insertBefore(this.$(".fixed_basemaps")),j=this.$(i)),j.append(e)}this._toggleAddBaseLayer()},_getCleanClassName:function(a){return a?a.replace(/default /g,"").replace(/\s+/g,"").replace(/[^a-zA-Z_0-9 ]/g,"").toLowerCase():!1},_updateTarget:function(a){var b=a.model.get("className"),c=(a.model.get("type"),a.model.get("color")),d=a.model.get("image"),e=(c?"color":void 0)||(d?"pattern":void 0)||"",b=this._getCleanClassName(b);if("googlemaps"===b){b=a.model.get("base_type");var f=a.model.get("baseName");b+=f?"."+f:""}var g=this.$el.find("a."+b);e&&(g=this.$el.find("a."+b+"."+e)),this._setName(g),this._setThumbnail(g,c,d)},_setName:function(a){var b=a.attr("data-name");b||(b="Change basemap"),b=cdb.Utils.truncate(b,40),this.options.target.find(".info .name").html(b)},_setThumbnail:function(a,b,c){c&&(c="url("+c+")");var d=a.find(".thumb"),e=c||d.css("background-image"),f=d.css("background-size"),g=d.css("background-position");b=e&&"none"!==e?"#000":b||d.css("background-color"),this.options.target.find("> .thumb").css({"background-image":e,"background-position":g,"background-size":f,"background-color":b})},_addBackgroundBasemap:function(){this.background_image=new cdb.admin.BackgroundMapImageView({model:this.model.getBaseLayer(),map:this.model,user:this.options.user}),this.addView(this.background_image);var a=$(this.background_image.render().el),b=this.$el.find(".custom ul.custom");b.append(a)},_addColorBasemap:function(){this.background_color=new cdb.admin.BackgroundMapColorView({model:this.model.getBaseLayer(),map:this.model}),this.addView(this.background_color);var a=$(this.background_color.render().el),b=this.$el.find(".custom ul.custom");b.append(a),this.background_color.delegateEvents()},_addAddBasemapLink:function(){var a=$('<li class="add_basemap hidden"><a class="add small" href="#add_basemap"><div class="thumb"></div></a></li>'),b=this.$el.find(".custom ul.yours");b.append(a)},show:function(){var a=$.Deferred(),b=this;return this.delegateEvents(),this.$el.css({marginTop:"down"==b.options.vertical_position?"-10px":"10px",opacity:0,display:"block"}).animate({margin:"0",opacity:1},{duration:this.options.speedIn,complete:function(){a.resolve()}}),this.trigger("onDropdownShown",this.el),this._toggleAddBaseLayer(),a.promise()},open:function(a,b){var c=b&&$(b)||this.options.target;this.options.target=c;var d=this.options.target.position().top+this.options.vertical_offset,e="up"==this.options.vertical_position?"bottom":"top";this.$el.css(e,d),this.$el.css({left:this.options.horizontal_offset}).addClass(("up"==this.options.vertical_position?"vertical_top":"vertical_bottom")+" "+("right"==this.options.horizontal_position?"horizontal_right":"horizontal_left")+" border tick_"+this.options.tick),this.show(),this.isOpen=!0},hide:function(a){if(!this.isOpen)return void(a&&a());var b=this;this.isOpen=!1,this.$el.animate({marginTop:"down"==b.options.vertical_position?"10px":"-10px",opacity:0},this.options.speedOut,function(){b.$el.hide()}),this.trigger("onDropdownHidden",this.el)},_addBaseDefault:function(){this.baseLayers.each(this.add)},setActiveBaselayer:function(a){for(var b in this._subviews){var c=this._subviews[b];if(c.model&&this.model.getBaseLayer&&this.model.getBaseLayer().isEqual(c.model))return"Plain"!=c.model.get("type")&&c.selectButton(),void this._updateTarget(c)}},_openSelector:function(a){var b=this;a.preventDefault();var c=_.map(b.$el.find(".others li a"),function(a){return $(a).attr("class")}),d=new cdb.admin.BaseMapAdder({map:this.model,baseLayers:this.baseLayers,layer_ids:c,ok:function(a){b.model.changeProvider("leaflet",a.clone())}}),e=function(){d.appendToBody().open({center:!0})};if(this.options.user.featureEnabled("new_modals")){var f=new cdb.editor.AddCustomBasemapView({map:this.model,baseLayers:this.baseLayers,openOldDialog:e,clean_on_hide:!0,enter_to_confirm:!0});f.appendToBody()}else e();return!1},render:function(){return this.clearSubViews(),this.$el.html(this.template_base(this.options)),this._addBaseDefault(),this._addColorBasemap(),this._addBackgroundBasemap(),this._addAddBasemapLink(),this},clean:function(){$(document).unbind("keydown",this._keydown),cdb.ui.common.Dropdown.prototype.clean.call(this)}}),cdb.admin.BackgroundMapColorView=cdb.admin.BaseLayerButton.extend({events:{click:"_openPicker"},tagName:"li",className:"map_background",initialize:function(){_.bindAll(this,"setColor"),this.map=this.options.map,this.template=cdb.templates.getTemplate("table/views/basemap/color_basemap"),this.bindMap(this.map),this.map.bind("savingLayersFinish",this._changeModel,this),this._initBinds()},render:function(){return this.$el.html(this.template(this.model.attributes)),this.elder("render"),this},activate:function(a){var b=new cdb.admin.PlainLayer({color:a,image:"",maxZoom:28});return this.model=b,this.map.changeProvider("leaflet",b),!1},_changeModel:function(){this.model&&this.model.unbind(null,null,this),this.model=this.map.getBaseLayer(),this._initBinds(),this.render()},_initBinds:function(){this.model.bind("change",this.render,this)},_createPicker:function(){this.color_picker=new cdb.admin.ColorPicker({className:"dropdown color_picker basemap border vertical_offset",target:this.$el,vertical_position:"down",horizontal_position:"left",vertical_offset:40,horizontal_offset:50,tick:"top",dragUpdate:!1}).bind("colorChosen",this.setColor,this),this._bindPicker(),this.addView(this.color_picker)},_destroyPicker:function(){this.color_picker&&(this._unbindPicker(),this.removeView(this.color_picker),this.color_picker.hide(),delete this.color_picker)},_bindPicker:function(){cdb.god.bind("closeDialogs",this._destroyPicker,this)},_unbindPicker:function(){cdb.god.unbind("closeDialogs",this._destroyPicker,this)},setColor:function(a,b){b&&cdb.god.trigger("closeDialogs"),this.activate(a),this.render(),$("ul.options .basemap_dropdown .info strong").text("Color: "+a),$("ul.options .basemap_dropdown a.thumb").css("background-color",a),this.selectButton(),cdb.god.trigger("mixpanel","Applying a color as basemap",{color:a}),cdb.god.trigger("metrics","color_basemap",{email:window.user_data.email,data:{color:a}})},_openPicker:function(a){this.killEvent(a),this.color_picker&&this._destroyPicker(),this.color_picker||(this._createPicker(),$("body").append(this.color_picker.render().el),this.color_picker.init(this.model.get("color")))},selectButton:function(){this.$el.closest(".dropdown.basemap").find("li.selected").removeClass("selected"),this.$el.addClass("selected")}}),cdb.admin.BaseMapView=cdb.admin.BaseLayerButton.extend({events:{"click .remove_layer":"_openDropdown",click:"activate"},defaults:{s:"a",x:30,y:24,z:6},tagName:"li",className:"leaflet",initialize:function(){this.options=_.defaults(this.options,this.defaults),this.map=this.options.map,this.model.bind("destroy",this.clean,this),this.bindMap(this.map)},render:function(){var a,b=this.model.get("subdomains"),c=this.model.get("urlTemplate").replace("{s}",b&&b.length?b[0]:this.options.s).replace("{z}",this.options.z).replace("{x}",this.options.x).replace("{y}",this.options.y),d=this.model.get("type")&&this.model.get("type").toLowerCase(),e=this.model.get("proxy"),f=this.model.get("className");a="wms"===d||e?$("<div class='thumb'></div>"):$("<div class='thumb' style='background-image:url("+c+")'></div>");var g=$(this.make("a",{"class":f},a));return g.attr("data-name",this.model.get("name")),this.model.get("read_only")||(del=this.make("span",{"class":"remove_layer"}),g.find(".thumb").append(del)),this.$el.html(g),this.$el.attr("data-tipsy",this.model.get("name")),this.$el.attr("title",this.model.get("name")),this.$el.tipsy({gravity:"s",live:!0,fade:!0}),this.elder("render"),this},activate:function(a){a.preventDefault(),a.stopPropagation(),cdb.god.trigger("closeDialogs");var b=this.model.clone();return b.set("id",void 0),this.map.changeProvider("leaflet",b),!1},_openDropdown:function(a){var b=this;return a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation(),this.dropdown=new cdb.admin.DropdownMenu({className:"dropdown border short",target:this.$(".remove_layer"),width:196,speedIn:150,speedOut:300,template_base:"table/views/remove_layer_content",vertical_position:"down",horizontal_position:"left",horizontal_offset:3,clean_on_hide:!0,tick:"left"}),this.dropdown.bind("optionClicked",function(a){a.preventDefault(),b.model.destroy()}),$("body").append(this.dropdown.render().el),this.dropdown.open(a),cdb.god.bind("closeDialogs",this.dropdown.hide,this.dropdown),!1}}),cdb.admin.GMapsBaseView=cdb.admin.BaseLayerButton.extend({events:{click:"activate"},tagName:"li",className:"gmaps",initialize:function(){this.options=_.defaults(this.options,this.defaults),this.map=this.options.map,this.bindMap(this.map)},render:function(){var a=$("<div class='thumb'></div>"),b=$(this.make("a",{"class":this.model.get("base_type")+" "+(this.model.get("baseName")||"")},a));return b.attr("data-name",this.model.get("name")),this.$el.html(b),this.$el.attr("data-tipsy",this.model.get("name")),this.$el.attr("title",this.model.get("name")),this.$el.tipsy({gravity:"s",live:!0,fade:!0}),this.elder("render"),this},activate:function(a){return a.preventDefault(),cdb.god.trigger("closeDialogs"),this.map.changeProvider("googlemaps",this.model.clone()),!1}}),cdb.admin.BackgroundMapImageView=cdb.admin.BackgroundMapColorView.extend({events:{click:"_openImagePicker"},initialize:function(){_.bindAll(this,"setPattern"),this.map=this.options.map,this.user=this.options.user,this.template=cdb.templates.getTemplate("table/views/basemap/pattern_basemap"),this.bindMap(this.map),this.map.bind("savingLayersFinish",this._changeModel,this),this._initBinds()},activate:function(a){var b=new cdb.admin.PlainLayer({color:"",image:a,maxZoom:28});return this.model=b,this.map.changeProvider("leaflet",b),!1},_openImagePicker:function(a){if(this.killEvent(a),this.user.featureEnabled("new_modals")){var b=new cdb.editor.ImagePickerView({user:this.user,kind:"pattern"});b.appendToBody(),b.bind("fileChosen",this.setPattern,this)}else{var c=new cdb.admin.AssetManager({user:window.user_data,kind:"pattern"});c.appendToBody().open(),c.bind("fileChosen",this.setPattern,this)}},setPattern:function(a){cdb.god.trigger("closeDialogs"),this.activate(a),this.render(),$("ul.options .basemap_dropdown a.thumb").css({"background-image":"url("+a+")","background-size":"34px","background-position":"50% 50%","background-color":"transparent"}),this.selectButton(),cdb.god.trigger("mixpanel","Applying a pattern as basemap",{url:a}),cdb.god.trigger("metrics","pattern_basemap",{email:window.user_data.email,data:{url:a}})}}),cdb.admin.ColumntypeDropdown=cdb.admin.DropdownMenu.extend({className:"dropdown border",dialogContainer:"body",events:{"click .string":"setString","click .number":"setNumber","click .date":"setDate","click .boolean":"setBool"},initialize:function(){_.bindAll(this,"setColumnTypeChange","setString","setNumber","setDate","setBool"),this.elder("initialize")},setTable:function(a,b){var c=this;this.table=a,this.column=b;var d=this.table.getColumnType(b);this._disableColumn(d),_(["string","number","boolean","date"]).each(function(a){c.table.isTypeChangeAllowed(c.column,a)||c._disableColumn(a,{keep_disabled:!0})})},_disableColumn:function(a,b){b=b||{},b.keep_disabled||this.$("li.disabled").removeClass("disabled"),this.$("li a."+a).parent().addClass("disabled")},setColumnTypeChange:function(a){var b=this;b.hide(),this.table.isTypeChangeDestructive(this.column,a)?(this.options.user&&this.options.user.featureEnabled("new_modals")?this.change_confirmation=cdb.editor.ViewFactory.createDialogByTemplate("common/dialogs/confirm_type_change",{title:"Confirm type change",description:"Unconvertible data will be lost. Are you sure?"}):this.change_confirmation=new cdb.admin.BaseDialog({title:"Confirm type change",description:"Unconvertible data will be lost. Are you sure?",template_name:"old_common/views/confirm_dialog",clean_on_hide:!0,enter_to_confirm:!0,ok_button_classes:"right button grey",ok_title:"Yes, do it",cancel_button_classes:"underline margin15",cancel_title:"Cancel",modal_type:"confirmation",width:500}),this.change_confirmation.ok=function(){b.table.changeColumnType(b.column,a),this.close&&this.close()},this.change_confirmation.appendToBody().open()):this.table.changeColumnType(this.column,a)},setString:function(a){this.killEvent(a),this.table.isTypeChangeAllowed(this.column,"string")&&this.setColumnTypeChange("string")},setNumber:function(a){this.killEvent(a),this.table.isTypeChangeAllowed(this.column,"number")&&this.setColumnTypeChange("number")},setDate:function(a){this.killEvent(a),this.table.isTypeChangeAllowed(this.column,"date")&&this.setColumnTypeChange("date")},setBool:function(a){this.killEvent(a),this.table.isTypeChangeAllowed(this.column,"boolean")&&this.setColumnTypeChange("boolean")}}),cdb.admin.CreateLayerDialog=cdb.common.CreateDialog.extend({render_content:function(){var a=this,b=new cdb.admin.CreateLayerDialog.Content({model:this.model,user:this.options.user,tabs:this.options.tabs,states:this.options.states,option:this.options.option,uploader:this._UPLOADER,$dialog:this.$el});this.$(".content").append(b.render().el),b.bind("showUpgrade",this._showUpgrade,this),b.bind("changeSize",function(){setTimeout(function(){a.centerInScreen(!0)},300)},this),this.addView(b);var c=new cdb.common.CreateDialog.Uploader({model:this.model,user:this.options.user,uploader:this._UPLOADER});this.$(".content").append(c.render().el),c.bind("creationComplete",this._onCreationComplete,this),this.addView(c)}}),cdb.admin.CreateLayerDialog.Actions=cdb.common.CreateDialog.Actions.extend({_VALID_STATES_OK:["idle","reset","abort","added","complete","error"]}),cdb.admin.CreateLayerDialog.Content=cdb.common.CreateDialog.Content.extend({_genActionsController:function(){var a=new cdb.admin.CreateLayerDialog.Actions({enabled_tabs:this.enabled_tabs,tabs:this.create_tabs,panes:this.create_panes,model:this.model,states:this.options.states,$dialog:this.$dialog});this.addView(a)}}),cdb.admin.CreateLayerDialog.states=_.extend(cdb.common.CreateDialog.states,{uploading:{title:{enabled:{"default":!1}},navigation:{enabled:!1},tabs:{enabled:!1},content:{enabled:!1},progress:{enabled:!0,text:{"default":_t("Uploading your data"),file:{file:_t("Uploading your data"),url:_t("Downloading file")},gdrive:_t("Uploading your Google Drive file"),dropbox:_t("Uploading your Dropbox file"),layer:_t(""),scratch:_t("Uploading your data"),twitter:_t("Importing. Depending on the amount of tweets, this can take a while"),arcgis:_t("Importing your ArcGIS data")}},close:{enabled:!1},upgrade:{enabled:!1},abort:{enabled:!0},ok:{text:{"default":_t("Hide this window")},classes:"ok disabled button grey",parent:"middle"}},complete:{navigation:{enabled:!1},tabs:{enabled:!1},content:{enabled:!0},progress:{enabled:!1},close:{enabled:!0},upgrade:{enabled:!1},abort:{enabled:!1},success:{enabled:{"default":!1,twitter:!0}},ok:{text:{"default":_t(""),twitter:_t("Add layer")},classes:"ok button grey",parent:"middle"}}}),cdb.admin.CartoCSSInfo=cdb.admin.BaseDialog.extend({initialize:function(){_.extend(this.options,{title:_t("Advanced map styling with CartoCSS"),width:502,clean_on_hide:!0,template_name:"old_common/views/dialog_base",include_footer:!1,modal_class:"docs_info_dialog"}),this.elder("initialize")},render_content:function(){var a=this.$content=$("<div>");return this.temp_content=cdb.templates.getTemplate("table/views/cartocss_doc"),a.append(this.temp_content()),this.$content}}),cdb.admin.PostgresInfo=cdb.admin.BaseDialog.extend({initialize:function(){_.extend(this.options,{title:_t("Performing SQL queries on CartoDB"),width:502,clean_on_hide:!0,template_name:"old_common/views/dialog_base",include_footer:!1,modal_class:"docs_info_dialog"}),this.elder("initialize")},render_content:function(){var a=this.$content=$("<div>");return this.temp_content=cdb.templates.getTemplate("table/views/postgres_doc"),a.append(this.temp_content()),this.$content}}),cdb.admin.MustacheInfo=cdb.admin.BaseDialog.extend({initialize:function(){_.extend(this.options,{title:_t("Templating infowindows in CartoDB"),width:502,clean_on_hide:!0,template_name:"old_common/views/dialog_base",include_footer:!1,modal_class:"docs_info_dialog"}),this.elder("initialize")},render_content:function(){var a=this.$content=$("<div>");return this.temp_content=cdb.templates.getTemplate("table/views/mustache_doc"),a.append(this.temp_content()),this.$content}}),cdb.admin.SmallEditorDialog=cdb.admin.SmallDialog.extend({initialize:function(){_.defaults(this.options,{template_name:"old_common/views/dialog_small_edit",ok_title:"Save",modal_class:"edit_text_dialog",clean_on_hide:!0}),cdb.ui.common.Dialog.prototype.initialize.apply(this),this.render(),$(document.body).find("div.table table").append(this.el)},render_content:function(){var a=$("<div>");return this.options.editorField&&(this.editor=new this.options.editorField({label:!1,autoResize:!1,rowNumber:this.options.rowNumber,row:this.options.row,readOnly:this.options.readOnly,model:new cdb.core.Model({attribute:this.options.column,value:this.options.value})}).bind("ENTER",this._ok,this),a.append(this.editor.render().el),this.addView(this.editor)),a},showAt:function(a,b,c,d){this.$el.css({top:b,left:a,minWidth:c}),d&&this.$el.find("textarea").css({"min-width":c-22}),this.show(),this.$el.find("textarea, input").focus().select()},_ok:function(a){return a&&a.preventDefault(),this.editor.isValid()?(this.options.res&&this.options.res(this.editor.model.get("value")),void this.hide()):!1}}),cdb.admin.FilterColumnDialog=cdb.admin.BaseDialog.extend({initialize:function(){_.extend(this.options,{title:"Filter by column",description:"",template_name:"old_common/views/dialog_base",clean_on_hide:!0,ok_button_classes:"button grey",ok_title:"Filter",modal_type:"creation",width:335,modal_class:"filter_column_dialog",error_messages:{empty:"Can't be empty!"}}),this.constructor.__super__.initialize.apply(this),_.bindAll(this,"_checkInput"),this.bind("clean",this._reClean)},render_content:function(){this.$(".content").append(this.getTemplate("table/views/filter_column_dialog")());var a=this.$el.find("input.column_name");return a.bind("keydown",this._checkInput),setTimeout(function(){a.focus()},0),this},checkColumnName:function(){var a=this.$("input.column_name").val();return""===a.trim()?!1:!0},_ok:function(a){a&&a.preventDefault(),this.options.ok&&this.options.ok(this.$("input.column_name").val()),this.hide()},_checkInput:function(a){var b=a.keyCode?a.keyCode:a.which;13!=b?this._hideError():this._ok()},_showError:function(){this.$el.find(".info").addClass("active error").html("<p>"+this.options.error_messages.empty+"</p>")},_hideError:function(){this.$el.find(".info").removeClass("active")},_reClean:function(){this.$el.find("input.column_name").unbind("keydown")}}),cdb.admin.GeocoderWorking=cdb.admin.BaseDialog.extend({_TEXTS:{georeference:{title:_t("Geocoder is already running"),description:_t("If you want to georeference using another pattern, please cancel the current                           one (at the right bottom of your screen) and start again the process."),ok:_t("Close")}},initialize:function(a){var b=this;_.extend(this.options,{title:b._TEXTS.georeference.title,description:b._TEXTS.georeference.description,template_name:"old_common/views/confirm_dialog",clean_on_hide:!0,enter_to_confirm:!0,ok_button_classes:"right button grey",ok_title:b._TEXTS.georeference.ok,cancel_button_classes:"hide",modal_type:"confirmation",width:500}),this.constructor.__super__.initialize.apply(this)}}),cdb.admin.GeocodingDialog=cdb.common.CreateDialog.extend({_TEXTS:{title:_t("Select your desired type of georeferenciation"),ok:_t("Continue")},options:{tabs:["lonlat","city","admin","postal","ip","address"],option:"lonlat"},initialize:function(){var a=this;this.tabs=this.options.tabs,this.user=this.options.user,this.table=this.options.table,this.options.states=this.options.states||cdb.common.CreateDialog.states,this.model=new cdb.admin.GeocodingDialog.Model,_.extend(this.options,{title:this._TEXTS.title,description:"",template_name:"table/views/geocoding_dialog/geocoding_dialog_base",clean_on_hide:!0,ok_button_classes:"button grey disabled",ok_title:this._TEXTS.ok,modal_type:"create-dialog geocoding-dialog",width:605,can_trial:!1}),cdb.admin.BaseDialog.prototype.initialize.apply(this),setTimeout(function(){a._checkData()},100)},render_content:function(){var a=this,b=new cdb.admin.GeocodingDialog.Content({model:this.model,user:this.user,tabs:this.tabs,states:this.options.states,option:this.options.option,table:this.table,$dialog:this.$el,template:"table/views/geocoding_dialog/geocoding_dialog_content"});b.bind("geocodingChosen",this._onGeocodingChosen,this),this.$(".content").append(b.render().el),b.bind("changeSize",function(){setTimeout(function(){a.centerInScreen(!0)},300)},this),this.addView(b)},_checkData:function(){if(!_.isEmpty(this.options.data)){this.options.data;this.model.set({state:"selected",option:"lonlat",geocoding:{longitude:this.options.data.longitude||"",latitude:this.options.data.latitude||"",valid:this.options.data.longitude&&this.options.data.latitude?!0:!1}})}},_onGeocodingChosen:function(){var a=_.extend(_.clone(this.model.get("geocoding")),{type:this.model.get("option"),table_name:this.table.get("id")});a=_.omit(a,"step","valid","agreement");var b=""===a.location||a.text&&-1!==a.location.search("world");b&&(a.location="world",a.text=!0),"admin1"===a.kind&&b&&(a.kind="admin0"),this.trigger("geocodingChosen",a,this),this.hide()},_keydown:function(a){27===a.keyCode&&this.hide()},hide:function(){this.trigger("closedDialog",this),cdb.common.CreateDialog.prototype.hide.call(this)},_ok:function(a){},clean:function(){$(document).unbind("keydown",this._keydown),cdb.common.CreateDialog.prototype.clean.call(this)}}),cdb.admin.GeocodingDialog.ColumnModel=cdb.core.Model.extend({defaults:{columnValue:"",columnText:!1},getValue:function(){return this.get("columnValue")},getText:function(){return this.get("columnText")}}),cdb.admin.GeocodingDialog.ColumnsCollection=Backbone.Collection.extend({model:cdb.admin.GeocodingDialog.ColumnModel}),cdb.admin.GeocodingDialog.AvailableGeometries=cdb.core.Model.extend({url:function(a){var b=cdb.config.urlVersion("geocoding",a);return"/api/"+b+"/geocodings/available_geometries"},parse:function(a){return{available_geometries:a}}}),cdb.admin.GeocodingDialog.Content=cdb.common.CreateDialog.Content.extend({_TABS:{lonlat:{method:"_genLonLatPane",title:_t("By Lon/Lat Columns")},city:{method:"_genCityPane",title:_t("By City <br/>Names")},admin:{method:"_genAdminPane",title:_t("By Admin. Regions")},postal:{method:"_genPostalPane",title:_t("By Postal Codes")},ip:{method:"_genIPPane",title:_t("By IP Addresses")},address:{method:"_genAddressPane",title:_t("By Street Addresses"),label:_t("geocoding")}},_TEXTS:{limits:{key:_t("<%- name %> key is not specified and panel can't be enabled"),account:_t("<%- name %> data source is not available in your plan. Please upgrade"),credits:_t("You've reached the available <%- name %> credits for your account this month"),quota:_t("Your geocoding quota is not defined, please contact us at support@cartodb.com"),georef_disabled:_t("You don't have this option available in this version")}},events:{},initialize:function(){cdb.common.CreateDialog.Content.prototype.initialize.call(this,arguments)},_genPanes:function(){var a=this;this.create_panes=new cdb.ui.common.TabPane({el:this.$(".create-panes")}),this.addView(this.create_panes),this.create_tabs.linkToPanel(this.create_panes),_.each(this.tabs,function(b){if(a._TABS[b]){var c=a[a._TABS[b].method]();c&&(a.create_panes.addTab(b,c),c.render())}else cdb.log.info("Create pane "+b+" doesn't exist")})},_genLonLatPane:function(){var a=new cdb.admin.GeocodingDialog.Pane.LonLat({table:this.options.table});return a.bind("geocodingChosen",this._onGeocodingChosen,this),a},_genCityPane:function(){if(this.user.featureEnabled("georef_disabled"))return this._setFailedTab("city","georef_disabled"),!1;var a=new cdb.admin.GeocodingDialog.Pane.DefaultGeocoder({table:this.options.table,kind:"namedplace",template:"table/views/geocoding_dialog/geocoding_dialog_pane_city"});return a.bind("geocodingChosen",this._onGeocodingChosen,this),a.bind("changeSize",this._onPaneChangeSize,this),a},_genAdminPane:function(){if(this.user.featureEnabled("georef_disabled"))return this._setFailedTab("admin","georef_disabled"),!1;var a=new cdb.admin.GeocodingDialog.Pane.DefaultGeocoder({table:this.options.table,kind:"admin1",template:"table/views/geocoding_dialog/geocoding_dialog_pane_admin"});return a.bind("geocodingChosen",this._onGeocodingChosen,this),a.bind("changeSize",this._onPaneChangeSize,this),a},_genPostalPane:function(){if(this.user.featureEnabled("georef_disabled"))return this._setFailedTab("postal","georef_disabled"),!1;var a=new cdb.admin.GeocodingDialog.Pane.DefaultGeocoder({table:this.options.table,kind:"postalcode",template:"table/views/geocoding_dialog/geocoding_dialog_pane_postal"});return a.bind("geocodingChosen",this._onGeocodingChosen,this),a.bind("changeSize",this._onPaneChangeSize,this),a},_genIPPane:function(){if(this.user.featureEnabled("georef_disabled"))return this._setFailedTab("ip","georef_disabled"),!1;var a=new cdb.admin.GeocodingDialog.Pane.IP({table:this.options.table});return a.bind("geocodingChosen",this._onGeocodingChosen,this),a},_genAddressPane:function(){var a=this.user.featureEnabled("google_maps"),b=this.user.get("geocoding");if(this.user.featureEnabled("georef_disabled"))return this._setFailedTab("address","georef_disabled"),!1;if(!(a||b&&null!==b.quota))return this._setFailedTab("address","quota"),!1;if(!a&&b.quota-b.monthly_use<=0&&b.hard_limit)return this._setFailedTab("address","credits"),!1;var c=new cdb.admin.GeocodingDialog.Pane.Address({table:this.options.table,user:this.options.user});return c.bind("geocodingChosen",this._onGeocodingChosen,this),c.bind("changeSize",this._onPaneChangeSize,this),c},_genErrorPane:function(){return new cdb.admin.ImportErrorPane({model:this.model})},_genActionsController:function(){},_createTooltip:function(a,b){var c=this,d=this.create_tabs.getTab(a),e=new cdb.common.TipsyTooltip({el:d,title:function(){return _.template(c._TEXTS.limits[b])({name:c._TABS[a].label||c._TABS[a].title})}});this.addView(e)},_setBinds:function(){this.create_panes.bind("tabEnabled",this._onTabChange,this),this.model.bind("change:state",this._onStateChange,this),this.model.bind("change:option",this._onOptionChange,this)},_onTabChange:function(a){if("error"!==a){var b=this.create_panes.getPane(a),c=this.create_panes.getPane(a).getValue();b.setActive(),this.model.set({option:a,geocoding:c}),this._onPaneChangeSize()}},_hideTitle:function(){this.options.$dialog.find("h3").addClass("disabled")},_onOptionChange:function(){this._hideTitle()},_onStateChange:function(a,b){if("selected"===this.model.get("state")){var c=this.create_panes.getPane(this.model.get("option"));
c.setValue(this.model.get("geocoding"))}},_onGeocodingChosen:function(a){this.model.set("geocoding",a),this.trigger("geocodingChosen",this.model.attributes,this)},_onPaneChangeSize:function(){this.trigger("changeSize",this)}}),cdb.admin.GeocodingDialog.EstimationModel=cdb.core.Model.extend({urlRoot:function(){var a=cdb.config.urlVersion("geocoding","read");return"/api/"+a+"/geocodings/estimation_for/"}}),cdb.admin.GeocodingDialog.Model=cdb.core.Model.extend({defaults:{state:"idle",option:"lonlat",geocoding:{type:"",valid:!1}}}),cdb.admin.GeocodingDialog.Pane=cdb.core.View.extend({_NON_VALID_COLUMS:["cartodb_id","the_geom","updated_at","created_at","cartodb_georef_status"],events:{"click a.ok":"_onOkClick"},initialize:function(){this.model=new cdb.admin.GeocodingDialog.Pane.Model,this.template=cdb.templates.getTemplate(this.options.template||"table/views/geocoding_dialog/geocoding_dialog_pane"),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.empty(),this.$el.append(this.template(this.model.attributes)),this._initViews(),this},_initBinds:function(){_.bindAll(this,"_onOkClick")},_initViews:function(){},getValue:function(){return this.model.toJSON()},setActive:function(){},setValue:function(a){this.model&&this.model.set(a)},_getTableColumns:function(){var a=this;return _.compact(_.map(this.table.get("schema"),function(b){return _.contains(a._NON_VALID_COLUMS,b[0])?null:b[0]}))},_onOkClick:function(a){a&&this.killEvent(a)}}),cdb.admin.GeocodingDialog.Pane.Address=cdb.admin.GeocodingDialog.Pane.extend({className:"geocoding-pane-default geocoding-pane-address",_GEOCODING_BLOCK_SIZE:1e3,_TEXTS:{placeholder:_t("Select column or type it"),error:{valid:_t("You need to specify, at least, the column where your addresses are"),agreement:_t("It is necessary to accept the cost of this geocoding task")}},events:{"click .geocoding-pane-terms label":"_onLabelClick","click #geocoding-address-terms":"_onTermsClick","click a.ok":"_onOkClick"},initialize:function(){this.user=this.options.user,this.table=this.options.table,this.model=new cdb.admin.GeocodingDialog.Pane.Model({valid:!1,formatter:"",kind:"high-resolution"}),this._createCustomModels(),this.template=cdb.templates.getTemplate("table/views/geocoding_dialog/geocoding_dialog_pane_address"),this._initBinds(),this.estimation.fetch()},render:function(){return this.clearSubViews(),this.$el.empty(),this.$el.append(this.template(_.extend({googleUser:this.user.featureEnabled("google_maps"),agreement:this.model.get("agreement"),estimation_cost:this.estimation.get("estimation"),estimation_rows:this.estimation.get("rows"),block_size:this._GEOCODING_BLOCK_SIZE},this.user.get("geocoding")))),this._initBinds(),this._initViews(),this},_initBinds:function(){_.bindAll(this,"_onOkClick","_onTermsClick"),this.model.bind("change:agreement",this._onTermsChange,this),this.model.bind("change:valid",this._onModelChange,this),this.country_model.bind("change",this._onCustomModelChange,this),this.add_related_model(this.country_model),this.state_model.bind("change",this._onCustomModelChange,this),this.add_related_model(this.state_model),this.address_model.bind("change",this._onCustomModelChange,this),this.add_related_model(this.address_model),this.additional_columns.bind("add remove change",this._onAdditionalColumnsChange,this),this.add_related_model(this.additional_columns),this.estimation.bind("change",this._onEstimationChange,this),this.estimation.bind("error",this._onEstimationError,this),this.add_related_model(this.estimation)},_initViews:function(){var a=new cdb.forms.CustomTextCombo({model:this.address_model,property:"columnValue",text:"columnText",width:"176px",placeholder:this._TEXTS.placeholder,extra:this._getTableColumns()});this.$(".address").append(a.render().el),this.addView(a);var b=new cdb.forms.CustomTextCombo({model:this.state_model,property:"columnValue",text:"columnText",width:"176px",placeholder:this._TEXTS.placeholder,extra:this._getTableColumns()});this.$(".state").append(b.render().el),this.addView(b);var c=new cdb.forms.CustomTextCombo({model:this.country_model,property:"columnValue",text:"columnText",width:"176px",placeholder:this._TEXTS.placeholder,extra:this._getTableColumns()});this.$(".country").append(c.render().el),this.addView(c),this.pane_info=new cdb.admin.ImportInfo({el:this.$("div.infobox"),model:this.model}),this.addView(this.pane_info);var d=new cdb.admin.GeocodingDialog.Pane.Address.Additional({el:this.$(".geocoding-additional-columns"),collection:this.additional_columns,model:this.address_model,columns_list:this._getTableColumns()});d.render(),this.addView(d);var e=new cdb.common.TipsyTooltip({el:this.$("i.help")});this.addView(e)},_createCustomModels:function(){this.estimation=new cdb.admin.GeocodingDialog.EstimationModel({id:this.table.getUnquotedName()}),this.country_model=new cdb.admin.GeocodingDialog.ColumnModel,this.state_model=new cdb.admin.GeocodingDialog.ColumnModel,this.address_model=new cdb.admin.GeocodingDialog.ColumnModel,this.additional_columns=new cdb.admin.GeocodingDialog.ColumnsCollection},_onEstimationChange:function(){var a=this.user.featureEnabled("google_maps"),b=this.user.get("geocoding").hard_limit,c=void 0!==this.estimation.get("estimation");a||b||!(this.estimation.get("estimation")>0||!c&&!b)?(a||b)&&this.model.unset("agreement"):this.model.set("agreement",!1),this.render()},_onEstimationError:function(){this.user.get("geocoding").hard_limit?this.model.unset("agreement"):this.model.set("agreement",!1),this.estimation.set({estimation:-1,rows:-1})},_onModelChange:function(){this.$(".ok")[this.model.get("valid")?"removeClass":"addClass"]("disabled")},_onAdditionalColumnsChange:function(){this.trigger("changeSize",this),this._onCustomModelChange()},_onCustomModelChange:function(){var a="",b=this.address_model.getValue();if(b){var c=this.address_model.getText();""!==a&&(a+=", "),a+=c?b.trim():"{"+b+"}"}this.additional_columns.size()>0&&this.additional_columns.each(function(b){var c=b.getValue();if(c){var d=b.getText();""!==a&&(a+=", "),a+=d?c.trim():"{"+c+"}"}});var d=this.state_model.getValue();if(d){var c=this.state_model.getText();""!==a&&(a+=", "),a+=c?d.trim():"{"+d+"}"}var e=this.country_model.getValue();if(e){var c=this.country_model.getText();""!==a&&(a+=", "),a+=c?e.trim():"{"+e+"}"}this.model.set({formatter:a,valid:a?!0:!1}),this.pane_info.hideTab()},_onTermsClick:function(a){a&&this.killEvent(a);var b=this.$("#geocoding-address-terms").hasClass("enabled");void 0!==this.model.get("agreement")&&this.model.set("agreement",!b),b||(this.pane_info.hideTab(),this._setInputError(!1))},_onTermsChange:function(){this.$("#geocoding-address-terms")[this.model.get("agreement")?"addClass":"removeClass"]("enabled")},_onLabelClick:function(a){var b=$(a.target).closest("a");0===b.length&&(a&&this.killEvent(a),this._onTermsClick())},_getTableColumns:function(){var a=this,b=this.table.get("original_schema")||this.table.get("schema"),c=["string","number","boolean","date"];return _.filter(b,function(b){var d=b[0],e=b[1];return _.contains(c,e)&&!_.contains(a._NON_VALID_COLUMS,d)}).map(function(a){a[0];return[a[1],a[0]]})},_setInputError:function(a){this.$(".geocoding-pane-terms label")[a?"addClass":"removeClass"]("error")},_onOkClick:function(a){return a&&this.killEvent(a),this.model.get("valid")===!1?(this.pane_info.activeTab("error",this._TEXTS.error.valid),!1):void 0!==this.model.get("agreement")&&this.model.get("agreement")===!1?(this.pane_info.activeTab("error",this._TEXTS.error.agreement),this._setInputError(!0),!1):(this.pane_info.hideTab(),void this.trigger("geocodingChosen",this.model.attributes,this))},clean:function(){this.additional_columns.reset(),cdb.admin.GeocodingDialog.Pane.prototype.clean.call(this)}}),cdb.admin.GeocodingDialog.Pane.Address.Additional=cdb.core.View.extend({_MAX_ADDITIONAL_COLUMNS:2,events:{"click a.add_column":"_onAddColumnClick"},initialize:function(){this._initBinds()},render:function(){return this.clearSubViews(),this.collection.each(this._addItem,this),this._initViews(),this._checkLink(),this},_initBinds:function(){_.bindAll(this,"_onAddColumnClick"),this.collection.bind("add",this._addItem,this),this.collection.bind("remove",this._removeItem,this),this.collection.bind("reset",this.render,this),this.collection.bind("add remove reset change",this._checkLink,this),this.add_related_model(this.collection),this.model.bind("change",this._checkLink,this)},_initViews:function(){var a=new cdb.common.TipsyTooltip({el:this.$(".add_column")});this.addView(a)},_addItem:function(a){var b=new cdb.admin.GeocodingDialog.Pane.Address.Additional.Item({model:a,columns_list:this.options.columns_list});this.$el.append(b.render().el),this.addView(b)},_removeItem:function(a){},_checkLink:function(){var a=this.collection.size()<this._MAX_ADDITIONAL_COLUMNS,b=this.collection.where({value:""}).length,c=this.model.get("value");this.$(".add_column")[a?"show":"hide"]()[0===b&&""!==c?"removeClass":"addClass"]("disabled")},_onAddColumnClick:function(a){a&&this.killEvent(a);var b=this.collection.size()<this._MAX_ADDITIONAL_COLUMNS,c=this.collection.where({value:""}).length,d=this.model.get("value");b&&0===c&&""!==d&&this.collection.add({value:""})}}),cdb.admin.GeocodingDialog.Pane.Address.Additional.Item=cdb.core.View.extend({tagName:"li",_TEXTS:{placeholder:_t("Select column or type it")},initialize:function(){this.template=cdb.templates.getTemplate("table/views/geocoding_dialog/geocoding_dialog_pane_address_additional_item")},render:function(){return this.$el.append(this.template(this.model.attributes)),this._initViews(),this},_initViews:function(){var a=new cdb.forms.CustomTextCombo({model:this.model,property:"value",text:"text",width:"176px",placeholder:this._TEXTS.placeholder,extra:this.options.columns_list});this.$(".geocoding-pane-select").append(a.render().el),this.addView(a)}}),cdb.admin.GeocodingDialog.Pane.Admin=cdb.admin.GeocodingDialog.Pane.extend({className:"geocoding-pane-default geocoding-pane-admin",_TEXTS:{placeholder:_t("Select the column(s)")},initialize:function(){this.table=this.options.table,this.model=new cdb.admin.GeocodingDialog.Pane.Model({valid:!1,longitude:"",latitude:""}),this.template=cdb.templates.getTemplate(this.options.template||"table/views/geocoding_dialog/geocoding_dialog_pane"),this._initBinds()},_initBinds:function(){this.model.bind("change",this._onModelChange,this)},_initViews:function(){},_onModelChange:function(){}}),cdb.admin.GeocodingDialog.Pane.DefaultGeocoder=cdb.admin.GeocodingDialog.Pane.extend({className:"geocoding-pane-default geocoding-pane-default-geocoder",events:{"click a.back":"_onBackClick","click a.ok":"_onOkClick"},_TEXTS:{placeholder:{column:_t("Select the column(s)"),column_text:_t("Select column or type it")},error:_t("You must select at least one column.")},initialize:function(){this.table=this.options.table,this.available_geometries=new cdb.admin.GeocodingDialog.AvailableGeometries({kind:this.options.kind}),this.model=new cdb.admin.GeocodingDialog.Pane.Model({valid:!1,column_name:"",location:"",geometry_type:"",text:!1,kind:this.options.kind||"anytype",step:0}),this.template=cdb.templates.getTemplate(this.options.template||"table/views/geocoding_dialog/geocoding_dialog_pane_default_geocoder"),this._initBinds()},_initBinds:function(){_.bindAll(this,"_onBackClick","_onOkClick"),this.model.bind("change",this._onModelChange,this),this.model.bind("change",this._checkOkButton,this),this.model.bind("change:step",this._onChangeStep,this),this.model.bind("change:location",this._getAvailableGeometries,this),this.available_geometries.bind("change:available_geometries",this._checkOkButton,this),this.add_related_model(this.available_geometries)},_initViews:function(){var a=new cdb.forms.Combo({model:this.model,property:"column_name",width:"178px",placeholder:this._TEXTS.placeholder.column,extra:this._getTableColumns()});this.addView(a),this.$(".geocoding-pane-select.kind").append(a.render().el);var b=new cdb.forms.CustomTextCombo({model:this.model,property:"location",text:"text",width:"178px",placeholder:this._TEXTS.placeholder.column_text,extra:this._getTableColumnsWithType()});if(this.addView(b),this.$(".geocoding-pane-select.location").append(b.render().el),1===this.$(".geocoding-pane-select.region").length){var c=new cdb.forms.CustomTextCombo({model:this.model,property:"region",text:"region_text",width:"178px",placeholder:this._TEXTS.placeholder.column_text,extra:this._getTableColumnsWithType()});this.addView(c),this.$(".geocoding-pane-select.region").append(c.render().el)}this.pane_info=new cdb.admin.ImportInfo({el:this.$("div.infobox"),model:this.model}),this.addView(this.pane_info),this.geocoder_styles=new cdb.admin.GeocodingDialog.Content.Styles({model:this.model,available_geometries:this.available_geometries}),this.addView(this.geocoder_styles),this.$(".geocoding-pane-step.second").append(this.geocoder_styles.render().el)},_onModelChange:function(){var a=this.model.get("column_name")&&this.model.get("location")&&this.model.get("geometry_type");this.model.set("valid",a?!0:!1)},_getAvailableGeometries:function(){var a=this.model.get("text"),b=this.model.get("location"),c={kind:this.options.kind};""===b?c.free_text="World":a?c.free_text=b:c=_.extend(c,{column_name:b,table_name:this.table.get("id")}),this.available_geometries.unset("available_geometries"),this.available_geometries.fetch({data:c})},_onChangeStep:function(){var a=this.model.get("step");this._changePaneHeight(250),this.$("a.back")[0===a?"hide":"show"]();var b=this.$(".geocoding-pane-step.second").position();if(b&&b.left){var c=b.left;this.$(".geocoding-pane-content-wrapper").animate({"margin-left":0===a?0:-c+40},{duration:350,queue:!1}),this.trigger("changeSize",this)}},_changePaneHeight:function(a){var b=this.model.get("step"),c=0===b?this.$(".geocoding-pane-step.first").height():this.$(".geocoding-pane-step.second").height();this.$(".geocoding-pane-content").animate({height:c},{duration:a||0,queue:!1})},_checkOkButton:function(){var a=this.model.get("column_name");0===this.model.get("step")?this.$("a.ok")[a?"removeClass":"addClass"]("disabled"):(a=a&&this.available_geometries.get("available_geometries")&&this.available_geometries.get("available_geometries").length>0,this.$("a.ok")[a?"removeClass":"addClass"]("disabled"))},_onBackClick:function(a){a&&this.killEvent(a),this.model.set({geometry_type:"",step:0})},_getTableColumnsWithType:function(){var a=this,b=this.table.get("original_schema")||this.table.get("schema"),c=["string","number","boolean","date"];return _.filter(b,function(b){var d=b[0],e=b[1];return _.contains(c,e)&&!_.contains(a._NON_VALID_COLUMS,d)}).map(function(a){a[0];return[a[1],a[0]]})},setActive:function(){this._changePaneHeight(0);var a=this.available_geometries.get("available_geometries");(!a||a&&0===a.length)&&this._getAvailableGeometries()},_onOkClick:function(a){if(a&&this.killEvent(a),this.model.get("column_name")){var b=this.model.get("step");0===b?this.model.set("step",1):this.model.get("geometry_type")&&this.trigger("geocodingChosen",this.model.attributes,this),this.pane_info.hideTab()}else{var c=this;this.pane_info.activeTab("error",this._TEXTS.error),setTimeout(function(){c._changePaneHeight(0)},400)}}}),cdb.admin.GeocodingDialog.Pane.IP=cdb.admin.GeocodingDialog.Pane.extend({className:"geocoding-pane-default geocoding-pane-ip",_TEXTS:{placeholder:_t("Select the column(s)"),error:_t("You have to select a column")},initialize:function(){this.table=this.options.table,this.model=new cdb.admin.GeocodingDialog.Pane.Model({valid:!1,column_name:"",kind:"ipaddress",geometry_type:"point"}),this.template=cdb.templates.getTemplate(this.options.template||"table/views/geocoding_dialog/geocoding_dialog_pane_ip"),this._initBinds()},_initBinds:function(){_.bindAll(this,"_onOkClick"),this.model.bind("change:column_name",this._onModelChange,this),this.model.bind("change:valid",this._onValidChange,this)},_initViews:function(){var a=new cdb.forms.Combo({model:this.model,property:"column_name",width:"172px",placeholder:this._TEXTS.placeholder,extra:this._getTableColumns()});this.addView(a),this.$(".geocoding-pane-select.ip").append(a.render().el),this.pane_info=new cdb.admin.ImportInfo({el:this.$("div.infobox"),model:this.model}),this.addView(this.pane_info)},_onValidChange:function(){this.$("a.ok")[this.model.get("valid")?"removeClass":"addClass"]("disabled")},_onModelChange:function(){var a=this.model.get("column_name")?!0:!1;this.model.set("valid",a),a&&this.pane_info.hideTab()},_onOkClick:function(a){a&&this.killEvent(a),this.model.get("valid")?this.trigger("geocodingChosen",this.model.attributes,this):this.pane_info.activeTab("error",this._TEXTS.error)}}),cdb.admin.GeocodingDialog.Pane.LonLat=cdb.admin.GeocodingDialog.Pane.extend({className:"geocoding-pane-lonlat",_TEXTS:{placeholder:_t("Select the column(s)"),error:_t("You have to select longitude and latitude")},initialize:function(){this.table=this.options.table,this.model=new cdb.admin.GeocodingDialog.Pane.Model({valid:!1,longitude:"",latitude:""}),this.template=cdb.templates.getTemplate(this.options.template||"table/views/geocoding_dialog/geocoding_dialog_pane_lonlat"),this._initBinds()},_initBinds:function(){_.bindAll(this,"_onOkClick"),this.model.bind("change:latitude change:longitude",this._onModelChange,this),this.model.bind("change:valid",this._onValidChange,this)},_initViews:function(){var a=new cdb.forms.Combo({model:this.model,property:"latitude",width:"220px",placeholder:this._TEXTS.placeholder,extra:this._getTableColumns()});this.addView(a),this.$(".table-column.latitude").append(a.render().el);var b=new cdb.forms.Combo({model:this.model,property:"longitude",width:"220px",placeholder:this._TEXTS.placeholder,extra:this._getTableColumns()});this.addView(b),this.$(".table-column.longitude").append(b.render().el),this.pane_info=new cdb.admin.ImportInfo({el:this.$("div.infobox"),model:this.model}),this.addView(this.pane_info),this._checkSelectedColumns()},_checkSelectedColumns:function(){this.model.set({longitude:this.$(".table-column.longitude select").val(),latitude:this.$(".table-column.latitude select").val()})},_onValidChange:function(){this.$("a.ok")[this.model.get("valid")?"removeClass":"addClass"]("disabled")},_onModelChange:function(){var a=this.model.get("latitude")&&this.model.get("longitude")?!0:!1;this.model.set("valid",a),a&&this.pane_info.hideTab()},setValue:function(a){this.model&&this.model.set(a),this.render()},_onOkClick:function(a){a&&this.killEvent(a),this.model.get("valid")?(this.trigger("geocodingChosen",this.model.attributes,this),this.pane_info.hideTab()):this.pane_info.activeTab("error",this._TEXTS.error)}}),cdb.admin.GeocodingDialog.Pane.Postal=cdb.admin.GeocodingDialog.Pane.extend({className:"geocoding-pane-default geocoding-pane-postal",_TEXTS:{placeholder:_t("Select the column(s)")},initialize:function(){this.table=this.options.table,this.model=new cdb.admin.GeocodingDialog.Pane.Model({valid:!1,longitude:"",latitude:""}),this.template=cdb.templates.getTemplate(this.options.template||"table/views/geocoding_dialog/geocoding_dialog_pane"),this._initBinds()},_initBinds:function(){this.model.bind("change",this._onModelChange,this)},_initViews:function(){},_onModelChange:function(){}}),cdb.admin.GeocodingDialog.Pane.Model=cdb.core.Model.extend({"default":{valid:!1}}),cdb.admin.GeocodingDialog.Content.Styles=cdb.core.View.extend({tagName:"ul",className:"geocoding-pane-styles",events:{"click .opt":"_onGeometryTypeClick"},initialize:function(){this.template=cdb.templates.getTemplate("table/views/geocoding_dialog/geocoding_dialog_styles"),this.available_geometries=this.options.available_geometries,this._initBinds()},render:function(){return this.clearSubViews(),this.$el.empty(),this.$el.append(this.template({available:this.available_geometries.get("available_geometries"),point:this._validGeometry("point"),polygon:this._validGeometry("polygon")})),this._initViews(),this},_initBinds:function(){_.bindAll(this,"_onGeometryTypeClick"),this.model.bind("change:country_code",this.render,this),this.model.bind("change:geometry_type",this._onGeometryChange,this),this.model.bind("change:step",this._onStepChange,this),this.available_geometries.bind("change:available_geometries",this.render,this),this.add_related_model(this.available_geometries)},_initViews:function(){var a=new cdb.common.TipsyTooltip({el:this.$("span em"),title:function(){return $(this).attr("data-title")}});this.addView(a)},_onStepChange:function(){var a=this.model.get("step"),b=this;0!==a&&(this._validGeometry("point")?this.model.set("geometry_type","point"):this._validGeometry("polygon")&&this.model.set("geometry_type","polygon")),setTimeout(function(){b.$("li.selected")[0===a?"removeClass":"addClass"]("animated")},500)},_onGeometryChange:function(){var a=this.model.get("geometry_type");this.$("li").removeClass("selected"),a&&this.$("li."+a).addClass("selected")},_validGeometry:function(a){var b=this.available_geometries.get("available_geometries");return b&&b.length>0?_.contains(b,a):!1},_onGeometryTypeClick:function(a){a&&this.killEvent(a);var b=$(a.target).closest("a"),c=b.attr("href").replace("#/","");this._validGeometry(c)&&this.model.set("geometry_type",c)}}),cdb.admin.GeocodingMessageDialog=cdb.admin.BaseDialog.extend({initialize:function(a){_.extend(this.options,{template_name:"table/views/geocoding_message_dialog_base",clean_on_hide:!0,enter_to_confirm:!0,ok_button_classes:"button grey",ok_title:"Continue",cancel_button_classes:"underline margin15",style:a.style||"point",width:512,modal_class:"geocoding_message_dialog"}),this.constructor.__super__.initialize.apply(this)},animate:function(){this.$(".opt").addClass("animated selected")},render_content:function(){return this.getTemplate("table/views/geocoding_message_dialog_content")(this.options)}}),cdb.admin.GeocodingResult=cdb.core.View.extend({_TEXTS:{error:{title:_t("Georeference Error"),desc:_t("There was a problem georeferencing your data. Please, get in contact with support to receive assistance.")},success:{title:{empty:_t("No rows were georeferenced")}},paid:"<% if (!success) { %><p>It seems that some of your rows didn't finish successfully. Perhaps these rows contained empty values or perhaps we just didn't know what the values meant. <% if (!googleUser) { %>Unsuccessful rows don't count against your quota, so we encourage you to take a look and try again.<% } %></p><% } %><% if (!googleUser) { %><p><% if (price == 0) { %>This job cost you <strong>$0</strong> because we love you! You have <strong><%- remaining_quota %></strong> geocoding tokens remaining in your free quota this month.<% } else { %>This job cost you <strong>$<%- price/100 %></strong> because <strong><%- used_credits %></strong> geocoding credit<%- used_credits == 1 ? '' : 's'  %> <%- used_credits == 1 ? 'was' : 'were'  %> over your freely available quota. This will be added to next months bill.<% } %></p><% } %>",one_paid:"<% if (!success) { %><p>It seems that some of your rows didn't finish successfully. Perhaps these rows contained empty values or perhaps we just didn't know what the values meant. <% if (!googleUser) { %>Unsuccessful rows don't count against your quota, so we encourage you to take a look and try again.<% } %></p><% } %><% if (!googleUser) { %><p><% if (price == 0) { %>This job cost you <strong>$0</strong> because we love you! You have <strong><%- remaining_quota %></strong> geocoding tokens remaining in your free quota this month.<% } else { %>This job cost you <strong>$<%- price/100 %></strong> because <strong><%- used_credits %></strong> geocoding credit<%- used_credits == 1 ? '' : 's'  %> <%- used_credits == 1 ? 'was' : 'were'  %> over your freely available quota. This will be added to next months bill.<% } %></p><% } %>",zero_paid:"<p>Perhaps these rows contained empty values or perhaps we just didn't know what the values meant.</p><% if (!googleUser) { %><p>Unsuccessful rows don't count against your quota, so we encourage you to take a look and try again.</p><% } %>",free:"<% if (!success){ %><p>It seems that some of your rows didn't finish successfully. Perhaps these rows contained empty values or perhaps we just didn't know what the values meant. We encourage you to take a look and try again.</p><% } %><p><% if (!googleUser) { %>This job cost you <strong>$0</strong> because we love you for being you!<% } else { %><% } %></p>",zero_free:"<p>It seems that some of your rows didn't finish successfully. Perhaps these rows contained empty values or perhaps we just didn't know what the values meant. We encourage you to take a look and try again.</p>",zero_processable:"<p>It seems that there are no georeferenceable rows. Please make sure that you have more than one row and that, if the column cartodb_georef_status exists, some of them have it set to null.</p>"},initialize:function(){this.user=this.options.user,this.completed_geocodings=[],this.geocoder=this.options.geocoder,this._initBinds()},_initBinds:function(){this.geocoder.bind("geocodingError geocodingComplete",this._onGeocodingChange,this),this.add_related_model(this.geocoder)},_onGeocodingChange:function(a,b){if(a.id){var c=_.contains(this.completed_geocodings,a.id);if(c)return!1;this.completed_geocodings.push(a.id)}"finished"===a.state?this._onGeocodingComplete(a,b):this._onGeocodingError(a,b)},_onGeocodingError:function(a,b){this.dlg&&this.dlg.hide();var c=this.dlg=new cdb.admin.GeocodingMessageDialog({style:a.geometry_type||"polygon",modal_type:"error",title:a.title||this._TEXTS.error.title,description:a.description||this._TEXTS.error.desc});c.appendToBody().open(),c.animate()},_onGeocodingComplete:function(a){var b,c,d=a.real_rows>0&&a.real_rows-a.processable_rows==0,e=cdb.Utils.formatNumber(a.real_rows),f=cdb.Utils.formatNumber(a.processable_rows);if(a.success=d,a.googleUser=this.user.featureEnabled("google_maps"),"high-resolution"!=a.kind)d?(b=(1==a.real_rows?"One":e)+" out of "+(1==a.processable_rows?"one":f)+" row"+(1==a.processable_rows?" ":"s ")+(1==a.processable_rows?"was":"were")+" succesfully turned into "+(a.geometry_type||"point")+"s!",c=1==a.real_rows?_.template(this._TEXTS.free)(a):_.template(this._TEXTS.free)(a)):0==a.real_rows?(b=this._TEXTS.success.title.empty,c=0==a.processable_rows?_.template(this._TEXTS.zero_processable)(a):_.template(this._TEXTS.zero_free)(a)):(b=(1==a.real_rows?"One":e)+" out of "+(1==a.processable_rows?"one":f)+" row"+(1==a.processable_rows?" ":"s ")+(1==a.processable_rows?"was":"were")+" succesfully turned into "+(a.geometry_type||"point")+"s!",c=_.template(this._TEXTS.free)(a));else{a.real_rows;b=(1==a.real_rows?"One":e)+" out of "+(1==a.processable_rows?"one":f)+" row"+(1==a.processable_rows?" ":"s ")+(1==a.processable_rows?"was":"were")+" succesfully turned into "+(a.geometry_type||"point")+"s!",d?c=1==a.real_rows?_.template(this._TEXTS.one_paid)(a):_.template(this._TEXTS.paid)(a):0==a.real_rows?(b=this._TEXTS.success.title.empty,c=0==a.processable_rows?_.template(this._TEXTS.zero_processable)(a):_.template(this._TEXTS.zero_paid)(a)):c=_.template(this._TEXTS.paid)(a)}this.dlg&&this.dlg.hide();var g=this.dlg=new cdb.admin.GeocodingMessageDialog({style:a.geometry_type,modal_type:"notification",title:b,description:c});g.appendToBody().open(),g.animate()}}),cdb.admin.GeometryEditor=cdb.core.View.extend({className:"editing",MAX_VERTEXES:2e3,events:{"click .done":"finish","click .discard":"discard","click .cancel":"discard",mousedown:"killEvent"},TEXTS:{"invalid geometry":_t("Overlapping polygons is not supported for same record")},initialize:function(){this.add_related_model(this.model),this.geomBeingEdited=null,this.drawer=null},isEditing:function(){return this.geomBeingEdited?!0:!1},finish:function(a){if(this.killEvent(a),this.drawer&&this.drawer.canFinish()||this.isEditing()){var b=this;this.geomBeingEdited&&(this.geomBeingEdited.destroy(),this.geomBeingEdited=null),this.drawer&&(this.row.set("the_geom",JSON.stringify(this.drawer.getGeoJSON())),this.drawer.clean(),this.drawer=null);var c=this.row.isNew();this.model.notice("Saving ... ","load"),$.when(this.row.save(null)).done(function(){c&&b.trigger("geomCreated",b.row),b.trigger("editFinish"),b.model.notice("Saved","info",5e3),b.row=null}).fail(function(a){b.trigger("editFinish");var c="Something has failed";try{c=JSON.parse(a.responseText||a.response).errors[0]}catch(a){}c=b.TEXTS[c.toLowerCase()]||c,b.model.notice(c,"error",5e3),b.row=null}),this.hide()}},discard:function(a){this.killEvent(a),this.geomBeingEdited&&(this.geomBeingEdited.destroy(),this.geomBeingEdited=null,this.row.set("the_geom",this.originalGeom),this.originalGeom=null,this.row=null,this.trigger("editDiscard")),this.drawer&&(this.drawer.clean(),this.drawer=null,this.trigger("editDiscard")),this.mapView.unbind(null,null,this),this.hide()},_getGeomCount:function(a){var b=0;return _.each(a.coordinates,function(a,c){_.each(a,function(a,c){b+=a.length})}),b},editGeom:function(a){var b=this;a.fetch({success:function(){var c=JSON.parse(a.get("the_geom"));return b._getGeomCount(c)>b.MAX_VERTEXES?(b._showStopEdit(a),!1):void b._startEdition(a)}})},_startEdition:function(a){this.trigger("editStart"),this.discard();var b=new cdb.geo.Geometry({geojson:JSON.parse(a.get("the_geom")),style:{fillColor:"white",fillOpacity:.4,weight:4,color:"#397DBA",opacity:1,strokeColor:"#397DBA",clickable:!1}});this.row=a,this.originalGeom=a.get("the_geom"),this.geomBeingEdited=b,b.bind("change:geojson",function(){a.set({the_geom:JSON.stringify(b.get("geojson"))})}),this.mapView.map.addGeometry(b);var c=this.mapView.geometries[b.cid];c.edit(!0),this.$(".finish_editing .tooltip").hide(),this.$el.fadeIn()},_showStopEdit:function(a){var b=this,c=new cdb.admin.BaseDialog({title:"This geometry is too big to edit from the web",description:"Editing this geometry could freeze or crash your browser, and you could lose your work. We encourage you to edit this feature through the API.",template_name:"old_common/views/confirm_dialog",clean_on_hide:!0,enter_to_confirm:!0,ok_button_classes:"right button grey",ok_title:"I'll take the risk",cancel_button_classes:"underline margin15",cancel_title:"Cancel",modal_type:"confirmation",width:500});c.ok=function(){b._startEdition(a)},c.appendToBody().open()},createGeom:function(a,b){var c=this;this.discard(),this.row=a,this.geomType=b,this.trigger("editStart");var d={point:PointDrawTool,polygon:PolygonDrawTool,line:PolylineDrawTool};this.drawer=new d[b]({mapview:this.mapView}),this.drawer.start();var e;this.mapView.bind("click",e=function(){c.drawer.canFinish()&&(this.mapView.unbind("click",e),c.$(".finish_editing .tooltip").fadeOut(),c.$(".finish_editing .done").removeClass("disabled"))},this),this.render(),this.$(".finish_editing .done").addClass("disabled"),this.$(".finish_editing .tooltip").show(),this.$el.fadeIn()},render:function(){return this.$el.html(this.getTemplate("table/views/geom_edit")({geom_type:this.geomType})),this}}),cdb.admin.CreateVizDialog=cdb.admin.BaseDialog.extend({_TEXTS:{title:_t("Save your map"),desc:_t("A map is a mix of layers, styles and SQL. Your               maps are now accessible from your dashboard."),button:_t("Create map"),error:_t("The map name can't be blank"),creation:{error:{description:_t("Something has failed in the process."),about:_t('Please, try again and if the problem persist contact us at <a href="mailto:support@cartodb.com">support@cartodb.com</a>')}}},events:cdb.core.View.extendEvents({"keydown input":"_checkEnter"}),initialize:function(){_.extend(this.options,{title:this._TEXTS.title,description:this._TEXTS.desc,template_name:"table/header/views/create_visualization_dialog_base",clean_on_hide:!0,ok_button_classes:"button green",ok_title:this._TEXTS.button,modal_type:"creation",modal_class:"create_visualization",width:450,error_messages:{blank:this._TEXTS.error}}),_.bindAll(this,"onCreationError","_onCreationSuccess"),this.state=0,this.new_vis_name="",this.old_vis_name=this.model.get("name"),this.constructor.__super__.initialize.apply(this);
},render_content:function(){var a=this.$content=$("<div>");return this.template=cdb.templates.getTemplate("table/header/views/create_visualization_dialog"),a.append(this.template(this.options)),setTimeout(function(){a.find("input").focus()},300),a},_checkEnter:function(a){var b=a.keyCode?a.keyCode:a.which;13==b&&0==this.state&&(this.killEvent(a),this._ok())},_keydown:function(a){27===a.keyCode&&1!=this.state&&this._cancel()},_isValidName:function(){var a=this.$content.find("input").val();return a.length>0&&" "!=a},_showInputError:function(){this.$("div.info").addClass("active error")},_hideInputError:function(){this.$("div.info").removeClass("active")},_changeState:function(){this.state++,this.$(".modal:eq(0)").animate({opacity:0,marginTop:0,height:0,top:0},function(){$(this).remove()}),this.$(".modal:eq(1)").css({opacity:0,display:"block",marginTop:"0px"}).animate({opacity:1,marginTop:"100px"},600)},_showLoader:function(){var a=this.getTemplate("table/header/views/create_visualization_loader");this.$(".modal:eq(1)").find("div.creating_content").html(a()),this._changeState(),this._createVisualization()},_createVisualization:function(){this.model.set("name",this.new_vis_name,{silent:!0}),this.model.changeToVisualization({success:this._onCreationSuccess,error:this.onCreationError})},_onCreationSuccess:function(a){this.ok&&this.ok(a),this.hide()},onCreationError:function(a,b,c){var d=cdb.templates.getTemplate("old_common/views/error_dialog_content"),e={number:"",description:b||this._TEXTS.creation.error.description,about:this._TEXTS.creation.error.about,item_queue_id:c||""};this.$("div.error_content").html(d(e)),this.model.set("name",this.old_vis_name,{silent:!0}),this._changeState()},_ok:function(a){this.killEvent(a);var b=this.$content.find("input").val();this._isValidName(b)?(this._hideInputError(),this.new_vis_name=b,this._showLoader()):this._showInputError()},clean:function(){this.$("input.text").unbind("keydown"),cdb.admin.BaseDialog.prototype.clean.call(this)}}),cdb.admin.DuplicateTableDialog=cdb.admin.BaseDialog.extend({_TEXTS:{title:{normal:_t("Name for your copy of this dataset"),query:_t("Name your new dataset from this query")},ok_button:{normal:_t("Duplicate dataset"),query:_t("Create dataset")},error:{"default":_t('Sorry, something went wrong and we\'re not sure what. Contact us at                   <a href="mailto:support@cartodb.com">support@cartodb.com</a>.')}},initialize:function(){var a=this.model.isInSQLView&&this.model.isInSQLView();_.extend(this.options,{title:this.options.title||(a?this._TEXTS.title.query:this._TEXTS.title.normal),description:"",template_name:"table/header/views/duplicate_table_dialog_base",clean_on_hide:!0,ok_button_classes:"button grey",ok_title:a?this._TEXTS.ok_button.query:this._TEXTS.ok_button.normal,cancel_button_classes:"underline",modal_type:"creation",width:525,modal_class:"duplicate_dialog"}),this.elder("initialize"),_.bindAll(this,"_onKeyDown"),this.state=0},render_content:function(){var a=this.$content=$("<div>"),b=cdb.templates.getTemplate("table/header/views/duplicate_table_dialog");return a.append(b({table_name:this.model.get("name"),queryApplied:this.model.isInSQLView()})),a.find("input.text").bind("keydown",this._onKeyDown),setTimeout(function(){a.find("input.text").focus()},300),this.$content},_checkCopyName:function(a,b){return b.length>0&&a!=b?!0:!1},_onKeyDown:function(a){13===a.keyCode&&this._ok()},_toggleInputError:function(a){a?this.$el.find("div.info").addClass("active"):this.$el.find("div.info").removeClass("active")},_showLoader:function(){var a=this.getTemplate("table/header/views/duplication_loader_dialog");this.$el.find(".modal:eq(1)").find("div.duplicate_content").html(a({type:"table",queryApplied:this.model.isInSQLView()})),this._changeState(),this._startDuplication()},_startDuplication:function(){var a=this;this.model.duplicate(this.copy_name,{success:function(a){window.location.href=a.viewUrl()},error:function(b){try{a._showError(b.attributes.error_code,b.attributes.get_error_text.title,b.attributes.get_error_text.what_about)}catch(b){a._showError("99999","Unknown",a._TEXTS.error["default"])}}})},_showError:function(a,b,c,d){var e=cdb.templates.getTemplate("old_common/views/error_dialog_content"),f={number:a,description:b,about:c,item_queue_id:d};this.$("div.error_content").html(e(f)),this._changeState()},_changeState:function(){this.state++,this.$(".modal:eq(0)").animate({opacity:0,marginTop:0,height:0,top:0},function(){$(this).remove()}),this.$(".modal:eq(1)").css({opacity:0,display:"block",marginTop:"0px"}).animate({opacity:1,marginTop:"100px"},600)},_keydown:function(a){27===a.keyCode&&1!=this.state&&this._cancel()},clean:function(){this.$("input.text").unbind("keydown"),cdb.admin.BaseDialog.prototype.clean.call(this)},_ok:function(a){a&&a.preventDefault();var b=this.$el.find("input.text").val();this._checkCopyName(this.model.get("name"),b)?(this._toggleInputError(!1),this.copy_name=b,this._showLoader()):this._toggleInputError(!0)}}),cdb.admin.DuplicateVisDialog=cdb.admin.BaseDialog.extend({_TEXTS:{title:_t("Name for your copy of this map"),ok_button:_t("Duplicate map"),error:_t('Sorry, something went wrong and we\'re not sure what. Contact us at                   <a href="mailto:support@cartodb.com">support@cartodb.com</a>.')},initialize:function(){_.extend(this.options,{title:this._TEXTS.title,description:"",template_name:"table/header/views/duplicate_vis_dialog_base",clean_on_hide:!0,ok_button_classes:"button grey",ok_title:this._TEXTS.ok_button,cancel_button_classes:"underline",modal_type:"creation",width:525,modal_class:"duplicate_dialog"}),this.elder("initialize"),_.bindAll(this,"_onKeyDown"),this.state=0},render_content:function(){var a=this.$content=$("<div>"),b=cdb.templates.getTemplate("table/header/views/duplicate_vis_dialog");return a.append(b({vis_name:this.model.get("name")})),a.find("input.text").bind("keydown",this._onKeyDown),setTimeout(function(){a.find("input.text").focus()},300),this.$content},_checkCopyName:function(a,b){return b.length>0&&a!=b?!0:!1},_onKeyDown:function(a){13===a.keyCode&&this._ok()},_toggleInputError:function(a){a?this.$el.find("div.info").addClass("active"):this.$el.find("div.info").removeClass("active")},_showLoader:function(){var a=this.getTemplate("table/header/views/duplication_loader_dialog"),b={type:"visualization",queryApplied:!1};this.$el.find(".modal:eq(1)").find("div.duplicate_content").html(a(b)),this._changeState(),this._startDuplication()},_startDuplication:function(){var a=this;({name:this.copy_name,source_visualization_id:this.model.get("id")});this.model.copy({name:this.copy_name},{success:function(a){window.location.href=a.viewUrl()},error:function(b){try{a._showError(b.attributes.error_code,b.attributes.get_error_text.title,b.attributes.get_error_text.what_about)}catch(b){a._showError("99999","Unknown",a._TEXTS.error)}}})},_showError:function(a,b,c,d){var e=cdb.templates.getTemplate("old_common/views/error_dialog_content"),f={number:a,description:b,about:c,item_queue_id:d};this.$("div.error_content").html(e(f)),this._changeState()},_changeState:function(){this.state++,this.$(".modal:eq(0)").animate({opacity:0,marginTop:0,height:0,top:0},function(){$(this).remove()}),this.$(".modal:eq(1)").css({opacity:0,display:"block",marginTop:"0px"}).animate({opacity:1,marginTop:"100px"},600)},_keydown:function(a){27===a.keyCode&&1!=this.state&&this._cancel()},clean:function(){this.$("input.text").unbind("keydown"),cdb.admin.BaseDialog.prototype.clean.call(this)},_ok:function(a){a&&a.preventDefault();var b=this.$el.find("input.text").val();this._checkCopyName(this.model.get("name"),b)?(this._toggleInputError(!1),this.copy_name=b,this._showLoader()):this._toggleInputError(!0)}}),cdb.admin.GeoreferenceEstimation=cdb.core.Model.extend(),cdb.admin.GeoreferenceEstimations=Backbone.Collection.extend({model:cdb.admin.GeoreferenceEstimation,url:function(a){var b=cdb.config.urlVersion("geocoding",a);return"/api/"+b+"/geocodings/estimation_for/"+this.table_name},initialize:function(a,b){this.table_name=b.table_name}}),cdb.admin.GeocoderStats=cdb.core.View.extend({tagName:"div",className:"geocoder_stats",_TEXTS:{upgrade_account:_t('<p><a href="<%- upgrade_url %><%- upgrade_url_no_rows_params %>">Upgrade your account</a> to get more.</p>'),charged:_t("<p>$<%- block_price %>/1,000 rows will be charged</p>"),available_hard:_t('<p><%- credits %> geocoding credit<%- credits > 1 ? "s" : "" %> still available.</p><% if (cost && cost > 0) { %><p>We calculate that geocoding this table completely could cost you up to <strong class="cost">$<%- cost %></strong>.</p><% } %>'),available_soft:_t('<p><%- credits %> geocoding credit<%- credits > 1 ? "s" : "" %> still available.</p><% if (cost && cost > 0) { %><p>We calculate that geocoding this table completely could cost you up to <strong class="cost">$<%- cost %></strong>.</p><% } %>'),no_geocodings_available:_t("<p>You don't have more geocoding credits this month.</p>"),no_geocodings_available_cost:_t('<p>You don\'t have more geocoding credits this month.</p><% if (cost && cost > 0) { %><p>We calculate that geocoding this table completely could cost you up to <strong class="cost">$<%- cost %></strong>.</p><% } %>')},initialize:function(){var a=this;this.template=cdb.templates.getTemplate("table/header/views/geocoder/geocoder_stats"),this.model.bind("change:geocoding",this.render,this),this.estimations=new cdb.admin.GeoreferenceEstimations([],{table_name:this.options.table.get("id")}),this.estimations.fetch({success:function(b){a.cost=b.models[0].get("estimation")/100,a.render()}})},render:function(){var a=window.config,b=_.clone(this.model.get("geocoding")),c="",d="",e=window.location.protocol+"//"+a.account_host+"/account/"+this.model.get("username")+"/upgrade",f=b.quota?100*(b.monthly_use||0)/b.quota:100;b.upgrade_url=e,b.upgrade_url_no_rows_params="?utm_source=Georeferencing_Credits_Not_Enough&utm_medium=referral&utm_campaign=Upgrade_from_Dashboard&utm_content=Upgrade%20your%20account",b.upgrade_url_hard_params="?utm_source=Georeferencing_Credits_Remaining&utm_medium=referral&utm_campaign=Upgrade_from_Dashboard&utm_content=upgrading%20to%20a%20higher%20plan",b.block_price=(b.block_price||1)/100,c=this._getMessage(b),f>80&&100>f?d="warning":f>=100&&(d="danger");var g={msg:c.msg,after_msg:c.after_msg,upgrade_url:e,state:d,used:f};return this.$el.html(this.template(g)),this},_getMessage:function(a){var b="",c="",d=a.quota?100*(a.monthly_use||0)/a.quota:100;Math.max(a.quota-a.monthly_use,0);return a.credits=a.quota-a.monthly_use,a.cost=this.cost||0,100>d?(b=_.template(this._TEXTS[a.hard_limit?"available_hard":"available_soft"])(a),a.cost&&a.cost>0&&(c=_.template(this._TEXTS.charged)(a))):(b=_.template(this._TEXTS[a.hard_limit?"no_geocodings_available":"no_geocodings_available_cost"])(a),c=_.template(this._TEXTS[a.hard_limit?"upgrade_account":"charged"])(a)),{msg:b,after_msg:c}}}),cdb.admin.GeoreferenceNoDataDialog=cdb.admin.BaseDialog.extend({_TEXTS:{title:_t("There is no data left to georeference"),close:_t("Close")},events:cdb.core.View.extendEvents({}),initialize:function(){_.extend(this.options,{title:this._TEXTS.title,template_name:"old_common/views/dialog_base",clean_on_hide:!0,ok_button_classes:"button grey",ok_title:this._TEXTS.close,modal_type:"creation",modal_class:"georeference_dialog",width:572}),this.constructor.__super__.initialize.apply(this)},render_content:function(){var a=this.$content=$("<div>"),b=this.getTemplate("table/header/views/geocoder/geocoder_nodata_content");return a.append(b),a}}),cdb.admin.SyncInfo=cdb.core.View.extend({tagName:"div",className:"sync_info",_SYNC_GAP:15,_POLLING_GAP:15,_TEXTS:{enabled:_t("This table will be synced again <%- run_at %>"),few_moments:_t("in a few moments"),sync_now_disabled:_t("You will be able to sync manually <%- gap %> minutes after your last synchronization")},events:{"click a.sync_options":"_onClickOptions","click a.sync_now":"_onClickSyncNow"},initialize:function(){_.bindAll(this,"_startSync"),this.dataLayer=this.options.dataLayer,this.table=this.dataLayer.table,this.model=this.table.synchronization,this.template=cdb.templates.getTemplate("table/header/views/sync_info_content"),this.model.bind("change",this.render,this),this._isSyncing()&&(this._showSyncNow(),this._startSync())},render:function(){var a=_.clone(this.model.attributes),b=this;return this._destroyTipsy(),a.ran_at=moment(a.ran_at||new Date).fromNow(),!a.run_at||new Date(a.run_at)<=new Date?a.run_at=this._TEXTS.few_moments:a.run_at=moment(a.run_at).fromNow(),a.canSync=this._canTableSyncNow()?!0:!1,this.$el.html(this.template(a)).attr("class","").addClass(a.state+" "+this.className),this.$(".sync_now_disabled").tipsy({gravity:"s",fade:!0,title:function(){return _.template(b._TEXTS.sync_now_disabled)({gap:b._SYNC_GAP})}}),this},_bindEvents:function(){this.model.bind("change:state",this._onStateChange,this)},_unbindEvents:function(){this.model.unbind("change:state",this._onStateChange,this)},_canTableSyncNow:function(){var a=new Date(this.model.get("ran_at")),b=new Date,c=this.model.get("state"),d=60*this._SYNC_GAP*1e3;return"syncing"===c?!1:b.getTime()-a.getTime()>d?!0:!1},_isSyncing:function(){return"syncing"===this.model.get("state")},_onClickSyncNow:function(a){a&&this.killEvent(a),this._canTableSyncNow()&&(this.model.set("state","syncing"),this._showSyncNow(),this.model.syncNow(this._startSync))},_onClickOptions:function(a){if(a&&this.killEvent(a),this.options.user.featureEnabled("new_modals"))this._createSyncDialog();else{this.sync_settings&&this.sync_settings.clean();var b=this.sync_settings=new cdb.admin.SyncSettings({table:this.table});b.appendToBody().open()}},_createSyncDialog:function(){var a=new cdb.editor.SyncView({table:this.table});a.appendToBody().open()},_startSync:function(){this.render(),this._bindEvents();var a=this;_.delay(function(){a.model.pollCheck()},1e3*this._POLLING_GAP)},_finishSync:function(){this._unbindEvents(),this.model.destroyCheck(),this._hideSyncNow(),this.dataLayer.invalidate(),this.table.data().refresh()},_onStateChange:function(){this._finishSync(),"success"===this.model.get("state")&&(this.model.get("error_code")||this.model.get("error_message"))&&this.model.set("state","failure"),this.render()},_showSyncNow:function(a){if(a&&this.killEvent(a),this.options.user.featureEnabled("new_modals")){var b=this.sync_now=cdb.editor.ViewFactory.createDialogByTemplate("common/templates/loading",{title:"Your dataset is being synced…",quote:"This action will take some time. In the meantime the UI is disabled, but APIs will work as usual."},{sticky:!0}).render();$("body").append(b.$el)}else{var b=this.sync_now=new cdb.admin.SyncNowModal({table:this.table});b.appendToBody().open()}},_hideSyncNow:function(){this.sync_now&&this.sync_now.hide()},_destroyTipsy:function(){this.$(".sync_now_disabled").data("tipsy")&&this.$(".sync_now_disabled").unbind("mouseenter mouseleave").data("tipsy").remove()},clean:function(){this._destroyTipsy(),cdb.core.View.prototype.clean.call(this)}}),cdb.admin.MergeTablesModel=cdb.core.Model.extend({defaults:{regularMerge:!0,spatialMerge:!0,nextButtonText:_("Next")}}),cdb.admin.MergeTablesDialog=cdb.admin.BaseDialog.extend({_TEXTS:{title:_t("Merge with another dataset"),desc:_t("Dataset merging is useful if you want to combine data from two datasets into a single                 new dataset. You can merge datasets by a column attribute or as a spatial intersection."),next:_t("Next"),back:_t("Go back"),merge:{column:{title:_t("Column Join"),desc:_t("Create a new dataset by selecting two datasets and the columns containing the shared value.                 First, select the matching column in both datasets and then select or deselect                 the columns you want in your new dataset. You can only merge datasets by joining by                 columns of the same type (e.g. number to a number).")},spatial:{title:_t("Spatial join"),desc:_t("Calculate the intersecting geospatial records between two datasets (ex. points in polygons).                 You'll need to decide the operation to perform: COUNT calculates the number of intersecting records,                 SUM sums of a column value for all intersecting records, AVG provides the average value of a column                 for all intersecting records.")},name:_t("Name for your merge dataset"),choose:_t("Choose a dataset to merge with {{ table_name }}"),next:_t("Merge datasets")},errors:{sorry:_t('Sorry, something went wrong and we\'re not sure what. Contact us at                   <a href="mailto:support@cartodb.com">support@cartodb.com</a>.')}},FILTERED_COLUMNS:["cartodb_id","created_at","updated_at","the_geom_webmercator","cartodb_georef_status"],events:function(){return _.extend({},cdb.admin.BaseDialog.prototype.events,{"keyup input.text":"_onKeyUp","click ul.join_types li a":"_onRadioClick","click .next":"_onNextClick","click .back":"_onBackClick"})},initialize:function(){_.bindAll(this,"_onKeyUp","_onChangeDescriptionTitle","_onChangeEnableNext","_onChangeEnableBack","_loadState","_onNextClick","_onBackClick","_onRadioClick","_onToggleMergeFlavorList","_onToggleTableSelector","_onTableSelected","_mergeMethodSelected","_merge","_importCopy","_onMergeSuccess","_onMergeError"),_.extend(this.options,{template_name:"table/header/views/merge_tables_dialog_base",title:this._TEXTS.title,description:this._TEXTS.desc,width:633,clean_on_hide:!0,cancel_button_classes:"margin15",ok_button_classes:"button disabled grey",ok_title:this._TEXTS.next,modal_type:"creation tables_selector",modal_class:"merge_tables_dialog"}),this.constructor.__super__.initialize.apply(this),this.join_type="regular",this.enabled=!1,this.model=new cdb.admin.MergeTablesModel({}),this.table=this.options.table,this.model.set("merge_name",this.table.get("name")+"_merge"),this.options.cancel_title=this._TEXTS.back,this.model.set({title:this.options.title,description:this.options.description,nextButtonText:this.options.ok_title,show_merge_flavor_list:!0,show_table_selector:!1,show_table_name_form:!1,enableNext:!1,enableBack:!1,state:0}),this.model.bind("change:title",this._onChangeTitle,this),this.model.bind("change:description",this._onChangeDescription,this),this.model.bind("change:description_title",this._onChangeDescriptionTitle,this),this.model.bind("change:nextButtonText",this._onChangeNextButtonText,this),this.model.bind("change:enableNext",this._onChangeEnableNext,this),this.model.bind("change:enableBack",this._onChangeEnableBack,this),this.model.bind("change:show_merge_flavor_list",this._onToggleMergeFlavorList,this),this.model.bind("change:show_table_selector",this._onToggleTableSelector,this),this.model.bind("change:show_table_name_form",this._onToggleTableNameForm,this),this.model.bind("change:merge_flavor",this._onChangeMergeFlavor,this)},_canApplyRegularMerge:function(){var a=this,b=this.table.get("schema"),c=_.compact(_.map(b,function(b,c){return _.contains(a.FILTERED_COLUMNS,b[0])?void 0:{name:b[0],columnType:b[1]}})),d=_.find(c,function(a){return"the_geom"!=a.name});return d?!0:!1},_onNextClick:function(a){this.killEvent(a),this.model.get("enableNext")&&(this.model.set({previous_state:this.model.get("state"),state:this.model.get("state")+1,enableNext:!1}),this._loadState())},_onBackClick:function(a){if(this.killEvent(a),this.model.get("enableBack")){this.model.set({previous_state:this.model.get("state"),state:this.model.get("state")-1,nextButtonText:this._TEXTS.merge.next,enableBack:!1});var b=(this.model.get("merge_flavor"),this.model.get("state"));0===b&&this.merge_table._hideCountCover(),this._loadState()}},_onChangeNextButtonText:function(){var a=this;this.$next.fadeOut(250,function(){a.$next.text(a.model.get("nextButtonText")),a.$next.fadeIn(250)})},_onChangeTitle:function(){var a=this,b=this.$title;b.fadeOut(250,function(){b.text(a.model.get("title")),b.fadeIn(250)})},_onChangeDescription:function(){var a=this,b=this.$description;b.fadeOut(250,function(){b.text(a.model.get("description")),b.fadeIn(250)})},_onChangeDescriptionTitle:function(){var a=this,b=this.$descriptionTitle;b.fadeOut(250,function(){b.text(a.model.get("description_title")),b.fadeIn(250)})},_onChangeEnableNext:function(){this.model.get("enableNext")?this.$next.removeClass("disabled"):this.$next.addClass("disabled")},_onChangeEnableBack:function(){this.model.get("enableBack")?this.$back.fadeIn(250,function(){$(this).removeClass("hidden")}):this.$back.fadeOut(250,function(){$(this).addClass("hidden")})},_center:function(){var a=this;setTimeout(function(){a.centerInScreen(!0)},100)},_loadState:function(){var a=this.model.get("merge_flavor"),b=this.model.get("state"),c=this.model.get("previous_state"),d=this.model.get("already_activated"),e=!1;if(1===b&&(cdb.god.trigger("mixpanel","Use visual merge"),cdb.god.trigger("metrics","visual_merge",{email:window.user_data.email,data:{flavor:a,table:this.table.get("name")}})),this.model.get("merge_flavor")){var f="merge_tables_"+a+"_"+b;if((b>c&&c>0||d)&&(e=!0),0===b)return this.model.set({show_merge_flavor_list:!0,show_table_selector:!1,show_table_name_form:!1,enableNext:!0,title:this._TEXTS.title,nextButtonText:this.model.get("nextButtonText")||this.model.defaults.nextButtonText,description_title:"",description:this._TEXTS.desc}),void this.merge_table.resetMergeMethods();if("merge_tables_regular_1"===f){return this.model.set({enableBack:!0,enableNext:e,show_merge_flavor_list:!1,show_table_selector:!0,show_table_name_form:!1,title:this._TEXTS.title,description_title:this._TEXTS.merge.column.title,nextButtonText:this._TEXTS.merge.next,description:this._TEXTS.merge.column.desc}),this.merge_table._setupRegularMerge(),void this.actual_table._setupRegularMerge()}if("merge_tables_spatial_1"===f){return this.model.set({enableBack:!0,enableNext:e,show_merge_flavor_list:!1,show_table_selector:!0,show_table_name_form:!1,title:this._TEXTS.title,description_title:this._TEXTS.merge.spatial.title,nextButtonText:this._TEXTS.merge.next,description:this._TEXTS.merge.spatial.desc}),this.merge_table._setupSpatialMerge(),void this.actual_table._setupSpatialMerge()}if("merge_tables_regular_2"===f||"merge_tables_spatial_2"===f)return this.model.set({enableBack:!0,enableNext:e,show_merge_flavor_list:!1,show_table_selector:!1,show_table_name_form:!0,nextButtonText:this._TEXTS.next,title:this._TEXTS.merge.name,description_title:"",description:""}),void this._focusInput();if("merge_tables_regular_3"===f||"merge_tables_spatial_3"===f){var g=this.$input.val();return this.model.set("merge_name",g),this.model.set({enableBack:!0,enableNext:e,show_merge_flavor_list:!1,show_table_selector:!1,show_table_name_form:!1,title:"",description_title:"",description:""}),this._merge(),this._showLoader(),void this.$(".modal.tables_selector").fadeOut(250)}}},_hideLoader:function(){this.$(".modal.merging").fadeOut(250)},_showLoader:function(){this.$(".modal.merging").css({opacity:0,display:"block",marginTop:"0px"}).animate({opacity:1,marginTop:-200},600)},_onChangeMergeFlavor:function(){var a=this.model.get("merge_flavor");this.actual_table.setJoinType(a),this.merge_table.setJoinType(a)},_onRadioClick:function(a){this.killEvent(a);var b=$(a.target).closest("a"),c=b.attr("data-merge-flavor");("regular"!==c||this.model.get("regularMerge"))&&(this.$mergeFlavorList.find(".radiobutton").removeClass("selected"),b.addClass("selected"),this.model.set({enableNext:!0,merge_flavor:c}))},_onToggleMergeFlavorList:function(){this.model.get("show_merge_flavor_list")?this.$mergeFlavorList.delay(170).slideDown(150):this.$mergeFlavorList.delay(170).slideUp(150)},_onToggleTableSelector:function(){var a=this;this.model.get("show_table_selector")?this.$tableSelector.delay(100).slideDown(150,function(){a._center()}):this.$tableSelector.delay(100).slideUp(150,function(){a._center()})},_onToggleTableNameForm:function(){this.model.get("show_table_name_form")?this.$tableNameForm.delay(200).slideDown(120):this.$tableNameForm.delay(200).slideUp(120)},_createTableColumnSelectors:function(a){var b=this.actual_table=new cdb.admin.TableColumnSelector({el:a.find(".actual_table"),model:this.table,choose_table_text:"",filteredColumns:this.FILTERED_COLUMNS,joinType:"regular",source:"origin"}).bind("columnChanged",this._onColumnChanged,this).render();this.addView(b);var c=this.merge_table=new cdb.admin.TableColumnSelector({el:a.find(".merge_table"),url:cdb.config.prefixUrl()+"/api/v1/tables/",choose_table_text:this._TEXTS.merge.choose.replace("{{ table_name }}",this.table.get("name")),filteredColumns:this.FILTERED_COLUMNS,filteredTables:[this.table.get("name")],joinType:"regular",source:"destiny"}).render().bind("columnChanged",this._onColumnChanged,this).bind("tableSelected",this._onTableSelected).bind("mergeMethodSelected",this._mergeMethodSelected);this.addView(c)},_onColumnChanged:function(a){if("regular"==this.actual_table.options.joinType&&"the_geom"==a.name){var b;if(this.merge_table&&"origin"===a.source){var c=this.merge_table._getTheGeom();c&&(b=c.model.get("switchSelected"),this.actual_table._getTheGeom().setSilent(b),this.merge_table._getTheGeom().setSilent(!b))}else this.merge_table&&(b=this.actual_table._getTheGeom().model.get("switchSelected"),this.actual_table._getTheGeom().setSilent(!b),this.merge_table._getTheGeom().setSilent(b))}},_mergeMethodSelected:function(a){this.model.set({enableNext:a,nextButtonText:this._TEXTS.merge.next,already_activated:!0})},_onTableSelected:function(){"spatial"!=this.model.get("merge_flavor")?this.model.set({enableNext:!0,nextButtonText:this._TEXTS.merge.next,already_activated:!0}):this.model.set({enableNext:!1})},render_content:function(){this._canApplyRegularMerge()||this.model.set("regularMerge",!1);var a=$(this.getTemplate("table/header/views/merge_tables_content")(this.model.toJSON())),b=$("<div class='inner_content'></div>").append(a);return this._createTableColumnSelectors(b),this.$next=this.$(".next"),this.$back=this.$(".back"),this.$mergeFlavorList=b.find(".join_types"),this.$tableSelector=b.find(".tables"),this.$tableNameForm=b.find(".table_name"),this.$title=this.$(".tables_selector h3"),this.$input=b.find("input.name"),this.$description=b.find(".description"),this.$descriptionTitle=b.find(".title"),b},_focusInput:function(){var a=this.$("input.text"),b=this.table.get("name")+"_merge";a.val(b),this.model.set("merge_name",b),setTimeout(function(){a.focus()})},_checkMergeName:function(a,b){return b.length>0&&a!=b?!0:!1},_onKeyUp:function(a){var b=!1,c=$(a.target).val();this._checkMergeName(this.actual_table.model.get("name"),c)?(this._toggleInputError(!1),this.model.set("merge_name",c),this.model.set("enableNext",!0),b=!1):(this._toggleInputError(!0),this.model.set("enableNext",!1),b=!0),13!==a.keyCode||b||(this.model.set({previous_state:this.model.get("state"),state:this.model.get("state")+1,enableNext:!1}),this._loadState())},_toggleInputError:function(a){a?this.$("div.info").addClass("active"):this.$("div.info").removeClass("active")},_generateRegularQuery:function(){var a=this,b="SELECT ",c="",d="",e=null,f=null;return this.actual_table._getTheGeom().model.get("switchSelected")&&(e=this.actual_table._getTheGeom().model.get("name")),this.merge_table._getTheGeom().model.get("switchSelected")&&(f=this.merge_table._getTheGeom().model.get("name")),_.each(this.actual_table.mergeColumns,function(c){b+=null!==e&&c===e?"CASE WHEN "+a.actual_table.table_name+"."+c+" IS NULL THEN "+a.merge_table.table_name+"."+c+" ELSE "+a.actual_table.table_name+"."+c+" END AS "+c+", ":a.actual_table.table_name+"."+c+", "}),_.each(this.merge_table.mergeColumns,function(c){b+=null!==f&&c===f?"CASE WHEN "+a.merge_table.table_name+"."+c+" IS NULL THEN "+a.actual_table.table_name+"."+c+" ELSE "+a.merge_table.table_name+"."+c+" END AS "+c:a.merge_table.table_name+"."+c,_.contains(a.actual_table.mergeColumns,c)&&(b+=" AS "+a.merge_table.table_name+"_"+c),b+=", "}),b=b.slice(0,b.length-2),b+=" FROM "+this.actual_table.table_name+" FULL OUTER JOIN "+this.merge_table.table_name+" ON ",_.each(this.actual_table.model.get("schema"),function(b){b[0]===a.actual_table.keyColumn&&(c=b[1])}),_.each(this.merge_table.schema,function(b){b.name===a.merge_table.keyColumn&&(d=b.columnType)}),b+="string"===c&&"string"===d?"LOWER(TRIM("+this.actual_table.table_name+"."+this.actual_table.keyColumn+")) = LOWER(TRIM("+this.merge_table.table_name+"."+this.merge_table.keyColumn+"))":this.actual_table.table_name+"."+this.actual_table.keyColumn+" = "+this.merge_table.table_name+"."+this.merge_table.keyColumn},_generateSpatialQuery:function(){var a=this.merge_table.mergeMethod;return"count"===a?this._generateCOUNTSpatialQuery():"avg"===a?this._generateAVGSpatialQuery():"sum"===a?this._generateSUMSpatialQuery():!1},_generateCOUNTSpatialQuery:function(){var a=this,b="SELECT ",c=this.actual_table.model.get("name"),d=this.merge_table.table_name;return b+=c+".cartodb_id, "+c+".the_geom_webmercator, "+c+".the_geom, ",_.each(this.actual_table.mergeColumns,function(c){"the_geom"!=c&&(b+=a.actual_table.table_name+"."+c+", ")}),b+="(SELECT COUNT(*) FROM "+d+" WHERE ST_Intersects("+c+".the_geom, "+d+".the_geom)) AS intersect_count FROM "+c},_generateAVGSpatialQuery:function(){var a=this,b="SELECT ",c=this.actual_table.model.get("name"),d=this.merge_table.table_name;return b+=c+".cartodb_id, "+c+".the_geom_webmercator, "+c+".the_geom, ",_.each(this.actual_table.mergeColumns,function(c){"the_geom"!=c&&(b+=a.actual_table.table_name+"."+c+", ")}),b+="(SELECT AVG("+d+"."+this.merge_table.keyColumn+") FROM "+d+" WHERE ST_Intersects("+c+".the_geom, "+d+".the_geom)) AS intersect_avg FROM "+c},_generateSUMSpatialQuery:function(){var a=this,b="SELECT ",c=this.actual_table.model.get("name"),d=this.merge_table.table_name;return b+=c+".cartodb_id, "+c+".the_geom_webmercator, "+c+".the_geom, ",_.each(this.actual_table.mergeColumns,function(c){"the_geom"!=c&&(b+=a.actual_table.table_name+"."+c+", ")}),b+="(SELECT SUM("+d+"."+this.merge_table.keyColumn+") FROM "+d+" WHERE ST_Intersects("+c+".the_geom, "+d+".the_geom)) AS intersect_sum FROM "+c},_generateQuery:function(){return"regular"===this.model.get("merge_flavor")?this._generateRegularQuery():"spatial"===this.model.get("merge_flavor")?this._generateSpatialQuery():!1},_merge:function(){var a=this._generateQuery(),b={table_name:this.model.get("merge_name"),sql:a};$.ajax({type:"POST",url:cdb.config.prefixUrl()+"/api/v1/imports",data:b,success:this._onMergeSuccess,error:this._onMergeError})},_onMergeSuccess:function(a){this._importCopy(a.item_queue_id)},_onMergeError:function(a){try{this._showError(a.attributes.error_code,a.attributes.get_error_text.title,a.attributes.get_error_text.what_about)}catch(a){this._showError("99999","Unknown",this._TEXTS.error["default"])}},_importCopy:function(a){var b=this,c=this.importation=new cdb.admin.Import({item_queue_id:a});c.bind("importComplete",function(a){c.unbind(),window.location.href=cdb.config.prefixUrl()+"/tables/"+(c.get("table_name")||c.get("table_id"))+"/"},this),c.bind("importError",function(a){b._showError(a.attributes.error_code,a.attributes.get_error_text.title,a.attributes.get_error_text.what_about)},this),this.add_related_model(c),c.pollCheck()},_showError:function(a,b,c){this._hideLoader();var d=cdb.templates.getTemplate("old_common/views/error_dialog_content"),e={number:a,description:b,about:c};this.$("div.error_content").html(d(e)),this.$(".modal.error").css({opacity:0,display:"block",marginTop:"0px"}).animate({opacity:1,marginTop:-200},600)},_ok:function(a){},centerInScreen:function(a){var b=this.$(".modal.tables_selector"),c=b.height();c>0&&b.animate({marginTop:-(c/2)},a?220:0)}}),cdb.admin.HeaderOptionsMenu=cdb.admin.DropdownMenu.extend({className:"dropdown table-options",_TEXTS:{error:_t("Something went wrong, try again later")},events:{"click .lock_vis":"_lockVis","click .export_table":"_exportTable","click .duplicate_table":"_duplicateDataset","click .duplicate_vis":"_duplicateVis","click .append_data":"_appendData","click .delete_table":"_deleteItem",
"click .georeference":"_georeference","click .merge_tables":"_mergeTables","click .change_privacy":"_changePrivacy","click .sync_settings":"_syncSettings","click .delete_vis":"_deleteItem"},render:function(){var a=this.options;return this.user=this.options.user,this.dataLayer=this.options.dataLayer,this.table=this.dataLayer.table,a.isVisualization=this.model.isVisualization(),a.table=this.table,a.dataLayer=this.options.dataLayer,a.isLayerOwner=this.table.permission.isOwner(this.user),a.isVisOwner=this.model.permission.isOwner(this.user),a.googleUser=this.user.featureEnabled("google_maps"),this.$el.html(this.template_base(a)).css({width:this.options.width}),this._setGeocodingBar(),this},show:function(){this.render(),this.constructor.__super__.show.apply(this)},_setGeocodingBar:function(){var a=this.user.toJSON();a.geocoding=a.geocoding||{};var b=a.geocoding.quota?100*a.geocoding.monthly_use/a.geocoding.quota:100,c="";90>b&b>79?c="caution":b>89&&(c="danger"),this.$(".progress-bar").find(".bar-2").width(b+"%").removeClass("danger caution").addClass(c)},_lockVis:function(a){a&&a.preventDefault();var b=this,c=function(){var a=b.model.isVisualization()?"maps":"datasets";window.location.href=cdb.config.prefixUrl()+"/dashboard/"+a};if(this.options.user.featureEnabled("new_modals")){var d=new cdb.editor.ChangeLockViewModel({items:[this.model],contentType:this.model.isVisualization()?"maps":"datasets"});d.bind("change:state",function(){"ProcessItemsDone"===d.get("state")&&c()});var e=new cdb.editor.ChangeLockView({model:d,clean_on_hide:!0,enter_to_confirm:!0});return void e.appendToBody()}var f=new cdb.admin.LockVisualizationDialog({model:this.model,user:this.user,onResponse:c});f.appendToBody().open({center:!0})},_exportTable:function(a){if(a.preventDefault(),this.table.isInSQLView()&&this.dataLayer&&!this.dataLayer.get("query"))return!1;var b=this.options.user.featureEnabled("new_modals")?cdb.editor.ExportView:cdb.admin.ExportTableDialog,c=new b({model:this.dataLayer.table,config:config,user_data:this.user.toJSON()});c.appendToBody().open()},_duplicateDataset:function(a){if(a.preventDefault(),this.user.featureEnabled("new_modals")){var b=new cdb.editor.DuplicateDatasetView({model:this.table,user:this.user,clean_on_hide:!0});return b.appendToBody().open()}if(!this.model.isVisualization()){var c=new cdb.admin.DuplicateTableDialog({model:this.table});c.appendToBody().open()}},_duplicateVis:function(a){if(a.preventDefault(),this.user.featureEnabled("new_modals")){var b=new cdb.editor.DuplicateVisView({model:this.model,table:this.table,user:this.user,clean_on_hide:!0});return b.appendToBody().open()}if(this.model.isVisualization()){var c=new cdb.admin.DuplicateVisDialog({model:this.model});c.appendToBody().open()}},_changePrivacy:function(a){a.preventDefault(),this.privacy_dialog=new cdb.admin.PrivacyDialog({model:this.model,config:config,user:this.options.user}),$("body").append(this.privacy_dialog.render().el),this.privacy_dialog.open({center:!0})},_appendData:function(a){a.preventDefault()},_syncSettings:function(a){if(a.preventDefault(),!this.model.isVisualization())if(this.user.featureEnabled("new_modals"))this._createSyncDialog();else{var b=new cdb.admin.SyncSettings({table:this.table});b.appendToBody().open()}},_createSyncDialog:function(){var a=new cdb.editor.SyncView({table:this.table});a.appendToBody().open()},_deleteTable:function(){if(!this.model.isVisualization()){this.delete_dialog=new cdb.admin.DeleteDialog({model:this.table,config:config,user:this.user}),$("body").append(this.delete_dialog.render().el),this.delete_dialog.open();var a=this;this.delete_dialog.ok=function(){a.model.destroy({success:function(){window.location=cdb.config.prefixUrl()+"/dashboard/tables"}})}}},_mergeTables:function(a){if(a.preventDefault(),!this.model.isVisualization()){var b=this.user,c=b.featureEnabled("new_modals")?cdb.editor.MergeDatasetsView:cdb.admin.MergeTablesDialog,d=new c({table:this.table,user:b});d.appendToBody().open({center:!0})}},_georeference:function(a){if(a.preventDefault(),this.options.geocoder.isGeocoding()||this.table.isSync()||this.table.isInSQLView()){if(!this.options.geocoder.isGeocoding())return;c=new cdb.admin.GeocoderWorking}else{var b=this.user.featureEnabled("new_modals")?cdb.editor.GeoreferenceView:cdb.admin.GeocodingDialog,c=new b({table:this.table,user:this.user,tabs:["lonlat","city","admin","postal","ip","address"],option:"lonlat"});c.bind("geocodingChosen",this._onGeocodingChosen,this)}c.appendToBody().open({center:!0})},_sendGeocodingMetrics:function(a){cdb.god.trigger("mixpanel","Geocoding",{type:a,table_name:this.table.get("id")}),cdb.god.trigger("metrics","geocoding",{email:window.user_data.email,data:{type:a,table_name:this.table.get("id")}})},_onGeocodingChosen:function(a){return this._sendGeocodingMetrics(a.type),"lonlat"==a.type?(this.table.bind("notice",this.options.globalError.showError,this.options.globalError),this.table.geocodeLatAndLng(a.latitude,a.longitude),!1):"lonlat"!==a.type?(this.options.geocoder.set(_.omit(a,"table_name","type")),!1):void cdb.log.info("No geocoder option for "+a.kind,obj)},_deleteVis:function(){if(this.model.isVisualization()){var a=this,b=new cdb.admin.DeleteVisualizationDialog({model:this.model});b.appendToBody().open({center:!0}),b.ok=function(){a.model.destroy({success:function(){window.location.href=cdb.config.prefixUrl()+"/dashboard/visualizations"},error:function(){a.options.globalError.showError(a._TEXTS.error,"info",3e3)}})}}},_deleteItem:function(a){this.killEvent(a);var b=this.model.isVisualization();if(this.user.featureEnabled("new_modals")){var c=new cdb.editor.DeleteItemsViewModel(this.model,{contentType:b?"maps":"datasets"});c.bind("DeleteItemsDone",function(){var a=this.user.viewUrl().dashboard();window.location=b?a.maps():a.datasets()},this);var d=new cdb.editor.DeleteItemsView({viewModel:c,user:this.user,clean_on_hide:!0,enter_to_confirm:!0});d.appendToBody()}else b?this._deleteVis():this._deleteTable()}}),cdb.admin.ShareController=cdb.core.View.extend({_TEXTS:{create_visualization:{msg:_t("If you want to share your map you need to create it first.")},next_button:_t("Check datasets")},initialize:function(){this.user=this.options.user,this.config=this.options.config,this.stack=[],this.any_private_table=this.model.related_tables&&this.model.related_tables.filter(function(a){return"private"==a.get("privacy").toLowerCase()}).length>0,this._generateStack(),this._nextStep()},_generateStack:function(){this.model.isVisualization()||this.stack.push({"class":"CreateVizDialog",step:"createVisualization",opts:{model:this.model,msg:this._TEXTS.create_visualization.msg},center:!1,callback:"_changeToVis"}),this.model.isVisualization()&&this.stack.push({"class":"ShareDialog",step:"showShareDialog",opts:{vis:this.model,user:this.user,config:this.config},center:!0})},_createDialog:function(){var a=this,b=a.stack.shift(),c=new cdb.admin[b["class"]](b.opts);c.cancel=function(){a._clean()},c.ok=function(c){b.callback&&a[b.callback](c),a._nextStep()},c.appendToBody().open({center:b.center}),this.addView(c)},_makeVisPublic:function(){this.model.save({privacy:"PUBLIC"})},_changeToVis:function(a){window.table_router.changeToVis(a)},_nextStep:function(){this.stack.length>0?this._createDialog():this._clean()},_clean:function(){var a=this;setTimeout(function(){a.clean()},1e3)},clean:function(){this.stack=[],cdb.core.View.prototype.clean.call(this)}}),cdb.admin.ShareDialog=cdb.admin.BaseDialog.extend({events:function(){return _.extend({},cdb.admin.BaseDialog.prototype.events,{"click input":"_selectAll","click .change-privacy":"_changePrivacy"})},_TEXTS:{title:_t("Share your map"),close:_t("Close")},options:{},_KEYS:{_BITLY:{key:"R_de188fd61320cb55d359b2fecd3dad4b",login:"vizzuality"}},initialize:function(){var a=("free"==user_data.account_type.toLowerCase(),this.options.vis.get("privacy")),b=(user_data.actions.private_maps,this.options.vis.get("description")),c=b?markdown.toHTML(b):"";this.options=_.extend({title:this._TEXTS.title,description:"",template_name:"table/header/views/share_dialog",private_maps:user_data.actions.private_maps,privacy:a,clean_on_hide:!0,ok_button_classes:"button grey",ok_title:this._TEXTS.close,width:"804px",modal_class:"share_dialog",map_title:this.options.vis.get("name"),map_description:c,removable_logo:this.options.user.get("actions").remove_logo,touch:!!("ontouchstart"in window)||!!("onmsgesturechange"in window),upgrade_url:window.location.protocol+"//"+this.options.config.account_host+"/account/"+user_data.username+"/upgrade"},this.options),this.model=new cdb.core.Model,this.model.bind("change:url",this._updateURL,this),this._enableCopy(),this.constructor.__super__.initialize.apply(this)},_onUpdatePasswordButtonLabel:function(){this.$el.find(".password .input_field .set_password").text(this.model.get("password_button_label"))},_onUpdatePasswordPlaceholder:function(){this.$el.find(".password .input_field input").attr("placeholder",this.model.get("password_placeholder"))},_resize:function(a){var b=40,c=$(window).height()-b,d=635,e=40;this.$el.find(".block.modal:eq(0)").css({height:c});var f=this,g=function(a){var b=a-2*f.$el.find("h4").outerHeight(!0)-f.$el.find("h3").outerHeight(!0)-f.$el.find(".privacy.switches").outerHeight(!0)-34,c=a-172;return this.$(".torque_warning:visible").length>0&&(b-=e,c-=e),{leftColumnHeight:b,mapWrapperHeight:c}};if(c>d){var h=g(c);1==a?(this.$el.find(".cartodb-map_wrapper").animate({height:h.mapWrapperHeight},150),this.$el.find(".scrollpane").animate({height:h.leftColumnHeight},150)):(this.$el.find(".cartodb-map_wrapper").css({height:h.mapWrapperHeight}),this.$el.find(".scrollpane").css({height:h.leftColumnHeight})),this.$el.find(".white-gradient-shadow.bottom").css({top:this.$el.find(".scrollpane").position().top+this.$el.find(".scrollpane").outerHeight(!0)-16})}else{var h=g(d);1==a?(this.$el.find(".cartodb-map_wrapper").animate({height:h.mapWrapperHeight-3},150),this.$el.find(".scrollpane").animate({height:h.leftColumnHeight},150)):(this.$el.find(".cartodb-map_wrapper").css({height:h.mapWrapperHeight-3}),this.$el.find(".scrollpane").css({height:h.leftColumnHeight})),this.$el.find(".white-gradient-shadow.bottom").css({top:this.$el.find(".scrollpane").position().top+this.$el.find(".scrollpane").outerHeight(!0)-16})}this.scrollPaneAPI&&this.scrollPaneAPI.reinitialise()},_addWidget:function(a){this.addView(a),this.$(".cartodb-map_wrapper").append(a.render().$el)},_addZoomWidget:function(){var a=new cdb.geo.ui.Zoom({model:this.map,template:this.getTemplate("table/views/zoom_control")});this._addWidget(a)},_changePrivacy:function(a){a.preventDefault(),a.stopPropagation();var b=this;this.hide(function(){b._openPrivacyDialog()})},_openPrivacyDialog:function(){var a=this.options.vis.permission.isOwner(this.options.user);return a?(this.privacy_dialog=new cdb.admin.PrivacyDialog({model:this.options.vis,config:this.options.config,user:this.options.user}),this.privacy_dialog.appendToBody(),void this.privacy_dialog.open({center:!0})):!1},_addLayerWidget:function(){var a=new cdb.geo.ui.LayerSelector({mapView:this.mapView,template:this.getTemplate("table/views/layer_selector"),dropdown_template:this.getTemplate("table/views/layer_dropdown")});a.bind("switchChanged",this._updateSublayerOptions,this),this._addWidget(a)},_addLegendWidget:function(){var a=new cdb.admin.mod.LegendWidget({map:this.map});this._addWidget(a)},_addFullScreenWidget:function(){var a=new cdb.ui.common.FullScreen({doc:".cartodb-map_wrapper",template:this.getTemplate("table/views/fullscreen")});this._addWidget(a)},_addShareWidget:function(){var a='<div class="cartodb-share"><a href="#"></a></div>';this.$(".cartodb-map_wrapper").append(a),this._setShortURL();var b=this.options.vis.embedURL(),c=this.options.vis.publicURL(),d=_.map(this.mapOptions.attributes,function(a,b){return b+"="+encodeURIComponent(a)}),d=d.join("&");d=d.replace(/'/g,"%27");var e=b+"?"+d,f=c+"?"+d,g=this.shareDialogWidget=new cdb.ui.common.ShareDialog({model:this.map,className:"cartodb-share-dialog",title:"Share this map",disableLinks:!0,descriptionShort:"",facebook_url:"#",twitter_url:"#",public_map_url:f,code:"<iframe width='100%' height='520' frameborder='0' src='"+e+"' allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen></iframe>",width:432,template:this.getTemplate("table/views/share_dialog")});this._addWidget(g)},_addSearchWidget:function(){var a=new cdb.geo.ui.Search({model:this.map,template:this.getTemplate("table/views/search_control")});this._addWidget(a)},_hidePrivacySettings:function(){this.$("#privacy_options").hide()},_setupPrivacySettings:function(){var a=this.options.vis.get("privacy");"PASSWORD"!==a?(this.$el.find(".privacy ."+a.toLowerCase()+" .radiobutton").addClass("selected"),this.model.set({password_button_label:this._TEXTS.insert_password_button_label,password_placeholder:this._TEXTS.insert_password_placeholder})):(this.model.set({password_button_label:this._TEXTS.edit_password_button_label,password_placeholder:this._TEXTS.edit_password_placeholder}),this.$el.find(".privacy .password .input_field input[type='password']").val("FAKE123"),user_data.actions.private_maps&&(this.$el.find(".privacy .password .radiobutton").addClass("selected"),this.$el.find(".privacy .password").addClass("open"),this.$el.find(".privacy .password .input_field").show()))},_onPrivacyRadioButtonClick:function(a){a.preventDefault(),a.stopPropagation();var b={},c=this,d=$(a.target).closest(".radiobutton");if(user_data.actions.private_maps||!d.hasClass("disabled")){this.$el.find(".radiobutton").removeClass("selected"),d.addClass("selected");var e=d.attr("data-mode");b.privacy=e.toUpperCase(),this.$el.find(".privacy .password").removeClass("loading"),"password"!=e&&this.$el.find(".password .input_field").fadeOut(250,function(){c.$el.find(".password").removeClass("open"),c._resize(!0),c._cleanPasswordField()}),"password"==e?(this.$el.find(".password").addClass("open"),this.$el.find(".password .input_field").fadeIn(250),this.$el.find(".password .input_field input").focus()):(this.options.vis.save(b,{success:this._onSaveSuccess,error:this._onSaveError}),this.$el.find("."+e).addClass("loading")),this._resize(!0)}},_cleanPasswordField:function(){this.$el.find("input.password").val(""),this.model.set({password_button_label:this._TEXTS.insert_password_button_label,password_placeholder:this._TEXTS.insert_password_placeholder})},_addSwitches:function(a){var b=this;_(a).each(function(a){var c="."+a,d=new cdb.forms.Switch({model:b.mapOptions,property:a}).bind("switched",b._onSwitchSwitched);b.addView(d),b.$("li"+c).append(d.render().el),b.mapOptions.attributes[a]||b.$(c).addClass("disabled")})},_onSwitchSwitched:function(a,b){b?this.$el.parent().removeClass("disabled"):this.$el.parent().addClass("disabled")},_addMapView:function(){var a=this;setTimeout(function(){var b=cdb.admin.LeafletMapView;"googlemaps"===a.map.get("provider")&&(b=cdb.admin.GoogleMapsMapView);var c=$("<div>").addClass("cartodb-map");a.$(".cartodb-map_wrapper").prepend(c),a.mapView=new b({el:c,map:a.map,user:a.options.user}),a.addView(a.mapView),a._addLayerWidget(),a._addLegendWidget(),a._addFullScreenWidget(),a.map.trigger("change"),a._changePreview()},300)},_getSublayerOptions:function(){var a=this.map.layers.filter(function(a){return _.contains(["CartoDB","torque"],a.get("type"))});return _.map(a,function(a){return a.get("visible")}).join("|").replace(/false/g,0).replace(/true/g,1)},_updateSublayerOptions:function(){var a=this._getSublayerOptions();this.mapOptions.set("sublayer_options",a)},_showTorqueWarning:function(){var a=this.map.layers.getLayersByType("torque");a.length&&(this._resize(),this.$(".torque_warning").fadeIn())},_setPassword:function(a){a&&a.preventDefault(),a&&a.stopPropagation();var b=this.$el.find("input[type='password']").val();cdb.Utils.isBlank(b)||"FAKE123"==b||(this.$el.find(".password").addClass("loading"),this.options.vis.save({privacy:"PASSWORD",password:b},{success:this._onSaveSuccess,error:this._onSaveError}))},_onSaveSuccess:function(){var a=this.options.vis.get("privacy");"PASSWORD"==a&&this.model.set({password_button_label:this._TEXTS.edit_password_button_label,password_placeholder:this._TEXTS.edit_password_placeholder}),this.$el.find("."+a.toLowerCase()).removeClass("loading")},_onSaveError:function(){var a=this.options.vis.get("privacy");a&&this.$el.find("."+a.toLowerCase()).removeClass("loading")},_onShareClick:function(a){a.preventDefault(),a.stopPropagation(),this.shareDialogWidget.toggle()},_onPasswordKeyUp:function(a){"13"==a.keyCode&&this._setPassword()},_onPasswordClick:function(a){"FAKE123"==this.$el.find("input.password").val()&&this.$el.find("input.password").val("")},_onInputBlur:function(){"PASSWORD"==this.options.vis.attributes.privacy&&""==this.$el.find("input.password").val()&&this.model.get("password_placeholder")===this._TEXTS.edit_password_placeholder&&this.$el.find("input.password").val("FAKE123")},_onInputClick:function(a){a.preventDefault(),a.stopPropagation();var b=$(a.target).find("input")[0]?$(a.target).find("input"):$(a.target);b.select()},_onMethodClick:function(a){a.preventDefault(),a.stopPropagation();var b=$(a.target),c=b.attr("data-method");this.model.set("method",c)},_updateURL:function(a,b){""===b?this.$el.find("li.link .input_field").addClass("loading"):this.$el.find("li.link .input_field").removeClass("loading"),this.$el.find("li.link input").val(b)},_enableCopy:function(a){var b=this;setTimeout(function(){b.$el.find("a.copy").zclip({path:cdb.config.get("assets_url")+"/flash/ZeroClipboard.swf",copy:function(){return $(".tipsy .tipsy-inner").css("width",$(".tipsy .tipsy-inner").width()),$(".tipsy .tipsy-inner").text("Copied!"),$(".tipsy").delay(550).fadeOut(250),$(this).parent().find("input").val()}})},500),this.$el.find(".zclip").tipsy({gravity:"s",live:!0,fade:!0,title:function(){return _t("Copy this")}}),this.$el.find("a.tooltip").click(function(a){a.preventDefault()})},_selectAll:function(a){$(a.target).select()},_setLinkURL:function(){this.localStorage||(this.localStorage=new cdb.admin.localStorage("cartodb_urls"));var a=this.options.vis.publicURL(),b=a,c=this.localStorage.search(b);c?this.model.set("url",c):this._requestShortURL(b)},_requestShortURL:function(a){var b=this;this.model.set("url",""),$.ajax({url:"https://api-ssl.bitly.com/v3/shorten?longUrl="+encodeURIComponent(a)+"&login="+this._KEYS._BITLY.login+"&apiKey="+this._KEYS._BITLY.key,type:"GET",async:!1,dataType:"jsonp",success:function(c){b._onRequestShortURLSuccess(c,a)},error:function(c){b._onRequestShortURLError(a)}})},_onRequestShortURLSuccess:function(a,b){if(a.status_code&&"200"==a.status_code){var c={};c[b]="http://cdb.io/"+a.data.hash,this.$el.find("li.link input").val(c[b]),this.localStorage.add(c),this.model.set("url",c[b])}else this.model.set("url",b)},_onRequestShortURLError:function(a){this.model.set("url",a)},_setIframeURL:function(){var a=this.options.vis.embedURL(),b="<iframe width='100%' height='520' frameborder='0' src='"+a+"' allowfullscreen webkitallowfullscreen mozallowfullscreen oallowfullscreen msallowfullscreen></iframe>";this.$el.find(".embed input").val(b),this.$el.find(".simple_url").attr("href",a),this.$el.find(".simple_url").attr("target","_blank")},_setAPIURL:function(){this.$el.find(".api input").val(this.options.vis.vizjsonURL())},render_content:function(){this._setLinkURL(),this._setIframeURL(),this._setAPIURL();var a={account_type:this.options.user.get("account_type"),privacy:this.options.vis.get("privacy")};return this.options.user.isInsideOrg()&&(a.enterprise_org=this.options.user.organization.get("name")),cdb.god.trigger("mixpanel","Click Publish Visualization",a),cdb.god.trigger("mixpanel_people",{publish_visualization_last_clicked:new Date}),cdb.god.trigger("metrics","published_visualization",{email:window.user_data.email,data:a}),this},open:function(a){this.trigger("will_open",this),this.$(".modal").css({opacity:"0",marginTop:"120px"}),this.$(".mamufas").fadeIn(),this.$(".modal").animate({marginTop:"90px",opacity:1},300)}}),cdb.admin.SharePrivateVisDialog=cdb.admin.BaseDialog.extend({_TEXTS:{title:_t("Cannot publish this visualization"),ok:_t("Make public"),ok_next:_t("Share it now!")},initialize:function(){this.options=_.extend({title:this._TEXTS.title,template_name:"old_common/views/dialog_base",clean_on_hide:!0,enter_to_confirm:!0,ok_button_classes:"button grey",ok_title:this._TEXTS.ok,cancel_button_classes:"underline margin15",modal_type:"confirmation",width:510,modal_class:"share_private_vis_dialog"},this.options),this.active=!1,this.loading=!1,this.elder("initialize")},render_content:function(){return this.getTemplate("table/header/views/share_private_vis_dialog")(this.model.toJSON())},_makeVisPublic:function(){this.loading=!0;var a=this;this._setLoading(),this.model.save({privacy:"PUBLIC"},{wait:!0,success:function(){a._setReady()},error:function(){a._setError()}})},_setLoading:function(){this.active=!1,this.loading=!1,this._hideError(),this._showLoader(),this._disableButton()},_setReady:function(){this.hide(),this.ok&&this.ok()},_setError:function(){this.active=!1,this.loading=!1,this._showError(),this._hideLoader(),this._enableButton()},_showError:function(){this.$("p.error").fadeIn()},_hideError:function(){this.$("p.error").fadeOut()},_showLoader:function(){this.$("span.loader").fadeIn()},_hideLoader:function(){this.$("span.loader").fadeOut()},_enableButton:function(a){this.$("a.ok").removeClass("disabled").text(a||this._TEXTS.ok)},_disableButton:function(){this.$("a.ok").addClass("disabled")},_ok:function(a){return a&&a.preventDefault(),this.loading?!1:void(this.active||this._makeVisPublic())}}),cdb.admin.SyncNowModal=cdb.admin.BaseDialog.extend({initialize:function(){_.extend(this.options,{title:"",description:"",template_name:"table/header/views/sync_now_modal",clean_on_hide:!0,modal_class:"sync_now",modal_type:"creation",width:275}),this.constructor.__super__.initialize.apply(this)},_keydown:function(){}}),cdb.admin.SyncSettings=cdb.admin.BaseDialog.extend({_TEXTS:{title:_t("Synchronization options"),ok:_t("Save settings")},events:function(){return _.extend({},cdb.admin.BaseDialog.prototype.events,{"click .dialog-tab > a":"_optionClicked"})},initialize:function(){_.extend(this.options,{title:this._TEXTS.title,description:"",template_name:"table/views/sync_settings_dialog",clean_on_hide:!0,ok_button_classes:"button grey",cancel_button_classes:"hide",ok_title:this._TEXTS.ok,modal_class:"sync_settings",modal_type:"creation",width:600}),this.table=this.options.table,this.model=new cdb.core.Model({option:"interval",interval:this.table.synchronization.get("interval")}),this.model.bind("change:option",this._onOptionChange,this),this.constructor.__super__.initialize.apply(this)},render_content:function(){var a=this.$content=$("<div>"),b=this.table.synchronization.get("url");(this.table.synchronization.get("service_name")||this.table.synchronization.get("service_item_id"))&&(b=this.table.synchronization.get("service_item_id"));var c=this.table.synchronization.get("service_name");return this.temp_content=cdb.templates.getTemplate("table/header/views/sync_settings_dialog_content"),a.append(this.temp_content()),c&&_.isString(c)&&(c=c.charAt(0).toUpperCase()+c.slice(1)),this._initCombo(a),this.$(".sync_url").append('<span title="'+b+'">'+(c?c+": ":"")+b+"</span>"),a},_initCombo:function(a){var b=new cdb.forms.IntervalCombo({el:a.find(".interval-combo"),model:this.model,property:"interval",width:"108px",remove_never:!0});b.render(),this.addView(b)},_onOptionChange:function(a){this.$(".dialog-tab > a").removeClass("selected");var b=this.model.get("option");this.$(".dialog-tab."+b+" > a").addClass("selected"),this.$(".dialog-tab").removeClass("active"),this.$(".dialog-tab."+b).addClass("active")},_optionClicked:function(a){a&&a.preventDefault();var b=$(a.target).attr("href"),c=b&&b.replace("#/","");c&&this.model.get("option")!=c&&this.model.set("option",c)},ok:function(a){a&&a.preventDefault(),"interval"==this.model.get("option")?this.table.synchronization.save({interval:this.model.get("interval")}):this.table.synchronization.destroy()}}),cdb.admin.HeaderDropdown=cdb.admin.DropdownMenu.extend({className:"dropdown border",isPublic:!1,events:{"click .asc":"orderColumnsAsc","click .desc":"orderColumnsDesc","click .rename_column":"renameColumn","click .change_data_type":"changeType","click .georeference":"georeference","click .clearview":"clearView","click .filter_by_this_column":"filterColumn","click .delete_column":"deleteColumn","click .add_new_column":"addColumn"},initialize:function(){this.options.reserved_column=!1,this.options.read_only=!1,this.options.in_sql_view=!1,this.options.isPublic=this.isPublic,this.elder("initialize")},render:function(){return cdb.admin.DropdownMenu.prototype.render.call(this),this.$el[this.options.isPublic!==!0||this.options.read_only?"addClass":"removeClass"]("public"),this},setTable:function(a,b){this.table=a,this.column=b,this.options.reserved_column=this.table.isReadOnly()||this.table.isReservedColumn(b),this.options.read_only=this.table.isReadOnly(),this.options.in_sql_view=this.table.isInSQLView(),this.render(),this.$(".asc").removeClass("selected"),this.$(".desc").removeClass("selected"),a.data().options.get("order_by")===b&&("asc"===a.data().options.get("sort_order")?this.$(".asc").addClass("selected"):this.$(".desc").addClass("selected"))},orderColumnsAsc:function(a){return a.preventDefault(),this.table.data().setOptions({sort_order:"asc",order_by:this.column}),this.hide(),!1},orderColumnsDesc:function(a){return a.preventDefault(),this.table.data().setOptions({sort_order:"desc",order_by:this.column}),this.hide(),!1},renameColumn:function(a){return a.preventDefault(),this.hide(),this.trigger("renameColumn"),!1},clearView:function(a){return a&&a.preventDefault(),this.hide(),this.trigger("clearView"),!1},changeType:function(a){return a.preventDefault(),this.hide(),this.trigger("changeType",this.column),!1},georeference:function(a){return a.preventDefault(),this.trigger("georeference",this.column),this.hide(),!1},filterColumn:function(a){this.killEvent(a);var b=this.table._columnType[this.column];"boolean"!=b&&"string"!=b&&"number"!=b&&"date"!=b||"cartodb_id"==this.column?this._showFilterDialog():this._addFilter(this.column)},_addFilter:function(a){this.trigger("applyFilter",a),this.hide()},_showFilterDialog:function(){var a=this,b=new cdb.admin.FilterColumnDialog({table:this.table,column:this.column,ok:function(b){a.trigger("applyFilter",a.column)}});$("body").append(b.render().el),this.hide(),b.open()},deleteColumn:function(a){a.preventDefault();var b=this;if(this.hide(),!b.delete_confirmation){if(this.options.user.featureEnabled("new_modals")){var c=new cdb.editor.DeleteColumnView({table:this.table,column:this.column});c.appendToBody()}else{var d=new cdb.admin.BaseDialog({title:"Delete "+b.column+" column",description:"Are you sure you want to delete this column and all its associated data?",template_name:"old_common/views/confirm_dialog",clean_on_hide:!0,enter_to_confirm:!0,ok_button_classes:"right button grey",ok_title:"Yes, do it",cancel_button_classes:"underline margin15",cancel_title:"Cancel",modal_type:"confirmation",width:500});this.delete_confirmation=d,this.delete_confirmation.on("clean",function e(){b.delete_confirmation.unbind("clean",e),b.delete_confirmation=null}),d.ok=function(){b.table.deleteColumn(b.column)},d.appendToBody().open()}return!1}},addColumn:function(a){if(a.preventDefault(),this.options.user.featureEnabled("new_modals"))this.trigger("addColumn",this);else{var b=new cdb.admin.NewColumnDialog({table:this.table});$("body").append(b.render().el),b.open()}return this.hide(),!1}}),function(){var a=cdb.admin.HeaderView=cdb.core.View.extend({_TEXTS:{no_geo:{title:_t("Georeference your table"),description:_t('This funcionality is not available in the visualization view.                     Please, visit <a href="<%- prefix %>/tables/<%- table_name %>">your table</a> and start georeferencing there.'),ok:_t("Ok, close")}},NO_MENU_COLUMNS:["the_geom","the_geom_webmercator"],events:{"dblclick .coloptions":"renameColumn","click    .coloptions":"showColumnOptions","click    .coltype":"showColumnTypeOptions","click    .geo":"showGeoreferenceWindow","keydown  .col_name_edit":"_checkEditColnameInput","focusout input":"_finishEdit",click:"activateColumnOptions"},initialize:function(){this.column=this.options.column,this.table=this.options.table,this.vis=this.options.vis,this.template=this.getTemplate("table/views/table_header_view"),this.editing_name=!1,this.changing_type=!1,this.vis.bind("change:type",function(){a&&a.colTypeOptions.render()}),this.add_related_model(this.vis),void 0===a.colOptions&&(a.colOptions=new cdb.admin.HeaderDropdown({user:this.options.user,position:"position",horizontal_position:"right",tick:"right",template_base:"table/views/table_header_options",sqlView:this.options.sqlView,vis:this.vis}),a.colOptions.render(),cdb.god.bind("closeDialogs",a.colOptions.hide,a.colOptions)),void 0===a.colTypeOptions&&(a.colTypeOptions=new cdb.admin.ColumntypeDropdown({user:this.options.user,position:"position",horizontal_position:"right",tick:"right",template_base:"table/views/table_column_type_options"}),a.colTypeOptions.render(),cdb.god.bind("closeDialogs",a.colTypeOptions.hide,a.colTypeOptions))},_addColumn:function(a){table.tableTab.tableView.addColumn(a)},render:function(){if(this.$el.html(""),this.$el.append(this.template({col_name:this.column[0],col_type:this.column[1],editing_name:this.editing_name,changing_type:this.changing_type,read_only:this.table.isReadOnly(),isReservedColumn:this.table.isReadOnly()||this.table.isReservedColumn(this.column[0]),noMenu:this.NO_MENU_COLUMNS.indexOf(this.column[0])>=0})),this.editing_name){var a=this.$el.find("p.auto").width();this.$el.find("input").css({"max-width":a,width:a}).focus()}return this.delegateEvents(),this},_openColOptions:function(b){var c=this,d=a.colOptions;d.off(),cdb.god.unbind("closeDialogs",a.colOptions.hide,a.colOptions),cdb.god.trigger("closeDialogs"),d.setTable(this.table,this.column[0]),d.bind("addColumn",this._addColumn,this),d.bind("renameColumn",this.renameColumn,this),d.bind("changeType",this._changeType,this),d.bind("clearView",function(){c.trigger("clearView")},this),d.bind("georeference",function(a){c.trigger("georeference",a)},this),d.bind("applyFilter",function(a){c.trigger("applyFilter",a)},this);var e=$(b.target).parent().parent();e.append(d.el);var f=$(b.target).width()+26,g=e.parent();d.openAt(f-d.$el.width(),g.height()/2+7),cdb.god.bind("closeDialogs",a.colOptions.hide,a.colOptions)},_openColTypeOptions:function(b){if(!this.table.isReadOnly()){var c=a.colTypeOptions;c.off(),cdb.god.unbind("closeDialogs",a.colTypeOptions.hide,a.colTypeOptions),cdb.god.trigger("closeDialogs"),c.setTable(this.table,this.column[0]);var d=$(b.target).parent().parent();d.append(c.el);var e=$(b.target).outerWidth()+24,f=d.parent();c.openAt(e-c.$el.width(),f.height()/2+25),cdb.god.bind("closeDialogs",a.colTypeOptions.hide,a.colTypeOptions)}},_checkEditColnameInput:function(a){13===a.keyCode&&this._submitEdit(),27===a.keyCode&&this._finishEdit()},_submitEdit:function(){this.table.renameColumn(this.column[0],$(".col_name_edit").val()),this._finishEdit()},_finishEdit:function(){this.editing_name=!1,this.render()},renameColumn:function(a){a&&this.killEvent(a),this.editing_name=!0,this.changing_type=!1,this.render()},_changeType:function(a){this.editing_name=!1,this.changing_type=!0;var b=this.$el.find("a.coltype");b.click()},activateColumnOptions:function(a){this.killEvent(a),this.$el.find("a.coloptions").click()},showColumnOptions:function(b){var c=this,d=a.colOptions,e=this.column[0];return b.preventDefault(),d.isOpen&&e==d.column?(d.hide(),!1):(this.NO_MENU_COLUMNS.indexOf(this.column[0])<0&&d.hide(function(){d.parent_&&d.parent_.css("z-index",0);var a=c.$el.find("th > div");d.parent_=a,a.css("z-index","100"),
c._openColOptions(b)}),!1)},showGeoreferenceWindow:function(a){this.killEvent(a),this.trigger("georeference",null)},showColumnTypeOptions:function(b){var c=this,d=a.colTypeOptions,e=this.column[0];return b&&b.preventDefault(),d.isOpen&&e==d.column?(d.hide(),!1):(d.hide(function(){c._openColTypeOptions(b)}),!1)}})}(),function(){var a=cdb.geo.ui.Infowindow.extend({_TEXTS:{_NO_FIELDS_SELECTED:_t("You haven’t selected any fields to be shown in the infowindow."),_NO_FIELDS_SELECTED_BUTTON:_t("Select fields")},_TEMPLATE_URL:"table/views/infowindow/templates",events:cdb.core.View.extendEvents({"click .edit_data":"_editData","click .edit_geo":"_editGeom","click .remove":"_removeGeom","click .open_infowindow_panel":"_openInfowindowPanel"}),initialize:function(){var a=this;_.bindAll(this,"_removeGeom"),this.table=this.options.table,this.model.set({content:"loading..."}),this.constructor.__super__.initialize.apply(this),this.model.set("offset",[28,0]),this.model.bind("change:fields",function(){!this.hasChanged("content")&&a.row&&a.renderInfo()}),this.table.bind("change:schema",this.render,this),this.add_related_model(this.table),this._containsCover&&this._createHelpDialog(),this.$("div.cartodb-edit-buttons a.button").tipsy({live:!0,fade:!0,gravity:"s",offset:-2,className:function(){return $(this).closest(".cartodb-popup").hasClass("dark")?"dark":""},title:function(a){var b=!$(this).hasClass("disabled");return b?$(this).text():"Not available in this mode"}})},_createHelpDialog:function(){var a=cdb.admin.BaseDialog.extend({render_content:function(){return"<p>This template allows you to add an image to your infowindow.</p><p>The image URLs will need to be stored as a column in your table. Next, you will need to drag the URL field to the top of the fields list.</p>"}});this.helpDialog=new a({title:"Adding images to your infowindows",ok_title:"Ok, close",cancel_title:"",ok_button_classes:"button grey",modal_type:"compressed",width:500}),this.addView(this.helpDialog)},setFeatureInfo:function(a){return this.cartodb_id=a,this.render(),this.row&&this.row.unbind(null,null,this),this.row=this.table.data().getRow(a,{no_add:!0}),this.row.bind("change",this.renderInfo,this).fetch({cache:!1,no_geom:!0}),this.renderInfo(),this},render:function(){var a=this;cdb.geo.ui.Infowindow.prototype.render.call(this);var b=this.model.get("fields");if(b&&(!b||b.length)||this.model.get("template"))this.$(".cartodb-popup").removeClass("no_fields");else{this.$(".cartodb-popup").addClass("no_fields");var c=".cartodb-popup-content";this.$(".cartodb-popup-header").length>0&&(c=".cartodb-popup-header"),this.$(c).html('<p class="italic">'+this._TEXTS._NO_FIELDS_SELECTED+'</p><p><a class="margin5 underline open_infowindow_panel" href="#/select-fields">'+this._TEXTS._NO_FIELDS_SELECTED_BUTTON+"</a></p>")}this.$(".cartodb-popup-content-wrapper").append(this.getTemplate("table/views/infowindow/infowindow_footer")({cartodb_id:this.cartodb_id})),this.table.isReadOnly()&&this.$(".cartodb-popup-content-wrapper").find("a.remove, a.edit_data, a.edit_geo").addClass("disabled"),this._containsCover()&&(this.$(".image_not_found a.help").off("click"),this.$(".image_not_found a.help").on("click",function(){$("body").append(a.helpDialog.render().el),a.helpDialog.open()}))},renderInfo:function(){var a=this,b=_(this.row.attributes).map(function(b,c){if(a.model.containsField(c)&&!_.contains(a.model.SYSTEM_COLUMNS,c)){var d={title:a.model.getFieldProperty(c,"title")?c:null,value:b,position:a.model.getFieldPos(c)};return d}return null});b=_.compact(b),b.sort(function(a,b){return a.position-b.position});for(var c=[],d=0;d<b.length;++d){var e=b[d];e&&(e.index=c.length?c.length:null,c.push(e))}b.length>0?this.model.set({content:{fields:c}}):this.setLoading(),this.model.get("visibility")&&this.adjustPan()},_loadCover:function(){if(this._containsCover()){var a=this.$(".cover"),b=this.$(".image_not_found"),c=a.find("img"),d=this._getCoverURL();if(!this._isValidURL(d))return b.fadeIn(250),void c.hide();var e=document.getElementById("spinner"),f={lines:9,length:4,width:2,radius:4,corners:1,rotate:0,color:"#ccc",speed:1,trail:60,shadow:!0,hwaccel:!1,zIndex:2e9},g=new Spinner(f).spin(e);b.hide(),c.hide(function(){this.remove()}),c=$("<img />").attr("src",d),a.append(c),c.load(function(){g.stop();var b=c.width(),d=c.height(),e=a.width(),f=a.height(),h=d/b,i=f/e;if(b>e&&d>f)if(i>h)c.css({height:f});else{var j=d/(b/e);c.css({width:e,top:"50%",position:"absolute","margin-top":-1*parseInt(j,10)/2})}else{var j=d/(b/e);c.css({width:e,top:"50%",position:"absolute","margin-top":-1*parseInt(j,10)/2})}c.fadeIn(300)}).error(function(){g.stop(),b.fadeIn(250)})}},_editGeom:function(a){return this.killEvent(a),this.model.set("visibility",!1),this.trigger("editGeom",this.row),!1},_editData:function(a){this.killEvent(a),this.model.set("visibility",!1),this.trigger("editData",this.row)},_removeGeom:function(a){this.killEvent(a),this.model.set("visibility",!1),this.trigger("removeGeom",this.row)},_openInfowindowPanel:function(a){this.killEvent(a),this.trigger("openInfowindowPanel")},_getModelTemplate:function(){var a=cdb.admin.mod.TemplateMap[this.model.get("template_name")]||this.model.get("template_name");return this._TEMPLATE_URL+"/"+a}});cdb.admin.MapInfowindow=a}(),cdb.admin.LayerPanelView=cdb.admin.RightMenu.extend({_TEXTS:{error:{"default":_t("Something went wrong, try again later")},visible:_t("This layer is hidden, changes won't be shown                       until you make it visible"),dblclick:_t("Double click will allow you to rename it")},MODULES:["infowindow","legends"],className:"layer_panel",events:{"dblclick span.name":"_editAlias","click a.info":"_switchTo","click a.visibility":"_switchVisibility","click a.remove":"_removeLayer","keyup input.alias":"_changeAlias","click input.alias":"killEvent",click:"setPanelStatus"},initialize:function(){cdb.admin.RightMenu.prototype.initialize.call(this),_.bindAll(this,"_editAlias"),this.table=this.model.table,this.sqlView=new cdb.admin.SQLViewData,this.map=this.options.vis.map,this.globalError=this.options.globalError,this.user=this.options.user,this.vis=this.options.vis,this.view_model=new cdb.core.Model({state:"idle"}),this.render(),this.activeWorkView="table",this.setDataLayer(this.model),this.model.bind("change:id",function(a){this.vis.save("active_layer_id",this.dataLayer.id),this.$el.attr("model-id",this.model.id)},this),this.model.bind("change:type",this._setLayerType,this),this.model.bind("change:visible",this.setVisibleMsg,this),this.model.bind("destroy",function(){this.trigger("destroy",this.dataLayer.cid)},this),this.view_model.bind("change:state",this._onChangeStatus,this),this.add_related_model(this.view_model),cdb.god.bind("panel_action",this.setPanelStatus,this),this.add_related_model(cdb.god),this.$el.attr("model-id",this.model.id),this._setLayerType()},_switchTo:function(a){a&&a.preventDefault();var b=this.vis.get("active_layer_id")==this.dataLayer.id;if(b&&"span"==$(a.target).prop("tagName").toLowerCase()&&"name"==$(a.target).prop("className")){var c=this;return setTimeout(function(){c._dblClick||c.$(".layer-info a.info .name").tipsy("show"),delete c._dblClick},150),!1}return this.trigger("switchTo",this),this.view_model.set("state","idle"),this.filters._addFilters(),!1},_editAlias:function(a){return a.preventDefault(),a.stopPropagation(),this.vis.isVisualization()?(this._dblClick=!0,this.view_model.set("state","idle"==this.view_model.get("state")?"editing":"idle")):this.trigger("switchTo",this),!1},_changeAlias:function(a){$(a.target).val();return a&&13==a.keyCode?(this.view_model.set({state:"idle"}),!1):void 0},setPanelStatus:function(){this.view_model.set("state","idle")},_onChangeStatus:function(){var a=this.$(".layer-info div.left");if("idle"==this.view_model.get("state")){var b=a.find("input").val();a.find("input").hide(),a.find("span.name").show(),a.find("span.name_info").show(),b!=this.view_model.get("table_name_alias")&&(""==b||" "==b?this.dataLayer.unset("table_name_alias"):this.dataLayer.set({table_name_alias:b}),this.dataLayer.save(),this.setLayerName(this.dataLayer))}else a.find("span.name").hide(),a.find("span.name_info").hide(),a.find("input").val(this.dataLayer.get("table_name_alias")||this.dataLayer.get("table_name").replace(/_/g," ")).show().focus()},_setLayerType:function(){this.$el.attr("layer-type",this.model.get("type").toLowerCase())},activated:function(){this.deactivated(),this.$el.html(""),this.render(),this.setDataLayer(this.model),this.setActivePanelView(),this.panels.bind("tabEnabled",this.saveActivePanelView,this)},deactivated:function(){this.clearSubViews(),this.buttons=[],this.panels.unbind("tabEnabled",this.saveActivePanelView,this),this.panels.clean(),this.tabs.clean(),this.view_model.set("state","idle")},_switchVisibility:function(a){return a.preventDefault(),this.vis.isVisualization()?(this.model.infowindow&&this.model.infowindow.set("visibility",!1),void this.model.save({visible:!this.model.get("visible")})):(cdb.log.info("You can't toggle the layer visibility in a table view"),!1)},_removeLayer:function(a){return a.preventDefault(),this.vis.isVisualization()?void this.trigger("delete",this):(cdb.log.info("You can't remove a layer in a table view"),!1)},_setLayerInfo:function(a){this.setLayerName(a),this.setLayerOptions(a),this.setLayerOrder(a),this.setVisibility(a),this.setVisibleMsg(a),this.setView(a)},setView:function(a){this.$el[this.vis.isVisualization()?"addClass":"removeClass"]("vis")},setVisibleMsg:function(){var a=["sql_mod","cartocss_mod"];if(this.$(".layer-views div.info.warning").remove(),!this.model.get("visible")){var b=$("<div>").addClass("info warning").append("<p>"+this._TEXTS.visible+"</p>"),c=_.contains(a,this.currentPanelView);b[c?"addClass":"removeClass"]("editor"),this.$(".layer-views").append(b)}},setLayerName:function(a){this.vis.isVisualization()?(this.$(".layer-info a.info .name").text(a.get("table_name_alias")||a.get("table_name").replace(/_/g," ")),this.$(".layer-info a.info .name_info").text("view of "+a.get("table_name")),this.table.isSync()?this.$(".layer-info a.info .name").append($("<i>").addClass("synced")):this.$(".layer-info i.synced").remove(),this._setLayerTooltip()):(this._unsetLayerTooltip(),this.$(".layer-info a.info .name").text(a.get("table_name")))},_setLayerTooltip:function(){var a=this;this.$(".layer-info a.info .name").tipsy({trigger:"manual",fade:!0,gravity:"s",title:function(){return a._TEXTS.dblclick}}).bind("mouseleave",function(){$(this).tipsy("hide")})},_unsetLayerTooltip:function(){var a=this.$(".layer-info a.info .name");a.data("tipsy")&&(a.unbind("mouseenter mouseleave"),a.data("tipsy").remove())},setLayerOptions:function(a){this.vis&&!this.vis.isVisualization()?this.$(".layer-info div.right").hide():this.$(".layer-info div.right").show()},setVisibility:function(a){var b=this.$(".layer-info div.right a.switch"),c=this.$(".layer-info div.right a.remove");this.vis.map.layers.length<=2?(b.hide(),c.hide()):(b.css("display","inline-block"),c.css("display","inline-block")),this.$(".layer-info div.right a.switch").removeClass("enabled disabled").addClass(a.get("visible")?"enabled":"disabled")},setLayerOrder:function(a){var b="1";this.vis.isVisualization()&&(b=a.collection.indexOf(a)),this.$(".layer-info a.info .order").text(b)},setDataLayer:function(a){var b=this;this.add_related_model(a);var c=b.MODULES;b.dataLayer||(b.dataLayer=a,this._initDataLayer(a)),this._setLayerInfo(a);var d=new cdb.admin.mod.SQL({model:b.dataLayer,user:b.user,className:"sql_panel editor"});this.filters=new cdb.admin.mod.Filters({table:b.table,sqlView:b.sqlView,dataLayer:b.dataLayer}),cdb.god.bind("end_narrow",function(){b.filters.loadScroll()},this);var e={polygon:"SimpleWizard",cluster:"ClusterWizard",intensity:"IntensityWizard",bubble:"BubbleWizard",choropleth:"ChoroplethWizard",color:"CategoryWizard",category:"CategoryWizard",density:"DensityWizard",torque:"TorqueWizard",torque_cat:"TorqueCategoryWizard",torque_heat:"TorqueHeatWizard"},f=new cdb.admin.mod.CartoCSSWizard({user:this.user,model:this.dataLayer,table:this.table,map:this.map,className:"wizards_panel",wizards:e}).bind("modules",function(a){c=a,this.enableModules(a)},this).bind("activeWizard",function(a){this.dataLayer.infowindow&&this.dataLayer.infowindow.set("visibility",!1)},this),g=this.infowindow=new cdb.admin.mod.InfoWindow({table:b.table,dataLayer:a});g.bind("tabChanged",this._onModuleTabChanged,this);var h=new cdb.admin.mod.CartoCSSEditor({model:b.dataLayer,table:b.table,className:"csseditor_panel editor"}).bind("hasErrors",function(){b.addClassToButton("cartocss_mod","has_errors")}).bind("clearError",function(){b.removeClassFromButton("cartocss_mod","has_errors")}),i=new cdb.admin.mod.LegendEditor({model:a.legend,dataLayer:a,className:"legends_panel",availableLegends:[{name:"none",enabled:!0},{name:"custom",enabled:!0},{name:"color",enabled:!1},{name:"category",enabled:!1},{name:"bubble",enabled:!1},{name:"choropleth",enabled:!1},{name:"intensity",enabled:!1},{name:"density",enabled:!1},{name:"torque_cat",enabled:!1}]}).bind("modules",function(a){c=a,b.enableModules(a)}).bind("tabChanged",this._onModuleTabChanged,this);b.addModule(d.render(),["table","tableLite","map","mapLite"]),b.addModule(f.render(),["map","mapLite"]),b.addModule(g.render(),["map","mapLite"]),b.addModule(h.render(),["map","mapLite"]),b.addModule(i.render(),["map","mapLite"]),b.addModule(this.filters.render(),["table","tableLite","map","mapLite"]);var j=b.addToolButton("merge_datasets","table"),k=b.addToolButton("add_row","table"),l=b.addToolButton("add_column","table"),m=b.addToolButton("add_feature","map");k.bind("click",this._addRow,this),l.bind("click",this._addColumn,this),j.bind("click",this._mergeTables,this),m.bind("click",this._addFeature,this),this.enableModules(c),this._bindDataLayer()},_initDataLayer:function(a){a.bind("change:table_name",this.setLayerName,this),a.bind("change:order",this.setLayerOrder,this),a.bind("change:visible",this.setVisibility,this),a.collection.bind("add remove",this.setVisibility,this),this.add_related_model(a.collection),a.set({stat_tag:this.vis.get("id"),user_name:this.user.get("username"),maps_api_template:cdb.config.get("maps_api_template"),cartodb_logo:!1,no_cdn:!1,force_cors:!0});var b=a.get("extra_params")||{};b.api_key=b.map_key=this.user.get("api_key"),a.set("extra_params",b),a.invalidate()},_bindDataLayer:function(){var a=this;this.dataLayer.bindSQLView(this.sqlView),this.dataLayer.bind("parseError",function(){"map"===a.activeWorkView&&a.globalError.showError("There is a problem with the map tiles. Please, check your CartoCSS style.","error",0,"tiles")},this).bind("sqlNoMercator",function(){"map"===a.activeWorkView},this).bind("error",function(b,c){var d=c&&"abort"===c.statusText;"map"!==a.activeWorkView||d||a.globalError.showError("There is a problem with your connection","error",0,"tiles")},this).bind("tileOk",function(){a.globalError.hide("tiles")},this),this.table.bind("columnRename columnDelete columnAdded geolocated",function(){a.dataLayer.invalidate()},this),this.table.bind("change:geometry_types",function(){this.table.get("geometry_types").length?this._enableGeometryRelatedWizards():this._disableGeometryRelatedWizards()},this),this.table.bind("change:permission",this._checkButtons,this),this.table.bind("change:readOnly",this._checkButtons,this),this.table.bind("change:synchronization",this._checkButtons,this),this.table.bind("change:isSync",this._checkButtons,this),this.vis.bind("change:type",function(){this.setLayerOptions(),this.setLayerName(this.model)},this),this.model.bind("applySQLView errorSQLView clearSQLView",this._checkButtons,this),this.model.unbind("applyFilter",this._applyFilter,this),this.model.bind("applyFilter",this._applyFilter,this),this.add_related_model(this.vis),this.add_related_model(this.table),this._checkButtons()},enableModules:function(a){var b=this;_(b.MODULES).each(function(c){"infowindow"!==c||b.model.wizard_properties.supportsInteractivity()?_.contains(a,c)?b.enableModule(c+"_mod"):b.disableModule(c+"_mod"):b.disableModule("infowindow_mod")})},SQL_WIZARDS:["cartocss_mod","wizards_mod","infowindow_mod","legends_mod"],_disableGeometryRelatedWizards:function(){var a=this;_(this.SQL_WIZARDS).each(function(b){a.disableModule(b)})},_enableGeometryRelatedWizards:function(){var a=this;_(this.SQL_WIZARDS).each(function(b){"infowindow_mod"!=b||a.model.wizard_properties.supportsInteractivity()?a.enableModule(b):a.disableModule(b)})},_addRow:function(){this.table.data().addRow({at:0}),this.trigger("createRow"),cdb.god.trigger("closeDialogs")},_addColumn:function(){this.user.featureEnabled("new_modals")?this.trigger("addColumn",this):(new cdb.admin.NewColumnDialog({table:this.table}).appendToBody().open(),cdb.god.trigger("closeDialogs"))},_mergeTables:function(){var a=this.user,b=a.featureEnabled("new_modals")?cdb.editor.MergeDatasetsView:cdb.admin.MergeTablesDialog;new b({table:this.table,user:a}).appendToBody().open({center:!0}),cdb.god.trigger("closeDialogs")},_addFeature:function(a){if("leaflet"===this.map.get("provider")&&this.map.clamp(),this.table.isGeoreferenced())this._addGeometry();else if(this.user.featureEnabled("new_modals"))this._showScratchDialog();else{this.newGeomDropdown&&this.newGeomDropdown.clean(),this.newGeomDropdown=new cdb.admin.NewGeometryDropdown({position:"position",template_base:"table/views/table_new_geom",tick:"bottom",horizontal_position:"right"}),this.newGeomDropdown.bind("onDropdownHidden",function(){cdb.god.unbind(null,null,this.newGeomDropdown),this.newGeomDropdown&&this.newGeomDropdown.clean()},this),this.newGeomDropdown.bind("onDropdownShown",function(){cdb.god.unbind("closeDialogs",this.newGeomDropdown.hide,this.newGeomDropdown),cdb.god.trigger("closeDialogs"),cdb.god.bind("closeDialogs",this.newGeomDropdown.hide,this.newGeomDropdown)},this),this.newGeomDropdown.bind("newGeometry",function(a){this._addGeometry(a)},this),$("body").append(this.newGeomDropdown.render().el);var b=this.tabs.getTab(a).offset();this.newGeomDropdown.openAt(b.left-165,b.top-77)}},_showScratchDialog:function(){this.scratchDialog=new cdb.editor.ScratchView({table:this.table,skipDisabled:!0}),this.scratchDialog.appendToBody(),this.scratchDialog.bind("newGeometry",function(a){this._addGeometry(a)},this)},_addGeometry:function(a){a=a||this.table.geomColumnTypes()[0],this.dataLayer.trigger("startEdition",a)},_onModuleTabChanged:function(a){this.trigger("tabChanged",a)},_checkButtons:function(){var a=this,b=this.table.get("geometry_types"),c={applied:"remove",has_errors:"remove"};this.table.isReadOnly()?(this.table.isInSQLView()&&("error"===this.model.getCurrentState()?c={applied:"add",has_errors:"add"}:c.applied="add"),b&&0===b.length?this._disableGeometryRelatedWizards():this._enableGeometryRelatedWizards(),this._readOnlyTableButtons()):(b&&0===b.length?this._disableGeometryRelatedWizards():this._enableGeometryRelatedWizards(),this._writableTableButtons()),this.setLayerName(this.dataLayer),_.each(c,function(b,c){a["remove"===b?"removeClassFromButton":"addClassToButton"]("sql_mod",c)})},setActiveWorkView:function(a){this.activeWorkView=a,this._checkButtons(),this.setActivePanelView(!0)},saveActivePanelView:function(a){this.currentPanelView=a,this.setVisibleMsg()},setActivePanelView:function(a){if(a||!this.currentPanelView)if("map"===this.activeWorkView){var b=this.table.get("geometry_types");"error"!==this.model.getCurrentState()&&b&&b.length>0&&this.active("wizards_mod")}else this.active("sql_mod");else this.active(this.currentPanelView)},_readOnlyTableButtons:function(){"map"===this.activeWorkView?this.showTools("mapLite",!0):this.showTools("tableLite",!0)},_writableTableButtons:function(){"map"===this.activeWorkView?this.showTools("map",!0):this.showTools("table",!0)},_applyFilter:function(a){var b={column:a},c=this.filters.filters.find(function(a){return a.get("column")==b.column});c||this.filters.filters.add(b)},hide:function(){this.$(".layer-sidebar").hide(),this.$(".layer-views").hide()},show:function(){this.$(".layer-sidebar").show(),this.$(".layer-views").show()},showModule:function(a,b){b&&this[a]&&this[a].setActiveTab(b),this.trigger("show",a+"_mod",this)},clean:function(){this._unsetLayerTooltip(),cdb.admin.RightMenu.prototype.clean.call(this)}}),"0.7.3"!==L.version)throw new Error("remove leaflet_monkeypatch.js file");if(L.Map.prototype.removeLayer=function(a){var b=L.stamp(a);return this._layers[b]?(this._loaded&&a.onRemove(this),delete this._layers[b],this._loaded&&this.fire("layerremove",{layer:a}),this._zoomBoundLayers[b]&&(delete this._zoomBoundLayers[b],this._updateZoomLevels()),this.options.zoomAnimation&&L.TileLayer&&a instanceof L.TileLayer&&(this._tryAnimatedZoom&&this._animatingZoom&&this._nothingToAnimate()&&this._onZoomTransitionEnd(),this._tileLayersNum--,this._tileLayersToLoad--,a.off("load",this._onTileLayerLoad,this)),this):this},"undefined"!=typeof google){_.extend(MarkerGMaps.prototype,google.maps.Marker.prototype,{bind:function(a,b){google.maps.event.addListener(this,a,function(a){a._latlng=[a.latLng.lat(),a.latLng.lng()],b(a)})},geojson:function(){return cdb.geo.gmaps.PathView.getGeoJSON(this,"Point")}});var gmapsPolyPrototype={bind:function(a,b){google.maps.event.addListener(this,a,function(a){a._latlng=[a.latlng.lat,a.latlng.lng],b(a)})},setPath:function(a){google.maps.Polygon.prototype.setPath.call(this,_(a).map(function(a){return new google.maps.LatLng(a[0],a[1])}))},setVertex:function(a,b){this.getPath().setAt(a,new google.maps.LatLng(b[0],b[1]))}};_.extend(PolygonGMaps.prototype,google.maps.Polygon.prototype,gmapsPolyPrototype,{geojson:function(){return cdb.geo.gmaps.PathView.getGeoJSON(this,"MultiPolygon")}}),_.extend(PolylineGMaps.prototype,google.maps.Polyline.prototype,gmapsPolyPrototype,{geojson:function(){return cdb.geo.gmaps.PathView.getGeoJSON(this,"MultiLineString")}})}var MarkerLeaflet=L.Marker.extend({initialize:function(a){a.icon&&(a.icon=L.icon({iconUrl:a.icon.url,iconAnchor:[a.icon.anchor.x,a.icon.anchor.y]})),a.position&&(a.position=new L.LatLng(a.position[0],a.position[1]));var b=[a.position].concat(Array.prototype.slice.call(arguments));L.Marker.prototype.initialize.apply(this,b);var a=arguments[0]||{};a.map&&(this.map=a.map,this.addTo(a.map))},bind:function(a,b){var c=this;this.on(a,function(a){a._latlng=[c.getLatLng().lat,c.getLatLng().lng],b(a)})},setMap:function(a){a?this.addTo(a):this.map.removeLayer(this)},geojson:function(){return this.toGeoJSON().geometry}}),PathPrototype={initialize:function(){this._parent.prototype.initialize.apply(this,arguments);var a=arguments[0]||{};a.map&&(this.map=a.map,this.addTo(a.map)),a.stroke=a.strokeOpacity>0,a.color=a.strokeColor,a.fill=a.fillOpacity>0,a.weight=a.strokeWeight,a.opacity=a.strokeOpacity,this.setStyle(a)},bind:function(a,b){this.on(a,function(a){a.latLng=a.latlng,b(a)})},setVertex:function(a,b){var c=this.getLatLngs();c[a]=new L.LatLng(b[0],b[1]),this.setLatLngs(c)},setPath:function(a){var b=_(a).map(function(a){return new L.LatLng(a[0],a[1])});this.setLatLngs(b)},setMap:function(a){a?this.addTo(a):this.map.removeLayer(this)}},PolygonLeaflet=L.Polygon.extend(PathPrototype).extend({_parent:L.Polygon,geojson:function(){var a=this.toGeoJSON().geometry;return{type:"MultiPolygon",coordinates:[a.coordinates]}}}),PolylineLeaflet=L.Polyline.extend(PathPrototype).extend({_parent:L.Polyline,geojson:function(){var a=this.toGeoJSON().geometry;return{type:"MultiLineString",coordinates:[a.coordinates]}}}),BaseDrawTool=cdb.core.View.extend({image:{url:cdb.config.get("assets_url")+"/images/layout/edit_marker_icon.png",anchor:{x:5,y:5}},_setObjects:function(){"googlemaps"==this.mapview.map.get("provider")?(this.Marker=MarkerGMaps,this.Polygon=PolygonGMaps,this.Polyline=PolylineGMaps):(this.Marker=MarkerLeaflet,this.Polygon=PolygonLeaflet,this.Polyline=PolylineLeaflet)}}),PointDrawTool=BaseDrawTool.extend({image:{url:cdb.config.get("assets_url")+"/images/layout/default_marker.png",anchor:{x:11,y:11}},initialize:function(){this.mapview=this.options.mapview,this.map=this.mapview.getNativeMap(),this.marker=null,this._setObjects()},canFinish:function(){return null!=this.marker},start:function(){this.mapview.bind("click",function(a,b){this.marker=new this.Marker({position:b,map:this.map,icon:this.image,draggable:!0,flat:!0,raiseOnDrag:!1}),this.mapview.unbind("click",null,this)},this)},clean:function(){this.marker&&this.marker.setMap(null),this.mapview.unbind("click",null,this)},getGeoJSON:function(){return this.marker.geojson()}}),PolygonDrawTool=BaseDrawTool.extend({initialize:function(){_.bindAll(this,"add_vertex","_add_vertex"),this.mapview=this.options.mapview,this.map=this.mapview.getNativeMap(),this._setObjects(),this.reset()},canFinish:function(){return this.vertex.length>=3},start:function(){this.mapview.unbind("click",this.add_vertex),this.mapview.bind("click",this.add_vertex),this.reset()},reset:function(){void 0!==this.feature&&(this.feature.setMap(null),delete this.feature),void 0!==this.markers&&_.each(this.markers,function(a){a.setMap(null)}),this.markers=[],this.vertex=[],this.createOverlays()},createOverlays:function(){this.feature=new this.Polygon({path:[],fillColor:"white",fillOpacity:.4,strokeOpacity:1,strokeColor:"#397DBA",strokeWeight:4,clickable:!1,map:this.map})},clean:function(){this.reset(),this.mapview.unbind("click",this.add_vertex),this.feature.setMap(null),delete this.feature},_add_vertex:function(a){var b=new this.Marker({position:a,map:this.map,icon:this.image,draggable:!0,flat:!0,raiseOnDrag:!1});return b.index=this.vertex.length,this.markers.push(b),this.vertex.push(a),this.feature.setPath(this.vertex),b},add_vertex:function(a,b){var c=this._add_vertex(b);c.bind("drag",function(a){d.mapview.unbind("click",d.add_vertex),d.vertex[c.index]=a._latlng,d.feature.setVertex(c.index,a._latlng)}),c.bind("dragend",function(a){d.feature.setVertex(c.index,a._latlng),d.vertex[c.index]=a._latlng,_.defer(function(){d.mapview.bind("click",d.add_vertex)})});var d=this},getGeoJSON:function(){return this.feature.geojson()}}),PolylineDrawTool=PolygonDrawTool.extend({createOverlays:function(){this.feature=new this.Polyline({path:[],strokeOpacity:1,strokeColor:"#397DBA",strokeWeight:4,fillOpacity:0,clickable:!1,map:this.map})},canFinish:function(){return this.vertex.length>=2}});cdb.admin.EditFeatureFields=cdb.admin.BaseDialog.extend({editorField:{date:cdb.admin.DateField,number:cdb.admin.NumberField,"boolean":cdb.admin.BooleanField,geometry:cdb.admin.GeometryField,"timestamp with time zone":cdb.admin.DateField,"timestamp without time zone":cdb.admin.DateField,string:cdb.admin.StringField},initialize:function(){_.defaults(this.options,{title:"Edit fields",width:450,ok_title:"Save and close",ok_button_classes:"button grey",cancel_title:"",clean_on_hide:!0,enter_to_confirm:!1,modal_type:"creation",modal_class:"edit_fields_dialog",include_footer:!0}),cdb.admin.BaseDialog.prototype.initialize.apply(this)},render_content:function(){var a=$("<div>").addClass("edit_content"),b=$("<div>").addClass("wrapper"),c=this,d=(this.options.table.get("schema"),this.options.table.hiddenColumns),e=_.keys(this.model.attributes);e.sort(),_.each(e,function(a){var e=c.model.get(a);if(!_.contains(d,a)&&!_.isFunction(e)){var f=c.options.table.getColumnType(a),g=c.editorField[f]||c.editorField.string,h=new g({label:!0,readOnly:!1,model:new cdb.core.Model({attribute:a,value:e})}).bind("ENTER",function(a){this._ok()},c);b.append(h.render().el),c.addView(h)}});var f=new cdb.admin.CustomScrolls({parent:a,el:b});return this.addView(f),a.append(b),a},_scrollToError:function(){var a=_.find(this._subviews,function(a){return!a.isValid()});if(a){var b=a.$el,c=this.$(".wrapper");c.stop().animate({scrollTop:b.offset().top-c.offset().top+c.scrollTop()},250)}},_isFormValid:function(){for(var a in this._subviews){var b=this._subviews[a];if(b.model&&!b.isValid())return!1}return!0},_ok:function(a){return a&&a.preventDefault(),this._isFormValid()?(this.ok&&this.ok(),void this.hide()):(this._scrollToError(),!1)},ok:function(){var a={};_(this._subviews).each(function(b){b.model&&(a[b.model.get("attribute")]=b.model.get("value"))}),this.options.res&&this.options.res(a)}}),cdb.geo.ui.LayerView=cdb.geo.ui.LayerView.extend({defaults:{template:'        <a class="layer" href="#/change-layer"><%- table_name_alias || table_name %></a>        <a href="#switch" class="right <%- visible ? "enabled" : "disabled" %> switch"><span class="handle"></span></a>      '},render:function(){var a=_.clone(this.model.attributes);return a.table_name_alias=a.table_name_alias||"",this.$el.append(this.template(a)),this}}),cdb.admin.MapOptionsDropdown=cdb.ui.common.Dropdown.extend({className:"dropdown map_options_dropdown",defaults:{speedOut:90,speedIn:90},events:{click:"killEvent"},desktopOverlays:["shareable","zoom","share"],initialize:function(){_.bindAll(this,"open","hide","_handleClick","_keydown"),_.defaults(this.options,this.defaults),this.collection.on("reset",this._setupOptions,this),this.mapOptions=new cdb.core.Model({title:!1,description:!1,search:!1,layer_selector:!1,fullscreen:!1,share:!0,logo:!0,zoom:!0,scrollwheel:!1,legends:!0}),this.template_base=cdb.templates.getTemplate(this.options.template_base),this.options.canvas.bind("change:mode",this._onChangeDevice,this),this.mapOptions.bind("change",this._onMapOptionsChange,this),$(this.options.target).bind({click:this._handleClick}),$(this.options.target).bind({dblclick:this.killEvent}),$(document).bind("keydown",this._keydown),this.isOpen=!1,this._setupOptions()},_onMapOptionsChange:function(a,b){_.each(b.changes,function(a,b){var c=this.$el.find("li."+b);c.find("a").hasClass("enabled")?c.addClass("active"):c.removeClass("active")},this)},_enableDesktopOverlays:function(){_.each(this.desktopOverlays,function(a){var b=this.$el.find("."+a);b.removeClass("inactive"),b.find(".form_switch").removeClass("inactive")},this)},_disableDesktopOverlays:function(){_.each(this.desktopOverlays,function(a){var b=this.$el.find("."+a);b.addClass("inactive"),b.find(".form_switch").addClass("inactive")},this)},_onChangeDevice:function(){var a=this.options.canvas.get("mode");"mobile"===a?this._disableDesktopOverlays():this._enableDesktopOverlays()},_setupOptions:function(){var a=this,b=this.collection.models,c=["search","shareable","zoom","share","fullscreen","layer_selector","logo"];this.mapOptions.set({scrollwheel:!!this.options.vis.map.get("scrollwheel")}),this.mapOptions.set({legends:!!this.options.vis.map.get("legends")}),_.each(c,function(b){_.contains(a.collection.pluck("type"),b)||a.mapOptions.set(b,!1)}),_.each(b,function(b){var d=b.get("extra"),e=b.get("type");if("header"===e){var f=d.show_title,g=d.show_description;a.mapOptions.set({title:f,description:g}),f&&a.$el.find(".title").removeClass("disabled"),g&&a.$el.find(".description").removeClass("disabled")}else if(_.contains(c,e)){var h=b.get("display");a.mapOptions.set(e,h),h&&a.$el.find("."+e).removeClass("disabled")}})},_handleClick:function(a){a&&(a.preventDefault(),a.stopPropagation()),this.isOpen?this.hide():this.open()},show:function(){var a=$.Deferred(),b=this;return this.delegateEvents(),this.$el.css({marginTop:"down"==b.options.vertical_position?"-10px":"10px",opacity:0,display:"block"}).animate({margin:"0",opacity:1},{duration:this.options.speedIn,complete:function(){a.resolve()}}),this.trigger("onDropdownShown",this.el),a.promise()},open:function(a,b){var c=b&&$(b)||this.options.target;this.options.target=c,this.$el.css({bottom:40,left:this.options.horizontal_offset}).addClass(("up"==this.options.vertical_position?"vertical_top":"vertical_bottom")+" "+("right"==this.options.horizontal_position?"horizontal_right":"horizontal_left")+" border tick_"+this.options.tick),this.show(),this._recalcHeight(),this.isOpen=!0},hide:function(a){if(!this.isOpen)return void(a&&a());var b=this;this.isOpen=!1,this.$el.animate({marginTop:"down"==b.options.vertical_position?"10px":"-10px",opacity:0},this.options.speedOut,function(){
b.$el.hide()}),this.trigger("onDropdownHidden",this.el)},_recalcHeight:function(){var a=this.$el.find("ul.special");a.height("auto"),a.parent().height("auto");var b=a.height(),c=a.parent().height();c>b?a.css("height",c):a.parent().height(b)},_addSwitches:function(a){_(a).each(this._addSwitch,this)},_addSwitch:function(a){var b="."+a,c=new cdb.forms.Switch({model:this.mapOptions,property:a}).bind("switched",this._onSwitchSwitched,this);this._renderSwitch(c,b),this.mapOptions.attributes[a]||this.$(b)},_renderSwitch:function(a,b){this.addView(a),this.$("li"+b).append(a.render().el)},_onSwitchSwitched:function(a,b){if("scrollwheel"===a)b?this.options.vis.map.enableScrollWheel():this.options.vis.map.disableScrollWheel(),this.options.vis.map.save(),this.options.table.globalError.showError("Scrollwheel "+(b?"enabled":"disabled"),"info",3e3);else if("legends"===a)this.options.vis.map.set(a,b),this.options.vis.map.save(),this.options.table.globalError.showError("Legends "+(b?"enabled":"disabled"),"info",3e3);else if("zoom"===a||"search"===a||"fullscreen"===a||"share"===a||"layer_selector"===a||"logo"===a)this._toggleOverlay(a);else if("title"===a||"description"===a){var c=this.collection.filter(function(a){return"header"==a.get("type")})[0];if(!c)return void this.trigger("createOverlay","header",a);var d=this.mapOptions.get(a);c.set("show_"+a,d),c.save(),(!c.get("show_title")&&!c.get("show_description")||!c.get("show_title")&&!c.get("description"))&&this.options.collection.remove(c)}b?this.$("li."+a).removeClass("disabled"):this.$("li."+a)},_toggleOverlay:function(a){var b=this.collection.filter(function(b){return b.get("type")===a})[0];b?this.options.collection.remove(b):b||this.trigger("createOverlay",a)},render:function(){var a=["title","description","search","zoom","fullscreen","share","scrollwheel","layer_selector","legends"];return this.clearSubViews(),this.$el.html(this.template_base(this.options)),this.options.user.get("actions").remove_logo?a.push("logo"):this.$(".logo").remove(),this._addSwitches(a),_.each(this.mapOptions.attributes,function(a,b){var c=this.$el.find("li."+b);c.find("a").hasClass("enabled")?c.addClass("active"):c.removeClass("active")},this),this},clean:function(){$(document).unbind("keydown",this._keydown),cdb.ui.common.Dropdown.prototype.clean.call(this)}}),cdb.admin.LeafletMapView=cdb.geo.LeafletMapView.extend(GrouperLayerMapView(cdb.geo.LeafletMapView)),"undefined"!=typeof google&&(cdb.admin.GoogleMapsMapView=cdb.geo.GoogleMapsMapView.extend(GrouperLayerMapView(cdb.geo.GoogleMapsMapView))),cdb.admin.MapTab=cdb.core.View.extend({events:{"click .toggle_slides.button":"_toggleSlides","click .add_overlay.button":"killEvent","click .canvas_setup.button":"killEvent","click .export_image.button":"_exportImage","click .sqlview .clearview":"_clearView","click .sqlview .export_query":"_tableFromQuery"},_TEXTS:{no_interaction_warn:_t("Map interaction is disabled, select cartodb_id to enable it")},className:"map",animation_time:300,initialize:function(){this.template=this.getTemplate("table/views/maptab"),this.map=this.model,this.user=this.options.user,this.vis=this.options.vis,this.master_vis=this.options.master_vis,this.canvas=new cdb.core.Model({mode:"desktop"}),this.map_enabled=!1,this.georeferenced=!1,this.featureHovered=null,this.activeLayerView=null,this.layerDataView=null,this.layerModel=null,this.legends=[],this.overlays=null,this.add_related_model(this.map),this.add_related_model(this.canvas),this.add_related_model(this.map.layers),this._addBindings()},_addBindings:function(){cdb.god.bind("panel_action",function(a){this._moveInfo(a)},this),this.add_related_model(cdb.god),this.map.bind("change:provider",this.switchMapType,this),this.map.layers.bind("change:visible",this._addLegends,this),this.map.layers.bind("change:visible",this._addTimeline,this),this.map.layers.bind("change:tile_style",this._addTimeline,this),this.map.layers.bind("remove reset",this._addLegends,this),this.map.layers.bind("remove reset",this._addTimeline,this),_.bindAll(this,"showNoGeoRefWarning","_exportImage")},isMapEnabled:function(){return this.map_enabled},deactivated:function(){this.map_enabled&&this.clearMap()},clearMap:function(){clearTimeout(this.autoSaveBoundsTimer),this.mapView.clean(),this.overlaysDropdown&&this.overlaysDropdown.clean(),this.mapOptionsDropdown&&this.mapOptionsDropdown.clean(),this.basemapDropdown&&this.basemapDropdown.clean(),this.configureCanvasDropdown&&this.configureCanvasDropdown.clean(),this.zoom&&this.zoom.clean(),this.infowindow&&this.infowindow.clean(),this.overlays&&this.overlays._cleanOverlays(),this._cleanLegends(),this.stackedLegend&&this.stackedLegend.clean(),this.timeline&&(this.timeline.clean(),this.timeline=null),this.geometryEditor&&this.geometryEditor.clean(),this.table&&this.table.unbind(null,null,this),delete this.mapView,delete this.overlaysDropdown,delete this.basemapDropdown,delete this.mapOptionsDropdown,delete this.configureCanvasDropdown,delete this.zoom,delete this.infowindow,delete this.layer_selector,delete this.header,delete this.share,delete this.legends,delete this.overlays,delete this.legend,delete this.stackedLegend,delete this.geometryEditor,this.map_enabled=!1,this.render()},_hideInfowindow:function(){this.infowindow&&this.infowindow.model.set("visibility",!1)},switchMapType:function(){this.map_enabled&&(this.clearMap(),this.enableMap())},_showGMapsDeprecationDialog:function(){var a=this,b=new cdb.admin.BaseDialog({$el:$("body"),width:600,modal_type:"confirmation warning",template_name:"table/views/gmaps_deprecation_dialog",title:"We are removing the support for Google Maps",description:"Since this visualization uses a Google Maps basemap, if you click 'Ok' we'll automatically change your basemap to an equivalent one provided by Leaflet. Click 'cancel' to go back to your dashboard without changing anything.<br /><br />If you have any questions regarding this change, please contact us at <a href='mailto:support@cartodb.com'>support@cartodb.com</a>",ok_title:"Ok, continue",cancel_button_classes:"margin15"});b.ok=function(){a.map.set("provider","leaflet",{silent:!0}),a.setupMap()},b.cancel=function(){a.user.isInsideOrg()?window.location="/u/"+a.user.get("username")+"/dashboard":window.location="/dashboard"},this.$el.parent().append(b.render().el),b.open()},enableMap:function(){this.render();var a=this.map.getBaseLayer();return"undefined"==typeof cdb.admin.GoogleMapsMapView&&a&&this.map.isProviderGmaps()?void this._showGMapsDeprecationDialog():void this.setupMap()},setupMap:function(){this.$(".tipsy").remove();var a=this;if(!this.map_enabled){this._addMapView(),this.clickTimeout=null,this._bindMissingClickEvents(),this.map_enabled=!0,$(".map").append('<div class="map-options" />').append("<div class='mobile_bkg' />"),this._addBasemapDropdown(),this._addInfowindow(),this._addTooltip(),this._addLegends(),this._addOverlays(),this._showScratchDialog(),this.user.featureEnabled("slides")&&this._addSlides();var b=this.vis.get("type");"table"!==b&&(this._addOverlaysDropdown(),this._addConfigureCanvasDropdown(),this._addMapOptionsDropdown(),this.canvas.on("change:mode",this._onChangeCanvasMode,this)),this.master_vis.on("change:type",function(){"table"===this.master_vis.previous("type")&&this.switchMapType()},this),this.autoSaveBoundsTimer=setTimeout(function(){a.mapView.on("dragend zoomend",function(){a.mapView._saveLocation()})},1e3)}},_addMapView:function(){var a=this.$(".cartodb-map"),b=cdb.admin.LeafletMapView;if("googlemaps"===this.map.get("provider"))var b=cdb.admin.GoogleMapsMapView;var c=this.map.get("legends");c?this.$el.removeClass("hide_legends"):this.$el.addClass("hide_legends"),this.map.bind("change:legends",function(){var a=this.map.get("legends");a?this.$el.removeClass("hide_legends"):this.$el.addClass("hide_legends")},this),this.mapView=new b({el:a,map:this.map,user:this.user}),this.mapView.bind("removeLayerView",function(a){this.layer_selector&&this.layer_selector.render()},this),this.mapView.bind("newLayerView",function(a,b){this.activeLayerView&&this.activeLayerView.model.id===b.id&&(this._bindDataLayer(this.activeLayerView,b),this.layer_selector&&this.layer_selector.render()),this._addTimeline()},this),this.activeLayerView&&this._bindDataLayer(this.activeLayerView,this.activeLayerView.model)},_addConfigureCanvasDropdown:function(){this.configureCanvasDropdown||(this.configureCanvasDropdown=new cdb.admin.ConfigureCanvasDropdown({target:$(".canvas_setup"),position:"position",canvas:this.canvas,template_base:"table/views/canvas_setup_dropdown",tick:"left",horizontal_position:"left",horizontal_offset:"40px"}),this.addView(this.configureCanvasDropdown),cdb.god.bind("closeDialogs",this.configureCanvasDropdown.hide,this.configureCanvasDropdown),$(".canvas_setup").append(this.configureCanvasDropdown.render().el))},_addOverlaysDropdown:function(){this.overlaysDropdown||(this.overlaysDropdown=new cdb.admin.OverlaysDropdown({vis:this.master_vis,canvas:this.canvas,mapView:this.mapView,target:$(".add_overlay"),position:"position",collection:this.vis.overlays,template_base:"table/views/widget_dropdown",tick:"left",horizontal_position:"left",horizontal_offset:"40px"}),this.addView(this.overlaysDropdown),this.overlaysDropdown.bind("onOverlayDropdownOpen",function(){this.slidesPanel&&this.slidesPanel.hide()},this),cdb.god.bind("closeDialogs",this.overlaysDropdown.hide,this.overlaysDropdown),cdb.god.bind("closeOverlayDropdown",this.overlaysDropdown.hide,this.overlaysDropdown),$(".add_overlay").append(this.overlaysDropdown.render().el))},_addBasemapDropdown:function(){if(!this.basemapDropdown){if("table"!==this.vis.get("type")){var a=$('<a href="#" class="option-button dropdown basemap_dropdown"><div class="thumb"></div>Change basemap</a>');$(".map-options").append(a)}this.basemapDropdown=new cdb.admin.DropdownBasemap({target:$(".basemap_dropdown"),position:"position",template_base:"table/views/basemap/basemap_dropdown",model:this.map,mapview:this.mapView,user:this.user,baseLayers:this.options.baseLayers,tick:"left",vertical_offset:40,horizontal_position:"left",vertical_position:"table"===this.vis.get("type")?"down":"up",horizontal_offset:"table"===this.vis.get("type")?42:0}),this.addView(this.basemapDropdown),this.basemapDropdown.bind("onDropdownShown",function(){cdb.god.trigger("closeDialogs")}),cdb.god.bind("closeDialogs",this.basemapDropdown.hide,this.basemapDropdown),$(".basemap_dropdown").append(this.basemapDropdown.render().el)}this.map.getBaseLayer()&&this.basemapDropdown.setActiveBaselayer()},bindGeoRefCheck:function(){this.table.data().fetched?this.checkGeoRef():this.table.bind("dataLoaded",function(){this.checkGeoRef(),this.scratchDialog||this._showScratchDialog()},this)},activated:function(){this.checkGeoRef(),$(window).scrollTop(0)},checkGeoRef:function(){this.options&&this.table&&(this.georeferenced=this.table.isGeoreferenced(),this.georeferenced?this.noGeoRefDialog&&this.noGeoRefDialog.hide():this.table.data().length>0&&this.showNoGeoRefWarning())},_showScratchDialog:function(){if(this.user.featureEnabled("new_modals")&&this.options.table&&this.options.table.data().fetched&&0===this.options.table.data().length){var a="scratchDialog_"+this.options.table.id+"_"+this.options.table.get("map_id");localStorage[a]||(this.scratchDialog=new cdb.editor.ScratchView({table:this.options.table}),this.scratchDialog.appendToBody(),this.scratchDialog.bind("newGeometry",function(a){this._addGeometry(a)},this),this.scratchDialog.bind("skip",function(){localStorage[a]=!0}))}},_bindMissingClickEvents:function(){var a=this;this.mapView.bind("click",function(b){null===a.clickTimeout&&(a.clickTimeout=setTimeout(function(){a.clickTimeout=null,a.featureHovered||a.trigger("missingClick")},150)),!a.featureHovered&&b.preventDefault&&(b.preventDefault(),b.stopPropagation())}),this.mapView.bind("dblclick",function(){null!==a.clickTimeout&&(clearTimeout(a.clickTimeout),a.clickTimeout=null)})},setActiveLayer:function(a){if(this.activeLayerView=a,this.mapView&&this.mapView.getLayerByCid(a.model.cid)){var b=a.model;this._bindDataLayer(a,b)}},_bindDataLayer:function(a,b){var c=this,d=b.get("type");("CartoDB"===d||"torque"===d)&&(c.layerDataView&&c.layerDataView.unbind(null,null,this),c.layerModel&&c.layerModel.unbind(null,null,this),c.options.geocoder&&c.options.geocoder.unbind(null,null,this),c.infowindowModel=b.infowindow,c.tooltipModel=b.tooltip,c.legendModel=b.legend,c._bindTable(b.table),c._bindSQLView(b.sqlView),c.layerDataView=c.mapView.getLayerByCid(b.cid),c.mapView.setActiveLayer(b),c._addLegends(),c._addTimeline(),c.layerDataView&&(c.layerDataView.bind("featureClick",c.featureClick,c),c.layerDataView.bind("featureOut",c.featureOut,c),c.layerDataView.bind("featureOver",c.featureOver,c),c.layerDataView.bind("loading",c.loadingTiles,c),c.layerDataView.bind("load",c.loadTiles,c),c.layerDataView.bind("error",c.loadTiles,c),c.tooltip.setLayer(c.layerDataView).enable()),a&&b&&(b.unbind("startEdition",this._addGeometry,this),b.bind("startEdition",this._addGeometry,this)),b&&(c.layerModel=b,b.bind("change:interactivity",this._updateSQLHeader,this),this._updateSQLHeader()),c.options.geocoder&&(c.options.geocoder.bind("geocodingComplete geocodingError geocodingCanceled",this.updateDataLayerView,this),c.add_related_model(c.options.geocoder)))},_cleanLegends:function(){this.legends&&_.each(this.legends,function(a){a.clean()}),this.legends=[]},_getCartoDBLayers:function(){return this.map.layers.models.filter(function(a){return"CartoDB"===a.get("type")})},_onChangeCanvasMode:function(){var a=this;cdb.god.trigger("closeDialogs");var b=this.canvas.get("mode");"desktop"===b?(this._showDesktopCanvas(b),this.overlays.loader&&this.overlays.fullscreen&&setTimeout(function(){a.overlays&&a.overlays._positionOverlaysVertically(!0)},500)):"mobile"===b&&(this._showMobileCanvas(b),setTimeout(function(){a.overlays&&a.overlays._positionOverlaysVertically(!0)},300))},_showMobileCanvas:function(a){var b=this,c=288,d=476;this.overlays._hideOverlays("desktop");var e=$("div.map div.cartodb-map");this.$el.addClass(a);var f=function(){e.animate({width:c,marginLeft:-Math.round(c/2)-1,left:"50%"},{easing:"easeOutQuad",duration:200,complete:h})},g=function(){b.$el.find(".mobile_bkg").animate({opacity:1},{duration:250}),b.overlays._showOverlays(a);var c=b.map.get("center");b.mapView.invalidateSize(),e.fadeOut(250),setTimeout(function(){b.mapView.map.setCenter(c),e.fadeIn(250)},300)},h=function(){e.animate({height:d,marginTop:-Math.round(d/2)+23,top:"50%"},{easing:"easeOutQuad",duration:200,complete:g})};f(),this._enableAnimatedMap(),this._enableMobileLayout()},_enableMobileLayout:function(){if(this.mobile)this.mobile.show();else{this.mobile=new cdb.admin.overlays.Mobile({mapView:this.mapView,overlays:this.overlays,map:this.map}),this.mapView.$el.append(this.mobile.render().$el)}},_disableMobileLayout:function(){this.mobile&&this.mobile.hide()},_showDesktopCanvas:function(a){var b=this;this.overlays._hideOverlays("mobile"),this.$el.removeClass("mobile"),this.$el.find(".mobile_bkg").animate({opacity:0},250);var c=$("div.map div.cartodb-map"),d=c.css("top"),e=c.css("left"),f=c.css("marginTop"),g=c.css("marginLeft"),h=c.width(),i=c.height(),j=c.css({width:"auto",marginLeft:0,left:"15px"}).width();autoHeight=c.css({height:"auto",marginTop:0,top:"82px"}).height(),c.height(i),c.width(h),c.css({top:d,left:e,marginLeft:g,marginTop:f,height:i,width:h});var k=function(){c.css("width","auto"),b.overlays._showOverlays(a);var d=b.map.get("center");b.mapView.invalidateSize(),setTimeout(function(){b.mapView.map.setCenter(d)},300)},l=function(){c.css("height","auto"),c.animate({width:j,left:"15px",marginLeft:"0"},{easing:"easeOutQuad",duration:200,complete:k})},m=function(){c.animate({height:autoHeight,top:"82",marginTop:"0"},{easing:"easeOutQuad",duration:200,complete:l})};m(),this._disableAnimatedMap(),this._disableMobileLayout()},_enableAnimatedMap:function(){var a=this;setTimeout(function(){a.$el.addClass("animated")},800)},_disableAnimatedMap:function(){this.$el.removeClass("animated")},_addMapOptionsDropdown:function(){if(!this.mapOptionsDropdown){var a=$("<a href='#show-options' class='option-button show-table-options'>Options</a>");this.$options=a,$(".map-options").append(a),this.mapOptionsDropdown=new cdb.admin.MapOptionsDropdown({target:$(".show-table-options"),template_base:"table/views/map_options_dropdown",table:table,model:this.map,mapview:this.mapView,collection:this.vis.overlays,user:this.user,vis:this.vis,canvas:this.canvas,position:"position",tick:"left",vertical_position:"up",horizontal_position:"left",horizontal_offset:"-3px"}),this._bindMapOptions(),this.addView(this.mapOptionsDropdown),$(".show-table-options").append(this.mapOptionsDropdown.render().el)}},_bindMapOptions:function(){var a=this;this.mapOptionsDropdown.bind("onDropdownShown",function(){cdb.god.trigger("closeDialogs"),a.$options.addClass("open")},this),this.mapOptionsDropdown.bind("onDropdownHidden",function(){a.$options.removeClass("open")},this),this.mapOptionsDropdown.bind("createOverlay",function(a,b){this.vis.overlays.createOverlayByType(a,b)},this),cdb.god.bind("closeDialogs",this.mapOptionsDropdown.hide,this.mapOptionsDropdown)},_addOverlays:function(){this.overlays=new cdb.admin.MapOverlays({headerMessageIsVisible:this._shouldAddSQLViewHeader(),vis:this.vis,canvas:this.canvas,mapView:this.mapView,master_vis:this.master_vis,mapToolbar:this.$el.find(".map_toolbar")})},_exportImage:function(){var a=new cdb.admin.StaticImageDialog({vizjson:this.vis.vizjsonURL(),attribution:this.vis.map.get("attribution").join(" "),width:this.mapView.$el.width(),height:this.mapView.$el.height(),privacy:this.vis.get("privacy"),user:this.user});a.appendToBody(),a.open({center:!0})},_addSlides:function(){this.vis.isVisualization()&&(this.slidesPanel=new cdb.admin.SlidesPanel({slides:this.vis.slides,toggle:this.$el.find(".toggle_slides")}),this.$el.append(this.slidesPanel.render().el),this.addView(this.slidesPanel))},_addLegends:function(){var a=this;this._cleanLegends();for(var b=this.map.layers.models,c=b.length-1;c>=0;--c){var d=b[c];a._addLegend(d)}},_addLegend:function(a){var b=a.get("type");if(("CartoDB"===b||"torque"===b)&&this.table&&this.mapView&&(this.legend&&this.legend.clean(),a.get("visible"))){var c=new cdb.geo.ui.Legend({model:a.legend,mapView:this.mapView,table:this.table});this.legends&&(this.legends.push(c),this._renderStackedLengeds())}},_addTimeline:function(){if(this.mapView)if(this.map.layers.any(function(a){return"torque"===a.get("type")&&a.get("visible")})){var a=this.map.layers.getLayersByType("torque")[0],b=a.wizard_properties.get("torque-frame-count");this.timeline&&this.timeline.torqueLayer.model.cid!==a.cid&&(this.timeline.clean(),this.timeline=null),layerView=this.mapView.getLayerByCid(a.cid),layerView&&"undefined"!=typeof layerView.getStep&&b>1?this.timeline?this.timeline.setLayer(layerView):(this.timeline=new cdb.geo.ui.TimeSlider({layer:layerView,width:"auto"}),this.mapView.$el.append(this.timeline.render().$el),this.addView(this.timeline)):this.timeline&&(this.timeline.clean(),this.timeline=null)}else this.timeline&&this.timeline.clean(),this.timeline=null},_renderStackedLengeds:function(){this.stackedLegend&&this.stackedLegend.clean(),this.legend&&this.legend.clean(),this.stackedLegend=new cdb.geo.ui.StackedLegend({legends:this.legends}),this.mapView.$el.append(this.stackedLegend.render().$el),this.addView(this.stackedLegend)},_renderLegend:function(){this.legend&&this.legend.clean(),this.legend=this.legends[0],this.mapView.$el.append(this.legend.render().$el),this.legend.model.get("type")?this.legend.show():this.legend.hide(),this.addView(this.legend)},_addTooltip:function(){this.tooltip&&this.tooltip.clean(),this.table&&this.mapView&&(this.tooltip=new cdb.admin.Tooltip({model:this.tooltipModel,table:this.table,mapView:this.mapView,omit_columns:["cartodb_id"]}),this.mapView.$el.append(this.tooltip.render().el),this.tooltip.bind("editData",this._editData,this),this.tooltip.bind("removeGeom",this._removeGeom,this),this.tooltip.bind("editGeom",this._editGeom,this),this.layerDataView&&this.tooltip.setLayer(this.layerDataView).enable())},_addInfowindow:function(){if(this.infowindow&&this.infowindow.clean(),this.table&&this.mapView){this.infowindow=new cdb.admin.MapInfowindow({model:this.infowindowModel,mapView:this.mapView,table:this.table}),this.mapView.$el.append(this.infowindow.el),this.geometryEditor&&(this.geometryEditor.discard(),this.geometryEditor.clean()),this.geometryEditor=new cdb.admin.GeometryEditor({model:this.table}),this.geometryEditor.mapView=this.mapView,this.mapView.$el.append(this.geometryEditor.render().el),this.geometryEditor.hide(),this.geometryEditor.bind("editStart",this.hideDataLayer,this),this.geometryEditor.bind("editDiscard",this.showDataLayer,this),this.geometryEditor.bind("editFinish",this.showDataLayer,this),this.geometryEditor.bind("editFinish",this.updateDataLayerView,this),this.geometryEditor.bind("geomCreated",function(a){this.table.data().add(a)},this);this.infowindow.bind("editData",this._editData,this),this.infowindow.bind("removeGeom",this._removeGeom,this),this.infowindow.bind("editGeom",this._editGeom,this),this.infowindow.bind("openInfowindowPanel",function(){this.activeLayerView.showModule("infowindow","fields")},this),this.infowindow.bind("close",function(){this.tooltip&&this.tooltip.setFilter(null)},this),this.table.bind("remove:row",this.updateDataLayerView,this),this.table.bind("change:dataSource",function(){this.geometryEditor&&this.geometryEditor.discard()},this),this.map.bind("change:provider",function(){this.geometryEditor&&this.geometryEditor.discard()},this)}},_editGeom:function(a){"leaflet"===this.map.get("provider")&&this.map.clamp(),this.geometryEditor.editGeom(a)},_editData:function(a){var b=this;return this.table.isReadOnly()?void 0:(a.fetch({cache:!1,no_geom:!0,success:function(){var c;c=b.user.featureEnabled("new_modals")?new cdb.editor.FeatureDataView({row:a,provider:b.map.get("provider"),baseLayer:b.map.getBaseLayer().clone(),dataLayer:b.layerModel.clone(),currentZoom:b.map.getZoom(),enter_to_confirm:!1,table:b.table,user:b.user,clean_on_hide:!0,onDone:function(){b.updateDataLayerView()}}):new cdb.admin.EditFeatureFields({model:a,table:b.table,res:function(c){b.table.notice("Saving ... ","load"),$.when(a.save(c)).done(function(a){b.table.trigger("data:saved"),b.table.notice("Saved","info",5e3)}).fail(function(){b.table.notice("Something has failed","error",5e3)})}}),c.appendToBody().open({center:!0})}}),!1)},_removeGeom:function(a){if(!this.table.isReadOnly()){var b=this,c=new cdb.admin.BaseDialog({title:"Delete feature",description:"Are you sure you want to delete this feature and all its associated data?",template_name:"old_common/views/confirm_dialog",clean_on_hide:!0,enter_to_confirm:!0,ok_button_classes:"right button grey",ok_title:"Yes, do it",cancel_button_classes:"underline margin15",cancel_title:"Cancel",modal_type:"confirmation",width:500});return c.ok=function(){b.table.trigger("removing:row"),b.model.set("visibility",!1),a.destroy({success:function(){b.table.trigger("remove:row",a)}},{wait:!0})},c.appendToBody().open(),!1}},_addGeometry:function(a){this.geometryEditor.createGeom(this.table.data().newRow(),a)},_bindTable:function(a){this.table&&this.table.unbind(null,null,this),this.table=a,this.table.bind("change:dataSource",this._hideInfowindow,this),this.table.bind("change:dataSource",this._updateSQLHeader,this),this.table.bind("change:schema",this._updateSQLHeader,this),this.table.bind("data:saved",function(){this.updateDataLayerView()},this),this._addInfowindow(),this._addLegends(),this._addTooltip(),this.bindGeoRefCheck()},_bindSQLView:function(a){this.sqlView&&this.sqlView.unbind(null,null,this),this.sqlView=a,this.sqlView.bind("reset error",this._updateSQLHeader,this),this.sqlView.bind("loading",this._renderLoading,this),this._updateSQLHeader()},_renderLoading:function(a){this._removeSQLViewHeader(),$(".table_panel").length>0&&(panel_opened=0==$(".table_panel").css("right").replace("px",""));var b=this.getTemplate("table/views/sql_view_notice_loading")({panel_opened:panel_opened});this.overlays&&this.overlays.setHeaderMessageIsVisible(!0),this.$(".cartodb-map").after(b)},_updateSQLHeader:function(){this._shouldAddSQLViewHeader()?this._addSQLViewHeader():this._removeSQLViewHeader()},_shouldAddSQLViewHeader:function(){return this.table&&this.table.isInSQLView()},loadingTiles:function(){this.overlays.loader&&this.overlays.loader.show()},loadTiles:function(){this.overlays.loader&&this.overlays.loader.hide()},featureOver:function(a,b,c,d){this.infowindowModel.get("disabled")||(this.mapView.setCursor("pointer"),this.featureHovered=d)},featureOut:function(){this.infowindowModel.get("disabled")||(this.mapView.setCursor("auto"),this.featureHovered=null)},featureClick:function(a,b,c,d){this.infowindowModel.get("disabled")||this.geometryEditor.isEditing()||(d.cartodb_id?(this.infowindow.setLatLng(b).setFeatureInfo(d.cartodb_id).showInfowindow(),this.tooltip.setFilter(function(a){return a.cartodb_id!==d.cartodb_id}).hide()):cdb.log.error("can't show infowindow, no cartodb_id on data"))},_moveInfo:function(a){"show"===a?this.$el.removeClass("narrow").addClass("displaced"):"hide"===a?this.$el.removeClass("narrow displaced"):"narrow"===a&&this.$el.addClass("narrow displaced")},render:function(){this.$el.html(""),this.$el.removeClass("mobile").removeClass("derived").removeClass("table"),this.$el.addClass(this.vis.isVisualization()?"derived":"table");this.map.get("provider");return this.$el.append(this.template({slides_enabled:this.user.featureEnabled("slides"),type:this.vis.get("type"),exportEnabled:!this.map.isProviderGmaps()})),this},showDataLayer:function(){this.mapView.enableInteraction(),this.layerDataView.setOpacity&&this.layerDataView.setOpacity(1)},hideDataLayer:function(){this.mapView.disableInteraction(),this.layerDataView.setOpacity&&this.layerDataView.setOpacity(.5)},updateDataLayerView:function(){this.layerDataView&&this.layerDataView.invalidate()},showNoGeoRefWarning:function(){var a="georefNoContentWarningShowed_"+this.table.id+"_"+this.table.get("map_id");this.noGeoRefDialog||this.table.isInSQLView()||localStorage[a]||(localStorage[a]=!0,this.noGeoRefDialog=new cdb.admin.NoGeoRefDataDialog({model:this.table,user:this.user,geocoder:this.options.geocoder}),this.noGeoRefDialog.appendToBody(),this.noGeoRefDialog.open({center:!0}))},_addSQLViewHeader:function(){this.$(".sqlview").remove();var a=this.table.data().size(),b=null;this.layerModel&&!this.layerModel.get("interactivity")&&this.layerModel.wizard_properties.supportsInteractivity()&&(b=this._TEXTS.no_interaction_warn),this.layerModel&&!this.layerModel.table.containsColumn("the_geom_webmercator")&&(b=_t("the_geom_webmercator column should be selected"));var c=this.getTemplate("table/views/sql_view_notice")({empty:!a,isVisualization:this.vis.isVisualization(),warnMsg:b});this.$(".cartodb-map").after(c),this.overlays&&this.overlays.setHeaderMessageIsVisible(!0)},_removeSQLViewHeader:function(){this.$(".sqlview").remove(),this.overlays&&this.overlays.setHeaderMessageIsVisible(!1)},_toggleSlides:function(a){this.killEvent(a),this.slidesPanel&&this.slidesPanel.toggle()},_clearView:function(a){return this.killEvent(a),this.activeLayerView.model.clearSQLView(),!1},_tableFromQuery:function(a){this.killEvent(a);var b;b=this.user.featureEnabled("new_modals")?new cdb.editor.DuplicateDatasetView({model:this.table,user:this.user,clean_on_hide:!0}):new cdb.admin.DuplicateTableDialog({model:this.table}),b.appendToBody().open()}}),function(){cdb.admin.forms={};var a=function(a){return JSON.parse(JSON.stringify(a))};cdb.admin.forms.get=function(b){return a(cdb.admin.forms[b])};var b={name:"Polygon Stroke",form:{"line-width":{type:"width",value:.5},"line-color":{type:"color",value:"#FFF"},"line-opacity":{type:"opacity",value:1}}},c={name:"LineStroke",form:{"line-width":{type:"width",value:2},"line-color":{type:"color",value:"#FF6600"},"line-opacity":{type:"opacity",value:.7}}},d={name:"LineStroke",form:{"line-width":{type:"width",value:1},"line-color":{type:"hidden",value:"#FF6600"},"line-opacity":{type:"opacity",value:.8}}},e={name:"Polygon Fill",form:{"polygon-fill":{type:"color",value:"#FF6600",extra:{image_property:"polygon-pattern-file",image_kind:"pattern"}},"polygon-opacity":{type:"opacity_polygon",value:.7}}},f={name:"Label Text",className:"label_text",form:{"text-name":{type:"select",value:"None",extra:[],columns:"string|number",extra_default:["None"]}}},g={name:"Label Font",className:"label_text_properties",form:{"text-face-name":{type:"select",value:"DejaVu Sans Book",extra:["DejaVu Sans Book","unifont Medium","Open Sans Regular","Lato Regular","Lato Bold","Lato Bold Italic","Graduate Regular","Gravitas One Regular","Old Standard TT Regular","Old Standard TT Italic","Old Standard TT Bold"]},"text-size":{type:"number",value:10,min:1,max:50},"text-fill":{type:"color",value:"#000"}}},h={name:"Label Overlap",className:"text_allow_overlap",form:{"text-allow-overlap":{type:"select",value:!0,extra:[!0,!1]},"text-placement-type":{type:"hidden",value:"dummy"},"text-label-position-tolerance":{type:"hidden",value:0}}},i={name:"Label Placement",className:"label_placement",form:{"text-placement":{type:"select",value:"point",extra:["point","line","vertex","interior"]}}},j={name:"Label Offset",className:"label_text_offset",form:{"text-dy":{type:"number",value:-10,min:-30,max:30}}},k={name:"Label Halo",className:"label_halo_properties",form:{"text-halo-fill":{type:"color",value:"#FFF"},"text-halo-radius":{type:"number",value:1,min:0,max:10,inc:.5}}},l={name:"Marker Fill",form:{"marker-width":{type:"width",value:10},"marker-fill":{type:"color",value:"#FF6600",extra:{image_property:"marker-file"}},"marker-opacity":{type:"opacity",value:.9},"marker-allow-overlap":{type:"hidden",value:!0},"marker-placement":{type:"hidden",value:"point"},"marker-type":{type:"hidden",value:"ellipse"}}},m={name:"Marker Stroke",form:{"marker-line-width":{type:"width",value:1.5},"marker-line-color":{type:"color",value:"#FFF"},"marker-line-opacity":{type:"opacity",value:1}}},n=["None","multiply","screen","overlay","darken","lighten","color-dodge","color-burn"],o="none",p={name:"Composite operation",form:{"polygon-comp-op":{type:"select",value:o,extra:n}}},q={name:"Composite operation",form:{"line-comp-op":{type:"select",value:o,extra:n}}},r={name:"Composite operation",form:{"marker-comp-op":{type:"select",value:o,extra:n}}};cdb.admin.forms.polygon={polygon:[e,b,p,f,g,k,j,h,i],point:[l,m,r,f,g,k,j,h,i],line:[c,q,f,g,k,j,h,i]};var s={name:"Column",form:{property:{type:"select",columns:"number|string|boolean"}}},t={name:"Column",form:{property:{type:"select",columns:"number"}}},u={name:"Category Column",form:{property_cat:{type:"select",columns:"number|string|boolean"}}},v={name:"Time Column",form:{property:{type:"select",columns:"number|date",extra_default:["cartodb_id"],default_column:"date"}}},w={name:"Column",form:{property:{type:"select",columns:"number|string"}}},x={name:"Buckets",form:{method:{type:"select",value:"7 Buckets",extra:["3 Buckets","5 Buckets","7 Buckets"]}}},y={name:"Quantification",form:{qfunction:{type:"select",value:"Quantile",extra:["Jenks","Equal Interval","Heads/Tails","Quantile"]}}},z={name:"Color Ramp",form:{color_ramp:{type:"select",value:"red",extra:["pink","red","black","green","blue","inverted_pink","inverted_red","inverted_black","inverted_green","inverted_blue","spectrum1","spectrum2","blue_states","purple_states","red_states","inverted_blue_states","inverted_purple_states","inverted_red_states"]},"line-opacity":{type:"opacity",value:.8}}},A={name:"Color Ramp",form:{color_ramp:{type:"select",value:"red",extra:["pink","red","black","green","blue","inverted_pink","inverted_red","inverted_black","inverted_green","inverted_blue","spectrum1","spectrum2","blue_states","purple_states","red_states","inverted_blue_states","inverted_purple_states","inverted_red_states"]
},"polygon-opacity":{type:"opacity",value:.8}}},B={name:"Color Ramp",form:{color_ramp:{type:"select",value:"red",extra:["pink","red","black","green","blue","inverted_pink","inverted_red","inverted_black","inverted_green","inverted_blue","spectrum1","spectrum2","blue_states","purple_states","red_states","inverted_blue_states","inverted_purple_states","inverted_red_states"]},"marker-opacity":{type:"opacity",value:.8}}},C=[t,y,{name:"Radius",title:"Radius (min-max)",form:{radius_min:{type:"number",value:10,min:0,max:100},radius_max:{type:"number",value:25,min:0,max:100}},text:"- to -"},{name:"Bubble fill",form:{"marker-fill":{type:"color",value:"#FF5C00"},"marker-opacity":{type:"opacity",value:.9}}},{name:"Bubble stroke",form:{"marker-line-width":{type:"number",value:1.5,min:0,max:100,inc:.5},"marker-line-color":{type:"color",value:"#FFF"},"marker-line-opacity":{type:"opacity",value:1}}},r];cdb.admin.forms.intensity={point:[{name:"Marker Fill",form:{"marker-width":{type:"width",value:10},"marker-fill":{type:"color",value:"#FFCC00"},"marker-opacity":{type:"opacity",value:.9},"marker-allow-overlap":{type:"hidden",value:!0},"marker-placement":{type:"hidden",value:"point"},"marker-type":{type:"hidden",value:"ellipse"}}},m]},cdb.admin.forms.bubble={point:C,polygon:C,line:C},cdb.admin.forms.choropleth={polygon:[t,x,y,A,b,p,f,g,k,j,h,i],line:[t,x,y,z,d,q,f,g,k,j,h,i],point:[t,x,y,B,{name:"Marker Width",form:{"marker-width":{type:"width",value:10},"marker-allow-overlap":{type:"hidden",value:!0},"marker-placement":{type:"hidden",value:"point"},"marker-type":{type:"hidden",value:"ellipse"}}},m,r,f,g,k,j,h,i]},cdb.admin.forms.color={polygon:[w,{name:"Polygon Fill",form:{"polygon-opacity":{type:"opacity",value:.7}}},b],line:[w,{name:"LineStroke",form:{"line-width":{type:"width",value:2},"line-opacity":{type:"opacity",value:.7}}}],point:[w,{name:"Marker Fill",form:{"marker-width":{type:"width",value:10},"marker-opacity":{type:"opacity",value:.9},"marker-allow-overlap":{type:"hidden",value:!0},"marker-placement":{type:"hidden",value:"point"},"marker-type":{type:"hidden",value:"ellipse"}}},m]},cdb.admin.forms.cluster={point:[{name:"Buckets",form:{method:{type:"select",value:"3 Buckets",extra:["2 Buckets","3 Buckets","4 Buckets","5 Buckets"]}}},{name:"Marker Fill",form:{"marker-fill":{type:"color",value:"#FD8D3C"},"marker-opacity":{type:"opacity",value:1},"marker-allow-overlap":{type:"hidden",value:!0},"marker-placement":{type:"hidden",value:"point"},"marker-type":{type:"hidden",value:"ellipse"}}},{name:"Marker Stroke",form:{"marker-line-width":{type:"width",value:5},"marker-line-color":{type:"color",value:"#fff"},"marker-line-opacity":{type:"opacity",value:1}}},{name:"Radius",title:"Marker size",form:{radius_min:{type:"number",value:24,min:0,max:200},radius_max:{type:"number",value:64,min:0,max:200}},text:"- to -"},{title:"Label Font",name:"Label Text",className:"label_text_properties",form:{"text-face-name":{type:"select",value:"DejaVu Sans Book",extra:["DejaVu Sans Book","unifont Medium","Open Sans Regular","Lato","Graduate","Gravitas One","Old Standard"]},"text-fill":{type:"color",value:"#fff"}}},{name:"Label Halo",className:"label_halo_properties",form:{"text-halo-fill":{type:"color",value:"#FFF"},"text-halo-radius":{type:"number",value:.5,min:0,max:10,inc:.5}}}]},cdb.admin.forms.category={polygon:[s,{name:"Polygon Fill",form:{"polygon-opacity":{type:"opacity",value:.7}}},b],line:[s,{name:"LineStroke",form:{"line-width":{type:"width",value:2},"line-opacity":{type:"opacity",value:.7}}}],point:[s,{name:"Marker Fill",form:{"marker-width":{type:"width",value:10},"marker-opacity":{type:"opacity",value:.9},"marker-allow-overlap":{type:"hidden",value:!0},"marker-placement":{type:"hidden",value:"point"},"marker-type":{type:"hidden",value:"ellipse"}}},m]},cdb.admin.forms.density={point:[{name:"Method",form:{geometry_type:{type:"select",value:"Hexagons",extra:["Hexagons","Rectangles"]}}},{name:"Buckets",form:{method:{type:"select",value:"5 Buckets",extra:["5 Buckets","7 Buckets"]}}},{name:"Color ramp",form:{color_ramp:{type:"select",value:"red",extra:["pink","red","black","green","blue","inverted_pink","inverted_red","inverted_black","inverted_green","inverted_blue","spectrum1","spectrum2","blue_states","purple_states","red_states","inverted_blue_states","inverted_purple_states","inverted_red_states"]},"polygon-opacity":{type:"opacity",value:.8}}},b,{name:"Polygon size",form:{"polygon-size":{type:"number",value:15,min:1,max:100}}},p]};var D={point:[v,{name:"Marker type",form:{"marker-type":{type:"select",value:"ellipse",extra:["ellipse","rectangle"]},"layer-type":{type:"hidden",value:"torque"}}},{name:"Marker Fill",form:{"marker-width":{type:"width",value:6},"marker-fill":{type:"color",value:"#FF9900"},"marker-opacity":{type:"opacity",value:.9}}},{name:"Marker Stroke",form:{"marker-line-width":{type:"width",value:1.5},"marker-line-color":{type:"color",value:"#FFF"},"marker-line-opacity":{type:"opacity",value:1}}},{name:"Duration (secs)",form:{"torque-duration":{type:"number",value:30,min:3,max:120}}},{name:"Steps",form:{"torque-frame-count":{type:"select",value:512,extra:[1,64,128,256,512,1024,2048]}}},{name:"Blend Mode",form:{"torque-blend-mode":{type:"select",value:"lighter",extra:["lighter","multiply","source-over","xor"]}}},{name:"Trails",form:{"torque-trails":{type:"number",value:2,min:0,max:5}}},{name:"Resolution",form:{"torque-resolution":{type:"select",value:2,extra:[1,2,4,8,16,32]}}}]};cdb.admin.forms.torque=a(D),cdb.admin.forms.torque.point.unshift({name:"Cumulative",form:{"torque-cumulative":{type:"switch",value:!1}}}),cdb.admin.forms.torque_cat=a(D),cdb.admin.forms.torque_heat={point:[{name:"Marker size",form:{"marker-width":{type:"width",value:35},"layer-type":{type:"hidden",value:"torque"},"marker-file":{type:"hidden",value:"url(http://s3.amazonaws.com/com.cartodb.assets.static/alphamarker.png)"},"image-filters":{type:"hidden",value:"colorize-alpha(blue, cyan, lightgreen, yellow , orange, red)"}}},{name:"Opacity",form:{"marker-opacity":{type:"opacity",value:.4}}},{name:"Animated",form:{"heat-animated":{type:"switch",value:!1}}},{name:"Cumulative",form:{"torque-cumulative":{type:"switch",value:!1}}},v,{name:"Duration (secs)",form:{"torque-duration":{type:"number",value:10,min:3,max:120}}},{name:"Steps",form:{"torque-frame-count":{type:"select",value:1,extra:[1,16,32,64,128,256,512,1024,2048]}}},{name:"Trails",form:{"torque-trails":{type:"number",value:2,min:0,max:5}}},{name:"Resolution",form:{"torque-resolution":{type:"select",value:8,extra:[1,2,4,8,16,32]}}}]},cdb.admin.forms.torque_cat.point.splice(2,0,u),_.find(cdb.admin.forms.torque_cat.point,function(a){return"Blend Mode"===a.name}).form["torque-blend-mode"].value="source-over"}(),cdb.admin.CodemirrorColorPicker=cdb.core.View.extend({initialize:function(){this.editor=this.options.editor,this._initBinds()},_initBinds:function(){_.bindAll(this,"_onClick","_destroyPicker","_onBlur","_replaceColor");var a=this;this.editor.on("mousedown",function(b,c){setTimeout(function(){a._onClick(c)},50)},this),this.editor.on("blur",this._onBlur,this),this.editor.on("viewportChange",this._destroyPicker,this),this.editor.on("scroll",this._destroyPicker,this)},_disableBinds:function(){this.editor.off("mousedown"),this.editor.off("blur",this._onBlur,this),this.editor.off("viewportChange",this._destroyPicker,this),this.editor.off("scroll",this._destroyPicker,this),cdb.god.unbind("closeDialogs",this._destroyPicker,this)},_onClick:function(a){a.preventDefault();var b=this.editor.getCursor(!0),c=this.editor.getTokenAt(b);"color"===c.type&&"span"===a.target.nodeName.toLowerCase()?this._openColorPicker(a,b,c):this.color_picker&&this._destroyPicker()},_openColorPicker:function(a,b,c){this._destroyPicker(),this._createPicker(a),$("body").append(this.color_picker.render().el),this.color_picker.init(c.string)},_createPicker:function(a){this.color_picker=new cdb.admin.ColorPicker({target:$(a.target),extra_colors:this._getCurrentUsedColors()}).bind("colorChosen",this._replaceColor,this),this._bindPickerEvents(),this.addView(this.color_picker)},_getCurrentUsedColors:function(){if(!this.model)return[];var a=this.model.get("tile_style"),b=new cdb.admin.CartoParser(a);return b.colorsUsed({mode:"hex"})},_bindPickerEvents:function(){if(this.color_picker){var a=this;this.editor.on("blur",this._onBlur,this),this.color_picker.$el.on("mousedown",function(){a.editor.off("blur",a._onBlur,a)}),this.color_picker.$el.on("mousemove",function(){a.editor.off("blur",a._onBlur,a)}),this.color_picker.$el.on("mouseup",function(){a.editor.on("blur",a._onBlur,a)}),setTimeout(function(){cdb.god.bind("closeDialogs",a._destroyPicker,a)},100)}},_unbindPickerEvents:function(){this.color_picker&&(this.editor.on("blur",this._onBlur,this),this.color_picker.$el.off("mousedown mousemove mouseup"),cdb.god.unbind("closeDialogs",this._destroyPicker,this))},_destroyPicker:function(){this.color_picker&&(this._unbindPickerEvents(),this.removeView(this.color_picker),this.color_picker.hide(),delete this.color_picker)},_onBlur:function(a){this._destroyPicker()},_replaceColor:function(a,b){var c=this.editor.getCursor(),d=this._getMatch(c,"name"),e=this._getMatch(c,"hex"),f=d?d:e,g={line:c.line,ch:f.start},h={line:c.line,ch:f.end};this.editor.replaceRange(a,g,h),this.editor.focus(),this.editor.setCursor(h),this.trigger("colorChosen",this),b&&this._destroyPicker()},_getMatch:function(a,b){if(b){var c;switch(b.toLowerCase()){case"name":c=new RegExp(color_keywords.join("|"),"g");break;case"hsl":c=/hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}\%)\s*,\s*(\d{1,3}\%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)/g;break;case"rgb":c=/rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)/;break;case"hex":c=/#[a-fA-F0-9]{3,6}/g;break;default:return void cdb.log.info("invalid color match selection")}for(var d=this.editor.getLine(a.line),e=c.exec(d);e;){var f=e[0],g=f.length,h=e.index,i=e.index+g;if(a.ch>=h&&a.ch<=i)return e=null,{start:h,end:i,string:f};e=c.exec(d)}}},clean:function(){this._disableBinds(),cdb.core.View.prototype.clean.call(this)}}),cdb.admin.mod.Filters=cdb.admin.Module.extend({buttonClass:"filters_mod",className:"filters_panel",type:"tool",events:{"click .clear a":"_onClickClearFilters","click .add_filter .add":"_onClickShowFilterSelector","click .add_filter .remove":"_onClickHideFilterSelector",scroll:"_onScroll"},_onToggleMode:function(){var a=this.model.get("addMode");"add"==a?this._showAddFilter():"combo"==a?this._showCombo():"hidden"==a&&this._hideAddFilter()},_hideAddFilter:function(){this.$el.find(".add_filter > a.add, .add_filter > .combo").fadeOut(150)},_showAddFilter:function(){var a=this;this.$el.find(".add_filter > .combo").fadeOut(150,function(){a.$el.find(".add_filter a.add").fadeIn(150),a._refreshScroll()})},_showCombo:function(){var a=this;this.$el.find(".add_filter a.add").fadeOut(150,function(){a.$el.find(".add_filter > .combo").fadeIn(150),a._refreshScroll(function(){a._scrollBy(30)})})},_onClickHideFilterSelector:function(a){a.preventDefault(),a.stopPropagation(),this.model.set("addMode","add")},_onClickClearFilters:function(a){a.preventDefault(),a.stopPropagation(),this.options.dataLayer.clearSQLView(),this._hideQueryAppliedMessage()},_onClickShowFilterSelector:function(a){a.preventDefault(),a.stopPropagation(),this.model.set("addMode","combo")},_onScroll:function(a){if(this.api){var b=this.api.getPercentScrolledY();0>=b?this.$el.find(".white-gradient-shadow.main.top").css({opacity:0}):1==b?this.$el.find(".white-gradient-shadow.main.bottom").css({opacity:0}):(this.$el.find(".white-gradient-shadow.main.top").css({opacity:1}),this.$el.find(".white-gradient-shadow.main.bottom").css({opacity:1}))}},initialize:function(){_.bindAll(this,"loadScroll","_refreshScroll");var a=this;this._initialized=!1,this._filterViews={},this.columns=new cdb.core.Model,this.model=new Backbone.Model({defaults:{addMode:!1}}),this.options.table.bind("change:schema change:original_schema",this.initFilters,this);var b=[];this.innerColumnSelector=new cdb.forms.ColumnTypeCombo({width:"200px",placeholder:"Select a column to filter by",extra:b,property:"column",model:a.columns}),this.innerColumnSelector.bind("change",this._sendEvent,this),this.columnSelector=new cdb.forms.ColumnTypeCombo({width:"200px",placeholder:"Select a column to filter by",extra:b,property:"column",model:a.columns}),this.columnSelector.bind("change",this._sendEvent,this),this.options.table.has("schema")&&this.initFilters()},initFilters:function(){if(!this._initialized){this._initialized=!0;var a=this;this.options.table.unbind("change:schema",this.initFilters,this),this.options.table.unbind("change:original_schema",this.initFilters,this),this.filters=new cdb.admin.models.Filters(null,{table:this.options.table}),this.excludedColumNames=[],this.options.repeatInterval=this.options.repeatInterval||200,this.add_related_model(this.filters),this.add_related_model(this.columns),this.add_related_model(this.options.table),this.add_related_model(this.options.dataLayer),this.options.table.bind("change:schema",this._onSchemaUpdate,this),this._onSchemaUpdate(),this.options.dataLayer.bind("change:query",function(b,c){c?("filters"!==this.options.dataLayer.get("sql_source")&&(this._unbindChangeQuery(),a.removeFilters(),this._bindChangeQuery()),a.filters.size()||a._showQueryAppliedMessage()):(a.removeFilters(),a._hideQueryAppliedMessage())},this),this.columns.bind("change:column",function(){var a=this.columns.get("column");this.filters.add({column:a})},this),this.options.repeatInterval>0&&(this._filtersChanged=_.debounce(this._filtersChanged,this.options.repeatInterval)),this.filters.bind("reset",this._addFilters,this),this.filters.bind("add",this._addFilter,this),this.filters.bind("remove",this._removeFilter,this),this.model.bind("change:addMode",this._onToggleMode,this),this._bindChangeQuery();var b=this.options.dataLayer.get("filters");b&&this.filters.reset(b)}},changeSQLEvents:["add","remove","change:items","change:lower","change:upper","change:free_text","change:list_view"].join(" "),_bindChangeQuery:function(){this.filters.bind(this.changeSQLEvents,this._filtersChanged,this)},_unbindChangeQuery:function(){this.filters.unbind(this.changeSQLEvents,this._filtersChanged,this)},_onSchemaUpdate:function(){var a=this._generateComboData();this.columnSelector.updateData(a),this.innerColumnSelector.updateData(a)},_generateComboData:function(){var a=this,b=this.options.table.get("original_schema")||this.options.table.get("schema"),c=["string","number","boolean","date"];return _.filter(b,function(b){var d=b[0],e=b[1];return _.contains(c,e)&&!_.contains(a.excludedColumNames,d)&&"cartodb_id"!=d}).map(function(a){a[0];return[a[1],a[0]]})},loadScroll:function(){var a=this;this.model.set("hasScroll",!0),setTimeout(function(){var b=a.$el.find(".scrollpane");b.css("height",a.$el.outerHeight(!0)),b.css("max-height",a.$el.outerHeight(!0)-60),b.jScrollPane({showArrows:!0,animateScroll:!0,animateDuration:150}),a.api=b.data("jsp")},250)},_scrollTo:function(a){this.api&&this.api.scrollToY(a)},_scrollBy:function(a){this.api&&this.api.scrollByY(a)},_refreshScroll:function(a){if(this.api&&this.model.get("hasScroll")){var b=this;setTimeout(function(){b.api.reinitialise(),a&&a()},500)}},removeFilters:function(){this.filters.removeFilters()},_getFilterViewforColumnType:function(a){return"number"==a||"date"==a?cdb.admin.mod.Filter:cdb.admin.mod.SelectorFilter},_addFilters:function(){var a=this;this.filters&&this.filters.each(function(b){a._addFilter(b)})},_addFilter:function(a){var b=this;if(!a.has("column_type"))return void cdb.log.error("model should contain column_type, filter is not added");this.$el.find(".chooser").hide(),this.$el.find(".add_filter").show();var c=a.get("column_type"),d=this._getFilterViewforColumnType(c),e=new d({model:a});e.bind("refresh_scroll",this._refreshScroll,this),e.bind("scrollToPosition",this._scrollToPosition,this),this.addView(e),this._filterViews[a.cid]=e,this.$(".filters").append(e.render().el),this.excludedColumNames.push(a.get("column"));var f=this._generateComboData();this.columnSelector.updateData(f),this.innerColumnSelector.updateData(f),0==f.length?this.model.set("addMode","hidden"):this.model.set("addMode","add"),this._refreshScroll(function(){setTimeout(function(){b._scrollBy(200)},100)})},_removeFilter:function(a){this.model.set("addMode","add");var b=this,c=this._filterViews[a.cid];c.$el.hide(),c.clean(),delete b._filterViews[a.cid],_.size(b._filterViews)<1&&(this.$el.find(".chooser").show(),this.$el.find(".add_filter").hide()),this.excludedColumNames=_.without(this.excludedColumNames,a.get("column")),this.innerColumnSelector.updateData(this._generateComboData()),this.innerColumnSelector.deselect(),this.columnSelector.updateData(this._generateComboData()),this.columnSelector.deselect(),this._scrollTo(0),this._refreshScroll()},_filtersChanged:function(){this.options.dataLayer.set({filters:this.filters.toJSON()},{silent:!0});var a;this.filters.size()?(a=_.template("SELECT * FROM <%= table %> WHERE <%= cond %>")({table:this.options.table.get("id"),cond:this.filters.getSQLCondition()}),a=this._cleanSQL(a),this.options.dataLayer.applySQLView(a,{sql_source:"filters"})):this.options.dataLayer.clearSQLView()},_cleanSQL:function(a){return String.prototype.rtrim=function(){return this.replace(/\s+$/,"")},cleaned_sql=a.replace(/\(true\)\s*AND/g,"").rtrim(),cleaned_sql=cleaned_sql.replace(/\AND\s*\(true\)/g,"").rtrim(),cleaned_sql=cleaned_sql.replace(/WHERE\s*\B/,"WHERE "),cleaned_sql=cleaned_sql.replace(/WHERE$/,""),cleaned_sql=cleaned_sql.replace(/WHERE\s*true$/,""),cleaned_sql=cleaned_sql.replace(/\sWHERE\s*\(true\)$/,""),cleaned_sql},_hideQueryAppliedMessage:function(){this.$el.find(".applied_query").hide(),this.$el.find(".form_combo").show(),this.$el.find(".help").show()},_showQueryAppliedMessage:function(){this.$el.find(".form_combo").hide(),this.$el.find(".help").hide(),this.$el.find(".applied_query").show()},_sendEvent:function(a){cdb.god.trigger("mixpanel","Applying filter",{column:a}),cdb.god.trigger("metrics","filter",{email:window.user_data.email,data:{column:a}})},render:function(){var a=this.getTemplate("table/menu_modules/filters/templates/filters"),b=this.options.dataLayer.get("sql_source"),c=this.options.dataLayer.get("query"),d=c&&"filters"!=b;return this.$el.html(a({isQueryApplied:d})),this.$el.find(".chooser").append(this.columnSelector.render().el),this.$el.find(".combo").prepend(this.innerColumnSelector.render().el),void 0==this.filters||0==this.filters.length?this.$el.find(".chooser").show():this.$el.find(".add_filter").show(),d&&this._showQueryAppliedMessage(),this}}),function(){cdb.admin.mod.Filter=cdb.core.View.extend({_SHORT_MONTH_NAMES:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],_MONTH_NAMES:["January","February","March","April","May","June","July","August","September","October","November","December"],tagName:"li",className:"filter histogram",events:{"click a.remove":"_remove"},initialize:function(){_.bindAll(this,"_barChart"),this.model.bind("change:hist",this.render,this),this.model.bind("change:lower",this._renderRange,this),this.model.bind("change:upper",this._renderRange,this),this.model.bind("error",this._checkEmpty,this),this.isDate="date"==this.model.get("column_type"),this.isDate&&this.$el.addClass("date")},_renderHist:function(){function a(){i.each(function(a){d3.select(this).call(a)})}var b=this,c=this.model.get("hist");if(c){if(1==c.length){c.length;return this.$el.find(".legend").html(this._cleanString(this.model.escape("column"),15)+":"),this.$(".loading").hide(),this.$(".empty").hide(),this.$(".range").hide(),void this.$(".only").fadeIn(150)}this._checkEmpty();var d=c.map(function(a,b){return{value:a}}),e=crossfilter(d),f=function(a){return e.dimension(function(b){return b[a]})},g=function(a){var c=f(a),e=325,g=b.model.get("lower"),h=b.model.get("upper"),i=b.model.get("upper_limit")-b.model.get("lower_limit"),j=(i/d.length,(g-b.model.get("lower_limit"))*d.length/i),k=(h-b.model.get("lower_limit"))*d.length/i;return b._barChart().dimension(c).group(d.map(function(a){return parseFloat(a.value,10)})).round(function(a){return Math.ceil(a)}).x(d3.scale.linear().domain([0,d.length]).range([0,e])).filter([j,k])},h=[g("value")],i=d3.select(".hist."+this.cid).data(h).each(function(b){b.on("brush",a).on("brushend",a)});a()}},render:function(){var a=this;return this.$el.html(this.getTemplate("table/menu_modules/filters/templates/histogram")({legend:this.model.escape("column"),cid:a.cid})),this._renderHist(),this},_cleanString:function(a,b){return a&&(a=a.replace(/<(?:.|\n)*?>/gm,""),a=a.substr(0,b-1)+(a.length>b?"&hellip;":"")),a},_checkEmpty:function(){var a=this;setTimeout(function(){var b=a.model.get("hist");b?b.length>1?(a.$(".empty").hide(),a.$(".loading").hide(),a.$(".range").fadeIn(250)):(a.$el.find(".legend").html(a.model.escape("column")),a.$(".loading").hide(),a.$(".range").hide(),a.$(".empty").hide(),a.$(".only").fadeIn(150)):(a.$el.find(".legend").html(a._cleanString(a.model.escape("column"),25)+":"),a.$(".range").hide(),a.$(".loading").hide(),a.$(".empty").fadeIn(150))},250)},_getMinMaxFromDate:function(a,b){a=Math.round(a),b=Math.round(b);var c=this.model._getDateFromTimestamp(a),d=this.model._getDateFromTimestamp(b);return minMaxDate=this._formatDate(c,d),{min:minMaxDate.min,max:minMaxDate.max}},_formatLowerUpper:function(a,b){return{min:a.toPrecision(Math.round(a).toString().length+2),max:b.toPrecision(Math.round(b).toString().length+2)}},_renderRange:function(){var a=this.model.get("lower"),b=this.model.get("upper"),c={};c=this.isDate?this._getMinMaxFromDate(a,b):this._formatLowerUpper(a,b),_.isNaN(b)||_.isNaN(a)||this.$(".range").html(c.min+" - "+c.max)},_remove:function(a){a.preventDefault(),a.stopPropagation(),this.model.destroy()},_updateBounds:function(a,b){if(a){var c=this.model.get("hist").length,d=this.model.interpolate(a[0]/c),e=this.model.interpolate(a[1]/c),f=this.model.fitToBucket(d),g=this.model.fitToBucket(e)+(this.model.get("bucket_size")||0);d>f?lower=d:lower=f||d,lower=f||d,g>e?upper=e:upper=g||e,b&&(_.isNaN(lower)||this.model.set("lower",lower),_.isNaN(upper)||this.model.set("upper",upper)),this.isDate?minMax=this._getMinMaxFromDate(lower,upper):minMax=this._formatLowerUpper(lower,upper),_.isNaN(upper)||_.isNaN(lower)||this.$(".range").html(minMax.min+" - "+minMax.max)}},_formatDate:function(a,b){function c(a,b,c){return c=c||"0",a+="",a.length>=b?a:new Array(b-a.length+1).join(c)+a}var d=a.getDate(),e=b.getDate(),f=a.getFullYear(),g=b.getFullYear(),h=a.getMonth(),i=b.getMonth(),j=c(a.getHours(),2)+":"+c(a.getMinutes(),2)+" ",k=c(d,2)+" "+this._SHORT_MONTH_NAMES[h]+" "+f,l=c(b.getHours(),2)+":"+c(b.getMinutes(),2)+" ",m=c(e,2)+" "+this._SHORT_MONTH_NAMES[i]+" "+g;return{min:k+" @ "+j,max:m+" @ "+l}},_barChart:function(){function a(a){function d(a,c){for(var d,e=[],c=-1,f=a.length,g=m/f;++c<f;)d=a[c],inverseHeight=j(d),inverseHeight>h&&inverseHeight<n&&(inverseHeight=h),e.push("M",b(c),",",n,"V",inverseHeight,"h",g,"V",n);return e.join("")}function f(a){var b=+("e"==a),c=b?1:-1,d=n/3;return"M"+.5*c+","+d+"A6,6 0 0 "+b+" "+6.5*c+","+(d+6)+"V"+(2*d-6)+"A6,6 0 0 "+b+" "+.5*c+","+2*d+"ZM"+2.5*c+","+(d+8)+"V"+(2*d-8)+"M"+4.5*c+","+(d+8)+"V"+(2*d-8)}var m=b.range()[1],n=j.range()[0];j.domain([0,d3.max(e)]),a.each(function(){var a=d3.select(this),h=a.select("g");if(h.empty()){h=a.append("svg").attr("width",m+i.left+i.right).attr("height",n+i.top+i.bottom).append("g").attr("transform","translate("+i.left+","+i.top+")"),h.append("clipPath").attr("id","clip-"+k).append("rect").attr("width",m).attr("height",n),h.selectAll(".bar").data(["background","foreground"]).enter().append("path").attr("class",function(a){return a+" bar"}).data([e,e]),h.selectAll(".foreground.bar").attr("clip-path","url(#clip-"+k+")");var j=h.append("g").attr("class","brush").call(l);j.selectAll("rect").attr("height",n),j.selectAll(".resize").append("path").attr("d",f)}if(c)if(c=!1,h.selectAll(".brush").call(l),l.empty())h.selectAll("#clip-"+k+" rect").attr("x",0).attr("width",m);else{var o=l.extent();h.selectAll("#clip-"+k+" rect").attr("x",b(o[0])).attr("width",b(o[1])-b(o[0])),g._updateBounds(o,!1)}h.selectAll(".bar").attr("d",d)})}var b,c,d,e,f,g=this,h=97,i={top:0,right:10,bottom:0,left:10},j=d3.scale.linear().range([100,0]),k=this.cid,l=d3.svg.brush();return l.on("brushstart.chart",function(){var a=l.extent();g._updateBounds(a,!1)}),l.on("brush.chart",function(){var a=d3.select(this.parentNode),c=l.extent();f&&a.select(".brush").call(l.extent(c=c.map(f))).selectAll(".resize").style("display",null),a.select("#clip-"+k+" rect").attr("x",b(c[0])).attr("width",b(c[1])-b(c[0])),g._updateBounds(c,!1)}),l.on("brushend.chart",function(){var a=l.extent();g._updateBounds(a,!0)}),a.margin=function(b){return arguments.length?(i=b,a):i},a.x=function(c){return arguments.length?(b=c,l.x(b),a):b},a.y=function(b){return arguments.length?(j=b,a):j},a.dimension=function(b){return arguments.length?(d=b,a):d},a.filter=function(b){return b?(l.extent(b),d.filterRange(b)):(l.clear(),d.filterAll()),c=!0,a},a.group=function(b){return arguments.length?(e=b,a):e},a.round=function(b){return arguments.length?(f=b,a):f},d3.rebind(a,l,"on")}})}(),function(){var a=cdb.core.View.extend({tagName:"li",events:{click:"toggle"},initialize:function(){this.model.bind("change",this.render,this),this.template_base=_.template("<p class='<% if (bucket == undefined || bucket == '' || bucket == 'null') { %>empty<% } %>'><% if (bucket == undefined) { %>null<% } else if (bucket == '') {%>empty<% } else { %><%- bucket %><% } %></p> <div class='value'><%- value %></div>")},_formatNumber:function(a){var b=a.toString().split(".");return b[0]=b[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),b.join(".")},_cleanString:function(a){var b=180;return a&&(a=a.replace(/<(?:.|\n)*?>/gm,""),a=a.substr(0,b-1)+(a.length>b?"&hellip;":"")),a},render:function(){var a,b=this.model.get("bucket");a="boolean"==this.options.column_type?null==b?"null":b?"true":"false":this._cleanString(b);var c=this.model.get("value");return this.model.set("value",this._formatNumber(c)),this.$el.html(this.template_base(_.extend(this.model.toJSON(),this.options,{bucket:a}))),this.model.get("selected")?this.$el.addClass("selected"):this.$el.removeClass("selected"),this},toggle:function(){var a=this.model.get("selected");this.model.set("selected",!a),this.trigger("updateCounter")}});cdb.admin.mod.SelectorFilter=cdb.core.View.extend({tagName:"li",className:"filter selection",_SCROLLSTEP:120,events:{"keypress input":"_onKeyPress","click a.apply":"_onApply","click a.remove":"_remove","click a.up":"_move","click a.down":"_move","click a.all":"_select","click a.none":"_select","click .view_mode label":"_toggleSwitch"},initialize:function(){_.bindAll(this,"_updateCounter"),this.model.items.bind("reset",this.render,this),this.model.bind("change:free_text",this._updateFreeText,this),this.model.bind("change:controllers",this._toggleControllers,this),this.model.bind("change:scrollers",this._toggleScrollers,this),this.model.bind("change:list_view",this._toggleMode,this),this.model.bind("change:legend",this._updateLegend,this),this.model.bind("change:show_items",this._toggleItems,this),this.add_related_model(this.model.items)},_cleanString:function(a,b){return a&&(a=a.replace(/<(?:.|\n)*?>/gm,""),a=a.substr(0,b-1)+(a.length>b?"&hellip;":"")),a},_updateFreeText:function(a){this.$el.find("input").html(a.get("free_text"))},_updateLegend:function(){this.$(".legend").html(this.model.get("legend"))},_updateCounter:function(){var a=_.countBy(this.model.items.models,function(a){return a.get("selected")?"selected":"unselected"});this.model.set("count",a),a.selected==_.size(this.model.items)?(this.model.set({all:!0}),this.$all.addClass("selected"),this.$none.removeClass("selected")):a.selected?(this.$none.addClass("selected"),this.$all.removeClass("selected")):(this.$none.addClass("selected"),this.$all.removeClass("selected"));var b=void 0==a.selected?0:a.selected;this.$el.find(".count").html(" - "+b+" selected")},_showControllers:function(){this.model.set("controllers",!0)},_hideControllers:function(){this.model.set("controllers",!1)},_toggleControllers:function(){this.model.get("controllers")?this.$el.find(".controllers").fadeIn(250):this.$el.find(".controllers").fadeOut(250)},_showScrollers:function(){this.model.set("scrollers",!0),this.$el.find(".fields").addClass("has_scrollers")},_hideScrollers:function(){this.model.set("scrollers",!1),this.$el.find(".fields").removeClass("has_scrollers")},_hideItems:function(){this.model.set("show_items",!1)},_toggleItems:function(){this.model.get("show_items")?this.$el.find(".items").fadeIn(250):this.$el.find(".items").fadeOut(250)},_toggleScrollers:function(){this.model.get("scrollers")?this.$el.find(".scrollers").removeClass("hidden"):this.$el.find(".scrollers").addClass("hidden")},_addItems:function(){var b=this;this.model.items.each(function(c){var d=new a({model:c,column_type:b.model.get("column_type")});d.bind("updateCounter",b._updateCounter,b),b.$items.append(d.render().el),b.addView(d)})},_addSwitch:function(){var a=this;this["switch"]=new cdb.forms.Switch({el:a.$el.find(".switch"),model:a.model,property:"list_view"})},_onKeyPress:function(a){13==a.keyCode&&this._onApply(a)},_onApply:function(a){a.preventDefault(),a.stopPropagation();var b=this.$input.find("input").attr("value");this.model.set("free_text",b)},render:function(){this.clearSubViews();var a="loading",b=this.model.get("count");return b&&(a=0==this.model.items.length||1==this.model.items.length&&null==this.model.items.at(0).get("bucket")?"empty":1==this.model.items.length?"only":"loaded"),this.$el.html(this.getTemplate("table/menu_modules/filters/templates/selection")({status:a,column_type:this.model.get("column_type"),legend:this.model.escape("column"),short_legend:this._cleanString(this.model.escape("column"),15),list_view:this.model.get("list_view"),free_text:this.model.get("free_text"),reached_limit:this.model.get("reached_limit")})),this.$scroll=this.$el.find(".scroll"),this.$items=this.$el.find(".items"),this.$all=this.$el.find(".all"),this.$none=this.$el.find(".none"),this.$input=this.$el.find(".input_field"),this._addItems(),this._updateCounter(),this.$items.find("li").length>5&&(this.model.set("scrollers",!0),this.$el.find(".white-gradient-shadow.bottom").css({opacity:1})),this.model.get("reached_limit")?(this.model.set({list_view:!1}),this._toggleMode(),this.model.set("legend",this.model.escape("column")),this.$el.find(".view_mode").tipsy({gravity:"s",fade:!0,html:!0,live:!0})):("boolean"==this.model.get("column_type")&&this.$el.find(".options").hide(),"loaded"!=a?this._hideItems():(this._addSwitch(),this._toggleMode())),this},_toggleSwitch:function(){this.model.get("reached_limit")||this.model.set("list_view",!this.model.get("list_view"))},_toggleMode:function(){this.model.get("list_view")?this._showListView():this._showFreeTextView()},_showFreeTextView:function(){this._toggleShadow("top",0),this._toggleShadow("bottom",0),this.$el.find(".scroll").animate({height:55},{duration:250}),this.$input.fadeIn(250),this.$el.find(".scroll .items").fadeOut(150),this._hideControllers(),this._hideScrollers(),this.$el.find(".fields").removeClass("list"),this.$el.find(".fields").addClass("text"),this.model.set("legend",this.model.escape("column")),this.trigger("refresh_scroll")},_showListView:function(){var a=this.model.get("count");this.$input.fadeOut(250),this.$el.find(".scroll .items").fadeIn(150);var b=34*(this.$el.find(".scroll .items li").length+1);this.$el.find(".scroll").animate({height:b},{duration:150}),this._showControllers();var c=0;a.selected&&(c=a.selected),a.unselected&&(c+=a.unselected),c>=5?(this._showScrollers(),this._toggleShadow("top",0),this._toggleShadow("bottom",1)):this._hideScrollers(),this.$el.find(".fields").removeClass("text"),this.$el.find(".fields").addClass("list"),this.model.set("legend",this.model.escape("column")+":"),
this.trigger("refresh_scroll")},_select:function(a){a.preventDefault(),a.stopPropagation();var b=$(a.target);b.hasClass("all")?this._selectAll(a):this._selectNone(a),this._updateCounter()},_selectAll:function(a){this.$all.addClass("selected"),this.$none.removeClass("selected"),this.model.items.each(function(a){a.set({selected:!0})})},_selectNone:function(a){this.$none.addClass("selected"),this.$all.removeClass("selected"),this.model.items.each(function(a){a.set({selected:!1})})},_move:function(a){a.preventDefault(),a.stopPropagation();var b=$(a.target);b.hasClass("up")?this._moveUp(a):this._moveDown(a)},_toggleShadow:function(a,b){this.$el.find(".white-gradient-shadow."+a).animate({opacity:b},50)},_moveUp:function(a){var b=this;this._toggleShadow("bottom",1),this.$el.find(".scrollers .down").removeClass("disabled"),this.$scroll.stop().animate({scrollTop:"-="+this._SCROLLSTEP+"px"},150,function(){0==b.$items.position().top&&(b.$el.find(".scrollers .up").addClass("disabled"),b._toggleShadow("top",0))})},_moveDown:function(a){var b=this;this._toggleShadow("top",1),this.$el.find(".scrollers .up").removeClass("disabled"),this.$el.find(".scroll").stop().animate({scrollTop:"+="+this._SCROLLSTEP+"px"},150,function(){var a=b.$scroll.scrollTop(),c=b.$scroll.find("ul").height(),d=b.$scroll.find("li:last-child").outerHeight(!0);a+b._SCROLLSTEP+d>=c&&(b._toggleShadow("bottom",0),b.$el.find(".scrollers .down").addClass("disabled"))})},_remove:function(a){a.preventDefault(),a.stopPropagation(),this.model.destroy()}})}(),cdb.admin.mod.HTMLEditorHelp=cdb.core.View.extend({_TEXTS:{message:_t("To link data write your column names within {{}}")},className:"help-tip",events:{"click .close":"_onClickClose"},initialize:function(){this.template=this.getTemplate("table/views/html_editor_help"),this.options.text&&(this._TEXTS.message=this.options.text),this._setupLocalStorage(),this._setupModel(),this._toggle(),_.bindAll(this,"_show","_hide")},render:function(){this.clearSubViews();var a=this.template(this.model.toJSON());return this.$el.html(a),this},_setupLocalStorage:function(){var a=this.options.localStorageKey||"html_editor_help";this.storage=new cdb.admin.localStorage(a)},_setupModel:function(){var a=this.storage.get("hidden")===!0?!0:!1;this.model=new cdb.core.Model({hidden:a,message:this._TEXTS.message}),this.model.bind("change:message",this.render,this),this.model.bind("change:hidden",this._toggle,this)},_show:function(){this.show(),this.trigger("show",this)},_hide:function(){this.hide(),this.trigger("hide",this)},_onClickClose:function(a){this.killEvent(a),this.storage.set({hidden:!0}),this.model.set("hidden",!0)},_toggle:function(){this.model.get("hidden")?this._hide():this._show()}}),cdb.admin.mod=cdb.admin.mod||{},cdb.admin.mod.InfoWindow=cdb.admin.Module.extend({buttonClass:"infowindow_mod",className:"infowindow_panel",type:"tool",events:{"click a.doc_info":"_showMustacheHelp"},initialize:function(){this.template=this.getTemplate("table/menu_modules/views/infowindow"),this.dataLayer=this.options.dataLayer,this.table=this.options.table},render:function(){return this.clearSubViews(),this.$el.html(this.template()),this._renderContent(),this},_renderContent:function(){this.infowindow_tabs=new cdb.admin.Tabs({el:this.$("ul.types"),slash:!0}),this.addView(this.infowindow_tabs),this.infowindow_panes=new cdb.ui.common.TabPane({el:this.$(".panes_content")}),this.addView(this.infowindow_panes),this.tooltip_pane=new cdb.admin.mod.TooltipTab({table:this.table,model:this.dataLayer.tooltip}).render(),this.tooltip_pane.bind("tabChanged",this._onEnableTab,this),this.infowindow_panes.addTab("tooltip",this.tooltip_pane),this.infowindow_pane=new cdb.admin.mod.InfoWindowTab({table:this.table,model:this.dataLayer.infowindow}).render(),this.infowindow_pane.bind("tabChanged",this._onEnableTab,this),this.infowindow_panes.addTab("infowindow",this.infowindow_pane),this.infowindow_tabs.linkToPanel(this.infowindow_panes),this.infowindow_panes.active("infowindow"),this.infowindow_tabs.activate("infowindow"),this.infowindow_panes.bind("tabEnabled",this._onEnableTab,this)},getModuleAction:function(){var a=this.infowindow_panes.activePane.getActiveTab(),b=this._ACTION;return"html"==a&&(b={type:"show",width:600}),b},_onEnableTab:function(){this.triggerModuleAction()},activated:function(){},disabled:function(){},enabled:function(){},_showMustacheHelp:function(a){this.killEvent(a);var b=new cdb.admin.MustacheInfo;b.appendToBody().open()},setActiveTab:function(a){this.infowindow_panes.active(a)}}),cdb.admin.mod.TemplateMap={"table/views/infowindow_light":"infowindow_light","table/views/infowindow_dark":"infowindow_dark","table/views/infowindow_light_header_blue":"infowindow_light_header_blue","table/views/infowindow_light_header_yellow":"infowindow_light_header_yellow","table/views/infowindow_light_header_orange":"infowindow_light_header_orange","table/views/infowindow_light_header_green":"infowindow_light_header_green","table/views/infowindow_header_with_image":"infowindow_header_with_image"},cdb.admin.mod.InfowindowBasePane=cdb.core.View.extend({_DEFAULT_TEMPLATE:"infowindow_light",events:{"click .reset":"_onResetClick"},getColumnNames:function(){var a=this,b=this.options.table.columnNames();return _(b).filter(function(b){return!_.contains(a.model.SYSTEM_COLUMNS,b)})},_onResetClick:function(a){this.killEvent(a),this.model.set({template_name:this.model.get("old_template_name")||this._DEFAULT_TEMPLATE,old_template_name:"",template:""}),this.model.restoreFields(),this.trigger("reset",this)},_toggleContent:function(){this.model.get("template")?(this.$el.addClass("disabled"),this.$(".blocked").show()):(this.$el.removeClass("disabled"),this.$(".blocked").hide())}}),cdb.admin.mod.InfowindowField=cdb.core.View.extend({tagName:"li",events:{"click .switch":"toggle","click .title":"toggleTitle"},template:_.template('<span class="ellipsis"><%- fieldName %></span>      <div class="switches">        <a href="#title" class="checkbox small light title">          <span class="check"></span>          title?        </a>        <a href="#switch" class="switch">          <span class="handle"></span>        </a>      </div>'),initialize:function(){this.fieldName=this.options.field,this.position=this.options.position,this.model.bind("change:fields",this.fieldChange,this)},render:function(){return this.$el.append(this.template(this)),this.fieldChange(),this.$el.attr("cid",this.cid),this.$el.addClass("drag_field"),this},fieldChange:function(){var a=this.$(".title"),b=this.$(".switch"),c=this.model.containsField(this.fieldName);c?b.removeClass("disabled").addClass("enabled"):b.removeClass("enabled").addClass("disabled");var d=this.model.getFieldProperty(this.fieldName,"title");c?(a.removeClass("enabled disabled"),d&&a.addClass("enabled")):a.removeClass("enabled").addClass("disabled")},toggle:function(a){return a.preventDefault(),this.model.containsField(this.fieldName)?this.model.removeField(this.fieldName):this.model.addField(this.fieldName,this.position),!1},toggleTitle:function(a){a.preventDefault();var b=this.model.getFieldProperty(this.fieldName,"title");return this.model.setFieldProperty(this.fieldName,"title",!b),!1}}),cdb.admin.mod.InfowindowFieldItem=cdb.core.View.extend({tagName:"li",events:{"click .switch":"toggle","click .title":"toggleTitle"},template:_.template('<span class="ellipsis"><%- fieldName %></span><div class="input"></div>'),initialize:function(){this.fieldName=this.options.field.name,this.fieldTitle=this.options.field.title,this.position=this.options.position},render:function(){return this.$el.append(this.template(this)),this._renderField(),this},toggle:function(a){return a.preventDefault(),this.model.containsField(this.fieldName)?this.model.removeField(this.fieldName):this.model.addField(this.fieldName,this.position),!1},toggleTitle:function(a){a.preventDefault();var b=this.model.getFieldProperty(this.fieldName,"title");return this.model.setFieldProperty(this.fieldName,"title",!b),!1},_renderField:function(){this.fieldModel=new cdb.core.Model({title:this.model.getAlternativeName(this.fieldName)||this.fieldName});var a=this;this.fieldModel.bind("change:title",function(){a.model.setAlternativeName(a.fieldName,this.get("title"))}),this.editInPlace=new cdb.admin.EditInPlace({observe:"title",model:this.fieldModel,stripHTML:!0,disabled:!this.fieldTitle,el:this.$el.find(".input")}),this.addView(this.editInPlace)}}),cdb.admin.mod.InfowindowFieldsPane=cdb.admin.mod.InfowindowBasePane.extend({className:"fieldPane",events:{"click .selectall":"_manageAll","click .reset":"_onResetClick"},initialize:function(){this._setupModel(),this._setupTemplate(),this.sortedFields=new Backbone.Collection,this.sortedFields.comparator=function(a){return a.get("position")},this.render()},render:function(){return this.clearSubViews(),this.$el.html(this.template),this._toggleContent(),this.$el.find(".fields").sortable("destroy"),this.renderFields(),this.$selectAll=this.$(".selectall"),this.renderSelectAll(),this._storeSortedFields(),this},_setupModel:function(){this.model.bind("remove:fields",this.renderSelectAll,this),this.model.bind("add:fields",this.renderSelectAll,this),this.model.bind("change:template",this._toggleContent,this),this.options.table.bind("change:schema",this.render,this),this.bind("reset",this.render,this),this.add_related_model(this.options.table)},_setupTemplate:function(){this.template=this.getTemplate("table/views/infowindow/infowindow_fields_pane")},renderSelectAll:function(){this.selectedAll=this._allFieldsSelected(),this._changeSelectAll()},_allFieldsSelected:function(){var a=this,b=!0;return _(this.getColumnNames()).each(function(c){a.model.containsField(c)||(b=!1)}),b},_changeSelectAll:function(){this.$selectAll.toggleClass("working",this.working),this.$selectAll.toggleClass("enabled",this.selectedAll),this.$selectAll.toggleClass("disabled",!this.selectedAll)},_manageAll:function(a){var b=this;this.killEvent(a),this.working||(b.model.clearFields(),b.selectedAll?b._unselectAll():b._selectAll())},_selectAll:function(){var a=this,b=this.sortedFields.map(function(a){return a.get("name")}),c=(_.size(b)-1,[]);_(b).each(function(b){a.working=!0,c.push(a.model._addField(b))}),$.when.apply($,c).then(function(){a.working=!1,a.model.sortFields(),a.model.trigger("change:fields"),a._toggleSelectAll()})},_unselectAll:function(){this.model.trigger("change:fields"),this._toggleSelectAll()},_toggleSelectAll:function(){this.selectedAll=!this.selectedAll,this._changeSelectAll()},renderFields:function(){var a=this,b=this.$(".fields"),c=this.getColumnNames();return 0==c.length?(this._showNoContent(),!1):(c.sort(function(b,c){var d=a.model.getFieldPos(b),e=a.model.getFieldPos(c);return d-e}),_(c).each(function(c,d){var e=a.model.fieldCount()?a.model.getFieldPos(c):d,f=new cdb.admin.mod.InfowindowField({model:a.model,field:c,position:e});a.addView(f),b.append(f.render().el)}),void b.sortable({items:"li",handle:"span.ellipsis",stop:function(b,c){a._reasignPositions()}}))},_showNoContent:function(){this.$(".no_content").show(),this.$("div.all").hide()},_storeSortedFields:function(){var a=this;this.sortedFields.reset([]);var b=this._getSortedColumnNames();_(b).each(function(b,c){a.sortedFields.add({name:b,position:c})})},_getSortedColumnNames:function(){var a=this,b=this.getColumnNames();return this.model.fieldCount()>0&&b.sort(function(b,c){var d=a.model.getFieldPos(b),e=a.model.getFieldPos(c);return d-e}),b},_reasignPositions:function(){var a=this;this.sortedFields.reset([]),this.$el.find(".drag_field").each(function(b,c){var d=a._subviews[$(c).attr("cid")];d.model.setFieldProperty(d.fieldName,"position",b),d.position=b,a.sortedFields.add({name:d.fieldName,position:b})})}}),cdb.admin.mod.InfowindowHTMLPane=cdb.admin.mod.InfowindowBasePane.extend({_TEMPLATE_URL:"table/views/infowindow/custom_templates",_STORAGE_NAMESPACE:"cdb.localStorage.infowindow.",_TEXTS:{tip:_t("To link data write your column names within {{}}.                           &lt;script&gt; tags could break your map."),template_error:_t("Error in line {{line}}: {{msg}}"),empty_error:_t("Template can't be empty")},className:"htmlPane",events:{"click .apply":"_apply"},initialize:function(a){_.bindAll(this,"_onKeyUpEditor"),a.template_url&&(this._TEMPLATE_URL=a.template_url),this._setupTemplate(),this.render(),this.model.bind("change:width",this._checkTemplate,this),this.model.bind("change:template_name",this._setContent,this),this.model.bind("change:fields change:alternative_names",this._resetContent,this)},render:function(){return this.clearSubViews(),this.$el.html(this.template),this._initEditor(),this._initHelp(),this},_initHelp:function(){this.help=new cdb.admin.mod.HTMLEditorHelp({localStorageKey:this._STORAGE_NAMESPACE+this.options.table.get("id"),text:this._TEXTS.tip}).bind("hide show",this.adjustCodeEditorSize,this),this.$el.append(this.help.render().$el),this.addView(this.help)},_initEditor:function(){var a=this;this.codeEditor=CodeMirror.fromTextArea(this.$("textarea")[0],{mode:"text/xml",tabMode:"indent",tabSize:2,matchBrackets:!0,lineNumbers:!0,lineWrapping:!0,onKeyEvent:this._onKeyUpEditor,extraKeys:{"Ctrl-Space":function(b){a._showAutocomplete(b)}}}),this._setKeymap(),this._setContent()},_showAutocomplete:function(a){CodeMirror.showHint(a,CodeMirror.hint["custom-list"],{completeSingle:!1,list:_.map(this.options.table.get("schema"),function(a){return a[0]})})},_onKeyUpEditor:function(a,b){var c=b.keyCode?b.keyCode:b.which;if("keyup"==b.type&&27!=c){var d=this;this.autocomplete_timeout&&clearTimeout(this.autocomplete_timeout),this.autocomplete_timeout=setTimeout(function(){var b=a.getCursor(),c=a.getTokenAt(b).string;if(c.length>2){var e=_.compact(_.map(d.options.table.get("schema"),function(a){return-1!=a[0].search(c)?a[0]:null}));!a.state.completionActive&&c.length>2&&e.length>0&&d._showAutocomplete(a)}},150)}},_setKeymap:function(){var a=navigator.userAgent.toLowerCase(),b=this;this.keymap={so:"rest",combination:"ctrl+s"},/mac os/.test(a)&&(this.keymap={so:"mac",combination:"meta+s"}),this.$("textarea").bind("keydown",this.keymap.combination,function(a){("mac"==b.keymap.so&&a.metaKey||"rest"==b.keymap.so&&a.ctrlKey)&&83==a.keyCode&&(a.preventDefault(),b._apply())})},_toggleContent:function(){},_checkTemplate:function(){var a=this.codeEditor.getValue(),b=/(?=<[^>]+(?=[\s+\"\']cartodb-popup[\s+\"\']).+)([^>]+>)/;if(a.match(b)&&a.match(b).length>0){var c=$(a).hasClass("v2");if(!c){var d=a.match(b);if(0===d.length)return!1;var e=d[0],f=e.replace("cartodb-popup","cartodb-popup v2");this.codeEditor.setValue(a.replace(e,f)),this._apply()}}},_setContent:function(){var a=this.model.get("template")||this._getTemplateContent();this.codeEditor.setValue(a),this._clearErrors()},_resetContent:function(){this.model.get("template_name")&&this._setContent()},_getTemplateContent:function(){var a=[],b=this,c=_.clone(b.model.get("alternative_names"));return _.each(this.model.toJSON().fields,function(b,d){var e=_.clone(b);e.position=d,c[e.name]&&(e.alternative_name=c[e.name]),a.push(e)}),cdb.templates.getTemplate(this._getTemplateURL())({content:{fields:a}})},_getTemplateURL:function(){var a=cdb.admin.mod.TemplateMap[this.model.get("template_name")]||this.model.get("template_name")||this._DEFAULT_TEMPLATE;return this._TEMPLATE_URL+"/"+a},_setupTemplate:function(){this.template=this.getTemplate("table/views/infowindow/infowindow_html_pane")},_getErrors:function(){try{var a=this.codeEditor.getValue();cdb.core.Template.compile(this.codeEditor.getValue(),"mustache")();return""===a?{line:"1",message:"\n\n"+this._TEXTS.empty_error}:{}}catch(b){return b}},_parseErrors:function(a){var b=this._TEXTS.template_error.replace("{{line}}",a.line).replace("{{msg}}",a.message.split("\n\n")[1]);this.$(".info").addClass("error").html("<p>"+b+"</p>").show(),this.adjustCodeEditorSize()},_clearErrors:function(){this.$(".info").removeClass("error").html("").hide(),this.adjustCodeEditorSize()},adjustCodeEditorSize:function(){var a=this.$(".info").is(":visible")?this.$(".info").outerHeight():0,b=this.$(".help-tip").is(":visible")?this.$(".help-tip").outerHeight():0;this.$(".CodeMirror-wrap").css({bottom:a+80,top:b+-10})},_onSQLApplied:function(){this.model.get("template")&&!this.model.get("template_name")&&this._apply()},_apply:function(a){a&&a.preventDefault&&a.preventDefault();var b=this._getErrors();_.isEmpty(b)?(this._clearErrors(),this.model.get("old_fields")||this.model.saveFields(),this.model.get("old_template_name")||this.model.set("old_template_name",this.model.get("template_name")),this.model.unbind("change:template",this._setContent,this),this.model.set({template:this.codeEditor.getValue(),fields:this._generateFields(),template_name:""}),this.model.bind("change:template",this._setContent,this)):this._parseErrors(b)},_generateFields:function(){var a=this,b=this.getColumnNames(),c=[];return _.each(b,function(b,d){c.push({position:a.model.getFieldPos(b),name:b,title:!0})}),c},clean:function(){this.$("textarea").unbind("keydown",null,null),cdb.admin.mod.InfowindowBasePane.prototype.clean.call(this)}}),cdb.admin.mod.InfoWindowTab=cdb.core.View.extend({_CUSTOM_TEMPLATES_PATH:"table/views/infowindow/custom_templates",_THEMES:[["light","infowindow_light"],["dark","infowindow_dark"],["header blue","infowindow_light_header_blue"],["header green","infowindow_light_header_green"],["header yellow","infowindow_light_header_yellow"],["header orange","infowindow_light_header_orange"],["image header","infowindow_header_with_image"]],_TEXTS:{title_tab:{enabled:_t("Change title labels"),disabled:_t("No titles selected")}},events:{},initialize:function(){this.selectedAll=!0,this.table=this.options.table,this.template=this.getTemplate("table/menu_modules/views/infowindow_tabs"),this._initBinds()},render:function(){return this.clearSubViews(),this.$el.html(this.template({})),this._renderComponents(),this._setupPane(),this},_initBinds:function(){this.table.bind("change:schema",this._onFieldsChange,this),this.table.linkToInfowindow(this.model),this.add_related_model(this.table),this.model.bind("change:template",this._onChangeTemplate,this),this.model.bind("change:fields",this._onFieldsChange,this),cdb.god.bind("end_show",this._refreshHTMLEditor,this),this.add_related_model(cdb.god)},_renderComponents:function(){this.themes=new cdb.forms.Combo({className:"form_combo left",property:"template_name",extra:this._THEMES,model:this.model}),this.$(".header").append(this.themes.render().el),this.addView(this.themes),this.model.get("width")||this.model.set({width:226},{silent:!0}),this.width=new cdb.forms.Spinner({model:this.model,property:"width",min:145,max:400,width:28}),this.$(".header .controls").append(this.width.render().el),this.addView(this.width)},_setupTipsy:function(){var a={gravity:"s",html:!0,live:!0,fade:!0,title:function(){return $(this).attr("data-tipsy")}};this.$(".menu a[href]:not([href='#/html'])").tipsy(a),a.gravity="se",this.$(".menu a[href='#/html']").tipsy(a)},_destroyTripsy:function(){this.$(".menu a").each(function(a,b){$(b).data("tipsy")&&($(b).unbind("mouseenter mouseleave"),$(b).removeData("tipsy"))})},_setupPane:function(){this._setupTipsy(),this.infowindow_tabs=new cdb.admin.Tabs({el:this.$(".menu ul"),slash:!0}),this.addView(this.infowindow_tabs),this.infowindow_panes=new cdb.ui.common.TabPane({el:this.$(".pane")}),this.addView(this.infowindow_panes),this.fields_pane=new cdb.admin.mod.InfowindowFieldsPane({table:this.options.table,model:this.model}),this.infowindow_panes.addTab("fields",this.fields_pane),this.infowindow_panes.addTab("title",new cdb.admin.mod.InfowindowTitlePane({table:this.options.table,model:this.model,fields_pane:this.fields_pane})),this.infowindow_panes.addTab("html",new cdb.admin.mod.InfowindowHTMLPane({table:this.options.table,model:this.model,template_url:this._CUSTOM_TEMPLATES_PATH})),this.infowindow_tabs.linkToPanel(this.infowindow_panes);var a="fields";this.model.get("template")&&(a="html"),this._activePane(a,this.infowindow_panes.getPane(a)),this.infowindow_panes.active(a),this.infowindow_tabs.activate(a),this.infowindow_panes.bind("tabEnabled",this._onEnableTab,this)},getActiveTab:function(){return this.infowindow_panes&&this.infowindow_panes.activeTab},_activePane:function(a,b){$(".tipsy:last").remove(),"html"==a?(this.$(".form_combo").hide(),this.$(".doc_info").show(),this.$(".controls").addClass("margin"),this.$(".header h3").text("Custom HTML")):(this.$(".form_combo").show(),this.$(".doc_info").hide(),this.$(".controls").removeClass("margin"),this.$(".header h3").text("")),"html"==a?(this._refreshHTMLEditor(),this.$el.addClass("editing_html editor")):this.$el.removeClass("editing_html editor"),this.model.get("template")&&"html"!==a?this.$(".header .blocked").show():this.$(".header .blocked").hide();var c={left:32,right:"auto"};"html"==a?c={right:29,left:"auto"}:"title"==a&&(c={right:68,left:"auto"}),this.$(".menu .tip").css(c)},setActiveTab:function(a){this.infowindow_panes.active(a),this.infowindow_tabs.activate(a)},_onEnableTab:function(a,b){this._activePane(a,b),this.trigger("tabChanged",a,this)},_onFieldsChange:function(a){var b=_.filter(this.model.get("fields"),function(a){return a.title}),c=this.getColumnNames(),d=this.infowindow_tabs.getTab("title");0==b.length||0==c.length?(this.infowindow_panes.removeTab("title"),this.infowindow_tabs.disable("title"),d.attr("data-tipsy",this._TEXTS.title_tab.disabled)):this.infowindow_panes.getPane("title")||(this.infowindow_panes.addTab("title",new cdb.admin.mod.InfowindowTitlePane({table:this.options.table,model:this.model,fields_pane:this.fields_pane}),{active:!1}),this.infowindow_tabs.enable("title"),d.attr("data-tipsy",this._TEXTS.title_tab.enabled))},_onChangeTemplate:function(){this._activePane(this.infowindow_panes.activeTab,this.infowindow_panes.getActivePane())},_refreshHTMLEditor:function(){if(this.infowindow_panes&&"html"==this.infowindow_panes.activeTab){var a=this.infowindow_panes.getPane("html");a&&a.codeEditor&&(a.codeEditor.refresh(),a.adjustCodeEditorSize())}},getColumnNames:function(){var a=this,b=this.options.table.columnNames();return _(b).filter(function(b){return!_.contains(a.model.SYSTEM_COLUMNS,b)})},clean:function(){this._destroyTripsy(),cdb.core.View.prototype.clean.call(this)}}),cdb.admin.mod.InfowindowTitlePane=cdb.admin.mod.InfowindowBasePane.extend({className:"titlePane",initialize:function(){this.fields_pane=this.options.fields_pane,this._setupModel(),this._setupTemplate(),this.render()},render:function(){return this.clearSubViews(),this.$el.html(this.template),this._toggleContent(),this.renderFields(),this},_setupModel:function(){this.model.bind("change:fields",this.render,this),this.model.bind("change:template",this._toggleContent,this),this.options.table.bind("change:schema",this.render,this),this.add_related_model(this.options.table)},_setupTemplate:function(){this.template=this.getTemplate("table/views/infowindow/infowindow_title_pane")},renderFields:function(){var a=this,b=this.$(".fields"),c=this.getColumnNames();return 0==c.length?!1:(this.fields_pane&&(c=[],this.fields_pane.$("ul.fields li").each(function(a,b){c.push($(b).find("span.ellipsis").text())})),void _(c).each(function(c){var d=!1;if(a.model.containsField(c)){var e=_.indexOf(_(a.model.get("fields")).pluck("name"),c);d=a.model.get("fields")[e]&&a.model.get("fields")[e].title}var f={name:c,title:d},g=new cdb.admin.mod.InfowindowFieldItem({model:a.model,field:f,position:a.model.getFieldPos(c)});a.addView(g),b.append(g.render().el)}))}}),cdb.admin.mod.TooltipTab=cdb.admin.mod.InfoWindowTab.extend({_CUSTOM_TEMPLATES_PATH:"table/views/tooltip/custom_templates",_THEMES:[["light","tooltip_light"],["dark","tooltip_dark"]],_renderComponents:function(){this.themes=new cdb.forms.Combo({className:"form_combo left",property:"template_name",extra:this._THEMES,model:this.model}),this.$(".header").append(this.themes.render().el),this.addView(this.themes),this.$(".controls").remove()}}),cdb.admin.mod.LegendWidget=cdb.core.View.extend({className:"cartodb-legends",initialize:function(){this.map=this.options.map,this._setupTemplates(),this.map.layers.bind("change",this.render,this)},_setupTemplates:function(){this.template=_.template('<%- count %> active legend<%- (count == 1) ? "" : "s" %>')},_getLegends:function(){var a=this,b=[];return _.each(this.map.layers.models,function(c){if("layergroup"==c.get("type"))for(var d=a.mapView.getLayerByCid(c.cid),e=0;e<d.getLayerCount();++e){var f=d.getLayer(e);b.push(new cdb.geo.ui.Legend({type:f.legend.get("type"),data:f.legend.items.toJSON()}))}else("CartoDB"===c.get("type")||"torque"===c.get("type"))&&b.push(new cdb.geo.ui.Legend({type:c.legend.get("type"),data:c.legend.items.toJSON()}))}),b},_getLegendsCount:function(){var a=0;return _.each(this.map.layers.models,function(b){if("layergroup"==b.get("type"))for(var c=this.mapView.getLayerByCid(b.cid),d=0;d<c.getLayerCount();++d){var e=c.getLayer(d);e.legend.items.length>0&&e.get("visible")&&null!=e.legend.get("type")&&a++}else"CartoDB"!==b.get("type")&&"torque"!==b.get("type")||!b.get("visible")||null==b.legend.get("type")||(b.legend.items.length>0||b.legend.get("template"))&&a++},this),a},render:function(){return this.$el.html(this.template({count:this._getLegendsCount()})),this}}),cdb.admin.mod.LegendEditorCollection=Backbone.Collection.extend({}),cdb.admin.mod.LegendEditorItem=cdb.core.View.extend({tagName:"li",events:{"click .title":"_onClickTitle","click .sync":"_onClickSync","click .remove":"_removeItem"},initialize:function(){_.bindAll(this,"_onChangeTitle","_onToggleShowTitle","_onToggleSync"),this.template=this.options.template_name?this.getTemplate(this.options.template_name):this.getTemplate("table/menu_modules/legends/views/legend_item"),this.add_related_model(this.model),this.removable=void 0===this.options.removable?!0:!1,this.title=void 0===this.options.title?"":this.options.title,this.showSwitch=void 0===this.options.showSwitch?"":this.options.showSwitch,this.model.bind("change:title",this._onChangeTitle),this.model.bind("change:show_title",this._onToggleShowTitle),this.model.bind("change:sync",this._onToggleSync)},render:function(){var a=_.extend(this.model.toJSON(),{title:this.title,sync:this.model.get("sync"),show_switch:this.showSwitch,removable:this.removable});return this.$el.append(this.template(a)),this._addEditInPlace(),this.title||this._addColorForm(),this},_onToggleSync:function(){this.model.get("sync")?this.$el.find(".checkbox.sync").addClass("enabled"):this.$el.find(".checkbox.sync").removeClass("enabled")},_onChangeTitle:function(){this.model.get("title")&&!this.model.get("show_title")?this.model.set("show_title",!0):!this.model.get("title")&&this.model.get("show_title")&&this.model.set("show_title",!1)},_onToggleShowTitle:function(){this.model.get("show_title")?this.$el.find(".title").addClass("enabled"):this.$el.find(".title").removeClass("enabled")},_onClickSync:function(a){a.preventDefault(),a.stopPropagation(),this.model.set("sync",!this.model.get("sync"))},_onClickTitle:function(a){a.preventDefault(),a.stopPropagation(),this.model.set("show_title",!this.model.get("show_title"))},_removeItem:function(a){a.preventDefault(),a.stopPropagation(),this.trigger("remove",this)},_addEditInPlace:function(){this.editInPlace=new cdb.admin.EditInPlace({observe:this.options.observe,model:this.model,maxWidth:this.options.maxWidth,stripHTML:!0,el:this.$el.find(".input")}),this.editInPlace.bind("change",function(a){("Left label"==this.model.get("name")||"Right label"==this.model.get("name"))&&this.model.set("custom_value",!0)}),this.addView(this.editInPlace)},_addColorForm:function(){if("category"==this.options.filter_type||"color"==this.options.filter_type||"custom"==this.options.filter_type||"choropleth"==this.options.filter_type){var a=this,b=new cdb.core.Model,c=this.model.get("value")||"",d=-1!=c.indexOf("http"),e=d?"":c,f=d?c:"";b.set({color:e,file:f}),b.bind("change:color change:file",function(b){var c=b.changed.color||b.changed.file;c&&a.model.set("value",c)}),this.colorForm=new cdb.forms.Color({model:b,property:"color",extra_colors:this.options.extra_colors,extra:{image_property:"file"}})}else this.colorForm=new cdb.forms.Color({model:this.model,property:"value",extra_colors:this.options.extra_colors});this.$el.find("span.field").append(this.colorForm.render().el),this.addView(this.colorForm)}}),cdb.admin.mod.LegendEditor=cdb.admin.Module.extend({type:"tool",buttonClass:"legends_mod",className:"legends_panel",events:{"click .reset":"_onResetClick"},initialize:function(){this.template=this.getTemplate("table/menu_modules/legends/views/legends"),this.model.bind("change:template",this._onChangeTemplate,this),cdb.god.bind("end_show",this._refreshHTMLEditor,this)},clean:function(){cdb.god.unbind("end_show",this._refreshHTMLEditor,this),cdb.admin.Module.prototype.clean.call(this)},getModuleAction:function(){var a=this.legend_panes.activeTab,b=this._ACTION;return"html"==a&&(b={type:"show",width:600}),b},_onResetClick:function(a){this.killEvent(a),this.model.set({template:""});var b=this.legend_panes.getPane("fields");if(b.currentLegendPane&&b.currentLegendPane.wizardProperties){var c=b.currentLegendPane.wizardProperties.get("type");"polygon"!=c?this.model.set({type:c}):this.model.set({type:"none"})}this.trigger("reset",this)},_setupLegendPane:function(){this._setupTipsy(),this.legend_tabs=new cdb.admin.Tabs({el:this.$(".menu ul"),slash:!0}),this.addView(this.legend_tabs),this.legend_panes=new cdb.ui.common.TabPane({el:this.$(".pane")}),this.addView(this.legend_panes),this.legend_panes.addTab("fields",new cdb.admin.mod.LegendFieldsPane({table:this.options.table,dataLayer:this.options.dataLayer,availableLegends:this.options.availableLegends,model:this.model})),this.legend_panes.addTab("html",new cdb.admin.mod.LegendHTMLPane({table:this.options.table,model:this.model})),this.legend_tabs.linkToPanel(this.legend_panes);var a="fields";this.model.get("template")&&(a="html"),this._activePane(a,this.legend_panes.getPane(a)),this.legend_panes.active(a),this.legend_tabs.activate(a),this.legend_panes.bind("tabEnabled",this._onEnableTab,this)},_setupTipsy:function(){var a={html:!0,live:!0,fade:!0};a.el=this.$(".menu a[href='#/fields']"),a.gravity="s";var b=new cdb.common.TipsyTooltip(a);this.addView(b),a.el=this.$(".menu a[href='#/html']"),a.gravity="se";var c=new cdb.common.TipsyTooltip(a);this.addView(c)},_toggleContent:function(){this.model.get("template")?(this.$el.addClass("disabled"),this.$(".blocked").show()):(this.$el.removeClass("disabled"),this.$(".blocked").hide())},_onEnableTab:function(a,b){this._activePane(a,b),this.triggerModuleAction()},_onChangeTemplate:function(){this._activePane(this.legend_panes.activeTab,this.legend_panes.getActivePane())},_activePane:function(a,b){$(".tipsy:last").remove(),"html"==a?this.$(".form_combo").hide():this.$(".form_combo").show(),"fields"==a?this.$(".header h3").text("Design"):"html"==a&&this.$(".header h3").text("Custom HTML"),"html"==a?(this._refreshHTMLEditor(),this.$el.addClass("editing_html editor")):this.$el.removeClass("editing_html editor"),this.model.get("template")&&"html"!==a?this.$(".header .blocked").show():this.$(".header .blocked").hide();var c={left:32,right:"auto"};"html"==a&&(c={right:29,left:"auto"}),this.$(".menu .tip").css(c)},setActiveTab:function(a){this.legend_panes.active(a),this.legend_tabs.activate(a)},_refreshHTMLEditor:function(){if(this.legend_panes&&"html"==this.legend_panes.activeTab){var a=this.legend_panes.getPane("html");a&&a.codeEditor&&(a.codeEditor.refresh(),a.adjustCodeEditorSize())}},render:function(){return this.clearSubViews(),this.$el.html(this.template),this._toggleContent(),this._setupLegendPane(),this}}),cdb.admin.mod.NoneLegend=cdb.core.View.extend({_FILTER_NAME:"none",initialize:function(){this._setupTemplates(),this.render()},_setupTemplates:function(){this.template=this.getTemplate("table/menu_modules/legends/views/none_legend_pane")},_calculateItems:function(){},refresh:function(){},
render:function(){return this.clearSubViews(),this.$el.html(this.template),this.$el.find(".no_content").show(),this}}),cdb.admin.mod.CustomLegend=cdb.core.View.extend({_FILTER_NAME:"custom",events:{"click .add":"_addItem"},initialize:function(){this._setupTemplates(),this.wizardProperties=this.options.wizardProperties,this.legendItems=[],this.items=this.model.items},_setupTemplates:function(){this.template=this.getTemplate("table/menu_modules/legends/views/custom_legend_pane"),this.item_template_name="table/menu_modules/legends/views/custom_legend_item"},refresh:function(){},_calculateItems:function(){},_addItem:function(a){a.preventDefault(),a.stopPropagation();var b=new cdb.geo.ui.LegendItemModel({name:"Untitled",value:"#cccccc",sync:!0});this.items.add(b)},_renderItems:function(){this.legendItems=[],this.items.length>0?(this.$el.find(".no_content").hide(),this.items.each(this._renderItem,this),this.titleEditor.show()):(this.$el.find(".no_content").show(),this.titleEditor.hide())},_renderItem:function(a){var b=new cdb.admin.mod.LegendEditorItem({model:a,observe:"name",filter_type:this._FILTER_NAME,template_name:this.item_template_name,extra_colors:this.options.extra_colors});b.bind("remove",this._removeItem,this),this.$el.find("ul").append(b.render().$el),this.addView(b),this.legendItems.push(b)},_removeItem:function(a){this.items.remove(a.model)},render:function(){return this.clearSubViews(),this.titleEditor=new cdb.admin.mod.LegendEditorItem({className:"title",model:this.model,observe:"title",title:"Title",maxWidth:120,showSwitch:!0,removable:!1,template_name:"table/menu_modules/legends/views/custom_legend_item"}),this.$el.html(this.template),this.$el.find("ul").append(this.titleEditor.render().$el),this.addView(this.titleEditor),this._renderItems(),this}}),cdb.admin.mod.BubbleLegend=cdb.admin.mod.CustomLegend.extend({_FILTER_NAME:"bubble",_setupTemplates:function(){this.template=this.getTemplate("table/menu_modules/legends/views/bubble_legend_pane"),this.itemTemplates={text:"table/menu_modules/legends/views/legend_item_text",color:"table/menu_modules/legends/views/legend_item_color"}},_setupSync:function(a,b){this.leftLabel=a,this.rightLabel=b,this.leftSync=!1,this.rightSync=!1,this.items&&this.items.length>1&&"bubble"===this.items.at(0).get("legend_type")&&(this.leftSync=this.items.at(0).get("sync"),this.rightSync=this.items.at(1).get("sync"),this.leftLabel=this.leftSync?this.items.at(0).get("value"):this.leftLabel,this.rightLabel=this.rightSync?this.items.at(1).get("value"):this.rightLabel)},_calculateItems:function(){var a=[],b=this.wizardProperties.get("marker-fill"),c=this.wizardProperties.get("metadata");if(c){var d=c[0],e=_.last(c);this._setupSync(d,e),a.push(new cdb.geo.ui.LegendItemModel({legend_type:"bubble",name:"Left label",type:"text",sync:this.leftSync,value:this.leftLabel})),a.push(new cdb.geo.ui.LegendItemModel({legend_type:"bubble",name:"Right Label",type:"text",sync:this.rightSync,value:this.rightLabel})),a.push(new cdb.geo.ui.LegendItemModel({name:"Color",type:"color",value:b})),this.items.reset(a)}},_renderItem:function(a){var b=new cdb.admin.mod.LegendEditorItem({model:a,observe:"value",showSwitch:!0,template_name:this.itemTemplates[a.get("type")],extra_colors:this.options.extra_colors});this.$el.find("ul").append(b.render().$el),this.addView(b),this.legendItems.push(b)}}),cdb.admin.mod.CategoryLegend=cdb.admin.mod.CustomLegend.extend({_FILTER_NAME:"category",_setupTemplates:function(){this.template=this.getTemplate("table/menu_modules/legends/views/category_legend_pane"),this.item_template_name="table/menu_modules/legends/views/category_legend_item"},refresh:function(a){var b=[];this.categories=!0,_.each(a,function(a){var c={name:a.get("name"),value:a.get("color")||a.get("file")||a.get("value")};b.push(new cdb.geo.ui.LegendItemModel(c))}),this.items.reset(b)},_calculateItems:function(){var a=[];return this.temp=!1,this.categories=this.wizardProperties.get("categories"),this.colors=this.wizardProperties.get("colors"),this.colors&&this.items&&this.items.length>0?(this.temp=!0,void(this.colors=null)):(this.categories&&_.each(this.categories,function(b){var c={name:b.title,value:b.file||b.color};a.push(new cdb.geo.ui.LegendItemModel(c))}),void this.items.reset(a))},_renderItems:function(){this.categories||this.temp?(this.$el.find(".no_content").hide(),this.items.each(this._renderItem,this)):this.$el.find(".no_content").show()},_renderItem:function(a){var b=new cdb.admin.mod.LegendEditorItem({model:a,observe:"value",filter_type:this._FILTER_NAME,template_name:this.item_template_name,extra_colors:this.options.extra_colors});this.$el.find("ul").append(b.render().$el),this.addView(b),this.legendItems.push(b)}}),cdb.admin.mod.ChoroplethLegend=cdb.admin.mod.CustomLegend.extend({_FILTER_NAME:"choropleth",_setupTemplates:function(){this.template=this.getTemplate("table/menu_modules/legends/views/choropleth_legend_pane"),this.item_templates=[],this.item_templates.text="table/menu_modules/legends/views/legend_item_text",this.item_templates.color="table/menu_modules/legends/views/choropleth_legend_item"},_calculateItems:function(){var a=[];this.metadata=this.wizardProperties.get("metadata")||[];var b={"3 Buckets":3,"5 Buckets":5,"7 Buckets":7},c=b[this.wizardProperties.get("method")],d=cdb.admin.color_ramps[this.wizardProperties.get("color_ramp")][c],e=this.model.get("items")&&this.model.get("items")[0]&&this.model.get("items")[0].custom_value,f=e?this.model.get("items")[0].value:parseFloat(this.metadata[0]||0,10).toFixed(2),g={type:"text",name:"Left label",value:f};e&&(g.custom_value=!0),a.push(new cdb.geo.ui.LegendItemModel(g));var h=this.model.get("items")&&this.model.get("items")[1]&&this.model.get("items")[1].custom_value,i=h?this.model.get("items")[1].value:parseFloat(this.metadata[this.metadata.length-1]||0,10).toFixed(2),g={type:"text",name:"Right label",value:i};h&&(g.custom_value=!0),a.push(new cdb.geo.ui.LegendItemModel(g)),_.each(d,function(b){a.push(new cdb.geo.ui.LegendItemModel({type:"color",name:"Color",value:b}))}),this.items.reset(a)},_addItem:function(a){a.preventDefault(),a.stopPropagation();var b=new cdb.geo.ui.LegendItemModel({type:"color",name:"Color",value:"#cccccc"});this.items.add(b)},_renderItem:function(a){var b=new cdb.admin.mod.LegendEditorItem({model:a,observe:"value",removable:!0,filter_type:this._FILTER_NAME,template_name:this.item_templates[a.get("type")],extra_colors:this.options.extra_colors});b.bind("remove",this._removeItem,this),this.$el.find("ul").append(b.render().$el),this.addView(b),this.legendItems.push(b)}}),cdb.admin.mod.ColorLegend=cdb.admin.mod.CustomLegend.extend({_FILTER_NAME:"color",_setupTemplates:function(){this.template=this.getTemplate("table/menu_modules/legends/views/color_legend_pane"),this.item_template_name="table/menu_modules/legends/views/color_legend_item"},refresh:function(a){var b=[];this.colors=!0,_.each(a,function(a){b.push(new cdb.geo.ui.LegendItemModel({name:a.get("name"),value:a.get("value")}))}),this.items.reset(b)},_calculateItems:function(){var a=[];this.colors=this.wizardProperties.get("colors"),this.colors&&_.each(this.colors,function(b){a.push(new cdb.geo.ui.LegendItemModel({name:b[0],value:b[1]}))}),this.items.reset(a)},_renderItems:function(){this.colors?(this.$el.find(".no_content").hide(),this.items.each(this._renderItem,this)):this.$el.find(".no_content").show()},_renderItem:function(a){var b=new cdb.admin.mod.LegendEditorItem({model:a,observe:"value",filter_type:this._FILTER_NAME,template_name:this.item_template_name});this.$el.find("ul").append(b.render().$el),this.addView(b),this.legendItems.push(b)}}),cdb.admin.mod.DensityLegend=cdb.admin.mod.CustomLegend.extend({_FILTER_NAME:"density",_setupTemplates:function(){this.template=this.getTemplate("table/menu_modules/legends/views/density_legend_pane"),this.item_templates=[],this.item_templates.text="table/menu_modules/legends/views/legend_item_text",this.item_templates.color="table/menu_modules/legends/views/legend_item_color"},_setupSync:function(){this.leftLabel="less",this.rightLabel="more",this.leftSync=!0,this.rightSync=!0,this.items&&this.items.length>1&&"density"==this.items.at(0).get("legend_type")&&(this.leftSync=this.items.at(0).get("sync"),this.rightSync=this.items.at(1).get("sync"),this.leftLabel=this.leftSync?this.items.at(0).get("value"):this.leftLabel,this.rightLabel=this.rightSync?this.items.at(1).get("value"):this.rightLabel)},_calculateItems:function(){var a=[],b={"3 Buckets":3,"5 Buckets":5,"7 Buckets":7},c=b[this.wizardProperties.get("method")],d=cdb.admin.color_ramps[this.wizardProperties.get("color_ramp")][c];this._setupSync(),a.push(new cdb.geo.ui.LegendItemModel({legend_type:"density",type:"text",name:"Less",sync:this.leftSync,value:this.leftLabel})),a.push(new cdb.geo.ui.LegendItemModel({legend_type:"density",type:"text",name:"More",sync:this.rightSync,value:this.rightLabel})),_.each(d,function(b){a.push(new cdb.geo.ui.LegendItemModel({type:"color",name:"Color",value:b}))}),this.items.reset(a)},_renderItem:function(a){var b=new cdb.admin.mod.LegendEditorItem({model:a,observe:"value",showSwitch:!0,template_name:this.item_templates[a.get("type")],extra_colors:this.options.extra_colors});this.$el.find("ul").append(b.render().$el),this.addView(b),this.legendItems.push(b)}}),cdb.admin.mod.IntensityLegend=cdb.admin.mod.CustomLegend.extend({_FILTER_NAME:"intensity",_setupTemplates:function(){this.template=this.getTemplate("table/menu_modules/legends/views/intensity_legend_pane"),this.item_templates=[],this.item_templates.text="table/menu_modules/legends/views/legend_item_text",this.item_templates.color="table/menu_modules/legends/views/legend_item_color"},_setupSync:function(){this.leftLabel="Less",this.rightLabel="More",this.leftSync=!0,this.rightSync=!0,this.items&&this.items.length>1&&"intensity"==this.items.at(0).get("legend_type")&&(this.leftSync=this.items.at(0).get("sync"),this.rightSync=this.items.at(1).get("sync"),this.leftLabel=this.leftSync?this.items.at(0).get("value"):this.leftLabel,this.rightLabel=this.rightSync?this.items.at(1).get("value"):this.rightLabel)},_calculateItems:function(){var a=[];this.color=this.wizardProperties.get("marker-fill"),this._setupSync(),a.push(new cdb.geo.ui.LegendItemModel({legend_type:"intensity",type:"text",name:"Left label",sync:this.leftSync,value:this.leftLabel})),a.push(new cdb.geo.ui.LegendItemModel({legend_type:"intensity",type:"text",name:"Right label",sync:this.rightSync,value:this.rightLabel})),a.push(new cdb.geo.ui.LegendItemModel({type:"color",name:"Color",value:this.color})),this.items.reset(a)},_renderItem:function(a){var b=new cdb.admin.mod.LegendEditorItem({model:a,observe:"value",showSwitch:!0,filter_type:"intensity",template_name:this.item_templates[a.get("type")],extra_colors:this.options.extra_colors});this.$el.find("ul").append(b.render().$el),this.addView(b),this.legendItems.push(b)}}),cdb.admin.mod.LegendFieldsPane=cdb.core.View.extend({className:"fieldPane",wizardTypeToLegend:{torque_cat:"category"},initialize:function(){this.template=this.getTemplate("table/menu_modules/legends/views/legend_fields_pane"),this.dataLayer=this.options.dataLayer,this.availableLegends=this.options.availableLegends,this._setupModel(),this._setupPanes(),this._setupBindings(),this._setupStorage(),this.render()},_setupModel:function(){this.add_related_model(this.model)},_setupPanes:function(){this.panes&&this.panes.clean(),this.panes=new cdb.ui.common.TabPane({activateOnClick:!0}),this.addView(this.panes)},_setupBindings:function(){var a=this;this.add_related_model(this.dataLayer),this.dataLayer.wizard_properties.bind("change",this._onWizardChange,this),this.dataLayer.bind("change:tile_style",this._onStyleChange,this),this.add_related_model(this.dataLayer.wizard_properties),this.model.bind("change:template",this._toggleContent,this),this.model.bind("change:items",function(){a._saveState(),a.currentLegendPane.render()},this)},_saveState:function(){"custom"==this.model.get("type")&&this._saveItems()},_setupStorage:function(){version="_3.0",this.storageKey=this.dataLayer.get("table_name")+version,this.savedItems=new cdb.admin.localStorage(this.storageKey)},_saveItems:function(){this.savedItems.set(this.model.get("items"))},_getSavedItems:function(){return this.savedItems.get()},_loadSavedItems:function(){var a=this.savedItems.get();a&&this.model.items.reset(a)},_enableLegend:function(a){var b=["none","custom",a];_.each(this.availableLegends,function(a){a.enabled=_.contains(b,a.name)?!0:!1})},_getLegendType:function(){var a=this.dataLayer.wizard_properties.get("type");return this.wizardTypeToLegend[a]&&(a=this.wizardTypeToLegend[a]),a},_enableLegendFromWizard:function(){var a=this._getLegendType();a&&this._enableLegend(a)},_loadTab:function(a,b){this._activatePane(a),this.currentLegendPane.wizardProperties=this.dataLayer.wizard_properties,"custom"===a&&"category"!==b?this._loadSavedItems():"custom"!==a&&this.currentLegendPane._calculateItems(),this._changeColors(),this.currentLegendPane.render()},_activatePane:function(a){this.panes.active(a),this.currentLegendPane=this.panes.getActivePane()},_reloadActiveTab:function(){var a=this.model.get("type")||"none";this._activatePane(a),a&&this.currentLegendPane&&this.currentLegendPane.model.get("type")&&(this.currentLegendPane.render(),this.currentLegendPane.refresh(this.model.items.models),this._enableLegendFromWizard())},_onWizardChange:function(a){var b=a.attributes,c=a.previousAttributes(),d=a.get("type"),e=c.type,f=_(b.metadata).difference(c.metadata);if("custom"===this.model.get("type")){var g=this._getLegendType();return this._enableLegend(g),void this._refreshTemplateCombo()}if(d===e){var h=a.get("property"),i=c.property,j=h==i;if("custom"===this.model.get("type"))return;if("category"===d){var k=_.difference(a.get("categories"),c.categories);if(j&&(!k||k&&0===k.length))return}else if("bubble"===d){var l=a.get("marker-fill")==c["marker-fill"],m=a.get("radius_min")==c.radius_min,n=a.get("radius_max")==c.radius_max;if(j&&l&&m&&n&&0===f.length)return}else if("intensity"===d){if(a.get("marker-fill")==c["marker-fill"])return}else if("density"===d||"choropleth"===d){var o=a.get("color_ramp")===c.color_ramp,p=a.get("method")===c.method,q=o&&p;if(q&&("density"===d||"choropleth"===d&&0===f.length))return}}var g=this._getLegendType();if("polygon"!==g||"custom"!==this.model.get("type")){if(_.contains(this._getPanes(),g)||(g="none"),this._enableLegend(g),this._refreshTemplateCombo(),!this.model.get("template")){var r={template:"",type:g};if(0==this._getNumericColumns().length&&("choropleth"==g||"bubble"==g))var r={items:"",template:"",type:"none"};this.model.set(r)}this._loadTab(g)}},_getNumericColumns:function(){var a=this.dataLayer.table;return _.filter(a.columnNamesByType("number"),function(a){return"cartodb_id"!=a})},_getPanes:function(){var a=this.availableLegends;return _.pluck(a,"name")},_getEnabledPanes:function(){var a=_.filter(this.availableLegends,function(a){return a.enabled});return _.pluck(a,"name")},_refreshTemplateCombo:function(){var a=this._getEnabledPanes();this.templates.updateData(a)},_renderTemplateCombo:function(){var a=this._getEnabledPanes();this.templates&&this.templates.clean(),this.templates=new cdb.forms.Combo({property:"type",extra:a,model:this.model}),this.model.unbind("change:type",this),this.model.bind("change:type",function(a,b){var c=a.get("type"),d=a.previous("type");this._loadTab(c,d)},this);var b=this.$(".fields"),c=$("<li>");c.append(this.templates.render().el).append("<span>Template</span>"),b.append(c),this.addView(this.templates)},_getCartoColors:function(){var a=this.options.dataLayer.get("tile_style"),b=new cdb.admin.CartoParser(a),c=b.colorsUsed({mode:"hex"});return c=_.uniq(c),c=_.without(c,"white","WHITE","#fff","#ffffff","#FFF","#FFFFFF"),c=_.without(c,"black","BLACK","#000","#000000")},_changeColors:function(){var a=this._getCartoColors(),b=this.panes.getActivePane();b&&b.legendItems&&(b.options.extra_colors=a,_.each(b.legendItems,function(b){b.colorForm&&b.colorForm.setExtraColors(a)}))},_onStyleChange:function(){this._changeColors()},_capitalize:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},_getExtraLegendNames:function(){var a=this.dataLayer.wizard_properties.get("type");return a?_.intersection(this.options.extraLegends,[a]):null},_renderPanes:function(){this.clearSubViews(),_.each(_.pluck(this.availableLegends,"name"),this._renderPane,this)},_renderPane:function(a){this.wizardTypeToLegend[a]&&(a=this.wizardTypeToLegend[a]);var b=this._capitalize(a+"Legend"),c=new cdb.admin.mod[b]({model:this.model,table_id:this.options.dataLayer.get("id"),wizardProperties:this.dataLayer.wizard_properties});this.panes.addTab(a,c),c.$el.addClass(a)},render:function(){return this.clearSubViews(),this.$el.html(this.template),this.panes.setElement(this.$(".forms")),this._renderPanes(),this._reloadActiveTab(),this._enableLegendFromWizard(),this._renderTemplateCombo(),this._toggleContent(),this.currentLegendPane&&this.currentLegendPane.render(),this._changeColors(),this},_toggleContent:function(){this.model.get("template")?(this.$el.addClass("disabled"),this.$(".blocked").show()):(this.$el.removeClass("disabled"),this.$(".blocked").hide())},_showNoContent:function(){this.$(".no_content").show(),this.$("div.all").hide()}}),cdb.admin.mod.LegendHTMLPane=cdb.core.View.extend({_STORAGE_NAMESPACE:"cdb.localStorage.legend.",_TEXTS:{tip:_t("&lt;script&gt; tags could break your map."),template_error:_t("Error in line {{line}}: {{msg}}")},className:"htmlPane",events:{"click .apply":"_apply"},initialize:function(){_.bindAll(this,"_onKeyUpEditor"),this.template=this.getTemplate("table/menu_modules/legends/views/legend_html_pane"),this.render(),this.model.bind("change:type",this._setContent,this),this.model.bind("change:items",this._resetContent,this),this.model.bind("change:title change:show_title",this._resetContent,this)},render:function(){return this.clearSubViews(),this.$el.html(this.template),this._initEditor(),this._initHelp(),this},_initHelp:function(){this.help=new cdb.admin.mod.HTMLEditorHelp({text:this._TEXTS.tip,localStorageKey:this._STORAGE_NAMESPACE}).bind("hide show",this.adjustCodeEditorSize,this),this.$el.append(this.help.render().$el),this.addView(this.help)},_initEditor:function(){var a=this;this.codeEditor=CodeMirror.fromTextArea(this.$("textarea")[0],{mode:"text/xml",tabMode:"indent",tabSize:2,matchBrackets:!0,lineNumbers:!0,lineWrapping:!0,onKeyEvent:this._onKeyUpEditor,extraKeys:{"Ctrl-Space":function(b){a._showAutocomplete(b)}}}),this._setKeymap(),this._setContent()},_showAutocomplete:function(a){CodeMirror.showHint(a,CodeMirror.hint["custom-list"],{completeSingle:!1,list:_.map(this.model.get("items"),function(a){return a.value})})},_onKeyUpEditor:function(a,b){var c=b.keyCode?b.keyCode:b.which;if("keyup"==b.type&&27!=c){var d=this;this.autocomplete_timeout&&clearTimeout(this.autocomplete_timeout),this.autocomplete_timeout=setTimeout(function(){var b=a.getCursor(),c=a.getTokenAt(b).string;if(c.length>2){var e=_.compact(_.map(d.model.get("items"),function(a){return a&&a.value?a.value:null}));!a.state.completionActive&&c.length>2&&e.length>0&&d._showAutocomplete(a)}},150)}},_setKeymap:function(){var a=navigator.userAgent.toLowerCase(),b=this;this.keymap={so:"rest",combination:"ctrl+s"},/mac os/.test(a)&&(this.keymap={so:"mac",combination:"meta+s"}),this.$("textarea").bind("keydown",this.keymap.combination,function(a){("mac"==b.keymap.so&&a.metaKey||"rest"==b.keymap.so&&a.ctrlKey)&&83==a.keyCode&&(a.preventDefault(),b._apply())})},_setContent:function(){var a=this.model.get("template")||this._getTemplateContent();a=a.replace(/<li(.*?)>/g,"\n	<li$1>\n"),a=a.replace(/<\/li>/g,"\n	</li>"),a=a.replace(/<ul>/g,"\n<ul>"),a=a.replace(/<\/ul>/g,"\n</ul>\n"),this.codeEditor.setValue(a),this._clearErrors()},_resetContent:function(){this.model.get("template")||this._setContent()},_capitalize:function(a){return a&&_.isString(a)?a.charAt(0).toUpperCase()+a.slice(1):""},_getTemplateContent:function(){var a=this.model.get("type"),b=this._capitalize(a)+"Legend";if(!a||"none"==a)return"";if(!cdb.geo.ui[b])return"";var c=new cdb.geo.ui[b]({model:this.model});return"<div class='cartodb-legend "+this.model.get("type")+"'>	"+c.render().$el.html()+"</div>"},_toggleContent:function(){},_getErrors:function(){try{cdb.core.Template.compile(this.codeEditor.getValue(),"mustache")();return{}}catch(a){return a}},_parseErrors:function(a){var b="an error";this.$(".info").addClass("error").html("<p>"+b+"</p>").show(),this.adjustCodeEditorSize()},_clearErrors:function(){this.$(".info").removeClass("error").html("").hide(),this.adjustCodeEditorSize()},adjustCodeEditorSize:function(){var a=this.$(".info").is(":visible")?this.$(".info").outerHeight():0,b=this.$(".help-tip").is(":visible")?this.$(".help-tip").outerHeight():0;this.$(".CodeMirror-wrap").css({bottom:a+80,top:b+-5})},_onSQLApplied:function(){this.model.get("template")&&this._apply()},_apply:function(a){a&&a.preventDefault&&a.preventDefault(),this.model.unbind("change:template",this._setContent,this),this.model.set({template:this.codeEditor.getValue()}),this.model.bind("change:template",this._setContent,this),this.model.get("template")||this.model.set("template",this._getTemplateContent())},clean:function(){this.$("textarea").unbind("keydown",null,null),cdb.core.View.prototype.clean.call(this)}}),cdb.admin.mod=cdb.admin.mod||{},cdb.admin.mod.SQL=cdb.admin.Module.extend({_TEXTS:{tip:"<strong>Ctrl + SPACE</strong> to autocomplete. <strong><%- key %> + S</strong> to apply your query."},_ACTION:{type:"show",width:600},buttonClass:"sql_mod",type:"tool",className:"sql_panel",events:{"click .actions a.clearview":"_clearView","click .actions button":"applyQuery","click .actions a.next":"_do","click .actions a.back":"_undo","click .doc_info":"_showDoc"},initialize:function(){_.bindAll(this,"_onKeyUpEditor");this.user=this.options.user,this.template=this.getTemplate("table/menu_modules/views/sql"),this.model.bind("change:table_name",this._replaceSQL,this),this.model.bind("change:query",this._updateSQL,this),this.model.bind("change:query_generated",this._updateQueryInfo,this),this.model.bind("errorSQLView",this._onSQLError,this);var a=this.model.get("query_history"),b=(this.model.query_history_position,this.model.get("query")||this._defaultSQL());this.model.query_history_position=_.indexOf(a,b)||0,this.add_related_model(this.model),this._initBinds(),this.user.fetchTables(),cdb.god.bind("end_show",this.activated,this),this.add_related_model(cdb.god)},render:function(){return this.clearSubViews(),this.$el.append(this.template({})),this._initEditor(),this._initHelp(),this._updateSQL(),this._updateQueryInfo(),this._adjustCodeEditorSize(),this},_initBinds:function(){var a=navigator.userAgent.toLowerCase(),b="rest",c="ctrl+s",d=this;/mac os/.test(a)&&(c="meta+s",b="mac"),this.$el.bind("keydown",c,function(a){("mac"==b&&a.metaKey||"rest"==b&&a.ctrlKey)&&83==a.keyCode&&(a.preventDefault(),d.applyQuery())})},_initEditor:function(){var a=this;this.codeEditor=CodeMirror.fromTextArea(this.$("textarea")[0],{mode:"text/x-postgres",tabMode:"indent",matchBrackets:!0,lineNumbers:!0,lineWrapping:!0,onKeyEvent:this._onKeyUpEditor,extraKeys:{"Ctrl-Space":function(b){a._showAutocomplete(b)}}}),this.$("textarea").bind("keyup",this._checkSubmit.bind(this)),this.$("a.next, a.back").tipsy({gravity:"s",fade:!0})},_initHelp:function(){var a="rest",b=navigator.userAgent.toLowerCase();/mac os/.test(b)&&(a="mac");var c=new cdb.admin.mod.HTMLEditorHelp({localStorageKey:this._STORAGE_NAMESPACE+this.model.table.get("id"),text:_.template(this._TEXTS.tip)({key:"mac"==a?"CMD":"Ctrl"})}).bind("hide show",this._adjustCodeEditorSize,this);this.$el.append(c.render().$el),this.addView(c)},activated:function(){this.codeEditor&&(this.codeEditor.refresh(),this.codeEditor.focus(),this._adjustCodeEditorSize())},_defaultSQL:function(){return"SELECT * FROM "+this.model.get("table_name")},_replaceSQL:function(){this.model.get("query")||this.codeEditor.setValue(this._defaultSQL())},_onSQLError:function(a){try{var b=JSON.parse(a.responseText);this._parseError(b.errors||b.error)}catch(c){this._parseError([_t("unknown error")])}this._toggleClearView("error")},_updateSQL:function(){if(this.trigger("clearError"),this.codeEditor){this._clearErrors();var a=(this.model.get("query"),this.codeEditor.getValue()),b=!1;a&&cdb.admin.CartoDBTableMetadata.alterTable(a)&&(b=!0),b||(this.codeEditor.setValue(this.model.get("query")||this._defaultSQL()),this.codeEditor.refresh()),this.model.get("query_history")&&this._checkDoButtons()}this._toggleClearView(this.model.get("query"))},_toggleClearView:function(a){a?this.$el.find("a.clearview").show():this.$el.find("a.clearview").hide()},_clearView:function(a){return a.preventDefault(),this.model.clearSQLView(),!1},_onKeyUpEditor:function(a,b){var c=b.keyCode?b.keyCode:b.which;if("keyup"==b.type&&27!=c){var d=this;this.autocomplete_timeout&&clearTimeout(this.autocomplete_timeout),this.autocomplete_timeout=setTimeout(function(){var b=a.getCursor(),c=a.getTokenAt(b).string,e=d.model.table.get("schema");if(e&&c.length>2){var f=_.union(d.model.table.get("schema"),d._getTableName()),g=_.compact(_.map(f,function(a){try{return a.length>0&&-1!=a[0].search(c)?a[0]:null}catch(b){return null}}));!a.state.completionActive&&c.length>2&&g.length>0&&d._showAutocomplete(a)}},150)}},_showAutocomplete:function(a){CodeMirror.showHint(a,CodeMirror.hint["custom-list-with-type"],{completeSingle:!1,list:_.union(this._getTableName(),this._getSQLColumns())})},_getTableName:function(){return[[this.model.table.get("name"),"T"]]},_getSQLColumns:function(){return _.map(_.union(this.model.table.get("schema"),[["the_geom_webmercator",0]]),function(a){return[a[0],"C"]})},_checkSubmit:function(a){a.shiftKey&&13===a.keyCode&&(this.killEvent(a),this.applyQuery())},_parseError:function(a){var b=this.$(".actions").outerHeight();this.$(".info").addClass("error").html("<p>"+a.join("<br/>")+"</p>").css({bottom:b+(this.model.get("visible")?0:57)}).show(),this._adjustCodeEditorSize()},_adjustCodeEditorSize:function(){var a=this.$(".info").is(":visible")?this.$(".info").outerHeight():0,b=this.$(".help-tip").is(":visible")?36:0,c=this.model.get("visible")?0:57;this.$(".CodeMirror-wrap").css({bottom:a+c+80,top:b})},_updateQueryInfo:function(){this.model.get("query_generated")?this.$(".info").removeClass("error"):this.$(".info").hide()},_clearErrors:function(){this.$(".info").removeClass("error").html("").hide(),this._adjustCodeEditorSize()},_do:function(a){a.preventDefault();var b=this.model.redoHistory("query");return this.codeEditor&&b&&(this.codeEditor.setValue(b),this._checkDoButtons()),!1},_undo:function(a){a.preventDefault();var b=this.model.undoHistory("query");return this.codeEditor&&b&&(this.codeEditor.setValue(b),this._checkDoButtons()),!1},applyQuery:function(){this._clearErrors();var a=this.codeEditor.getValue();return a=a.replace(/{table_name}/g,this.model.table.get("name")).replace(/;\s*$/g,""),this.user.isInsideOrg()&&(a=this.qualifyTables(a)),this.model.applySQLView(a),cdb.god.trigger("mixpanel","Performing a query",{sql:a}),cdb.god.trigger("metrics","query",{email:window.user_data.email,data:{sql:a}}),!1},qualifyTables:function(a){var b=this.user.get("username");return _.reduce(this.user.tables,function(a,c){var d,e=new RegExp("([^\\.\\'a-zA-Z0-9_])(\"?)"+c+'("?)',"gi");return d=-1!==b.indexOf("-")?'$1"'+b+'".$2'+c+"$3":"$1"+b+".$2"+c+"$3",a.replace(e,d)},a)},hasChanges:function(){return this.model.get("query")!=this.codeEditor.getValue()},_checkDoButtons:function(){this.model.isHistoryAtLastPosition("query")?this.$el.find("a.next").addClass("disabled"):this.$el.find("a.next").removeClass("disabled"),this.model.isHistoryAtFirstPosition("query")?this.$el.find("a.back").addClass("disabled"):this.$el.find("a.back").removeClass("disabled")},_showDoc:function(a){a.preventDefault();var b=new cdb.admin.PostgresInfo;b.appendToBody().open()}}),cdb.admin.mod.BubbleWizard=cdb.admin.mod.SimpleWizard.extend({error_msg:{NO_CONTENT_MSG:_t("There are no numeric columns on your dataset to make a bubble map.<br/>If you have numbers on your dataset, but you don't see them here is likely they are set as String.")},initialize:function(){this.type="bubble",cdb.admin.mod.SimpleWizard.prototype.initialize.call(this)},isValid:function(){return this._getNumberColumns().length>0},render:function(){return this.isValid()?cdb.admin.mod.SimpleWizard.prototype.render.call(this):this.renderError(this.error_msg.NO_CONTENT_MSG),this}}),cdb.admin.mod.CategoryWizard=cdb.admin.mod.SimpleWizard.extend({_TEXTS:{default_color:_t("Others"),select_column:_t("Select a column"),no_valid_columns:_t("There are no valid columns on your table to make a this visualization.                             Try to add a new one or change the existing ones to a valid type                             (string, number or boolean).")},initialize:function(){this.type=this.type||"category",cdb.admin.mod.SimpleWizard.prototype.initialize.call(this),this.table=this.options.table,this.categories=new Backbone.Collection(this.cartoProperties.get("categories")),this.cartoProperties.bind("change:metadata",this._getMetadata,this),this.categories.bind("change reset",function(){this.cartoProperties.set("categories",this.categories.toJSON())},this),this.cartoProperties.bind("load",this._hideLoader,this),this.cartoProperties.bind("loading",this._showLoader,this),this.add_related_model(this.categories),this._addViews()},_showLoader:function(){this.loader.show()},_hideLoader:function(){this.loader.hide()},render:function(){var a=$("<div>").addClass("wrapper"),b=$("<div>").addClass("content");return this.isValid()?(b.append(this.form.render().el),b.append(this.custom_categories.render().el),b.append(this.error.render().el),b.append(this.loader.render().el),a.append(b),this.custom_scroll&&(this.removeView(this.custom_scroll),this.custom_scroll.clean()),this.custom_scroll=new cdb.admin.CustomScrolls({el:a,parent:a.parent()}),this.addView(this.custom_scroll),this.$el.html(a)):this.renderError(this._TEXTS.no_valid_columns),this},isValid:function(){return this._getColorColumns().length>0},_addViews:function(){this.form=new cdb.forms.Form({form_data:this.cartoProperties.formData(this.type),model:this.cartoProperties}),this.addView(this.form),this.custom_categories=new cdb.admin.mod.CategoryWizard.CategoriesView({collection:this.categories,cartoProperties:this.cartoProperties}),this.addView(this.custom_categories),this.error=new cdb.admin.mod.CategoryWizard.Error,this.addView(this.error),this.loader=new cdb.admin.mod.CategoryWizard.Loader,this.addView(this.loader)},_getMetadata:function(){var a=this.cartoProperties.get("metadata");a&&a.length&&void 0!==a[0].title&&this.categories.reset(a)},comeFromColor:function(){for(var a=_.clone(this.model.get("properties").colors),b=_.clone(this.model.get("properties").categories),c=0,d=a.length;d>c;c++)if(a[c][0]!=b[c].title||a[c][1]!=b[c].color||a[c][2]!=b[c].title_type)return!1;return!0}}),cdb.admin.mod.CategoryWizard.CategoriesView=cdb.core.View.extend({tagName:"ul",className:"custom_categories",initialize:function(){this.collection.bind("add remove reset",this.render,this),this.add_related_model(this.collection)},render:function(){var a=this;return this.clearSubViews(),this.collection.each(function(b){var c=new cdb.admin.mod.CategoryWizard.CategoriesViewItem({model:b,cartoProperties:a.options.cartoProperties});a.$el.append(c.render().el),a.addView(c)}),this}}),cdb.admin.mod.CategoryWizard.CategoriesViewItem=cdb.core.View.extend({tagName:"li",className:"custom_category_item",initialize:function(){this.template=cdb.templates.getTemplate("table/menu_modules/wizards/views/category_wizard_custom_categories")},render:function(){this.clearSubViews(),this.$el.append(this.template(this.model.toJSON()));var a=new cdb.admin.mod.CategoryColor({model:this.model,property:"color",extra:{image_property:"file"
},cartoProperties:this.options.cartoProperties});return this.model.bind("change",this._setModel,this),this.$("span.field").append(a.render().el),this.addView(a),this},_setModel:function(a,b){if(b.changes&&b.changes.file&&a.get("file")){a.get("file");a.set({value_type:"file"},{silent:!0})}else a.set({value_type:"color"},{silent:!0});this._triggerChange()},_triggerChange:function(){this.model.trigger("valueChanged")}}),cdb.admin.mod.CategoryColor=cdb.forms.Color.extend({_createPicker:function(){this.options.cartoProperties&&(this.options.extra_colors=this._getExtraColors()),cdb.forms.Color.prototype._createPicker.call(this)},_getExtraColors:function(){if(!this.options.cartoProperties)return[];var a=this.options.cartoProperties.layer.get("tile_style"),b=new cdb.admin.CartoParser(a);return b.colorsUsed({mode:"hex"})}}),cdb.admin.mod.CategoryWizard.Error=cdb.core.View.extend({tagName:"div",className:"colors_error",initialize:function(){this.template=cdb.templates.getTemplate("table/menu_modules/wizards/views/color_wizard_error")},render:function(){return this.$el.html(this.template()),this}}),cdb.admin.mod.CategoryWizard.Loader=cdb.core.View.extend({tagName:"div",className:"colors_loader",initialize:function(){this.template=cdb.templates.getTemplate("table/menu_modules/wizards/views/color_wizard_loader")},render:function(){return this.$el.html(this.template()),this}}),cdb.admin.mod.ChoroplethWizard=cdb.admin.mod.SimpleWizard.extend({error_msg:{NO_CONTENT_MSG:_t("There are no numeric columns on your dataset to make a choropleth map.<br/>If you have numbers on your dataset, but you don't see them here is likely they are set as String.")},initialize:function(){this.type="choropleth",cdb.admin.mod.SimpleWizard.prototype.initialize.call(this)},isValid:function(){return this._getNumberColumns().length>0},render:function(){return this.isValid()?cdb.admin.mod.SimpleWizard.prototype.render.call(this):this.renderError(this.error_msg.NO_CONTENT_MSG),this}}),cdb.admin.mod.ClusterWizard=cdb.admin.mod.SimpleWizard.extend({MODULES:["legends"],initialize:function(){this.type="cluster",cdb.admin.mod.SimpleWizard.prototype.initialize.call(this)}}),cdb.admin.mod.DensityWizard=cdb.admin.mod.SimpleWizard.extend({MODULES:["legends"],initialize:function(){this.type="density",cdb.admin.mod.SimpleWizard.prototype.initialize.call(this)},_generateSQL:function(){var a=this,b=(a.options.table,"cartodb_id"),c=a.options.map.get("zoom");return"Rectangles"===this.cartoProperties.get("geometry_type")?a.sql=_.template("WITH hgrid AS (SELECT CDB_RectangleGrid(ST_Expand(!bbox!, greatest(!pixel_width!,!pixel_height!) * <%= size %>), greatest(!pixel_width!,!pixel_height!) * <%= size %>, greatest(!pixel_width!,!pixel_height!) * <%= size %>) as cell) SELECT hgrid.cell as the_geom_webmercator, count(i.<%=prop%>) as points_count,count(i.<%=prop%>)/power( <%= size %> * CDB_XYZ_Resolution(<%= z %>), 2 )  as points_density, 1 as cartodb_id FROM hgrid, <%= table %> i where ST_Intersects(i.the_geom_webmercator, hgrid.cell) GROUP BY hgrid.cell")({prop:b,table:"__wrapped",size:this.cartoProperties.get("polygon-size"),z:c}):a.sql=_.template("WITH hgrid AS (SELECT CDB_HexagonGrid(ST_Expand(!bbox!, greatest(!pixel_width!,!pixel_height!) * <%= size %>), greatest(!pixel_width!,!pixel_height!) * <%= size %>) as cell) SELECT hgrid.cell as the_geom_webmercator, count(i.<%=prop%>) as points_count, count(i.<%=prop%>)/power( <%= size %> * CDB_XYZ_Resolution(<%= z %>), 2 ) as points_density, 1 as cartodb_id FROM hgrid, <%= table %> i where ST_Intersects(i.the_geom_webmercator, hgrid.cell) GROUP BY hgrid.cell")({prop:b,table:"__wrapped",size:this.cartoProperties.get("polygon-size"),z:c}),this.sql}}),cdb.admin.mod.IntensityWizard=cdb.admin.mod.SimpleWizard.extend({MODULES:["infowindow","legends"],initialize:function(){this.type="intensity",cdb.admin.mod.SimpleWizard.prototype.initialize.call(this),this.options.table.bind("change:schema",function(){this.render()},this)}}),cdb.admin.mod.TorqueWizard=cdb.admin.mod.SimpleWizard.extend({MODULES:["legends"],events:{"click .to_the_top":"moveToFront"},LAYER_PROPS:["property","torque-duration","torque-frame-count","torque-blend-mode","torque-trails","torque-is-time"],error_msg:{NO_CONTENT_MSG:_t("There are no numeric or date columns on your dataset to make an animated map.<br/>If you have numbers on your dataset, but you don't see them here is likely they are set as String."),LAYER_ON_TOP:_t("Animated layers should be on top of the map."),ONLY_ONE_TORQUE_LAYER:_t("Sorry, but for the moment only one Torque layer is allowed per map.")},initialize:function(){this.type="torque",this.layer_type="torque",this.layers=this.options.map.layers,cdb.admin.mod.SimpleWizard.prototype.initialize.call(this)},validColumns:function(){return this.options.table.columnNamesByType("number").concat(this.options.table.columnNamesByType("date"))},isLayerOnTop:function(){return this.layers.last().cid===this.options.layer.cid},moveToFront:function(a){a&&a.preventDefault(),this.options.layer.moveToFront()},torqueLayersCount:function(){return this.layers.getLayersByType("torque").length},getTorqueLayer:function(){return this.layers.getLayersByType("torque")[0]},isValid:function(){return this.validColumns().length>0&&this.isLayerOnTop()&&(0===this.torqueLayersCount()||1===this.torqueLayersCount()&&this.getTorqueLayer().cid===this.options.layer.cid)},render:function(){return this.isValid()?cdb.admin.mod.SimpleWizard.prototype.render.call(this):0!==this.torqueLayersCount()?this.renderError(this.error_msg.ONLY_ONE_TORQUE_LAYER):this.isLayerOnTop()?this.renderError(this.error_msg.NO_CONTENT_MSG):(this.renderError(this.error_msg.LAYER_ON_TOP),$(this.$(".wrapper .no_content")[0]).append(' Please <a href="#/move" class="to_the_top">move it to the top</a>.')),this}}),cdb.admin.mod.TorqueCategoryWizard=cdb.admin.mod.CategoryWizard.extend({MODULES:["legends"],events:{"click .to_the_top":"moveToFront"},LAYER_PROPS:["property","torque-duration","torque-frame-count","torque-blend-mode","torque-trails","torque-is-time"],error_msg:{NO_CONTENT_MSG:_t("There are no numeric or date columns on your dataset to make an animated map.<br/>If you have numbers on your dataset, but you don't see them here is likely they are set as String."),LAYER_ON_TOP:_t("Animated layers should be on top of the map."),ONLY_ONE_TORQUE_LAYER:_t("Sorry, but for the moment only one Torque layer is allowed per map.")},initialize:function(){this.type="torque_cat",this.layer_type="torque",cdb.admin.mod.CategoryWizard.prototype.initialize.call(this)},validColumns:function(){return this.options.table.columnNamesByType("number").concat(this.options.table.columnNamesByType("date"))},isLayerOnTop:function(){var a=this.options.layer.collection;return a.last().cid===this.options.layer.cid},moveToFront:function(a){a&&a.preventDefault(),this.options.layer.moveToFront()},torqueLayersCount:function(){return this.options.layer.collection.getLayersByType("torque").length},getTorqueLayer:function(){return this.options.layer.collection.getLayersByType("torque")[0]},isValid:function(){return this.validColumns().length>0&&this.isLayerOnTop()&&(0===this.torqueLayersCount()||1===this.torqueLayersCount()&&this.getTorqueLayer().cid===this.options.layer.cid)},render:function(){return this.isValid()?cdb.admin.mod.CategoryWizard.prototype.render.call(this):0!==this.torqueLayersCount()?this.renderError(this.error_msg.ONLY_ONE_TORQUE_LAYER):this.isLayerOnTop()?this.renderError(this.error_msg.NO_CONTENT_MSG):(this.renderError(this.error_msg.LAYER_ON_TOP),$(this.$(".wrapper .no_content")[0]).append(' Please <a href="#/move" class="to_the_top">move it to the top</a>.')),this}}),cdb.admin.mod.TorqueHeatWizard=cdb.admin.mod.TorqueWizard.extend({initialize:function(){this.type="torque_heat",this.layer_type="torque",cdb.admin.mod.SimpleWizard.prototype.initialize.call(this)},_bindChanges:function(){cdb.admin.mod.SimpleWizard.prototype._bindChanges.call(this),this.cartoProperties.bind("change",this.showHeatAnimationFields,this),this.cartoProperties.bind("change:heat-animated",this.setDefaults,this),this.cartoProperties.bind("change:torque-cumulative",this.setDefaults,this)},render:function(){return cdb.admin.mod.SimpleWizard.prototype.render.call(this),this.showHeatAnimationFields(),this},setDefaults:function(){var a=this.cartoProperties.get("heat-animated");if(void 0!==a)if(a===!1)this.cartoProperties.set({"torque-frame-count":1,"torque-resolution":2,"torque-trails":0});else{var b=this.cartoProperties.get("torque-cumulative");b?this.cartoProperties.set({"torque-frame-count":512,"torque-resolution":10}):this.cartoProperties.set({"torque-frame-count":32,"torque-resolution":8,"torque-trails":2})}},showHeatAnimationFields:function(){var a=this,b=a.form.getFieldByName("Animated"),c=a.cartoProperties.get("heat-animated");if(b){var d=a.form.getFieldByName("Time Column"),e=a.form.getFieldByName("Duration (secs)"),f=a.form.getFieldByName("Steps"),g=a.form.getFieldByName("Cumulative"),h=a.form.getFieldByName("Trails");d&&d.hide(),c?(d&&d.show(),e&&e.show(),f&&f.show(),g&&g.show(),h&&h.show()):(e&&e.hide(),f&&f.hide(),g&&g.hide(),h&&h.hide())}}}),cdb.admin.MetadataDialog=cdb.admin.BaseDialog.extend({events:{"click .save":"_saveModel","click .ok":"_ok","click .cancel":"_cancel","click .close":"_cancel",submit:"_ok"},_TEXTS:{title:{table:_t("Dataset metadata"),vis:_t("Map metadata")},ok:_t("Save settings")},initialize:function(){_.bindAll(this,"_reInitScrollpane"),this.vis=this.options.vis,this.user=this.options.user,this.model=_.clone(this.vis),delete this.model.id,_.extend(this.options,{title:this._TEXTS.title[this.vis.isVisualization()?"vis":"table"],description:"",width:490,clean_on_hide:!0,template_name:"old_common/views/metadata_dialog_base",ok_title:this._TEXTS.ok,ok_button_classes:"button grey",modal_class:"metadata_dialog"}),this.constructor.__super__.initialize.apply(this)},render:function(){return this.$el.append(this.template_base(_.extend(this.options,this._getVisData()))),this.$(".modal").css({width:this.options.width}),this.render_content(),this.options.modal_class&&this.$el.addClass(this.options.modal_class),this},render_content:function(){var a=this;return _.each(this.model.get("tags"),function(a){this.$("ul").append("<li>"+a+"</li>")},this),this.$("ul").tagit({allowSpaces:!0,readOnly:!this._isMetadataEditable(),afterTagAdded:this._reInitScrollpane,afterTagRemoved:this._reInitScrollpane,onBlur:function(){a.$("ul").removeClass("focus")},onFocus:function(){a.$("ul").addClass("focus")},onSubmitTags:this.ok}),setTimeout(function(){a.$(".metadata_list").jScrollPane({verticalDragMinHeight:20});var b=new cdb.common.ScrollPaneGradient({list:a.$(".metadata_list")});a.$(".metadata_list").append(b.render().el),a.addView(b)},0),!1},_getVisData:function(){return{vis:{name:this.model.get("name"),title:this.model.get("title"),description:this.model.get("description"),max_length:this.options.maxLength,tags:"",license:this.model.get("license"),source:this.model.get("source"),isTitleEditable:this._isTitleEditable(),isMetaEditable:this._isMetadataEditable(),isOwner:this.model.permission.isOwner(this.user),owner:this.model.permission.owner.renderData(this.user),internal:"internal"===this.user.get("account_type").toLowerCase()}}},_isMetadataEditable:function(){if(this.model.isVisualization())return this.model.permission.isOwner(this.user)?!0:!1;var a=this.vis.map.layers&&this.vis.map.layers.last()&&this.vis.map.layers.last().table;return a&&(!a||!a.isInSQLView()&&a.permission.isOwner(this.user))?!0:!1},_isTitleEditable:function(){if(this.model.isVisualization())return this.model.permission.isOwner(this.user)?!0:!1;var a=this.vis.map.layers&&this.vis.map.layers.last().table;return a&&(!a||!a.isReadOnly()&&a.permission.isOwner(this.user))?!0:!1},_reInitScrollpane:function(){this.$(".metadata_list").data("jsp")&&this.$(".metadata_list").data("jsp").reinitialise()},_keydown:function(a){27===a.keyCode&&this._cancel()},_isNameValid:function(a){return""===a?!1:!0},_getFormData:function(){var a={};return _.each(this.$("form").serializeArray(),function(b){a[b.name]=b.value}),a.description=cdb.Utils.removeHTMLEvents(cdb.Utils.stripHTML(a.description)),a.tags=this.$("ul").tagit("assignedTags"),a},_saveModel:function(a){a&&this.killEvent(a),this.options.onResponse&&this.options.onResponse(this._getFormData()),this.hide()},_ok:function(a){this.killEvent(a);var b=this.$('input[name="name"]').val(),c=this.model.get("name")!==b,d=this._isNameValid(b);return d?(this._hideNameError(),void(!this.model.isVisualization()&&c?this._showConfirmation():this._saveModel())):(this._showNameError(),!1)},_showConfirmation:function(){if(this.user.featureEnabled("new_modals")){var a=cdb.editor.ViewFactory.createDialogByTemplate("common/dialogs/confirm_rename_dataset"),b=this;return a.ok=function(){b._saveModel(),this.close()},void a.appendToBody()}this.$("section.modal:eq(0)").animate({top:0,opacity:0},300,function(){$(this).slideUp(300)}),this.$(".modal.confirmation").css({top:"50%",marginTop:this.$(".modal.confirmation").height()/2,display:"block",opacity:0}).delay(200).animate({marginTop:-(this.$(".modal.confirmation").height()/2),opacity:1},300)},_showNameError:function(){this.$(".info.error").addClass("active"),setTimeout(this._reInitScrollpane,400)},_hideNameError:function(){this.$(".info.error").removeClass("active"),setTimeout(this._reInitScrollpane,400)},_destroyCustomElements:function(){this.$("ul").tagit("destroy"),this.$(".metadata_list").data()&&this.$(".metadata_list").data().jsp&&this.$(".metadata_list").data().jsp.destroy()},clean:function(){this._destroyCustomElements(),cdb.admin.BaseDialog.prototype.clean.call(this)}}),cdb.admin.NewColumnDialog=cdb.admin.BaseDialog.extend({initialize:function(){_.extend(this.options,{title:"Add new column",description:"",template_name:"old_common/views/dialog_base",clean_on_hide:!0,ok_button_classes:"button grey",ok_title:"Create column",modal_type:"creation",width:335,modal_class:"new_column_dialog",error_messages:{empty:"You have to choose a name"}}),this.constructor.__super__.initialize.apply(this),this.columnType=new cdb.core.Model({columnType:"string"}),_.bindAll(this,"_checkInput"),this.bind("clean",this._reClean)},render_content:function(){this.$(".content").append(this.getTemplate("table/views/new_column_dialog")()),this.combo=new cdb.forms.Combo({el:this.$(".column_select"),model:this.columnType,property:"columnType",width:"100%",extra:["string","number","date","boolean"]}),this.addView(this.combo),this.$("column_select").append(this.combo.render().el);var a=this.$el.find("input.column_name");return a.bind("keydown",this._checkInput),setTimeout(function(){a.focus()},0),this},checkColumnName:function(){var a=this.$("input.column_name").val();return""===a.trim()?!1:!0},_ok:function(a){return a&&a.preventDefault(),this.checkColumnName()?(this.options.table.addColumn(this.$("input.column_name").val(),this.columnType.get("columnType")),void this.hide()):(this._showError(),!1)},_checkInput:function(a){var b=a.keyCode?a.keyCode:a.which;13!=b?this._hideError():this._ok()},_showError:function(){this.$el.find(".info").addClass("active error").html("<p>"+this.options.error_messages.empty+"</p>")},_hideError:function(){this.$el.find(".info").removeClass("active")},_reClean:function(){this.$el.find("input.column_name").unbind("keydown")}}),cdb.admin.NewGeometryDropdown=cdb.admin.DropdownMenu.extend({className:"dropdown border",events:{"click .line":"newLine","click .point":"newPoint","click .polygon":"newPolygon"},show:function(){var a=$.Deferred(),b=this;return this.delegateEvents(),this.$el.css({marginTop:"down"==b.options.vertical_position?"-1px":"-50px",marginLeft:15,opacity:0,display:"block"}).animate({marginLeft:0,opacity:1},{duration:this.options.speedIn,complete:function(){a.resolve()}}),this.trigger("onDropdownShown",this.el),a.promise()},hide:function(a){var b=this;this.isOpen=!1,this.$el.animate({marginLeft:-15,opacity:0},this.options.speedOut,function(){$(b.options.target).removeClass("selected"),b.$el.hide(),a&&a(),b.trigger("onDropdownHidden",this.el)})},_trigger:function(a,b){this.killEvent(a),this.trigger("newGeometry",b),this.hide()},newPolygon:function(a){this._trigger(a,"polygon")},newLine:function(a){this._trigger(a,"line")},newPoint:function(a){this._trigger(a,"point")}}),cdb.admin.NoGeoRefDataDialog=cdb.admin.BaseDialog.extend({_TEXTS:{title:_t("No georeferenced data on your layer"),content:_t("Although we can see you have data, it does not                 appear to be georeferenced. You will not see anything on the map if                 your records are not georeferenced. Click on Georeference if you want                 to use a geocoder to get location out of your data, or cancel."),georef:_t("Georeference"),cancel:_t("Cancel")},initialize:function(a){_.extend(this.options,{title:this._TEXTS.title,content_classes:"grey",content:"",template_name:"table/views/noGeoRef_dialog",clean_on_hide:!0,hasContent:!1,ok_button_classes:"button grey",cancel_button_classes:"enabled",cancel_title:this._TEXTS.cancel,modal_type:"noGeoRef",width:525,error_messages:{}}),this.user=this.options.user,this.elder("initialize")},render_content:function(){return this.hasContent=this.model._data.length>0,this.$("a.ok").text(this._TEXTS.georef),this._TEXTS.content},_onGeocodingChosen:function(a){return"lonlat"==a.type?(this.model.geocodeLatAndLng(a.latitude,a.longitude),!1):"lonlat"!==a.type?(this.options.geocoder.set(_.omit(a,"table_name","type")),!1):void cdb.log.info("No geocoder option for "+a.type,obj)},ok:function(){if(this.hasContent){var a;if(this.options.geocoder.isGeocoding()||this.model.isSync()){if(!this.options.geocoder.isGeocoding())return;a=new cdb.admin.GeocoderWorking}else{var b=this.user.featureEnabled("new_modals")?cdb.editor.GeoreferenceView:cdb.admin.GeocodingDialog;a=new b({table:this.model,user:this.user,tabs:["lonlat","city","admin","postal","ip","address"],option:"lonlat"}),a.bind("geocodingChosen",this._onGeocodingChosen,this)}a.appendToBody().open({center:!0})}}}),cdb.admin.overlays.Annotation=cdb.geo.ui.Annotation.extend({className:"annotation overlay",template_name:"table/views/overlays/annotation",events:{"mouseenter .text":"_onMouseEnter",mouseup:"_onMouseUp","click .close":"_close","click .content":"_onClickEdit","click .text":"_onClickEdit","dblclick .content":"_onDblClick","dblclick .text":"_onDblClick","keyup .text":"_onKeyUp","paste .text":"_onPaste"},initialize:function(){_.bindAll(this,"_close","_onChangeMode","_onKeyDown"),this.vis=this.options.vis,this.canvas=this.options.canvas,this.mapView=this.options.mapView,this._bindMap(),this.template=this.getTemplate(this.template_name),this._setupModels();var a=this.mapView.map.get("minZoom"),b=this.mapView.map.get("maxZoom");this.form_data=[{name:"Text",form:{"font-size":{type:"simple_number",value:12,min:5,max:50,inc:2,disable_triggering:!0},color:{type:"color",value:"#FFF",extra:{tick:"left",picker_horizontal_position:"left",picker_vertical_position:"down"}},"font-family-name":{type:"select",value:"Helvetica",extra:["Helvetica","Droid Sans","Vollkorn","Roboto","Open Sans","Lato","Graduate","Gravitas One","Old Standard TT"]},"text-align":{type:"text_align",value:"left",alignments:{left:!0,right:!0,center:!1}}}},{name:"Box",form:{"box-color":{type:"color",value:"#000",extra:{tick:"left",picker_horizontal_position:"left",picker_vertical_position:"down"}},"box-opacity":{type:"simple_opacity",value:.7,min:0,max:1,inc:.1,disable_triggering:!0},"box-padding":{type:"simple_number_with_label",value:5,min:5,max:50,inc:1,label:"P",disable_triggering:!0}}},{name:"Line",form:{"line-color":{type:"color",value:"#000",extra:{tick:"left",picker_horizontal_position:"left",picker_vertical_position:"down"}},"line-width":{type:"simple_number_with_label",value:50,min:5,max:100,inc:1,label:"W",disable_triggering:!0}}},{name:"Zoom (min-max)",form:{"min-zoom":{type:"simple_number",value:a,min:a,max:b,inc:1,classes:"margin-min",disable_triggering:!0},"max-zoom":{type:"simple_number_with_label",value:b,min:a,max:b,inc:1,label:"↔",disable_triggering:!0}}}]},_bindMap:function(){this.mapView.map.bind("change",this._place,this),this.mapView.map.bind("change:zoom",this._applyZoomLevelStyle,this),this.mapView.bind("zoomstart",this._hideOverlay,this),this.mapView.bind("zoomend",this._showOverlay,this)},_unbindMap:function(){this.mapView.map.unbind("change",this._place,this),this.mapView.map.unbind("change:zoom",this._applyZoomLevelStyle,this),this.mapView.unbind("zoomstart",this._hideOverlay,this),this.mapView.unbind("zoomend",this._showOverlay,this)},_setupModels:function(){var a=this,b=this.extra=this.model.get("extra");this.model.set({text:b.text},{silent:!0});var c=function(){a._applyStyle(),a.model.save()};this.model.bind("remove",this.hide,this),this.model.bind("change:style",c,this),this.model.bind("change:text",this._setText,this),this.model.bind("change:display",this._onChangeDisplay,this),this.model.bind("change:extra",this._onChangeExtra,this),this.model.bind("change:selected",this._onChangeSelected,this),this.editModel=new cdb.core.Model({mode:""}),this.editModel.bind("change:mode",this._onChangeMode,this),this.add_related_model(this.editModel)},_onKeyUp:function(a){this.timeout&&clearTimeout(this.timeout),this.model.set({text:this.$text.html()},{silent:!0})},_onClickEdit:function(a){this.killEvent(a),$(document).bind("keydown",this._onKeyDown),this.trigger("clickEdit",this.model,this.form_data),this.model.set("selected",!0)},_onKeyDown:function(a){var b=this.model.get("selected");if(b){var c="editable"!==this.editModel.get("mode"),d=this.$(".overlay_text").is(":focus");($(a.target).hasClass("overlay_text")||$(a.target).hasClass("cartodb-map"))&&(a.keyCode!==$.ui.keyCode.BACKSPACE||!c&&d||(this.killEvent(a),this._close()))}a.keyCode===$.ui.keyCode.ESCAPE&&this.editModel.set("mode","")},_onPaste:function(a){var b=this;setTimeout(function(){var a=cdb.Utils.stripHTML(b.model.get("text"));b.model.set("text",a)},200)},_onDblClick:function(a){this.killEvent(a),this.editModel.set("mode","editable")},_onMouseUp:function(){var a="editable"==this.editModel.get("mode");a||this._savePosition()},_savePosition:function(){var a=this.model.get("extra"),b=this.model.get("x"),c=this.model.get("y"),d=this.$el.position().left,e=this.$el.position().top;this.$el.height();if(b!=d||c!=e){var b=this.$el.position().left,c=this.$el.position().top,f=this.model.get("style"),g=f["line-width"],h=f["text-align"];c+=Math.ceil(this.$el.outerHeight(!0)/2),"right"===h?b=b+this.$el.width()+g+this.$(".ball").width():b-=g;var i=this.mapView.pixelToLatLon([b,c]);a.latlng=[i.lat,i.lng],this.model.isNew()||this.model.save({extra:a})}},_onMouseDown:function(){},_onMouseEnter:function(){this.$el.addClass("hover"),"editable"===this.editModel.get("mode")&&this.timeout&&clearTimeout(this.timeout)},_onMouseLeave:function(){this.$el.removeClass("hover");var a=this;"editable"===this.editModel.get("mode")&&(this.timeout=setTimeout(function(){a.editModel.set("mode","")},250))},_hideOverlay:function(){this.$el.fadeOut(150)},_showOverlay:function(){if(this._belongsToCanvas()){var a=this;this.$el.stop().delay(500).fadeIn(150,function(){a.$el.css({display:"inline-table"})})}},show:function(a){if(this._belongsToCanvas()){this.$el.show(),this.$el.css({display:"inline-table "}),this.$el.addClass("animated bounceIn");var b=this;this.$el.one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){b.$el.removeClass("animated bounceIn")})}},hide:function(a){var b=this;this.unbind("mouseenter",this._onMouseEnter,this),this.unbind("mouseup",this._onMouseUp,this),$(document).unbind("keydown",this._onKeyDown,this),this.$el.removeClass("animated bounceIn").addClass("animated bounceOut"),a&&_.isFunction(a)&&a(),this._unbindMap(),cdb.god.unbind("closeDialogs",this._onCloseDialogs,this),setTimeout(function(){b.clean()},550)},_close:function(a){this.killEvent(a);var b=this;this.hide(function(){b.trigger("remove",b)})},_place:function(){var a=this.editModel.get("mode");if("editable"!==a){var b=this.model.get("style"),c=b["line-width"],d=b["text-align"],e=this.mapView.latLonToPixel(this.model.get("extra").latlng),f=(this.mapView.getSize(),e.y-Math.ceil(this.$el.outerHeight(!0)/2)),g=e.x+c;"right"===d&&(g=e.x-this.$el.width()-c-this.$(".ball").width()),this.$el.css({top:f,left:g})}},_belongsToCanvas:function(){return this.model.get("device")===this.canvas.get("mode")},_onChangeDisplay:function(){var a=this.model.get("display");a&&this._belongsToCanvas()?this.show():this._hideOverlay()},_onChangeExtra:function(){var a=this.model.get("extra");a.text=this.model.get("text"),this.model.set({extra:a},{silent:!0})},_getStyleProperty:function(a){var b=this.model.get("style");return b[a]},_applyStyle:function(){var a=this.model.get("style"),b=a["text-align"],c=a["box-color"],d=a["box-opacity"],e=a["box-padding"],f=a["line-width"],g=(a["line-color"],a["font-family-name"]);0===d?this.$el.addClass("border-dark"):this.$el.removeClass("border-dark"),"#FFFFFF"===c?this.$el.addClass("white-box"):this.$el.removeClass("white-box"),this.$text.css(a),this.$(".content").css("padding",e),this.$text.css("font-size",a["font-size"]+"px"),this.$el.css("z-index",a["z-index"]),this.$(".stick").css({width:f,left:-f});var h="";"Droid Sans"==g?h="droid":"Vollkorn"==g?h="vollkorn":"Open Sans"==g?h="open_sans":"Roboto"==g?h="roboto":"Lato"==g?h="lato":"Graduate"==g?h="graduate":"Gravitas One"==g?h="gravitas_one":"Old Standard TT"==g&&(h="old_standard_tt"),this.$el.removeClass("droid").removeClass("vollkorn").removeClass("roboto").removeClass("open_sans").removeClass("lato").removeClass("graduate").removeClass("gravitas_one").removeClass("old_standard_tt"),this.$el.addClass(h),"right"===b?(this.$el.addClass("align-right"),this.$(".stick").css({left:"auto",right:-f})):this.$el.removeClass("align-right"),this._place(),this._applyZoomLevelStyle()},_applyZoomLevelStyle:function(){var a=this.model.get("style"),b=(this.model.get("extra"),a["box-color"]),c=a["box-opacity"],d=a["line-color"],e=a["min-zoom"],f=a["max-zoom"],g=this.mapView.map.get("zoom"),h=1;if(g>=e&&f>=g){h=1;var i=this._getRGBA(d,1),j=this._getRGBA(b,c)}else{h=.5;var i=this._getRGBA(d,.2),j=this._getRGBA(b,.2)}this.$(".text").animate({opacity:h},150),this.$el.css("background-color",j),this.$(".stick").css("background-color",i),this.$(".ball").css("background-color",i)},_onChangeSelected:function(){var a=this.model.get("selected");a?(this.$el.addClass("selected"),0===this._getStyleProperty("box-opacity")&&this.$el.addClass("border-dark"),"#FFFFFF"===this._getStyleProperty("box-color")&&this.$el.addClass("white-box")):(this.$el.removeClass("selected").removeClass("border-dark").removeClass("white-box"),this._disableEditingMode())},_onChangeMode:function(){var a=this.editModel.get("mode");"editable"==a?this._enableEditingMode():this._disableEditingMode()},_enableEditingMode:function(){this.$el.addClass("editable").addClass("disabled"),this.$text.attr("contenteditable",!0).focus();var a=this.model.get("style"),b=a["box-width"],c=this.model.get("text");this.$el.css("width","auto"),this.$el.css("max-width",b),this.$text.html(c),this.$(".hint").fadeIn(150)},_disableEditingMode:function(){$(document).unbind("keydown",this._onKeyDown);var a=this._transformToMarkdown(this.model.get("text"));if(this.editModel.set("mode",""),a){var b=this;b.$(".hint").fadeOut(150,function(){b.$el.removeClass("editable").removeClass("disabled"),b.$text.attr("contenteditable",!1)}),b.$text.html(a),b._savePosition()}else this._close()},_setText:function(){var a=this.model.get("text"),b=this._transformToMarkdown(a),c=this.model.get("extra");c.text=a,c.rendered_text=b,this.model.save({extra:c}),b&&this.$text.html(b)},_transformToMarkdown:function(a){return a=markdown.toHTML(a),a=a.replace(/&lt;/g,"<"),a=a.replace(/&gt;/g,">"),a=a.replace(/<p>/g,""),a=a.replace(/&amp;nbsp;/g," "),a=a.replace(/<\/p>/g,"")},_onCloseDialogs:function(){void 0!==this.model.get("selected")&&this.model.set("selected",!1)},_setupText:function(){this.$text=this.$(".content div.text"),this.$text.html(this._transformToMarkdown(this.model.get("text")))},render:function(){this.$el.append(this.template(this.model.attributes)),this.$el.addClass(this.model.get("device")),this._setupText();var a=this;return setTimeout(function(){a._applyStyle(),a._place(),a.show()},500),cdb.god.unbind("closeDialogs",this._onCloseDialogs,this),cdb.god.bind("closeDialogs",this._onCloseDialogs,this),this}}),cdb.admin.ConfigureCanvasDropdown=cdb.ui.common.Dropdown.extend({className:"dropdown canvas_setup_dropdown",defaults:{speedOut:100,speedIn:100},events:{click:"killEvent"},initialize:function(){_.bindAll(this,"open","hide","_handleClick","_keydown"),_.defaults(this.options,this.defaults),this.template_base=cdb.templates.getTemplate(this.options.template_base),$(this.options.target).bind({click:this._handleClick}),$(document).bind("keydown",this._keydown),this.isOpen=!1},_handleClick:function(a){a&&a.preventDefault(),this.isOpen?this.hide():this.open()},show:function(){var a=$.Deferred();return this.delegateEvents(),this.$el.css({marginTop:"-10px",opacity:0,display:"block"}).animate({margin:"0",opacity:1},{duration:this.options.speedIn,complete:function(){a.resolve()}}),this.trigger("onDropdownShown",this.el),a.promise()},open:function(a,b){cdb.god.trigger("closeDialogs");var c=b&&$(b)||this.options.target;this.options.target=c,this.$el.css({top:40,left:0}).addClass(("up"==this.options.vertical_position?"vertical_top":"vertical_bottom")+" "+("right"==this.options.horizontal_position?"horizontal_right":"horizontal_left")+" border tick_"+this.options.tick),this.show(),this._recalcHeight(),this.isOpen=!0},hide:function(a){if(!this.isOpen)return void(a&&a());var b=this;this.isOpen=!1,this.$el.animate({marginTop:"down"==b.options.vertical_position?"10px":"-10px",opacity:0},this.options.speedOut,function(){b.$el.hide()}),this.trigger("onDropdownHidden",this.el)},_recalcHeight:function(){var a=this.$el.find("ul.special");a.height("auto"),a.parent().height("auto");var b=a.height(),c=a.parent().height();c>b?a.css("height",c):a.parent().height(b)},_addButton:function(a,b,c,d){var e=new cdb.admin.OverlaysDropdownItem({template_name:"table/views/overlays/canvas_dropdown_item",text:a,active:c,className:a.toLowerCase()}).on("click",d,this);return this.$el.find("ul").append(e.render().$el),e},_switchToDesktop:function(){this.desktopButton.model.set("active",!0),this.mobileButton.model.set("active",!1),this.options.canvas.set("mode","desktop")},_switchToMobile:function(){this.desktopButton.model.set("active",!1),this.mobileButton.model.set("active",!0),this.options.canvas.set("mode","mobile")},render:function(){return this.clearSubViews(),this.$el.html(this.template_base(this.options)),this.desktopButton=this._addButton("Desktop","desktop",!0,this._switchToDesktop),this.mobileButton=this._addButton("Mobile","mobile",!1,this._switchToMobile),this},clean:function(){$(document).unbind("keydown",this._keydown),cdb.ui.common.Dropdown.prototype.clean.call(this)}}),cdb.admin.overlays.Code=cdb.core.View.extend({className:"code overlay",template_name:"table/views/overlays/code",events:{mouseup:"_onMouseUp",mousedown:"_onMouseDown","mouseenter .text":"_onMouseEnter","mouseleave .text":"_onMouseLeave","click .close":"_close","click .content":"_click","dblclick .content":"_dblClick","keyup .text":"_onKeyUp","click .text":"_killEvent","paste .text":"_onPaste"},initialize:function(){_.bindAll(this,"_click","_close","_dblClick","_onChangeMode","_onKeyDown","_putOnTop"),$(document).bind("keydown",this._onKeyDown),this.template=this.getTemplate(this.template_name),this._setupModels()},_killEvent:function(a){a&&a.preventDefault(),a&&a.stopPropagation()},_setupModels:function(){var a=this.model.get("extra");this.model.set({text:a.text},{silent:!0}),this.model.bind("change:text",this._setText,this),
this.model.bind("change:style",this._applyStyle,this),this.model.bind("change:display",this._onChangeDisplay,this),this.model.bind("change:extra",this._onChangeExtra,this),this.editModel=new cdb.core.Model({mode:""}),this.editModel.bind("change:mode",this._onChangeMode,this),this.add_related_model(this.editModel)},_onKeyUp:function(a){var b=this;this.timeout&&clearTimeout(this.timeout),this.keyUpTimeout&&clearTimeout(this.keyUpTimeout),this.savingTimeout&&clearTimeout(this.savingTimeout);var c=this.$text.html();""==cdb.Utils.stripHTML(c)?this.keyUpTimeout=setTimeout(function(){b.model.set({text:""},{silent:!0}),b._close()},600):(this.model.set({text:c},{silent:!0}),!this.$el.hasClass("hover")&&this.$text.text()&&(this.savingTimeout=setTimeout(function(){b._disableEditingMode()},500)))},_dblClick:function(a){this._killEvent(a)},_click:function(a){this._killEvent(a),this._putOnTop();var b=a.target.hasAttribute("href");b||cdb.god.trigger("closeDialogs")},_onKeyDown:function(a){27===a.keyCode&&this.editModel.set("mode","")},_onPaste:function(a){var b=this;setTimeout(function(){var a=cdb.Utils.stripHTML(b.model.get("text"));b.model.set("text",a)},200)},_onMouseUp:function(a){if($(a.target).parents(".overlay_text").length||$(a.target).hasClass("overlay_text")){cdb.god.trigger("closeDialogs");var b=this.model.get("extra"),c=this.model.get("x"),d=this.model.get("y"),e=this.$el.position().left,f=this.$el.position().top,g=b.portraitDirection,h=b.landscapeDirection;if(0==d&&"bottom"==g&&(f=d),0==c&&"right"==h&&(e=c),e===c&&d===f||0==c&&"right"==h&&d===f||0==d&&"bottom"==g&&e===c)return this.dropdown.hide(),void this.editModel.set("mode","editable");var c=this.$el.position().left,d=this.$el.position().top;b.portraitDirection="top",b.landscapeDirection="left";var i=c+this.$el.width()>=$(".cartodb-map").width(),j=d+this.$el.height()>=$(".cartodb-map").height();j&&(d=0,this.$el.css({bottom:0,top:"auto"}),b.portraitDirection="bottom"),i&&(c=0,this.$el.css({right:0,left:"auto"}),b.landscapeDirection="right"),this.model.set({extra:b},{silent:!0}),this.model.set({x:c,y:d}),this.model.save()}},_onMouseDown:function(){},_onMouseEnter:function(){this.$el.addClass("hover"),"editable"==this.editModel.get("mode")&&this.timeout&&clearTimeout(this.timeout)},_onMouseLeave:function(){this.$el.removeClass("hover");var a=this;"editable"==this.editModel.get("mode")&&(this.timeout=setTimeout(function(){a.editModel.set("mode","")},250))},show:function(a){this.$el.show(),this.$el.addClass("animated bounceIn")},hide:function(a){var b=this;this.$el.removeClass("animated bounceIn").addClass("animated bounceOut"),a&&a(),setTimeout(function(){b.clean()},550)},_close:function(a){this._killEvent(a);var b=this;this.dropdown.hide(),this.dropdown.clean(),this.hide(function(){b.trigger("remove",b)})},_onChangeDisplay:function(){var a=this.model.get("display");a?this.show():this.$el.hide()},_onChangeExtra:function(){var a=this.model.get("extra");a.text=this.model.get("text"),this.model.set({extra:a},{silent:!0})},_applyStyle:function(){var a=this.model.get("style"),b=a["box-color"],c=a["box-opacity"],d=a["box-width"],e=a["font-family-name"];this.$text.css(a),this.$text.css("font-size",a["font-size"]+"px");var f="rgba("+parseInt(b.slice(-6,-4),16)+","+parseInt(b.slice(-4,-2),16)+","+parseInt(b.slice(-2),16)+", "+c+" )";this.$el.css("background-color",f),this.$el.css("max-width",d);var g="";"Droid Sans"==e?g="droid":"Vollkorn"==e?g="vollkorn":"Open Sans"==e?g="open_sans":"Roboto"==e&&(g="roboto"),this.$el.css("width","auto"),this.$el.removeClass("droid").removeClass("vollkorn").removeClass("roboto").removeClass("open_sans"),this.$el.addClass(g)},_onChangeMode:function(){var a=this.editModel.get("mode");"editable"==a?this._enableEditingMode():this._disableEditingMode()},_enableEditingMode:function(){var a=this.model.get("text");this.$el.addClass("editable").addClass("disabled"),this.$text.attr("contenteditable",!0).focus(),this.$el.css("width","auto");var b=this;setTimeout(function(){b.$text.html(a)},100)},_disableEditingMode:function(){var a=this._transformToMarkdown(this.model.get("text"));if(this.editModel.set("mode",""),a){this.$text.html(a),this.$el.removeClass("editable").removeClass("disabled"),this.$text.attr("contenteditable",!1),this.$el.css("width","auto");var b=this;setTimeout(function(){var a=b.$el.width();b.$el.css("width",a)},300),this.model.save()}},_setText:function(){var a=this.model.get("text"),b=this._transformToMarkdown(a),c=this.model.get("extra");c.text=a,c.rendered_text=b,this.model.set({extra:c},{silent:!0}),b&&this.$text.html(b)},_transformToMarkdown:function(a){return console.log(a),"code"},_addDropdown:function(){var a=this.model.get("device"),b=26,c=24;"mobile"===a&&(c-=$("header").height()+12),this.dropdown=new cdb.admin.WidgetPropertiesDropdown({tick:"left",target:this.$el.find(".edit"),model:this.model,offset_mode:"mobile"===a?"offset":"position",horizontal_position:"left",horizontal_offset:b,vertical_offset:c,template_base:"table/views/overlays/properties_dropdown",form_data:[{name:"Text Align",form:{"text-align":{type:"text_align",value:"left"}}},{name:"Text Style",form:{"font-size":{type:"simple_number",value:12,min:5,max:50,inc:2},color:{type:"color",value:"#FFF"}}},{name:"Font",form:{"font-family-name":{type:"select",value:"Helvetica",extra:["Helvetica","Droid Sans","Vollkorn","Roboto","Open Sans"]}}},{name:"Box Style",form:{"box-color":{type:"color",value:"#000"},"box-opacity":{type:"simple_opacity",value:.7,min:0,max:1,inc:.1}}},{name:"Max Width",form:{"box-width":{type:"simple_number",value:300,min:50,max:2e3,inc:10}}}]}),this._bindDropdown();var d=this;this.dropdown.on("saved",function(){d.dropdown.move(!0)}),"mobile"==this.model.get("device")?$(".map").append(this.dropdown.render().el):this.$el.append(this.dropdown.render().el)},_bindDropdown:function(){this.dropdown.bind("onDropdownShown",function(){this.$el.addClass("open"),this._putOnTop()},this),this.dropdown.bind("onDropdownHidden",function(){this.$el.removeClass("open")},this),cdb.god.bind("closeDialogs",this.dropdown.hide,this.dropdown)},_putOnTop:function(){$(".overlay").css("z-index",999),this.$el.css("z-index",2001)},_place:function(){var a=this.model.get("extra").landscapeDirection,b=this.model.get("extra").portraitDirection;"bottom"==b?(this.$el.offset({top:this.model.get("y")}),this.$el.css({top:"auto",bottom:this.model.get("y")})):this.$el.offset({top:this.model.get("y")}),"right"==a?(this.$el.offset({left:this.model.get("x")}),this.$el.css({left:"auto",right:this.model.get("x")})):this.$el.offset({left:this.model.get("x")})},render:function(){this._place(),this.$el.append(this.template(this.model.attributes)),this.$text=this.$el.find(".content div.text");var a=this._transformToMarkdown(this.model.get("text"));return this.$text.html(a),this._applyStyle(),this._onChangeExtra(),this._addDropdown(),this}}),cdb.admin.overlays.Fullscreen=cdb.core.View.extend({tagName:"div",className:"cartodb-fullscreen",events:{"click a":"_toggleFullScreen"},template_name:"table/views/overlays/fullscreen",initialize:function(){_.bindAll(this,"_close"),this.template=this.getTemplate(this.template_name),this._setupModels()},_killEvent:function(a){a&&a.preventDefault(),a&&a.stopPropagation()},_setupModels:function(){this.model=this.options.model,this.model.on("change:display",this._onChangeDisplay,this),this.model.on("change:y",this._onChangeY,this),this.model.on("destroy",function(){this.$el.remove()},this)},_onChangeY:function(){var a=this.model.get("y");this.$el.animate({top:a},150),this.trigger("change_y",this)},_onChangeDisplay:function(){var a=this.model.get("display");a?this.show():this.hide()},_onMouseDown:function(){},_onMouseEnterText:function(){},_onMouseLeaveText:function(){},_onMouseEnter:function(){},_onMouseLeave:function(){},show:function(){var a=this;this.$el.fadeIn(250,function(){a.trigger("change_y",a)})},hide:function(a){var b=this;a&&a(),this.$el.fadeOut(250,function(){b.trigger("change_y",b)})},_close:function(a){this._killEvent(a);var b=this;this.hide(function(){b.trigger("remove",b)})},_toggleFullScreen:function(a){a.stopPropagation(),a.preventDefault();var b=window.document,c=b.documentElement;this.options.doc&&(c=$(this.options.doc)[0]);var d=c.requestFullscreen||c.mozRequestFullScreen||c.webkitRequestFullScreen||c.msRequestFullscreen,e=b.exitFullscreen||b.mozCancelFullScreen||b.webkitExitFullscreen||b.msExitFullscreen,f=this.options.mapView;b.fullscreenElement||b.mozFullScreenElement||b.webkitFullscreenElement||b.msFullscreenElement?e.call(b):(d.call(c),f&&this.model.get("allowWheelOnFullscreen")&&f.options.map.set("scrollwheel",!0))},render:function(){return this.$el.append(this.template()),this.$el.css({left:this.model.get("x"),top:this.model.get("y")}),this}}),cdb.admin.overlays.Header=cdb.admin.overlays.Text.extend({className:"header overlay-static",template_name:"table/views/overlays/header",events:{},_close:function(){},_applyStyle:function(){},_onChangeMode:function(){},_enableEditingMode:function(){},_onMouseLeave:function(){},_onMouseEnter:function(){},_onKeyUp:function(){},_onKeyDown:function(){},initialize:function(){_.bindAll(this,"_close","_dblClick","_onChangeMode","_onKeyDown"),$(document).bind("keydown",this._onKeyDown),this.template=this.getTemplate(this.template_name),this._setupModel()},_setupModel:function(){this.model=this.options.model,this.model.set({mode:""},{silent:!0}),this.model.bind("change:show_title",this._onChangeShowTitle,this),this.model.bind("change:show_description",this._onChangeShowDescription,this),this.model.bind("change:style",this._applyStyle,this),this.model.bind("change:title",this._onChangeTitle,this),this.model.bind("change:description",this._onChangeDescription,this),this.model.bind("change:mode",this._onChangeMode,this),this.model.on("change:y",this._onChangeY,this),this.model.on("destroy",function(){this.$el.remove()},this)},isVisible:function(){return this.model.get("title")&&this.model.get("show_title")||this.model.get("description")&&this.model.get("show_description")},_dblClick:function(a){this._killEvent(a)},_onChangeShowDescription:function(){var a=this.model.get("title")&&this.model.get("show_title"),b=this.model.get("description")&&this.model.get("show_description"),c=!1,d=this.model.get("extra");d.show_description=this.model.get("show_description"),b?(c=!0,this.$el.show(),this.$description.show(),this.trigger("change_y")):(this.$description.hide(),a||this.$el.hide(),this.trigger("change_y")),this.model.set({extra:d},{silent:!0})},_onChangeY:function(){var a=this.model.get("y");this.$el.animate({top:a},150)},_onChangeShowTitle:function(){var a=this.model.get("title")&&this.model.get("show_title"),b=this.model.get("description")&&this.model.get("show_description"),c=!1,d=this.model.get("extra");d.show_title=this.model.get("show_title"),a?(c=!0,this.$el.show(),this.$title.show(),this.trigger("change_y")):(this.$title.hide(),b||this.$el.hide(),this.trigger("change_y")),this.model.set({extra:d},{silent:!0})},_onChangeTitle:function(){this.$el.find(".title").html(this.model.get("title"));var a=this.model.get("extra");a.title=this.model.get("title"),this.model.set({extra:a},{silent:!0}),this.show()},_onChangeDescription:function(){this.$el.find(".description").html(this.model.get("description"));var a=this.model.get("extra");a.description=this.model.get("description"),this.model.set({extra:a},{silent:!0}),this.show()},show:function(){var a=this.model.get("title")&&this.model.get("show_title"),b=this.model.get("description")&&this.model.get("show_description");if(a||b){var c=this;this.$el.show(),a&&c.$title.show(),b&&c.$description.show(),c.trigger("change_y")}},hide:function(){},_getMarkdown:function(a){return a=cdb.Utils.stripHTML(a),a=markdown.toHTML(a),a=cdb.Utils.stripHTML(a,"<a><i><em><strong><b><u><s>"),a=a.replace(/&#39;/g,"'"),cdb.core.sanitize.html(a)},render:function(){this.$el.offset({top:this.model.get("y"),left:this.model.get("x")}),this.extra=this.model.get("extra"),this.model.set({title:this.extra.title,description:this.extra.description,show_title:this.extra.show_title,show_description:this.extra.show_description},{silent:!0});var a=_.chain(this.model.attributes).clone().extend({description:this._getMarkdown(this.model.get("description"))}).value();return this.$el.append(this.template(a)),this.$title=this.$el.find(".content div.title"),this.$description=this.$el.find(".content div.description"),(this.model.get("show_title")||this.model.get("show_description"))&&this.show(),this}}),cdb.admin.overlays.Image=cdb.admin.overlays.Text.extend({className:"image overlay snap",events:{"mouseenter .text":"_onMouseEnter","click .close":"_close","click .content":"_onClickEdit","click .text":"_onClickEdit","dblclick .content":"_onDblClick","dblclick .text":"_onDblClick","keyup .text":"_onKeyUp","paste .text":"_onPaste"},initialize:function(){_.bindAll(this,"_close","_onDblClick","_onChangeMode","_onKeyDown","_onLoadSuccess","_onLoadError"),$(document).bind("keydown",this._onKeyDown),this.template=this.getTemplate("table/views/overlays/image"),this.image_template=_.template("<img src='<%- url %>' style='width: <%- width %>px'/>"),this._setupModels(),this.form_data=[{name:"Box",form:{"box-color":{type:"color",value:"#000",extra:{tick:"left",picker_vertical_position:"down",picker_horizontal_position:"left"}},"box-opacity":{type:"simple_opacity",value:.7,min:0,max:1,inc:.1,disable_triggering:!0}}},{name:"Width",form:{"box-width":{type:"simple_number",value:300,min:50,max:2e3,inc:10,disable_triggering:!0}}}]},_setupModels:function(){var a=this,b=this.model.get("extra");this.model.set({url:b.url},{silent:!0});var c=function(){a._applyStyle(!0)};this.model.bind("remove",this.hide,this),this.model.bind("change:url",this._setURL,this),this.model.bind("change:style",c,this),this.model.bind("change:extra",this._onChangeExtra,this),this.model.bind("change:display",this._onChangeDisplay,this),this.model.bind("change:selected",this._onChangeSelected,this),this.editModel=new cdb.core.Model({mode:""}),this.editModel.bind("change:mode",this._onChangeMode,this),this.add_related_model(this.editModel)},_onKeyUp:function(a){var b=this;this.timeout&&clearTimeout(this.timeout),this.keyUpTimeout&&clearTimeout(this.keyUpTimeout),this.savingTimeout&&clearTimeout(this.savingTimeout);var c=this.$text.html();""==cdb.Utils.stripHTML(c)?this.keyUpTimeout=setTimeout(function(){b.model.set({url:""},{silent:!0}),b._close()},600):(cdb.Utils.isURL(c)&&this.model.set({url:c},{silent:!0}),!this.$el.hasClass("hover")&&this.$text.text()&&(this.savingTimeout=setTimeout(function(){b._disableEditingMode()},500)))},_onPaste:function(a){var b=this;setTimeout(function(){var a=cdb.Utils.stripHTML(b.$text.text());cdb.Utils.isURL(a)&&(b.model.set("url",a),b.editModel.set("mode","loading"))},300)},_onMouseDown:function(){},_onMouseEnterText:function(){},_onMouseLeaveText:function(){},_applyStyle:function(a){var b=this.model.get("style"),c=b["box-color"],d=b["box-opacity"],e=b["box-width"];this.$text.css(b),this.$text.css("font-size",b["font-size"]+"px"),this.$el.css("z-index",b["z-index"]);var f="rgba("+parseInt(c.slice(-6,-4),16)+","+parseInt(c.slice(-4,-2),16)+","+parseInt(c.slice(-2),16)+", "+d+" )";this.$el.css("background-color",f),this.$("img").css("width",e),a&&this.model.save()},_enableEditingMode:function(){var a=this,b=this.model.get("url");this.$el.removeClass("error").addClass("editable disabled"),this.$text.attr("contenteditable",!0).focus(),setTimeout(function(){var c=(a.$text.outerHeight(!0),a.$text.width());a.$text.html(b),a.$text.css({minWidth:c})},100)},_disableEditingMode:function(){var a=this.model.get("url"),b=this.model.get("style"),c=b["box-width"],d=this.model.get("extra"),e="<img src='"+a+"' style='width: "+c+"px'/>";this.$el.removeClass("editable disabled"),this.editModel.set("mode",""),this.error?this.$el.addClass("error"):this.$el.removeClass("error"),this.$text.html(e),this.$text.attr("contenteditable",!1),d.url=a,d.rendered_text=this.image_template({url:a,width:c}),d.url!==d.default_image_url&&(d.has_default_image=!1),this.model.set({extra:d},{silent:!0}),this.model.save(),this.$text.css({height:"auto",minHeight:"0",minWidth:"0"})},_setURL:function(){this._loadImage(this.model.get("url"))},_loadImage:function(a){var b=this,c=function(){b._onLoadSuccess(a)},d=function(){b._onLoadError(a)};$("<img/>").load(c).error(d).attr("src",a)},_onLoadError:function(a){this.$el.addClass("error"),this.error=!0},_onLoadSuccess:function(a){this.$el.removeClass("error"),this.error=!1;var b=this.model.get("style"),c=b["box-width"],d=this.model.get("extra"),e=this.image_template({url:a,width:c});d.rendered_text=e,this.model.set({extra:d},{silent:!0}),this.$el.removeClass("editable disabled"),this.$text.html(e),this.$text.attr("contenteditable",!1),this.$text.css("height","auto"),this.editModel.set("mode",""),this.model.get("display")&&this.show()},_addDropdown:function(){this.dropdown=new cdb.admin.OverlayPropertiesDropdown({tick:"left",target:this.$(".edit"),model:this.model,horizontal_position:"left",horizontal_offset:26,vertical_offset:24,template_base:"table/views/overlays/properties_dropdown",form_data:this.form_data});var a=this;this.dropdown.on("saved",function(){a.dropdown.move()}),this._bindDropdown(),this.$el.append(this.dropdown.render().el)},_bindDropdown:function(){this.dropdown.bind("onDropdownShown",function(){this.$el.addClass("open")},this),this.dropdown.bind("onDropdownHidden",function(){this.$el.removeClass("open")},this),cdb.god.bind("closeDialogs",this.dropdown.hide,this.dropdown)},_onChangeMode:function(){var a=this.editModel.get("mode");"editable"===a?this._enableEditingMode():this._disableEditingMode()},clean:function(){$(document).unbind("keydown",this._onKeyDown,this),cdb.core.View.prototype.clean.call(this)},render:function(){return this._place(),this.$el.append(this.template()),this.$text=this.$(".content div.text"),this._setURL(),this._applyStyle(!1),this.$el.addClass(this.model.get("device")),cdb.god.unbind("closeDialogs",this._onCloseDialogs,this),cdb.god.bind("closeDialogs",this._onCloseDialogs,this),this}}),cdb.admin.overlays.LayerSelector=cdb.core.View.extend({tagName:"div",className:"cartodb-layer-selector-box",events:{click:"_openDropdown",dblclick:"killEvent",mousedown:"killEvent"},default_options:{timeout:0,msg:""},initialize:function(){_.bindAll(this,"_close"),this.map=this.options.mapView.map,this.mapView=this.options.mapView,this.mapView.bind("click zoomstart drag",function(){this.dropdown&&this.dropdown.hide()},this),this.add_related_model(this.mapView),this.layers=[],this.map=this.options.map,_.defaults(this.options,this.default_options),this._setupModels()},_killEvent:function(a){a&&a.preventDefault(),a&&a.stopPropagation()},_setupModels:function(){this.model=this.options.model,this.model.on("change:display",this._onChangeDisplay,this),this.model.on("change:y",this._onChangeY,this),this.model.on("change:x",this._onChangeX,this),this.model.on("destroy",function(){this.$el.remove()},this)},_onChangeX:function(){var a=this.model.get("x");this.$el.animate({right:a},150),this.trigger("change_x",this)},_onChangeY:function(){var a=this.model.get("y");this.$el.animate({top:a},150),this.trigger("change_y",this)},_onChangeDisplay:function(){var a=this.model.get("display");a?this.show():this.hide()},_checkZoom:function(){var a=this.map.get("zoom");this.$(".zoom_in")[a<this.map.get("maxZoom")?"removeClass":"addClass"]("disabled"),this.$(".zoom_out")[a>this.map.get("minZoom")?"removeClass":"addClass"]("disabled")},zoom_in:function(a){this.map.get("maxZoom")>this.map.getZoom()&&this.map.setZoom(this.map.getZoom()+1),a.preventDefault(),a.stopPropagation()},zoom_out:function(a){this.map.get("minZoom")<this.map.getZoom()&&this.map.setZoom(this.map.getZoom()-1),a.preventDefault(),a.stopPropagation()},_onMouseDown:function(){},_onMouseEnterText:function(){},_onMouseLeaveText:function(){},_onMouseEnter:function(){},_onMouseLeave:function(){},show:function(){this.$el.fadeIn(250)},hide:function(a){a&&a(),this.$el.fadeOut(250)},_close:function(a){this._killEvent(a);var b=this;this.hide(function(){b.trigger("remove",b)})},_toggleFullScreen:function(a){a.stopPropagation(),a.preventDefault();var b=window.document,c=b.documentElement;this.options.doc&&(c=$(this.options.doc)[0]);var d=c.requestFullscreen||c.mozRequestFullScreen||c.webkitRequestFullScreen,e=b.exitFullscreen||b.mozCancelFullScreen||b.webkitExitFullscreen,f=this.options.mapView;b.fullscreenElement||b.mozFullScreenElement||b.webkitFullscreenElement?e.call(b):(d.call(c),f&&this.model.get("allowWheelOnFullscreen")&&f.options.map.set("scrollwheel",!0))},_getLayers:function(){var a=this;this.layers=[],_.each(this.mapView.map.layers.models,function(b){if("layergroup"==b.get("type")||"namedmap"===b.get("type"))for(var c=a.mapView.getLayerByCid(b.cid),d=0;d<c.getLayerCount();++d){var e=c.getLayer(d),f=new cdb.core.Model(e);f.set("order",d),f.set("type","layergroup"),f.set("visible",!c.getSubLayer(d).get("hidden")),f.bind("change:visible",function(a){this.trigger("change:visible",a.get("visible"),a.get("order"),a),a.save()},a),a.options.layer_names?f.set("layer_name",a.options.layer_names[d]):f.set("layer_name",e.options.layer_name);var g=a._createLayer("LayerViewFromLayerGroup",{model:f,layerView:c,layerIndex:d});g.bind("switchChanged",a._setCount,a),a.layers.push(g)}else if("CartoDB"===b.get("type")||"torque"===b.get("type")){var g=a._createLayer("LayerView",{model:b});g.bind("switchChanged",a._setCount,a),a.layers.push(g),g.model.bind("change:visible",function(a){this.trigger("change:visible",a.get("visible"),a.get("order"),a),a.save()},a)}})},_createLayer:function(a,b){var c=new cdb.geo.ui[a](b);return this.$("ul").append(c.render().el),this.addView(c),c},_setCount:function(){for(var a=0,b=0,c=this.layers.length;c>b;++b){var d=this.layers[b];d.model.get("visible")&&a++}this.$(".count").text(a),this.trigger("switchChanged",this)},_openDropdown:function(){this.dropdown.open()},render:function(){return this.$el.html(this.options.template(this.options)),this.$el.css({right:this.model.get("x"),top:this.model.get("y")}),this.dropdown=new cdb.ui.common.Dropdown({className:"cartodb-dropdown border",template:this.options.dropdown_template,target:this.$el.find("a"),speedIn:300,speedOut:200,position:"position",tick:"right",vertical_position:"down",horizontal_position:"right",vertical_offset:7,horizontal_offset:13}),cdb.god&&cdb.god.bind("closeDialogs",this.dropdown.hide,this.dropdown),this.$el.append(this.dropdown.render().el),this._getLayers(),this._setCount(),this}}),cdb.admin.overlays.Loader=cdb.core.View.extend({tagName:"div",className:"cartodb-tiles-loader",template_name:"table/views/overlays/loader",default_options:{animationSpeed:500},initialize:function(){_.bindAll(this,"_close"),this.isVisible=0,this.template=this.getTemplate(this.template_name),this.map=this.options.map,_.defaults(this.options,this.default_options),this._setupModels()},_killEvent:function(a){a&&a.preventDefault(),a&&a.stopPropagation()},_setupModels:function(){this.model=this.options.model,this.model.on("change:y",this._onChangeY,this),this.map.bind("change:zoom change:minZoom change:maxZoom",this._checkZoom,this)},_onChangeY:function(){var a=this.model.get("y");this.$el.animate({top:a},150)},_onChangeDisplay:function(){var a=this.model.get("display");a?this.show():this.hide()},show:function(a){this.isVisible||(!$.browser.msie||$.browser.msie&&0!=$.browser.version.indexOf("9.")?this.$el.fadeIn(this.options.animationSpeed):this.$el.show(),this.isVisible++)},hide:function(a){this.isVisible--,this.isVisible>0||(this.isVisible=0,!$.browser.msie||$.browser.msie&&0==$.browser.version.indexOf("9.")?this.$el.fadeOut(this.options.animationSpeed):this.$el.hide())},visible:function(){return this.isVisible>0},_onMouseDown:function(){},_onMouseEnterText:function(){},_onMouseLeaveText:function(){},_onMouseEnter:function(){},_onMouseLeave:function(){},_close:function(a){this._killEvent(a);var b=this;this.hide(function(){b.trigger("remove",b)})},render:function(){return this.$el.html($(this.template(this.options))),this.$el.css({left:this.model.get("x"),top:this.model.get("y")}),this.$el.find("div.loader").tipsy({title:function(){return"Loading tiles..."},fade:!0,offset:3,gravity:"w"}),this}}),cdb.admin.overlays.Logo=cdb.admin.overlays.Text.extend({className:"cartodb-logo",template_name:"table/views/overlays/logo",events:{},initialize:function(){this.template=this.getTemplate(this.template_name),this._setupModels()},_killEvent:function(a){a&&a.preventDefault(),a&&a.stopPropagation()},_setupModels:function(){this.model.bind("change:display",this._onChangeDisplay,this),this.model.on("destroy",function(){this.$el.hide()},this)},show:function(a){this.$el.show(),this.$el.addClass("animated bounceIn")},hide:function(a){this.$el.removeClass("animated bounceIn").addClass("animated bounceOut"),a&&a()},_onChangeDisplay:function(){var a=this.model.get("display");a?this.show():this.$el.hide()},render:function(){return this.$el.append(this.template(this.model.attributes)),this.model.get("display")&&this.show(),this.$el.css({left:this.model.get("x"),bottom:this.model.get("y")}),this}}),cdb.admin.MapOverlays=cdb.core.View.extend({initialize:function(){this.overlayViews=[],this.horizontal_overlays=["share","layer_selector","search"],this.vertical_overlays=["zoom","fullscreen","loader"],this.vis=this.options.vis,this.master_vis=this.options.master_vis,this.canvas=this.options.canvas,this.mapView=this.options.mapView,this.map=this.mapView.map,this.mapToolbar=this.options.mapToolbar,this.headerMessageIsVisible=this.options.headerMessageIsVisible,this._bindOverlays()},setHeaderMessageIsVisible:function(a){this.headerMessageIsVisible=a,this._positionOverlaysVertically()},_cleanOverlays:function(){this.overlays&&(_.each(this.overlayViews,function(a){a.clean()}),this.overlayViews=[],this.zoom=null,this.loader=null,this.fullscreen=null,this.search=null)},_getOverlay:function(a){return this.overlays?this.overlays.filter(function(b){return b.get("type")==a})[0]:void 0},_getHeaderOverlay:function(){return this._getOverlay("header")},_hideOverlays:function(a){if(this.overlays){this.overlays.each(function(b){var c=b.get("device");c===a&&b.set("display",!1)},this)}},_showOverlays:function(a){this.overlays.each(function(b){var c=b.get("device");c===a&&b.set("display",!0)},this)},_bindOverlays:function(){var a=this;this.overlays=this.vis.overlays,this.add_related_model(this.vis.overlays),this.overlays.unbind("reset",this._onResetOverlays),this.overlays.unbind("remove"),this.overlays.unbind("add"),this.overlays.bind("reset",this._onResetOverlays,this),this.overlays.bind("remove",function(a){a.destroy()}),this.overlays.bind("add",function(b){a._renderOverlay(!1,b),a._reloadDraggable()}),this._onResetOverlays(this.overlays)},_onResetOverlays:function(a){this._cleanOverlays(),a.models.length>0&&a.each(this._setupOverlay,this)},_setupOverlay:function(a){this._renderOverlay(!1,a)},_renderOverlay:function(a,b){var c=this._getOverlayTpe(b),d=b.get("device"),e=["Header","Fullscreen","Share","LayerSelector"];if(!_.contains(e,c)||"table"!==this.vis.get("type")){var f=d&&d!=this.canvas.get("mode")?!1:!0;b.set("display",f);var g=this._configureOverlay(b);g&&(this.overlayViews.push(g),this._bindOverlay(g),"Text"===c||"Image"===c?this._toggleOverlay(g):"Annotation"===c&&this._reloadDraggable())}},_configureOverlay:function(a){var b,c=this._getOverlayTpe(a);switch(c){case"Loader":b=this._setupLoaderOverlay(c,a);break;case"Zoom":b=this._setupZoomOverlay(c,a);break;case"Share":b=this._setupShareOverlay(c,a);break;case"Header":b=this._setupHeaderOverlay(c,a);break;case"Search":b=this._setupSearchOverlay(c,a);break;case"Logo":b=this._setupCartoDBLogo(c,a);break;case"LayerSelector":b=this._setupLayerSelectorOverlay(c,a);break;case"Fullscreen":b=this._setupFullScreenOverlay(c,a);break;case"Text":b=new cdb.admin.overlays[c]({model:a});break;case"Image":b=new cdb.admin.overlays[c]({model:a});break;case"Annotation":b=new cdb.admin.overlays[c]({vis:this.vis,canvas:this.canvas,model:a,mapView:this.mapView})}return b},_getOverlayTpe:function(a){var b=a.get("type");return b||(b="text"),_.map(b.split("_"),function(a){return a.slice(0,1).toUpperCase()+a.slice(1)}).join("")},_positionOverlaysHorizontally:function(){_.each(this.horizontal_overlays,function(a){var b=this._getOverlay(a);b&&this._positionOverlay(b)},this)},_positionOverlaysVertically:function(a){if(this.overlays){if(a){var b=this._getHeaderOverlay();this._positionOverlay(b)}_.each(this.horizontal_overlays,function(a){var b=this._getOverlay(a);b&&this._positionOverlay(b)},this),_.each(this.vertical_overlays,function(a){var b=this._getOverlay(a);b&&this._positionOverlay(b)},this)}},_bindOverlay:function(a){this.mapView.$el.append(a.render().$el),"header"===a.model.get("type")&&this._positionOverlaysVertically(),"search"===a.model.get("type")&&this._positionSearchOverlay(a.model),a.bind("remove",function(a){this.overlays.remove(a.model),this._removeOverlayPropertiesBar(!0)},this),a.bind("clickEdit",function(a,b){this._addOverlayPropertiesBar(a,b)},this)},_hideToobarOptions:function(a){this.overlayPropertiesBar?this.overlayPropertiesBar.compareModel(a)?this.mapToolbar.find("ul.options").animate({top:-100},{duration:200,easing:"easeInOutQuad"}):this.overlayPropertiesBar.deselectOverlay():this.mapToolbar.find("ul.options").animate({top:-100},{duration:200,easing:"easeInOutQuad"})},_removeOverlayPropertiesBar:function(a,b){if(!(b&&this.overlayPropertiesBar&&this.overlayPropertiesBar.compareModel(b))&&(a&&this._showToolbarOptions(),this.overlayPropertiesBar)){var c=this;return b?(this.overlayPropertiesBar.clean(),delete this.overlayPropertiesBar,!0):(this.overlayPropertiesBar.$el.animate({top:100},{duration:150,complete:function(){c.overlayPropertiesBar.clean(),delete c.overlayPropertiesBar}}),!1)}},_showToolbarOptions:function(){var a=this;this.mapToolbar.find("ul.options").animate({top:0},{duration:250,easing:"easeInOutQuad",complete:function(){a.mapToolbar.removeClass("animated")}})},_addOverlayPropertiesBar:function(a,b){this.overlaysDropdown&&this.overlaysDropdown.hide(),this.mapToolbar.addClass("animated"),this._hideToobarOptions(a);var c=this._removeOverlayPropertiesBar(!1,a);this.overlayPropertiesBar||(this.overlayPropertiesBar=new cdb.admin.OverlayPropertiesBar({model:a,mapView:this.mapView,overlays:this.overlays,canvas:this.canvas,vis:this.vis,form_data:b}),this.addView(this.overlayPropertiesBar),this.overlayPropertiesBar.bind("remove",this._removeOverlayPropertiesBar,this),this.mapToolbar.append(this.overlayPropertiesBar.render().el),c?this.overlayPropertiesBar.$el.css({top:0}):this.overlayPropertiesBar.$el.animate({top:0},{duration:200,easing:"easeInOutQuad"}))},_toggleOverlay:function(a,b){if(this._reloadDraggable(),b){var c=100+900*Math.random();setTimeout(function(){a.model.get("display")&&a.show()},c)}else a.model.get("display")&&a.show()},_reloadDraggable:function(){$(".overlay").draggableOverlay({container:$(".cartodb-map"),stickiness:10})},_setupShareOverlay:function(a,b){var c=this.share=new cdb.admin.overlays[a]({model:b,map:this.map});return c.show(),this._bindShareOverlay(c),c},_bindShareOverlay:function(a){var b=this;this._positionShareOverlay(a.model),this._positionOverlaysHorizontally();var c=function(){b.share&&(b.share.clean(),delete b.share),b._positionOverlaysHorizontally()};a.model.bind("destroy",c,this)},_setupLoaderOverlay:function(a,b){if(!this.loader){var c=this.loader=new cdb.admin.overlays[a]({model:b,map:this.vis.map});return this._bindLoaderOverlay(c),c}},_bindLoaderOverlay:function(a){this._positionLoaderOverlay(a.model)},_setupFullScreenOverlay:function(a,b){if(!this.fullscreen){var c=this.fullscreen=new cdb.admin.overlays[a]({model:b,mapView:this.mapView});return this._bindFullScreenOverlay(c),c}},_bindFullScreenOverlay:function(a){var b=this;this._positionOverlay(a.model);
var c=function(){b.fullscreen&&(b.fullscreen.clean(),delete b.fullscreen)};a.show(),a.model.bind("destroy",c,this)},_setupLayerSelectorOverlay:function(a,b){if(!this.layer_selector){var c=this.layer_selector=new cdb.admin.overlays[a]({model:b,mapView:this.mapView,template:this.getTemplate("table/views/layer_selector"),dropdown_template:this.getTemplate("table/views/layer_dropdown")});return c.show(),this._bindLayerSelectorOverlay(c),c}},_bindLayerSelectorOverlay:function(a){var b=this;this._positionOverlay(a.model);var c=function(){b.layer_selector&&(b.layer_selector.clean(),delete b.layer_selector)};a.model.bind("destroy",c,this)},_setupZoomOverlay:function(a,b){if(!this.zoom){var c=this.zoom=new cdb.admin.overlays[a]({model:b,map:this.vis.map});return c.show(),this._bindZoomOverlay(c),c}},_bindZoomOverlay:function(a){for(var b=this,c=this.vertical_overlays.indexOf(a.model.get("type")),d=c;d<this.vertical_overlays.length;d++){var e=this.vertical_overlays[d],f=this._getOverlay(e);f&&this._positionOverlay(f)}var g=function(){b.zoom&&(b.zoom.clean(),delete b.zoom);for(var c=this.vertical_overlays.indexOf(a.model.get("type")),d=c+1;d<this.vertical_overlays.length;d++){var e=this.vertical_overlays[d],f=this._getOverlay(e);f&&this._positionOverlay(f)}};a.model.bind("destroy",g,this)},_setupCartoDBLogo:function(a,b){var c=this.cartodb_logo=new cdb.admin.overlays[a]({model:b,map:this.map});return c},_setupSearchOverlay:function(a,b){if(!this.search){var c=this.search=new cdb.admin.overlays[a]({model:b,relative_position:"table"===this.vis.get("type"),map:this.map});return this._bindSearchOverlay(c),c}},_bindSearchOverlay:function(a){var b=this;this._positionSearchOverlay(a.model),this._positionOverlaysHorizontally();var c=function(){b.search&&(b.search.clean(),delete b.search),b._positionOverlaysHorizontally()};a.model.bind("destroy",c,this)},_setupHeaderOverlay:function(a,b){var c=this.header=new cdb.admin.overlays[a]({model:b,map:this.map});return this._bindHeaderOverlay(c),c},_bindHeaderOverlay:function(a){var b=this,c=function(){b.header&&(b.header.clean(),delete b.header),b._positionOverlaysVertically()};a.bind("change_y",this._positionOverlaysVertically,this),a.model.bind("destroy",c,this)},_getHeaderHeight:function(){return $(".header.overlay-static").outerHeight(!0)||20},_positionOverlay:function(a){if(a){var b=a.get("type");"header"===b?this._positionHeaderOverlay(a):"zoom"===b?this._positionZoomOverlay(a):"fullscreen"===b?this._positionFullScreenOverlay(a):"share"===b?this._positionShareOverlay(a):"loader"===b?this._positionLoaderOverlay(a):"search"===b?this._positionSearchOverlay(a):"layer_selector"===b&&this._positionLayerSelectorOverlay(a)}},_positionHeaderOverlay:function(a){this.headerMessageIsVisible&&"desktop"===this.canvas.get("mode")?a.set("y",20):a.set("y",0)},_positionSearchOverlay:function(a){var b=this.header?this._getHeaderHeight()+20:20,c=this.share?60:20;this.headerMessageIsVisible&&"desktop"===this.canvas.get("mode")?a.set("y",this._getHeaderHeight()+40):a.set("y",b),a.set("x",c)},_positionLayerSelectorOverlay:function(a){var b=20,c=20;this.header&&(b=this._getHeaderHeight()+20),this.search&&this.share?c=220:this.search?c=180:this.share&&(c=60),a.set("x",c),this.headerMessageIsVisible&&"desktop"===this.canvas.get("mode")?a.set("y",this._getHeaderHeight()+40):a.set("y",b)},_positionShareOverlay:function(a){var b=this.header?this._getHeaderHeight()+20:20;this.headerMessageIsVisible&&"desktop"===this.canvas.get("mode")?a.set("y",this._getHeaderHeight()+40):a.set("y",b)},_positionLoaderOverlay:function(a){var b=this.headerMessageIsVisible&&"desktop"===this.canvas.get("mode"),c=20;"mobile"===this.canvas.get("mode")&&this.header?c=this._getHeaderHeight()+20:this.fullscreen?c=this.fullscreen.model.get("y")+40:this.zoom?c=this.zoom.model.get("y")+120:this.header?c=this._getHeaderHeight()+20:b&&(c=this._getHeaderHeight()+40),a.set("y",c)},_positionZoomOverlay:function(a){var b=this.header?this._getHeaderHeight()+20:20;this.headerMessageIsVisible?a.set("y",this._getHeaderHeight()+40):a.set("y",b)},_positionFullScreenOverlay:function(a){this.zoom?a.set("y",this.zoom.model.get("y")+120):this.header?a.set("y",this._getHeaderHeight()+20):this.headerMessageIsVisible&&"desktop"===this.canvas.get("mode")?a.set("y",this._getHeaderHeight()+40):a.set("y",20)}}),cdb.admin.overlays.MobileLayers=cdb.core.View.extend({className:"layer-container",template:cdb.core.Template.compile('<div class="scrollpane"><ul class="layers"></ul></div>'),initialize:function(){this.layers=[],this.layerViews=[],this.model=new Backbone.Model({layer_count:0,show_title:this.options.show_title,force_hidden_title:this.options.force_hidden_title,show_layer_selector:this.options.show_layer_selector,show_legends:this.options.show_legends||!1}),this.model.on("change:layer_count",this._onChangeLayerCount,this),this.model.on("change:show_title",this._onChangeShowTitle,this),this.model.on("change:show_legends",this._onChangeShowLegends,this),this.model.on("change:show_layer_selector",this._onChangeShowLayerSelector,this),this.map=this.options.map,this.mapView=this.options.mapView,this.map.layers.on("change",function(){this._reloadLayers()},this),_.each(this.map.layers.models,this._getLayer,this)},getLayerCount:function(){return this.layerViews.length},_onChangeShowLayerSelector:function(){this._reloadLayers()},_onChangeShowLegends:function(){this._reloadLayers()},_onChangeLayerCount:function(){var a=this.model.get("layer_count");if(0===a)this.trigger("hide-layers",this),this.model.get("force_hidden_title")||this.model.set("show_title",!1);else{this.trigger("show-layers",this);var b=a+" layer"+(1!=a?"s":"");this.$el.find(" > h3").text(b),this.model.get("force_hidden_title")||this.model.set("show_title",!0)}},_onChangeShowTitle:function(){this.model.get("show_title")?this._showTitle():this._hideTitle()},_addTitle:function(){var a=this.model.get("layer_count"),b=a+" layer"+(1!=a?"s":"");this.$el.prepend("<h3>"+b+"</h3>"),this.model.get("show_title")||this.$el.find("> h3").hide()},showTitle:function(a){a&&this.model.set("force_hidden_title",!1),this.model.set("show_title",!0)},hideTitle:function(a){a&&this.model.set("force_hidden_title",!0),this.model.set("show_title",!1)},_showTitle:function(){this.$el.find("> h3").show()},_hideTitle:function(){this.$el.find("> h3").hide()},showLayerSelector:function(){this.model.set("show_layer_selector",!0)},hideLayerSelector:function(){this.model.set("show_layer_selector",!1)},toggleLegends:function(){this.model.set("show_legends",!this.model.get("show_legends"))},_getLayer:function(a){("CartoDB"===a.get("type")||"torque"===a.get("type"))&&this.layers.push(a)},_renderLayer:function(a){var b=a.legend&&""!==a.legend.get("type")&&"none"!==a.legend.get("type"),c=this.model.get("show_layer_selector"),d=this.model.get("show_legends"),e=new cdb.admin.overlays.MobileLayer({model:a,show_legends:d,show_title:c,hide_toggle:!c});if("torque"===e.model.get("type")&&e.model.get("visible")){var f=this._getTorqueLayer();this.trigger("add-torque",f)}(c||d)&&(c||b)&&(c||a.get("visible"))&&(a.wizard_properties&&(a.wizard_properties.off("change",this._onChangeWizardProperties,this),a.wizard_properties.on("change",this._onChangeWizardProperties,this)),this.layerViews.push(e),this.addView(e),this.$el.find(".layers").append(e.render().$el),e.bind("change_visibility",this._reInitScrollpane,this))},_onChangeWizardProperties:function(a){this._reloadLayers()},_getTorqueLayer:function(){var a=this.map.layers.getLayersByType("torque")[0];return a?this.mapView.getLayerByCid(a.cid):void 0},_reloadLayers:function(){this.layers=[],_.each(this.map.layers.models,this._getLayer,this),this._removeTorque(),this._removeLayers(),this._renderLayers()},_removeTorque:function(){this.trigger("remove-torque",this)},_removeLayers:function(){_.each(this.layerViews,function(a){a.clean()},this),this.layerViews=[]},_renderLayers:function(){_.each(this.layers,this._renderLayer,this),this.model.set("layer_count",this.layerViews.length),this._reInitScrollpane()},_reInitScrollpane:function(){this.$(".scrollpane").data("jsp")&&this.$(".scrollpane").data("jsp").reinitialise()},render:function(){return this.$el.append(this.template),this._renderLayers(),this._addTitle(),this}}),cdb.admin.overlays.MobileHeader=cdb.core.View.extend({className:"hgroup",template:_.template('<% if (show_title) { %><div class="title"><%- title %></div><% } %><% if (show_description) { %><div class="description"><%- description %><% } %></div>'),initialize:function(){this.model.get("extra");this.model.on("change:title",this._onChangeTitle,this),this.model.on("change:description",this._onChangeDescription,this),this.model.on("change:show_title",this._onChangeShowTitle,this),this.model.on("change:show_description",this._onChangeShowDescription,this)},_onChangeShowTitle:function(){this.render()},_onChangeShowDescription:function(){this.render()},_onChangeTitle:function(){this.render()},_onChangeDescription:function(){this.render()},render:function(){var a=this.model.get("extra"),b=!1,c=!1;return a.title&&a.show_title&&(b=!0),a.description&&a.show_description&&(c=!0),this.$el.html(this.template({title:a.title,show_title:b,description:a.description,show_description:c})),this}}),cdb.admin.overlays.MobileLayer=cdb.core.View.extend({tagName:"li",events:{"click h3":"_toggle",dblclick:"_stopPropagation"},className:"cartodb-mobile-layer",template:cdb.core.Template.compile("<% if (show_title) { %><h3><span><%- layer_name %></span><% } %><a href='#' class='toggle<%- toggle_class %>'></a></h3>"),_stopPropagation:function(a){a.stopPropagation()},initialize:function(){_.defaults(this.options,this.default_options),this.model.on("change:table_name_alias",this._onChangeLayerName,this),this.model.on("change:visible",this._onChangeVisible,this),this.model.legend&&(this.model.legend.off("add change remove",this._reloadLegend,this),this.model.legend.on("add change remove",this._reloadLegend,this))},_onChangeLayerName:function(){this.$el.find("h3 span",this._getLayerName())},_onChangeVisible:function(){this.$el.find(".legend")[this.model.get("visible")?"fadeIn":"fadeOut"](150),this.$el[this.model.get("visible")?"removeClass":"addClass"]("hidden"),this.trigger("change_visibility",this)},_toggle:function(a){a.preventDefault(),a.stopPropagation(),this.options.hide_toggle||this.model.set("visible",!this.model.get("visible"))},_reloadLegend:function(){this.$el.removeClass("has-legend"),this.legend&&(this.legend.clean(),delete this.legend),this._renderLegend()},_renderLegend:function(){this.options.show_legends&&(!this.model.legend||"none"!==this.model.legend.get("type")&&this.model.legend.get("type"))&&(this.model.legend&&this.model.legend.get("items")&&0===this.model.legend.get("items").length||(this.$el.addClass("has-legend"),this.legend=new cdb.geo.ui.Legend({model:this.model.legend}),this.addView(this.legend),this.legend.undelegateEvents(),this.$el.append(this.legend.render().$el)))},_truncate:function(a,b){return a.substr(0,b-1)+(a.length>b?"&hellip;":"")},_getLayerName:function(){return this.model.get("table_name_alias")||this.model.get("table_name")},render:function(){var a=_.extend(this.model.attributes,{show_title:this.options.show_title,layer_name:this._getLayerName(),toggle_class:this.options.hide_toggle?" hide":""});return this.$el.html(this.template(a)),this.model.get("visible")||this.$el.addClass("hidden"),this.model.get("legend")&&this._renderLegend(),this._onChangeVisible(),this}}),cdb.admin.overlays.Mobile=cdb.core.View.extend({className:"cartodb-mobile",template_name:"table/views/mobile",events:{"click .cartodb-attribution-button":"_onAttributionClick","click .toggle":"_toggle","click .fullscreen":"_toggleFullScreen","click .backdrop":"_onBackdropClick","dblclick .aside":"_stopPropagation","dragstart .aside":"_checkOrigin","mousedown .aside":"_checkOrigin","touchstart .aside":"_checkOrigin","MSPointerDown .aside":"_checkOrigin"},initialize:function(){_.bindAll(this,"_toggle","_reInitScrollpane"),_.defaults(this.options,this.default_options),this.visibility_options=this.options.visibility_options||{},this.mapView=this.options.mapView,this.map=this.mapView.map,this.map.on("change:legends",this._toggleLegends,this),this.template=this.options.template?this.options.template:this.getTemplate(this.template_name),this._bindOverlays(),this.model=new Backbone.Model({open:!1,show_layer_selector:!1}),this.model.on("change:open",this._onChangeOpen,this)},show:function(){this.$el.fadeIn(250)},hide:function(){this.$el.fadeOut(250)},_checkOrigin:function(a){var b=$(a.target).closest(".jspVerticalBar").length>0&&"touchstart"!=a.type;b||a.stopPropagation()},_stopPropagation:function(a){a.stopPropagation()},_onBackdropClick:function(a){a.preventDefault(),a.stopPropagation(),this.$el.find(".backdrop").fadeOut(250),this.$el.find(".cartodb-attribution").fadeOut(250)},_onAttributionClick:function(a){a.preventDefault(),a.stopPropagation(),this.$el.find(".backdrop").fadeIn(250),this.$el.find(".cartodb-attribution").fadeIn(250)},_toggle:function(a){a.preventDefault(),a.stopPropagation(),this.model.set("open",!this.model.get("open"))},_toggleLegends:function(){this.layers.toggleLegends()},_toggleFullScreen:function(a){a.stopPropagation(),a.preventDefault();var b=window.document,c=b.documentElement;this.options.doc&&(c=$(this.options.doc)[0]);var d=c.requestFullscreen||c.mozRequestFullScreen||c.webkitRequestFullScreen,e=b.exitFullscreen||b.mozCancelFullScreen||b.webkitExitFullscreen,f=this.options.mapView;b.fullscreenElement||b.mozFullScreenElement||b.webkitFullscreenElement?e.call(b):(d.call(c),f&&this.model.get("allowWheelOnFullscreen")&&f.options.map.set("scrollwheel",!0))},_open:function(){var a=this.$el.find(".aside").width();this.$el.find(".cartodb-header").animate({right:a},200),this.$el.find(".aside").animate({right:0},200),this.$el.find(".cartodb-attribution-button").animate({right:a+parseInt(this.$el.find(".cartodb-attribution-button").css("right"))},200),this.$el.find(".cartodb-attribution").animate({right:a+parseInt(this.$el.find(".cartodb-attribution-button").css("right"))},200),this._initScrollPane()},_close:function(){this.$el.find(".cartodb-header").animate({right:0},200),this.$el.find(".aside").animate({right:-this.$el.find(".aside").width()},200),this.$el.find(".cartodb-attribution-button").animate({right:20},200),this.$el.find(".cartodb-attribution").animate({right:20},200)},default_options:{timeout:0,msg:""},_stopPropagation:function(a){a.stopPropagation()},_bindOverlays:function(){this.overlays=this.options.overlays,this.overlays.on("add",function(){this._resetOverlays()},this),this.overlays.on("remove",function(){this._resetOverlays()},this)},_onChangeOpen:function(){this.model.get("open")?this._open():this._close()},_createLayer:function(a,b){return new cdb.geo.ui[a](b)},_reInitScrollpane:function(){this.$(".scrollpane").data("jsp")&&this.$(".scrollpane").data("jsp").reinitialise()},_removeOverlays:function(){this._removeLayerSelector(),this._removeHeader(),this._removeSearch(),this._removeFullscreen()},_resetOverlays:function(){this._removeOverlays(),this._renderOverlays(),this.model.get("show_layer_selector")||this.model.get("show_search")||this.map.get("legends")||this.model.set("open",!1),0!==this.layers.layers.length||this.model.get("search")||this.model.set("open",!1)},_renderOverlays:function(){_.each(this.overlays.models,function(a){var b=a.get("type");"search"===b&&this._addSearch(a),"layer_selector"===b&&this._addLayerSelector(),"fullscreen"===b&&this._addFullscreen(a),"header"===b&&this._addHeader(a)},this)},render:function(){return this.$el.html(this.template(this.options)),this._renderOverlays(),this._addAttributions(),this._addLayers(),this},_initScrollPane:function(){if(!this.$scrollpane){var a=this,b=this.$el.height();this.$scrollpane=this.$el.find(".scrollpane"),setTimeout(function(){a.$scrollpane.css("max-height",b-60),a.$scrollpane.jScrollPane({showArrows:!0})},500)}},_removeLayerSelector:function(){this.model.set("show_layer_selector",!1),this.layers&&this.layers.hideLayerSelector()},_addLayerSelector:function(a){this.model.set("show_layer_selector",!0),this.layers&&this.layers.showLayerSelector()},_addFullscreen:function(a){this.$el.addClass("with-fullscreen")},_addSearch:function(a){this.model.set("show_search",!0),this.search=new cdb.geo.ui.Search({template:this.getTemplate("table/views/search_control"),model:this.options.map}),this.addView(this.search),this.$el.addClass("with-search"),this.$el.find(".aside").prepend(this.search.render().$el),this.search.$el.find("input[type='text']").attr("placeholder","Search for places…"),this.layers&&this.layers.hideTitle(!0)},_addHeader:function(a){this.header=new cdb.admin.overlays.MobileHeader({model:a}),this.addView(this.header),this.$el.addClass("with-header"),this.$el.find(".cartodb-header .content").append(this.header.render().$el)},_removeFullscreen:function(){this.$el.removeClass("with-fullscreen")},_removeSearch:function(){this.model.set("show_search",!1),this.$el.removeClass("with-search"),this.search&&(this.search.clean(),delete this.search),this.layers&&this.layers.showTitle()},_removeHeader:function(){this.$el.removeClass("with-header"),this.header&&(this.header.clean(),delete this.header)},_addAttributions:function(){var a="";this.options.mapView.$el.find(".leaflet-control-attribution").hide(),this.options.layerView?(a=this.options.layerView.model.get("attribution"),this.$el.find(".cartodb-attribution").append(a)):this.options.map.get("attribution")&&(a=this.options.map.get("attribution"),_.each(a,function(a){var b=$("<li></li>");b.html(a);this.$el.find(".cartodb-attribution").append(b)},this)),a&&this.$el.find(".cartodb-attribution-button").fadeIn(250)},_removeLayers:function(){this.$el.removeClass("with-layers"),this.layers&&(this.layers.clean(),delete this.layers)},_addLayers:function(){this.layers=new cdb.admin.overlays.MobileLayers({map:this.map,mapView:this.mapView,show_legends:this.map.get("legends"),show_title:!this.model.get("show_search"),force_hidden_title:this.model.get("show_search"),show_layer_selector:this.model.get("show_layer_selector")}),this.layers.bind("remove-torque",function(a){this._removeTorque()},this),this.layers.bind("add-torque",function(a){this._addTorqueLayer(a)},this),this.layers.bind("show-layers",function(){this.$el.addClass("with-layers")},this),this.layers.bind("hide-layers",function(){this.$el.removeClass("with-layers")},this),this.addView(this.layers),this.$el.find(".aside").append(this.layers.render().$el)},_removeTorque:function(){this.$el.removeClass("with-torque"),this.slider&&(this.slider.clean(),this.slider=null)},_addTorqueLayer:function(a){this.slider=new cdb.geo.ui.TimeSlider({type:"time_slider",layer:a,map:this.options.map,pos_margin:0,position:"none",width:"auto"}),this.addView(this.slider),this.slider.bind("time_clicked",function(){this.slider.toggleTime()},this),this.$el.find(".torque").append(this.slider.render().$el),this.$el.addClass("with-torque")}}),cdb.admin.OverlayPropertiesActions=cdb.core.View.extend({events:{"click .btn-copy":"_onClickCopy","click .btn-delete":"_onClickDelete","click .btn-zIndexInc":"_onClickZIndexInc","click .btn-zIndexDec":"_onClickZIndexDec"},initialize:function(){this.template_base=cdb.templates.getTemplate(this.options.template_base)},_onClickCopy:function(a){this.killEvent(a),this.trigger("copy-overlay",this)},_onClickDelete:function(a){a.preventDefault(),this.trigger("delete-overlay",this)},_onClickZIndexInc:function(a){this.killEvent(a),this.trigger("increase-zindex",this)},_onClickZIndexDec:function(a){this.killEvent(a),this.trigger("decrease-zindex",this)},_enableTipsy:function(){var a=this;_.each(this.$("a[title]"),function(b){var c=new cdb.common.TipsyTooltip({el:$(b)});a.addView(c)})},render:function(){return this.clearSubViews(),this.setElement(this.template_base(this.options)),this._enableTipsy(),this}}),cdb.admin.OverlayPropertiesBar=cdb.core.View.extend({className:"overlay-properties",events:{click:"killEvent"},initialize:function(){this.overlays=this.options.overlays,this._setupModel(),this._addStyleModel()},_setupModel:function(){this.model=this.options.model,this.model.bind("remove",this._remove,this)},_addStyleModel:function(){this.style=new cdb.core.Model(this.model.get("style")),this.style.unbind("change",this._setStyle,this),this.style.bind("change",this._setStyle,this)},_setStyle:function(){this.model.set("style",this.style.toJSON())},_addForm:function(){var a=this;this.form||(this.form=new cdb.forms.Form({form_data:this.options.form_data,model:this.style}).on("saved",function(){a.trigger("saved",a)}),this.addView(this.form),this.$el.append(this.form.render().$el))},_addActions:function(){var a=this;this.actions||(this.actions=new cdb.admin.OverlayPropertiesActions({template_base:"table/views/overlays/overlay_properties_actions",model:this.model}).on("copy-overlay",function(){a._duplicateOverlay(a.model),a.trigger("copy-overlay",a.model,a)}).on("delete-overlay",function(){a.overlays.remove(a.model)}).on("decrease-zindex",function(){a._decreaseOverlayZIndex(a.model)}).on("increase-zindex",function(){a._increaseOverlayZIndex(a.model)}).on("saved",function(){a.trigger("saved",a)}),this.addView(this.actions),this.$el.find("> ul").append(this.actions.render().$el))},_decreaseOverlayZIndex:function(a){var b=this._getOverlaysZIndex(),c=_.min(b),d=_.clone(a.get("style"));d["z-index"]=c-1,a.set("style",d)},_increaseOverlayZIndex:function(a){var b=this._getOverlaysZIndex(),c=_.max(b),d=_.clone(a.get("style"));d["z-index"]=c+1,a.set("style",d)},_getOverlaysZIndex:function(){var a=this.options.canvas.get("mode"),b=this.overlays.filter(function(b){return b.get("device")===a&&("text"===b.get("type")||"annotation"===b.get("type")||"image"===b.get("type"))});return _.map(b,function(a){return parseInt(a.get("style")["z-index"])})},_duplicateOverlay:function(a){var b=a.cloneAttributes(),c=a.get("x")+20+Math.round(20*Math.random()),d=a.get("y")+20+Math.round(20*Math.random()),e=this._getOverlaysZIndex(),f=_.max(e),g=b.extra,h=b.style;h["z-index"]=f+1,"annotation"===a.get("type")?g.latlng=this.options.mapView.map.get("center"):(b.x=c,b.y=d),b.id=null,b.style=h,b.extra=g;var b=new cdb.admin.models.Overlay(b);this.overlays.add(b),b.save()},_remove:function(a,b){cdb.god.unbind("closeDialogs",this._remove,this),this.trigger("remove",this)},deselectOverlay:function(){this.model.set("selected",!1)},compareModel:function(a){return a&&this.model===a},render:function(){return this._addForm(),this._addActions(),cdb.god.bind("closeDialogs",this._remove,this),this}}),cdb.admin.OverlayPropertiesDropdown=cdb.ui.common.Dropdown.extend({className:"dropdown properties_dropdown",defaults:{speedOut:100,speedIn:100},events:{click:"killEvent",dblclick:"killEvent"},initialize:function(){_.bindAll(this,"open","hide","_handleClick","_onKeyDown"),_.defaults(this.options,this.defaults),this.template_base=cdb.templates.getTemplate(this.options.template_base),$(this.options.target).bind({click:this._handleClick}),this._addStyleModel(),$(document).bind("keydown",this._onKeyDown),this.isOpen=!1,this.options.original_vertical_position=this.options.vertical_position},_handleClick:function(a){a&&a.preventDefault(),this.isOpen?this.hide():this.open()},_addStyleModel:function(){this.style=new cdb.core.Model(this.model.get("style")),this.style.bind("change",function(){this.model.set("style",this.style.toJSON())},this)},_adjustPosition:function(){var a=this.$el.offset().top,b=this.$el.offset().left,c=this.$el.width(),d=this.$el.height(),e=$(".cartodb-map"),f=e.width(),g=e.height(),h=e.offset().top,i=e.offset().left;b+c-i>f&&this.$el.css({left:"auto",right:-6}).removeClass("tick_left").addClass("tick_right"),a+d-h>g&&this.$el.css({top:-d-13})},show:function(){var a=this,b=$.Deferred(),c=this.options.target;this.options.target=c;var d=this.options.target.position().top,e=this.options.target.position().left;"offset"===this.options.offset_mode&&(d=this.options.target.offset().top,e=this.options.target.offset().left);var f=d+this.options.vertical_offset,g=e+this.options.horizontal_offset;return this.delegateEvents(),this.$el.css({top:f,left:g,marginTop:"down"==a.options.vertical_position?"-10px":"10px",opacity:0,display:"block"}).animate({margin:"0",opacity:1},{duration:this.options.speedIn,complete:function(){b.resolve()}}),"offset"!==this.options.offset_mode&&this._adjustPosition(),this.trigger("onDropdownShown",this.el),b.promise()},move:function(a){var b=$.Deferred(),c=this.options.target;this.options.target=c;var d=this.options.target.position().top,e=this.options.target.position().left;"offset"===this.options.offset_mode&&(d=this.options.target.offset().top,e=this.options.target.offset().left);var f=d+this.options.vertical_offset,g=e+this.options.horizontal_offset;return this.delegateEvents(),a?this.$el.css({marginTop:0,display:"block"}).animate({top:f,left:g},{duration:this.options.speedIn,complete:function(){b.resolve()}}):this.$el.css({top:f,left:g,marginTop:0,display:"block"}).animate({},{duration:this.options.speedIn,complete:function(){b.resolve()}}),"offset"!==this.options.offset_mode&&this._adjustPosition(),this.trigger("onDropdownShown",this.el),b.promise()},open:function(a,b){var c=b&&$(b)||this.options.target;if(this.options.target=c,this.$el.removeClass("vertical_top"),this.$el.removeClass("vertical_bottom"),"offset"!==this.options.offset_mode)var d=this.options.target.offset().top+this.options.vertical_offset+this.$el.height()-$(".cartodb-map").offset().top>$(".cartodb-map").height();d?this.options.vertical_position="up":this.options.vertical_position=this.options.original_vertical_position,this.$el.css({top:this.options.target.offset().top+this.options.vertical_offset,left:this.options.target.position().left+this.options.horizontal_offset}).addClass(("up"==this.options.vertical_position?"vertical_top":"vertical_bottom")+" "+("right"==this.options.horizontal_position?"horizontal_right":"horizontal_left")+" border tick_"+this.options.tick),this.show(),this._recalcHeight(),this.isOpen=!0},_onKeyDown:function(a){27===a.keyCode&&this.hide()},hide:function(a){if(!this.isOpen)return void(a&&a());var b=this;this.isOpen=!1,this.$el.animate({marginTop:"down"==b.options.vertical_position?"10px":"-10px",opacity:0},this.options.speedOut,function(){b.$el.hide()}),this.trigger("onDropdownHidden",this.el)},_recalcHeight:function(){var a=this.$el.find("ul.special");a.height("auto"),a.parent().height("auto");var b=a.height(),c=a.parent().height();c>b?a.css("height",c):a.parent().height(b)},_addForm:function(){var a=(this.options.properties,this);this.form=new cdb.forms.Form({form_data:this.options.form_data,model:this.style}).on("saved",function(){a.trigger("saved",a)}),this.addView(this.form),this.$el.append(this.form.render().$el)},render:function(){return this.clearSubViews(),this.$el.html(this.template_base(this.options)),this._addForm(),this}}),cdb.admin.overlays=cdb.admin.overlays||{},cdb.admin.models.Overlay=cdb.core.Model.extend({defaults:{order:1},sync:Backbone.syncAbort,url:function(a){var b=cdb.config.urlVersion("overlays",a),c="/api/"+b+"/viz/"+this.collection.vis.id+"/overlays";return this.isNew()?c:c+"/"+this.id},_clone:function(a){var b;if(null==a||"object"!=typeof a)return a;if(a instanceof Array){b=[];for(var c=0,d=a.length;d>c;c++)b[c]=this._clone(a[c]);return b}if(a instanceof Object){b={};for(var e in a)a.hasOwnProperty(e)&&(b[e]=this._clone(a[e]));return b}throw new Error("Type not supported")},cloneAttributes:function(){return this._clone(this.attributes)},toJSON:function(){return{template:this.get("template"),order:this.get("order"),type:this.get("type"),options:{x:this.get("x"),y:this.get("y"),device:this.get("device"),display:this.get("display"),style:this.get("style"),extra:this.get("extra")}}},parse:function(a){a.display=a.options.display;var b=a.options;return b&&(b="string"==typeof b?JSON.parse(b):b,_.extend(a,{x:b.x,y:b.y,oder:b.order,device:b.device,extra:b.extra,style:b.style,display:b.display})),delete a.options.display,a},clone:function(){return new cdb.admin.models.Overlay(_.omit(_.clone(this.attributes),"id","parent_id"))}}),cdb.admin.Overlays=Backbone.Collection.extend({model:cdb.admin.models.Overlay,url:function(a){var b=cdb.config.urlVersion("overlays",a);return"/api/"+b+"/viz/"+this.vis.get("id")+"/overlays"},comparator:function(a){return a.get("order")},initialize:function(){this._bindOverlays()},_bindOverlays:function(){this.bind("reset",function(){var a=this.filter(function(a){return"header"===a.get("type")});if(a.length){var b=this;this.vis.on("change:name change:description",function(){a[0].set({title:this.get("name"),description:b._getMarkdown(this.get("description"))})},this.vis)}},this)},createOverlayByType:function(a,b){var c={fullscreen:this._createFullScreenOverlay,header:this._createHeaderOverlay,layer_selector:this._createLayerSelectorOverlay,share:this._createShareOverlay,search:this._createSearchOverlay,zoom:this._createZoomOverlay,logo:this._createLogoOverlay},d=c[a];return d?d.call(this,b):void 0},_createZoomOverlay:function(){var a={type:"zoom",order:6,display:!0,template:'<a href="#zoom_in" class="zoom_in">+</a> <a href="#zoom_out" class="zoom_out">-</a>',x:20,y:20};this.create(a)},_createLogoOverlay:function(){var a={type:"logo",order:10,display:!0,x:10,y:40};this.create(a)},_createSearchOverlay:function(){var a={type:"search",order:3,display:!0,x:60,y:20};this.create(a)},_createLayerSelectorOverlay:function(){var a={type:"layer_selector",order:4,display:!0,x:212,y:20};this.create(a)},_createShareOverlay:function(){var a={type:"share",order:2,display:!0,x:20,y:20};this.create(a)},_getMarkdown:function(a){return a?$(markdown.toHTML(a)).html():""},_createHeaderOverlay:function(a){var b=this,c=!1,d=!1;"title"===a&&(c=!0),"description"===a&&(d=!0);var e=this.vis.get("description"),f=this.vis.get("name");if(c||"description"!=a||e){var g={type:"header",order:1,display:!0,extra:{title:f,description:e,show_title:c,show_description:d}},h=this.create(g),i=this.vis;this.vis.on("change:name change:description",function(){h.set({title:i.get("name"),description:b._getMarkdown(i.get("description"))})},h),h.bind("destroy",function(){i.unbind(null,null,h)})}},_createFullScreenOverlay:function(){var a={type:"fullscreen",order:7,display:!0,x:20,y:172};this.create(a)}}),cdb.admin.OverlaysDropdownItem=cdb.core.View.extend({tagName:"li",events:{"click a":"_onClick"},initialize:function(){this.template=this.getTemplate(this.options.template_name),this.collection=this.options.collection,this.model=new cdb.core.Model,this.model.on("change:active",this._onChangeActive,this),this.model.set("active",this.options.active)},_onClick:function(a){a.preventDefault(),a.stopPropagation(),this.trigger("click",this)},_onChangeActive:function(){this.model.get("active")?this.$el.addClass("active"):this.$el.removeClass("active")},render:function(){return this.$el.append(this.template(this.options)),this}}),cdb.admin.OverlaysDropdown=cdb.ui.common.Dropdown.extend({className:"dropdown widgets_dropdown",defaults:{speedOut:100,speedIn:100},placeholders:{public_default_image:"overlay_placeholder_cartofante.png",default_image:"overlay_placeholder.png"},events:{click:"killEvent"},initialize:function(){_.bindAll(this,"open","hide","_handleClick","_onKeyDown"),_.defaults(this.options,this.defaults),this.template_base=cdb.templates.getTemplate(this.options.template_base),this.vis=this.options.vis,this.canvas=this.options.canvas,this.mapView=this.options.mapView,$(this.options.target).bind({click:this._handleClick}),$(document).bind("keydown",this._onKeyDown),this.isOpen=!1},_isDesktop:function(){return"desktop"===this.canvas.get("mode")},_handleClick:function(a){a&&a.preventDefault(),this.isOpen?this.hide():this.open()},show:function(){var a=$.Deferred();return this.delegateEvents(),this.$el.css({marginTop:"-10px",opacity:0,display:"block"}).animate({margin:"0",
opacity:1},{duration:this.options.speedIn,complete:function(){a.resolve()}}),this.trigger("onDropdownShown",this.el),a.promise()},open:function(a,b){cdb.god.trigger("closeDialogs");var c=b&&$(b)||this.options.target;this.options.target=c,this.$el.css({top:40,left:0}).addClass(("up"===this.options.vertical_position?"vertical_top":"vertical_bottom")+" "+("right"===this.options.horizontal_position?"horizontal_right":"horizontal_left")+" border tick_"+this.options.tick),this.show(),this._recalcHeight(),this.isOpen=!0,this.trigger("onOverlayDropdownOpen",this)},_onKeyDown:function(a){27===a.keyCode&&this.hide()},hide:function(a){if(!this.isOpen)return void(a&&a());var b=this;this.isOpen=!1,this.$el.animate({marginTop:"down"===b.options.vertical_position?"10px":"-10px",opacity:0},this.options.speedOut,function(){b.$el.hide()}),this.trigger("onDropdownHidden",this.el)},_recalcHeight:function(){var a=this.$el.find("ul.special");a.height("auto"),a.parent().height("auto");var b=a.height(),c=a.parent().height();c>b?a.css("height",c):a.parent().height(b)},_addOverlay:function(a){this.collection.add(a),a.save(),cdb.god.trigger("closeDialogs")},_addLogoOverlay:function(){var a=new cdb.admin.models.Overlay({type:"logo",display:!0});this._addOverlay(a)},_getDefaultImageURL:function(){return cdb.config.get("assets_url")+"/images/layout/"+this.placeholders.default_image},_getPublicDefaultImageURL:function(){return cdb.config.get("assets_url")+"/images/layout/"+this.placeholders.public_default_image},_addImageOverlay:function(){var a=400,b=200,c={"z-index":4,"box-color":"#000000","box-opacity":.7,"box-width":200},d=this._getDefaultImageURL(),e={has_default_image:!0,url:this._getDefaultImageURL(),rendered_text:"<img src='"+d+"' />",default_image_url:d,public_default_image_url:this._getPublicDefaultImageURL()},f=$(".cartodb-map").width()/2-a/2,g=$(".cartodb-map").height()/2-b/2;"mobile"===this.canvas.get("mode")&&(f=33,g=120);var h=new cdb.admin.models.Overlay({type:"image",display:!0,width:a,height:b,device:this.canvas.get("mode"),x:f,y:g,extra:e,style:c});this._addOverlay(h)},_addTitleOverlay:function(){var a=this.vis.get("name"),b=350,c=30,d={"z-index":4,color:"#ffffff","text-align":"left","font-size":this._isDesktop()?"40":"17","font-family-name":"Helvetica","box-padding":10,"box-color":"#000000","box-opacity":.7,"box-width":this._isDesktop?500:200},e={landscapeDirection:"left",pTop:0,pLeft:0,portraitDirection:"top",text:"**"+a+"**",rendered_text:"<strong>"+a+"</strong>"},f=new cdb.admin.models.Overlay({type:"text",display:!0,width:b,height:c,device:this.canvas.get("mode"),x:this._isDesktop()?66:20,y:this._isDesktop()?$(".header").outerHeight()+15:$(".header").outerHeight()+15,extra:e,style:d});this._addOverlay(f)},_addTextOverlay:function(){var a=200,b=30,c={"z-index":4,color:"#ffffff","text-align":"left","font-size":this._isDesktop()?"20":"12","font-family-name":"Helvetica","box-padding":10,"box-color":"#000000","box-opacity":.7,"box-width":300},d={pLeft:"50",pTop:"50",landscapeDirection:"left",portraitDirection:"top",text:"I'm a **text overlay**",rendered_text:"I'm a <strong>text overlay</strong>"},e=new cdb.admin.models.Overlay({type:"text",display:!0,width:a,height:b,device:this.canvas.get("mode"),x:$(".cartodb-map").width()/2-a/2,y:$(".cartodb-map").height()/2-b/2,extra:d,style:c});this._addOverlay(e)},_addAnnotationOverlay:function(){var a={"z-index":4,color:"#ffffff","text-align":"left","font-size":this._isDesktop()?"13":"12","font-family-name":"Helvetica","box-color":"#000000","box-opacity":.7,"box-padding":5,"line-color":"#000000","line-width":this._isDesktop()?50:25,"min-zoom":this.mapView.map.get("minZoom"),"max-zoom":this.mapView.map.get("maxZoom")},b={latlng:this.mapView.map.get("center"),text:this._isDesktop()?"I'm an **annotation overlay**":"Hi! I'm here",rendered_text:this._isDesktop()?"I'm an <strong>annotation overlay</strong>":"Hi! I'm here"},c=new cdb.admin.models.Overlay({type:"annotation",display:!0,device:this.canvas.get("mode"),extra:b,style:a});this._addOverlay(c)},_addButton:function(a,b){var c=new cdb.admin.OverlaysDropdownItem({text:a,template_name:"table/views/overlays/add_widget_dropdown_item"}).on("click",b,this);this.$el.find("ul").append(c.render().$el)},render:function(){return this.clearSubViews(),this.$el.html(this.template_base(this.options)),this._addButton("Add title item",this._addTitleOverlay),this._addButton("Add text item",this._addTextOverlay),this._addButton("Add annotation item",this._addAnnotationOverlay),this._addButton("Add image item",this._addImageOverlay),this}}),cdb.admin.overlays.Search=cdb.core.View.extend({events:{},initialize:function(){_.bindAll(this,"_close"),this._setupModels(),this._addSearchControl()},_killEvent:function(a){a&&a.preventDefault(),a&&a.stopPropagation()},_setupModels:function(){this.model=this.options.model,this.model.on("change:display",this._onChangeDisplay,this),this.model.on("change:y",this._onChangeY,this),this.model.on("change:x",this._onChangeX,this),this.model.on("destroy",function(){this.$el.remove()},this)},_onChangeX:function(){var a=this.model.get("x"),b=this;this.$el.animate({right:a},{duration:150,complete:function(){b.trigger("change_x",this)}})},_onChangeY:function(){var a=this.model.get("y");this.$el.animate({top:a},150)},_onChangeDisplay:function(){var a=this.model.get("display");a?this.show():this.hide()},_addSearchControl:function(){this.searchControl=new cdb.geo.ui.Search({model:this.options.map,map:this.options.map,template:cdb.templates.getTemplate("table/views/search_control")})},_onMouseDown:function(){},_onMouseEnterText:function(){},_onMouseLeaveText:function(){},_onMouseEnter:function(){},_onMouseLeave:function(){},show:function(){var a=this;this.$el.fadeIn(250,function(){a.trigger("change_x",this)})},hide:function(a){var b=this;a&&a(),this.$el.fadeOut(250,function(){b.trigger("change_x",this)})},_close:function(a){this._killEvent(a);var b=this;this.hide(function(){b.trigger("remove",b)})},_toggleDisplay:function(){this.model.get("display")?this.$el.show():this.$el.hide()},_position:function(){var a={top:this.model.get("y")};this.options.relative_position||(a.right=this.model.get("x")),this.$el.css(a)},render:function(){return this.$el=this.searchControl.render().$el,this._toggleDisplay(),this._position(),this}}),cdb.admin.overlays.Share=cdb.core.View.extend({className:"cartodb-share",template_name:"table/views/overlays/share",events:{},initialize:function(){_.bindAll(this,"_close"),this.template=this.getTemplate(this.template_name),this._setupModels()},_killEvent:function(a){a&&a.preventDefault(),a&&a.stopPropagation()},_setupModels:function(){this.model=this.options.model,this.model.on("change:display",this._onChangeDisplay,this),this.model.on("change:y",this._onChangeY,this),this.model.on("change:x",this._onChangeX,this),this.model.on("destroy",function(){this.$el.remove()},this)},_onChangeX:function(){var a=this.model.get("x");this.$el.animate({right:a},150),this.trigger("change_x",this)},_onChangeY:function(){var a=this.model.get("y");this.$el.animate({top:a},150),this.trigger("change_y",this)},_onChangeDisplay:function(){var a=this.model.get("display");a?this.show():this.hide()},_addControl:function(){this.control=new cdb.ui.common.FullScreen({doc:".map",mapView:this.options.mapView,template:this.getTemplate("table/views/fullscreen")})},_onMouseDown:function(){},_onMouseEnterText:function(){},_onMouseLeaveText:function(){},_onMouseEnter:function(){},_onMouseLeave:function(){},show:function(){var a=this;this.$el.fadeIn(250,function(){a.trigger("change_x",this)})},hide:function(a){var b=this;a&&a(),this.$el.fadeOut(250,function(){b.trigger("change_x",this)})},_close:function(a){this._killEvent(a);var b=this;this.hide(function(){b.trigger("remove",b)})},render:function(){return this.$el.append(this.template()),this.$el.css({right:this.model.get("x"),top:this.model.get("y")}),this}}),cdb.admin.overlays.Zoom=cdb.core.View.extend({tagName:"div",className:"cartodb-zoom",events:{"click .zoom_in":"zoom_in","click .zoom_out":"zoom_out"},default_options:{timeout:0,msg:""},template_name:"table/views/overlays/zoom",initialize:function(){_.bindAll(this,"_close"),this.template=this.getTemplate(this.template_name),this.map=this.options.map,_.defaults(this.options,this.default_options),this._setupModels()},_killEvent:function(a){a&&a.preventDefault(),a&&a.stopPropagation()},_setupModels:function(){this.model=this.options.model,this.model.on("change:display",this._onChangeDisplay,this),this.model.on("change:y",this._onChangeY,this),this.map.bind("change:zoom change:minZoom change:maxZoom",this._checkZoom,this),this.model.on("destroy",function(){this.$el.remove()},this)},_onChangeY:function(){var a=this.model.get("y");this.$el.animate({top:a},150),this.trigger("change_y",this)},_onChangeDisplay:function(){var a=this.model.get("display");a?this.show():this.hide()},_checkZoom:function(){var a=this.map.get("zoom");this.$(".zoom_in")[a<this.map.get("maxZoom")?"removeClass":"addClass"]("disabled"),this.$(".zoom_out")[a>this.map.get("minZoom")?"removeClass":"addClass"]("disabled"),this.$el.find(".info").html(a)},zoom_in:function(a){this.map.get("maxZoom")>this.map.getZoom()&&this.map.setZoom(this.map.getZoom()+1),a.preventDefault(),a.stopPropagation()},zoom_out:function(a){this.map.get("minZoom")<this.map.getZoom()&&this.map.setZoom(this.map.getZoom()-1),a.preventDefault(),a.stopPropagation()},_onMouseDown:function(){},_onMouseEnterText:function(){},_onMouseLeaveText:function(){},_onMouseEnter:function(){},_onMouseLeave:function(){},show:function(){var a=this;this.$el.fadeIn(250,function(){a.trigger("change_y",a)})},hide:function(a){var b=this;a&&a(),this.$el.fadeOut(250,function(){b.trigger("change_y",b)})},_close:function(a){this._killEvent(a);var b=this;this.hide(function(){b.trigger("remove",b)})},_toggleFullScreen:function(a){a.stopPropagation(),a.preventDefault();var b=window.document,c=b.documentElement;this.options.doc&&(c=$(this.options.doc)[0]);var d=c.requestFullscreen||c.mozRequestFullScreen||c.webkitRequestFullScreen,e=b.exitFullscreen||b.mozCancelFullScreen||b.webkitExitFullscreen,f=this.options.mapView;b.fullscreenElement||b.mozFullScreenElement||b.webkitFullscreenElement?e.call(b):(d.call(c),f&&this.model.get("allowWheelOnFullscreen")&&f.options.map.set("scrollwheel",!0))},render:function(){return this.$el.append(this.template()),this.$el.css({left:this.model.get("x"),top:this.model.get("y")}),this._checkZoom(),this._createTooltip(),this},_createTooltip:function(a){var b=new cdb.common.TipsyTooltip({el:this.$(".info"),gravity:"w",title:function(){return"zoom level"}});this.addView(b)}}),cdb.admin.RowHeaderDropdown=cdb.admin.DropdownMenu.extend({className:"dropdown border",events:{"click .delete_row":"deleteRow","click .add_row":"addRow"},initialize:function(a){this.tableData=a.tableData,this.table=this.options.table,this.elder("initialize")},openAt:function(a,b){this.$el.removeClass("vertical_top vertical_bottom horizontal_right horigonzal_left tick_top tick_bottom"),this.constructor.__super__.openAt.apply(this,arguments)},show:function(){var a=$.Deferred(),b=this;return this.delegateEvents(),this.$el.css({marginTop:"down"==b.options.vertical_position?"-1px":"-50px",marginLeft:-5,opacity:0,display:"block"}).animate({marginLeft:5,opacity:1},{duration:this.options.speedIn,complete:function(){a.resolve()}}),this.trigger("onDropdownShown",this.el),a.promise()},hide:function(a){if(!this.isOpen)return void(a&&a());var b=this;this.isOpen=!1,this.$el.animate({marginLeft:15,opacity:0},this.options.speedOut,function(){$(b.options.target).removeClass("selected"),b.$el.hide(),a&&a()}),this.trigger("onDropdownHidden",this.el)},setRow:function(a){this.row=a},deleteRow:function(a){var b=this;if(this.killEvent(a),this.options.user.featureEnabled("new_modals")){var c=new cdb.editor.DeleteRowView({table:this.table,row:this.row,clean_on_hide:!0,enter_to_confirm:!0});c.appendToBody()}else{var d=new cdb.admin.BaseDialog({title:"Delete this row",description:"Are you sure you want to delete this row and all its associated data?",template_name:"old_common/views/confirm_dialog",clean_on_hide:!0,enter_to_confirm:!0,ok_button_classes:"right button grey",ok_title:"Yes, do it",cancel_button_classes:"underline margin15",cancel_title:"Cancel",modal_type:"confirmation",width:500});d.ok=function(){b.table.trigger("removing:row"),b.row.destroy({success:function(){b.table.trigger("remove:row",b.row)}})},d.appendToBody().open()}return this.hide(),!1},addRow:function(a){this.killEvent(a);var b=this.row.collection.indexOf(this.row);return this.tableData.addRow({at:b+1}),this.hide(),!1}}),cdb.admin.RowView=cdb.ui.common.RowView.extend({classLabel:"cdb.admin.RowView",events:{"click      .row_header":"_onOptionsClick","mouseout   .row_header":"_onOptionsOut"},cellRenderers:{"default":"_renderDefault","boolean":"_renderBoolean",number:"_renderNumber",geometry:"_renderGeometry"},initialize:function(){this.elder("initialize"),_.bindAll(this,"_onOptionsClick","_onOptionsOut"),this.options.row_header=!0,this.retrigger("saving",this.model),this.retrigger("saved",this.model),this.retrigger("errorSaving",this.model)},_getRowOptions:function(){if(!cdb.admin.RowView.rowOptions){var a=cdb.admin.RowView.rowOptions=new cdb.admin.RowHeaderDropdown({position:"position",user:this.tableView.user,template_base:"table/views/table_row_header_options",tick:"top",horizontal_position:"left",tableData:this.getTableView().dataModel,table:this.getTableView().model});a.render(),this.retrigger("createRow",a)}return cdb.admin.RowView.rowOptions},_onOptionsOut:function(a){var b=$(a.relatedTarget);b.closest("tr").attr("id");0==b.closest(".dropdown").length&&0==b.closest(".row_header").length&&this.rowOptions&&this.rowOptions.hide()},_onOptionsClick:function(a){var b,c,d,e,f=$(a.target);return c=this.getTableView().dataModel,this.table.isReadOnly()?void 0:(b=this._getRowOptions(),a.preventDefault(),f.append(b.el),d=30,e=5,f.closest("tr").is(":last-child")&&f.closest("tr").index()>1?(b.options.vertical_position="top",b.options.tick="bottom"):(b.options.vertical_position="down",b.options.tick="top"),b.setRow(this.model),b.openAt(d,e),this.rowOptions=b,!1)},valueView:function(a,b){this.table=this.table||this.getTableView().model;var c="_renderDefault";if(a.length){var d=this.table.getColumnType(a);c=this.cellRenderers[d]||c}var e=$(this[c](b));return e.addClass("cell"),cdb.admin.Row.isReservedColumn(a)&&e.addClass("disabled"),""===a&&""===b&&(this.table.isReadOnly()?e.addClass("disabled").html(""):e.addClass("row_header")),e},_renderDefault:function(a,b){b=b||"";var c;return null===a?(b+=" isNull",c='<div class="'+b+'">null</div>'):c='<div class="'+b+'">'+_.escape(a)+"</div>",c},_renderBoolean:function(a){return this._renderDefault(a,"boolean")},_renderNumber:function(a){return this._renderDefault(a,"number")},_renderGeometry:function(a){function b(a){var b=_.uniq(d.table.geomColumnTypes());return!_.isNull(a)&&b&&b.length&&b[0]&&(b=b[0],a=b.charAt(0).toUpperCase()+b.substring(1).toLowerCase()),a}function c(a){var b="       ";return void 0!==a&&(b=a.toFixed(4),a>0&&(b=" "+b)),b}var d=this,e={};try{e=JSON.parse(a),a="Point"===e.type?c(e.coordinates[0])+","+c(e.coordinates[1]):b(a)}catch(f){a=b(a)}return this._renderDefault(a)}}),cdb.admin.SharedTablesCombo=cdb.ui.common.VisualizationsSelector.extend({initialize:function(){this.model&&this.options.user&&this.options.vis||cdb.log.info("Visualizations, user and vis models are required"),this.user=this.options.user,this.vis=this.options.vis,this._initBinds()},render:function(){this.clearSubViews();var a=$("<div>");this.$el.append(a);var b=new cdb.forms.SharedTableCombo({el:a,property:"table",width:"100%",extra:this._generateList()});return b.bind("change",this._onComboChange,this),this.$el.append(b.render().el),this.addView(b),this._onComboChange(),this},_generateList:function(){var a=_.pluck(this.vis.permission.getUsersWithAnyPermission(),"id"),b=this.model.map(function(b){var c=b.permission.acl.find(function(a){return"org"===a.get("type")}),d=_.pluck(b.permission.getUsersWithAnyPermission(),"id"),e=b.permission.owner.id,f=d.concat(e),g={vis_id:b.get("id"),name:b.get("name"),username:"",avatar:"",permission:"",enabled:c||0===_.difference(a,f).length?!0:!1};if(this.user.isInsideOrg()&&b.permission.owner){var h=b.permission.owner.renderData(this.user);g=_.extend(g,{username:h.username,avatar:h.avatar_url,permission:b.permission.getPermission(this.user)===cdb.admin.Permission.READ_ONLY?"READ":null})}return g},this);return _.compact(b)}}),cdb.forms.SharedTableCombo=cdb.forms.VisualizationCombo.extend({_TEXTS:{disabled:_t("This table is not shared with the rest of the visualization users")},_ITEM_TEMPLATE:_t('       <div class="vis-info-item <%- !enabled ? "disabled" : "" %> <%- username ? "shared" : "" %>">        <div class="value" title="<%- id %>" alt="<%- id %>"><%- id %></div>        <% if (username) { %>          <div class="by">            <% if (permission) { %>              <span class="permission round grey"><%- permission %></span>            <% } %>            <span class="username">by <%- username %></span>            <% if (avatar) { %>              <img class="avatar" src="<%- avatar %>" title="<%- username %>" alt="<%- username %>"/>            <% } %>          </div>        <% } %>      </div>    '),_getOptions:function(){var a=this,b=_.map(this.data,function(b){return'<option data-message="'+a._TEXTS.disabled+'" data-vis_id="'+b.vis_id+'" data-permission="'+b.permission+'" data-name="'+b.name+'"  data-avatar="'+b.avatar+'" data-enabled="'+b.enabled+'" data-username="'+b.username+'" '+(b.enabled?"":"disabled")+">"+b.name+"</option>"}).join("");return this.options.placeholder&&(b="<option></option>"+b),b}}),cdb.admin.SlidesPanel=cdb.core.View.extend({className:"slides_panel",template_name:"table/views/slides/panel",initialize:function(){if(this.template=this.getTemplate(this.template_name),this.slides=this.options.slides,this.toggleElement=this.options.toggle,this.model=new cdb.core.Model({visible:!1}),this.model.bind("change:visible",this._onChangeVisible,this),!this.slides)throw new Error("slides is undefined");this._bindSlides()},_bindSlides:function(){this.add_related_model(this.slides),this.slides.bind("reset",function(){this.slides.each(this._add.bind(this))},this),this.slides.bind("remove",function(){this._reInitScrollpane()},this),this.slides.bind("add",this._add,this)},_addAddButton:function(a){this.addSlideButton=new cdb.admin.SlideViewAdd({model:new cdb.core.Model}),this.addSlideButton.bind("click",function(){this.addSlideButton.model.set("loading",!0),this.slides.create()},this),this.addView(this.addSlideButton),this.$el.find(".scrollpane").append(this.addSlideButton.render().el)},_reInitScrollpane:function(){setTimeout(function(){this.$(".scrollpane").data("jsp")&&this.$(".scrollpane").data("jsp").reinitialise(),this.$(".scrollpane.jspScrollable").css("overflow","")},500)},_add:function(a){var b=new cdb.admin.SlideView({model:a});this._fakeSlide&&(this._fakeSlide.clean(),this._fakeSlide=null),this._addSlideView(b)},_addSlideView:function(a){this.addView(a),this.$el.find(".scrollpane .slides").append(a.render().el),a.show(),this._reInitScrollpane()},_onChangeVisible:function(){var a=this.model.get("visible");a?this._show():this._hide(),this.trigger("onChangeVisible",a,this)},toggle:function(){var a=!this.model.get("visible");return this.model.set("visible",a),a},show:function(){this.model.set("visible",!0)},hide:function(){this.model.set("visible",!1)},_hide:function(){this.toggleElement.find("h5").html("Create"),this.toggleElement.removeClass("active"),this.$el.removeClass("active"),cdb.god.trigger("closeDialogs")},_show:function(){this.toggleElement.find("h5").html("Hide"),this.toggleElement.addClass("active"),this.$el.addClass("active")},_initScrollPane:function(){var a=this.$el.find(".scrollpane"),b=this.$el.height();setTimeout(function(){a.css("max-height",b-60),a.jScrollPane(),a.css("overflow","")},500)},_initSortable:function(){var a=this;this.$el.find(".slides").sortable({axis:"y",update:function(b,c){var d=c.item.attr("id"),e=c.item.next()?c.item.next().attr("id"):null,f=a.slides.get(d);f.setNext(e)}})},_renderFake:function(){this._fakeSlide=new cdb.admin.SlideViewFake,this._addSlideView(this._fakeSlide)},render:function(){return this.clearSubViews(),this.$el.append(this.template()),this._renderFake(),this.slides.each(this._add.bind(this)),this._addAddButton(),this._initScrollPane(),this._initSortable(),this.slides.bind("add",function(){this.addSlideButton.model.set("loading",!1)},this),this}}),cdb.admin.SlideViewFake=cdb.core.View.extend({tagName:"a",className:"slide_view fake",template_name:"table/views/slides/slide",initialize:function(){this.template=this.getTemplate(this.template_name)},show:function(){this.$el.addClass("animated bounceIn active")},render:function(){return this.$el.attr("href","#"),this.$el.append(this.template({count:1,transition:!1})),this}}),cdb.admin.SlideView=cdb.core.View.extend({tagName:"a",className:"slide_view",template_name:"table/views/slides/slide",events:{click:"_onClick","click .count":"_onClick","click .info":"_onClickInfo","click .close":"_onClickClose"},initialize:function(){this._setupModel(),this.template=this.getTemplate(this.template_name)},_setupDropdown:function(){this.dropdown=new cdb.admin.TransitionDropdown({target:this.$el.find(".js-change-transition-method"),template_base:"table/views/slides/transition_dropdown",horizontal_position:"left",tick:"top",vertical_offset:58,horizontal_offset:-145,vis:this.model.visualization}),this.addView(this.dropdown),cdb.god.bind("closeDialogs",this._onHideDropdown,this),this.$el.append(this.dropdown.render().el)},_onHideDropdown:function(){this.dropdown.hide(),this.$el.css("z-index",1)},_setupModel:function(){this.model.bind("change:active",this._onChangeActive,this),this.model.visualization.bind("change:transition_options",this._onChangeTransitionOptions,this),this.model.bind("remove",this._onDestroy,this),this.model.collection.bind("add remove reset change:next_id",this._onChangeCount,this),this.add_related_model(this.model.collection)},_onClick:function(a){this.killEvent(a),this.model.collection.setActive(this.model)},_onClickInfo:function(a){this.killEvent(a),this.$el.css("z-index",100)},_onClickClose:function(a){this.killEvent(a);var b=this,c=new cdb.admin.BaseDialog({title:"Delete slide",description:"Are you sure you want to delete this slide?",template_name:"old_common/views/confirm_dialog",clean_on_hide:!0,enter_to_confirm:!0,ok_button_classes:"right button grey",ok_title:"Yes, do it",cancel_button_classes:"underline margin15",cancel_title:"Cancel",modal_type:"confirmation",width:500});c.ok=function(){b.model.destroy()},c.appendToBody().open()},_onDestroy:function(){var a=this;this.hide(function(){a.clean()})},_onChangeCount:function(){this.$el.find(".count").html(this.model.collection.indexOf(this.model)+1)},_onChangeTransitionOptions:function(){var a=this._getTransitionMethod();this.$el.find(".js-change-transition-method").html(a)},_onChangeActive:function(){this.model.isActive()?this.$el.addClass("active"):this.$el.removeClass("active"),cdb.god.trigger("closeDialogs")},hide:function(a){this.$el.removeClass("animated bounceIn").addClass("animated bounceOut"),a&&setTimeout(function(){a()},500)},_getTransitionMethod:function(){var a=this.model.visualization.get("transition_options"),b="on click";return a&&"time"===a.transition_trigger&&(b=1!==a.time?a.time+" seconds":"1 second"),b},show:function(){this.$el.addClass("animated bounceIn")},render:function(){this.$el.attr("href","#");var a=_.extend(this.model.attributes,{count:1,transition:!0,transition_method:this._getTransitionMethod()});return this.$el.append(this.template(a)),this._onChangeActive(),this._onChangeCount(),this._setupDropdown(),this.$el.attr("id",this.model.get("id")),this}}),cdb.admin.SlideViewAdd=cdb.admin.SlideView.extend({className:"slide_view add",template_name:"table/views/slides/add_slide",_setupModel:function(){this.model.bind("change:loading",this._onChangeLoading,this)},_onChangeLoading:function(a){this.model.get("loading")?this.$el.addClass("loading"):this.$el.removeClass("loading")},_onClick:function(a){a.preventDefault(),a.stopPropagation(),this.trigger("click",this)},render:function(){this.$el.attr("href","#");var a=this.options;return this.$el.append(this.template(a)),this}}),cdb.admin.TransitionDropdown=cdb.ui.common.Dropdown.extend({className:"dropdown slide_transition_dropdown",defaults:{speedOut:100,speedIn:100},events:{click:"killEvent","click .radiobutton":"_onClickRadioButton"},initialize:function(){var a=this;_.bindAll(this,"open","hide","_handleClick","_onKeyDown"),_.defaults(this.options,this.defaults),this.template_base=cdb.templates.getTemplate(this.options.template_base),this.vis=this.options.vis,$(this.options.target).bind({click:this._handleClick}),$(document).bind("keydown",this._onKeyDown),this.formModel=proxyModel(this.vis.transition,function(b,c){function d(){b.set(c.attributes),a.vis.save()}a.vis.isLoaded()?d():a.vis.fetch({success:function(){d()}})}),this.on("clean",function(){this.formModel.unlink()}),this.formModel.on("change:transition_trigger",this._onChangeTransitionTrigger,this),this.formModel.on("change:time",this._onChangeTime,this),this.isOpen=!1},_handleClick:function(a){a&&a.preventDefault(),this.isOpen?this.hide():this.open()},_onClickRadioButton:function(a){a.preventDefault(),a.stopPropagation();var b=$(a.target),c=b.attr("data-transition");this.$el.find(".radiobutton").removeClass("selected"),b.addClass("selected"),this.formModel.set({transition_trigger:c})},_selectTimeEvent:function(){this.$el.find(".radiobutton").removeClass("selected"),this.$el.find("a[data-transition='time']").addClass("selected")},_selectOnClickEvent:function(){this.$el.find(".radiobutton").removeClass("selected"),this.$el.find("a[data-transition='click']").addClass("selected")},_onChangeTime:function(){var a=this.formModel.get("time");0!==a&&a?this._selectTimeEvent():this._selectOnClickEvent()},_onChangeTransitionTrigger:function(){var a=this.formModel.get("transition_trigger");"click"!==a&&a?this._selectTimeEvent():this._selectOnClickEvent()},show:function(){var a=$.Deferred();return this.delegateEvents(),this.$el.css({marginTop:"-10px",opacity:0,display:"block"}).animate({margin:"0",opacity:1},{duration:this.options.speedIn,complete:function(){a.resolve()}}),this.trigger("onDropdownShown",this.el),a.promise()},open:function(a,b){cdb.god.trigger("closeDialogs");var c=b&&$(b)||this.options.target;this.options.target=c,this.$el.css({top:this.options.vertical_offset,right:this.options.horizontal_offset}).addClass(("up"==this.options.vertical_position?"vertical_top":"vertical_bottom")+" "+("right"==this.options.horizontal_position?"horizontal_right":"horizontal_left")+" border tick_"+this.options.tick),this.show(),this._recalcHeight(),this.isOpen=!0},_onKeyDown:function(a){27===a.keyCode&&this.hide()},hide:function(a){if(!this.isOpen)return void(a&&a());var b=this;this.isOpen=!1,this.$el.animate({marginTop:"down"==b.options.vertical_position?"10px":"-10px",opacity:0},this.options.speedOut,function(){b.$el.hide()}),this.trigger("onDropdownHidden",this.el)},_recalcHeight:function(){var a=this.$el.find("ul.special");a.height("auto"),a.parent().height("auto");var b=a.height(),c=a.parent().height();c>b?a.css("height",c):a.parent().height(b)},render:function(){this.clearSubViews(),this.$el.html(this.template_base(this.options));var a=new cdb.forms.SimpleNumber({model:this.formModel,property:"time",max:120,min:1,inc:1});return a.bind("saved",function(a){this.formModel.set("transition_trigger","time")},this),this.$el.find("li.seconds .form").append(a.render().$el),this._onChangeTransitionTrigger(),this}}),cdb.admin.StaticImageDialog=cdb.admin.BaseDialog.extend({events:{"click .ok":"_ok","click .cancel":"_cancel","click .close":"_cancel"},_TEXTS:{title:_t("Configure export options"),description:_t("The image will be centered using the map's current center"),ok:_t("Export image")},initialize:function(){_.bindAll(this,"_onImageCallback"),_.extend(this.options,{disabled:!1,title:this._TEXTS.title,description:this._TEXTS.description,width:355,error_width:511,clean_on_hide:!0,capture_width:this.options.width,capture_height:this.options.height,attribution:this.options.attribution,template_name:"table/views/static_image_dialog",ok_title:this._TEXTS.ok,ok_button_classes:"button grey",error_close_title:"Close",ok_button_classes:"button grey",modal_class:"static_image_dialog"}),this.constructor.__super__.initialize.apply(this)},render:function(){return this.$el.append(this.template_base(_.extend(this.options))),this.$(".modal").css({width:this.options.width}),this.$(".modal.warning").css({width:this.options.error_width}),this.options.modal_class&&this.$el.addClass(this.options.modal_class),this},_keydown:function(a){27===a.keyCode&&this._cancel()},_ok:function(a){if(!this.options.disabled){this.options.disabled=!0,this.privacy=this.options.privacy,this.killEvent(a);var b=this.$el.find('input[name="width"]').val(),c=this.$el.find('input[name="height"]').val(),d=this.$el.find(".ok.button");d.addClass("disabled"),this.$el.addClass("is-loading"),this.user=this.options.user,this.url=this.options.vizjson,cdb.Image(this.url,{https:this._isHTTPS()}).size(b,c).getUrl(this._onImageCallback)}},_isHTTPS:function(){return 0===location.protocol.indexOf("https")},_onImageCallback:function(a,b){this.$el.removeClass("is-loading"),this.$el.find(".ok.button").removeClass("disabled"),this.options.disabled=!1,a&&a.errors?this._showError(a.errors[0]):window.open(b,"_blank")},_showError:function(a){this.$el.find(".js-error-message").html(a),this.$("section.modal:eq(0)").animate({top:0,opacity:0},300,function(){$(this).slideUp(300)}),this.$(".modal.confirmation").css({top:"50%",marginTop:this.$(".modal.confirmation").height()/2,display:"block",opacity:0}).delay(200).animate({marginTop:-(this.$(".modal.confirmation").height()/2),opacity:1},300)},clean:function(){cdb.admin.BaseDialog.prototype.clean.call(this)}}),cdb.admin.StopEditDialog=cdb.admin.BaseDialog.extend({initialize:function(){_.extend(this.options,{title:"Sorry, this geometry is too big to edit in browser",template_name:"old_common/views/dialog_base",clean_on_hide:!0,cancel_button_classes:"hide",ok_button_classes:"button grey",ok_title:"Hide",modal_type:"confirmation",width:510}),this.constructor.__super__.initialize.apply(this)},render_content:function(){return this.getTemplate("table/views/stop_edit_confirmation")()}}),$(function(){var a=cdb.core.View.extend({el:document.body,events:{keypress:"keyPress",keyup:"keyUp"},initialize:function(a){this.table=null,this.selectedMenu=null,this.workViewActive="table",this.options.user_data.get_layers=!0,this.user=new cdb.admin.User(this.options.user_data),cdb.config.set("user",this.user),this._initModels(),this._initViews(),this._createLoader(),cdb.admin.hotkeys.enable(),this.keyBind()},keyBind:function(){var a=this;cdb.god.bind("hotkey:d",function(b){a.menu.isOpen?a.menu.hide():a.menu.show("sql_mod")}),cdb.god.bind("hotkey:s",function(b){a.menu.show("sql_mod")}),cdb.god.bind("hotkey:c",function(b){a.menu.show("style_mod")})},_initModels:function(){var a=this;this.vis=new cdb.admin.Visualization(this.options.vis_data),this.master_vis=new cdb.admin.Visualization(_.omit(this.options.vis_data,"children")),this.vis.setMaster(this.master_vis),0===this.vis.slides.length?this.vis.map.set(this.vis.map.parse(this.options.map_data)):this.vis.activeSlide(0),this.map=this.vis.map,this.vis.enableOverlays();var b=this.options.basemaps;this.baseLayers=this.user.layers,this.baseLayers.each(function(a){a.set("category","Yours")}),_(b).each(function(b,c){_(b).map(function(b){var d={googlemaps:cdb.admin.GMapsBaseLayer},e=d[b.className]||cdb.admin.TileLayer;a.baseLayers.add(new e({
name:b.name,className:b.className,base_type:b.baseType||"default",urlTemplate:b.url,read_only:!0,minZoom:b.minZoom,maxZoom:b.maxZoom,attribution:b.attribution,subdomains:b.subdomains,baseName:b.baseName,style:b.style?JSON.parse(b.style):null,category:c}))})})},_resetModel:function(a){this.vis=new cdb.admin.Visualization({id:a}),this.vis.fetch()},_initViews:function(){if(this.globalError=new cdb.admin.GlobalError({el:$(".globalerror")}),this.globalError.listenGlobal(),this.addView(this.globalError),this.vis.get("locked"))if(this.user.featureEnabled("new_modals")){var a=new cdb.editor.ChangeLockViewModel({items:[this.vis],contentType:this.vis.isVisualization()?"maps":"datasets"}),b=new cdb.editor.ChangeLockView({model:a,ownerName:this.vis.permission.owner.get("username"),isOwner:this.vis.permission.isOwner(this.user),template:cdb.templates.getTemplate("common/dialogs/change_lock/templates/unlock_to_editor"),clean_on_hide:!0,enter_to_confirm:!0}),c=this;b.cancel=function(){window.location=c.user.viewUrl().dashboard()[c.vis.isVisualization()?"maps":"datasets"]().urlToPath("locked")},b.appendToBody()}else{var d=new cdb.admin.LockVisualizationDialog({user:this.user,model:this.vis,cancelEnabled:!1});d.appendToBody().open({center:!0}),this.addView(d)}if(this.tabs=new cdb.admin.Tabs({el:this.$("nav"),slash:!0}),this.addView(this.tabs),this.workView=new cdb.ui.common.TabPane({el:this.$(".panes")}),this.addView(this.workView),this.menu=new cdb.admin.LayersPanel({vis:this.vis,master_vis:this.master_vis,user:this.user,globalError:this.globalError}),this.$el.append(this.menu.render().el),this.menu.hide(),this.addView(this.menu),this.menu.bind("switch",function(a){this.setTable(a.table,a.sqlView),this.tableTab||(this._initTableMap(),this.table.trigger("change",this.table)),this.backgroundTab.setActiveLayer(a),this.tableTab.setActiveLayer(a),this.mapTab.setActiveLayer(a),this.header.setActiveLayer(a)},this),this.vis.isVisualization()||this._setWatchingNotifier(),enableClickOut(this.$el),$(window).bind("resize",this._onResize),this.user.featureEnabled("new_modals")){var e=new cdb.editor.ImportsCollection(null,{user:this.user}),f=new cdb.editor.BackgroundImporterModel({},{importsCollection:e,user:this.user,vis:this.vis});f.bind("importLayerFail",function(a){cdb.editor.ViewFactory.createDialogByTemplate("common/templates/fail",{msg:a}).render().appendToBody()});var g=new cdb.editor.BackgroundImporterView({model:f,createVis:!1,items:{fetch:function(){}},user:this.user});this.$el.append(g.render().el),this.addView(g)}},_initTableMap:function(){var a=this;this.geocoder=new cdb.admin.Geocoding,this.header=new cdb.admin.Header({el:this.$("header"),globalError:this.globalError,model:this.master_vis,visualization:this.vis,user:this.user,config:this.options.config,geocoder:this.geocoder}),this.addView(this.header),this.tableTab=new cdb.admin.TableTab({model:this.table,user:this.user,vis:this.vis,sqlView:this.sqlView,geocoder:this.geocoder,globalError:this.globalError,menu:this.menu}),this.mapTab=new cdb.admin.MapTab({model:this.map,baseLayers:this.baseLayers,vis:this.vis,master_vis:this.master_vis,geocoder:this.geocoder,table:this.table,user:this.user,menu:this.menu}),this.backgroundTab=new cdb.admin.BackgroundTab({el:this.el,model:this.geocoder,vis:this.vis,table:this.table,globalError:this.globalError,user:this.user});var b=new cdb.admin.GeocodingResult({geocoder:this.geocoder,user:this.user});this._addVideoPlayer(),this.addView(b),this.map.bind("notice",this.globalError.showError,this.globalError),this.workView.bind("tabEnabled:map",this.mapTab.enableMap,this.mapTab),this.workView.bind("tabEnabled",this.tabs.activate),this.mapTab.bind("missingClick",a.menu.hide,a.menu),this.workView.addTab("table",this.tableTab.render(),{active:!1}),this.workView.addTab("map",this.mapTab.render(),{active:!1}),this.workView.active(this.workViewActive)},setTable:function(a,b){function c(){a.setReadOnly(a.permission.getPermission(d.user)!==cdb.admin.Permission.READ_WRITE)}var d=this;this.table&&(this.table.unbind("notice",null,this.globalError),this.table.unbind("change:permission",null,this)),a.bind("change:permission",c,this),c(),this.table=a,this.sqlView=b,this.table.bind("notice",this.globalError.showError,this.globalError),this.table.bind("change:isSync",this._setSyncInfo,this),this._setSyncInfo()},_addVideoPlayer:function(){this.player=new cdb.admin.VideoPlayer,this.player.hasVideoData()&&this.$el.append(this.player.render().$el)},_setSyncInfo:function(){this.table&&this.table.isSync()&&!this.vis.isVisualization()?this.workView.$el.addClass("synced"):this.workView.$el.removeClass("synced")},_setWatchingNotifier:function(){var a=new cdb.admin.WatchingNotifierModel({},{vis:this.vis,interval:cdb.config.get("watcher_ttl")}),b=new cdb.admin.WatchingNotifierView({model:a,user:this.user});this.$el.append(b.render().el),this.addView(b)},_onResize:function(a){cdb.god.trigger("closeDialogs")},keyUp:function(a){},keyPress:function(a){},_createLoader:function(){this.big_loader=new cdb.admin.TableBigLoader,this.$el.append(this.big_loader.render().el)},showLoader:function(a){this.big_loader.change(a),this.big_loader.open()},hideLoader:function(){this.big_loader.hide()},activeView:function(a){this.workView.active(a),this.menu.setActiveWorkView(a),this.workViewActive=a}});cdb._test=cdb._test||{},cdb._test.Table=a,cdb.init(function(){cdb.config.set(config),cdb.config.set("api_key",user_data.api_key),cdb.templates.namespace="cartodb/",cdb.config.set("url_prefix",user_data.base_url);var b=new cdb.admin.User(window.user_data);b.featureEnabled("active_record_geocoding_endpoint")&&applyPatchNewGeocodingUrls(),b.featureEnabled("active_record_table_vis_endpoint")&&applyPatchNewTableUrls(),b.featureEnabled("active_record_synchronization_endpoint")&&applyPatchNewSynchronizationUrls(),b.featureEnabled("active_record_layers_endpoint")&&applyPatchNewLayerUrls(),b.featureEnabled("active_record_asset_endpoint")&&applyPatchNewAssetUrl();var c=(new cdb.admin.ErrorStats({user_data:user_data}),new a({vis_data:vis_data,user_data:user_data,config:config,map_data:map_data,basemaps:basemaps||cdb.admin.DEFAULT_BASEMAPS}));window.mixpanel&&new cdb.admin.Mixpanel({user:user_data,token:mixpanel_token});new cdb.admin.Metrics;window.table=c,window.table_router=new cdb.admin.TableRouter(c),Backbone.history.start({pushState:!0,root:cdb.config.prefixUrlPathname()+"/"})})}),cdb.admin.TableBigLoader=cdb.admin.BaseDialog.extend({events:{},_TEXTS:{loader:_t("Setting <%- type %>...")},initialize:function(){_.extend(this.options,{clean_on_hide:!1,template_name:"table/views/base_table_big_loader",modal_class:"table_big_loader"}),this.constructor.__super__.initialize.apply(this)},render_content:function(){var a=this.$content=$("<div>");return this.template=cdb.templates.getTemplate("table/views/table_big_loader"),a.append(this.template(this.options)),this.$(".mamufas").hide(),a},change:function(a){this.$(".loader p").text(this._TEXTS.loader.replace("<%- type %>",a))}}),cdb.admin.TableRouter=Backbone.Router.extend({_TEXTS:{error:_t("Something went wrong, try again later")},routes:{":type/:id":"change",":type/:id/":"change",":type/:id/:scenario":"change"},initialize:function(a){this.history=[],this.table=a,this.addToHistory()},changeToVis:function(a){var b=this.history.length>0&&_.last(this.history).split("/"),c="/viz/"+a.get("id")+"/"+(b[2]||"table");this.navigate(c,{trigger:!1}),this.addToHistory()},addToHistory:function(){if(Backbone.history.fragment){var a=Backbone.history.fragment.replace(/"/g,"");this.history.push(a)}},change:function(a,b,c){function d(a){h.table.master_vis.set("id",a).fetch({wait:!0,success:function(a){a.getRelatedTables(),h.table.hideLoader()},error:function(){h.table.hideLoader(),h.table.globalError.showError(h._TEXTS.error,"error",5e3)}})}var e=this.history.length>0&&_.compact(_.last(this.history).split("/")),f=!1,g=!1,h=this;if(b=b.replace(/"/g,""),e&&e.length>0&&e[0]!=a&&"tables"==a){f=!0,g=!0,h.table.showLoader("table");var i=new cdb.admin.CartoDBTableMetadata({id:b});i.fetch({wait:!0,success:function(a){d(a.get("table_visualization").id)},fail:function(){h.table.globalError.showError(h._TEXTS.error,"error",5e3)}})}e&&e.length>1&&e[1]!=b&&(f||h.table.showLoader("visualization"),g||d(b)),"table"!=c&&"map"!=c&&(c="table"),this.table.activeView(c),this.addToHistory()}}),function(){cdb.admin.TableView=cdb.ui.common.Table.extend({classLabel:"cdb.admin.TableView",events:cdb.core.View.extendEvents({"click .clearview":"_clearView","click .sqlview .export_query":"_tableFromQuery","click .noRows":"addEmptyRow"}),rowView:cdb.admin.RowView,initialize:function(){this.elder("initialize"),this.options.row_header=!0,this.globalError=this.options.globalError,this.vis=this.options.vis,this.user=this.options.user,this._editorsOpened=null,this.initializeBindings(),this.initPaginationAndScroll()},initializeBindings:function(){var a=this;_.bindAll(this,"render","rowSaving","addEmptyRow","_checkEmptyTable","_forceScroll","_scrollMagic","rowChanged","rowSynched","_startPagination","_finishPagination","rowFailed","rowDestroyed","emptyTable"),this.model.data().bind("newPage",this.newPage,this),this.model.data().bind("endLoadingRows",this._finishPagination),this.bind("cellDblClick",this._editCell,this),this.bind("createRow",function(){a._checkEmptyTable()}),this.model.bind("change:dataSource",this._onSQLView,this),this.model.bind("dataLoaded",function(){a._forceScroll()},this),this.model.bind("change:permission",this._checkEmptyTable,this),this.model.bind("change:isSync",this._swicthEnabled,this),this._swicthEnabled(),cdb.god.bind("panel_action",function(b){a._moveInfo(b)},this),this.add_related_model(cdb.god),this.options.geocoder.bind("geocodingComplete geocodingError geocodingCanceled",function(){this.notice(_t("loaded"))},this),this.add_related_model(this.options.geocoder)},initPaginationAndScroll:function(){var a=this,b=!1,c=!1;this.scroll_position={x:$(window).scrollLeft(),y:$(window).scrollTop(),last:"vertical"},$(window).scroll(this._scrollMagic);var d=2;this.checkScrollTimer=setInterval(function(){if(a.$el.is(":visible")&&!a.model.data().isFetchingPage()){var e=$(this).scrollTop(),f=a.model.data();e>d&&(b=!1);var g=$(window).height()-a.$el.offset().top,h=this.$("tbody").height(),i=e+g;g>h||(h-d>i&&(c=!1),i>=h?(c||(f.lastPage||a._startPagination("down"),setTimeout(function(){f.loadPageAtBottom()},600)),c=!0):0>=e&&(b||(f.pages&&0!=f.pages[0]&&a._startPagination("up"),setTimeout(function(){f.loadPageAtTop()},600)),b=!0),a._setUpPagination(f))}},300),this.bind("clean",function(){clearInterval(this.checkScrollTimer)},this)},needsRender:function(a){if(!a)return!0;var b=a.changedAttributes();return b.geometry_types&&1===_.keys(b).length?!1:!0},render:function(a){this.needsRender(a)&&(this.elder("render",a),this.model.isInSQLView()&&this._onSQLView(),this._swicthEnabled(),this.trigger("render"))},_renderHeader:function(){var a=cdb.ui.common.Table.prototype._renderHeader.apply(this);return a.append($("<div>").addClass("shadow")),a},addColumn:function(a){this.newColumnName="column_"+(new Date).getTime(),this.model.addColumn(this.newColumnName,"string"),this.unbind("render",this._highlightColumn,this),this.bind("render",this._highlightColumn,this)},_highlightColumn:function(){if(this.newColumnName){var a=this.$("a[href='#"+this.newColumnName+"']").parents("th"),b=a.index();b&&(setTimeout(function(){var c=$(window).width();if(a&&a.position()){var d=a.position().left-c/2+a.width()/2;$(window).scrollLeft(d)}this.$("[data-x='"+b+"']").addClass("is-highlighted")},300),this.unbind("render",this._highlightColumn,this))}},_setUpPagination:function(a){var b=a.pages;b.length>0&&b[0]>0?(0==this.$el.find("tfoot.page_loader.up").length&&this.$el.append(this.getTemplate("table/views/table_pagination_loaders")({direction:"up"})),this.$el.parent().addClass("page_up")):this.$el.parent().removeClass("page_up"),a.lastPage?this.$el.parent().removeClass("page_down"):(0==this.$el.find("tfoot.page_loader.down").length&&this.$el.append(this.getTemplate("table/views/table_pagination_loaders")({direction:"down"})),this.$el.parent().addClass("page_down"))},_startPagination:function(a){this.$el.find(".page_loader."+a).addClass("active")},_finishPagination:function(a,b){0!=a&&"up"==b&&setTimeout(function(){$(window).scrollTop(180)},300),this.$el.find(".page_loader.active").removeClass("active")},_onSQLView:function(){this.$(".sqlview").remove(),this.options.sqlView.unbind("reset error",this._renderSQLHeader,this),this.options.sqlView.unbind("loading",this._renderLoading,this),this.options.sqlView.bind("loading",this._renderLoading,this),this.options.sqlView.bind("reset",this._renderSQLHeader,this),this.options.sqlView.bind("error",this._renderSQLHeader,this),this._renderSQLHeader()},_renderLoading:function(a){a=a||{},this.cleanEmptyTableInfo(),a.add||this._renderBodyTemplate("table/views/sql_loading")},_renderSQLHeader:function(){var a=this;if(a.model.isInSQLView()){var b=a.isEmptyTable();a.$("thead").find(".sqlview").remove(),a.$("thead").append(a.getTemplate("table/views/sql_view_notice")({empty:b,isVisualization:a.vis.isVisualization(),warnMsg:null})),a.$("thead > tr").css("height",106),a.isEmptyTable()&&a.addEmptySQLIfo(),a._moveInfo()}},_swicthEnabled:function(){this.$el[this.model.isSync()?"addClass":"removeClass"]("synced"),this.$el[this.vis.isVisualization()?"addClass":"removeClass"]("vis")},_clearView:function(a){return a&&a.preventDefault(),this.options.layer.clearSQLView(),!1},_tableFromQuery:function(a){a.preventDefault();var b;b=this.user.featureEnabled("new_modals")?new cdb.editor.DuplicateDatasetView({model:this.model,user:this.user,clean_on_hide:!0}):new cdb.admin.DuplicateTableDialog({model:this.model}),b.appendToBody().open()},_scrollMagic:function(a){var b={x:$(window).scrollLeft(),y:$(window).scrollTop()};this.scroll_position.x!=b.x?(this.scroll_position.x=b.x,this.$el.find("thead").addClass("horizontal"),"vertical"==this.scroll_position.last&&(this.scroll_position.x=b.x,this.$el.find("thead > tr > th > div > div:not(.dropdown)").removeAttr("style").css("top",b.y+"px"),this.scroll_position.last="horizontal")):this.scroll_position.y!=b.y&&(this.scroll_position.y=b.y,this.$el.find("thead").removeClass("horizontal"),"horizontal"==this.scroll_position.last&&(this.$el.find("thead > tr > th > div > div:not(.dropdown)").removeAttr("style").css({marginLeft:"-"+b.x+"px"}),this.scroll_position.last="vertical"))},_moveInfo:function(a){if("show"==a)this.$el.removeClass("narrow").addClass("displaced");else if("narrow"==a)this.$el.addClass("displaced narrow");else if("hide"==a)this.$el.removeClass("displaced narrow");else if($(".table_panel").length>0){var b=0==$(".table_panel").css("right").replace("px","")?!0:!1;b||this.$el.removeClass("displaced")}},_getEditor:function(a,b){var c={string:cdb.admin.StringField,number:cdb.admin.NumberField,date:cdb.admin.DateField,geometry:cdb.admin.GeometryField,"timestamp with time zone":cdb.admin.DateField,"timestamp without time zone":cdb.admin.DateField,"boolean":cdb.admin.BooleanField},d=_.filter(c,function(b,c){return c===a}).length>0;return"undefined"!==a&&d?c[a]:c.string},closeEditor:function(){this._editorsOpened&&(this._editorsOpened.hide(),this._editorsOpened.clean())},_editCell:function(a,b,c,d){var e=this;this.closeEditor();var f=e.model.columnName(c-1),g=this.model.getColumnType(f);if(!this.model.isReservedColumn(f)||this.model.isReadOnly()||"geometry"==g){var h=e.model.data().getRowAt(d),i="";0===e.model.data().getCell(d,f)||"0"===e.model.data().getCell(d,f)?i="0":void 0!==e.model.data().getCell(d,f)&&(i=e.model.data().getCell(d,f)),"the_geom"==f&&(g="geometry");var j=_.clone(h.toJSON()),k=this._editorsOpened=new cdb.admin.SmallEditorDialog({value:i,column:f,row:h,rowNumber:d,readOnly:this.model.isReadOnly(),editorField:this._getEditor(g),res:function(a){_.isEqual(a,j[f])||(h.bind("error",function b(){h.unbind("error",b),h.set(f,j[f])}),h.save(f,a).done(function(a){e.model.trigger("data:saved")}))}});if(!k)return void cdb.log.error("editor not defined for column type "+g);var l=$(a.target).closest("td"),m=l.offset(),n=$(a.target).closest("tr"),o=Math.min(l.outerWidth(),278);m.top=m.top-this.$el.offset().top,0==l.parent().index()?m.top+=5:m.top-=11,l.index()==n.find("td").size()-1&&n.find("td").size()<2?m.left-=o/2:m.left-=11,k.showAt(m.left,m.top,o,!0)}},headerView:function(a){var b=this;if("header"!==a[1]){var c=new cdb.admin.HeaderView({column:a,table:this.model,sqlView:this.options.sqlView,user:this.user,vis:this.vis}).bind("clearView",this._clearView,this).bind("georeference",function(a){var b;if(this.options.geocoder.isGeocoding()||this.model.isSync()){if(!this.options.geocoder.isGeocoding())return;b=new cdb.admin.GeocoderWorking}else{var c=this.user.featureEnabled("new_modals")?cdb.editor.GeoreferenceView:cdb.admin.GeocodingDialog;b=new c({table:this.model,user:this.user,tabs:["lonlat","city","admin","postal","ip","address"],option:"lonlat",data:{longitude:a}}),b.bind("geocodingChosen",this._onGeocodingChosen,this)}b.appendToBody().open({center:!0})},this).bind("applyFilter",function(a){b.options.menu.show("filters_mod"),b.options.layer.trigger("applyFilter",a)},this);return this.addView(c),this.newColumnName==a[0]&&setTimeout(function(){c.renameColumn(),b.newColumnName=null},300),c.render().el}return"<div><div></div></div>"},_onGeocodingChosen:function(a){return"lonlat"==a.type?(this.model.geocodeLatAndLng(a.latitude,a.longitude),!1):"lonlat"!==a.type?(this.options.geocoder.set(_.omit(a,"table_name","type")),!1):void cdb.log.info("No geocoder option for "+a.type,obj)},_checkEmptyTable:function(){this.isEmptyTable()?this.addEmptyTableInfo():this.cleanEmptyTableInfo()},_forceScroll:function(a){$(window).scrollLeft(0)},_renderEmpty:function(){this.addEmptyTableInfo()},addEmptyTableInfo:function(){if(0==this.$(".noRows").length&&!this.model.isInSQLView()&&this.model.get("schema")){if(this.elder("addEmptyTableInfo"),this.$el.hide(),!this.model.isReadOnly()){for(var a=this.model.get("schema").length,b='<tr class="placeholder noRows"><td class="addNewRow">+</td>',c=0;a>c;c++)b+="<td></td>";b+="</tr>";for(var d='<tr class="placeholder noRows decoration"><td></td>',c=0;a>c;c++)d+="<td></td>";d+="</tr>";var e=$(b+d);this.$el.append(e)}this.template_base=cdb.templates.getTemplate(this.model.isReadOnly()?"table/views/empty_readtable_info":"table/views/empty_table");var f=this.template_base(),g=$('<tfoot><tr><td colspan="100">'+f+"</td></tr></tfoot>");this.$el.append(g),this.$el.fadeIn()}},addEmptySQLIfo:function(){this.model.isInSQLView()&&this._renderBodyTemplate("table/views/empty_sql")},_renderBodyTemplate:function(a){this.$("tbody").html(""),this.$("tfoot").remove(),this.$el.hide();var b=!1;$(".table_panel").length>0&&(b=0==$(".table_panel").css("right").replace("px","")?!0:!1);var c=cdb.templates.getTemplate(a)({panel_opened:b}),d=$('<tfoot class="sql_loader"><tr><td colspan="100">'+c+"</td></tr></tfoot>");this.$el.append(d),this.$el.fadeIn()},cleanEmptyTableInfo:function(){this.$("tfoot").fadeOut("fast",function(){$(this).remove()}),this.$(".noRows").slideUp("fast",function(){$(this).remove()})},notice:function(a,b,c){this.globalError.showError(a,b,c)},addEmptyRow:function(){this.dataModel.addRow({at:0}),this.cleanEmptyTableInfo()},rowSaving:function(){this.notice("Saving your edit","load",-1)},rowSynched:function(){this.notice("Sucessfully saved")},rowFailed:function(){this.notice("Oops, there has been an error saving your changes.","error")},rowDestroying:function(){this.notice("Deleting row","load",-1)},rowDestroyed:function(){this.notice("Sucessfully deleted"),this._checkEmptyTable()}}),cdb.admin.TableTab=cdb.core.View.extend({className:"table",initialize:function(){this.user=this.options.user,this.sqlView=this.options.sqlView,this.geocoder=this.options.geocoder,this._initBinds()},setActiveLayer:function(a){var b=!!this.tableView;this.deactivated(),this.model=a.table,this.layer=a.model,this.sqlView=a.sqlView,b&&this.activated()},_initBinds:function(){this.geocoder.bind("geocodingComplete geocodingError geocodingCanceled",function(){this.model.data&&this.model.data().refresh()},this),this.add_related_model(this.geocoder)},_createTable:function(){this.tableView=new cdb.admin.TableView({dataModel:this.model.data(),model:this.model,sqlView:this.sqlView,layer:this.layer,geocoder:this.options.geocoder,vis:this.options.vis,menu:this.options.menu,user:this.user,globalError:this.options.globalError})},activated:function(){this.tableView||(this._createTable(),this.tableView.render(),this.render())},deactivated:function(){this.tableView&&(this.tableView.clean(),this.tableView=null,this.hasRenderedTableView=!1)},render:function(){return this.tableView&&!this.hasRenderedTableView&&(this.hasRenderedTableView=!0,this.$el.append(this.tableView.el)),this}})}(),cdb.admin.Tooltip=cdb.geo.ui.Tooltip.extend({_TEMPLATE_URL:"table/views/tooltip/templates",defaults:{vertical_offset:10,horizontal_offset:4,position:"bottom|right"},events:{mouseover:"_lock",mouseout:"_unlock"},initialize:function(){this.table=this.options.table,this.options.empty_fields=!0,cdb.geo.ui.Tooltip.prototype.initialize.call(this),this.model.bind("change:template_name",this._setTemplate,this),this.model.bind("change:template",this._compileTemplate,this),this.model.bind("change:fields",this._changeFields,this),this.model.bind("change:alternative_names",this._alternameNames,this),this._setTemplate(),this._alternameNames(),this._changeFields(),this.model.get("template")&&this._compileTemplate(),this.targetPos=null,this.locked=!1,this.hideTimeout=-1},render:function(a){return this.model.fieldCount()?cdb.geo.ui.Tooltip.prototype.render.call(this,a):this.el.innerHTML="",this},_lock:function(a){this.locked=!0,clearTimeout(this.hideTimeout)},_unlock:function(a){this.locked=!1},_changeFields:function(){this.setFields(this.model.get("fields"))},_alternameNames:function(){this.options.alternative_names=this.model.get("alternative_names")},_compileTemplate:function(){var a=this.model.get("template")?this.model.get("template"):cdb.templates.getTemplate(this._getModelTemplate());"function"!=typeof a?this.template=new cdb.core.Template({template:a,type:this.model.get("template_type")||"mustache"}).asFunction():this.template=a,this.render()},_setTemplate:function(){this.model.get("template_name")&&(this.template=cdb.templates.getTemplate(this._getModelTemplate()),this.render())},_getModelTemplate:function(){return this._TEMPLATE_URL+"/"+this.model.get("template_name")},_move:function(){if(this.targetPos){var a=this.$el.position(),b=this.targetPos.x-a.left,c=this.targetPos.y-a.top;a.left+=.05*b,a.top+=.05*c,this.$el.css(a),!this.locked&&(Math.abs(b)>1||Math.abs(c)>1)&&L.Util.requestAnimFrame(this._move,this)}}}),cdb.admin.WatchingNotifierModel=cdb.core.Model.extend({_INTERVAL:3e4,_FIRST_TRY:3e3,defaults:{users:[]},url:function(a){var b=cdb.config.urlVersion("watching",a);return"/api/"+b+"/viz/"+this.vis.get("id")+"/watching"},initialize:function(a,b){b.vis||cdb.log.info("There is no vis defined"),b.interval&&(this._INTERVAL=b.interval/2*1e3),this.vis=b.vis,this.set("id",this.vis.get("id")),this._initBinds(),this._checkPermissions()},_initBinds:function(){_.bindAll(this,"_fetchModel"),this.vis.bind("change:id",this._checkPermissions,this)},_checkPermissions:function(){var a=this;if(this.vis.permission&&!this.vis.isVisualization()){var b=this.vis.permission;b.acl.size()>0?setTimeout(function(){a._fetchModel(),a.pollCheck()},a._FIRST_TRY):this.destroyCheck()}else this.destroyCheck()},_fetchModel:function(){var a=this;this.save({success:function(){a.trigger("change")},error:function(b){a.destroyCheck()}})},pollCheck:function(a){var b=this;this.pollTimer=setInterval(function(){b._fetchModel()},a||this._INTERVAL)},destroyCheck:function(){clearInterval(this.pollTimer),this.set("users",[])},parse:function(a){return{users:a}}}),cdb.admin.WatchingNotifierView=cdb.core.View.extend({className:"watching-notifier",tagName:"div",initialize:function(){this.user=this.options.user,this._initBinds(),this.template=cdb.templates.getTemplate("table/views/watching_notifier")},render:function(){var a=this._removeCurrentUser(this.model.get("users"))||[];return this.$el.html(this.template({users:a})),this},_initBinds:function(){this.model.bind("change",this._onModelChange,this)},_onModelChange:function(){var a=this._removeCurrentUser(this.model.get("users"))||[];a.length>0?this.render().show():this.hide()},_removeCurrentUser:function(a){var b=this;return _.reject(a,function(a){return a===b.user.get("username")})},show:function(){this.$el.addClass("active")},hide:function(){this.$el.removeClass("active")}});
//# sourceMappingURL=table.js.map